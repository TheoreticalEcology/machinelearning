<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>6 Generative modeling and reinforcement learning | Machine Learning and AI in TensorFlow and R</title>
  <meta name="description" content="6 Generative modeling and reinforcement learning | Machine Learning and AI in TensorFlow and R" />
  <meta name="generator" content="bookdown 0.22 and GitBook 2.6.7" />

  <meta property="og:title" content="6 Generative modeling and reinforcement learning | Machine Learning and AI in TensorFlow and R" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="6 Generative modeling and reinforcement learning | Machine Learning and AI in TensorFlow and R" />
  <meta name="github-repo" content="rstudio/bookdown-demo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="6 Generative modeling and reinforcement learning | Machine Learning and AI in TensorFlow and R" />
  
  <meta name="twitter:description" content="6 Generative modeling and reinforcement learning | Machine Learning and AI in TensorFlow and R" />
  

<meta name="author" content="Maximilian Pichler and Florian Hartig" />


<meta name="date" content="2021-05-06" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="interpretation-and-causality-with-machine-learning.html"/>
<link rel="next" href="datasets.html"/>
<script src="libs/header-attrs-2.6/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>
<script src="libs/htmlwidgets-1.5.1/htmlwidgets.js"></script>
<script src="libs/viz-1.8.2/viz.js"></script>
<link href="libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet" />
<script src="libs/grViz-binding-1.0.6.1/grViz.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    background-color: #ffffff;
    color: #a0a0a0;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #a0a0a0;  padding-left: 4px; }
div.sourceCode
  { color: #1f1c1b; background-color: #ffffff; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span { color: #1f1c1b; } /* Normal */
code span.al { color: #bf0303; background-color: #f7e6e6; font-weight: bold; } /* Alert */
code span.an { color: #ca60ca; } /* Annotation */
code span.at { color: #0057ae; } /* Attribute */
code span.bn { color: #b08000; } /* BaseN */
code span.bu { color: #644a9b; font-weight: bold; } /* BuiltIn */
code span.cf { color: #1f1c1b; font-weight: bold; } /* ControlFlow */
code span.ch { color: #924c9d; } /* Char */
code span.cn { color: #aa5500; } /* Constant */
code span.co { color: #898887; } /* Comment */
code span.cv { color: #0095ff; } /* CommentVar */
code span.do { color: #607880; } /* Documentation */
code span.dt { color: #0057ae; } /* DataType */
code span.dv { color: #b08000; } /* DecVal */
code span.er { color: #bf0303; text-decoration: underline; } /* Error */
code span.ex { color: #0095ff; font-weight: bold; } /* Extension */
code span.fl { color: #b08000; } /* Float */
code span.fu { color: #644a9b; } /* Function */
code span.im { color: #ff5500; } /* Import */
code span.in { color: #b08000; } /* Information */
code span.kw { color: #1f1c1b; font-weight: bold; } /* Keyword */
code span.op { color: #1f1c1b; } /* Operator */
code span.ot { color: #006e28; } /* Other */
code span.pp { color: #006e28; } /* Preprocessor */
code span.re { color: #0057ae; background-color: #e0e9f8; } /* RegionMarker */
code span.sc { color: #3daee9; } /* SpecialChar */
code span.ss { color: #ff5500; } /* SpecialString */
code span.st { color: #bf0303; } /* String */
code span.va { color: #0057ae; } /* Variable */
code span.vs { color: #bf0303; } /* VerbatimString */
code span.wa { color: #bf0303; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Prerequisites</a></li>
<li class="chapter" data-level="2" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>2</b> Introduction to Machine Learning</a>
<ul>
<li class="chapter" data-level="2.1" data-path="introduction.html"><a href="introduction.html#unsupervised-learning"><i class="fa fa-check"></i><b>2.1</b> Unsupervised learning</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="introduction.html"><a href="introduction.html#hierarchical-clustering"><i class="fa fa-check"></i><b>2.1.1</b> Hierarchical clustering</a></li>
<li class="chapter" data-level="2.1.2" data-path="introduction.html"><a href="introduction.html#k-means-clustering"><i class="fa fa-check"></i><b>2.1.2</b> k-means clustering</a></li>
<li class="chapter" data-level="2.1.3" data-path="introduction.html"><a href="introduction.html#density-based-clustering"><i class="fa fa-check"></i><b>2.1.3</b> Density-based clustering</a></li>
<li class="chapter" data-level="2.1.4" data-path="introduction.html"><a href="introduction.html#model-based-clustering"><i class="fa fa-check"></i><b>2.1.4</b> Model-based clustering</a></li>
<li class="chapter" data-level="2.1.5" data-path="introduction.html"><a href="introduction.html#ordination"><i class="fa fa-check"></i><b>2.1.5</b> Ordination</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="introduction.html"><a href="introduction.html#supervised-learning-regression-and-classification"><i class="fa fa-check"></i><b>2.2</b> Supervised learning: regression and classification</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="introduction.html"><a href="introduction.html#supervised-regression-using-random-forest"><i class="fa fa-check"></i><b>2.2.1</b> Supervised regression using Random Forest</a></li>
<li class="chapter" data-level="2.2.2" data-path="introduction.html"><a href="introduction.html#supervised-classification-using-random-forest"><i class="fa fa-check"></i><b>2.2.2</b> Supervised classification using Random Forest</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="introduction.html"><a href="introduction.html#introduction-to-tensorflow"><i class="fa fa-check"></i><b>2.3</b> Introduction to Tensorflow</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="introduction.html"><a href="introduction.html#tensorflow-data-containers"><i class="fa fa-check"></i><b>2.3.1</b> Tensorflow data containers</a></li>
<li class="chapter" data-level="2.3.2" data-path="introduction.html"><a href="introduction.html#tensorflow-data-types---good-practise-with-r-tf"><i class="fa fa-check"></i><b>2.3.2</b> Tensorflow data types - good practise with R-TF</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="introduction.html"><a href="introduction.html#introduction-to-pytorch"><i class="fa fa-check"></i><b>2.4</b> Introduction to PyTorch</a>
<ul>
<li class="chapter" data-level="2.4.1" data-path="introduction.html"><a href="introduction.html#pytorch-data-containers"><i class="fa fa-check"></i><b>2.4.1</b> PyTorch data containers</a></li>
<li class="chapter" data-level="2.4.2" data-path="introduction.html"><a href="introduction.html#torch-data-types---good-practise-with-r-tf"><i class="fa fa-check"></i><b>2.4.2</b> Torch data types - good practise with R-TF</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="introduction.html"><a href="introduction.html#first-steps-with-the-keras-framework"><i class="fa fa-check"></i><b>2.5</b> First steps with the keras framework</a>
<ul>
<li class="chapter" data-level="2.5.1" data-path="introduction.html"><a href="introduction.html#example-workflow-in-keras"><i class="fa fa-check"></i><b>2.5.1</b> Example workflow in keras</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="fund.html"><a href="fund.html"><i class="fa fa-check"></i><b>3</b> Fundamental principles and techniques</a>
<ul>
<li class="chapter" data-level="3.1" data-path="fund.html"><a href="fund.html#machine-learning-principles"><i class="fa fa-check"></i><b>3.1</b> Machine learning principles</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="fund.html"><a href="fund.html#optimization"><i class="fa fa-check"></i><b>3.1.1</b> Optimization</a></li>
<li class="chapter" data-level="3.1.2" data-path="fund.html"><a href="fund.html#regularization"><i class="fa fa-check"></i><b>3.1.2</b> Regularization</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="fund.html"><a href="fund.html#tree-based-ml-algorithms"><i class="fa fa-check"></i><b>3.2</b> Tree-based ML algorithms</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="fund.html"><a href="fund.html#classification-and-regression-trees"><i class="fa fa-check"></i><b>3.2.1</b> Classification and Regression Trees</a></li>
<li class="chapter" data-level="3.2.2" data-path="fund.html"><a href="fund.html#random-forest"><i class="fa fa-check"></i><b>3.2.2</b> Random Forest</a></li>
<li class="chapter" data-level="3.2.3" data-path="fund.html"><a href="fund.html#boosted-regression-trees"><i class="fa fa-check"></i><b>3.2.3</b> Boosted regression trees</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="fund.html"><a href="fund.html#distance-based-algorithms"><i class="fa fa-check"></i><b>3.3</b> Distance-based algorithms</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="fund.html"><a href="fund.html#k-nearest-neighbor"><i class="fa fa-check"></i><b>3.3.1</b> k-nearest-neighbor</a></li>
<li class="chapter" data-level="3.3.2" data-path="fund.html"><a href="fund.html#support-vector-machines-svm"><i class="fa fa-check"></i><b>3.3.2</b> Support Vector Machines (SVM)</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="fund.html"><a href="fund.html#artificial-neural-networks"><i class="fa fa-check"></i><b>3.4</b> Artificial neural networks</a></li>
<li class="chapter" data-level="3.5" data-path="fund.html"><a href="fund.html#the-standard-ml-pipeline-at-the-example-of-the-titanic-dataset"><i class="fa fa-check"></i><b>3.5</b> The standard ML pipeline at the example of the titanic dataset</a>
<ul>
<li class="chapter" data-level="3.5.1" data-path="fund.html"><a href="fund.html#data-cleaning"><i class="fa fa-check"></i><b>3.5.1</b> Data cleaning</a></li>
<li class="chapter" data-level="3.5.2" data-path="fund.html"><a href="fund.html#pre-processing-and-feature-selection"><i class="fa fa-check"></i><b>3.5.2</b> Pre-processing and feature selection</a></li>
<li class="chapter" data-level="3.5.3" data-path="fund.html"><a href="fund.html#split-data-for-training-and-testing"><i class="fa fa-check"></i><b>3.5.3</b> Split data for training and testing</a></li>
<li class="chapter" data-level="3.5.4" data-path="fund.html"><a href="fund.html#model-fitting"><i class="fa fa-check"></i><b>3.5.4</b> Model fitting</a></li>
<li class="chapter" data-level="3.5.5" data-path="fund.html"><a href="fund.html#model-evaluation"><i class="fa fa-check"></i><b>3.5.5</b> Model evaluation</a></li>
<li class="chapter" data-level="3.5.6" data-path="fund.html"><a href="fund.html#predictions-and-submission"><i class="fa fa-check"></i><b>3.5.6</b> Predictions and submission</a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="fund.html"><a href="fund.html#mlr"><i class="fa fa-check"></i><b>3.6</b> Bonus - ML pipelines with mlr3</a>
<ul>
<li class="chapter" data-level="3.6.1" data-path="fund.html"><a href="fund.html#mlr3---the-basic-workflow"><i class="fa fa-check"></i><b>3.6.1</b> mlr3 - the basic workflow</a></li>
<li class="chapter" data-level="3.6.2" data-path="fund.html"><a href="fund.html#mlr3---hyper-parameter-tuning"><i class="fa fa-check"></i><b>3.6.2</b> mlr3 - hyper-parameter tuning</a></li>
<li class="chapter" data-level="3.6.3" data-path="fund.html"><a href="fund.html#mlr3---hyper-parameter-tuning-with-oversampling"><i class="fa fa-check"></i><b>3.6.3</b> mlr3 - hyper-parameter tuning with oversampling</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="Deep.html"><a href="Deep.html"><i class="fa fa-check"></i><b>4</b> Deep learning</a>
<ul>
<li class="chapter" data-level="4.1" data-path="Deep.html"><a href="Deep.html#network-architectures"><i class="fa fa-check"></i><b>4.1</b> Network architectures</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="Deep.html"><a href="Deep.html#deep-neural-networks-dnns"><i class="fa fa-check"></i><b>4.1.1</b> Deep neural networks (DNNs)</a></li>
<li class="chapter" data-level="4.1.2" data-path="Deep.html"><a href="Deep.html#convolutional-neural-networks-dnns"><i class="fa fa-check"></i><b>4.1.2</b> Convolutional neural networks (DNNs)</a></li>
<li class="chapter" data-level="4.1.3" data-path="Deep.html"><a href="Deep.html#recurrent-neural-networks-rnns"><i class="fa fa-check"></i><b>4.1.3</b> Recurrent neural networks (RNNs)</a></li>
<li class="chapter" data-level="4.1.4" data-path="Deep.html"><a href="Deep.html#natural-language-processing-nlp"><i class="fa fa-check"></i><b>4.1.4</b> Natural language processing (NLP)</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="Deep.html"><a href="Deep.html#case-study-dropout-and-early-stopping-in-a-deep-neural-network"><i class="fa fa-check"></i><b>4.2</b> Case study: dropout and early stopping in a deep neural network</a></li>
<li class="chapter" data-level="4.3" data-path="Deep.html"><a href="Deep.html#case-study---fitting-a-convolutional-neural-networks-on-mnist"><i class="fa fa-check"></i><b>4.3</b> Case study - fitting a Convolutional Neural Networks on MNIST</a></li>
<li class="chapter" data-level="4.4" data-path="Deep.html"><a href="Deep.html#advanced-training-techniques"><i class="fa fa-check"></i><b>4.4</b> Advanced training techniques</a>
<ul>
<li class="chapter" data-level="4.4.1" data-path="Deep.html"><a href="Deep.html#data-augmentation"><i class="fa fa-check"></i><b>4.4.1</b> Data Augmentation</a></li>
<li class="chapter" data-level="4.4.2" data-path="Deep.html"><a href="Deep.html#transfer"><i class="fa fa-check"></i><b>4.4.2</b> Transfer learning</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="interpretation-and-causality-with-machine-learning.html"><a href="interpretation-and-causality-with-machine-learning.html"><i class="fa fa-check"></i><b>5</b> Interpretation and causality with machine learning</a>
<ul>
<li class="chapter" data-level="5.1" data-path="interpretation-and-causality-with-machine-learning.html"><a href="interpretation-and-causality-with-machine-learning.html#explainable-ai"><i class="fa fa-check"></i><b>5.1</b> Explainable AI</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="interpretation-and-causality-with-machine-learning.html"><a href="interpretation-and-causality-with-machine-learning.html#a-practical-example"><i class="fa fa-check"></i><b>5.1.1</b> A practical example</a></li>
<li class="chapter" data-level="5.1.2" data-path="interpretation-and-causality-with-machine-learning.html"><a href="interpretation-and-causality-with-machine-learning.html#feature-importance"><i class="fa fa-check"></i><b>5.1.2</b> Feature Importance</a></li>
<li class="chapter" data-level="5.1.3" data-path="interpretation-and-causality-with-machine-learning.html"><a href="interpretation-and-causality-with-machine-learning.html#partial-dependencies"><i class="fa fa-check"></i><b>5.1.3</b> Partial dependencies</a></li>
<li class="chapter" data-level="5.1.4" data-path="interpretation-and-causality-with-machine-learning.html"><a href="interpretation-and-causality-with-machine-learning.html#accumulated-local-effects"><i class="fa fa-check"></i><b>5.1.4</b> Accumulated local effects</a></li>
<li class="chapter" data-level="5.1.5" data-path="interpretation-and-causality-with-machine-learning.html"><a href="interpretation-and-causality-with-machine-learning.html#friedmans-h-statistic"><i class="fa fa-check"></i><b>5.1.5</b> Friedmans H-statistic</a></li>
<li class="chapter" data-level="5.1.6" data-path="interpretation-and-causality-with-machine-learning.html"><a href="interpretation-and-causality-with-machine-learning.html#global-explainer---simplifying-the-ml-model"><i class="fa fa-check"></i><b>5.1.6</b> Global explainer - Simplifying the ML model</a></li>
<li class="chapter" data-level="5.1.7" data-path="interpretation-and-causality-with-machine-learning.html"><a href="interpretation-and-causality-with-machine-learning.html#local-explainer---lime-explaining-single-instances-observations"><i class="fa fa-check"></i><b>5.1.7</b> Local explainer - LIME explaining single instances (observations)</a></li>
<li class="chapter" data-level="5.1.8" data-path="interpretation-and-causality-with-machine-learning.html"><a href="interpretation-and-causality-with-machine-learning.html#local-explainer---shapley"><i class="fa fa-check"></i><b>5.1.8</b> Local explainer - Shapley</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="interpretation-and-causality-with-machine-learning.html"><a href="interpretation-and-causality-with-machine-learning.html#causal-inference-and-machine-learning"><i class="fa fa-check"></i><b>5.2</b> Causal inference and machine learning</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="interpretation-and-causality-with-machine-learning.html"><a href="interpretation-and-causality-with-machine-learning.html#causal-inference-on-static-data"><i class="fa fa-check"></i><b>5.2.1</b> Causal inference on static data</a></li>
<li class="chapter" data-level="5.2.2" data-path="interpretation-and-causality-with-machine-learning.html"><a href="interpretation-and-causality-with-machine-learning.html#structural-equation-models"><i class="fa fa-check"></i><b>5.2.2</b> Structural equation models</a></li>
<li class="chapter" data-level="5.2.3" data-path="interpretation-and-causality-with-machine-learning.html"><a href="interpretation-and-causality-with-machine-learning.html#automatic-causal-discovery"><i class="fa fa-check"></i><b>5.2.3</b> Automatic causal discovery</a></li>
<li class="chapter" data-level="5.2.4" data-path="interpretation-and-causality-with-machine-learning.html"><a href="interpretation-and-causality-with-machine-learning.html#causal-inference-on-dynamic-data"><i class="fa fa-check"></i><b>5.2.4</b> Causal inference on dynamic data</a></li>
<li class="chapter" data-level="5.2.5" data-path="interpretation-and-causality-with-machine-learning.html"><a href="interpretation-and-causality-with-machine-learning.html#outlook-for-machine-learning"><i class="fa fa-check"></i><b>5.2.5</b> Outlook for machine learning</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="generative-modeling-and-reinforcement-learning.html"><a href="generative-modeling-and-reinforcement-learning.html"><i class="fa fa-check"></i><b>6</b> Generative modeling and reinforcement learning</a>
<ul>
<li class="chapter" data-level="6.1" data-path="generative-modeling-and-reinforcement-learning.html"><a href="generative-modeling-and-reinforcement-learning.html#autoencoder"><i class="fa fa-check"></i><b>6.1</b> Autoencoder</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="generative-modeling-and-reinforcement-learning.html"><a href="generative-modeling-and-reinforcement-learning.html#autoencoder---dnn-mnist"><i class="fa fa-check"></i><b>6.1.1</b> Autoencoder - DNN MNIST</a></li>
<li class="chapter" data-level="6.1.2" data-path="generative-modeling-and-reinforcement-learning.html"><a href="generative-modeling-and-reinforcement-learning.html#autoencoder---mnist-cnn"><i class="fa fa-check"></i><b>6.1.2</b> Autoencoder - MNIST CNN</a></li>
<li class="chapter" data-level="6.1.3" data-path="generative-modeling-and-reinforcement-learning.html"><a href="generative-modeling-and-reinforcement-learning.html#varational-autoencoder"><i class="fa fa-check"></i><b>6.1.3</b> Varational Autoencoder</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="generative-modeling-and-reinforcement-learning.html"><a href="generative-modeling-and-reinforcement-learning.html#generative-adversarial-network-gans"><i class="fa fa-check"></i><b>6.2</b> Generative adversarial network (GANs)</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="generative-modeling-and-reinforcement-learning.html"><a href="generative-modeling-and-reinforcement-learning.html#mnist---gan-based-on-dnns"><i class="fa fa-check"></i><b>6.2.1</b> MNIST - GAN based on DNNs</a></li>
<li class="chapter" data-level="6.2.2" data-path="generative-modeling-and-reinforcement-learning.html"><a href="generative-modeling-and-reinforcement-learning.html#flower---gan"><i class="fa fa-check"></i><b>6.2.2</b> Flower - GAN</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="generative-modeling-and-reinforcement-learning.html"><a href="generative-modeling-and-reinforcement-learning.html#reinforcement-learning"><i class="fa fa-check"></i><b>6.3</b> Reinforcement learning</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="datasets.html"><a href="datasets.html"><i class="fa fa-check"></i><b>7</b> Datasets</a>
<ul>
<li class="chapter" data-level="7.1" data-path="datasets.html"><a href="datasets.html#titanic"><i class="fa fa-check"></i><b>7.1</b> Titanic</a></li>
<li class="chapter" data-level="7.2" data-path="datasets.html"><a href="datasets.html#plant-pollinator-database"><i class="fa fa-check"></i><b>7.2</b> Plant-pollinator database</a></li>
<li class="chapter" data-level="7.3" data-path="datasets.html"><a href="datasets.html#wine"><i class="fa fa-check"></i><b>7.3</b> Wine</a></li>
<li class="chapter" data-level="7.4" data-path="datasets.html"><a href="datasets.html#nasa"><i class="fa fa-check"></i><b>7.4</b> Nasa</a></li>
<li class="chapter" data-level="7.5" data-path="datasets.html"><a href="datasets.html#flower"><i class="fa fa-check"></i><b>7.5</b> Flower</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Machine Learning and AI in TensorFlow and R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="generative-modeling-and-reinforcement-learning" class="section level1" number="6">
<h1><span class="header-section-number">6</span> Generative modeling and reinforcement learning</h1>
<p>We will explore today more machine learning ideas.</p>
<div id="autoencoder" class="section level2" number="6.1">
<h2><span class="header-section-number">6.1</span> Autoencoder</h2>
<p>An autoencoder is a type of artificial neural network for unsupervised learning. The idea is similar to data compression: the first part of the network compresses (encodes) the data to a low dimensional space (e.g. 2-4 dimensions) and the second part of the network decompresses the encodings and learns to reconstruct the data (think of a hourglass).</p>
<p>Why is this useful? The method is similar to a dimension reduction technique (e.g. PCA) but with the advantage that we don’t have to make any assumptions (but see PCA). For instance, we could first train a AE on genomic expression data with thousands of features, compress them into 2-4 dimensions, and use them then for clustering.</p>
<div id="autoencoder---dnn-mnist" class="section level3" number="6.1.1">
<h3><span class="header-section-number">6.1.1</span> Autoencoder - DNN MNIST</h3>
<p>We will now write an autoencoder for the MNIST data set.</p>
<p>Let’s start with the (usal) MNIST example:</p>
<div class="sourceCode" id="cb420"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb420-1"><a href="generative-modeling-and-reinforcement-learning.html#cb420-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(keras)</span>
<span id="cb420-2"><a href="generative-modeling-and-reinforcement-learning.html#cb420-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tensorflow)</span>
<span id="cb420-3"><a href="generative-modeling-and-reinforcement-learning.html#cb420-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb420-4"><a href="generative-modeling-and-reinforcement-learning.html#cb420-4" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> keras<span class="sc">::</span><span class="fu">dataset_mnist</span>()</span>
<span id="cb420-5"><a href="generative-modeling-and-reinforcement-learning.html#cb420-5" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> keras<span class="sc">::</span><span class="fu">dataset_mnist</span>()</span></code></pre></div>
<p>We don’t need here the labels, our images will be the inputs and the outputs of our final autoencoder</p>
<div class="sourceCode" id="cb421"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb421-1"><a href="generative-modeling-and-reinforcement-learning.html#cb421-1" aria-hidden="true" tabindex="-1"></a>rotate <span class="ot">=</span> <span class="cf">function</span>(x) <span class="fu">t</span>(<span class="fu">apply</span>(x, <span class="dv">2</span>, rev))</span>
<span id="cb421-2"><a href="generative-modeling-and-reinforcement-learning.html#cb421-2" aria-hidden="true" tabindex="-1"></a>imgPlot <span class="ot">=</span> <span class="cf">function</span>(img, <span class="at">title =</span> <span class="st">&quot;&quot;</span>){</span>
<span id="cb421-3"><a href="generative-modeling-and-reinforcement-learning.html#cb421-3" aria-hidden="true" tabindex="-1"></a> col<span class="ot">=</span><span class="fu">grey.colors</span>(<span class="dv">255</span>)</span>
<span id="cb421-4"><a href="generative-modeling-and-reinforcement-learning.html#cb421-4" aria-hidden="true" tabindex="-1"></a> <span class="fu">image</span>(<span class="fu">rotate</span>(img), <span class="at">col =</span> col, <span class="at">xlab =</span> <span class="st">&quot;&quot;</span>, <span class="at">ylab =</span> <span class="st">&quot;&quot;</span>, <span class="at">axes=</span><span class="cn">FALSE</span>, <span class="at">main =</span> <span class="fu">paste0</span>(<span class="st">&quot;Label: &quot;</span>, <span class="fu">as.character</span>(title)))</span>
<span id="cb421-5"><a href="generative-modeling-and-reinforcement-learning.html#cb421-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb421-6"><a href="generative-modeling-and-reinforcement-learning.html#cb421-6" aria-hidden="true" tabindex="-1"></a>train <span class="ot">=</span> data[[<span class="dv">1</span>]]</span>
<span id="cb421-7"><a href="generative-modeling-and-reinforcement-learning.html#cb421-7" aria-hidden="true" tabindex="-1"></a>test <span class="ot">=</span> data[[<span class="dv">2</span>]]</span>
<span id="cb421-8"><a href="generative-modeling-and-reinforcement-learning.html#cb421-8" aria-hidden="true" tabindex="-1"></a>train_x <span class="ot">=</span> <span class="fu">array</span>(train[[<span class="dv">1</span>]]<span class="sc">/</span><span class="dv">255</span>, <span class="fu">c</span>(<span class="fu">dim</span>(train[[<span class="dv">1</span>]])[<span class="dv">1</span>], 784L))</span>
<span id="cb421-9"><a href="generative-modeling-and-reinforcement-learning.html#cb421-9" aria-hidden="true" tabindex="-1"></a>test_x <span class="ot">=</span> <span class="fu">array</span>(test[[<span class="dv">1</span>]]<span class="sc">/</span><span class="dv">255</span>, <span class="fu">c</span>(<span class="fu">dim</span>(test[[<span class="dv">1</span>]])[<span class="dv">1</span>], 784L))</span></code></pre></div>
<p>Our encoder: image (784 dimenions) -&gt; 2 dimensions</p>
<div class="sourceCode" id="cb422"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb422-1"><a href="generative-modeling-and-reinforcement-learning.html#cb422-1" aria-hidden="true" tabindex="-1"></a>down_size_model <span class="ot">=</span> <span class="fu">keras_model_sequential</span>()</span>
<span id="cb422-2"><a href="generative-modeling-and-reinforcement-learning.html#cb422-2" aria-hidden="true" tabindex="-1"></a>down_size_model <span class="sc">%&gt;%</span> </span>
<span id="cb422-3"><a href="generative-modeling-and-reinforcement-learning.html#cb422-3" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_dense</span>(<span class="at">units =</span> 100L, <span class="at">input_shape =</span> <span class="fu">c</span>(784L),<span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb422-4"><a href="generative-modeling-and-reinforcement-learning.html#cb422-4" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_dense</span>(<span class="at">units =</span> 20L, <span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb422-5"><a href="generative-modeling-and-reinforcement-learning.html#cb422-5" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_dense</span>(<span class="at">units =</span> 2L, <span class="at">activation =</span> <span class="st">&quot;linear&quot;</span>)</span></code></pre></div>
<p>Our decoder: 2 dimensions -&gt; 784 dimensions (our image)</p>
<div class="sourceCode" id="cb423"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb423-1"><a href="generative-modeling-and-reinforcement-learning.html#cb423-1" aria-hidden="true" tabindex="-1"></a>up_size_model <span class="ot">=</span> <span class="fu">keras_model_sequential</span>()</span>
<span id="cb423-2"><a href="generative-modeling-and-reinforcement-learning.html#cb423-2" aria-hidden="true" tabindex="-1"></a>up_size_model <span class="sc">%&gt;%</span> </span>
<span id="cb423-3"><a href="generative-modeling-and-reinforcement-learning.html#cb423-3" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_dense</span>(<span class="at">units =</span> 20L, <span class="at">input_shape =</span> <span class="fu">c</span>(2L), <span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb423-4"><a href="generative-modeling-and-reinforcement-learning.html#cb423-4" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_dense</span>(<span class="at">units =</span> 100L, <span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb423-5"><a href="generative-modeling-and-reinforcement-learning.html#cb423-5" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_dense</span>(<span class="at">units =</span> 784L, <span class="at">activation =</span> <span class="st">&quot;sigmoid&quot;</span>)</span></code></pre></div>
<p>We can use the non-sequential model type to connect the two models! (we did the same in the transfer learning chapter!)</p>
<div class="sourceCode" id="cb424"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb424-1"><a href="generative-modeling-and-reinforcement-learning.html#cb424-1" aria-hidden="true" tabindex="-1"></a>autoencoder <span class="ot">=</span> <span class="fu">keras_model</span>(<span class="at">inputs=</span>down_size_model<span class="sc">$</span>input,  <span class="at">outputs=</span><span class="fu">up_size_model</span>(down_size_model<span class="sc">$</span>output))</span>
<span id="cb424-2"><a href="generative-modeling-and-reinforcement-learning.html#cb424-2" aria-hidden="true" tabindex="-1"></a>autoencoder<span class="sc">$</span><span class="fu">compile</span>(<span class="at">loss =</span> loss_binary_crossentropy, <span class="at">optimizer =</span> <span class="fu">optimizer_adamax</span>(<span class="fl">0.01</span>))</span>
<span id="cb424-3"><a href="generative-modeling-and-reinforcement-learning.html#cb424-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(autoencoder)</span></code></pre></div>
<pre><code>## Model: &quot;model&quot;
## __________________________________________________________________________________________________________________________________________________________
## Layer (type)                                                         Output Shape                                                 Param #                 
## ==========================================================================================================================================================
## dense_32_input (InputLayer)                                          [(None, 784)]                                                0                       
## __________________________________________________________________________________________________________________________________________________________
## dense_32 (Dense)                                                     (None, 100)                                                  78500                   
## __________________________________________________________________________________________________________________________________________________________
## dense_33 (Dense)                                                     (None, 20)                                                   2020                    
## __________________________________________________________________________________________________________________________________________________________
## dense_34 (Dense)                                                     (None, 2)                                                    42                      
## __________________________________________________________________________________________________________________________________________________________
## sequential_11 (Sequential)                                           (None, 784)                                                  81344                   
## ==========================================================================================================================================================
## Total params: 161,906
## Trainable params: 161,906
## Non-trainable params: 0
## __________________________________________________________________________________________________________________________________________________________</code></pre>
<div class="sourceCode" id="cb426"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb426-1"><a href="generative-modeling-and-reinforcement-learning.html#cb426-1" aria-hidden="true" tabindex="-1"></a>image <span class="ot">=</span> <span class="fu">autoencoder</span>(train_x[<span class="dv">1</span>,,<span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb426-2"><a href="generative-modeling-and-reinforcement-learning.html#cb426-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb426-3"><a href="generative-modeling-and-reinforcement-learning.html#cb426-3" aria-hidden="true" tabindex="-1"></a><span class="fu">imgPlot</span>(<span class="fu">array</span>(train_x[<span class="dv">1</span>,,<span class="at">drop =</span> <span class="cn">FALSE</span>], <span class="fu">c</span>(<span class="dv">28</span>, <span class="dv">28</span>)))</span>
<span id="cb426-4"><a href="generative-modeling-and-reinforcement-learning.html#cb426-4" aria-hidden="true" tabindex="-1"></a><span class="fu">imgPlot</span>(<span class="fu">array</span>(image<span class="sc">$</span><span class="fu">numpy</span>(), <span class="fu">c</span>(<span class="dv">28</span>, <span class="dv">28</span>)))</span></code></pre></div>
<p><img src="_main_files/figure-html/AEmnistoutput-1.png" width="672" /></p>
<p>Fit the autoencoder (inputs == outputs!!)</p>
<div class="sourceCode" id="cb427"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb427-1"><a href="generative-modeling-and-reinforcement-learning.html#cb427-1" aria-hidden="true" tabindex="-1"></a>autoencoder <span class="sc">%&gt;%</span> </span>
<span id="cb427-2"><a href="generative-modeling-and-reinforcement-learning.html#cb427-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(<span class="at">x =</span> train_x, <span class="at">y =</span> train_x, <span class="at">epochs =</span> 5L, <span class="at">batch_size =</span> 128L)</span></code></pre></div>
<p>Visualization of the latent variables</p>
<div class="sourceCode" id="cb428"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb428-1"><a href="generative-modeling-and-reinforcement-learning.html#cb428-1" aria-hidden="true" tabindex="-1"></a>pred_dim <span class="ot">=</span> <span class="fu">down_size_model</span>(test_x)</span>
<span id="cb428-2"><a href="generative-modeling-and-reinforcement-learning.html#cb428-2" aria-hidden="true" tabindex="-1"></a>reconstr_pred <span class="ot">=</span> <span class="fu">up_size_model</span>(pred_dim)</span>
<span id="cb428-3"><a href="generative-modeling-and-reinforcement-learning.html#cb428-3" aria-hidden="true" tabindex="-1"></a><span class="fu">imgPlot</span>(<span class="fu">array</span>(reconstr_pred[<span class="dv">10</span>,]<span class="sc">$</span><span class="fu">numpy</span>(), <span class="at">dim =</span> <span class="fu">c</span>(28L, 28L)))</span></code></pre></div>
<p><img src="_main_files/figure-html/AEvisualization-1.png" width="672" /></p>
<div class="sourceCode" id="cb429"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb429-1"><a href="generative-modeling-and-reinforcement-learning.html#cb429-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb429-2"><a href="generative-modeling-and-reinforcement-learning.html#cb429-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pred_dim<span class="sc">$</span><span class="fu">numpy</span>()[,<span class="dv">1</span>], pred_dim<span class="sc">$</span><span class="fu">numpy</span>()[,<span class="dv">2</span>], <span class="at">col =</span> test[[<span class="dv">2</span>]]<span class="sc">+</span>1L)</span></code></pre></div>
<p><img src="_main_files/figure-html/AEvisualization-2.png" width="672" /></p>
</div>
<div id="autoencoder---mnist-cnn" class="section level3" number="6.1.2">
<h3><span class="header-section-number">6.1.2</span> Autoencoder - MNIST CNN</h3>
<p>We can also use CNNs isntead of DNNs. There is also an inverse convolutional layer:</p>
<p>Prepare data:</p>
<div class="sourceCode" id="cb430"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb430-1"><a href="generative-modeling-and-reinforcement-learning.html#cb430-1" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> tf<span class="sc">$</span>keras<span class="sc">$</span>datasets<span class="sc">$</span>mnist<span class="sc">$</span><span class="fu">load_data</span>()</span>
<span id="cb430-2"><a href="generative-modeling-and-reinforcement-learning.html#cb430-2" aria-hidden="true" tabindex="-1"></a>train <span class="ot">=</span> data[[<span class="dv">1</span>]]</span>
<span id="cb430-3"><a href="generative-modeling-and-reinforcement-learning.html#cb430-3" aria-hidden="true" tabindex="-1"></a>train_x <span class="ot">=</span> <span class="fu">array</span>(train[[<span class="dv">1</span>]]<span class="sc">/</span><span class="dv">255</span>, <span class="fu">c</span>(<span class="fu">dim</span>(train[[<span class="dv">1</span>]]), 1L))</span>
<span id="cb430-4"><a href="generative-modeling-and-reinforcement-learning.html#cb430-4" aria-hidden="true" tabindex="-1"></a>test_x <span class="ot">=</span> <span class="fu">array</span>(data[[<span class="dv">2</span>]][[<span class="dv">1</span>]]<span class="sc">/</span><span class="dv">255</span>, <span class="fu">c</span>(<span class="fu">dim</span>(data[[<span class="dv">2</span>]][[<span class="dv">1</span>]]<span class="sc">/</span><span class="dv">255</span>), 1L))</span></code></pre></div>
<p>Then defining the downsize model</p>
<div class="sourceCode" id="cb431"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb431-1"><a href="generative-modeling-and-reinforcement-learning.html#cb431-1" aria-hidden="true" tabindex="-1"></a>down_size_model <span class="ot">=</span> <span class="fu">keras_model_sequential</span>()</span>
<span id="cb431-2"><a href="generative-modeling-and-reinforcement-learning.html#cb431-2" aria-hidden="true" tabindex="-1"></a>down_size_model <span class="sc">%&gt;%</span> </span>
<span id="cb431-3"><a href="generative-modeling-and-reinforcement-learning.html#cb431-3" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_conv_2d</span>(<span class="at">filters =</span> 32L, <span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>, <span class="at">kernel_size =</span> <span class="fu">c</span>(2L,2L), </span>
<span id="cb431-4"><a href="generative-modeling-and-reinforcement-learning.html#cb431-4" aria-hidden="true" tabindex="-1"></a>                          <span class="at">input_shape =</span> <span class="fu">c</span>(28L, 28L, 1L), <span class="at">strides =</span> <span class="fu">c</span>(4L, 4L)) <span class="sc">%&gt;%</span> </span>
<span id="cb431-5"><a href="generative-modeling-and-reinforcement-learning.html#cb431-5" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_conv_2d</span>(<span class="at">filters =</span> 16L, <span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>, </span>
<span id="cb431-6"><a href="generative-modeling-and-reinforcement-learning.html#cb431-6" aria-hidden="true" tabindex="-1"></a>                           <span class="at">kernel_size =</span> <span class="fu">c</span>(7L,7L), <span class="at">strides =</span> <span class="fu">c</span>(1L, 1L)) <span class="sc">%&gt;%</span> </span>
<span id="cb431-7"><a href="generative-modeling-and-reinforcement-learning.html#cb431-7" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_flatten</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb431-8"><a href="generative-modeling-and-reinforcement-learning.html#cb431-8" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_dense</span>(<span class="at">units =</span> 2L, <span class="at">activation =</span> <span class="st">&quot;linear&quot;</span>)</span></code></pre></div>
<p>Define the upsize model</p>
<div class="sourceCode" id="cb432"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb432-1"><a href="generative-modeling-and-reinforcement-learning.html#cb432-1" aria-hidden="true" tabindex="-1"></a>up_size_model <span class="ot">=</span> <span class="fu">keras_model_sequential</span>()</span>
<span id="cb432-2"><a href="generative-modeling-and-reinforcement-learning.html#cb432-2" aria-hidden="true" tabindex="-1"></a>up_size_model <span class="sc">%&gt;%</span> </span>
<span id="cb432-3"><a href="generative-modeling-and-reinforcement-learning.html#cb432-3" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_dense</span>(<span class="at">units =</span> 8L, <span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>, <span class="at">input_shape =</span> <span class="fu">c</span>(2L)) <span class="sc">%&gt;%</span> </span>
<span id="cb432-4"><a href="generative-modeling-and-reinforcement-learning.html#cb432-4" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_reshape</span>(<span class="at">target_shape =</span> <span class="fu">c</span>(1L, 1L, 8L)) <span class="sc">%&gt;%</span> </span>
<span id="cb432-5"><a href="generative-modeling-and-reinforcement-learning.html#cb432-5" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_conv_2d_transpose</span>(<span class="at">filters =</span> 16L, <span class="at">kernel_size =</span> <span class="fu">c</span>(<span class="dv">7</span>,<span class="dv">7</span>), <span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>, <span class="at">strides =</span> <span class="fu">c</span>(1L,1L)) <span class="sc">%&gt;%</span> </span>
<span id="cb432-6"><a href="generative-modeling-and-reinforcement-learning.html#cb432-6" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_conv_2d_transpose</span>(<span class="at">filters =</span> 32L, <span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>, <span class="at">kernel_size =</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>), <span class="at">strides =</span> <span class="fu">c</span>(4L,4L)) <span class="sc">%&gt;%</span> </span>
<span id="cb432-7"><a href="generative-modeling-and-reinforcement-learning.html#cb432-7" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_conv_2d</span>(<span class="at">filters =</span> <span class="dv">1</span>, <span class="at">kernel_size =</span> <span class="fu">c</span>(1L, 1L), <span class="at">strides =</span> <span class="fu">c</span>(1L, 1L), <span class="at">activation =</span> <span class="st">&quot;sigmoid&quot;</span>)</span></code></pre></div>
<p>Combine the two models and fit it</p>
<div class="sourceCode" id="cb433"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb433-1"><a href="generative-modeling-and-reinforcement-learning.html#cb433-1" aria-hidden="true" tabindex="-1"></a>autoencoder <span class="ot">=</span> tf<span class="sc">$</span>keras<span class="sc">$</span>models<span class="sc">$</span><span class="fu">Model</span>(<span class="at">inputs =</span> down_size_model<span class="sc">$</span>input, <span class="at">outputs =</span> <span class="fu">up_size_model</span>(down_size_model<span class="sc">$</span>output))</span>
<span id="cb433-2"><a href="generative-modeling-and-reinforcement-learning.html#cb433-2" aria-hidden="true" tabindex="-1"></a>autoencoder<span class="sc">$</span><span class="fu">compile</span>(<span class="at">loss =</span> loss_binary_crossentropy, <span class="at">optimizer =</span> <span class="fu">optimizer_rmsprop</span>(<span class="fl">0.001</span>))</span>
<span id="cb433-3"><a href="generative-modeling-and-reinforcement-learning.html#cb433-3" aria-hidden="true" tabindex="-1"></a>autoencoder<span class="sc">$</span><span class="fu">fit</span>(<span class="at">x =</span> tf<span class="sc">$</span><span class="fu">constant</span>(train_x), <span class="at">y =</span> tf<span class="sc">$</span><span class="fu">constant</span>(train_x), <span class="at">epochs =</span> 10L, <span class="at">batch_size =</span> 128L)</span></code></pre></div>
<pre><code>## &lt;tensorflow.python.keras.callbacks.History&gt;</code></pre>
<p>Test it</p>
<div class="sourceCode" id="cb435"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb435-1"><a href="generative-modeling-and-reinforcement-learning.html#cb435-1" aria-hidden="true" tabindex="-1"></a>pred_dim <span class="ot">=</span> <span class="fu">down_size_model</span>(tf<span class="sc">$</span><span class="fu">constant</span>(test_x, <span class="st">&quot;float32&quot;</span>))</span>
<span id="cb435-2"><a href="generative-modeling-and-reinforcement-learning.html#cb435-2" aria-hidden="true" tabindex="-1"></a>reconstr_pred <span class="ot">=</span> <span class="fu">autoencoder</span>(tf<span class="sc">$</span><span class="fu">constant</span>(test_x, <span class="st">&quot;float32&quot;</span>))</span>
<span id="cb435-3"><a href="generative-modeling-and-reinforcement-learning.html#cb435-3" aria-hidden="true" tabindex="-1"></a><span class="fu">imgPlot</span>(reconstr_pred[<span class="dv">10</span>,,,]<span class="sc">$</span><span class="fu">numpy</span>()[,,<span class="dv">1</span>])</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-201-1.png" width="672" /></p>
<div class="sourceCode" id="cb436"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb436-1"><a href="generative-modeling-and-reinforcement-learning.html#cb436-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pred_dim[,<span class="dv">1</span>]<span class="sc">$</span><span class="fu">numpy</span>(), pred_dim[,<span class="dv">2</span>]<span class="sc">$</span><span class="fu">numpy</span>(), <span class="at">col =</span> test[[<span class="dv">2</span>]]<span class="sc">+</span>1L)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-201-2.png" width="672" /></p>
<div class="sourceCode" id="cb437"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb437-1"><a href="generative-modeling-and-reinforcement-learning.html#cb437-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Generate new images!</span></span>
<span id="cb437-2"><a href="generative-modeling-and-reinforcement-learning.html#cb437-2" aria-hidden="true" tabindex="-1"></a>new <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">10</span>,<span class="dv">10</span>), <span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb437-3"><a href="generative-modeling-and-reinforcement-learning.html#cb437-3" aria-hidden="true" tabindex="-1"></a><span class="fu">imgPlot</span>(<span class="fu">array</span>(<span class="fu">up_size_model</span>(new)<span class="sc">$</span><span class="fu">numpy</span>(), <span class="fu">c</span>(28L, 28L)))</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-201-3.png" width="672" /></p>
</div>
<div id="varational-autoencoder" class="section level3" number="6.1.3">
<h3><span class="header-section-number">6.1.3</span> Varational Autoencoder</h3>
<p>The difference between a variational and a normal autoencoder is that a variational autoencoder assumes a distribution for the latent variables.</p>
<p>To do so we will use the tensorflow probability, first need to split the data again</p>
<div class="sourceCode" id="cb438"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb438-1"><a href="generative-modeling-and-reinforcement-learning.html#cb438-1" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages(&quot;tfprobability&quot;)</span></span>
<span id="cb438-2"><a href="generative-modeling-and-reinforcement-learning.html#cb438-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tfprobability)</span>
<span id="cb438-3"><a href="generative-modeling-and-reinforcement-learning.html#cb438-3" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> tf<span class="sc">$</span>keras<span class="sc">$</span>datasets<span class="sc">$</span>mnist<span class="sc">$</span><span class="fu">load_data</span>()</span>
<span id="cb438-4"><a href="generative-modeling-and-reinforcement-learning.html#cb438-4" aria-hidden="true" tabindex="-1"></a>train <span class="ot">=</span> data[[<span class="dv">1</span>]]</span>
<span id="cb438-5"><a href="generative-modeling-and-reinforcement-learning.html#cb438-5" aria-hidden="true" tabindex="-1"></a>train_x <span class="ot">=</span> <span class="fu">array</span>(train[[<span class="dv">1</span>]]<span class="sc">/</span><span class="dv">255</span>, <span class="fu">c</span>(<span class="fu">dim</span>(train[[<span class="dv">1</span>]]), 1L))</span></code></pre></div>
<p>We will use tensorflow probability to define priors for our latent variables</p>
<div class="sourceCode" id="cb439"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb439-1"><a href="generative-modeling-and-reinforcement-learning.html#cb439-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tfprobability)</span>
<span id="cb439-2"><a href="generative-modeling-and-reinforcement-learning.html#cb439-2" aria-hidden="true" tabindex="-1"></a>tfp <span class="ot">=</span> reticulate<span class="sc">::</span><span class="fu">import</span>(<span class="st">&quot;tensorflow_probability&quot;</span>)</span></code></pre></div>
<p>Build the two networks:</p>
<div class="sourceCode" id="cb440"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb440-1"><a href="generative-modeling-and-reinforcement-learning.html#cb440-1" aria-hidden="true" tabindex="-1"></a>encoded <span class="ot">=</span> 2L</span>
<span id="cb440-2"><a href="generative-modeling-and-reinforcement-learning.html#cb440-2" aria-hidden="true" tabindex="-1"></a>prior <span class="ot">=</span> tfp<span class="sc">$</span>distributions<span class="sc">$</span><span class="fu">Independent</span>(tfp<span class="sc">$</span>distributions<span class="sc">$</span><span class="fu">Normal</span>(tf<span class="sc">$</span><span class="fu">zeros</span>(2L),<span class="fl">1.0</span>),1L)</span>
<span id="cb440-3"><a href="generative-modeling-and-reinforcement-learning.html#cb440-3" aria-hidden="true" tabindex="-1"></a>prior <span class="ot">=</span> <span class="fu">tfd_independent</span>(<span class="fu">tfd_normal</span>(<span class="fu">c</span>(<span class="fl">0.0</span>, <span class="fl">0.0</span>), <span class="fl">1.0</span>), 1L)</span>
<span id="cb440-4"><a href="generative-modeling-and-reinforcement-learning.html#cb440-4" aria-hidden="true" tabindex="-1"></a>down_size_model <span class="ot">=</span> <span class="fu">keras_model_sequential</span>()</span>
<span id="cb440-5"><a href="generative-modeling-and-reinforcement-learning.html#cb440-5" aria-hidden="true" tabindex="-1"></a>down_size_model <span class="sc">%&gt;%</span> </span>
<span id="cb440-6"><a href="generative-modeling-and-reinforcement-learning.html#cb440-6" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_conv_2d</span>(<span class="at">filters =</span> 32L, <span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>, <span class="at">kernel_size =</span> <span class="fu">c</span>(2L,2L), </span>
<span id="cb440-7"><a href="generative-modeling-and-reinforcement-learning.html#cb440-7" aria-hidden="true" tabindex="-1"></a>                          <span class="at">input_shape =</span> <span class="fu">c</span>(28L, 28L, 1L), <span class="at">strides =</span> <span class="fu">c</span>(4L, 4L)) <span class="sc">%&gt;%</span> </span>
<span id="cb440-8"><a href="generative-modeling-and-reinforcement-learning.html#cb440-8" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_conv_2d</span>(<span class="at">filters =</span> 16L, <span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>, </span>
<span id="cb440-9"><a href="generative-modeling-and-reinforcement-learning.html#cb440-9" aria-hidden="true" tabindex="-1"></a>                           <span class="at">kernel_size =</span> <span class="fu">c</span>(7L,7L), <span class="at">strides =</span> <span class="fu">c</span>(1L, 1L)) <span class="sc">%&gt;%</span> </span>
<span id="cb440-10"><a href="generative-modeling-and-reinforcement-learning.html#cb440-10" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_flatten</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb440-11"><a href="generative-modeling-and-reinforcement-learning.html#cb440-11" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_dense</span>(<span class="at">units =</span> 4L, <span class="at">activation =</span> <span class="st">&quot;linear&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb440-12"><a href="generative-modeling-and-reinforcement-learning.html#cb440-12" aria-hidden="true" tabindex="-1"></a> tfprobability<span class="sc">::</span><span class="fu">layer_independent_normal</span>(2L, <span class="at">activity_regularizer =</span> tfp<span class="sc">$</span>layers<span class="sc">$</span><span class="fu">KLDivergenceRegularizer</span>(<span class="at">distribution_b =</span> prior))</span>
<span id="cb440-13"><a href="generative-modeling-and-reinforcement-learning.html#cb440-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb440-14"><a href="generative-modeling-and-reinforcement-learning.html#cb440-14" aria-hidden="true" tabindex="-1"></a>up_size_model <span class="ot">=</span> <span class="fu">keras_model_sequential</span>()</span>
<span id="cb440-15"><a href="generative-modeling-and-reinforcement-learning.html#cb440-15" aria-hidden="true" tabindex="-1"></a>up_size_model <span class="sc">%&gt;%</span> </span>
<span id="cb440-16"><a href="generative-modeling-and-reinforcement-learning.html#cb440-16" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_dense</span>(<span class="at">units =</span> 8L, <span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>, <span class="at">input_shape =</span> <span class="fu">c</span>(2L)) <span class="sc">%&gt;%</span> </span>
<span id="cb440-17"><a href="generative-modeling-and-reinforcement-learning.html#cb440-17" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_reshape</span>(<span class="at">target_shape =</span> <span class="fu">c</span>(1L, 1L, 8L)) <span class="sc">%&gt;%</span> </span>
<span id="cb440-18"><a href="generative-modeling-and-reinforcement-learning.html#cb440-18" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_conv_2d_transpose</span>(<span class="at">filters =</span> 16L, <span class="at">kernel_size =</span> <span class="fu">c</span>(<span class="dv">7</span>,<span class="dv">7</span>), <span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>, <span class="at">strides =</span> <span class="fu">c</span>(1L,1L),<span class="at">use_bias =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb440-19"><a href="generative-modeling-and-reinforcement-learning.html#cb440-19" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_conv_2d_transpose</span>(<span class="at">filters =</span> 32L, <span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>, <span class="at">kernel_size =</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>), <span class="at">strides =</span> <span class="fu">c</span>(4L,4L),<span class="at">use_bias =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb440-20"><a href="generative-modeling-and-reinforcement-learning.html#cb440-20" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_conv_2d</span>(<span class="at">filters =</span> <span class="dv">1</span>, <span class="at">kernel_size =</span> <span class="fu">c</span>(1L, 1L), <span class="at">strides =</span> <span class="fu">c</span>(1L, 1L), <span class="at">activation =</span> <span class="st">&quot;sigmoid&quot;</span>,<span class="at">use_bias =</span> <span class="cn">FALSE</span>)</span>
<span id="cb440-21"><a href="generative-modeling-and-reinforcement-learning.html#cb440-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb440-22"><a href="generative-modeling-and-reinforcement-learning.html#cb440-22" aria-hidden="true" tabindex="-1"></a>VAE <span class="ot">=</span> <span class="fu">keras_model</span>(<span class="at">inputs =</span> down_size_model<span class="sc">$</span>inputs,</span>
<span id="cb440-23"><a href="generative-modeling-and-reinforcement-learning.html#cb440-23" aria-hidden="true" tabindex="-1"></a>                  <span class="at">outputs =</span> <span class="fu">up_size_model</span>(down_size_model<span class="sc">$</span>outputs))</span></code></pre></div>
<p>Compile and fit Model:</p>
<div class="sourceCode" id="cb441"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb441-1"><a href="generative-modeling-and-reinforcement-learning.html#cb441-1" aria-hidden="true" tabindex="-1"></a>loss_binary <span class="ot">=</span> <span class="cf">function</span>(true, pred) {<span class="fu">loss_binary_crossentropy</span>(true, pred)<span class="sc">*</span><span class="fl">28.0</span><span class="sc">*</span><span class="fl">28.0</span>}</span>
<span id="cb441-2"><a href="generative-modeling-and-reinforcement-learning.html#cb441-2" aria-hidden="true" tabindex="-1"></a>VAE<span class="sc">$</span><span class="fu">compile</span>(<span class="at">loss =</span> loss_binary, <span class="at">optimizer =</span> <span class="fu">optimizer_adamax</span>())</span>
<span id="cb441-3"><a href="generative-modeling-and-reinforcement-learning.html#cb441-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb441-4"><a href="generative-modeling-and-reinforcement-learning.html#cb441-4" aria-hidden="true" tabindex="-1"></a>VAE<span class="sc">$</span><span class="fu">fit</span>(train_x, train_x, <span class="at">epochs =</span> 5L)</span></code></pre></div>
<pre><code>## &lt;tensorflow.python.keras.callbacks.History&gt;</code></pre>
<div class="sourceCode" id="cb443"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb443-1"><a href="generative-modeling-and-reinforcement-learning.html#cb443-1" aria-hidden="true" tabindex="-1"></a>dist <span class="ot">=</span> <span class="fu">down_size_model</span>(train_x[<span class="dv">1</span><span class="sc">:</span><span class="dv">2000</span>,,,,<span class="at">drop=</span><span class="cn">FALSE</span>])</span>
<span id="cb443-2"><a href="generative-modeling-and-reinforcement-learning.html#cb443-2" aria-hidden="true" tabindex="-1"></a>images <span class="ot">=</span> <span class="fu">up_size_model</span>( dist<span class="sc">$</span><span class="fu">sample</span>()[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,] )</span>
<span id="cb443-3"><a href="generative-modeling-and-reinforcement-learning.html#cb443-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb443-4"><a href="generative-modeling-and-reinforcement-learning.html#cb443-4" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>))</span>
<span id="cb443-5"><a href="generative-modeling-and-reinforcement-learning.html#cb443-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) <span class="fu">imgPlot</span>(images[i,,,<span class="dv">1</span>]<span class="sc">$</span><span class="fu">numpy</span>())</span></code></pre></div>
<p><img src="_main_files/figure-html/VAEmnist-1.png" width="672" /></p>
<div class="sourceCode" id="cb444"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb444-1"><a href="generative-modeling-and-reinforcement-learning.html#cb444-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb444-2"><a href="generative-modeling-and-reinforcement-learning.html#cb444-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(dist<span class="sc">$</span><span class="fu">mean</span>()<span class="sc">$</span><span class="fu">numpy</span>()[,<span class="dv">1</span>], dist<span class="sc">$</span><span class="fu">mean</span>()<span class="sc">$</span><span class="fu">numpy</span>()[,<span class="dv">2</span>], <span class="at">col =</span> train[[<span class="dv">2</span>]]<span class="sc">+</span>1L)</span></code></pre></div>
<p><img src="_main_files/figure-html/VAEmnist-2.png" width="672" /></p>
<details>
<summary>
<strong><span style="color: #CC2FAA">Exercise: Flower VAE</span></strong>
</summary>
<p>
<div class="sourceCode" id="cb445"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb445-1"><a href="generative-modeling-and-reinforcement-learning.html#cb445-1" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> EcoData<span class="sc">::</span><span class="fu">dataset_flower</span>()</span>
<span id="cb445-2"><a href="generative-modeling-and-reinforcement-learning.html#cb445-2" aria-hidden="true" tabindex="-1"></a>test <span class="ot">=</span> data<span class="sc">$</span>test<span class="sc">/</span><span class="dv">255</span></span>
<span id="cb445-3"><a href="generative-modeling-and-reinforcement-learning.html#cb445-3" aria-hidden="true" tabindex="-1"></a>train <span class="ot">=</span> data<span class="sc">$</span>train<span class="sc">/</span><span class="dv">255</span></span>
<span id="cb445-4"><a href="generative-modeling-and-reinforcement-learning.html#cb445-4" aria-hidden="true" tabindex="-1"></a>train <span class="ot">=</span> abind<span class="sc">::</span><span class="fu">abind</span>(<span class="fu">list</span>(train, test), <span class="at">along =</span> 1L)</span></code></pre></div>
<div class="sourceCode" id="cb446"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb446-1"><a href="generative-modeling-and-reinforcement-learning.html#cb446-1" aria-hidden="true" tabindex="-1"></a>encoded <span class="ot">=</span> 10L</span>
<span id="cb446-2"><a href="generative-modeling-and-reinforcement-learning.html#cb446-2" aria-hidden="true" tabindex="-1"></a>prior <span class="ot">=</span> tfp<span class="sc">$</span>distributions<span class="sc">$</span><span class="fu">Independent</span>(tfp<span class="sc">$</span>distributions<span class="sc">$</span><span class="fu">Normal</span>(tf<span class="sc">$</span><span class="fu">zeros</span>(encoded),<span class="fl">1.0</span>),1L)</span>
<span id="cb446-3"><a href="generative-modeling-and-reinforcement-learning.html#cb446-3" aria-hidden="true" tabindex="-1"></a>down_size_model <span class="ot">=</span> tf<span class="sc">$</span>keras<span class="sc">$</span>models<span class="sc">$</span><span class="fu">Sequential</span>(<span class="fu">list</span>(</span>
<span id="cb446-4"><a href="generative-modeling-and-reinforcement-learning.html#cb446-4" aria-hidden="true" tabindex="-1"></a>  tf<span class="sc">$</span>keras<span class="sc">$</span>layers<span class="sc">$</span><span class="fu">InputLayer</span>(<span class="at">input_shape =</span> <span class="fu">c</span>(80L, 80L, 3L)),</span>
<span id="cb446-5"><a href="generative-modeling-and-reinforcement-learning.html#cb446-5" aria-hidden="true" tabindex="-1"></a>  tf<span class="sc">$</span>keras<span class="sc">$</span>layers<span class="sc">$</span><span class="fu">Conv2D</span>(<span class="at">filters =</span> 32L, <span class="at">activation =</span> tf<span class="sc">$</span>nn<span class="sc">$</span>leaky_relu, <span class="at">kernel_size =</span> 5L, <span class="at">strides =</span>1L),</span>
<span id="cb446-6"><a href="generative-modeling-and-reinforcement-learning.html#cb446-6" aria-hidden="true" tabindex="-1"></a>  tf<span class="sc">$</span>keras<span class="sc">$</span>layers<span class="sc">$</span><span class="fu">Conv2D</span>(<span class="at">filters =</span> 32L, <span class="at">activation =</span> tf<span class="sc">$</span>nn<span class="sc">$</span>leaky_relu, <span class="at">kernel_size =</span> 5L, <span class="at">strides =</span>2L),</span>
<span id="cb446-7"><a href="generative-modeling-and-reinforcement-learning.html#cb446-7" aria-hidden="true" tabindex="-1"></a>  tf<span class="sc">$</span>keras<span class="sc">$</span>layers<span class="sc">$</span><span class="fu">Conv2D</span>(<span class="at">filters =</span> 64L, <span class="at">activation =</span> tf<span class="sc">$</span>nn<span class="sc">$</span>leaky_relu, <span class="at">kernel_size =</span> 5L, <span class="at">strides =</span>1L),</span>
<span id="cb446-8"><a href="generative-modeling-and-reinforcement-learning.html#cb446-8" aria-hidden="true" tabindex="-1"></a>  tf<span class="sc">$</span>keras<span class="sc">$</span>layers<span class="sc">$</span><span class="fu">Conv2D</span>(<span class="at">filters =</span> 64L, <span class="at">activation =</span> tf<span class="sc">$</span>nn<span class="sc">$</span>leaky_relu, <span class="at">kernel_size =</span> 5L, <span class="at">strides =</span>2L),</span>
<span id="cb446-9"><a href="generative-modeling-and-reinforcement-learning.html#cb446-9" aria-hidden="true" tabindex="-1"></a>  tf<span class="sc">$</span>keras<span class="sc">$</span>layers<span class="sc">$</span><span class="fu">Conv2D</span>(<span class="at">filters =</span> 128L, <span class="at">activation =</span> tf<span class="sc">$</span>nn<span class="sc">$</span>leaky_relu, <span class="at">kernel_size =</span> 7L, <span class="at">strides =</span>1L),</span>
<span id="cb446-10"><a href="generative-modeling-and-reinforcement-learning.html#cb446-10" aria-hidden="true" tabindex="-1"></a>  tf<span class="sc">$</span>keras<span class="sc">$</span>layers<span class="sc">$</span><span class="fu">Flatten</span>(),</span>
<span id="cb446-11"><a href="generative-modeling-and-reinforcement-learning.html#cb446-11" aria-hidden="true" tabindex="-1"></a>  tf<span class="sc">$</span>keras<span class="sc">$</span>layers<span class="sc">$</span><span class="fu">Dense</span>(<span class="at">units =</span> encoded<span class="sc">*</span>2L, <span class="at">activation =</span> <span class="cn">NULL</span>),</span>
<span id="cb446-12"><a href="generative-modeling-and-reinforcement-learning.html#cb446-12" aria-hidden="true" tabindex="-1"></a>  tfp<span class="sc">$</span>layers<span class="sc">$</span><span class="fu">IndependentNormal</span>(encoded, <span class="at">activity_regularizer =</span> tfp<span class="sc">$</span>layers<span class="sc">$</span><span class="fu">KLDivergenceRegularizer</span>(prior, <span class="at">weight =</span> <span class="fl">0.1</span>))</span>
<span id="cb446-13"><a href="generative-modeling-and-reinforcement-learning.html#cb446-13" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb446-14"><a href="generative-modeling-and-reinforcement-learning.html#cb446-14" aria-hidden="true" tabindex="-1"></a>up_size_model <span class="ot">=</span> tf<span class="sc">$</span>keras<span class="sc">$</span>models<span class="sc">$</span><span class="fu">Sequential</span>(<span class="fu">list</span>(</span>
<span id="cb446-15"><a href="generative-modeling-and-reinforcement-learning.html#cb446-15" aria-hidden="true" tabindex="-1"></a>  tf<span class="sc">$</span>keras<span class="sc">$</span>layers<span class="sc">$</span><span class="fu">InputLayer</span>(<span class="at">input_shape =</span> encoded),</span>
<span id="cb446-16"><a href="generative-modeling-and-reinforcement-learning.html#cb446-16" aria-hidden="true" tabindex="-1"></a>  tf<span class="sc">$</span>keras<span class="sc">$</span>layers<span class="sc">$</span><span class="fu">Dense</span>(<span class="at">units =</span> 8192L, <span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>),</span>
<span id="cb446-17"><a href="generative-modeling-and-reinforcement-learning.html#cb446-17" aria-hidden="true" tabindex="-1"></a>  tf<span class="sc">$</span>keras<span class="sc">$</span>layers<span class="sc">$</span><span class="fu">Reshape</span>(<span class="at">target_shape =</span>  <span class="fu">c</span>(8L, 8L, 128L)),</span>
<span id="cb446-18"><a href="generative-modeling-and-reinforcement-learning.html#cb446-18" aria-hidden="true" tabindex="-1"></a>  tf<span class="sc">$</span>keras<span class="sc">$</span>layers<span class="sc">$</span><span class="fu">Conv2DTranspose</span>(<span class="at">filters =</span> 128L, <span class="at">kernel_size =</span> 7L, <span class="at">activation =</span> tf<span class="sc">$</span>nn<span class="sc">$</span>leaky_relu, <span class="at">strides =</span> 1L,<span class="at">use_bias =</span> <span class="cn">FALSE</span>),</span>
<span id="cb446-19"><a href="generative-modeling-and-reinforcement-learning.html#cb446-19" aria-hidden="true" tabindex="-1"></a>  tf<span class="sc">$</span>keras<span class="sc">$</span>layers<span class="sc">$</span><span class="fu">Conv2DTranspose</span>(<span class="at">filters =</span> 64L, <span class="at">kernel_size =</span> 5L, <span class="at">activation =</span> tf<span class="sc">$</span>nn<span class="sc">$</span>leaky_relu, <span class="at">strides =</span> 2L,<span class="at">use_bias =</span> <span class="cn">FALSE</span>),</span>
<span id="cb446-20"><a href="generative-modeling-and-reinforcement-learning.html#cb446-20" aria-hidden="true" tabindex="-1"></a>  tf<span class="sc">$</span>keras<span class="sc">$</span>layers<span class="sc">$</span><span class="fu">Conv2DTranspose</span>(<span class="at">filters =</span> 64L, <span class="at">kernel_size =</span> 5L, <span class="at">activation =</span> tf<span class="sc">$</span>nn<span class="sc">$</span>leaky_relu, <span class="at">strides =</span> 1L,<span class="at">use_bias =</span> <span class="cn">FALSE</span>),</span>
<span id="cb446-21"><a href="generative-modeling-and-reinforcement-learning.html#cb446-21" aria-hidden="true" tabindex="-1"></a>  tf<span class="sc">$</span>keras<span class="sc">$</span>layers<span class="sc">$</span><span class="fu">Conv2DTranspose</span>(<span class="at">filters =</span> 32L, <span class="at">kernel_size =</span> 5L, <span class="at">activation =</span> tf<span class="sc">$</span>nn<span class="sc">$</span>leaky_relu, <span class="at">strides =</span> 2L,<span class="at">use_bias =</span> <span class="cn">FALSE</span>),</span>
<span id="cb446-22"><a href="generative-modeling-and-reinforcement-learning.html#cb446-22" aria-hidden="true" tabindex="-1"></a>  tf<span class="sc">$</span>keras<span class="sc">$</span>layers<span class="sc">$</span><span class="fu">Conv2DTranspose</span>(<span class="at">filters =</span> 32L, <span class="at">kernel_size =</span> 5L, <span class="at">activation =</span> tf<span class="sc">$</span>nn<span class="sc">$</span>leaky_relu, <span class="at">strides =</span> 1L,<span class="at">use_bias =</span> <span class="cn">FALSE</span>),</span>
<span id="cb446-23"><a href="generative-modeling-and-reinforcement-learning.html#cb446-23" aria-hidden="true" tabindex="-1"></a>  tf<span class="sc">$</span>keras<span class="sc">$</span>layers<span class="sc">$</span><span class="fu">Conv2DTranspose</span>(<span class="at">filters =</span> 3L, <span class="at">kernel_size =</span> <span class="fu">c</span>(4L,4L), <span class="at">activation =</span> <span class="st">&quot;sigmoid&quot;</span>, <span class="at">strides =</span> <span class="fu">c</span>(1L, 1L),<span class="at">use_bias =</span> <span class="cn">FALSE</span>)</span>
<span id="cb446-24"><a href="generative-modeling-and-reinforcement-learning.html#cb446-24" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb446-25"><a href="generative-modeling-and-reinforcement-learning.html#cb446-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb446-26"><a href="generative-modeling-and-reinforcement-learning.html#cb446-26" aria-hidden="true" tabindex="-1"></a>VAE <span class="ot">=</span> tf<span class="sc">$</span>keras<span class="sc">$</span>models<span class="sc">$</span><span class="fu">Model</span>(<span class="at">inputs =</span> down_size_model<span class="sc">$</span>inputs, </span>
<span id="cb446-27"><a href="generative-modeling-and-reinforcement-learning.html#cb446-27" aria-hidden="true" tabindex="-1"></a>                            <span class="at">outputs =</span> <span class="fu">up_size_model</span>(down_size_model<span class="sc">$</span>outputs))</span>
<span id="cb446-28"><a href="generative-modeling-and-reinforcement-learning.html#cb446-28" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(VAE)</span></code></pre></div>
<pre><code>## Model: &quot;model_3&quot;
## __________________________________________________________________________________________________________________________________________________________
## Layer (type)                                                         Output Shape                                                 Param #                 
## ==========================================================================================================================================================
## input_1 (InputLayer)                                                 [(None, 80, 80, 3)]                                          0                       
## __________________________________________________________________________________________________________________________________________________________
## conv2d_8 (Conv2D)                                                    (None, 76, 76, 32)                                           2432                    
## __________________________________________________________________________________________________________________________________________________________
## conv2d_9 (Conv2D)                                                    (None, 36, 36, 32)                                           25632                   
## __________________________________________________________________________________________________________________________________________________________
## conv2d_10 (Conv2D)                                                   (None, 32, 32, 64)                                           51264                   
## __________________________________________________________________________________________________________________________________________________________
## conv2d_11 (Conv2D)                                                   (None, 14, 14, 64)                                           102464                  
## __________________________________________________________________________________________________________________________________________________________
## conv2d_12 (Conv2D)                                                   (None, 8, 8, 128)                                            401536                  
## __________________________________________________________________________________________________________________________________________________________
## flatten_3 (Flatten)                                                  (None, 8192)                                                 0                       
## __________________________________________________________________________________________________________________________________________________________
## dense_42 (Dense)                                                     (None, 20)                                                   163860                  
## __________________________________________________________________________________________________________________________________________________________
## independent_normal_1 (IndependentNormal)                             multiple                                                     0                       
## __________________________________________________________________________________________________________________________________________________________
## sequential_17 (Sequential)                                           (None, 80, 80, 3)                                            1278464                 
## ==========================================================================================================================================================
## Total params: 2,025,652
## Trainable params: 2,025,652
## Non-trainable params: 0
## __________________________________________________________________________________________________________________________________________________________</code></pre>
<div class="sourceCode" id="cb448"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb448-1"><a href="generative-modeling-and-reinforcement-learning.html#cb448-1" aria-hidden="true" tabindex="-1"></a>be <span class="ot">=</span> <span class="cf">function</span>(true, pred) tf<span class="sc">$</span>losses<span class="sc">$</span><span class="fu">binary_crossentropy</span>(true, pred)<span class="sc">*</span><span class="fl">80.0</span><span class="sc">*</span><span class="fl">80.0</span></span>
<span id="cb448-2"><a href="generative-modeling-and-reinforcement-learning.html#cb448-2" aria-hidden="true" tabindex="-1"></a>VAE<span class="sc">$</span><span class="fu">compile</span>(<span class="at">loss =</span> be, <span class="at">optimizer =</span> tf<span class="sc">$</span>keras<span class="sc">$</span>optimizers<span class="sc">$</span><span class="fu">Adamax</span>(<span class="at">learning_rate =</span> <span class="fl">0.0003</span>))</span>
<span id="cb448-3"><a href="generative-modeling-and-reinforcement-learning.html#cb448-3" aria-hidden="true" tabindex="-1"></a>VAE<span class="sc">$</span><span class="fu">fit</span>(<span class="at">x =</span> train, <span class="at">y =</span> train, <span class="at">epochs =</span> 50L, <span class="at">shuffle =</span> <span class="cn">TRUE</span>, <span class="at">batch_size =</span> 20L)</span></code></pre></div>
<pre><code>## &lt;tensorflow.python.keras.callbacks.History&gt;</code></pre>
<div class="sourceCode" id="cb450"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb450-1"><a href="generative-modeling-and-reinforcement-learning.html#cb450-1" aria-hidden="true" tabindex="-1"></a>dist <span class="ot">=</span> <span class="fu">down_size_model</span>(train[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,,,])</span>
<span id="cb450-2"><a href="generative-modeling-and-reinforcement-learning.html#cb450-2" aria-hidden="true" tabindex="-1"></a>images <span class="ot">=</span> <span class="fu">up_size_model</span>( dist<span class="sc">$</span><span class="fu">sample</span>()[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,] )</span>
<span id="cb450-3"><a href="generative-modeling-and-reinforcement-learning.html#cb450-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb450-4"><a href="generative-modeling-and-reinforcement-learning.html#cb450-4" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">1</span>), <span class="at">mar =</span> <span class="fu">rep</span>(<span class="dv">1</span>,<span class="dv">4</span>))</span>
<span id="cb450-5"><a href="generative-modeling-and-reinforcement-learning.html#cb450-5" aria-hidden="true" tabindex="-1"></a>scales<span class="sc">::</span><span class="fu">rescale</span>(images[<span class="dv">1</span>,,,]<span class="sc">$</span><span class="fu">numpy</span>(), <span class="at">to =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">255</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb450-6"><a href="generative-modeling-and-reinforcement-learning.html#cb450-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">image_to_array</span>() <span class="sc">%&gt;%</span></span>
<span id="cb450-7"><a href="generative-modeling-and-reinforcement-learning.html#cb450-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">/</span><span class="st">`</span>(., <span class="dv">255</span>) <span class="sc">%&gt;%</span></span>
<span id="cb450-8"><a href="generative-modeling-and-reinforcement-learning.html#cb450-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.raster</span>() <span class="sc">%&gt;%</span></span>
<span id="cb450-9"><a href="generative-modeling-and-reinforcement-learning.html#cb450-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>()</span>
<span id="cb450-10"><a href="generative-modeling-and-reinforcement-learning.html#cb450-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb450-11"><a href="generative-modeling-and-reinforcement-learning.html#cb450-11" aria-hidden="true" tabindex="-1"></a>scales<span class="sc">::</span><span class="fu">rescale</span>(images[<span class="dv">2</span>,,,]<span class="sc">$</span><span class="fu">numpy</span>(), <span class="at">to =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">255</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb450-12"><a href="generative-modeling-and-reinforcement-learning.html#cb450-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">image_to_array</span>() <span class="sc">%&gt;%</span></span>
<span id="cb450-13"><a href="generative-modeling-and-reinforcement-learning.html#cb450-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">/</span><span class="st">`</span>(., <span class="dv">255</span>) <span class="sc">%&gt;%</span></span>
<span id="cb450-14"><a href="generative-modeling-and-reinforcement-learning.html#cb450-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.raster</span>() <span class="sc">%&gt;%</span></span>
<span id="cb450-15"><a href="generative-modeling-and-reinforcement-learning.html#cb450-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>()</span>
<span id="cb450-16"><a href="generative-modeling-and-reinforcement-learning.html#cb450-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb450-17"><a href="generative-modeling-and-reinforcement-learning.html#cb450-17" aria-hidden="true" tabindex="-1"></a>scales<span class="sc">::</span><span class="fu">rescale</span>(images[<span class="dv">3</span>,,,]<span class="sc">$</span><span class="fu">numpy</span>(), <span class="at">to =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">255</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb450-18"><a href="generative-modeling-and-reinforcement-learning.html#cb450-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">image_to_array</span>() <span class="sc">%&gt;%</span></span>
<span id="cb450-19"><a href="generative-modeling-and-reinforcement-learning.html#cb450-19" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">/</span><span class="st">`</span>(., <span class="dv">255</span>) <span class="sc">%&gt;%</span></span>
<span id="cb450-20"><a href="generative-modeling-and-reinforcement-learning.html#cb450-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.raster</span>() <span class="sc">%&gt;%</span></span>
<span id="cb450-21"><a href="generative-modeling-and-reinforcement-learning.html#cb450-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-207-1.png" width="672" /></p>
<div class="sourceCode" id="cb451"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb451-1"><a href="generative-modeling-and-reinforcement-learning.html#cb451-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span></code></pre></div>
</details>
<p><br/></p>
</div>
</div>
<div id="generative-adversarial-network-gans" class="section level2" number="6.2">
<h2><span class="header-section-number">6.2</span> Generative adversarial network (GANs)</h2>
<p>The idea of generative adversarial network (GAN) is that two neural networks contest with each other in a game. On network is creating data and is trying to “trick” the other network into thinking that the generated data is real. The generator (similar to the decoder in AEs) creates new images from noise and tries to convince the discriminator that this is a real image. The discriminator is getting a mix of true (from the dataset) and artificially generated images from the generator. Thereby, the loss of the generator rises when fakes are identified as fakes by the discriminator (simple binary_crossentropy loss, 0/1…) and the loss of the discriminator rises when fakes are identified as fakes (class 1) and true images as true images (class 0), again simple binary crossentropy.</p>
<p>A possible application is to create pictures that look like real photographs (e.g. <img src="https://thispersondoesnotexist.com/" /> ). However, the application of GANs today is much wider than just the creation of data. For example, GANs can also be used to “augment” data, i.e. to create new data and thereby improve the fitted model.</p>
<div id="mnist---gan-based-on-dnns" class="section level3" number="6.2.1">
<h3><span class="header-section-number">6.2.1</span> MNIST - GAN based on DNNs</h3>
<p>We will now explore this on the MNIST data set.</p>
<div class="sourceCode" id="cb452"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb452-1"><a href="generative-modeling-and-reinforcement-learning.html#cb452-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(keras)</span>
<span id="cb452-2"><a href="generative-modeling-and-reinforcement-learning.html#cb452-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tensorflow)</span>
<span id="cb452-3"><a href="generative-modeling-and-reinforcement-learning.html#cb452-3" aria-hidden="true" tabindex="-1"></a>rotate <span class="ot">=</span> <span class="cf">function</span>(x) <span class="fu">t</span>(<span class="fu">apply</span>(x, <span class="dv">2</span>, rev))</span>
<span id="cb452-4"><a href="generative-modeling-and-reinforcement-learning.html#cb452-4" aria-hidden="true" tabindex="-1"></a>imgPlot <span class="ot">=</span> <span class="cf">function</span>(img, <span class="at">title =</span> <span class="st">&quot;&quot;</span>){</span>
<span id="cb452-5"><a href="generative-modeling-and-reinforcement-learning.html#cb452-5" aria-hidden="true" tabindex="-1"></a> col<span class="ot">=</span><span class="fu">grey.colors</span>(<span class="dv">255</span>)</span>
<span id="cb452-6"><a href="generative-modeling-and-reinforcement-learning.html#cb452-6" aria-hidden="true" tabindex="-1"></a> <span class="fu">image</span>(<span class="fu">rotate</span>(img), <span class="at">col =</span> col, <span class="at">xlab =</span> <span class="st">&quot;&quot;</span>, <span class="at">ylab =</span> <span class="st">&quot;&quot;</span>, <span class="at">axes=</span><span class="cn">FALSE</span>, <span class="at">main =</span> <span class="fu">paste0</span>(<span class="st">&quot;Label: &quot;</span>, <span class="fu">as.character</span>(title)))</span>
<span id="cb452-7"><a href="generative-modeling-and-reinforcement-learning.html#cb452-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>We don’t need the test set</p>
<div class="sourceCode" id="cb453"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb453-1"><a href="generative-modeling-and-reinforcement-learning.html#cb453-1" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> <span class="fu">dataset_mnist</span>()</span>
<span id="cb453-2"><a href="generative-modeling-and-reinforcement-learning.html#cb453-2" aria-hidden="true" tabindex="-1"></a>train <span class="ot">=</span> data<span class="sc">$</span>train</span>
<span id="cb453-3"><a href="generative-modeling-and-reinforcement-learning.html#cb453-3" aria-hidden="true" tabindex="-1"></a>train_x <span class="ot">=</span> <span class="fu">array</span>((train<span class="sc">$</span>x<span class="fl">-127.5</span>)<span class="sc">/</span><span class="fl">127.5</span>, <span class="fu">c</span>(<span class="fu">dim</span>(train<span class="sc">$</span>x)[<span class="dv">1</span>], 784L))</span></code></pre></div>
<p>We also need a function to sample images for the discriminator.</p>
<div class="sourceCode" id="cb454"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb454-1"><a href="generative-modeling-and-reinforcement-learning.html#cb454-1" aria-hidden="true" tabindex="-1"></a>batch_size <span class="ot">=</span> 32L</span>
<span id="cb454-2"><a href="generative-modeling-and-reinforcement-learning.html#cb454-2" aria-hidden="true" tabindex="-1"></a>get_batch <span class="ot">=</span> <span class="cf">function</span>(){  <span class="co"># Helper function to get batches of images</span></span>
<span id="cb454-3"><a href="generative-modeling-and-reinforcement-learning.html#cb454-3" aria-hidden="true" tabindex="-1"></a> indices <span class="ot">=</span> <span class="fu">sample.int</span>(<span class="fu">nrow</span>(train_x), batch_size)</span>
<span id="cb454-4"><a href="generative-modeling-and-reinforcement-learning.html#cb454-4" aria-hidden="true" tabindex="-1"></a> <span class="fu">return</span>(tf<span class="sc">$</span><span class="fu">constant</span>(train_x[indices,], <span class="st">&quot;float32&quot;</span>))</span>
<span id="cb454-5"><a href="generative-modeling-and-reinforcement-learning.html#cb454-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb454-6"><a href="generative-modeling-and-reinforcement-learning.html#cb454-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb454-7"><a href="generative-modeling-and-reinforcement-learning.html#cb454-7" aria-hidden="true" tabindex="-1"></a>dataset <span class="ot">=</span> tf<span class="sc">$</span>data<span class="sc">$</span>Dataset<span class="sc">$</span><span class="fu">from_tensor_slices</span>(tf<span class="sc">$</span><span class="fu">constant</span>(train_x, <span class="st">&quot;float32&quot;</span>))</span>
<span id="cb454-8"><a href="generative-modeling-and-reinforcement-learning.html#cb454-8" aria-hidden="true" tabindex="-1"></a>dataset<span class="sc">$</span><span class="fu">batch</span>(batch_size)</span></code></pre></div>
<pre><code>## &lt;BatchDataset shapes: (None, 784), types: tf.float32&gt;</code></pre>
<p>Define generator model:</p>
<div class="sourceCode" id="cb456"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb456-1"><a href="generative-modeling-and-reinforcement-learning.html#cb456-1" aria-hidden="true" tabindex="-1"></a>get_generator <span class="ot">=</span> <span class="cf">function</span>(){</span>
<span id="cb456-2"><a href="generative-modeling-and-reinforcement-learning.html#cb456-2" aria-hidden="true" tabindex="-1"></a> generator <span class="ot">=</span> <span class="fu">keras_model_sequential</span>()</span>
<span id="cb456-3"><a href="generative-modeling-and-reinforcement-learning.html#cb456-3" aria-hidden="true" tabindex="-1"></a> generator <span class="sc">%&gt;%</span> </span>
<span id="cb456-4"><a href="generative-modeling-and-reinforcement-learning.html#cb456-4" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_dense</span>(<span class="at">units =</span> 200L ,<span class="at">input_shape =</span> <span class="fu">c</span>(100L)) <span class="sc">%&gt;%</span> </span>
<span id="cb456-5"><a href="generative-modeling-and-reinforcement-learning.html#cb456-5" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_activation_leaky_relu</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb456-6"><a href="generative-modeling-and-reinforcement-learning.html#cb456-6" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_dense</span>(<span class="at">units =</span> 200L) <span class="sc">%&gt;%</span> </span>
<span id="cb456-7"><a href="generative-modeling-and-reinforcement-learning.html#cb456-7" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_activation_leaky_relu</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb456-8"><a href="generative-modeling-and-reinforcement-learning.html#cb456-8" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_dense</span>(<span class="at">units =</span> 784L, <span class="at">activation =</span> <span class="st">&quot;tanh&quot;</span>)</span>
<span id="cb456-9"><a href="generative-modeling-and-reinforcement-learning.html#cb456-9" aria-hidden="true" tabindex="-1"></a> <span class="fu">return</span>(generator)</span>
<span id="cb456-10"><a href="generative-modeling-and-reinforcement-learning.html#cb456-10" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>And we also test the generator model:</p>
<div class="sourceCode" id="cb457"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb457-1"><a href="generative-modeling-and-reinforcement-learning.html#cb457-1" aria-hidden="true" tabindex="-1"></a>generator <span class="ot">=</span> <span class="fu">get_generator</span>()</span>
<span id="cb457-2"><a href="generative-modeling-and-reinforcement-learning.html#cb457-2" aria-hidden="true" tabindex="-1"></a>sample <span class="ot">=</span> tf<span class="sc">$</span>random<span class="sc">$</span><span class="fu">normal</span>(<span class="fu">c</span>(1L, 100L))</span>
<span id="cb457-3"><a href="generative-modeling-and-reinforcement-learning.html#cb457-3" aria-hidden="true" tabindex="-1"></a><span class="fu">imgPlot</span>(<span class="fu">array</span>(<span class="fu">generator</span>(sample)<span class="sc">$</span><span class="fu">numpy</span>(), <span class="fu">c</span>(28L, 28L)))</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-212-1.png" width="672" /></p>
<p>The noise (random vector with 100 values) is passed through the network and the output correspond to the number of pixels of one MNIST image (784). We therefore now define the discriminator function</p>
<div class="sourceCode" id="cb458"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb458-1"><a href="generative-modeling-and-reinforcement-learning.html#cb458-1" aria-hidden="true" tabindex="-1"></a>get_discriminator <span class="ot">=</span> <span class="cf">function</span>(){</span>
<span id="cb458-2"><a href="generative-modeling-and-reinforcement-learning.html#cb458-2" aria-hidden="true" tabindex="-1"></a> discriminator <span class="ot">=</span> <span class="fu">keras_model_sequential</span>()</span>
<span id="cb458-3"><a href="generative-modeling-and-reinforcement-learning.html#cb458-3" aria-hidden="true" tabindex="-1"></a> discriminator <span class="sc">%&gt;%</span> </span>
<span id="cb458-4"><a href="generative-modeling-and-reinforcement-learning.html#cb458-4" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_dense</span>(<span class="at">units =</span> 200L, <span class="at">input_shape =</span> <span class="fu">c</span>(784L)) <span class="sc">%&gt;%</span> </span>
<span id="cb458-5"><a href="generative-modeling-and-reinforcement-learning.html#cb458-5" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_activation_leaky_relu</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb458-6"><a href="generative-modeling-and-reinforcement-learning.html#cb458-6" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_dense</span>(<span class="at">units =</span> 100L) <span class="sc">%&gt;%</span> </span>
<span id="cb458-7"><a href="generative-modeling-and-reinforcement-learning.html#cb458-7" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_activation_leaky_relu</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb458-8"><a href="generative-modeling-and-reinforcement-learning.html#cb458-8" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_dense</span>(<span class="at">units =</span> 1L, <span class="at">activation =</span> <span class="st">&quot;sigmoid&quot;</span>)</span>
<span id="cb458-9"><a href="generative-modeling-and-reinforcement-learning.html#cb458-9" aria-hidden="true" tabindex="-1"></a> <span class="fu">return</span>(discriminator)</span>
<span id="cb458-10"><a href="generative-modeling-and-reinforcement-learning.html#cb458-10" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>And also the discriminator function</p>
<div class="sourceCode" id="cb459"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb459-1"><a href="generative-modeling-and-reinforcement-learning.html#cb459-1" aria-hidden="true" tabindex="-1"></a>discriminator <span class="ot">=</span> <span class="fu">get_discriminator</span>()</span>
<span id="cb459-2"><a href="generative-modeling-and-reinforcement-learning.html#cb459-2" aria-hidden="true" tabindex="-1"></a><span class="fu">discriminator</span>(<span class="fu">generator</span>(tf<span class="sc">$</span>random<span class="sc">$</span><span class="fu">normal</span>(<span class="fu">c</span>(1L, 100L))))</span></code></pre></div>
<pre><code>## tf.Tensor([[0.45401824]], shape=(1, 1), dtype=float32)</code></pre>
<p>The normal architecture of a binary classifier (will get images as input)</p>
<p>We also have to define the loss functions for both networks, the binary crossentropy. However, we have to encode the true and predicted values for the two networks individually.</p>
<p>The discriminator will get two losses - one for identifying fake images as fake, and one for identifying real MNIST images as real images.</p>
<p>The generator will just get one loss - was it able to deceive the discriminator?</p>
<div class="sourceCode" id="cb461"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb461-1"><a href="generative-modeling-and-reinforcement-learning.html#cb461-1" aria-hidden="true" tabindex="-1"></a>ce <span class="ot">=</span> tf<span class="sc">$</span>keras<span class="sc">$</span>losses<span class="sc">$</span><span class="fu">BinaryCrossentropy</span>(<span class="at">from_logits =</span> <span class="cn">TRUE</span>)</span>
<span id="cb461-2"><a href="generative-modeling-and-reinforcement-learning.html#cb461-2" aria-hidden="true" tabindex="-1"></a>loss_discriminator <span class="ot">=</span> <span class="cf">function</span>(real, fake){</span>
<span id="cb461-3"><a href="generative-modeling-and-reinforcement-learning.html#cb461-3" aria-hidden="true" tabindex="-1"></a> real_loss <span class="ot">=</span> <span class="fu">ce</span>(tf<span class="sc">$</span><span class="fu">ones_like</span>(real), real)</span>
<span id="cb461-4"><a href="generative-modeling-and-reinforcement-learning.html#cb461-4" aria-hidden="true" tabindex="-1"></a> fake_loss <span class="ot">=</span> <span class="fu">ce</span>(tf<span class="sc">$</span><span class="fu">zeros_like</span>(fake), fake)</span>
<span id="cb461-5"><a href="generative-modeling-and-reinforcement-learning.html#cb461-5" aria-hidden="true" tabindex="-1"></a> <span class="fu">return</span>(real_loss<span class="sc">+</span>fake_loss)</span>
<span id="cb461-6"><a href="generative-modeling-and-reinforcement-learning.html#cb461-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb461-7"><a href="generative-modeling-and-reinforcement-learning.html#cb461-7" aria-hidden="true" tabindex="-1"></a>loss_generator <span class="ot">=</span> <span class="cf">function</span>(fake){</span>
<span id="cb461-8"><a href="generative-modeling-and-reinforcement-learning.html#cb461-8" aria-hidden="true" tabindex="-1"></a> <span class="fu">return</span>(<span class="fu">ce</span>(tf<span class="sc">$</span><span class="fu">ones_like</span>(fake), fake))</span>
<span id="cb461-9"><a href="generative-modeling-and-reinforcement-learning.html#cb461-9" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Each network will get its own optimizer (in a GAN the networks are treated independently)</p>
<div class="sourceCode" id="cb462"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb462-1"><a href="generative-modeling-and-reinforcement-learning.html#cb462-1" aria-hidden="true" tabindex="-1"></a>gen_opt <span class="ot">=</span> tf<span class="sc">$</span>keras<span class="sc">$</span>optimizers<span class="sc">$</span><span class="fu">RMSprop</span>(<span class="fl">1e-4</span>)</span>
<span id="cb462-2"><a href="generative-modeling-and-reinforcement-learning.html#cb462-2" aria-hidden="true" tabindex="-1"></a>disc_opt <span class="ot">=</span> tf<span class="sc">$</span>keras<span class="sc">$</span>optimizers<span class="sc">$</span><span class="fu">RMSprop</span>(<span class="fl">1e-4</span>)</span></code></pre></div>
<p>We have to write here our own training loop (we cannot use the fit function).
In each iteration (for each batch) we will do the following (the GradientTape records computations to do automatic differenation):</p>
<ol style="list-style-type: decimal">
<li>sample noise</li>
<li>Generator creates images from the noise</li>
<li>Discriminator will make predictions for fake images and real images (response is a probability between [0,1])</li>
<li>Calculate loss for generator</li>
<li>Calculate loss for discriminator</li>
<li>Calculate gradients for weights and the loss</li>
<li>Update weights of generator</li>
<li>Update weights of discriminator</li>
<li>return losses</li>
</ol>
<div class="sourceCode" id="cb463"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb463-1"><a href="generative-modeling-and-reinforcement-learning.html#cb463-1" aria-hidden="true" tabindex="-1"></a>generator <span class="ot">=</span> <span class="fu">get_generator</span>()</span>
<span id="cb463-2"><a href="generative-modeling-and-reinforcement-learning.html#cb463-2" aria-hidden="true" tabindex="-1"></a>discriminator <span class="ot">=</span> <span class="fu">get_discriminator</span>()</span>
<span id="cb463-3"><a href="generative-modeling-and-reinforcement-learning.html#cb463-3" aria-hidden="true" tabindex="-1"></a>train_step <span class="ot">=</span> <span class="cf">function</span>(images){</span>
<span id="cb463-4"><a href="generative-modeling-and-reinforcement-learning.html#cb463-4" aria-hidden="true" tabindex="-1"></a> noise <span class="ot">=</span> tf<span class="sc">$</span>random<span class="sc">$</span><span class="fu">normal</span>(<span class="fu">c</span>(128L, 100L))</span>
<span id="cb463-5"><a href="generative-modeling-and-reinforcement-learning.html#cb463-5" aria-hidden="true" tabindex="-1"></a> <span class="fu">with</span>(tf<span class="sc">$</span><span class="fu">GradientTape</span>(<span class="at">persistent =</span> <span class="cn">TRUE</span>) <span class="sc">%as%</span> tape,{</span>
<span id="cb463-6"><a href="generative-modeling-and-reinforcement-learning.html#cb463-6" aria-hidden="true" tabindex="-1"></a>   gen_images <span class="ot">=</span> <span class="fu">generator</span>(noise)</span>
<span id="cb463-7"><a href="generative-modeling-and-reinforcement-learning.html#cb463-7" aria-hidden="true" tabindex="-1"></a>   fake_output <span class="ot">=</span> <span class="fu">discriminator</span>(gen_images)</span>
<span id="cb463-8"><a href="generative-modeling-and-reinforcement-learning.html#cb463-8" aria-hidden="true" tabindex="-1"></a>   real_output <span class="ot">=</span> <span class="fu">discriminator</span>(images)</span>
<span id="cb463-9"><a href="generative-modeling-and-reinforcement-learning.html#cb463-9" aria-hidden="true" tabindex="-1"></a>   gen_loss <span class="ot">=</span> <span class="fu">loss_generator</span>(fake_output)</span>
<span id="cb463-10"><a href="generative-modeling-and-reinforcement-learning.html#cb463-10" aria-hidden="true" tabindex="-1"></a>   disc_loss <span class="ot">=</span> <span class="fu">loss_discriminator</span>(real_output, fake_output)</span>
<span id="cb463-11"><a href="generative-modeling-and-reinforcement-learning.html#cb463-11" aria-hidden="true" tabindex="-1"></a> })</span>
<span id="cb463-12"><a href="generative-modeling-and-reinforcement-learning.html#cb463-12" aria-hidden="true" tabindex="-1"></a> gen_grads <span class="ot">=</span> tape<span class="sc">$</span><span class="fu">gradient</span>(gen_loss, generator<span class="sc">$</span>weights)</span>
<span id="cb463-13"><a href="generative-modeling-and-reinforcement-learning.html#cb463-13" aria-hidden="true" tabindex="-1"></a> disc_grads <span class="ot">=</span> tape<span class="sc">$</span><span class="fu">gradient</span>(disc_loss, discriminator<span class="sc">$</span>weights)</span>
<span id="cb463-14"><a href="generative-modeling-and-reinforcement-learning.html#cb463-14" aria-hidden="true" tabindex="-1"></a> <span class="fu">rm</span>(tape)</span>
<span id="cb463-15"><a href="generative-modeling-and-reinforcement-learning.html#cb463-15" aria-hidden="true" tabindex="-1"></a> gen_opt<span class="sc">$</span><span class="fu">apply_gradients</span>(purrr<span class="sc">::</span><span class="fu">transpose</span>(<span class="fu">list</span>(gen_grads, generator<span class="sc">$</span>weights)))</span>
<span id="cb463-16"><a href="generative-modeling-and-reinforcement-learning.html#cb463-16" aria-hidden="true" tabindex="-1"></a> disc_opt<span class="sc">$</span><span class="fu">apply_gradients</span>(purrr<span class="sc">::</span><span class="fu">transpose</span>(<span class="fu">list</span>(disc_grads, discriminator<span class="sc">$</span>weights)))</span>
<span id="cb463-17"><a href="generative-modeling-and-reinforcement-learning.html#cb463-17" aria-hidden="true" tabindex="-1"></a> <span class="fu">return</span>(<span class="fu">c</span>(gen_loss, disc_loss))</span>
<span id="cb463-18"><a href="generative-modeling-and-reinforcement-learning.html#cb463-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb463-19"><a href="generative-modeling-and-reinforcement-learning.html#cb463-19" aria-hidden="true" tabindex="-1"></a>train_step <span class="ot">=</span> tf<span class="sc">$</span><span class="st">`</span><span class="at">function</span><span class="st">`</span>(reticulate<span class="sc">::</span><span class="fu">py_func</span>(train_step))</span></code></pre></div>
<p>Now we can finally train our networks in a traings loop:</p>
<ol style="list-style-type: decimal">
<li>Create networks</li>
<li>get batch of images</li>
<li>run train_step function</li>
<li>print losses</li>
<li>repeat step 2-4 for number of epochs</li>
</ol>
<div class="sourceCode" id="cb464"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb464-1"><a href="generative-modeling-and-reinforcement-learning.html#cb464-1" aria-hidden="true" tabindex="-1"></a>batch_size <span class="ot">=</span> 128L</span>
<span id="cb464-2"><a href="generative-modeling-and-reinforcement-learning.html#cb464-2" aria-hidden="true" tabindex="-1"></a>epochs <span class="ot">=</span> 15L</span>
<span id="cb464-3"><a href="generative-modeling-and-reinforcement-learning.html#cb464-3" aria-hidden="true" tabindex="-1"></a>steps <span class="ot">=</span> <span class="fu">as.integer</span>(<span class="fu">nrow</span>(train_x)<span class="sc">/</span>batch_size)</span>
<span id="cb464-4"><a href="generative-modeling-and-reinforcement-learning.html#cb464-4" aria-hidden="true" tabindex="-1"></a>counter <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb464-5"><a href="generative-modeling-and-reinforcement-learning.html#cb464-5" aria-hidden="true" tabindex="-1"></a>gen_loss <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb464-6"><a href="generative-modeling-and-reinforcement-learning.html#cb464-6" aria-hidden="true" tabindex="-1"></a>disc_loss <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb464-7"><a href="generative-modeling-and-reinforcement-learning.html#cb464-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb464-8"><a href="generative-modeling-and-reinforcement-learning.html#cb464-8" aria-hidden="true" tabindex="-1"></a>dataset2 <span class="ot">=</span> dataset</span>
<span id="cb464-9"><a href="generative-modeling-and-reinforcement-learning.html#cb464-9" aria-hidden="true" tabindex="-1"></a>dataset2 <span class="ot">=</span> dataset2<span class="sc">$</span><span class="fu">prefetch</span>(tf<span class="sc">$</span>data<span class="sc">$</span>AUTOTUNE)</span>
<span id="cb464-10"><a href="generative-modeling-and-reinforcement-learning.html#cb464-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb464-11"><a href="generative-modeling-and-reinforcement-learning.html#cb464-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb464-12"><a href="generative-modeling-and-reinforcement-learning.html#cb464-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(e <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>epochs) {</span>
<span id="cb464-13"><a href="generative-modeling-and-reinforcement-learning.html#cb464-13" aria-hidden="true" tabindex="-1"></a>  dat <span class="ot">=</span> reticulate<span class="sc">::</span><span class="fu">as_iterator</span>(dataset2<span class="sc">$</span><span class="fu">batch</span>(batch_size))</span>
<span id="cb464-14"><a href="generative-modeling-and-reinforcement-learning.html#cb464-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb464-15"><a href="generative-modeling-and-reinforcement-learning.html#cb464-15" aria-hidden="true" tabindex="-1"></a>   coro<span class="sc">::</span><span class="fu">loop</span>(<span class="cf">for</span> (images <span class="cf">in</span> dat) {</span>
<span id="cb464-16"><a href="generative-modeling-and-reinforcement-learning.html#cb464-16" aria-hidden="true" tabindex="-1"></a>      losses <span class="ot">=</span> <span class="fu">train_step</span>(images)</span>
<span id="cb464-17"><a href="generative-modeling-and-reinforcement-learning.html#cb464-17" aria-hidden="true" tabindex="-1"></a>      gen_loss <span class="ot">=</span> <span class="fu">c</span>(gen_loss, tf<span class="sc">$</span><span class="fu">reduce_sum</span>(losses[[<span class="dv">1</span>]])<span class="sc">$</span><span class="fu">numpy</span>())</span>
<span id="cb464-18"><a href="generative-modeling-and-reinforcement-learning.html#cb464-18" aria-hidden="true" tabindex="-1"></a>      disc_loss <span class="ot">=</span> <span class="fu">c</span>(disc_loss, tf<span class="sc">$</span><span class="fu">reduce_sum</span>(losses[[<span class="dv">2</span>]])<span class="sc">$</span><span class="fu">numpy</span>())</span>
<span id="cb464-19"><a href="generative-modeling-and-reinforcement-learning.html#cb464-19" aria-hidden="true" tabindex="-1"></a>   })</span>
<span id="cb464-20"><a href="generative-modeling-and-reinforcement-learning.html#cb464-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb464-21"><a href="generative-modeling-and-reinforcement-learning.html#cb464-21" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb464-22"><a href="generative-modeling-and-reinforcement-learning.html#cb464-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;Gen: &quot;</span>, <span class="fu">mean</span>(gen_loss), <span class="st">&quot; Disc: &quot;</span>, <span class="fu">mean</span>(disc_loss), <span class="st">&quot; </span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb464-23"><a href="generative-modeling-and-reinforcement-learning.html#cb464-23" aria-hidden="true" tabindex="-1"></a>  noise <span class="ot">=</span> tf<span class="sc">$</span>random<span class="sc">$</span><span class="fu">normal</span>(<span class="fu">c</span>(1L, 100L))</span>
<span id="cb464-24"><a href="generative-modeling-and-reinforcement-learning.html#cb464-24" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(epochs <span class="sc">%%</span> <span class="dv">5</span> <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">imgPlot</span>(<span class="fu">array</span>(<span class="fu">generator</span>(noise)<span class="sc">$</span><span class="fu">numpy</span>(), <span class="fu">c</span>(28L, 28L)), <span class="st">&quot;Gen&quot;</span>)</span>
<span id="cb464-25"><a href="generative-modeling-and-reinforcement-learning.html#cb464-25" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## Gen:  0.6981396  Disc:  1.073848</code></pre>
<p><img src="_main_files/figure-html/unnamed-chunk-218-1.png" width="672" /></p>
<pre><code>## Gen:  0.7257163  Disc:  1.187211</code></pre>
<p><img src="_main_files/figure-html/unnamed-chunk-218-2.png" width="672" /></p>
<pre><code>## Gen:  0.7402381  Disc:  1.174831</code></pre>
<p><img src="_main_files/figure-html/unnamed-chunk-218-3.png" width="672" /></p>
<pre><code>## Gen:  0.7699947  Disc:  1.149783</code></pre>
<p><img src="_main_files/figure-html/unnamed-chunk-218-4.png" width="672" /></p>
<pre><code>## Gen:  0.7869773  Disc:  1.144487</code></pre>
<p><img src="_main_files/figure-html/unnamed-chunk-218-5.png" width="672" /></p>
<pre><code>## Gen:  0.8781484  Disc:  1.046465</code></pre>
<p><img src="_main_files/figure-html/unnamed-chunk-218-6.png" width="672" /></p>
<pre><code>## Gen:  0.8777228  Disc:  1.137123</code></pre>
<p><img src="_main_files/figure-html/unnamed-chunk-218-7.png" width="672" /></p>
<pre><code>## Gen:  0.8775521  Disc:  1.203271</code></pre>
<p><img src="_main_files/figure-html/unnamed-chunk-218-8.png" width="672" /></p>
<pre><code>## Gen:  0.8799466  Disc:  1.244008</code></pre>
<p><img src="_main_files/figure-html/unnamed-chunk-218-9.png" width="672" /></p>
<pre><code>## Gen:  0.8820972  Disc:  1.270838</code></pre>
<p><img src="_main_files/figure-html/unnamed-chunk-218-10.png" width="672" /></p>
<pre><code>## Gen:  0.8859784  Disc:  1.28558</code></pre>
<p><img src="_main_files/figure-html/unnamed-chunk-218-11.png" width="672" /></p>
<pre><code>## Gen:  0.8901639  Disc:  1.295835</code></pre>
<p><img src="_main_files/figure-html/unnamed-chunk-218-12.png" width="672" /></p>
<pre><code>## Gen:  0.895102  Disc:  1.302093</code></pre>
<p><img src="_main_files/figure-html/unnamed-chunk-218-13.png" width="672" /></p>
<pre><code>## Gen:  0.8979753  Disc:  1.3091</code></pre>
<p><img src="_main_files/figure-html/unnamed-chunk-218-14.png" width="672" /></p>
<pre><code>## Gen:  0.9025143  Disc:  1.311126</code></pre>
<p><img src="_main_files/figure-html/unnamed-chunk-218-15.png" width="672" /></p>
</div>
<div id="flower---gan" class="section level3" number="6.2.2">
<h3><span class="header-section-number">6.2.2</span> Flower - GAN</h3>
<p>We can now also do the same for the flower dataset, we will write this now compleltly in our own following the steps also done for the MNIST data set.</p>
<div class="sourceCode" id="cb480"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb480-1"><a href="generative-modeling-and-reinforcement-learning.html#cb480-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(keras)</span>
<span id="cb480-2"><a href="generative-modeling-and-reinforcement-learning.html#cb480-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb480-3"><a href="generative-modeling-and-reinforcement-learning.html#cb480-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tensorflow)</span>
<span id="cb480-4"><a href="generative-modeling-and-reinforcement-learning.html#cb480-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(EcoData)</span>
<span id="cb480-5"><a href="generative-modeling-and-reinforcement-learning.html#cb480-5" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> EcoData<span class="sc">::</span><span class="fu">dataset_flower</span>()</span>
<span id="cb480-6"><a href="generative-modeling-and-reinforcement-learning.html#cb480-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb480-7"><a href="generative-modeling-and-reinforcement-learning.html#cb480-7" aria-hidden="true" tabindex="-1"></a>train <span class="ot">=</span> (data<span class="sc">$</span>train<span class="fl">-127.5</span>)<span class="sc">/</span><span class="fl">127.5</span></span>
<span id="cb480-8"><a href="generative-modeling-and-reinforcement-learning.html#cb480-8" aria-hidden="true" tabindex="-1"></a>test <span class="ot">=</span> (data<span class="sc">$</span>test<span class="fl">-127.5</span>)<span class="sc">/</span><span class="fl">127.5</span></span>
<span id="cb480-9"><a href="generative-modeling-and-reinforcement-learning.html#cb480-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb480-10"><a href="generative-modeling-and-reinforcement-learning.html#cb480-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb480-11"><a href="generative-modeling-and-reinforcement-learning.html#cb480-11" aria-hidden="true" tabindex="-1"></a>train_x <span class="ot">=</span> abind<span class="sc">::</span><span class="fu">abind</span>(<span class="fu">list</span>(train, test), <span class="at">along =</span> 1L)</span>
<span id="cb480-12"><a href="generative-modeling-and-reinforcement-learning.html#cb480-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb480-13"><a href="generative-modeling-and-reinforcement-learning.html#cb480-13" aria-hidden="true" tabindex="-1"></a>dataset <span class="ot">=</span> tf<span class="sc">$</span>data<span class="sc">$</span>Dataset<span class="sc">$</span><span class="fu">from_tensor_slices</span>(tf<span class="sc">$</span><span class="fu">constant</span>(train_x, <span class="st">&quot;float32&quot;</span>))</span></code></pre></div>
<p>Define the generator models and test it</p>
<div class="sourceCode" id="cb481"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb481-1"><a href="generative-modeling-and-reinforcement-learning.html#cb481-1" aria-hidden="true" tabindex="-1"></a>get_generator <span class="ot">=</span> <span class="cf">function</span>(){</span>
<span id="cb481-2"><a href="generative-modeling-and-reinforcement-learning.html#cb481-2" aria-hidden="true" tabindex="-1"></a>  generator <span class="ot">=</span> <span class="fu">keras_model_sequential</span>()</span>
<span id="cb481-3"><a href="generative-modeling-and-reinforcement-learning.html#cb481-3" aria-hidden="true" tabindex="-1"></a>  generator <span class="sc">%&gt;%</span> </span>
<span id="cb481-4"><a href="generative-modeling-and-reinforcement-learning.html#cb481-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_dense</span>(<span class="at">units =</span> 20L<span class="sc">*</span>20L<span class="sc">*</span>128L, <span class="at">input_shape =</span> <span class="fu">c</span>(100L), <span class="at">use_bias =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb481-5"><a href="generative-modeling-and-reinforcement-learning.html#cb481-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_activation_leaky_relu</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb481-6"><a href="generative-modeling-and-reinforcement-learning.html#cb481-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_reshape</span>(<span class="fu">c</span>(20L, 20L, 128L)) <span class="sc">%&gt;%</span> </span>
<span id="cb481-7"><a href="generative-modeling-and-reinforcement-learning.html#cb481-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_dropout</span>(<span class="fl">0.3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb481-8"><a href="generative-modeling-and-reinforcement-learning.html#cb481-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_conv_2d_transpose</span>(<span class="at">filters =</span> 256L, <span class="at">kernel_size =</span> <span class="fu">c</span>(3L, 3L), <span class="at">padding =</span> <span class="st">&quot;same&quot;</span>, <span class="at">strides =</span> <span class="fu">c</span>(1L, 1L), <span class="at">use_bias =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb481-9"><a href="generative-modeling-and-reinforcement-learning.html#cb481-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_activation_leaky_relu</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb481-10"><a href="generative-modeling-and-reinforcement-learning.html#cb481-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_dropout</span>(<span class="fl">0.3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb481-11"><a href="generative-modeling-and-reinforcement-learning.html#cb481-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_conv_2d_transpose</span>(<span class="at">filters =</span> 128L, <span class="at">kernel_size =</span> <span class="fu">c</span>(5L, 5L), <span class="at">padding =</span> <span class="st">&quot;same&quot;</span>, <span class="at">strides =</span> <span class="fu">c</span>(1L, 1L), <span class="at">use_bias =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb481-12"><a href="generative-modeling-and-reinforcement-learning.html#cb481-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_activation_leaky_relu</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb481-13"><a href="generative-modeling-and-reinforcement-learning.html#cb481-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_dropout</span>(<span class="fl">0.3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb481-14"><a href="generative-modeling-and-reinforcement-learning.html#cb481-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_conv_2d_transpose</span>(<span class="at">filters =</span> 64L, <span class="at">kernel_size =</span> <span class="fu">c</span>(5L, 5L), <span class="at">padding =</span> <span class="st">&quot;same&quot;</span>, <span class="at">strides =</span> <span class="fu">c</span>(2L, 2L), <span class="at">use_bias =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb481-15"><a href="generative-modeling-and-reinforcement-learning.html#cb481-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_activation_leaky_relu</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb481-16"><a href="generative-modeling-and-reinforcement-learning.html#cb481-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_dropout</span>(<span class="fl">0.3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb481-17"><a href="generative-modeling-and-reinforcement-learning.html#cb481-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_conv_2d_transpose</span>(<span class="at">filters =</span>3L, <span class="at">kernel_size =</span> <span class="fu">c</span>(5L, 5L), <span class="at">padding =</span> <span class="st">&quot;same&quot;</span>, <span class="at">strides =</span> <span class="fu">c</span>(2L, 2L), <span class="at">activation =</span> <span class="st">&quot;tanh&quot;</span>, <span class="at">use_bias =</span> <span class="cn">FALSE</span>)</span>
<span id="cb481-18"><a href="generative-modeling-and-reinforcement-learning.html#cb481-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(generator)</span>
<span id="cb481-19"><a href="generative-modeling-and-reinforcement-learning.html#cb481-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb481-20"><a href="generative-modeling-and-reinforcement-learning.html#cb481-20" aria-hidden="true" tabindex="-1"></a>generator <span class="ot">=</span> <span class="fu">get_generator</span>()</span>
<span id="cb481-21"><a href="generative-modeling-and-reinforcement-learning.html#cb481-21" aria-hidden="true" tabindex="-1"></a>image <span class="ot">=</span> <span class="fu">generator</span>(tf<span class="sc">$</span>random<span class="sc">$</span><span class="fu">normal</span>(<span class="fu">c</span>(1L,100L)))<span class="sc">$</span><span class="fu">numpy</span>()[<span class="dv">1</span>,,,]</span>
<span id="cb481-22"><a href="generative-modeling-and-reinforcement-learning.html#cb481-22" aria-hidden="true" tabindex="-1"></a>image <span class="ot">=</span> scales<span class="sc">::</span><span class="fu">rescale</span>(image, <span class="at">to =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">255</span>))</span>
<span id="cb481-23"><a href="generative-modeling-and-reinforcement-learning.html#cb481-23" aria-hidden="true" tabindex="-1"></a>image <span class="sc">%&gt;%</span> </span>
<span id="cb481-24"><a href="generative-modeling-and-reinforcement-learning.html#cb481-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">image_to_array</span>() <span class="sc">%&gt;%</span></span>
<span id="cb481-25"><a href="generative-modeling-and-reinforcement-learning.html#cb481-25" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">/</span><span class="st">`</span>(., <span class="dv">255</span>) <span class="sc">%&gt;%</span></span>
<span id="cb481-26"><a href="generative-modeling-and-reinforcement-learning.html#cb481-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.raster</span>() <span class="sc">%&gt;%</span></span>
<span id="cb481-27"><a href="generative-modeling-and-reinforcement-learning.html#cb481-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-220-1.png" width="672" />
Define the discriminator and test it</p>
<div class="sourceCode" id="cb482"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb482-1"><a href="generative-modeling-and-reinforcement-learning.html#cb482-1" aria-hidden="true" tabindex="-1"></a>get_discriminator <span class="ot">=</span> <span class="cf">function</span>(){</span>
<span id="cb482-2"><a href="generative-modeling-and-reinforcement-learning.html#cb482-2" aria-hidden="true" tabindex="-1"></a>  discriminator <span class="ot">=</span> <span class="fu">keras_model_sequential</span>()</span>
<span id="cb482-3"><a href="generative-modeling-and-reinforcement-learning.html#cb482-3" aria-hidden="true" tabindex="-1"></a>  discriminator <span class="sc">%&gt;%</span> </span>
<span id="cb482-4"><a href="generative-modeling-and-reinforcement-learning.html#cb482-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_conv_2d</span>(<span class="at">filters =</span> 64L, <span class="at">kernel_size =</span> <span class="fu">c</span>(5L, 5L), <span class="at">strides =</span> <span class="fu">c</span>(2L, 2L), <span class="at">padding =</span> <span class="st">&quot;same&quot;</span>, <span class="at">input_shape =</span> <span class="fu">c</span>(80L, 80L, 3L)) <span class="sc">%&gt;%</span></span>
<span id="cb482-5"><a href="generative-modeling-and-reinforcement-learning.html#cb482-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_activation_leaky_relu</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb482-6"><a href="generative-modeling-and-reinforcement-learning.html#cb482-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_dropout</span>(<span class="fl">0.3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb482-7"><a href="generative-modeling-and-reinforcement-learning.html#cb482-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_conv_2d</span>(<span class="at">filters =</span> 128L, <span class="at">kernel_size =</span> <span class="fu">c</span>(5L, 5L), <span class="at">strides =</span> <span class="fu">c</span>(2L, 2L), <span class="at">padding =</span> <span class="st">&quot;same&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb482-8"><a href="generative-modeling-and-reinforcement-learning.html#cb482-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_activation_leaky_relu</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb482-9"><a href="generative-modeling-and-reinforcement-learning.html#cb482-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_dropout</span>(<span class="fl">0.3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb482-10"><a href="generative-modeling-and-reinforcement-learning.html#cb482-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_conv_2d</span>(<span class="at">filters =</span> 256L, <span class="at">kernel_size =</span> <span class="fu">c</span>(3L, 3L), <span class="at">strides =</span> <span class="fu">c</span>(2L, 2L), <span class="at">padding =</span> <span class="st">&quot;same&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb482-11"><a href="generative-modeling-and-reinforcement-learning.html#cb482-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_activation_leaky_relu</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb482-12"><a href="generative-modeling-and-reinforcement-learning.html#cb482-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_dropout</span>(<span class="fl">0.3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb482-13"><a href="generative-modeling-and-reinforcement-learning.html#cb482-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_flatten</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb482-14"><a href="generative-modeling-and-reinforcement-learning.html#cb482-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_dense</span>(<span class="at">units =</span> 1L, <span class="at">activation =</span> <span class="st">&quot;sigmoid&quot;</span>)</span>
<span id="cb482-15"><a href="generative-modeling-and-reinforcement-learning.html#cb482-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(discriminator)</span>
<span id="cb482-16"><a href="generative-modeling-and-reinforcement-learning.html#cb482-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb482-17"><a href="generative-modeling-and-reinforcement-learning.html#cb482-17" aria-hidden="true" tabindex="-1"></a>discriminator <span class="ot">=</span> <span class="fu">get_discriminator</span>()</span>
<span id="cb482-18"><a href="generative-modeling-and-reinforcement-learning.html#cb482-18" aria-hidden="true" tabindex="-1"></a>discriminator</span></code></pre></div>
<pre><code>## Model
## Model: &quot;sequential_23&quot;
## __________________________________________________________________________________________________________________________________________________________
## Layer (type)                                                         Output Shape                                                 Param #                 
## ==========================================================================================================================================================
## conv2d_13 (Conv2D)                                                   (None, 40, 40, 64)                                           4864                    
## __________________________________________________________________________________________________________________________________________________________
## leaky_re_lu_12 (LeakyReLU)                                           (None, 40, 40, 64)                                           0                       
## __________________________________________________________________________________________________________________________________________________________
## dropout_8 (Dropout)                                                  (None, 40, 40, 64)                                           0                       
## __________________________________________________________________________________________________________________________________________________________
## conv2d_14 (Conv2D)                                                   (None, 20, 20, 128)                                          204928                  
## __________________________________________________________________________________________________________________________________________________________
## leaky_re_lu_13 (LeakyReLU)                                           (None, 20, 20, 128)                                          0                       
## __________________________________________________________________________________________________________________________________________________________
## dropout_9 (Dropout)                                                  (None, 20, 20, 128)                                          0                       
## __________________________________________________________________________________________________________________________________________________________
## conv2d_15 (Conv2D)                                                   (None, 10, 10, 256)                                          295168                  
## __________________________________________________________________________________________________________________________________________________________
## leaky_re_lu_14 (LeakyReLU)                                           (None, 10, 10, 256)                                          0                       
## __________________________________________________________________________________________________________________________________________________________
## dropout_10 (Dropout)                                                 (None, 10, 10, 256)                                          0                       
## __________________________________________________________________________________________________________________________________________________________
## flatten_4 (Flatten)                                                  (None, 25600)                                                0                       
## __________________________________________________________________________________________________________________________________________________________
## dense_57 (Dense)                                                     (None, 1)                                                    25601                   
## ==========================================================================================================================================================
## Total params: 530,561
## Trainable params: 530,561
## Non-trainable params: 0
## __________________________________________________________________________________________________________________________________________________________</code></pre>
<div class="sourceCode" id="cb484"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb484-1"><a href="generative-modeling-and-reinforcement-learning.html#cb484-1" aria-hidden="true" tabindex="-1"></a><span class="fu">discriminator</span>(<span class="fu">generator</span>(tf<span class="sc">$</span>random<span class="sc">$</span><span class="fu">normal</span>(<span class="fu">c</span>(1L, 100L))))</span></code></pre></div>
<pre><code>## tf.Tensor([[0.49998677]], shape=(1, 1), dtype=float32)</code></pre>
<div class="sourceCode" id="cb486"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb486-1"><a href="generative-modeling-and-reinforcement-learning.html#cb486-1" aria-hidden="true" tabindex="-1"></a>ce <span class="ot">=</span> tf<span class="sc">$</span>keras<span class="sc">$</span>losses<span class="sc">$</span><span class="fu">BinaryCrossentropy</span>(<span class="at">from_logits =</span> <span class="cn">TRUE</span>,<span class="at">label_smoothing =</span> <span class="fl">0.1</span>)</span></code></pre></div>
<p>Defin the loss functions</p>
<div class="sourceCode" id="cb487"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb487-1"><a href="generative-modeling-and-reinforcement-learning.html#cb487-1" aria-hidden="true" tabindex="-1"></a>loss_discriminator <span class="ot">=</span> <span class="cf">function</span>(real, fake){</span>
<span id="cb487-2"><a href="generative-modeling-and-reinforcement-learning.html#cb487-2" aria-hidden="true" tabindex="-1"></a>  real_loss <span class="ot">=</span> <span class="fu">ce</span>(tf<span class="sc">$</span><span class="fu">ones_like</span>(real), real)</span>
<span id="cb487-3"><a href="generative-modeling-and-reinforcement-learning.html#cb487-3" aria-hidden="true" tabindex="-1"></a>  fake_loss <span class="ot">=</span> <span class="fu">ce</span>(tf<span class="sc">$</span><span class="fu">zeros_like</span>(fake), fake)</span>
<span id="cb487-4"><a href="generative-modeling-and-reinforcement-learning.html#cb487-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(real_loss<span class="sc">+</span>fake_loss)</span>
<span id="cb487-5"><a href="generative-modeling-and-reinforcement-learning.html#cb487-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb487-6"><a href="generative-modeling-and-reinforcement-learning.html#cb487-6" aria-hidden="true" tabindex="-1"></a>loss_generator <span class="ot">=</span> <span class="cf">function</span>(fake){</span>
<span id="cb487-7"><a href="generative-modeling-and-reinforcement-learning.html#cb487-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">ce</span>(tf<span class="sc">$</span><span class="fu">ones_like</span>(fake), fake))</span>
<span id="cb487-8"><a href="generative-modeling-and-reinforcement-learning.html#cb487-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Define the optimizers and the batch function</p>
<div class="sourceCode" id="cb488"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb488-1"><a href="generative-modeling-and-reinforcement-learning.html#cb488-1" aria-hidden="true" tabindex="-1"></a>gen_opt <span class="ot">=</span> tf<span class="sc">$</span>keras<span class="sc">$</span>optimizers<span class="sc">$</span><span class="fu">RMSprop</span>(<span class="fl">1e-4</span>)</span>
<span id="cb488-2"><a href="generative-modeling-and-reinforcement-learning.html#cb488-2" aria-hidden="true" tabindex="-1"></a>disc_opt <span class="ot">=</span> tf<span class="sc">$</span>keras<span class="sc">$</span>optimizers<span class="sc">$</span><span class="fu">RMSprop</span>(<span class="fl">1e-4</span>)</span>
<span id="cb488-3"><a href="generative-modeling-and-reinforcement-learning.html#cb488-3" aria-hidden="true" tabindex="-1"></a>batch_size <span class="ot">=</span> 32L</span>
<span id="cb488-4"><a href="generative-modeling-and-reinforcement-learning.html#cb488-4" aria-hidden="true" tabindex="-1"></a>get_batch <span class="ot">=</span> <span class="cf">function</span>(){</span>
<span id="cb488-5"><a href="generative-modeling-and-reinforcement-learning.html#cb488-5" aria-hidden="true" tabindex="-1"></a>  indices <span class="ot">=</span> <span class="fu">sample.int</span>(<span class="fu">nrow</span>(train_x), batch_size)</span>
<span id="cb488-6"><a href="generative-modeling-and-reinforcement-learning.html#cb488-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(tf<span class="sc">$</span><span class="fu">constant</span>(train_x[indices,,,,<span class="at">drop=</span><span class="cn">FALSE</span>], <span class="st">&quot;float32&quot;</span>))</span>
<span id="cb488-7"><a href="generative-modeling-and-reinforcement-learning.html#cb488-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Finally do the training</p>
<div class="sourceCode" id="cb489"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb489-1"><a href="generative-modeling-and-reinforcement-learning.html#cb489-1" aria-hidden="true" tabindex="-1"></a>generator <span class="ot">=</span> <span class="fu">get_generator</span>()</span>
<span id="cb489-2"><a href="generative-modeling-and-reinforcement-learning.html#cb489-2" aria-hidden="true" tabindex="-1"></a>discriminator <span class="ot">=</span> <span class="fu">get_discriminator</span>()</span>
<span id="cb489-3"><a href="generative-modeling-and-reinforcement-learning.html#cb489-3" aria-hidden="true" tabindex="-1"></a>train_step <span class="ot">=</span> <span class="cf">function</span>(images){</span>
<span id="cb489-4"><a href="generative-modeling-and-reinforcement-learning.html#cb489-4" aria-hidden="true" tabindex="-1"></a>  noise <span class="ot">=</span> tf<span class="sc">$</span>random<span class="sc">$</span><span class="fu">normal</span>(<span class="fu">c</span>(32L, 100L))</span>
<span id="cb489-5"><a href="generative-modeling-and-reinforcement-learning.html#cb489-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb489-6"><a href="generative-modeling-and-reinforcement-learning.html#cb489-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">with</span>(tf<span class="sc">$</span><span class="fu">GradientTape</span>(<span class="at">persistent =</span> <span class="cn">TRUE</span>) <span class="sc">%as%</span> tape,{</span>
<span id="cb489-7"><a href="generative-modeling-and-reinforcement-learning.html#cb489-7" aria-hidden="true" tabindex="-1"></a>    gen_images <span class="ot">=</span> <span class="fu">generator</span>(noise)</span>
<span id="cb489-8"><a href="generative-modeling-and-reinforcement-learning.html#cb489-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb489-9"><a href="generative-modeling-and-reinforcement-learning.html#cb489-9" aria-hidden="true" tabindex="-1"></a>    real_output <span class="ot">=</span> <span class="fu">discriminator</span>(images)</span>
<span id="cb489-10"><a href="generative-modeling-and-reinforcement-learning.html#cb489-10" aria-hidden="true" tabindex="-1"></a>    fake_output <span class="ot">=</span> <span class="fu">discriminator</span>(gen_images)</span>
<span id="cb489-11"><a href="generative-modeling-and-reinforcement-learning.html#cb489-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb489-12"><a href="generative-modeling-and-reinforcement-learning.html#cb489-12" aria-hidden="true" tabindex="-1"></a>    gen_loss <span class="ot">=</span> <span class="fu">loss_generator</span>(fake_output)</span>
<span id="cb489-13"><a href="generative-modeling-and-reinforcement-learning.html#cb489-13" aria-hidden="true" tabindex="-1"></a>    disc_loss <span class="ot">=</span> <span class="fu">loss_discriminator</span>(real_output, fake_output)</span>
<span id="cb489-14"><a href="generative-modeling-and-reinforcement-learning.html#cb489-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb489-15"><a href="generative-modeling-and-reinforcement-learning.html#cb489-15" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb489-16"><a href="generative-modeling-and-reinforcement-learning.html#cb489-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb489-17"><a href="generative-modeling-and-reinforcement-learning.html#cb489-17" aria-hidden="true" tabindex="-1"></a>  gen_grads <span class="ot">=</span> tape<span class="sc">$</span><span class="fu">gradient</span>(gen_loss, generator<span class="sc">$</span>weights)</span>
<span id="cb489-18"><a href="generative-modeling-and-reinforcement-learning.html#cb489-18" aria-hidden="true" tabindex="-1"></a>  disc_grads <span class="ot">=</span> tape<span class="sc">$</span><span class="fu">gradient</span>(disc_loss, discriminator<span class="sc">$</span>weights)</span>
<span id="cb489-19"><a href="generative-modeling-and-reinforcement-learning.html#cb489-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(tape)</span>
<span id="cb489-20"><a href="generative-modeling-and-reinforcement-learning.html#cb489-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb489-21"><a href="generative-modeling-and-reinforcement-learning.html#cb489-21" aria-hidden="true" tabindex="-1"></a>  gen_opt<span class="sc">$</span><span class="fu">apply_gradients</span>(purrr<span class="sc">::</span><span class="fu">transpose</span>(<span class="fu">list</span>(gen_grads, generator<span class="sc">$</span>weights)))</span>
<span id="cb489-22"><a href="generative-modeling-and-reinforcement-learning.html#cb489-22" aria-hidden="true" tabindex="-1"></a>  disc_opt<span class="sc">$</span><span class="fu">apply_gradients</span>(purrr<span class="sc">::</span><span class="fu">transpose</span>(<span class="fu">list</span>(disc_grads, discriminator<span class="sc">$</span>weights)))</span>
<span id="cb489-23"><a href="generative-modeling-and-reinforcement-learning.html#cb489-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb489-24"><a href="generative-modeling-and-reinforcement-learning.html#cb489-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">c</span>(gen_loss, disc_loss))</span>
<span id="cb489-25"><a href="generative-modeling-and-reinforcement-learning.html#cb489-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb489-26"><a href="generative-modeling-and-reinforcement-learning.html#cb489-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb489-27"><a href="generative-modeling-and-reinforcement-learning.html#cb489-27" aria-hidden="true" tabindex="-1"></a>train_step <span class="ot">=</span> tf<span class="sc">$</span><span class="st">`</span><span class="at">function</span><span class="st">`</span>(reticulate<span class="sc">::</span><span class="fu">py_func</span>(train_step))</span></code></pre></div>
<div class="sourceCode" id="cb490"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb490-1"><a href="generative-modeling-and-reinforcement-learning.html#cb490-1" aria-hidden="true" tabindex="-1"></a>batch_size <span class="ot">=</span> 32L</span>
<span id="cb490-2"><a href="generative-modeling-and-reinforcement-learning.html#cb490-2" aria-hidden="true" tabindex="-1"></a>epochs <span class="ot">=</span> 30L</span>
<span id="cb490-3"><a href="generative-modeling-and-reinforcement-learning.html#cb490-3" aria-hidden="true" tabindex="-1"></a>steps <span class="ot">=</span> <span class="fu">as.integer</span>(<span class="fu">dim</span>(train_x)[<span class="dv">1</span>]<span class="sc">/</span>batch_size)</span>
<span id="cb490-4"><a href="generative-modeling-and-reinforcement-learning.html#cb490-4" aria-hidden="true" tabindex="-1"></a>counter <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb490-5"><a href="generative-modeling-and-reinforcement-learning.html#cb490-5" aria-hidden="true" tabindex="-1"></a>gen_loss <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb490-6"><a href="generative-modeling-and-reinforcement-learning.html#cb490-6" aria-hidden="true" tabindex="-1"></a>disc_loss <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb490-7"><a href="generative-modeling-and-reinforcement-learning.html#cb490-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb490-8"><a href="generative-modeling-and-reinforcement-learning.html#cb490-8" aria-hidden="true" tabindex="-1"></a>dataset2 <span class="ot">=</span> dataset</span>
<span id="cb490-9"><a href="generative-modeling-and-reinforcement-learning.html#cb490-9" aria-hidden="true" tabindex="-1"></a>dataset2 <span class="ot">=</span> dataset2<span class="sc">$</span><span class="fu">prefetch</span>(tf<span class="sc">$</span>data<span class="sc">$</span>AUTOTUNE)</span>
<span id="cb490-10"><a href="generative-modeling-and-reinforcement-learning.html#cb490-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb490-11"><a href="generative-modeling-and-reinforcement-learning.html#cb490-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb490-12"><a href="generative-modeling-and-reinforcement-learning.html#cb490-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(e <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>epochs) {</span>
<span id="cb490-13"><a href="generative-modeling-and-reinforcement-learning.html#cb490-13" aria-hidden="true" tabindex="-1"></a>  dat <span class="ot">=</span> reticulate<span class="sc">::</span><span class="fu">as_iterator</span>(dataset2<span class="sc">$</span><span class="fu">batch</span>(batch_size))</span>
<span id="cb490-14"><a href="generative-modeling-and-reinforcement-learning.html#cb490-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb490-15"><a href="generative-modeling-and-reinforcement-learning.html#cb490-15" aria-hidden="true" tabindex="-1"></a>   coro<span class="sc">::</span><span class="fu">loop</span>(<span class="cf">for</span> (images <span class="cf">in</span> dat) {</span>
<span id="cb490-16"><a href="generative-modeling-and-reinforcement-learning.html#cb490-16" aria-hidden="true" tabindex="-1"></a>      losses <span class="ot">=</span> <span class="fu">train_step</span>(images)</span>
<span id="cb490-17"><a href="generative-modeling-and-reinforcement-learning.html#cb490-17" aria-hidden="true" tabindex="-1"></a>      gen_loss <span class="ot">=</span> <span class="fu">c</span>(gen_loss, tf<span class="sc">$</span><span class="fu">reduce_sum</span>(losses[[<span class="dv">1</span>]])<span class="sc">$</span><span class="fu">numpy</span>())</span>
<span id="cb490-18"><a href="generative-modeling-and-reinforcement-learning.html#cb490-18" aria-hidden="true" tabindex="-1"></a>      disc_loss <span class="ot">=</span> <span class="fu">c</span>(disc_loss, tf<span class="sc">$</span><span class="fu">reduce_sum</span>(losses[[<span class="dv">2</span>]])<span class="sc">$</span><span class="fu">numpy</span>())</span>
<span id="cb490-19"><a href="generative-modeling-and-reinforcement-learning.html#cb490-19" aria-hidden="true" tabindex="-1"></a>   })</span>
<span id="cb490-20"><a href="generative-modeling-and-reinforcement-learning.html#cb490-20" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb490-21"><a href="generative-modeling-and-reinforcement-learning.html#cb490-21" aria-hidden="true" tabindex="-1"></a>  noise <span class="ot">=</span> tf<span class="sc">$</span>random<span class="sc">$</span><span class="fu">normal</span>(<span class="fu">c</span>(1L, 100L))</span>
<span id="cb490-22"><a href="generative-modeling-and-reinforcement-learning.html#cb490-22" aria-hidden="true" tabindex="-1"></a>  image <span class="ot">=</span> <span class="fu">generator</span>(noise)<span class="sc">$</span><span class="fu">numpy</span>()[<span class="dv">1</span>,,,]</span>
<span id="cb490-23"><a href="generative-modeling-and-reinforcement-learning.html#cb490-23" aria-hidden="true" tabindex="-1"></a>  image <span class="ot">=</span> scales<span class="sc">::</span><span class="fu">rescale</span>(image, <span class="at">to =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">255</span>))</span>
<span id="cb490-24"><a href="generative-modeling-and-reinforcement-learning.html#cb490-24" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(e <span class="sc">%%</span> <span class="dv">5</span> <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb490-25"><a href="generative-modeling-and-reinforcement-learning.html#cb490-25" aria-hidden="true" tabindex="-1"></a>    image <span class="sc">%&gt;%</span> </span>
<span id="cb490-26"><a href="generative-modeling-and-reinforcement-learning.html#cb490-26" aria-hidden="true" tabindex="-1"></a>      <span class="fu">image_to_array</span>() <span class="sc">%&gt;%</span></span>
<span id="cb490-27"><a href="generative-modeling-and-reinforcement-learning.html#cb490-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">`</span><span class="at">/</span><span class="st">`</span>(., <span class="dv">255</span>) <span class="sc">%&gt;%</span></span>
<span id="cb490-28"><a href="generative-modeling-and-reinforcement-learning.html#cb490-28" aria-hidden="true" tabindex="-1"></a>        <span class="fu">as.raster</span>() <span class="sc">%&gt;%</span></span>
<span id="cb490-29"><a href="generative-modeling-and-reinforcement-learning.html#cb490-29" aria-hidden="true" tabindex="-1"></a>        <span class="fu">plot</span>()</span>
<span id="cb490-30"><a href="generative-modeling-and-reinforcement-learning.html#cb490-30" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb490-31"><a href="generative-modeling-and-reinforcement-learning.html#cb490-31" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb490-32"><a href="generative-modeling-and-reinforcement-learning.html#cb490-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;Gen: &quot;</span>, <span class="fu">mean</span>(gen_loss), <span class="st">&quot; Disc: &quot;</span>, <span class="fu">mean</span>(disc_loss), <span class="st">&quot; </span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb490-33"><a href="generative-modeling-and-reinforcement-learning.html#cb490-33" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## Gen:  1.285174  Disc:  0.7568829  
## Gen:  1.586877  Disc:  0.7609698  
## Gen:  1.682233  Disc:  0.7684908  
## Gen:  1.688981  Disc:  0.7947441</code></pre>
<p><img src="_main_files/figure-html/unnamed-chunk-225-1.png" width="672" /></p>
<pre><code>## Gen:  1.623185  Disc:  0.8463655  
## Gen:  1.541145  Disc:  0.8955236  
## Gen:  1.488347  Disc:  0.918444  
## Gen:  1.441985  Disc:  0.9330423  
## Gen:  1.404866  Disc:  0.94838</code></pre>
<p><img src="_main_files/figure-html/unnamed-chunk-225-2.png" width="672" /></p>
<pre><code>## Gen:  1.382156  Disc:  0.9578988  
## Gen:  1.360223  Disc:  0.9693824  
## Gen:  1.337443  Disc:  0.9792228  
## Gen:  1.313062  Disc:  0.992228  
## Gen:  1.291037  Disc:  1.003252</code></pre>
<p><img src="_main_files/figure-html/unnamed-chunk-225-3.png" width="672" /></p>
<pre><code>## Gen:  1.266184  Disc:  1.019214  
## Gen:  1.244402  Disc:  1.031348  
## Gen:  1.227457  Disc:  1.039981  
## Gen:  1.210571  Disc:  1.048991  
## Gen:  1.195826  Disc:  1.056692</code></pre>
<p><img src="_main_files/figure-html/unnamed-chunk-225-4.png" width="672" /></p>
<pre><code>## Gen:  1.182242  Disc:  1.063213  
## Gen:  1.170855  Disc:  1.069197  
## Gen:  1.159815  Disc:  1.075199  
## Gen:  1.149698  Disc:  1.080034  
## Gen:  1.140972  Disc:  1.08438</code></pre>
<p><img src="_main_files/figure-html/unnamed-chunk-225-5.png" width="672" /></p>
<pre><code>## Gen:  1.13432  Disc:  1.086645  
## Gen:  1.130559  Disc:  1.087323  
## Gen:  1.12841  Disc:  1.087506  
## Gen:  1.127137  Disc:  1.087978  
## Gen:  1.126315  Disc:  1.088647</code></pre>
<p><img src="_main_files/figure-html/unnamed-chunk-225-6.png" width="672" /></p>
<pre><code>## Gen:  1.124414  Disc:  1.089115</code></pre>
<div class="sourceCode" id="cb498"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb498-1"><a href="generative-modeling-and-reinforcement-learning.html#cb498-1" aria-hidden="true" tabindex="-1"></a>  noise <span class="ot">=</span> tf<span class="sc">$</span>random<span class="sc">$</span><span class="fu">normal</span>(<span class="fu">c</span>(1L, 100L))</span>
<span id="cb498-2"><a href="generative-modeling-and-reinforcement-learning.html#cb498-2" aria-hidden="true" tabindex="-1"></a>  image <span class="ot">=</span> <span class="fu">generator</span>(noise)<span class="sc">$</span><span class="fu">numpy</span>()[<span class="dv">1</span>,,,]</span>
<span id="cb498-3"><a href="generative-modeling-and-reinforcement-learning.html#cb498-3" aria-hidden="true" tabindex="-1"></a>  image <span class="ot">=</span> scales<span class="sc">::</span><span class="fu">rescale</span>(image, <span class="at">to =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">255</span>))</span>
<span id="cb498-4"><a href="generative-modeling-and-reinforcement-learning.html#cb498-4" aria-hidden="true" tabindex="-1"></a>  image <span class="sc">%&gt;%</span> </span>
<span id="cb498-5"><a href="generative-modeling-and-reinforcement-learning.html#cb498-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">image_to_array</span>() <span class="sc">%&gt;%</span></span>
<span id="cb498-6"><a href="generative-modeling-and-reinforcement-learning.html#cb498-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">/</span><span class="st">`</span>(., <span class="dv">255</span>) <span class="sc">%&gt;%</span></span>
<span id="cb498-7"><a href="generative-modeling-and-reinforcement-learning.html#cb498-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.raster</span>() <span class="sc">%&gt;%</span></span>
<span id="cb498-8"><a href="generative-modeling-and-reinforcement-learning.html#cb498-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-226-1.png" width="672" /></p>
<p>More images:
<img src="images/flower2.png" width="150%" height="150%" /><img src="images/flower3.png" width="150%" height="150%" /><img src="images/flower4.png" width="150%" height="150%" /><img src="images/flower5.png" width="150%" height="150%" /></p>
</div>
</div>
<div id="reinforcement-learning" class="section level2" number="6.3">
<h2><span class="header-section-number">6.3</span> Reinforcement learning</h2>
<p>Objective: train a neural network capable of balancing a pole</p>
<div class="sourceCode" id="cb499"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb499-1"><a href="generative-modeling-and-reinforcement-learning.html#cb499-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(keras)</span>
<span id="cb499-2"><a href="generative-modeling-and-reinforcement-learning.html#cb499-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tensorflow)</span>
<span id="cb499-3"><a href="generative-modeling-and-reinforcement-learning.html#cb499-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gym)</span>
<span id="cb499-4"><a href="generative-modeling-and-reinforcement-learning.html#cb499-4" aria-hidden="true" tabindex="-1"></a>remote_base <span class="ot">&lt;-</span> <span class="st">&quot;http://127.0.0.1:5000&quot;</span></span>
<span id="cb499-5"><a href="generative-modeling-and-reinforcement-learning.html#cb499-5" aria-hidden="true" tabindex="-1"></a>client <span class="ot">&lt;-</span> <span class="fu">create_GymClient</span>(remote_base)</span>
<span id="cb499-6"><a href="generative-modeling-and-reinforcement-learning.html#cb499-6" aria-hidden="true" tabindex="-1"></a>env <span class="ot">=</span> gym<span class="sc">::</span><span class="fu">env_create</span>(client, <span class="st">&quot;CartPole-v1&quot;</span>)</span>
<span id="cb499-7"><a href="generative-modeling-and-reinforcement-learning.html#cb499-7" aria-hidden="true" tabindex="-1"></a>gym<span class="sc">::</span><span class="fu">env_list_all</span>(client)</span>
<span id="cb499-8"><a href="generative-modeling-and-reinforcement-learning.html#cb499-8" aria-hidden="true" tabindex="-1"></a><span class="fu">env_reset</span>(client, env)</span>
<span id="cb499-9"><a href="generative-modeling-and-reinforcement-learning.html#cb499-9" aria-hidden="true" tabindex="-1"></a><span class="co">#action = env_action_space_sample(client, env)</span></span>
<span id="cb499-10"><a href="generative-modeling-and-reinforcement-learning.html#cb499-10" aria-hidden="true" tabindex="-1"></a>step <span class="ot">=</span> <span class="fu">env_step</span>(client, env, <span class="dv">1</span>)</span>
<span id="cb499-11"><a href="generative-modeling-and-reinforcement-learning.html#cb499-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb499-12"><a href="generative-modeling-and-reinforcement-learning.html#cb499-12" aria-hidden="true" tabindex="-1"></a><span class="fu">env_reset</span>(client, env)</span>
<span id="cb499-13"><a href="generative-modeling-and-reinforcement-learning.html#cb499-13" aria-hidden="true" tabindex="-1"></a>goal_steps <span class="ot">=</span> <span class="dv">500</span></span>
<span id="cb499-14"><a href="generative-modeling-and-reinforcement-learning.html#cb499-14" aria-hidden="true" tabindex="-1"></a>score_requirement <span class="ot">=</span> <span class="dv">60</span></span>
<span id="cb499-15"><a href="generative-modeling-and-reinforcement-learning.html#cb499-15" aria-hidden="true" tabindex="-1"></a>intial_games <span class="ot">=</span> <span class="dv">1000</span></span>
<span id="cb499-16"><a href="generative-modeling-and-reinforcement-learning.html#cb499-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb499-17"><a href="generative-modeling-and-reinforcement-learning.html#cb499-17" aria-hidden="true" tabindex="-1"></a>state_size <span class="ot">=</span> 4L</span>
<span id="cb499-18"><a href="generative-modeling-and-reinforcement-learning.html#cb499-18" aria-hidden="true" tabindex="-1"></a>action_size <span class="ot">=</span> 2L</span>
<span id="cb499-19"><a href="generative-modeling-and-reinforcement-learning.html#cb499-19" aria-hidden="true" tabindex="-1"></a>gamma <span class="ot">=</span> <span class="fl">0.95</span></span>
<span id="cb499-20"><a href="generative-modeling-and-reinforcement-learning.html#cb499-20" aria-hidden="true" tabindex="-1"></a>epsilon <span class="ot">=</span> <span class="fl">0.95</span></span>
<span id="cb499-21"><a href="generative-modeling-and-reinforcement-learning.html#cb499-21" aria-hidden="true" tabindex="-1"></a>epsilon_min <span class="ot">=</span> <span class="fl">0.01</span></span>
<span id="cb499-22"><a href="generative-modeling-and-reinforcement-learning.html#cb499-22" aria-hidden="true" tabindex="-1"></a>epsilon_decay <span class="ot">=</span> <span class="fl">0.995</span></span>
<span id="cb499-23"><a href="generative-modeling-and-reinforcement-learning.html#cb499-23" aria-hidden="true" tabindex="-1"></a>model <span class="ot">=</span> <span class="fu">keras_model_sequential</span>()</span>
<span id="cb499-24"><a href="generative-modeling-and-reinforcement-learning.html#cb499-24" aria-hidden="true" tabindex="-1"></a>model <span class="sc">%&gt;%</span> </span>
<span id="cb499-25"><a href="generative-modeling-and-reinforcement-learning.html#cb499-25" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_dense</span>(<span class="at">input_shape =</span> <span class="fu">c</span>(4L), <span class="at">units =</span> 20L, <span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb499-26"><a href="generative-modeling-and-reinforcement-learning.html#cb499-26" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_dense</span>(<span class="at">units =</span> 20L, <span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb499-27"><a href="generative-modeling-and-reinforcement-learning.html#cb499-27" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_dense</span>(2L, <span class="at">activation =</span> <span class="st">&quot;linear&quot;</span>)</span>
<span id="cb499-28"><a href="generative-modeling-and-reinforcement-learning.html#cb499-28" aria-hidden="true" tabindex="-1"></a>model <span class="sc">%&gt;%</span> </span>
<span id="cb499-29"><a href="generative-modeling-and-reinforcement-learning.html#cb499-29" aria-hidden="true" tabindex="-1"></a> <span class="fu">compile</span>(<span class="at">loss =</span> loss_mean_squared_error, <span class="at">optimizer =</span> <span class="fu">optimizer_adamax</span>())</span>
<span id="cb499-30"><a href="generative-modeling-and-reinforcement-learning.html#cb499-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb499-31"><a href="generative-modeling-and-reinforcement-learning.html#cb499-31" aria-hidden="true" tabindex="-1"></a>memory <span class="ot">=</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> 8000L, 11L)</span>
<span id="cb499-32"><a href="generative-modeling-and-reinforcement-learning.html#cb499-32" aria-hidden="true" tabindex="-1"></a>counter <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb499-33"><a href="generative-modeling-and-reinforcement-learning.html#cb499-33" aria-hidden="true" tabindex="-1"></a>remember <span class="ot">=</span> <span class="cf">function</span>(memory, state, action, reward, next_state, done){</span>
<span id="cb499-34"><a href="generative-modeling-and-reinforcement-learning.html#cb499-34" aria-hidden="true" tabindex="-1"></a> memory[counter,] <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="fu">c</span>(state, action, reward, next_state, done))</span>
<span id="cb499-35"><a href="generative-modeling-and-reinforcement-learning.html#cb499-35" aria-hidden="true" tabindex="-1"></a> counter <span class="ot">&lt;&lt;-</span> counter<span class="sc">+</span><span class="dv">1</span></span>
<span id="cb499-36"><a href="generative-modeling-and-reinforcement-learning.html#cb499-36" aria-hidden="true" tabindex="-1"></a> <span class="fu">return</span>(memory)</span>
<span id="cb499-37"><a href="generative-modeling-and-reinforcement-learning.html#cb499-37" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb499-38"><a href="generative-modeling-and-reinforcement-learning.html#cb499-38" aria-hidden="true" tabindex="-1"></a><span class="co"># memory: state 1:4, action 5, reward 6, next_state 7:10, done 11</span></span>
<span id="cb499-39"><a href="generative-modeling-and-reinforcement-learning.html#cb499-39" aria-hidden="true" tabindex="-1"></a>act <span class="ot">=</span> <span class="cf">function</span>(state){</span>
<span id="cb499-40"><a href="generative-modeling-and-reinforcement-learning.html#cb499-40" aria-hidden="true" tabindex="-1"></a> <span class="cf">if</span>(<span class="fu">runif</span>(<span class="dv">1</span>) <span class="sc">&lt;=</span> epsilon) <span class="fu">return</span>(<span class="fu">sample</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="dv">1</span>)) <span class="co"># </span></span>
<span id="cb499-41"><a href="generative-modeling-and-reinforcement-learning.html#cb499-41" aria-hidden="true" tabindex="-1"></a> act_prob <span class="ot">=</span> <span class="fu">predict</span>(model, <span class="fu">matrix</span>(state,<span class="at">nrow =</span> 1L))</span>
<span id="cb499-42"><a href="generative-modeling-and-reinforcement-learning.html#cb499-42" aria-hidden="true" tabindex="-1"></a> <span class="fu">return</span>(<span class="fu">which.max</span>(act_prob) <span class="sc">-</span>1L)</span>
<span id="cb499-43"><a href="generative-modeling-and-reinforcement-learning.html#cb499-43" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb499-44"><a href="generative-modeling-and-reinforcement-learning.html#cb499-44" aria-hidden="true" tabindex="-1"></a>replay <span class="ot">=</span> <span class="cf">function</span>(<span class="at">batch_size =</span> 25L, memory, counter){</span>
<span id="cb499-45"><a href="generative-modeling-and-reinforcement-learning.html#cb499-45" aria-hidden="true" tabindex="-1"></a> indices <span class="ot">=</span> <span class="fu">sample.int</span>(counter, batch_size)</span>
<span id="cb499-46"><a href="generative-modeling-and-reinforcement-learning.html#cb499-46" aria-hidden="true" tabindex="-1"></a> batch <span class="ot">=</span> memory[indices,,drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb499-47"><a href="generative-modeling-and-reinforcement-learning.html#cb499-47" aria-hidden="true" tabindex="-1"></a> <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(batch)){</span>
<span id="cb499-48"><a href="generative-modeling-and-reinforcement-learning.html#cb499-48" aria-hidden="true" tabindex="-1"></a> target <span class="ot">=</span> batch[i,<span class="dv">6</span>] <span class="co">#reward</span></span>
<span id="cb499-49"><a href="generative-modeling-and-reinforcement-learning.html#cb499-49" aria-hidden="true" tabindex="-1"></a> action <span class="ot">=</span> batch[i,<span class="dv">5</span>] <span class="co">#action</span></span>
<span id="cb499-50"><a href="generative-modeling-and-reinforcement-learning.html#cb499-50" aria-hidden="true" tabindex="-1"></a> state <span class="ot">=</span> <span class="fu">matrix</span>(memory[i, <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>], <span class="at">nrow =</span> 1L)</span>
<span id="cb499-51"><a href="generative-modeling-and-reinforcement-learning.html#cb499-51" aria-hidden="true" tabindex="-1"></a> next_state <span class="ot">=</span> <span class="fu">matrix</span>(memory[i,<span class="dv">7</span><span class="sc">:</span><span class="dv">10</span>], <span class="at">nrow =</span>1L)</span>
<span id="cb499-52"><a href="generative-modeling-and-reinforcement-learning.html#cb499-52" aria-hidden="true" tabindex="-1"></a> <span class="cf">if</span>(<span class="sc">!</span>batch[i,<span class="dv">11</span>]){ <span class="co"># not done</span></span>
<span id="cb499-53"><a href="generative-modeling-and-reinforcement-learning.html#cb499-53" aria-hidden="true" tabindex="-1"></a> target <span class="ot">=</span> (batch[i,<span class="dv">6</span>] <span class="sc">+</span> gamma<span class="sc">*</span> <span class="fu">predict</span>(model, <span class="fu">matrix</span>(next_state, <span class="at">nrow =</span> 1L)))[<span class="dv">1</span>,<span class="dv">1</span>]</span>
<span id="cb499-54"><a href="generative-modeling-and-reinforcement-learning.html#cb499-54" aria-hidden="true" tabindex="-1"></a> } </span>
<span id="cb499-55"><a href="generative-modeling-and-reinforcement-learning.html#cb499-55" aria-hidden="true" tabindex="-1"></a> target_f <span class="ot">=</span> <span class="fu">predict</span>(model, <span class="fu">matrix</span>(state, <span class="at">nrow =</span> 1L))</span>
<span id="cb499-56"><a href="generative-modeling-and-reinforcement-learning.html#cb499-56" aria-hidden="true" tabindex="-1"></a> target_f[action<span class="sc">+</span>1L] <span class="ot">=</span> target</span>
<span id="cb499-57"><a href="generative-modeling-and-reinforcement-learning.html#cb499-57" aria-hidden="true" tabindex="-1"></a> model<span class="sc">$</span><span class="fu">fit</span>(<span class="at">x =</span> state, <span class="at">y =</span> target_f, <span class="at">epochs =</span> 1L, <span class="at">verbose =</span> 0L)</span>
<span id="cb499-58"><a href="generative-modeling-and-reinforcement-learning.html#cb499-58" aria-hidden="true" tabindex="-1"></a> <span class="cf">if</span>(epsilon <span class="sc">&gt;</span> epsilon_min){</span>
<span id="cb499-59"><a href="generative-modeling-and-reinforcement-learning.html#cb499-59" aria-hidden="true" tabindex="-1"></a> epsilon <span class="ot">&lt;&lt;-</span> epsilon_decay<span class="sc">*</span>epsilon</span>
<span id="cb499-60"><a href="generative-modeling-and-reinforcement-learning.html#cb499-60" aria-hidden="true" tabindex="-1"></a> }</span>
<span id="cb499-61"><a href="generative-modeling-and-reinforcement-learning.html#cb499-61" aria-hidden="true" tabindex="-1"></a> }</span>
<span id="cb499-62"><a href="generative-modeling-and-reinforcement-learning.html#cb499-62" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb499-63"><a href="generative-modeling-and-reinforcement-learning.html#cb499-63" aria-hidden="true" tabindex="-1"></a>done <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb499-64"><a href="generative-modeling-and-reinforcement-learning.html#cb499-64" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(e <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>){</span>
<span id="cb499-65"><a href="generative-modeling-and-reinforcement-learning.html#cb499-65" aria-hidden="true" tabindex="-1"></a> state <span class="ot">=</span> <span class="fu">unlist</span>(<span class="fu">env_reset</span>(client, env))</span>
<span id="cb499-66"><a href="generative-modeling-and-reinforcement-learning.html#cb499-66" aria-hidden="true" tabindex="-1"></a> <span class="cf">for</span>(time <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">500</span>){</span>
<span id="cb499-67"><a href="generative-modeling-and-reinforcement-learning.html#cb499-67" aria-hidden="true" tabindex="-1"></a> action <span class="ot">=</span> <span class="fu">act</span>(state)</span>
<span id="cb499-68"><a href="generative-modeling-and-reinforcement-learning.html#cb499-68" aria-hidden="true" tabindex="-1"></a> response <span class="ot">=</span> <span class="fu">env_step</span>(client, env, <span class="at">action =</span> action)</span>
<span id="cb499-69"><a href="generative-modeling-and-reinforcement-learning.html#cb499-69" aria-hidden="true" tabindex="-1"></a> done <span class="ot">=</span> <span class="fu">as.integer</span>(response<span class="sc">$</span>done)</span>
<span id="cb499-70"><a href="generative-modeling-and-reinforcement-learning.html#cb499-70" aria-hidden="true" tabindex="-1"></a> <span class="cf">if</span>(<span class="sc">!</span>done) reward <span class="ot">=</span> response<span class="sc">$</span>reward</span>
<span id="cb499-71"><a href="generative-modeling-and-reinforcement-learning.html#cb499-71" aria-hidden="true" tabindex="-1"></a> <span class="cf">else</span> reward <span class="ot">=</span> <span class="sc">-</span><span class="dv">10</span></span>
<span id="cb499-72"><a href="generative-modeling-and-reinforcement-learning.html#cb499-72" aria-hidden="true" tabindex="-1"></a> next_state <span class="ot">=</span> <span class="fu">unlist</span>(response<span class="sc">$</span>observation)</span>
<span id="cb499-73"><a href="generative-modeling-and-reinforcement-learning.html#cb499-73" aria-hidden="true" tabindex="-1"></a> memory <span class="ot">=</span> <span class="fu">remember</span>(memory, state, action, reward, next_state, done)</span>
<span id="cb499-74"><a href="generative-modeling-and-reinforcement-learning.html#cb499-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb499-75"><a href="generative-modeling-and-reinforcement-learning.html#cb499-75" aria-hidden="true" tabindex="-1"></a> state <span class="ot">=</span> next_state</span>
<span id="cb499-76"><a href="generative-modeling-and-reinforcement-learning.html#cb499-76" aria-hidden="true" tabindex="-1"></a> <span class="cf">if</span>(done){</span>
<span id="cb499-77"><a href="generative-modeling-and-reinforcement-learning.html#cb499-77" aria-hidden="true" tabindex="-1"></a> <span class="fu">cat</span>(<span class="st">&quot;episode&quot;</span>, e<span class="sc">/</span><span class="dv">500</span>, <span class="st">&quot; score: &quot;</span>, time, <span class="st">&quot; eps: &quot;</span>, epsilon, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb499-78"><a href="generative-modeling-and-reinforcement-learning.html#cb499-78" aria-hidden="true" tabindex="-1"></a> <span class="cf">break</span>()</span>
<span id="cb499-79"><a href="generative-modeling-and-reinforcement-learning.html#cb499-79" aria-hidden="true" tabindex="-1"></a> } </span>
<span id="cb499-80"><a href="generative-modeling-and-reinforcement-learning.html#cb499-80" aria-hidden="true" tabindex="-1"></a> <span class="cf">if</span>(counter <span class="sc">&gt;</span> 32L) </span>
<span id="cb499-81"><a href="generative-modeling-and-reinforcement-learning.html#cb499-81" aria-hidden="true" tabindex="-1"></a> <span class="fu">replay</span>(32L, memory, counter<span class="sc">-</span>1L)</span>
<span id="cb499-82"><a href="generative-modeling-and-reinforcement-learning.html#cb499-82" aria-hidden="true" tabindex="-1"></a> }</span>
<span id="cb499-83"><a href="generative-modeling-and-reinforcement-learning.html#cb499-83" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="interpretation-and-causality-with-machine-learning.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="datasets.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
