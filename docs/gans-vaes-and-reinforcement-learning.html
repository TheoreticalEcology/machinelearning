<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>6 GANs, VAEs, and Reinforcement learning | Machine Learning and AI in TensorFlow and R</title>
  <meta name="description" content="6 GANs, VAEs, and Reinforcement learning | Machine Learning and AI in TensorFlow and R" />
  <meta name="generator" content="bookdown 0.22 and GitBook 2.6.7" />

  <meta property="og:title" content="6 GANs, VAEs, and Reinforcement learning | Machine Learning and AI in TensorFlow and R" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="6 GANs, VAEs, and Reinforcement learning | Machine Learning and AI in TensorFlow and R" />
  <meta name="github-repo" content="rstudio/bookdown-demo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="6 GANs, VAEs, and Reinforcement learning | Machine Learning and AI in TensorFlow and R" />
  
  <meta name="twitter:description" content="6 GANs, VAEs, and Reinforcement learning | Machine Learning and AI in TensorFlow and R" />
  

<meta name="author" content="Maximilian Pichler and Florian Hartig" />


<meta name="date" content="2021-05-02" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="xAI.html"/>
<link rel="next" href="datasets.html"/>
<script src="libs/header-attrs-2.6/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    background-color: #ffffff;
    color: #a0a0a0;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #a0a0a0;  padding-left: 4px; }
div.sourceCode
  { color: #1f1c1b; background-color: #ffffff; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span { color: #1f1c1b; } /* Normal */
code span.al { color: #bf0303; background-color: #f7e6e6; font-weight: bold; } /* Alert */
code span.an { color: #ca60ca; } /* Annotation */
code span.at { color: #0057ae; } /* Attribute */
code span.bn { color: #b08000; } /* BaseN */
code span.bu { color: #644a9b; font-weight: bold; } /* BuiltIn */
code span.cf { color: #1f1c1b; font-weight: bold; } /* ControlFlow */
code span.ch { color: #924c9d; } /* Char */
code span.cn { color: #aa5500; } /* Constant */
code span.co { color: #898887; } /* Comment */
code span.cv { color: #0095ff; } /* CommentVar */
code span.do { color: #607880; } /* Documentation */
code span.dt { color: #0057ae; } /* DataType */
code span.dv { color: #b08000; } /* DecVal */
code span.er { color: #bf0303; text-decoration: underline; } /* Error */
code span.ex { color: #0095ff; font-weight: bold; } /* Extension */
code span.fl { color: #b08000; } /* Float */
code span.fu { color: #644a9b; } /* Function */
code span.im { color: #ff5500; } /* Import */
code span.in { color: #b08000; } /* Information */
code span.kw { color: #1f1c1b; font-weight: bold; } /* Keyword */
code span.op { color: #1f1c1b; } /* Operator */
code span.ot { color: #006e28; } /* Other */
code span.pp { color: #006e28; } /* Preprocessor */
code span.re { color: #0057ae; background-color: #e0e9f8; } /* RegionMarker */
code span.sc { color: #3daee9; } /* SpecialChar */
code span.ss { color: #ff5500; } /* SpecialString */
code span.st { color: #bf0303; } /* String */
code span.va { color: #0057ae; } /* Variable */
code span.vs { color: #bf0303; } /* VerbatimString */
code span.wa { color: #bf0303; } /* Warning */
</style>


</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Prerequisites</a></li>
<li class="chapter" data-level="2" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>2</b> Introduction to Machine Learning</a>
<ul>
<li class="chapter" data-level="2.1" data-path="introduction.html"><a href="introduction.html#unsupervised-learning"><i class="fa fa-check"></i><b>2.1</b> Unsupervised learning</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="introduction.html"><a href="introduction.html#hierarchical-clustering"><i class="fa fa-check"></i><b>2.1.1</b> Hierarchical clustering</a></li>
<li class="chapter" data-level="2.1.2" data-path="introduction.html"><a href="introduction.html#k-means-clustering"><i class="fa fa-check"></i><b>2.1.2</b> k-means clustering</a></li>
<li class="chapter" data-level="2.1.3" data-path="introduction.html"><a href="introduction.html#density-based-clustering"><i class="fa fa-check"></i><b>2.1.3</b> Density-based clustering</a></li>
<li class="chapter" data-level="2.1.4" data-path="introduction.html"><a href="introduction.html#model-based-clustering"><i class="fa fa-check"></i><b>2.1.4</b> Model-based clustering</a></li>
<li class="chapter" data-level="2.1.5" data-path="introduction.html"><a href="introduction.html#ordination"><i class="fa fa-check"></i><b>2.1.5</b> Ordination</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="introduction.html"><a href="introduction.html#supervised-learning-regression-and-classification"><i class="fa fa-check"></i><b>2.2</b> Supervised learning: regression and classification</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="introduction.html"><a href="introduction.html#supervised-regression-using-random-forest"><i class="fa fa-check"></i><b>2.2.1</b> Supervised regression using Random Forest</a></li>
<li class="chapter" data-level="2.2.2" data-path="introduction.html"><a href="introduction.html#supervised-classification-using-random-forest"><i class="fa fa-check"></i><b>2.2.2</b> Supervised classification using Random Forest</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="introduction.html"><a href="introduction.html#introduction-to-tensorflow"><i class="fa fa-check"></i><b>2.3</b> Introduction to Tensorflow</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="introduction.html"><a href="introduction.html#tensorflow-data-containers"><i class="fa fa-check"></i><b>2.3.1</b> Tensorflow data containers</a></li>
<li class="chapter" data-level="2.3.2" data-path="introduction.html"><a href="introduction.html#tensorflow-data-types---good-practise-with-r-tf"><i class="fa fa-check"></i><b>2.3.2</b> Tensorflow data types - good practise with R-TF</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="introduction.html"><a href="introduction.html#introduction-to-pytorch"><i class="fa fa-check"></i><b>2.4</b> Introduction to PyTorch</a>
<ul>
<li class="chapter" data-level="2.4.1" data-path="introduction.html"><a href="introduction.html#pytorch-data-containers"><i class="fa fa-check"></i><b>2.4.1</b> PyTorch data containers</a></li>
<li class="chapter" data-level="2.4.2" data-path="introduction.html"><a href="introduction.html#torch-data-types---good-practise-with-r-tf"><i class="fa fa-check"></i><b>2.4.2</b> Torch data types - good practise with R-TF</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="introduction.html"><a href="introduction.html#first-steps-with-the-keras-framework"><i class="fa fa-check"></i><b>2.5</b> First steps with the keras framework</a>
<ul>
<li class="chapter" data-level="2.5.1" data-path="introduction.html"><a href="introduction.html#example-workflow-in-keras"><i class="fa fa-check"></i><b>2.5.1</b> Example workflow in keras</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="fund.html"><a href="fund.html"><i class="fa fa-check"></i><b>3</b> Fundamental principles and techniques</a>
<ul>
<li class="chapter" data-level="3.1" data-path="fund.html"><a href="fund.html#machine-learning-principles"><i class="fa fa-check"></i><b>3.1</b> Machine learning principles</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="fund.html"><a href="fund.html#optimization"><i class="fa fa-check"></i><b>3.1.1</b> Optimization</a></li>
<li class="chapter" data-level="3.1.2" data-path="fund.html"><a href="fund.html#regularization"><i class="fa fa-check"></i><b>3.1.2</b> Regularization</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="fund.html"><a href="fund.html#tree-based-ml-algorithms"><i class="fa fa-check"></i><b>3.2</b> Tree-based ML algorithms</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="fund.html"><a href="fund.html#classification-and-regression-trees"><i class="fa fa-check"></i><b>3.2.1</b> Classification and Regression Trees</a></li>
<li class="chapter" data-level="3.2.2" data-path="fund.html"><a href="fund.html#random-forest"><i class="fa fa-check"></i><b>3.2.2</b> Random Forest</a></li>
<li class="chapter" data-level="3.2.3" data-path="fund.html"><a href="fund.html#boosted-regression-trees"><i class="fa fa-check"></i><b>3.2.3</b> Boosted regression trees</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="fund.html"><a href="fund.html#distance-based-algorithms"><i class="fa fa-check"></i><b>3.3</b> Distance-based algorithms</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="fund.html"><a href="fund.html#k-nearest-neighbor"><i class="fa fa-check"></i><b>3.3.1</b> k-nearest-neighbor</a></li>
<li class="chapter" data-level="3.3.2" data-path="fund.html"><a href="fund.html#support-vector-machines-svm"><i class="fa fa-check"></i><b>3.3.2</b> Support Vector Machines (SVM)</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="fund.html"><a href="fund.html#artificial-neural-networks"><i class="fa fa-check"></i><b>3.4</b> Artificial neural networks</a>
<ul>
<li class="chapter" data-level="3.4.1" data-path="fund.html"><a href="fund.html#data-cleaning"><i class="fa fa-check"></i><b>3.4.1</b> Data cleaning</a></li>
<li class="chapter" data-level="3.4.2" data-path="fund.html"><a href="fund.html#pre-processing-and-feature-selection"><i class="fa fa-check"></i><b>3.4.2</b> Pre-processing and feature selection</a></li>
<li class="chapter" data-level="3.4.3" data-path="fund.html"><a href="fund.html#split-data-for-training-and-testing"><i class="fa fa-check"></i><b>3.4.3</b> Split data for training and testing</a></li>
<li class="chapter" data-level="3.4.4" data-path="fund.html"><a href="fund.html#model-fitting"><i class="fa fa-check"></i><b>3.4.4</b> Model fitting</a></li>
<li class="chapter" data-level="3.4.5" data-path="fund.html"><a href="fund.html#model-evaluation"><i class="fa fa-check"></i><b>3.4.5</b> Model evaluation</a></li>
<li class="chapter" data-level="3.4.6" data-path="fund.html"><a href="fund.html#predictions-and-submission"><i class="fa fa-check"></i><b>3.4.6</b> Predictions and submission</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="Deep.html"><a href="Deep.html"><i class="fa fa-check"></i><b>4</b> Deep learning</a>
<ul>
<li class="chapter" data-level="4.1" data-path="Deep.html"><a href="Deep.html#deep-neural-networks"><i class="fa fa-check"></i><b>4.1</b> Deep Neural Networks</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="Deep.html"><a href="Deep.html#dropout-and-early-stopping"><i class="fa fa-check"></i><b>4.1.1</b> Dropout and Early stopping</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="Deep.html"><a href="Deep.html#convolutional-neural-networks---mnist"><i class="fa fa-check"></i><b>4.2</b> Convolutional Neural Networks - MNIST</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="Deep.html"><a href="Deep.html#data-augmentation"><i class="fa fa-check"></i><b>4.2.1</b> Data Augmentation</a></li>
<li class="chapter" data-level="4.2.2" data-path="Deep.html"><a href="Deep.html#transfer"><i class="fa fa-check"></i><b>4.2.2</b> Transfer learning</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="Deep.html"><a href="Deep.html#flower-dataset"><i class="fa fa-check"></i><b>4.3</b> Flower dataset</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="xAI.html"><a href="xAI.html"><i class="fa fa-check"></i><b>5</b> Explainable AI (xAI), NLP, and RNNs</a>
<ul>
<li class="chapter" data-level="5.1" data-path="xAI.html"><a href="xAI.html#xai-methods"><i class="fa fa-check"></i><b>5.1</b> xAI Methods</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="xAI.html"><a href="xAI.html#variable-importance"><i class="fa fa-check"></i><b>5.1.1</b> Variable Importance</a></li>
<li class="chapter" data-level="5.1.2" data-path="xAI.html"><a href="xAI.html#partial-dependencies"><i class="fa fa-check"></i><b>5.1.2</b> Partial dependencies</a></li>
<li class="chapter" data-level="5.1.3" data-path="xAI.html"><a href="xAI.html#accumulated-local-effects"><i class="fa fa-check"></i><b>5.1.3</b> Accumulated local effects</a></li>
<li class="chapter" data-level="5.1.4" data-path="xAI.html"><a href="xAI.html#friedmans-h-statistic"><i class="fa fa-check"></i><b>5.1.4</b> Friedmans H-statistic</a></li>
<li class="chapter" data-level="5.1.5" data-path="xAI.html"><a href="xAI.html#global-explainer---simplifying-the-ml-model"><i class="fa fa-check"></i><b>5.1.5</b> Global explainer - Simplifying the ML model</a></li>
<li class="chapter" data-level="5.1.6" data-path="xAI.html"><a href="xAI.html#local-explainer---lime-explaining-single-instances-observations"><i class="fa fa-check"></i><b>5.1.6</b> Local explainer - LIME explaining single instances (observations)</a></li>
<li class="chapter" data-level="5.1.7" data-path="xAI.html"><a href="xAI.html#local-explainer---shapley"><i class="fa fa-check"></i><b>5.1.7</b> Local explainer - Shapley</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="xAI.html"><a href="xAI.html#natural-language-processing-nlp"><i class="fa fa-check"></i><b>5.2</b> Natural Language Processing (NLP)</a></li>
<li class="chapter" data-level="5.3" data-path="xAI.html"><a href="xAI.html#recurrent-neural-networks-rnns"><i class="fa fa-check"></i><b>5.3</b> Recurrent neural networks (RNNs)</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="gans-vaes-and-reinforcement-learning.html"><a href="gans-vaes-and-reinforcement-learning.html"><i class="fa fa-check"></i><b>6</b> GANs, VAEs, and Reinforcement learning</a>
<ul>
<li class="chapter" data-level="6.1" data-path="gans-vaes-and-reinforcement-learning.html"><a href="gans-vaes-and-reinforcement-learning.html#generative-adversarial-network-gans"><i class="fa fa-check"></i><b>6.1</b> Generative adversarial network (GANs)</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="gans-vaes-and-reinforcement-learning.html"><a href="gans-vaes-and-reinforcement-learning.html#mnist---gan-based-on-dnns"><i class="fa fa-check"></i><b>6.1.1</b> MNIST - GAN based on DNNs</a></li>
<li class="chapter" data-level="6.1.2" data-path="gans-vaes-and-reinforcement-learning.html"><a href="gans-vaes-and-reinforcement-learning.html#flower---gan"><i class="fa fa-check"></i><b>6.1.2</b> Flower - GAN</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="gans-vaes-and-reinforcement-learning.html"><a href="gans-vaes-and-reinforcement-learning.html#autoencoder"><i class="fa fa-check"></i><b>6.2</b> Autoencoder</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="gans-vaes-and-reinforcement-learning.html"><a href="gans-vaes-and-reinforcement-learning.html#autoencoder---mnist-cnn"><i class="fa fa-check"></i><b>6.2.1</b> Autoencoder - MNIST CNN</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="gans-vaes-and-reinforcement-learning.html"><a href="gans-vaes-and-reinforcement-learning.html#varational-autoencoder"><i class="fa fa-check"></i><b>6.3</b> Varational Autoencoder</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="datasets.html"><a href="datasets.html"><i class="fa fa-check"></i><b>7</b> Datasets</a>
<ul>
<li class="chapter" data-level="7.1" data-path="datasets.html"><a href="datasets.html#titanic"><i class="fa fa-check"></i><b>7.1</b> Titanic</a></li>
<li class="chapter" data-level="7.2" data-path="datasets.html"><a href="datasets.html#plant-pollinator-database"><i class="fa fa-check"></i><b>7.2</b> Plant-pollinator database</a></li>
<li class="chapter" data-level="7.3" data-path="datasets.html"><a href="datasets.html#wine"><i class="fa fa-check"></i><b>7.3</b> Wine</a></li>
<li class="chapter" data-level="7.4" data-path="datasets.html"><a href="datasets.html#nasa"><i class="fa fa-check"></i><b>7.4</b> Nasa</a></li>
<li class="chapter" data-level="7.5" data-path="datasets.html"><a href="datasets.html#flower"><i class="fa fa-check"></i><b>7.5</b> Flower</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Machine Learning and AI in TensorFlow and R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="gans-vaes-and-reinforcement-learning" class="section level1" number="6">
<h1><span class="header-section-number">6</span> GANs, VAEs, and Reinforcement learning</h1>
<div id="generative-adversarial-network-gans" class="section level2" number="6.1">
<h2><span class="header-section-number">6.1</span> Generative adversarial network (GANs)</h2>
<p>The idea of generative adversarial network (GAN) is that two neural networks contest with each other in a game. On network is creating data and is trying to “trick” the other into thinking that this data is real. A possible application is to create pictures that look like real photographs. However, the application of GANs today is much wider than just the creation of data. For example, GANs can also be used to “augment” data, i.e. to create new data and thereby improve the fitted model.</p>
<div id="mnist---gan-based-on-dnns" class="section level3" number="6.1.1">
<h3><span class="header-section-number">6.1.1</span> MNIST - GAN based on DNNs</h3>
<p>GANs - two networks are playing against each other. The generator (similar to the decoder in AEs) creates new images from noise and tries to convince the discriminator that this is a real image.</p>
<p>The discriminator is getting a mix of true images (from the dataset) and of artificially generated images from the generator.</p>
<p>Loss of the generator - when fakes are identified as fakes by the discriminator (simple binary_crossentropy loss, 0/1…)</p>
<p>Loss of the discriminator - when fakes are identified as fakes (class 1) and true images as true images (class 0), again simple binary crossentropy.</p>
<p>MNIST example:</p>
<div class="sourceCode" id="cb309"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb309-1"><a href="gans-vaes-and-reinforcement-learning.html#cb309-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(keras)</span>
<span id="cb309-2"><a href="gans-vaes-and-reinforcement-learning.html#cb309-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tensorflow)</span>
<span id="cb309-3"><a href="gans-vaes-and-reinforcement-learning.html#cb309-3" aria-hidden="true" tabindex="-1"></a>rotate <span class="ot">=</span> <span class="cf">function</span>(x) <span class="fu">t</span>(<span class="fu">apply</span>(x, <span class="dv">2</span>, rev))</span>
<span id="cb309-4"><a href="gans-vaes-and-reinforcement-learning.html#cb309-4" aria-hidden="true" tabindex="-1"></a>imgPlot <span class="ot">=</span> <span class="cf">function</span>(img, <span class="at">title =</span> <span class="st">&quot;&quot;</span>){</span>
<span id="cb309-5"><a href="gans-vaes-and-reinforcement-learning.html#cb309-5" aria-hidden="true" tabindex="-1"></a> col<span class="ot">=</span><span class="fu">grey.colors</span>(<span class="dv">255</span>)</span>
<span id="cb309-6"><a href="gans-vaes-and-reinforcement-learning.html#cb309-6" aria-hidden="true" tabindex="-1"></a> <span class="fu">image</span>(<span class="fu">rotate</span>(img), <span class="at">col =</span> col, <span class="at">xlab =</span> <span class="st">&quot;&quot;</span>, <span class="at">ylab =</span> <span class="st">&quot;&quot;</span>, <span class="at">axes=</span><span class="cn">FALSE</span>, <span class="at">main =</span> <span class="fu">paste0</span>(<span class="st">&quot;Label: &quot;</span>, <span class="fu">as.character</span>(title)))</span>
<span id="cb309-7"><a href="gans-vaes-and-reinforcement-learning.html#cb309-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>We don’t need the test set:</p>
<div class="sourceCode" id="cb310"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb310-1"><a href="gans-vaes-and-reinforcement-learning.html#cb310-1" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> <span class="fu">dataset_mnist</span>()</span>
<span id="cb310-2"><a href="gans-vaes-and-reinforcement-learning.html#cb310-2" aria-hidden="true" tabindex="-1"></a>train <span class="ot">=</span> data<span class="sc">$</span>train</span>
<span id="cb310-3"><a href="gans-vaes-and-reinforcement-learning.html#cb310-3" aria-hidden="true" tabindex="-1"></a>train_x <span class="ot">=</span> <span class="fu">array</span>((train<span class="sc">$</span>x<span class="fl">-127.5</span>)<span class="sc">/</span><span class="fl">127.5</span>, <span class="fu">c</span>(<span class="fu">dim</span>(train<span class="sc">$</span>x)[<span class="dv">1</span>], 784L))</span></code></pre></div>
<p>Define and test generator model:</p>
<div class="sourceCode" id="cb311"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb311-1"><a href="gans-vaes-and-reinforcement-learning.html#cb311-1" aria-hidden="true" tabindex="-1"></a>get_generator <span class="ot">=</span> <span class="cf">function</span>(){</span>
<span id="cb311-2"><a href="gans-vaes-and-reinforcement-learning.html#cb311-2" aria-hidden="true" tabindex="-1"></a> generator <span class="ot">=</span> <span class="fu">keras_model_sequential</span>()</span>
<span id="cb311-3"><a href="gans-vaes-and-reinforcement-learning.html#cb311-3" aria-hidden="true" tabindex="-1"></a> generator <span class="sc">%&gt;%</span> </span>
<span id="cb311-4"><a href="gans-vaes-and-reinforcement-learning.html#cb311-4" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_dense</span>(<span class="at">units =</span> 200L ,<span class="at">input_shape =</span> <span class="fu">c</span>(100L)) <span class="sc">%&gt;%</span> </span>
<span id="cb311-5"><a href="gans-vaes-and-reinforcement-learning.html#cb311-5" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_activation_leaky_relu</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb311-6"><a href="gans-vaes-and-reinforcement-learning.html#cb311-6" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_dense</span>(<span class="at">units =</span> 200L) <span class="sc">%&gt;%</span> </span>
<span id="cb311-7"><a href="gans-vaes-and-reinforcement-learning.html#cb311-7" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_activation_leaky_relu</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb311-8"><a href="gans-vaes-and-reinforcement-learning.html#cb311-8" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_dense</span>(<span class="at">units =</span> 784L, <span class="at">activation =</span> <span class="st">&quot;tanh&quot;</span>)</span>
<span id="cb311-9"><a href="gans-vaes-and-reinforcement-learning.html#cb311-9" aria-hidden="true" tabindex="-1"></a> <span class="fu">return</span>(generator)</span>
<span id="cb311-10"><a href="gans-vaes-and-reinforcement-learning.html#cb311-10" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb312"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb312-1"><a href="gans-vaes-and-reinforcement-learning.html#cb312-1" aria-hidden="true" tabindex="-1"></a>generator <span class="ot">=</span> <span class="fu">get_generator</span>()</span>
<span id="cb312-2"><a href="gans-vaes-and-reinforcement-learning.html#cb312-2" aria-hidden="true" tabindex="-1"></a>sample <span class="ot">=</span> tf<span class="sc">$</span>random<span class="sc">$</span><span class="fu">normal</span>(<span class="fu">c</span>(1L, 100L))</span>
<span id="cb312-3"><a href="gans-vaes-and-reinforcement-learning.html#cb312-3" aria-hidden="true" tabindex="-1"></a><span class="fu">imgPlot</span>(<span class="fu">array</span>(<span class="fu">generator</span>(sample)<span class="sc">$</span><span class="fu">numpy</span>(), <span class="fu">c</span>(28L, 28L)))</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-153-1.png" width="672" /></p>
<p>The noise of size = [100] (random vector with 100 values) is passed through the network and the output correspond to the number of pixels of one MNIST image (784)</p>
<div class="sourceCode" id="cb313"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb313-1"><a href="gans-vaes-and-reinforcement-learning.html#cb313-1" aria-hidden="true" tabindex="-1"></a>get_discriminator <span class="ot">=</span> <span class="cf">function</span>(){</span>
<span id="cb313-2"><a href="gans-vaes-and-reinforcement-learning.html#cb313-2" aria-hidden="true" tabindex="-1"></a> discriminator <span class="ot">=</span> <span class="fu">keras_model_sequential</span>()</span>
<span id="cb313-3"><a href="gans-vaes-and-reinforcement-learning.html#cb313-3" aria-hidden="true" tabindex="-1"></a> discriminator <span class="sc">%&gt;%</span> </span>
<span id="cb313-4"><a href="gans-vaes-and-reinforcement-learning.html#cb313-4" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_dense</span>(<span class="at">units =</span> 200L, <span class="at">input_shape =</span> <span class="fu">c</span>(784L)) <span class="sc">%&gt;%</span> </span>
<span id="cb313-5"><a href="gans-vaes-and-reinforcement-learning.html#cb313-5" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_activation_leaky_relu</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb313-6"><a href="gans-vaes-and-reinforcement-learning.html#cb313-6" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_dense</span>(<span class="at">units =</span> 100L) <span class="sc">%&gt;%</span> </span>
<span id="cb313-7"><a href="gans-vaes-and-reinforcement-learning.html#cb313-7" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_activation_leaky_relu</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb313-8"><a href="gans-vaes-and-reinforcement-learning.html#cb313-8" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_dense</span>(<span class="at">units =</span> 1L, <span class="at">activation =</span> <span class="st">&quot;sigmoid&quot;</span>)</span>
<span id="cb313-9"><a href="gans-vaes-and-reinforcement-learning.html#cb313-9" aria-hidden="true" tabindex="-1"></a> <span class="fu">return</span>(discriminator)</span>
<span id="cb313-10"><a href="gans-vaes-and-reinforcement-learning.html#cb313-10" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb314"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb314-1"><a href="gans-vaes-and-reinforcement-learning.html#cb314-1" aria-hidden="true" tabindex="-1"></a>discriminator <span class="ot">=</span> <span class="fu">get_discriminator</span>()</span>
<span id="cb314-2"><a href="gans-vaes-and-reinforcement-learning.html#cb314-2" aria-hidden="true" tabindex="-1"></a><span class="fu">discriminator</span>(<span class="fu">generator</span>(tf<span class="sc">$</span>random<span class="sc">$</span><span class="fu">normal</span>(<span class="fu">c</span>(1L, 100L))))</span></code></pre></div>
<pre><code>## tf.Tensor([[0.35990807]], shape=(1, 1), dtype=float32)</code></pre>
<p>The normal architecture of a binary classifier (will get images as input)</p>
<p>Loss:</p>
<div class="sourceCode" id="cb316"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb316-1"><a href="gans-vaes-and-reinforcement-learning.html#cb316-1" aria-hidden="true" tabindex="-1"></a>ce <span class="ot">=</span> tf<span class="sc">$</span>keras<span class="sc">$</span>losses<span class="sc">$</span><span class="fu">BinaryCrossentropy</span>(<span class="at">from_logits =</span> <span class="cn">TRUE</span>)</span>
<span id="cb316-2"><a href="gans-vaes-and-reinforcement-learning.html#cb316-2" aria-hidden="true" tabindex="-1"></a>loss_discriminator <span class="ot">=</span> <span class="cf">function</span>(real, fake){</span>
<span id="cb316-3"><a href="gans-vaes-and-reinforcement-learning.html#cb316-3" aria-hidden="true" tabindex="-1"></a> real_loss <span class="ot">=</span> <span class="fu">ce</span>(tf<span class="sc">$</span><span class="fu">ones_like</span>(real), real)</span>
<span id="cb316-4"><a href="gans-vaes-and-reinforcement-learning.html#cb316-4" aria-hidden="true" tabindex="-1"></a> fake_loss <span class="ot">=</span> <span class="fu">ce</span>(tf<span class="sc">$</span><span class="fu">zeros_like</span>(fake), fake)</span>
<span id="cb316-5"><a href="gans-vaes-and-reinforcement-learning.html#cb316-5" aria-hidden="true" tabindex="-1"></a> <span class="fu">return</span>(real_loss<span class="sc">+</span>fake_loss)</span>
<span id="cb316-6"><a href="gans-vaes-and-reinforcement-learning.html#cb316-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb316-7"><a href="gans-vaes-and-reinforcement-learning.html#cb316-7" aria-hidden="true" tabindex="-1"></a>loss_generator <span class="ot">=</span> <span class="cf">function</span>(fake){</span>
<span id="cb316-8"><a href="gans-vaes-and-reinforcement-learning.html#cb316-8" aria-hidden="true" tabindex="-1"></a> <span class="fu">return</span>(<span class="fu">ce</span>(tf<span class="sc">$</span><span class="fu">ones_like</span>(fake), fake))</span>
<span id="cb316-9"><a href="gans-vaes-and-reinforcement-learning.html#cb316-9" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Binary crossentropy as loss function.</p>
<p>However, we have to encode the true and predicted values for the two networks individually.</p>
<p>The discriminator will get two losses - one for identifying fake images as fake, and one for identifying real MNIST images as real images.</p>
<p>The generator will just get one loss - was it able to deceive the discriminator?</p>
<p>Each network will get its own optimizer (while a AE will be treated as one network, in a GAN the networks will be treated independently)</p>
<div class="sourceCode" id="cb317"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb317-1"><a href="gans-vaes-and-reinforcement-learning.html#cb317-1" aria-hidden="true" tabindex="-1"></a>gen_opt <span class="ot">=</span> tf<span class="sc">$</span>keras<span class="sc">$</span>optimizers<span class="sc">$</span><span class="fu">RMSprop</span>(<span class="fl">1e-4</span>)</span>
<span id="cb317-2"><a href="gans-vaes-and-reinforcement-learning.html#cb317-2" aria-hidden="true" tabindex="-1"></a>disc_opt <span class="ot">=</span> tf<span class="sc">$</span>keras<span class="sc">$</span>optimizers<span class="sc">$</span><span class="fu">RMSprop</span>(<span class="fl">1e-4</span>)</span>
<span id="cb317-3"><a href="gans-vaes-and-reinforcement-learning.html#cb317-3" aria-hidden="true" tabindex="-1"></a>batch_size <span class="ot">=</span> 32L</span>
<span id="cb317-4"><a href="gans-vaes-and-reinforcement-learning.html#cb317-4" aria-hidden="true" tabindex="-1"></a>get_batch <span class="ot">=</span> <span class="cf">function</span>(){  <span class="co"># Helper function to get batches of images</span></span>
<span id="cb317-5"><a href="gans-vaes-and-reinforcement-learning.html#cb317-5" aria-hidden="true" tabindex="-1"></a> indices <span class="ot">=</span> <span class="fu">sample.int</span>(<span class="fu">nrow</span>(train_x), batch_size)</span>
<span id="cb317-6"><a href="gans-vaes-and-reinforcement-learning.html#cb317-6" aria-hidden="true" tabindex="-1"></a> <span class="fu">return</span>(tf<span class="sc">$</span><span class="fu">constant</span>(train_x[indices,], <span class="st">&quot;float32&quot;</span>))</span>
<span id="cb317-7"><a href="gans-vaes-and-reinforcement-learning.html#cb317-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>We have to write here our own training loop (we cannot use the fit function). Let’s define a training function:</p>
<div class="sourceCode" id="cb318"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb318-1"><a href="gans-vaes-and-reinforcement-learning.html#cb318-1" aria-hidden="true" tabindex="-1"></a>train_step <span class="ot">=</span> <span class="cf">function</span>(images){</span>
<span id="cb318-2"><a href="gans-vaes-and-reinforcement-learning.html#cb318-2" aria-hidden="true" tabindex="-1"></a> noise <span class="ot">=</span> tf<span class="sc">$</span>random<span class="sc">$</span><span class="fu">normal</span>(<span class="fu">c</span>(32L, 100L))</span>
<span id="cb318-3"><a href="gans-vaes-and-reinforcement-learning.html#cb318-3" aria-hidden="true" tabindex="-1"></a> <span class="fu">with</span>(tf<span class="sc">$</span><span class="fu">GradientTape</span>(<span class="at">persistent =</span> <span class="cn">TRUE</span>) <span class="sc">%as%</span> tape,{</span>
<span id="cb318-4"><a href="gans-vaes-and-reinforcement-learning.html#cb318-4" aria-hidden="true" tabindex="-1"></a> gen_images <span class="ot">=</span> <span class="fu">generator</span>(noise)</span>
<span id="cb318-5"><a href="gans-vaes-and-reinforcement-learning.html#cb318-5" aria-hidden="true" tabindex="-1"></a> fake_output <span class="ot">=</span> <span class="fu">discriminator</span>(gen_images)</span>
<span id="cb318-6"><a href="gans-vaes-and-reinforcement-learning.html#cb318-6" aria-hidden="true" tabindex="-1"></a> real_output <span class="ot">=</span> <span class="fu">discriminator</span>(images)</span>
<span id="cb318-7"><a href="gans-vaes-and-reinforcement-learning.html#cb318-7" aria-hidden="true" tabindex="-1"></a> gen_loss <span class="ot">=</span> <span class="fu">loss_generator</span>(fake_output)</span>
<span id="cb318-8"><a href="gans-vaes-and-reinforcement-learning.html#cb318-8" aria-hidden="true" tabindex="-1"></a> disc_loss <span class="ot">=</span> <span class="fu">loss_discriminator</span>(real_output, fake_output)</span>
<span id="cb318-9"><a href="gans-vaes-and-reinforcement-learning.html#cb318-9" aria-hidden="true" tabindex="-1"></a> })</span>
<span id="cb318-10"><a href="gans-vaes-and-reinforcement-learning.html#cb318-10" aria-hidden="true" tabindex="-1"></a> gen_grads <span class="ot">=</span> tape<span class="sc">$</span><span class="fu">gradient</span>(gen_loss, generator<span class="sc">$</span>weights)</span>
<span id="cb318-11"><a href="gans-vaes-and-reinforcement-learning.html#cb318-11" aria-hidden="true" tabindex="-1"></a> disc_grads <span class="ot">=</span> tape<span class="sc">$</span><span class="fu">gradient</span>(disc_loss, discriminator<span class="sc">$</span>weights)</span>
<span id="cb318-12"><a href="gans-vaes-and-reinforcement-learning.html#cb318-12" aria-hidden="true" tabindex="-1"></a> <span class="fu">rm</span>(tape)</span>
<span id="cb318-13"><a href="gans-vaes-and-reinforcement-learning.html#cb318-13" aria-hidden="true" tabindex="-1"></a> gen_opt<span class="sc">$</span><span class="fu">apply_gradients</span>(purrr<span class="sc">::</span><span class="fu">transpose</span>(<span class="fu">list</span>(gen_grads, generator<span class="sc">$</span>weights)))</span>
<span id="cb318-14"><a href="gans-vaes-and-reinforcement-learning.html#cb318-14" aria-hidden="true" tabindex="-1"></a> disc_opt<span class="sc">$</span><span class="fu">apply_gradients</span>(purrr<span class="sc">::</span><span class="fu">transpose</span>(<span class="fu">list</span>(disc_grads, discriminator<span class="sc">$</span>weights)))</span>
<span id="cb318-15"><a href="gans-vaes-and-reinforcement-learning.html#cb318-15" aria-hidden="true" tabindex="-1"></a> <span class="fu">return</span>(<span class="fu">c</span>(gen_loss, disc_loss))</span>
<span id="cb318-16"><a href="gans-vaes-and-reinforcement-learning.html#cb318-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb318-17"><a href="gans-vaes-and-reinforcement-learning.html#cb318-17" aria-hidden="true" tabindex="-1"></a>train_step <span class="ot">=</span> tf<span class="sc">$</span><span class="st">`</span><span class="at">function</span><span class="st">`</span>(reticulate<span class="sc">::</span><span class="fu">py_func</span>(train_step))</span></code></pre></div>
<p>In each iteration (for each batch) we will do the following (the GradientTape records computations to do automatic differenation):</p>
<ol style="list-style-type: decimal">
<li>sample noise</li>
<li>Generator creates images from the noise</li>
<li>Discriminator will make predictions for fake images and real images (response is a probability between [0,1])</li>
<li>Calculate loss for generator</li>
<li>Calculate loss for discriminator</li>
<li>Calculate gradients for weights and the loss</li>
<li>Update weights of generator</li>
<li>Update weights of discriminator</li>
<li>return losses</li>
</ol>
<div class="sourceCode" id="cb319"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb319-1"><a href="gans-vaes-and-reinforcement-learning.html#cb319-1" aria-hidden="true" tabindex="-1"></a>steps <span class="ot">=</span> <span class="fu">as.integer</span>(<span class="fu">nrow</span>(train_x)<span class="sc">/</span>batch_size)</span>
<span id="cb319-2"><a href="gans-vaes-and-reinforcement-learning.html#cb319-2" aria-hidden="true" tabindex="-1"></a>generator <span class="ot">=</span> <span class="fu">get_generator</span>()</span>
<span id="cb319-3"><a href="gans-vaes-and-reinforcement-learning.html#cb319-3" aria-hidden="true" tabindex="-1"></a>discriminator <span class="ot">=</span> <span class="fu">get_discriminator</span>()</span>
<span id="cb319-4"><a href="gans-vaes-and-reinforcement-learning.html#cb319-4" aria-hidden="true" tabindex="-1"></a>epochs <span class="ot">=</span> 30L</span>
<span id="cb319-5"><a href="gans-vaes-and-reinforcement-learning.html#cb319-5" aria-hidden="true" tabindex="-1"></a>steps <span class="ot">=</span> <span class="fu">as.integer</span>(<span class="fu">nrow</span>(train_x)<span class="sc">/</span>batch_size)</span>
<span id="cb319-6"><a href="gans-vaes-and-reinforcement-learning.html#cb319-6" aria-hidden="true" tabindex="-1"></a>counter <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb319-7"><a href="gans-vaes-and-reinforcement-learning.html#cb319-7" aria-hidden="true" tabindex="-1"></a>gen_loss <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb319-8"><a href="gans-vaes-and-reinforcement-learning.html#cb319-8" aria-hidden="true" tabindex="-1"></a>disc_loss <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb319-9"><a href="gans-vaes-and-reinforcement-learning.html#cb319-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(epochs<span class="sc">*</span>steps)){</span>
<span id="cb319-10"><a href="gans-vaes-and-reinforcement-learning.html#cb319-10" aria-hidden="true" tabindex="-1"></a> images <span class="ot">=</span> <span class="fu">get_batch</span>()</span>
<span id="cb319-11"><a href="gans-vaes-and-reinforcement-learning.html#cb319-11" aria-hidden="true" tabindex="-1"></a> losses <span class="ot">=</span> <span class="fu">train_step</span>(images)</span>
<span id="cb319-12"><a href="gans-vaes-and-reinforcement-learning.html#cb319-12" aria-hidden="true" tabindex="-1"></a> gen_loss <span class="ot">=</span> tf<span class="sc">$</span><span class="fu">reduce_sum</span>(losses[[<span class="dv">1</span>]])<span class="sc">$</span><span class="fu">numpy</span>()</span>
<span id="cb319-13"><a href="gans-vaes-and-reinforcement-learning.html#cb319-13" aria-hidden="true" tabindex="-1"></a> disc_loss <span class="ot">=</span> tf<span class="sc">$</span><span class="fu">reduce_sum</span>(losses[[<span class="dv">2</span>]])<span class="sc">$</span><span class="fu">numpy</span>()</span>
<span id="cb319-14"><a href="gans-vaes-and-reinforcement-learning.html#cb319-14" aria-hidden="true" tabindex="-1"></a> <span class="cf">if</span>(i <span class="sc">%%</span> <span class="dv">50</span><span class="sc">*</span>steps <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb319-15"><a href="gans-vaes-and-reinforcement-learning.html#cb319-15" aria-hidden="true" tabindex="-1"></a> noise <span class="ot">=</span> tf<span class="sc">$</span>random<span class="sc">$</span><span class="fu">normal</span>(<span class="fu">c</span>(1L, 100L))</span>
<span id="cb319-16"><a href="gans-vaes-and-reinforcement-learning.html#cb319-16" aria-hidden="true" tabindex="-1"></a> <span class="fu">imgPlot</span>(<span class="fu">array</span>(<span class="fu">generator</span>(noise)<span class="sc">$</span><span class="fu">numpy</span>(), <span class="fu">c</span>(28L, 28L)), <span class="st">&quot;Gen&quot;</span>)</span>
<span id="cb319-17"><a href="gans-vaes-and-reinforcement-learning.html#cb319-17" aria-hidden="true" tabindex="-1"></a> }</span>
<span id="cb319-18"><a href="gans-vaes-and-reinforcement-learning.html#cb319-18" aria-hidden="true" tabindex="-1"></a> <span class="cf">if</span>(i <span class="sc">%%</span> steps <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb319-19"><a href="gans-vaes-and-reinforcement-learning.html#cb319-19" aria-hidden="true" tabindex="-1"></a> counter <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb319-20"><a href="gans-vaes-and-reinforcement-learning.html#cb319-20" aria-hidden="true" tabindex="-1"></a> <span class="fu">cat</span>(<span class="st">&quot;Gen: &quot;</span>, <span class="fu">mean</span>(gen_loss), <span class="st">&quot; Disc: &quot;</span>, <span class="fu">mean</span>(disc_loss), <span class="st">&quot; </span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb319-21"><a href="gans-vaes-and-reinforcement-learning.html#cb319-21" aria-hidden="true" tabindex="-1"></a> }</span>
<span id="cb319-22"><a href="gans-vaes-and-reinforcement-learning.html#cb319-22" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>The actual training loop:</p>
<ol style="list-style-type: decimal">
<li>Create networks</li>
<li>get batch of images</li>
<li>run train_step function</li>
<li>print losses</li>
<li>repeat step 2-4 for number of epochs</li>
</ol>
</div>
<div id="flower---gan" class="section level3" number="6.1.2">
<h3><span class="header-section-number">6.1.2</span> Flower - GAN</h3>
<div class="sourceCode" id="cb320"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb320-1"><a href="gans-vaes-and-reinforcement-learning.html#cb320-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(keras)</span>
<span id="cb320-2"><a href="gans-vaes-and-reinforcement-learning.html#cb320-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb320-3"><a href="gans-vaes-and-reinforcement-learning.html#cb320-3" aria-hidden="true" tabindex="-1"></a>data_files <span class="ot">=</span> <span class="fu">list.files</span>(<span class="st">&quot;flowers/&quot;</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb320-4"><a href="gans-vaes-and-reinforcement-learning.html#cb320-4" aria-hidden="true" tabindex="-1"></a>train <span class="ot">=</span> data_files[<span class="fu">str_detect</span>(data_files, <span class="st">&quot;train&quot;</span>)]</span>
<span id="cb320-5"><a href="gans-vaes-and-reinforcement-learning.html#cb320-5" aria-hidden="true" tabindex="-1"></a>test <span class="ot">=</span> <span class="fu">readRDS</span>(<span class="at">file =</span> <span class="st">&quot;test.RDS&quot;</span>)</span>
<span id="cb320-6"><a href="gans-vaes-and-reinforcement-learning.html#cb320-6" aria-hidden="true" tabindex="-1"></a>train <span class="ot">=</span> <span class="fu">lapply</span>(train, readRDS)</span>
<span id="cb320-7"><a href="gans-vaes-and-reinforcement-learning.html#cb320-7" aria-hidden="true" tabindex="-1"></a>train <span class="ot">=</span> abind<span class="sc">::</span><span class="fu">abind</span>(train, <span class="at">along =</span> 1L)</span>
<span id="cb320-8"><a href="gans-vaes-and-reinforcement-learning.html#cb320-8" aria-hidden="true" tabindex="-1"></a>train <span class="ot">=</span> tf<span class="sc">$</span><span class="fu">concat</span>(<span class="fu">list</span>(train, test), <span class="at">axis =</span> 0L)<span class="sc">$</span><span class="fu">numpy</span>()</span>
<span id="cb320-9"><a href="gans-vaes-and-reinforcement-learning.html#cb320-9" aria-hidden="true" tabindex="-1"></a>train_x <span class="ot">=</span> <span class="fu">array</span>((train<span class="fl">-127.5</span>)<span class="sc">/</span><span class="fl">127.5</span>, <span class="fu">c</span>(<span class="fu">dim</span>(train)))</span>
<span id="cb320-10"><a href="gans-vaes-and-reinforcement-learning.html#cb320-10" aria-hidden="true" tabindex="-1"></a>get_generator <span class="ot">=</span> <span class="cf">function</span>(){</span>
<span id="cb320-11"><a href="gans-vaes-and-reinforcement-learning.html#cb320-11" aria-hidden="true" tabindex="-1"></a>  generator <span class="ot">=</span> <span class="fu">keras_model_sequential</span>()</span>
<span id="cb320-12"><a href="gans-vaes-and-reinforcement-learning.html#cb320-12" aria-hidden="true" tabindex="-1"></a>  generator <span class="sc">%&gt;%</span> </span>
<span id="cb320-13"><a href="gans-vaes-and-reinforcement-learning.html#cb320-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_dense</span>(<span class="at">units =</span> 20L<span class="sc">*</span>20L<span class="sc">*</span>128L, <span class="at">input_shape =</span> <span class="fu">c</span>(100L), <span class="at">use_bias =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb320-14"><a href="gans-vaes-and-reinforcement-learning.html#cb320-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_activation_leaky_relu</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb320-15"><a href="gans-vaes-and-reinforcement-learning.html#cb320-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_reshape</span>(<span class="fu">c</span>(20L, 20L, 128L)) <span class="sc">%&gt;%</span> </span>
<span id="cb320-16"><a href="gans-vaes-and-reinforcement-learning.html#cb320-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_dropout</span>(<span class="fl">0.3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb320-17"><a href="gans-vaes-and-reinforcement-learning.html#cb320-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_conv_2d_transpose</span>(<span class="at">filters =</span> 256L, <span class="at">kernel_size =</span> <span class="fu">c</span>(3L, 3L), <span class="at">padding =</span> <span class="st">&quot;same&quot;</span>, <span class="at">strides =</span> <span class="fu">c</span>(1L, 1L), <span class="at">use_bias =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb320-18"><a href="gans-vaes-and-reinforcement-learning.html#cb320-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_activation_leaky_relu</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb320-19"><a href="gans-vaes-and-reinforcement-learning.html#cb320-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_dropout</span>(<span class="fl">0.3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb320-20"><a href="gans-vaes-and-reinforcement-learning.html#cb320-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_conv_2d_transpose</span>(<span class="at">filters =</span> 128L, <span class="at">kernel_size =</span> <span class="fu">c</span>(5L, 5L), <span class="at">padding =</span> <span class="st">&quot;same&quot;</span>, <span class="at">strides =</span> <span class="fu">c</span>(1L, 1L), <span class="at">use_bias =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb320-21"><a href="gans-vaes-and-reinforcement-learning.html#cb320-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_activation_leaky_relu</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb320-22"><a href="gans-vaes-and-reinforcement-learning.html#cb320-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_dropout</span>(<span class="fl">0.3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb320-23"><a href="gans-vaes-and-reinforcement-learning.html#cb320-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_conv_2d_transpose</span>(<span class="at">filters =</span> 64L, <span class="at">kernel_size =</span> <span class="fu">c</span>(5L, 5L), <span class="at">padding =</span> <span class="st">&quot;same&quot;</span>, <span class="at">strides =</span> <span class="fu">c</span>(2L, 2L), <span class="at">use_bias =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb320-24"><a href="gans-vaes-and-reinforcement-learning.html#cb320-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_activation_leaky_relu</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb320-25"><a href="gans-vaes-and-reinforcement-learning.html#cb320-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_dropout</span>(<span class="fl">0.3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb320-26"><a href="gans-vaes-and-reinforcement-learning.html#cb320-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_conv_2d_transpose</span>(<span class="at">filters =</span>3L, <span class="at">kernel_size =</span> <span class="fu">c</span>(5L, 5L), <span class="at">padding =</span> <span class="st">&quot;same&quot;</span>, <span class="at">strides =</span> <span class="fu">c</span>(2L, 2L), <span class="at">activation =</span> <span class="st">&quot;tanh&quot;</span>, <span class="at">use_bias =</span> <span class="cn">FALSE</span>)</span>
<span id="cb320-27"><a href="gans-vaes-and-reinforcement-learning.html#cb320-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(generator)</span>
<span id="cb320-28"><a href="gans-vaes-and-reinforcement-learning.html#cb320-28" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb320-29"><a href="gans-vaes-and-reinforcement-learning.html#cb320-29" aria-hidden="true" tabindex="-1"></a>generator <span class="ot">=</span> <span class="fu">get_generator</span>()</span>
<span id="cb320-30"><a href="gans-vaes-and-reinforcement-learning.html#cb320-30" aria-hidden="true" tabindex="-1"></a>image <span class="ot">=</span> <span class="fu">generator</span>(tf<span class="sc">$</span>random<span class="sc">$</span><span class="fu">normal</span>(<span class="fu">c</span>(1L,100L)))<span class="sc">$</span><span class="fu">numpy</span>()[<span class="dv">1</span>,,,]</span>
<span id="cb320-31"><a href="gans-vaes-and-reinforcement-learning.html#cb320-31" aria-hidden="true" tabindex="-1"></a>image <span class="ot">=</span> scales<span class="sc">::</span><span class="fu">rescale</span>(image, <span class="at">to =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">255</span>))</span>
<span id="cb320-32"><a href="gans-vaes-and-reinforcement-learning.html#cb320-32" aria-hidden="true" tabindex="-1"></a>image <span class="sc">%&gt;%</span> </span>
<span id="cb320-33"><a href="gans-vaes-and-reinforcement-learning.html#cb320-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">image_to_array</span>() <span class="sc">%&gt;%</span></span>
<span id="cb320-34"><a href="gans-vaes-and-reinforcement-learning.html#cb320-34" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">/</span><span class="st">`</span>(., <span class="dv">255</span>) <span class="sc">%&gt;%</span></span>
<span id="cb320-35"><a href="gans-vaes-and-reinforcement-learning.html#cb320-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.raster</span>() <span class="sc">%&gt;%</span></span>
<span id="cb320-36"><a href="gans-vaes-and-reinforcement-learning.html#cb320-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>()</span>
<span id="cb320-37"><a href="gans-vaes-and-reinforcement-learning.html#cb320-37" aria-hidden="true" tabindex="-1"></a>get_discriminator <span class="ot">=</span> <span class="cf">function</span>(){</span>
<span id="cb320-38"><a href="gans-vaes-and-reinforcement-learning.html#cb320-38" aria-hidden="true" tabindex="-1"></a>  discriminator <span class="ot">=</span> <span class="fu">keras_model_sequential</span>()</span>
<span id="cb320-39"><a href="gans-vaes-and-reinforcement-learning.html#cb320-39" aria-hidden="true" tabindex="-1"></a>  discriminator <span class="sc">%&gt;%</span> </span>
<span id="cb320-40"><a href="gans-vaes-and-reinforcement-learning.html#cb320-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_conv_2d</span>(<span class="at">filters =</span> 64L, <span class="at">kernel_size =</span> <span class="fu">c</span>(5L, 5L), <span class="at">strides =</span> <span class="fu">c</span>(2L, 2L), <span class="at">padding =</span> <span class="st">&quot;same&quot;</span>, <span class="at">input_shape =</span> <span class="fu">c</span>(80L, 80L, 3L)) <span class="sc">%&gt;%</span></span>
<span id="cb320-41"><a href="gans-vaes-and-reinforcement-learning.html#cb320-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_activation_leaky_relu</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb320-42"><a href="gans-vaes-and-reinforcement-learning.html#cb320-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_dropout</span>(<span class="fl">0.3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb320-43"><a href="gans-vaes-and-reinforcement-learning.html#cb320-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_conv_2d</span>(<span class="at">filters =</span> 128L, <span class="at">kernel_size =</span> <span class="fu">c</span>(5L, 5L), <span class="at">strides =</span> <span class="fu">c</span>(2L, 2L), <span class="at">padding =</span> <span class="st">&quot;same&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb320-44"><a href="gans-vaes-and-reinforcement-learning.html#cb320-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_activation_leaky_relu</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb320-45"><a href="gans-vaes-and-reinforcement-learning.html#cb320-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_dropout</span>(<span class="fl">0.3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb320-46"><a href="gans-vaes-and-reinforcement-learning.html#cb320-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_conv_2d</span>(<span class="at">filters =</span> 256L, <span class="at">kernel_size =</span> <span class="fu">c</span>(3L, 3L), <span class="at">strides =</span> <span class="fu">c</span>(2L, 2L), <span class="at">padding =</span> <span class="st">&quot;same&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb320-47"><a href="gans-vaes-and-reinforcement-learning.html#cb320-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_activation_leaky_relu</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb320-48"><a href="gans-vaes-and-reinforcement-learning.html#cb320-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_dropout</span>(<span class="fl">0.3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb320-49"><a href="gans-vaes-and-reinforcement-learning.html#cb320-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_flatten</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb320-50"><a href="gans-vaes-and-reinforcement-learning.html#cb320-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_dense</span>(<span class="at">units =</span> 1L, <span class="at">activation =</span> <span class="st">&quot;sigmoid&quot;</span>)</span>
<span id="cb320-51"><a href="gans-vaes-and-reinforcement-learning.html#cb320-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(discriminator)</span>
<span id="cb320-52"><a href="gans-vaes-and-reinforcement-learning.html#cb320-52" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb320-53"><a href="gans-vaes-and-reinforcement-learning.html#cb320-53" aria-hidden="true" tabindex="-1"></a>discriminator <span class="ot">=</span> <span class="fu">get_discriminator</span>()</span>
<span id="cb320-54"><a href="gans-vaes-and-reinforcement-learning.html#cb320-54" aria-hidden="true" tabindex="-1"></a>discriminator</span>
<span id="cb320-55"><a href="gans-vaes-and-reinforcement-learning.html#cb320-55" aria-hidden="true" tabindex="-1"></a><span class="fu">discriminator</span>(<span class="fu">generator</span>(tf<span class="sc">$</span>random<span class="sc">$</span><span class="fu">normal</span>(<span class="fu">c</span>(1L, 100L))))</span>
<span id="cb320-56"><a href="gans-vaes-and-reinforcement-learning.html#cb320-56" aria-hidden="true" tabindex="-1"></a>ce <span class="ot">=</span> tf<span class="sc">$</span>keras<span class="sc">$</span>losses<span class="sc">$</span><span class="fu">BinaryCrossentropy</span>(<span class="at">from_logits =</span> <span class="cn">TRUE</span>,<span class="at">label_smoothing =</span> <span class="fl">0.1</span>)</span>
<span id="cb320-57"><a href="gans-vaes-and-reinforcement-learning.html#cb320-57" aria-hidden="true" tabindex="-1"></a>loss_discriminator <span class="ot">=</span> <span class="cf">function</span>(real, fake){</span>
<span id="cb320-58"><a href="gans-vaes-and-reinforcement-learning.html#cb320-58" aria-hidden="true" tabindex="-1"></a>  real_loss <span class="ot">=</span> <span class="fu">ce</span>(tf<span class="sc">$</span><span class="fu">ones_like</span>(real), real)</span>
<span id="cb320-59"><a href="gans-vaes-and-reinforcement-learning.html#cb320-59" aria-hidden="true" tabindex="-1"></a>  fake_loss <span class="ot">=</span> <span class="fu">ce</span>(tf<span class="sc">$</span><span class="fu">zeros_like</span>(fake), fake)</span>
<span id="cb320-60"><a href="gans-vaes-and-reinforcement-learning.html#cb320-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(real_loss<span class="sc">+</span>fake_loss)</span>
<span id="cb320-61"><a href="gans-vaes-and-reinforcement-learning.html#cb320-61" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb320-62"><a href="gans-vaes-and-reinforcement-learning.html#cb320-62" aria-hidden="true" tabindex="-1"></a>loss_generator <span class="ot">=</span> <span class="cf">function</span>(fake){</span>
<span id="cb320-63"><a href="gans-vaes-and-reinforcement-learning.html#cb320-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">ce</span>(tf<span class="sc">$</span><span class="fu">ones_like</span>(fake), fake))</span>
<span id="cb320-64"><a href="gans-vaes-and-reinforcement-learning.html#cb320-64" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb320-65"><a href="gans-vaes-and-reinforcement-learning.html#cb320-65" aria-hidden="true" tabindex="-1"></a>gen_opt <span class="ot">=</span> tf<span class="sc">$</span>keras<span class="sc">$</span>optimizers<span class="sc">$</span><span class="fu">RMSprop</span>(<span class="fl">1e-4</span>)</span>
<span id="cb320-66"><a href="gans-vaes-and-reinforcement-learning.html#cb320-66" aria-hidden="true" tabindex="-1"></a>disc_opt <span class="ot">=</span> tf<span class="sc">$</span>keras<span class="sc">$</span>optimizers<span class="sc">$</span><span class="fu">RMSprop</span>(<span class="fl">1e-4</span>)</span>
<span id="cb320-67"><a href="gans-vaes-and-reinforcement-learning.html#cb320-67" aria-hidden="true" tabindex="-1"></a>batch_size <span class="ot">=</span> 32L</span>
<span id="cb320-68"><a href="gans-vaes-and-reinforcement-learning.html#cb320-68" aria-hidden="true" tabindex="-1"></a>get_batch <span class="ot">=</span> <span class="cf">function</span>(){</span>
<span id="cb320-69"><a href="gans-vaes-and-reinforcement-learning.html#cb320-69" aria-hidden="true" tabindex="-1"></a>  indices <span class="ot">=</span> <span class="fu">sample.int</span>(<span class="fu">nrow</span>(train_x), batch_size)</span>
<span id="cb320-70"><a href="gans-vaes-and-reinforcement-learning.html#cb320-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(tf<span class="sc">$</span><span class="fu">constant</span>(train_x[indices,,,,<span class="at">drop=</span><span class="cn">FALSE</span>], <span class="st">&quot;float32&quot;</span>))</span>
<span id="cb320-71"><a href="gans-vaes-and-reinforcement-learning.html#cb320-71" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb320-72"><a href="gans-vaes-and-reinforcement-learning.html#cb320-72" aria-hidden="true" tabindex="-1"></a>train_step <span class="ot">=</span> <span class="cf">function</span>(images){</span>
<span id="cb320-73"><a href="gans-vaes-and-reinforcement-learning.html#cb320-73" aria-hidden="true" tabindex="-1"></a>  noise <span class="ot">=</span> tf<span class="sc">$</span>random<span class="sc">$</span><span class="fu">normal</span>(<span class="fu">c</span>(32L, 100L))</span>
<span id="cb320-74"><a href="gans-vaes-and-reinforcement-learning.html#cb320-74" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb320-75"><a href="gans-vaes-and-reinforcement-learning.html#cb320-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">with</span>(tf<span class="sc">$</span><span class="fu">GradientTape</span>(<span class="at">persistent =</span> <span class="cn">TRUE</span>) <span class="sc">%as%</span> tape,{</span>
<span id="cb320-76"><a href="gans-vaes-and-reinforcement-learning.html#cb320-76" aria-hidden="true" tabindex="-1"></a>    gen_images <span class="ot">=</span> <span class="fu">generator</span>(noise)</span>
<span id="cb320-77"><a href="gans-vaes-and-reinforcement-learning.html#cb320-77" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb320-78"><a href="gans-vaes-and-reinforcement-learning.html#cb320-78" aria-hidden="true" tabindex="-1"></a>    real_output <span class="ot">=</span> <span class="fu">discriminator</span>(images)</span>
<span id="cb320-79"><a href="gans-vaes-and-reinforcement-learning.html#cb320-79" aria-hidden="true" tabindex="-1"></a>    fake_output <span class="ot">=</span> <span class="fu">discriminator</span>(gen_images)</span>
<span id="cb320-80"><a href="gans-vaes-and-reinforcement-learning.html#cb320-80" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb320-81"><a href="gans-vaes-and-reinforcement-learning.html#cb320-81" aria-hidden="true" tabindex="-1"></a>    gen_loss <span class="ot">=</span> <span class="fu">loss_generator</span>(fake_output)</span>
<span id="cb320-82"><a href="gans-vaes-and-reinforcement-learning.html#cb320-82" aria-hidden="true" tabindex="-1"></a>    disc_loss <span class="ot">=</span> <span class="fu">loss_discriminator</span>(real_output, fake_output)</span>
<span id="cb320-83"><a href="gans-vaes-and-reinforcement-learning.html#cb320-83" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb320-84"><a href="gans-vaes-and-reinforcement-learning.html#cb320-84" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb320-85"><a href="gans-vaes-and-reinforcement-learning.html#cb320-85" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb320-86"><a href="gans-vaes-and-reinforcement-learning.html#cb320-86" aria-hidden="true" tabindex="-1"></a>  gen_grads <span class="ot">=</span> tape<span class="sc">$</span><span class="fu">gradient</span>(gen_loss, generator<span class="sc">$</span>weights)</span>
<span id="cb320-87"><a href="gans-vaes-and-reinforcement-learning.html#cb320-87" aria-hidden="true" tabindex="-1"></a>  disc_grads <span class="ot">=</span> tape<span class="sc">$</span><span class="fu">gradient</span>(disc_loss, discriminator<span class="sc">$</span>weights)</span>
<span id="cb320-88"><a href="gans-vaes-and-reinforcement-learning.html#cb320-88" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(tape)</span>
<span id="cb320-89"><a href="gans-vaes-and-reinforcement-learning.html#cb320-89" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb320-90"><a href="gans-vaes-and-reinforcement-learning.html#cb320-90" aria-hidden="true" tabindex="-1"></a>  gen_opt<span class="sc">$</span><span class="fu">apply_gradients</span>(purrr<span class="sc">::</span><span class="fu">transpose</span>(<span class="fu">list</span>(gen_grads, generator<span class="sc">$</span>weights)))</span>
<span id="cb320-91"><a href="gans-vaes-and-reinforcement-learning.html#cb320-91" aria-hidden="true" tabindex="-1"></a>  disc_opt<span class="sc">$</span><span class="fu">apply_gradients</span>(purrr<span class="sc">::</span><span class="fu">transpose</span>(<span class="fu">list</span>(disc_grads, discriminator<span class="sc">$</span>weights)))</span>
<span id="cb320-92"><a href="gans-vaes-and-reinforcement-learning.html#cb320-92" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb320-93"><a href="gans-vaes-and-reinforcement-learning.html#cb320-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">c</span>(gen_loss, disc_loss))</span>
<span id="cb320-94"><a href="gans-vaes-and-reinforcement-learning.html#cb320-94" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb320-95"><a href="gans-vaes-and-reinforcement-learning.html#cb320-95" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb320-96"><a href="gans-vaes-and-reinforcement-learning.html#cb320-96" aria-hidden="true" tabindex="-1"></a>train_step <span class="ot">=</span> tf<span class="sc">$</span><span class="st">`</span><span class="at">function</span><span class="st">`</span>(reticulate<span class="sc">::</span><span class="fu">py_func</span>(train_step))</span>
<span id="cb320-97"><a href="gans-vaes-and-reinforcement-learning.html#cb320-97" aria-hidden="true" tabindex="-1"></a>epochs <span class="ot">=</span> 10L</span>
<span id="cb320-98"><a href="gans-vaes-and-reinforcement-learning.html#cb320-98" aria-hidden="true" tabindex="-1"></a>steps <span class="ot">=</span> <span class="fu">as.integer</span>(<span class="fu">nrow</span>(train_x)<span class="sc">/</span>batch_size)</span>
<span id="cb320-99"><a href="gans-vaes-and-reinforcement-learning.html#cb320-99" aria-hidden="true" tabindex="-1"></a>counter <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb320-100"><a href="gans-vaes-and-reinforcement-learning.html#cb320-100" aria-hidden="true" tabindex="-1"></a>gen_loss <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb320-101"><a href="gans-vaes-and-reinforcement-learning.html#cb320-101" aria-hidden="true" tabindex="-1"></a>disc_loss <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb320-102"><a href="gans-vaes-and-reinforcement-learning.html#cb320-102" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(epochs<span class="sc">*</span>steps)){</span>
<span id="cb320-103"><a href="gans-vaes-and-reinforcement-learning.html#cb320-103" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb320-104"><a href="gans-vaes-and-reinforcement-learning.html#cb320-104" aria-hidden="true" tabindex="-1"></a>  images <span class="ot">=</span> <span class="fu">get_batch</span>()</span>
<span id="cb320-105"><a href="gans-vaes-and-reinforcement-learning.html#cb320-105" aria-hidden="true" tabindex="-1"></a>  losses <span class="ot">=</span> <span class="fu">train_step</span>(images)</span>
<span id="cb320-106"><a href="gans-vaes-and-reinforcement-learning.html#cb320-106" aria-hidden="true" tabindex="-1"></a>  gen_loss[counter] <span class="ot">=</span> tf<span class="sc">$</span><span class="fu">reduce_sum</span>(losses[[<span class="dv">1</span>]])<span class="sc">$</span><span class="fu">numpy</span>()</span>
<span id="cb320-107"><a href="gans-vaes-and-reinforcement-learning.html#cb320-107" aria-hidden="true" tabindex="-1"></a>  disc_loss[counter] <span class="ot">=</span> tf<span class="sc">$</span><span class="fu">reduce_sum</span>(losses[[<span class="dv">2</span>]])<span class="sc">$</span><span class="fu">numpy</span>()</span>
<span id="cb320-108"><a href="gans-vaes-and-reinforcement-learning.html#cb320-108" aria-hidden="true" tabindex="-1"></a>  counter <span class="ot">=</span> counter<span class="sc">+</span><span class="dv">1</span></span>
<span id="cb320-109"><a href="gans-vaes-and-reinforcement-learning.html#cb320-109" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(i <span class="sc">%%</span> <span class="dv">10</span><span class="sc">*</span>steps <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb320-110"><a href="gans-vaes-and-reinforcement-learning.html#cb320-110" aria-hidden="true" tabindex="-1"></a>    noise <span class="ot">=</span> tf<span class="sc">$</span>random<span class="sc">$</span><span class="fu">normal</span>(<span class="fu">c</span>(1L, 100L))</span>
<span id="cb320-111"><a href="gans-vaes-and-reinforcement-learning.html#cb320-111" aria-hidden="true" tabindex="-1"></a>    image <span class="ot">=</span> <span class="fu">generator</span>(noise)<span class="sc">$</span><span class="fu">numpy</span>()[<span class="dv">1</span>,,,]</span>
<span id="cb320-112"><a href="gans-vaes-and-reinforcement-learning.html#cb320-112" aria-hidden="true" tabindex="-1"></a>    image <span class="ot">=</span> scales<span class="sc">::</span><span class="fu">rescale</span>(image, <span class="at">to =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">255</span>))</span>
<span id="cb320-113"><a href="gans-vaes-and-reinforcement-learning.html#cb320-113" aria-hidden="true" tabindex="-1"></a>    image <span class="sc">%&gt;%</span> </span>
<span id="cb320-114"><a href="gans-vaes-and-reinforcement-learning.html#cb320-114" aria-hidden="true" tabindex="-1"></a>      <span class="fu">image_to_array</span>() <span class="sc">%&gt;%</span></span>
<span id="cb320-115"><a href="gans-vaes-and-reinforcement-learning.html#cb320-115" aria-hidden="true" tabindex="-1"></a>      <span class="st">`</span><span class="at">/</span><span class="st">`</span>(., <span class="dv">255</span>) <span class="sc">%&gt;%</span></span>
<span id="cb320-116"><a href="gans-vaes-and-reinforcement-learning.html#cb320-116" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.raster</span>() <span class="sc">%&gt;%</span></span>
<span id="cb320-117"><a href="gans-vaes-and-reinforcement-learning.html#cb320-117" aria-hidden="true" tabindex="-1"></a>      <span class="fu">plot</span>()</span>
<span id="cb320-118"><a href="gans-vaes-and-reinforcement-learning.html#cb320-118" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb320-119"><a href="gans-vaes-and-reinforcement-learning.html#cb320-119" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(i <span class="sc">%%</span> steps <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb320-120"><a href="gans-vaes-and-reinforcement-learning.html#cb320-120" aria-hidden="true" tabindex="-1"></a>    counter <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb320-121"><a href="gans-vaes-and-reinforcement-learning.html#cb320-121" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">&quot;Gen: &quot;</span>, <span class="fu">mean</span>(gen_loss), <span class="st">&quot; Disc: &quot;</span>, <span class="fu">mean</span>(disc_loss), <span class="st">&quot; </span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb320-122"><a href="gans-vaes-and-reinforcement-learning.html#cb320-122" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb320-123"><a href="gans-vaes-and-reinforcement-learning.html#cb320-123" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb320-124"><a href="gans-vaes-and-reinforcement-learning.html#cb320-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb320-125"><a href="gans-vaes-and-reinforcement-learning.html#cb320-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb320-126"><a href="gans-vaes-and-reinforcement-learning.html#cb320-126" aria-hidden="true" tabindex="-1"></a>results <span class="ot">=</span> <span class="fu">vector</span>(<span class="st">&quot;list&quot;</span>, 100L)</span>
<span id="cb320-127"><a href="gans-vaes-and-reinforcement-learning.html#cb320-127" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>) {</span>
<span id="cb320-128"><a href="gans-vaes-and-reinforcement-learning.html#cb320-128" aria-hidden="true" tabindex="-1"></a>  noise <span class="ot">=</span> tf<span class="sc">$</span>random<span class="sc">$</span><span class="fu">normal</span>(<span class="fu">c</span>(1L, 100L))</span>
<span id="cb320-129"><a href="gans-vaes-and-reinforcement-learning.html#cb320-129" aria-hidden="true" tabindex="-1"></a>  image <span class="ot">=</span> <span class="fu">generator</span>(noise)<span class="sc">$</span><span class="fu">numpy</span>()[<span class="dv">1</span>,,,]</span>
<span id="cb320-130"><a href="gans-vaes-and-reinforcement-learning.html#cb320-130" aria-hidden="true" tabindex="-1"></a>  image <span class="ot">=</span> scales<span class="sc">::</span><span class="fu">rescale</span>(image, <span class="at">to =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">255</span>))</span>
<span id="cb320-131"><a href="gans-vaes-and-reinforcement-learning.html#cb320-131" aria-hidden="true" tabindex="-1"></a>  image <span class="sc">%&gt;%</span> </span>
<span id="cb320-132"><a href="gans-vaes-and-reinforcement-learning.html#cb320-132" aria-hidden="true" tabindex="-1"></a>    <span class="fu">image_to_array</span>() <span class="sc">%&gt;%</span></span>
<span id="cb320-133"><a href="gans-vaes-and-reinforcement-learning.html#cb320-133" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">/</span><span class="st">`</span>(., <span class="dv">255</span>) <span class="sc">%&gt;%</span></span>
<span id="cb320-134"><a href="gans-vaes-and-reinforcement-learning.html#cb320-134" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.raster</span>() <span class="sc">%&gt;%</span></span>
<span id="cb320-135"><a href="gans-vaes-and-reinforcement-learning.html#cb320-135" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>()</span>
<span id="cb320-136"><a href="gans-vaes-and-reinforcement-learning.html#cb320-136" aria-hidden="true" tabindex="-1"></a>  results[[i]] <span class="ot">=</span> image</span>
<span id="cb320-137"><a href="gans-vaes-and-reinforcement-learning.html#cb320-137" aria-hidden="true" tabindex="-1"></a>  imager<span class="sc">::</span><span class="fu">save.image</span>(imager<span class="sc">::</span><span class="fu">as.cimg</span>(image),<span class="at">quality =</span> <span class="fl">1.0</span>,<span class="at">file =</span> <span class="fu">paste0</span>(<span class="st">&quot;images/flower&quot;</span>,i, <span class="st">&quot;.png&quot;</span>))</span>
<span id="cb320-138"><a href="gans-vaes-and-reinforcement-learning.html#cb320-138" aria-hidden="true" tabindex="-1"></a>  imager<span class="sc">::</span><span class="fu">as.cimg</span>(image)</span>
<span id="cb320-139"><a href="gans-vaes-and-reinforcement-learning.html#cb320-139" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb320-140"><a href="gans-vaes-and-reinforcement-learning.html#cb320-140" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(abind<span class="sc">::</span><span class="fu">abind</span>(results, <span class="at">along =</span> 0L), <span class="at">file =</span> <span class="st">&quot;images/result.RDS&quot;</span>)</span></code></pre></div>
<p><img src="images/flower2.png" width="300%" height="300%" /><img src="images/flower3.png" width="300%" height="300%" /><img src="images/flower4.png" width="300%" height="300%" /><img src="images/flower5.png" width="300%" height="300%" /></p>
</div>
</div>
<div id="autoencoder" class="section level2" number="6.2">
<h2><span class="header-section-number">6.2</span> Autoencoder</h2>
<p>An autoencoder is a type of artificial neural network used to learn efficient data codings in an unsupervised manner. The aim of an autoencoder is to learn a representation (encoding) for a set of data, typically for dimensionality reduction, by training the network to ignore signal “noise”.
### Autoencoder - DNN MNIST
Autoencoders consist of Encoder and a Decoder Networks.</p>
<p>The encoder will compress the data into 2 dimensions and the decoder will reconstruct the original data:</p>
<div class="sourceCode" id="cb321"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb321-1"><a href="gans-vaes-and-reinforcement-learning.html#cb321-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(keras)</span>
<span id="cb321-2"><a href="gans-vaes-and-reinforcement-learning.html#cb321-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tensorflow)</span>
<span id="cb321-3"><a href="gans-vaes-and-reinforcement-learning.html#cb321-3" aria-hidden="true" tabindex="-1"></a>rotate <span class="ot">=</span> <span class="cf">function</span>(x) <span class="fu">t</span>(<span class="fu">apply</span>(x, <span class="dv">2</span>, rev))</span>
<span id="cb321-4"><a href="gans-vaes-and-reinforcement-learning.html#cb321-4" aria-hidden="true" tabindex="-1"></a>imgPlot <span class="ot">=</span> <span class="cf">function</span>(img, <span class="at">title =</span> <span class="st">&quot;&quot;</span>){</span>
<span id="cb321-5"><a href="gans-vaes-and-reinforcement-learning.html#cb321-5" aria-hidden="true" tabindex="-1"></a> col<span class="ot">=</span><span class="fu">grey.colors</span>(<span class="dv">255</span>)</span>
<span id="cb321-6"><a href="gans-vaes-and-reinforcement-learning.html#cb321-6" aria-hidden="true" tabindex="-1"></a> <span class="fu">image</span>(<span class="fu">rotate</span>(img), <span class="at">col =</span> col, <span class="at">xlab =</span> <span class="st">&quot;&quot;</span>, <span class="at">ylab =</span> <span class="st">&quot;&quot;</span>, <span class="at">axes=</span><span class="cn">FALSE</span>, <span class="at">main =</span> <span class="fu">paste0</span>(<span class="st">&quot;Label: &quot;</span>, <span class="fu">as.character</span>(title)))</span>
<span id="cb321-7"><a href="gans-vaes-and-reinforcement-learning.html#cb321-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb321-8"><a href="gans-vaes-and-reinforcement-learning.html#cb321-8" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> tf<span class="sc">$</span>keras<span class="sc">$</span>datasets<span class="sc">$</span>mnist<span class="sc">$</span><span class="fu">load_data</span>()</span>
<span id="cb321-9"><a href="gans-vaes-and-reinforcement-learning.html#cb321-9" aria-hidden="true" tabindex="-1"></a>train <span class="ot">=</span> data[[<span class="dv">1</span>]]</span>
<span id="cb321-10"><a href="gans-vaes-and-reinforcement-learning.html#cb321-10" aria-hidden="true" tabindex="-1"></a>train_x <span class="ot">=</span> <span class="fu">array</span>(train[[<span class="dv">1</span>]]<span class="sc">/</span><span class="dv">255</span>, <span class="fu">c</span>(<span class="fu">dim</span>(train[[<span class="dv">1</span>]])[<span class="dv">1</span>], 784L))</span>
<span id="cb321-11"><a href="gans-vaes-and-reinforcement-learning.html#cb321-11" aria-hidden="true" tabindex="-1"></a>test_x <span class="ot">=</span> <span class="fu">array</span>(test[[<span class="dv">1</span>]]<span class="sc">/</span><span class="dv">255</span>, <span class="fu">c</span>(<span class="fu">dim</span>(test[[<span class="dv">1</span>]])[<span class="dv">1</span>], 784L))</span>
<span id="cb321-12"><a href="gans-vaes-and-reinforcement-learning.html#cb321-12" aria-hidden="true" tabindex="-1"></a><span class="do">## Dense autoencoder</span></span>
<span id="cb321-13"><a href="gans-vaes-and-reinforcement-learning.html#cb321-13" aria-hidden="true" tabindex="-1"></a><span class="do">### Inputs will be compromized to two dimensions</span></span>
<span id="cb321-14"><a href="gans-vaes-and-reinforcement-learning.html#cb321-14" aria-hidden="true" tabindex="-1"></a>down_size_model <span class="ot">=</span> <span class="fu">keras_model_sequential</span>()</span>
<span id="cb321-15"><a href="gans-vaes-and-reinforcement-learning.html#cb321-15" aria-hidden="true" tabindex="-1"></a>down_size_model <span class="sc">%&gt;%</span> </span>
<span id="cb321-16"><a href="gans-vaes-and-reinforcement-learning.html#cb321-16" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_dense</span>(<span class="at">units =</span> 100L, <span class="at">input_shape =</span> <span class="fu">c</span>(784L),<span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb321-17"><a href="gans-vaes-and-reinforcement-learning.html#cb321-17" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_dense</span>(<span class="at">units =</span> 20L, <span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb321-18"><a href="gans-vaes-and-reinforcement-learning.html#cb321-18" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_dense</span>(<span class="at">units =</span> 2L, <span class="at">activation =</span> <span class="st">&quot;linear&quot;</span>)</span>
<span id="cb321-19"><a href="gans-vaes-and-reinforcement-learning.html#cb321-19" aria-hidden="true" tabindex="-1"></a><span class="do">### Reconstruction of the images</span></span>
<span id="cb321-20"><a href="gans-vaes-and-reinforcement-learning.html#cb321-20" aria-hidden="true" tabindex="-1"></a>up_size_model <span class="ot">=</span> <span class="fu">keras_model_sequential</span>()</span>
<span id="cb321-21"><a href="gans-vaes-and-reinforcement-learning.html#cb321-21" aria-hidden="true" tabindex="-1"></a>up_size_model <span class="sc">%&gt;%</span> </span>
<span id="cb321-22"><a href="gans-vaes-and-reinforcement-learning.html#cb321-22" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_dense</span>(<span class="at">units =</span> 20L, <span class="at">input_shape =</span> <span class="fu">c</span>(2L), <span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb321-23"><a href="gans-vaes-and-reinforcement-learning.html#cb321-23" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_dense</span>(<span class="at">units =</span> 100L, <span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb321-24"><a href="gans-vaes-and-reinforcement-learning.html#cb321-24" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_dense</span>(<span class="at">units =</span> 784L, <span class="at">activation =</span> <span class="st">&quot;sigmoid&quot;</span>)</span>
<span id="cb321-25"><a href="gans-vaes-and-reinforcement-learning.html#cb321-25" aria-hidden="true" tabindex="-1"></a><span class="do">### Combine models into one</span></span>
<span id="cb321-26"><a href="gans-vaes-and-reinforcement-learning.html#cb321-26" aria-hidden="true" tabindex="-1"></a>autoencoder <span class="ot">=</span> tf<span class="sc">$</span>keras<span class="sc">$</span>models<span class="sc">$</span><span class="fu">Model</span>(<span class="at">inputs=</span>down_size_model<span class="sc">$</span>input,  <span class="at">outputs=</span><span class="fu">up_size_model</span>(down_size_model<span class="sc">$</span>output))</span>
<span id="cb321-27"><a href="gans-vaes-and-reinforcement-learning.html#cb321-27" aria-hidden="true" tabindex="-1"></a>autoencoder<span class="sc">$</span><span class="fu">compile</span>(<span class="at">loss =</span> loss_binary_crossentropy, <span class="at">optimizer =</span> <span class="fu">optimizer_adamax</span>(<span class="fl">0.01</span>))</span>
<span id="cb321-28"><a href="gans-vaes-and-reinforcement-learning.html#cb321-28" aria-hidden="true" tabindex="-1"></a>image <span class="ot">=</span> <span class="fu">autoencoder</span>(train_x[<span class="dv">1</span>,,<span class="at">drop =</span> <span class="cn">FALSE</span>])<span class="sc">$</span><span class="fu">numpy</span>()</span>
<span id="cb321-29"><a href="gans-vaes-and-reinforcement-learning.html#cb321-29" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb321-30"><a href="gans-vaes-and-reinforcement-learning.html#cb321-30" aria-hidden="true" tabindex="-1"></a><span class="fu">imgPlot</span>(<span class="fu">array</span>(train_x[<span class="dv">1</span>,,<span class="at">drop =</span> <span class="cn">FALSE</span>], <span class="fu">c</span>(<span class="dv">28</span>, <span class="dv">28</span>)))</span>
<span id="cb321-31"><a href="gans-vaes-and-reinforcement-learning.html#cb321-31" aria-hidden="true" tabindex="-1"></a><span class="fu">imgPlot</span>(<span class="fu">array</span>(image, <span class="fu">c</span>(<span class="dv">28</span>, <span class="dv">28</span>)))</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-162-1.png" width="672" /></p>
<div class="sourceCode" id="cb322"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb322-1"><a href="gans-vaes-and-reinforcement-learning.html#cb322-1" aria-hidden="true" tabindex="-1"></a>autoencoder<span class="sc">$</span><span class="fu">fit</span>(<span class="at">x =</span> tf<span class="sc">$</span><span class="fu">constant</span>(train_x), <span class="at">y =</span> tf<span class="sc">$</span><span class="fu">constant</span>(train_x), <span class="at">epochs =</span> 5L, <span class="at">batch_size =</span> 32L)</span></code></pre></div>
<pre><code>## &lt;tensorflow.python.keras.callbacks.History&gt;</code></pre>
<p>After training:</p>
<div class="sourceCode" id="cb324"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb324-1"><a href="gans-vaes-and-reinforcement-learning.html#cb324-1" aria-hidden="true" tabindex="-1"></a>pred_dim <span class="ot">=</span> <span class="fu">down_size_model</span>(test_x)</span>
<span id="cb324-2"><a href="gans-vaes-and-reinforcement-learning.html#cb324-2" aria-hidden="true" tabindex="-1"></a>reconstr_pred <span class="ot">=</span> <span class="fu">autoencoder</span>(test_x)</span>
<span id="cb324-3"><a href="gans-vaes-and-reinforcement-learning.html#cb324-3" aria-hidden="true" tabindex="-1"></a><span class="fu">imgPlot</span>(<span class="fu">array</span>(reconstr_pred[<span class="dv">10</span>,]<span class="sc">$</span><span class="fu">numpy</span>(), <span class="at">dim =</span> <span class="fu">c</span>(28L, 28L)))</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-163-1.png" width="672" /></p>
<div class="sourceCode" id="cb325"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb325-1"><a href="gans-vaes-and-reinforcement-learning.html#cb325-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb325-2"><a href="gans-vaes-and-reinforcement-learning.html#cb325-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pred_dim<span class="sc">$</span><span class="fu">numpy</span>()[,<span class="dv">1</span>], pred_dim<span class="sc">$</span><span class="fu">numpy</span>()[,<span class="dv">2</span>], <span class="at">col =</span> test[[<span class="dv">2</span>]]<span class="sc">+</span>1L)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-163-2.png" width="672" /></p>
<div id="autoencoder---mnist-cnn" class="section level3" number="6.2.1">
<h3><span class="header-section-number">6.2.1</span> Autoencoder - MNIST CNN</h3>
<p>We can also use CNNs isntead of DNNs. There is also an inverse convolutional layer:</p>
<div class="sourceCode" id="cb326"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb326-1"><a href="gans-vaes-and-reinforcement-learning.html#cb326-1" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> tf<span class="sc">$</span>keras<span class="sc">$</span>datasets<span class="sc">$</span>mnist<span class="sc">$</span><span class="fu">load_data</span>()</span>
<span id="cb326-2"><a href="gans-vaes-and-reinforcement-learning.html#cb326-2" aria-hidden="true" tabindex="-1"></a>train <span class="ot">=</span> data[[<span class="dv">1</span>]]</span>
<span id="cb326-3"><a href="gans-vaes-and-reinforcement-learning.html#cb326-3" aria-hidden="true" tabindex="-1"></a>train_x <span class="ot">=</span> <span class="fu">array</span>(train[[<span class="dv">1</span>]]<span class="sc">/</span><span class="dv">255</span>, <span class="fu">c</span>(<span class="fu">dim</span>(train[[<span class="dv">1</span>]]), 1L))</span>
<span id="cb326-4"><a href="gans-vaes-and-reinforcement-learning.html#cb326-4" aria-hidden="true" tabindex="-1"></a>test_x <span class="ot">=</span> <span class="fu">array</span>(data[[<span class="dv">2</span>]][[<span class="dv">1</span><span class="sc">/</span><span class="dv">255</span><span class="sc">/</span><span class="dv">255</span>, <span class="fu">c</span>(<span class="fu">dim</span>(data[[<span class="dv">2</span>]][[<span class="dv">1</span><span class="sc">/</span><span class="dv">255</span>), 1L))</span>
<span id="cb326-5"><a href="gans-vaes-and-reinforcement-learning.html#cb326-5" aria-hidden="true" tabindex="-1"></a>down_size_model <span class="ot">=</span> <span class="fu">keras_model_sequential</span>()</span>
<span id="cb326-6"><a href="gans-vaes-and-reinforcement-learning.html#cb326-6" aria-hidden="true" tabindex="-1"></a>down_size_model <span class="sc">%&gt;%</span> </span>
<span id="cb326-7"><a href="gans-vaes-and-reinforcement-learning.html#cb326-7" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_conv_2d</span>(<span class="at">filters =</span> 32L, <span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>, <span class="at">kernel_size =</span> <span class="fu">c</span>(2L,2L), </span>
<span id="cb326-8"><a href="gans-vaes-and-reinforcement-learning.html#cb326-8" aria-hidden="true" tabindex="-1"></a>                          <span class="at">input_shape =</span> <span class="fu">c</span>(28L, 28L, 1L), <span class="at">strides =</span> <span class="fu">c</span>(4L, 4L)) <span class="sc">%&gt;%</span> </span>
<span id="cb326-9"><a href="gans-vaes-and-reinforcement-learning.html#cb326-9" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_conv_2d</span>(<span class="at">filters =</span> 16L, <span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>, </span>
<span id="cb326-10"><a href="gans-vaes-and-reinforcement-learning.html#cb326-10" aria-hidden="true" tabindex="-1"></a>                           <span class="at">kernel_size =</span> <span class="fu">c</span>(7L,7L), <span class="at">strides =</span> <span class="fu">c</span>(1L, 1L)) <span class="sc">%&gt;%</span> </span>
<span id="cb326-11"><a href="gans-vaes-and-reinforcement-learning.html#cb326-11" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_flatten</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb326-12"><a href="gans-vaes-and-reinforcement-learning.html#cb326-12" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_dense</span>(<span class="at">units =</span> 2L, <span class="at">activation =</span> <span class="st">&quot;linear&quot;</span>)</span>
<span id="cb326-13"><a href="gans-vaes-and-reinforcement-learning.html#cb326-13" aria-hidden="true" tabindex="-1"></a>up_size_model <span class="ot">=</span> <span class="fu">keras_model_sequential</span>()</span>
<span id="cb326-14"><a href="gans-vaes-and-reinforcement-learning.html#cb326-14" aria-hidden="true" tabindex="-1"></a>up_size_model <span class="sc">%&gt;%</span> </span>
<span id="cb326-15"><a href="gans-vaes-and-reinforcement-learning.html#cb326-15" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_dense</span>(<span class="at">units =</span> 8L, <span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>, <span class="at">input_shape =</span> <span class="fu">c</span>(2L)) <span class="sc">%&gt;%</span> </span>
<span id="cb326-16"><a href="gans-vaes-and-reinforcement-learning.html#cb326-16" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_reshape</span>(<span class="at">target_shape =</span> <span class="fu">c</span>(1L, 1L, 8L)) <span class="sc">%&gt;%</span> </span>
<span id="cb326-17"><a href="gans-vaes-and-reinforcement-learning.html#cb326-17" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_conv_2d_transpose</span>(<span class="at">filters =</span> 16L, <span class="at">kernel_size =</span> <span class="fu">c</span>(<span class="dv">7</span>,<span class="dv">7</span>), <span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>, <span class="at">strides =</span> <span class="fu">c</span>(1L,1L)) <span class="sc">%&gt;%</span> </span>
<span id="cb326-18"><a href="gans-vaes-and-reinforcement-learning.html#cb326-18" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_conv_2d_transpose</span>(<span class="at">filters =</span> 32L, <span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>, <span class="at">kernel_size =</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>), <span class="at">strides =</span> <span class="fu">c</span>(4L,4L)) <span class="sc">%&gt;%</span> </span>
<span id="cb326-19"><a href="gans-vaes-and-reinforcement-learning.html#cb326-19" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_conv_2d</span>(<span class="at">filters =</span> <span class="dv">1</span>, <span class="at">kernel_size =</span> <span class="fu">c</span>(1L, 1L), <span class="at">strides =</span> <span class="fu">c</span>(1L, 1L), <span class="at">activation =</span> <span class="st">&quot;sigmoid&quot;</span>)</span>
<span id="cb326-20"><a href="gans-vaes-and-reinforcement-learning.html#cb326-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb326-21"><a href="gans-vaes-and-reinforcement-learning.html#cb326-21" aria-hidden="true" tabindex="-1"></a>autoencoder <span class="ot">=</span> tf<span class="sc">$</span>keras<span class="sc">$</span>models<span class="sc">$</span><span class="fu">Model</span>(<span class="at">inputs =</span> down_size_model<span class="sc">$</span>input, <span class="at">outputs =</span> <span class="fu">up_size_model</span>(down_size_model<span class="sc">$</span>output))</span>
<span id="cb326-22"><a href="gans-vaes-and-reinforcement-learning.html#cb326-22" aria-hidden="true" tabindex="-1"></a>autoencoder<span class="sc">$</span><span class="fu">compile</span>(<span class="at">loss =</span> loss_binary_crossentropy, <span class="at">optimizer =</span> <span class="fu">optimizer_rmsprop</span>(<span class="fl">0.001</span>))</span>
<span id="cb326-23"><a href="gans-vaes-and-reinforcement-learning.html#cb326-23" aria-hidden="true" tabindex="-1"></a>autoencoder<span class="sc">$</span><span class="fu">fit</span>(<span class="at">x =</span> tf<span class="sc">$</span><span class="fu">constant</span>(train_x), <span class="at">y =</span> tf<span class="sc">$</span><span class="fu">constant</span>(train_x), <span class="at">epochs =</span> 1L, <span class="at">batch_size =</span> 64L)</span>
<span id="cb326-24"><a href="gans-vaes-and-reinforcement-learning.html#cb326-24" aria-hidden="true" tabindex="-1"></a>pred_dim <span class="ot">=</span> <span class="fu">down_size_model</span>(tf<span class="sc">$</span><span class="fu">constant</span>(test_x, <span class="st">&quot;float32&quot;</span>))</span>
<span id="cb326-25"><a href="gans-vaes-and-reinforcement-learning.html#cb326-25" aria-hidden="true" tabindex="-1"></a>reconstr_pred <span class="ot">=</span> <span class="fu">autoencoder</span>(tf<span class="sc">$</span><span class="fu">constant</span>(test_x, <span class="st">&quot;float32&quot;</span>))</span>
<span id="cb326-26"><a href="gans-vaes-and-reinforcement-learning.html#cb326-26" aria-hidden="true" tabindex="-1"></a><span class="fu">imgPlot</span>(reconstr_pred[<span class="dv">10</span>,,,]<span class="sc">$</span><span class="fu">numpy</span>()[,,<span class="dv">1</span>])</span>
<span id="cb326-27"><a href="gans-vaes-and-reinforcement-learning.html#cb326-27" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pred_dim[,<span class="dv">1</span>]<span class="sc">$</span><span class="fu">numpy</span>(), pred_dim[,<span class="dv">2</span>]<span class="sc">$</span><span class="fu">numpy</span>(), <span class="at">col =</span> test[[<span class="dv">2</span>]]<span class="sc">+</span>1L)</span>
<span id="cb326-28"><a href="gans-vaes-and-reinforcement-learning.html#cb326-28" aria-hidden="true" tabindex="-1"></a><span class="do">## Generate new images!</span></span>
<span id="cb326-29"><a href="gans-vaes-and-reinforcement-learning.html#cb326-29" aria-hidden="true" tabindex="-1"></a>new <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">10</span>,<span class="dv">10</span>), <span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb326-30"><a href="gans-vaes-and-reinforcement-learning.html#cb326-30" aria-hidden="true" tabindex="-1"></a><span class="fu">imgPlot</span>(<span class="fu">array</span>(<span class="fu">up_size_model</span>(new)<span class="sc">$</span><span class="fu">numpy</span>(), <span class="fu">c</span>(28L, 28L)))</span></code></pre></div>
</div>
</div>
<div id="varational-autoencoder" class="section level2" number="6.3">
<h2><span class="header-section-number">6.3</span> Varational Autoencoder</h2>
<p>The difference to normal autoencoder is that we here try to fit latent variables which encode the images:</p>
<div class="sourceCode" id="cb327"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb327-1"><a href="gans-vaes-and-reinforcement-learning.html#cb327-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tensorflow_probability)</span>
<span id="cb327-2"><a href="gans-vaes-and-reinforcement-learning.html#cb327-2" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> tf<span class="sc">$</span>keras<span class="sc">$</span>datasets<span class="sc">$</span>mnist<span class="sc">$</span><span class="fu">load_data</span>()</span>
<span id="cb327-3"><a href="gans-vaes-and-reinforcement-learning.html#cb327-3" aria-hidden="true" tabindex="-1"></a>train <span class="ot">=</span> data[[<span class="dv">1</span>]]</span>
<span id="cb327-4"><a href="gans-vaes-and-reinforcement-learning.html#cb327-4" aria-hidden="true" tabindex="-1"></a>train_x <span class="ot">=</span> <span class="fu">array</span>(train[[<span class="dv">1</span>]]<span class="sc">/</span><span class="dv">255</span>, <span class="fu">c</span>(<span class="fu">dim</span>(train[[<span class="dv">1</span>]])[<span class="dv">1</span>], 784L))</span>
<span id="cb327-5"><a href="gans-vaes-and-reinforcement-learning.html#cb327-5" aria-hidden="true" tabindex="-1"></a>tfp <span class="ot">=</span> reticulate<span class="sc">::</span><span class="fu">import</span>(<span class="st">&quot;tensorflow_probability&quot;</span>)</span>
<span id="cb327-6"><a href="gans-vaes-and-reinforcement-learning.html#cb327-6" aria-hidden="true" tabindex="-1"></a>prior <span class="ot">=</span> tfp<span class="sc">$</span>distributions<span class="sc">$</span><span class="fu">Independent</span>(tfp<span class="sc">$</span>distributions<span class="sc">$</span><span class="fu">Normal</span>(<span class="at">loc=</span>tf<span class="sc">$</span><span class="fu">zeros</span>(<span class="fu">shape</span>(10L,4L)), <span class="at">scale=</span><span class="fl">1.0</span>),</span>
<span id="cb327-7"><a href="gans-vaes-and-reinforcement-learning.html#cb327-7" aria-hidden="true" tabindex="-1"></a> <span class="at">reinterpreted_batch_ndims=</span>1L)</span>
<span id="cb327-8"><a href="gans-vaes-and-reinforcement-learning.html#cb327-8" aria-hidden="true" tabindex="-1"></a>down_size_model <span class="ot">=</span> <span class="fu">keras_model_sequential</span>()</span>
<span id="cb327-9"><a href="gans-vaes-and-reinforcement-learning.html#cb327-9" aria-hidden="true" tabindex="-1"></a>down_size_model <span class="sc">%&gt;%</span> </span>
<span id="cb327-10"><a href="gans-vaes-and-reinforcement-learning.html#cb327-10" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_dense</span>(<span class="at">units =</span> 100L, <span class="at">input_shape =</span> <span class="fu">c</span>(784L),<span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb327-11"><a href="gans-vaes-and-reinforcement-learning.html#cb327-11" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_dense</span>(<span class="at">units =</span> 20L, <span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb327-12"><a href="gans-vaes-and-reinforcement-learning.html#cb327-12" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_dense</span>(<span class="at">units =</span> 4L)</span>
<span id="cb327-13"><a href="gans-vaes-and-reinforcement-learning.html#cb327-13" aria-hidden="true" tabindex="-1"></a><span class="do">### Reconstruction of the images</span></span>
<span id="cb327-14"><a href="gans-vaes-and-reinforcement-learning.html#cb327-14" aria-hidden="true" tabindex="-1"></a>up_size_model <span class="ot">=</span> <span class="fu">keras_model_sequential</span>()</span>
<span id="cb327-15"><a href="gans-vaes-and-reinforcement-learning.html#cb327-15" aria-hidden="true" tabindex="-1"></a>up_size_model <span class="sc">%&gt;%</span> </span>
<span id="cb327-16"><a href="gans-vaes-and-reinforcement-learning.html#cb327-16" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_dense</span>(<span class="at">units =</span> 20L, <span class="at">input_shape =</span> <span class="fu">c</span>(2L), <span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb327-17"><a href="gans-vaes-and-reinforcement-learning.html#cb327-17" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_dense</span>(<span class="at">units =</span> 100L, <span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb327-18"><a href="gans-vaes-and-reinforcement-learning.html#cb327-18" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_dense</span>(<span class="at">units =</span> 784L, <span class="at">activation =</span> <span class="st">&quot;sigmoid&quot;</span>)</span>
<span id="cb327-19"><a href="gans-vaes-and-reinforcement-learning.html#cb327-19" aria-hidden="true" tabindex="-1"></a><span class="do">### Combine models into one</span></span>
<span id="cb327-20"><a href="gans-vaes-and-reinforcement-learning.html#cb327-20" aria-hidden="true" tabindex="-1"></a>batch_size <span class="ot">=</span> 32L</span>
<span id="cb327-21"><a href="gans-vaes-and-reinforcement-learning.html#cb327-21" aria-hidden="true" tabindex="-1"></a>epochs <span class="ot">=</span> 10L</span>
<span id="cb327-22"><a href="gans-vaes-and-reinforcement-learning.html#cb327-22" aria-hidden="true" tabindex="-1"></a>steps <span class="ot">=</span> <span class="fu">as.integer</span>(<span class="fu">nrow</span>(train_x)<span class="sc">/</span>32L <span class="sc">*</span> epochs)</span>
<span id="cb327-23"><a href="gans-vaes-and-reinforcement-learning.html#cb327-23" aria-hidden="true" tabindex="-1"></a>prior <span class="ot">=</span> tfp<span class="sc">$</span>distributions<span class="sc">$</span><span class="fu">MultivariateNormalDiag</span>(<span class="at">loc =</span> tf<span class="sc">$</span><span class="fu">zeros</span>(<span class="fu">shape</span>(batch_size, 2L), <span class="st">&quot;float32&quot;</span>), <span class="at">scale_diag =</span> tf<span class="sc">$</span><span class="fu">ones</span>(2L, <span class="st">&quot;float32&quot;</span>))</span>
<span id="cb327-24"><a href="gans-vaes-and-reinforcement-learning.html#cb327-24" aria-hidden="true" tabindex="-1"></a>optimizer <span class="ot">=</span> tf<span class="sc">$</span>keras<span class="sc">$</span>optimizers<span class="sc">$</span><span class="fu">RMSprop</span>(<span class="fl">0.0001</span>)</span>
<span id="cb327-25"><a href="gans-vaes-and-reinforcement-learning.html#cb327-25" aria-hidden="true" tabindex="-1"></a>weights <span class="ot">=</span> <span class="fu">c</span>(down_size_model<span class="sc">$</span>weights, up_size_model<span class="sc">$</span>weights)</span>
<span id="cb327-26"><a href="gans-vaes-and-reinforcement-learning.html#cb327-26" aria-hidden="true" tabindex="-1"></a>get_batch <span class="ot">=</span> <span class="cf">function</span>(){</span>
<span id="cb327-27"><a href="gans-vaes-and-reinforcement-learning.html#cb327-27" aria-hidden="true" tabindex="-1"></a> indices <span class="ot">=</span> <span class="fu">sample.int</span>(<span class="fu">nrow</span>(train_x), batch_size)</span>
<span id="cb327-28"><a href="gans-vaes-and-reinforcement-learning.html#cb327-28" aria-hidden="true" tabindex="-1"></a> <span class="fu">return</span>(train_x[indices,])</span>
<span id="cb327-29"><a href="gans-vaes-and-reinforcement-learning.html#cb327-29" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb327-30"><a href="gans-vaes-and-reinforcement-learning.html#cb327-30" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>steps){</span>
<span id="cb327-31"><a href="gans-vaes-and-reinforcement-learning.html#cb327-31" aria-hidden="true" tabindex="-1"></a> tmp_X <span class="ot">=</span> <span class="fu">get_batch</span>()</span>
<span id="cb327-32"><a href="gans-vaes-and-reinforcement-learning.html#cb327-32" aria-hidden="true" tabindex="-1"></a> <span class="fu">with</span>(tf<span class="sc">$</span><span class="fu">GradientTape</span>() <span class="sc">%as%</span> tape, {</span>
<span id="cb327-33"><a href="gans-vaes-and-reinforcement-learning.html#cb327-33" aria-hidden="true" tabindex="-1"></a> encoded <span class="ot">=</span> <span class="fu">down_size_model</span>(tmp_X)</span>
<span id="cb327-34"><a href="gans-vaes-and-reinforcement-learning.html#cb327-34" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb327-35"><a href="gans-vaes-and-reinforcement-learning.html#cb327-35" aria-hidden="true" tabindex="-1"></a> dd <span class="ot">=</span> tfp<span class="sc">$</span>distributions<span class="sc">$</span><span class="fu">MultivariateNormalDiag</span>(<span class="at">loc =</span> encoded[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>], </span>
<span id="cb327-36"><a href="gans-vaes-and-reinforcement-learning.html#cb327-36" aria-hidden="true" tabindex="-1"></a> <span class="at">scale_diag =</span> <span class="fl">1.0</span><span class="sc">/</span>(<span class="fl">0.01</span><span class="sc">+</span> tf<span class="sc">$</span>math<span class="sc">$</span><span class="fu">softplus</span>(encoded[,<span class="dv">3</span><span class="sc">:</span><span class="dv">4</span>])))</span>
<span id="cb327-37"><a href="gans-vaes-and-reinforcement-learning.html#cb327-37" aria-hidden="true" tabindex="-1"></a> samples <span class="ot">=</span> dd<span class="sc">$</span><span class="fu">sample</span>()</span>
<span id="cb327-38"><a href="gans-vaes-and-reinforcement-learning.html#cb327-38" aria-hidden="true" tabindex="-1"></a> reconstructed <span class="ot">=</span> <span class="fu">up_size_model</span>(samples)</span>
<span id="cb327-39"><a href="gans-vaes-and-reinforcement-learning.html#cb327-39" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb327-40"><a href="gans-vaes-and-reinforcement-learning.html#cb327-40" aria-hidden="true" tabindex="-1"></a> KL_loss <span class="ot">=</span> dd<span class="sc">$</span><span class="fu">kl_divergence</span>(prior) <span class="co"># constrain</span></span>
<span id="cb327-41"><a href="gans-vaes-and-reinforcement-learning.html#cb327-41" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb327-42"><a href="gans-vaes-and-reinforcement-learning.html#cb327-42" aria-hidden="true" tabindex="-1"></a> loss <span class="ot">=</span> tf<span class="sc">$</span><span class="fu">reduce_mean</span>(tf<span class="sc">$</span><span class="fu">negative</span>(tfp<span class="sc">$</span>distributions<span class="sc">$</span><span class="fu">Binomial</span>(1L, <span class="at">logits =</span> reconstructed)<span class="sc">$</span><span class="fu">log_prob</span>(tmp_X)))<span class="sc">+</span>tf<span class="sc">$</span><span class="fu">reduce_mean</span>(KL_loss)</span>
<span id="cb327-43"><a href="gans-vaes-and-reinforcement-learning.html#cb327-43" aria-hidden="true" tabindex="-1"></a> })</span>
<span id="cb327-44"><a href="gans-vaes-and-reinforcement-learning.html#cb327-44" aria-hidden="true" tabindex="-1"></a> gradients <span class="ot">=</span> tape<span class="sc">$</span><span class="fu">gradient</span>(loss, weights)</span>
<span id="cb327-45"><a href="gans-vaes-and-reinforcement-learning.html#cb327-45" aria-hidden="true" tabindex="-1"></a> optimizer<span class="sc">$</span><span class="fu">apply_gradients</span>(purrr<span class="sc">::</span><span class="fu">transpose</span>(<span class="fu">list</span>(gradients, weights)))</span>
<span id="cb327-46"><a href="gans-vaes-and-reinforcement-learning.html#cb327-46" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb327-47"><a href="gans-vaes-and-reinforcement-learning.html#cb327-47" aria-hidden="true" tabindex="-1"></a> <span class="cf">if</span>(i <span class="sc">%%</span> <span class="fu">as.integer</span>(<span class="fu">nrow</span>(train_x)<span class="sc">/</span>10L) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">cat</span>(<span class="st">&quot;Loss: &quot;</span>, loss<span class="sc">$</span><span class="fu">numpy</span>(), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb327-48"><a href="gans-vaes-and-reinforcement-learning.html#cb327-48" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="xAI.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="datasets.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
