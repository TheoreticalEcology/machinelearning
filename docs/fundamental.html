<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 4 Common Machine Learning algorithms | Machine Learning and AI in TensorFlow and R</title>
<meta name="author" content="Maximilian Pichler and Florian Hartig">
<meta name="description" content="4.1 Machine Learning Principles  4.1.1 Optimization Out of Wikipedia: “An optimization problem is the problem of finding the best solution from all feasible solutions.” Why do we need this...">
<meta name="generator" content="bookdown 0.27 with bs4_book()">
<meta property="og:title" content="Chapter 4 Common Machine Learning algorithms | Machine Learning and AI in TensorFlow and R">
<meta property="og:type" content="book">
<meta property="og:description" content="4.1 Machine Learning Principles  4.1.1 Optimization Out of Wikipedia: “An optimization problem is the problem of finding the best solution from all feasible solutions.” Why do we need this...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 4 Common Machine Learning algorithms | Machine Learning and AI in TensorFlow and R">
<meta name="twitter:description" content="4.1 Machine Learning Principles  4.1.1 Optimization Out of Wikipedia: “An optimization problem is the problem of finding the best solution from all feasible solutions.” Why do we need this...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><link href="libs/panelset-0.2.6/panelset.css" rel="stylesheet">
<script src="libs/panelset-0.2.6/panelset.js"></script><script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script><script src="libs/viz-1.8.2/viz.js"></script><link href="libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">
<script src="libs/grViz-binding-1.0.9/grViz.js"></script><style>
    #content {
        font-size: 0.95rem;
    }


    </style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
<link rel="stylesheet" href="panel.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Machine Learning and AI in TensorFlow and R</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"><span class="header-section-number">1</span> Prerequisites</a></li>
<li><a class="" href="introduction.html"><span class="header-section-number">2</span> Introduction to Machine Learning</a></li>
<li><a class="" href="tensorflowintro.html"><span class="header-section-number">3</span> Introduction to TensorFlow, Keras, and Torch</a></li>
<li><a class="active" href="fundamental.html"><span class="header-section-number">4</span> Common Machine Learning algorithms</a></li>
<li><a class="" href="workflow.html"><span class="header-section-number">5</span> Machine Learning workflow</a></li>
<li><a class="" href="deep.html"><span class="header-section-number">6</span> Deep Learning Architectures</a></li>
<li><a class="" href="interpretation.html"><span class="header-section-number">7</span> Interpretation and Causality With Machine Learning</a></li>
<li><a class="" href="gan.html"><span class="header-section-number">8</span> Generative Modeling and Reinforcement Learning</a></li>
<li><a class="" href="datasets.html"><span class="header-section-number">9</span> Data sets</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/TheoreticalEcology/machinelearning">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="fundamental" class="section level1" number="4">
<h1>
<span class="header-section-number">4</span> Common Machine Learning algorithms<a class="anchor" aria-label="anchor" href="#fundamental"><i class="fas fa-link"></i></a>
</h1>
<!-- Put this here (right after the first markdown headline) and only here for each document! -->
<script src="./scripts/multipleChoice.js"></script><div id="machine-learning-principles" class="section level2" number="4.1">
<h2>
<span class="header-section-number">4.1</span> Machine Learning Principles<a class="anchor" aria-label="anchor" href="#machine-learning-principles"><i class="fas fa-link"></i></a>
</h2>
<div id="optimization" class="section level3" number="4.1.1">
<h3>
<span class="header-section-number">4.1.1</span> Optimization<a class="anchor" aria-label="anchor" href="#optimization"><i class="fas fa-link"></i></a>
</h3>
<p>Out of Wikipedia: “An optimization problem is the problem of finding the best solution from all feasible solutions.”</p>
<p>Why do we need this “optimization?”</p>
<p>Somehow, we need to tell the algorithm what it should learn. To do so we have the so called <strong>loss function</strong>, which expresses what our goal is. But we also need to find the configurations where the loss function attains its minimum. This is the job of the optimizer. Thus, an optimization consists of:</p>
<ul>
<li><p>A <strong>loss function</strong> (e.g. we tell the algorithm in each training step how many observations were misclassified) guides the training of machine learning algorithms.</p></li>
<li><p>The <strong>optimizer</strong>, which tries to update the weights of the machine learning algorithms in a way that the loss function is minimized.</p></li>
</ul>
<p>Calculating the global optimum analytically is a non-trivial problem and thus a bunch of diverse optimization algorithms evolved.</p>
<p>Some optimization algorithms are inspired by biological systems e.g. ants, bees or even slimes. These optimizers are explained in the following video, have a look:</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/X-iSQQgOd1A" frameborder="0" allow="accelerometer; autoplay; encrypted-media;
  gyroscope; picture-in-picture" allowfullscreen>
</iframe>
</div>
<div id="questions-2" class="section level3" number="4.1.2">
<h3>
<span class="header-section-number">4.1.2</span> Questions<a class="anchor" aria-label="anchor" href="#questions-2"><i class="fas fa-link"></i></a>
</h3>
  <hr>
<p>
      <script>
        makeMultipleChoiceForm(
                'In the lecture, it was said that, during training, machine learning parameters are optimised to get a good fit (loss function) to training data. Which of the following statements about loss functions is correct?',
                'checkbox',
                [
                    {
                        'answer':'A loss function measures the difference between the (current) machine learning model prediction and the data.',
                        'correct':true,
                        'explanationIfSelected':'',
                        'explanationIfNotSelected':'',
                        'explanationGeneral':''
                    },
                    {
                        'answer':'When we specify a simple line as our machine learning model, all loss functions will lead to the same line.',
                        'correct':false,
                        'explanationIfSelected':'',
                        'explanationIfNotSelected':'',
                        'explanationGeneral':''
                    },
                    {
                        'answer':'Cross-Entropy and Kullback–Leibler divergence are common loss functions.',
                        'correct':true,
                        'explanationIfSelected':'',
                        'explanationIfNotSelected':'',
                        'explanationGeneral':''
                    },
                    {
                        'answer':'For regression, there is only one sensible loss function, and this is the mean squared error.',
                        'correct':false,
                        'explanationIfSelected':'',
                        'explanationIfNotSelected':'',
                        'explanationGeneral':''
            }
          ],
          ''
        );
      </script></p>
  <hr>
<div id="small-optimization-example" class="section level4" number="4.1.2.1">
<h4>
<span class="header-section-number">4.1.2.1</span> Small Optimization Example<a class="anchor" aria-label="anchor" href="#small-optimization-example"><i class="fas fa-link"></i></a>
</h4>
<p>As an easy example for an optimization we can think of a quadratic function:</p>
<div class="sourceCode" id="cb180"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">func</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">x</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">}</span></span></code></pre></div>
<p>This function is so easy, we can randomly probe it and identify the optimum by plotting.</p>
<div class="sourceCode" id="cb181"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/curve.html">curve</a></span><span class="op">(</span><span class="va">func</span>, <span class="op">-</span><span class="fl">3</span>,<span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_2-1.png" width="100%" style="display: block; margin: auto;"></div>
<p>The minimal value is at <span class="math inline">\(x = 0\)</span> (to be honest, we can calculate this analytically in this simple case).</p>
<p>We can also use an optimizer with the optim-function (the first argument is the starting value):</p>
<div class="sourceCode" id="cb182"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="va">opt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/optim.html">optim</a></span><span class="op">(</span><span class="fl">1.0</span>, <span class="va">func</span>, method <span class="op">=</span> <span class="st">"Brent"</span>, lower <span class="op">=</span> <span class="op">-</span><span class="fl">100</span>, upper <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">opt</span><span class="op">$</span><span class="va">par</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -3.552714e-15</span></span></code></pre></div>
<p>opt$par will return the best values found by the optimizer, which is really close to zero :)</p>
</div>
</div>
<div id="advanced-optimization-example" class="section level3" number="4.1.3">
<h3>
<span class="header-section-number">4.1.3</span> Advanced Optimization Example<a class="anchor" aria-label="anchor" href="#advanced-optimization-example"><i class="fas fa-link"></i></a>
</h3>
<p>Also statistical models are fit by optimizing the parameters. Let’s see how this works for a linear regression, using the example of the airquality data set. First, we have to be sure to have no NAs in there. Then we split into response (Ozone) and predictors (Month, Day, Solar.R, Wind, Temp). Additionally it is beneficial for the optimizer, when the different predictors have the same scale, and thus we scale them.</p>
<div class="sourceCode" id="cb183"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">=</span> <span class="va">airquality</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">airquality</span><span class="op">$</span><span class="va">Ozone</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">airquality</span><span class="op">$</span><span class="va">Solar.R</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="va">X</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">Y</span> <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Ozone</span></span></code></pre></div>
<p>The model we want to optimize: <span class="math inline">\(Ozone = Solar.R \cdot X1 + Wind \cdot X2 + Temp \cdot X3 + Month \cdot X4 + Day \cdot X5 + X6\)</span></p>
<p>We assume that the residuals are normally distributed, and our loss function to be the mean squared error: <span class="math inline">\(\mathrm{mean}(predicted~ozone - true~ozone)^{2}\)</span></p>
<p>Our task is now to find the parameters <span class="math inline">\(X1,\dots,X6\)</span> for which this loss function is minimal. Therefore, we implement a function, that takes parameters and returns the loss.</p>
<div class="sourceCode" id="cb184"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linear_regression</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">w</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">prediction</span> <span class="op">=</span> <span class="va">w</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span>  <span class="co"># intercept</span></span>
<span>         <span class="va">w</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="co"># Solar.R</span></span>
<span>         <span class="va">w</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="co"># Wind</span></span>
<span>         <span class="va">w</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">+</span> <span class="co"># Temp</span></span>
<span>         <span class="va">w</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">4</span><span class="op">]</span> <span class="op">+</span> <span class="co"># Month</span></span>
<span>         <span class="va">w</span><span class="op">[</span><span class="fl">6</span><span class="op">]</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span> <span class="co"># Day</span></span>
<span>  <span class="co"># or X * w[2:6]^T + w[1]</span></span>
<span>  <span class="co"># loss  = MSE, we want to find the optimal weights </span></span>
<span>  <span class="co"># to minimize the sum of squared residuals.</span></span>
<span>  <span class="va">loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">prediction</span> <span class="op">-</span> <span class="va">Y</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">loss</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>For example we can sample some weights and see how the loss changes with this weights.</p>
<div class="sourceCode" id="cb185"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="fu">linear_regression</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">6</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 2797.199</span></span></code></pre></div>
<p>We can try to find the optimum by bruteforce (what means we will use a random set of weights and see for which the loss function is minimal):</p>
<div class="sourceCode" id="cb186"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="va">random_search</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">6</span><span class="op">*</span><span class="fl">5000</span>, <span class="op">-</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">)</span>, <span class="fl">5000</span>, <span class="fl">6</span><span class="op">)</span></span>
<span><span class="va">losses</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">random_search</span>, <span class="fl">1</span>, <span class="va">linear_regression</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">losses</span>, type <span class="op">=</span> <span class="st">"l"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_7-1.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb187"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">losses</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1602.35</span></span>
<span><span class="va">random_search</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html">which.min</a></span><span class="op">(</span><span class="va">losses</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="co">#&gt; [1]  9.3257134  5.1024129 -9.6783025  7.6759366 -0.9435499 -1.4808634</span></span></code></pre></div>
<p>In most cases, bruteforce isn’t a good approach. It might work well with only a few parameters, but with increasing complexity and more parameters it will take a long time. Furthermore it is not guaranteed that it finds a stable solution on continuous data. In R the optim function helps computing the optimum faster.</p>
<div class="sourceCode" id="cb188"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">opt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/optim.html">optim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">6</span>, <span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>, <span class="va">linear_regression</span>, method <span class="op">=</span> <span class="st">"BFGS"</span><span class="op">)</span></span>
<span><span class="va">opt</span><span class="op">$</span><span class="va">par</span></span>
<span><span class="co">#&gt; [1]  42.099071   4.582640 -11.806113  18.066734  -4.479160   2.384711</span></span>
<span><span class="va">opt</span><span class="op">$</span><span class="va">value</span></span>
<span><span class="co">#&gt; [1] 411.5579</span></span></code></pre></div>
<p>We see, we have found a better loss value, with far few model evaluations. You can see the number of model evaluations via</p>
<div class="sourceCode" id="cb189"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">opt</span><span class="op">$</span><span class="va">counts</span></span>
<span><span class="co">#&gt; function gradient </span></span>
<span><span class="co">#&gt;       22       11</span></span></code></pre></div>
<p>By comparing the weights from the optimizer to the estimated weights of the lm() function, we see that our self-written code obtains the same weights as the lm.</p>
<div class="sourceCode" id="cb190"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">Y</span><span class="op">~</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; (Intercept)    XSolar.R       XWind       XTemp      XMonth        XDay </span></span>
<span><span class="co">#&gt;   42.099099    4.582620  -11.806072   18.066786   -4.479175    2.384705</span></span></code></pre></div>
<p>When you look at these numbers, keep in mind that most optimization algorithms use random numbers thus the results might differ each run (without setting the seed).</p>
<p>Let’s optimize a linear regression model using tensorflow/torch, autodiff and stochastic gradient descent. Gradient descent updates iteraviely the weights/variables of interest by the following rule:</p>
<p><span class="math display">\[ w_{new} = w_{old} - \eta \nabla f(w_{old})   \]</span></p>
<p>with = learning rate (step size) and <span class="math inline">\(f(x)\)</span> our loss function.</p>
<p>Also have a look at the Torch example, there we use (similar to the R optim example) the LFBGS optimizer.</p>
<div class="panelset">
<div class="panel">
<p><span class="panel-name">Tensorflow</span></p>
<div class="sourceCode" id="cb191"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/set_random_seed.html">set_random_seed</a></span><span class="op">(</span><span class="fl">321L</span>, disable_gpu <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># Already sets R's random seed.</span></span>
<span><span class="co">#&gt; Loaded Tensorflow version 2.9.1</span></span>
<span></span>
<span></span>
<span><span class="co"># Guessed weights and intercept.</span></span>
<span><span class="va">wTF</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="fu">Variable</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, <span class="fl">0</span>, <span class="fl">0.01</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>, dtype<span class="op">=</span><span class="st">"float32"</span><span class="op">)</span></span>
<span><span class="va">interceptTF</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="fu">Variable</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">.05</span><span class="op">)</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fl">1</span>, dtype<span class="op">=</span><span class="st">"float32"</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">get_batch</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">indices</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, <span class="fl">20</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">tf</span><span class="op">$</span><span class="fu">constant</span><span class="op">(</span><span class="va">X</span><span class="op">[</span><span class="va">indices</span>,<span class="op">]</span>, dtype<span class="op">=</span><span class="st">"float32"</span><span class="op">)</span>, </span>
<span>              <span class="va">tf</span><span class="op">$</span><span class="fu">constant</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span><span class="op">[</span><span class="va">indices</span>,,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span>, dtype<span class="op">=</span><span class="st">"float32"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">learning_rate</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="fu">constant</span><span class="op">(</span> <span class="fl">0.5</span>, dtype <span class="op">=</span> <span class="st">"float32"</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2000</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">batch</span> <span class="op">=</span> <span class="fu">get_batch</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">xTF</span> <span class="op">=</span> <span class="va">batch</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">yTF</span> <span class="op">=</span> <span class="va">batch</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">tf</span><span class="op">$</span><span class="fu">GradientTape</span><span class="op">(</span>persistent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://rstudio.github.io/reticulate/reference/with-as-operator.html">%as%</a></span> <span class="va">tape</span>,</span>
<span>    <span class="op">{</span></span>
<span>      <span class="va">pred</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="fu">add</span><span class="op">(</span><span class="va">interceptTF</span>, <span class="va">tf</span><span class="op">$</span><span class="fu">matmul</span><span class="op">(</span><span class="va">xTF</span>, <span class="va">wTF</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="va">loss</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="fu">sqrt</span><span class="op">(</span><span class="va">tf</span><span class="op">$</span><span class="fu">reduce_mean</span><span class="op">(</span><span class="va">tf</span><span class="op">$</span><span class="fu">square</span><span class="op">(</span><span class="va">yTF</span> <span class="op">-</span> <span class="va">pred</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">grads</span> <span class="op">=</span> <span class="va">tape</span><span class="op">$</span><span class="fu">gradient</span><span class="op">(</span><span class="va">loss</span>, <span class="va">wTF</span><span class="op">)</span></span>
<span>  <span class="va">.n</span> <span class="op">=</span> <span class="va">wTF</span><span class="op">$</span><span class="fu">assign</span><span class="op">(</span> <span class="va">wTF</span> <span class="op">-</span> <span class="va">tf</span><span class="op">$</span><span class="fu">multiply</span><span class="op">(</span><span class="va">learning_rate</span>, <span class="va">grads</span> <span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">grads_inter</span> <span class="op">=</span> <span class="va">tape</span><span class="op">$</span><span class="fu">gradient</span><span class="op">(</span><span class="va">loss</span>, <span class="va">interceptTF</span><span class="op">)</span></span>
<span>  <span class="va">.n</span> <span class="op">=</span> <span class="va">interceptTF</span><span class="op">$</span><span class="fu">assign</span><span class="op">(</span> <span class="va">interceptTF</span> <span class="op">-</span> <span class="va">tf</span><span class="op">$</span><span class="fu">multiply</span><span class="op">(</span><span class="va">learning_rate</span>, <span class="va">grads_inter</span> <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="va">i</span><span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span><span class="fl">100</span><span class="op">)</span><span class="op">{</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/k_print_tensor.html">k_print_tensor</a></span><span class="op">(</span><span class="va">loss</span>, message <span class="op">=</span> <span class="st">"Loss: "</span><span class="op">)</span> <span class="op">}</span>  <span class="co"># Every 10 times.</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="panel">
<p><span class="panel-name">Torch</span></p>
<div class="sourceCode" id="cb192"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs">torch</a></span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Guessed weights and intercept.</span></span>
<span><span class="va">wTorch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, <span class="fl">0</span>, <span class="fl">0.01</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>, </span>
<span>                      dtype<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_dtype.html">torch_float32</a></span><span class="op">(</span><span class="op">)</span>, requires_grad <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">interceptTorch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">.05</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>, dtype<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_dtype.html">torch_float32</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>                              requires_grad <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">get_batch</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">indices</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, <span class="fl">40</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="va">X</span><span class="op">[</span><span class="va">indices</span>,<span class="op">]</span>, dtype<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_dtype.html">torch_float32</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>, </span>
<span>              <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span><span class="op">[</span><span class="va">indices</span>,,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span>, dtype<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_dtype.html">torch_float32</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">optim</span> <span class="op">=</span> <span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/optim_lbfgs.html">optim_lbfgs</a></span><span class="op">(</span>params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">wTorch</span>, <span class="va">interceptTorch</span><span class="op">)</span>, lr <span class="op">=</span> <span class="fl">0.1</span>, line_search_fn <span class="op">=</span>  <span class="st">"strong_wolfe"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">train_step</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">optim</span><span class="op">$</span><span class="fu">zero_grad</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">pred</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_add.html">torch_add</a></span><span class="op">(</span><span class="va">interceptTorch</span>, <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_matmul.html">torch_matmul</a></span><span class="op">(</span><span class="va">xTorch</span>, <span class="va">wTorch</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_sqrt.html">torch_sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_mean.html">torch_mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_pow.html">torch_pow</a></span><span class="op">(</span><span class="va">yTorch</span> <span class="op">-</span> <span class="va">pred</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">loss</span><span class="op">$</span><span class="fu">backward</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">loss</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">batch</span> <span class="op">=</span> <span class="fu">get_batch</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">xTorch</span> <span class="op">=</span> <span class="va">batch</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">yTorch</span> <span class="op">=</span> <span class="va">batch</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">loss</span> <span class="op">=</span> <span class="va">optim</span><span class="op">$</span><span class="fu">step</span><span class="op">(</span><span class="va">train_step</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="va">i</span><span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span><span class="fl">10</span><span class="op">)</span><span class="op">{</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Loss: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">loss</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span><span class="op">}</span>  <span class="co"># Every 10 times.</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Loss:  23.50033 </span></span>
<span><span class="co">#&gt; Loss:  25.81845 </span></span>
<span><span class="co">#&gt; Loss:  21.38388</span></span></code></pre></div>
</div>
</div>
<pre><code>#&gt; LM weights:
#&gt;  42.0991 4.58262 -11.80607 18.06679 -4.479175 2.384705
#&gt; Optim weights:
#&gt; TF weights:
#&gt;  41.74698 4.607593 -10.34761 18.43785 -4.653901 2.504827
#&gt; Torch LBFGS weights:
#&gt;  45.92921 4.999026 -10.84635 24.09501 -8.427817 -4.406448</code></pre>
</div>
<div id="regularization" class="section level3" number="4.1.4">
<h3>
<span class="header-section-number">4.1.4</span> Regularization<a class="anchor" aria-label="anchor" href="#regularization"><i class="fas fa-link"></i></a>
</h3>
<p>Regularization means adding information or structure to a system in order to solve an ill-posed optimization problem or to prevent overfitting. There are many ways of regularizing a machine learning model. The most important distinction is between <em>shrinkage estimators</em> and estimators based on <em>model averaging</em>.</p>
<p><strong>Shrikage estimators</strong> are based on the idea of adding a penalty to the loss function that penalizes deviations of the model parameters from a particular value (typically 0). In this way, estimates are <em>“shrunk”</em> to the specified default value. In practice, the most important penalties are the least absolute shrinkage and selection operator; also <em>Lasso</em> or <em>LASSO</em>, where the penalty is proportional to the sum of absolute deviations (<span class="math inline">\(L1\)</span> penalty), and the <em>Tikhonov regularization</em> aka <em>Ridge regression</em>, where the penalty is proportional to the sum of squared distances from the reference (<span class="math inline">\(L2\)</span> penalty). Thus, the loss function that we optimize is given by</p>
<p><span class="math display">\[
loss = fit - \lambda \cdot d
\]</span></p>
<p>where fit refers to the standard loss function, <span class="math inline">\(\lambda\)</span> is the strength of the regularization, and <span class="math inline">\(d\)</span> is the chosen metric, e.g. <span class="math inline">\(L1\)</span> or<span class="math inline">\(L2\)</span>:</p>
<p><span class="math display">\[
loss_{L1} = fit - \lambda \cdot \Vert weights \Vert_1
\]</span>
<span class="math display">\[
loss_{L2} = fit - \lambda \cdot \Vert weights \Vert_2
\]</span></p>
<p><span class="math inline">\(\lambda\)</span> and possibly d are typically optimized under cross-validation. <span class="math inline">\(L1\)</span> and <span class="math inline">\(L2\)</span> can be also combined what is then called <em>elastic net</em> (see <span class="citation"><a href="references.html#ref-zou2005" role="doc-biblioref">Zou and Hastie</a> (<a href="references.html#ref-zou2005" role="doc-biblioref">2005</a>)</span>).</p>
<p><strong>Model averaging</strong> refers to an entire set of techniques, including <em>boosting</em>, <em>bagging</em> and other averaging techniques. The general principle is that predictions are made by combining (= averaging) several models. This is based on on the insight that it is often more efficient having many simpler models and average them, than one “super model.” The reasons are complicated, and explained in more detail in <span class="citation"><a href="references.html#ref-dormann2018" role="doc-biblioref">Dormann et al.</a> (<a href="references.html#ref-dormann2018" role="doc-biblioref">2018</a>)</span>.</p>
<p>A particular important application of averaging is <em>boosting</em>, where the idea is that many weak learners are combined to a model average, resulting in a strong learner. Another related method is <em>bootstrap aggregating</em>, also called <em>bagging</em>. Idea here is to <em>boostrap</em> (use random sampling with replacement ) the data, and average the bootstrapped predictions.</p>
<p>To see how these techniques work in practice, let’s first focus on LASSO and Ridge regularization for weights in neural networks. We can imagine that the LASSO and Ridge act similar to a rubber band on the weights that pulls them to zero if the data does not strongly push them away from zero. This leads to important weights, which are supported by the data, being estimated as different from zero, whereas unimportant model structures are reduced (shrunken) to zero.</p>
<p>LASSO <span class="math inline">\(\left(penalty \propto \sum_{}^{} \mathrm{abs}(weights) \right)\)</span> and Ridge <span class="math inline">\(\left(penalty \propto \sum_{}^{} weights^{2} \right)\)</span> have slightly different properties. They are best understood if we express those as the effective prior preference they create on the parameters:</p>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_10-1.png" width="100%" style="display: block; margin: auto;"></div>
<p>As you can see, the LASSO creates a very strong preference towards exactly zero, but falls off less strongly towards the tails. This means that parameters tend to be estimated either to exactly zero, or, if not, they are more free than the Ridge. For this reason, LASSO is often more interpreted as a model selection method.</p>
<p>The Ridge, on the other hand, has a certain area around zero where it is relatively indifferent about deviations from zero, thus rarely leading to exactly zero values. However, it will create a stronger shrinkage for values that deviate significantly from zero.</p>
<p>We can implement the linear regression also in Keras, when we do not specify any hidden layers:</p>
<div class="panelset">
<div class="panel">
<p><span class="panel-name">Keras</span></p>
<div class="sourceCode" id="cb194"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/set_random_seed.html">set_random_seed</a></span><span class="op">(</span><span class="fl">321L</span>, disable_gpu <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># Already sets R's random seed.</span></span>
<span><span class="co">#&gt; Loaded Tensorflow version 2.9.1</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">airquality</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">airquality</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="va">X</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">Y</span> <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Ozone</span></span>
<span><span class="co"># L1/L2 on linear model.</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">1L</span>, activation <span class="op">=</span> <span class="st">"linear"</span>, input_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span><span class="co">#&gt; Model: "sequential"</span></span>
<span><span class="co">#&gt; __________________________________________________________________________________________</span></span>
<span><span class="co">#&gt;  Layer (type)                           Output Shape                        Param #       </span></span>
<span><span class="co">#&gt; ==========================================================================================</span></span>
<span><span class="co">#&gt;  dense (Dense)                          (None, 1)                           6             </span></span>
<span><span class="co">#&gt; ==========================================================================================</span></span>
<span><span class="co">#&gt; Total params: 6</span></span>
<span><span class="co">#&gt; Trainable params: 6</span></span>
<span><span class="co">#&gt; Non-trainable params: 0</span></span>
<span><span class="co">#&gt; __________________________________________________________________________________________</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span> <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html">compile</a></span><span class="op">(</span>loss <span class="op">=</span> <span class="va">loss_mean_squared_error</span>, <span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_adamax.html">optimizer_adamax</a></span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>         metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">metric_mean_squared_error</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_history</span> <span class="op">=</span></span>
<span> <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span> <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">X</span>, y <span class="op">=</span> <span class="va">Y</span>, epochs <span class="op">=</span> <span class="fl">100L</span>, batch_size <span class="op">=</span> <span class="fl">20L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">unconstrained</span> <span class="op">=</span> <span class="va">model</span><span class="op">$</span><span class="fu">get_weights</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">Y</span><span class="op">~</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; lm(formula = Y ~ X)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residuals:</span></span>
<span><span class="co">#&gt;     Min      1Q  Median      3Q     Max </span></span>
<span><span class="co">#&gt; -37.014 -12.284  -3.302   8.454  95.348 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept)   42.099      1.980  21.264  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; XSolar.R       4.583      2.135   2.147   0.0341 *  </span></span>
<span><span class="co">#&gt; XWind        -11.806      2.293  -5.149 1.23e-06 ***</span></span>
<span><span class="co">#&gt; XTemp         18.067      2.610   6.922 3.66e-10 ***</span></span>
<span><span class="co">#&gt; XMonth        -4.479      2.230  -2.009   0.0471 *  </span></span>
<span><span class="co">#&gt; XDay           2.385      2.000   1.192   0.2358    </span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual standard error: 20.86 on 105 degrees of freedom</span></span>
<span><span class="co">#&gt; Multiple R-squared:  0.6249, Adjusted R-squared:  0.6071 </span></span>
<span><span class="co">#&gt; F-statistic: 34.99 on 5 and 105 DF,  p-value: &lt; 2.2e-16</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">Y</span><span class="op">~</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; (Intercept)    XSolar.R       XWind       XTemp      XMonth        XDay </span></span>
<span><span class="co">#&gt;   42.099099    4.582620  -11.806072   18.066786   -4.479175    2.384705</span></span></code></pre></div>
</div>
<div class="panel">
<p><span class="panel-name">Torch</span></p>
<div class="sourceCode" id="cb195"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs">torch</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_manual_seed.html">torch_manual_seed</a></span><span class="op">(</span><span class="fl">321L</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_torch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_sequential.html">nn_sequential</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html">nn_linear</a></span><span class="op">(</span>in_features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, out_features <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">opt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/optim_adam.html">optim_adam</a></span><span class="op">(</span>params <span class="op">=</span> <span class="va">model_torch</span><span class="op">$</span><span class="va">parameters</span>, lr <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">X_torch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="va">Y_torch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">Y</span>, ncol <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span>, dtype <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_dtype.html">torch_float32</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">500</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">indices</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, <span class="fl">20L</span><span class="op">)</span></span>
<span>  <span class="va">opt</span><span class="op">$</span><span class="fu">zero_grad</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">pred</span> <span class="op">=</span> <span class="fu">model_torch</span><span class="op">(</span><span class="va">X_torch</span><span class="op">[</span><span class="va">indices</span>, <span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nnf_mse_loss.html">nnf_mse_loss</a></span><span class="op">(</span><span class="va">pred</span>, <span class="va">Y_torch</span><span class="op">[</span><span class="va">indices</span>,,drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">loss</span><span class="op">$</span><span class="fu">sum</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">backward</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">opt</span><span class="op">$</span><span class="fu">step</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">Y</span><span class="op">~</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; (Intercept)    XSolar.R       XWind       XTemp      XMonth        XDay </span></span>
<span><span class="co">#&gt;   42.099099    4.582620  -11.806072   18.066786   -4.479175    2.384705</span></span>
<span><span class="va">model_torch</span><span class="op">$</span><span class="va">parameters</span></span>
<span><span class="co">#&gt; $`0.weight`</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt;   4.1083 -10.1831  18.2815  -4.3478   1.2937</span></span>
<span><span class="co">#&gt; [ CPUFloatType{1,5} ][ requires_grad = TRUE ]</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $`0.bias`</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt;  42.0958</span></span>
<span><span class="co">#&gt; [ CPUFloatType{1} ][ requires_grad = TRUE ]</span></span></code></pre></div>
</div>
</div>
<p>TensorFlow and thus Keras also allow use using LASSO and Ridge on the weights.
Lets see what happens when we put an <span class="math inline">\(L1\)</span> (LASSO) regularization on the weights:</p>
<div class="panelset">
<div class="panel">
<p><span class="panel-name">Keras</span></p>
<div class="sourceCode" id="cb196"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/set_random_seed.html">set_random_seed</a></span><span class="op">(</span><span class="fl">321L</span>, disable_gpu <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># Already sets R's random seed.</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># Remind the penalty lambda that is set to 10 here.</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">1L</span>, activation <span class="op">=</span> <span class="st">"linear"</span>, input_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>, </span>
<span>              kernel_regularizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l1</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>,</span>
<span>              bias_regularizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l1</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span><span class="co">#&gt; Model: "sequential_1"</span></span>
<span><span class="co">#&gt; __________________________________________________________________________________________</span></span>
<span><span class="co">#&gt;  Layer (type)                           Output Shape                        Param #       </span></span>
<span><span class="co">#&gt; ==========================================================================================</span></span>
<span><span class="co">#&gt;  dense_1 (Dense)                        (None, 1)                           6             </span></span>
<span><span class="co">#&gt; ==========================================================================================</span></span>
<span><span class="co">#&gt; Total params: 6</span></span>
<span><span class="co">#&gt; Trainable params: 6</span></span>
<span><span class="co">#&gt; Non-trainable params: 0</span></span>
<span><span class="co">#&gt; __________________________________________________________________________________________</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html">compile</a></span><span class="op">(</span>loss <span class="op">=</span> <span class="va">loss_mean_squared_error</span>, <span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_adamax.html">optimizer_adamax</a></span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>          metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">metric_mean_squared_error</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_history</span> <span class="op">=</span></span>
<span>  <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">X</span>, y <span class="op">=</span> <span class="va">Y</span>, epochs <span class="op">=</span> <span class="fl">30L</span>, batch_size <span class="op">=</span> <span class="fl">20L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">l1</span> <span class="op">=</span> <span class="va">model</span><span class="op">$</span><span class="fu">get_weights</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">Y</span><span class="op">~</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; lm(formula = Y ~ X)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residuals:</span></span>
<span><span class="co">#&gt;     Min      1Q  Median      3Q     Max </span></span>
<span><span class="co">#&gt; -37.014 -12.284  -3.302   8.454  95.348 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept)   42.099      1.980  21.264  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; XSolar.R       4.583      2.135   2.147   0.0341 *  </span></span>
<span><span class="co">#&gt; XWind        -11.806      2.293  -5.149 1.23e-06 ***</span></span>
<span><span class="co">#&gt; XTemp         18.067      2.610   6.922 3.66e-10 ***</span></span>
<span><span class="co">#&gt; XMonth        -4.479      2.230  -2.009   0.0471 *  </span></span>
<span><span class="co">#&gt; XDay           2.385      2.000   1.192   0.2358    </span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual standard error: 20.86 on 105 degrees of freedom</span></span>
<span><span class="co">#&gt; Multiple R-squared:  0.6249, Adjusted R-squared:  0.6071 </span></span>
<span><span class="co">#&gt; F-statistic: 34.99 on 5 and 105 DF,  p-value: &lt; 2.2e-16</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">Y</span><span class="op">~</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; (Intercept)    XSolar.R       XWind       XTemp      XMonth        XDay </span></span>
<span><span class="co">#&gt;   42.099099    4.582620  -11.806072   18.066786   -4.479175    2.384705</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="va">l1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="va">unconstrained</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;             [,1]       [,2]</span></span>
<span><span class="co">#&gt; [1,]  1.69559026   4.576884</span></span>
<span><span class="co">#&gt; [2,] -8.43734646 -11.771938</span></span>
<span><span class="co">#&gt; [3,] 12.91758442  18.096060</span></span>
<span><span class="co">#&gt; [4,]  0.01775982  -4.407187</span></span>
<span><span class="co">#&gt; [5,]  0.01594419   2.432310</span></span>
<span><span class="co">#&gt; [6,] 33.05084229  42.205029</span></span></code></pre></div>
<p>One can clearly see that parameters are pulled towards zero because of the regularization.</p>
</div>
<div class="panel">
<p><span class="panel-name">Torch</span></p>
<p>In Torch, we have to specify the regularization on our own when calculating the loss.</p>
<div class="sourceCode" id="cb197"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs">torch</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_manual_seed.html">torch_manual_seed</a></span><span class="op">(</span><span class="fl">321L</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_torch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_sequential.html">nn_sequential</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html">nn_linear</a></span><span class="op">(</span>in_features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, out_features <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">opt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/optim_adam.html">optim_adam</a></span><span class="op">(</span>params <span class="op">=</span> <span class="va">model_torch</span><span class="op">$</span><span class="va">parameters</span>, lr <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">X_torch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="va">Y_torch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">Y</span>, ncol <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span>, dtype <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_dtype.html">torch_float32</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">500</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">indices</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, <span class="fl">20L</span><span class="op">)</span></span>
<span>  <span class="va">opt</span><span class="op">$</span><span class="fu">zero_grad</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">pred</span> <span class="op">=</span> <span class="fu">model_torch</span><span class="op">(</span><span class="va">X_torch</span><span class="op">[</span><span class="va">indices</span>, <span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nnf_mse_loss.html">nnf_mse_loss</a></span><span class="op">(</span><span class="va">pred</span>, <span class="va">Y_torch</span><span class="op">[</span><span class="va">indices</span>,,drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Add L1:</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">model_torch</span><span class="op">$</span><span class="va">parameters</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="co"># Remind the penalty lambda that is set to 10 here.</span></span>
<span>    <span class="va">loss</span> <span class="op">=</span> <span class="va">loss</span> <span class="op">+</span> <span class="va">model_torch</span><span class="op">$</span><span class="va">parameters</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">abs</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">sum</span><span class="op">(</span><span class="op">)</span><span class="op">*</span><span class="fl">10.0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">loss</span><span class="op">$</span><span class="fu">sum</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">backward</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">opt</span><span class="op">$</span><span class="fu">step</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">Y</span><span class="op">~</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; (Intercept)    XSolar.R       XWind       XTemp      XMonth        XDay </span></span>
<span><span class="co">#&gt;   42.099099    4.582620  -11.806072   18.066786   -4.479175    2.384705</span></span>
<span><span class="va">model_torch</span><span class="op">$</span><span class="va">parameters</span></span>
<span><span class="co">#&gt; $`0.weight`</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt;   0.7787  -6.5937  14.6648  -0.0670   0.0475</span></span>
<span><span class="co">#&gt; [ CPUFloatType{1,5} ][ requires_grad = TRUE ]</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $`0.bias`</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt;  37.2661</span></span>
<span><span class="co">#&gt; [ CPUFloatType{1} ][ requires_grad = TRUE ]</span></span></code></pre></div>
</div>
</div>
</div>
<div id="exerexer" class="section level3" number="4.1.5">
<h3>
<span class="header-section-number">4.1.5</span> Exercise<a class="anchor" aria-label="anchor" href="#exerexer"><i class="fas fa-link"></i></a>
</h3>
  <hr>
  In our linear regression model for the airquality dataset we only had to optimize 6 parameters/weights...
... in neural networks, we have to optimize thousands, up to billions of weights.
You can surlely imagine that the surface of the loss function is very complex, with many local optima. 
Finding a global optimum is almost impossible, most of the times we are only searching for good local optima.

The learning rate of the optimizers defines the step size in which the weights of the neural network are updated:

<ul>
<li>Too high learning rates and optima might be jumped over.</li>
  <li>Too low learning rates and we might be land in local optima or it might take too long.</li>
</ul> 

Below, there is the code for the iris dataset.

Try out different learning rates, very high and very low learning rates, can you see a difference?
<div class="panelset">
<div class="panel">
<p><span class="panel-name">Keras</span></p>
<div class="sourceCode" id="cb198"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/set_random_seed.html">set_random_seed</a></span><span class="op">(</span><span class="fl">321L</span>, disable_gpu <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># Already sets R's random seed.</span></span>
<span></span>
<span><span class="va">iris</span> <span class="op">=</span> <span class="fu">datasets</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/r/datasets/iris.html">iris</a></span></span>
<span><span class="va">X</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">iris</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">Y</span> <span class="op">=</span> <span class="va">iris</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span></span>
<span><span class="va">Y</span> <span class="op">=</span> <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/k_one_hot.html">k_one_hot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span><span class="op">-</span><span class="fl">1L</span>, <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">20L</span>, activation <span class="op">=</span> <span class="st">"relu"</span>, input_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fl">4L</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">20L</span>, activation <span class="op">=</span> <span class="st">"relu"</span>, <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">20L</span>, activation <span class="op">=</span> <span class="st">"relu"</span>, <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">3L</span>, activation <span class="op">=</span> <span class="st">"softmax"</span><span class="op">)</span></span>
<span><span class="co"># Softmax scales to (0, 1]; 3 output nodes for 3 response classes/labels.</span></span>
<span><span class="co"># The labels MUST start at 0!</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html">compile</a></span><span class="op">(</span>loss <span class="op">=</span> <span class="va">loss_categorical_crossentropy</span>,</span>
<span>          <span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_adamax.html">optimizer_adamax</a></span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>          metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">metric_categorical_accuracy</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">model_history</span> <span class="op">=</span></span>
<span>  <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">X</span>, y <span class="op">=</span> <span class="va">Y</span>, epochs <span class="op">=</span> <span class="fl">30L</span>, batch_size <span class="op">=</span> <span class="fl">20L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/evaluate.html">evaluate</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span><span class="op">)</span></span>
<span><span class="co">#&gt;                 loss categorical_accuracy </span></span>
<span><span class="co">#&gt;           0.04419739           0.98666668</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model_history</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_0-1.png" width="100%" style="display: block; margin: auto;"></div>
</div>
<div class="panel">
<p><span class="panel-name">Torch</span></p>
<div class="sourceCode" id="cb199"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs">torch</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_manual_seed.html">torch_manual_seed</a></span><span class="op">(</span><span class="fl">321L</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="va">iris</span> <span class="op">=</span> <span class="fu">datasets</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/r/datasets/iris.html">iris</a></span></span>
<span><span class="va">X</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">iris</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">Yt</span> <span class="op">=</span> <span class="va">iris</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span></span>
<span><span class="va">Yt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">Yt</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_torch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_sequential.html">nn_sequential</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html">nn_linear</a></span><span class="op">(</span>in_features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, out_features <span class="op">=</span> <span class="fl">20L</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_relu.html">nn_relu</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html">nn_linear</a></span><span class="op">(</span>in_features <span class="op">=</span> <span class="fl">20L</span>, out_features <span class="op">=</span> <span class="fl">20L</span>, bias <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_relu.html">nn_relu</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html">nn_linear</a></span><span class="op">(</span>in_features <span class="op">=</span> <span class="fl">20L</span>, out_features <span class="op">=</span> <span class="fl">20L</span>, bias <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_relu.html">nn_relu</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html">nn_linear</a></span><span class="op">(</span>in_features <span class="op">=</span> <span class="fl">20L</span>, out_features <span class="op">=</span> <span class="fl">3L</span>, bias <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">opt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/optim_adam.html">optim_adam</a></span><span class="op">(</span>params <span class="op">=</span> <span class="va">model_torch</span><span class="op">$</span><span class="va">parameters</span>, lr <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">batch_size</span> <span class="op">=</span> <span class="fl">20L</span></span>
<span><span class="va">X_torch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="va">Y_torch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="va">Yt</span>, dtype <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_dtype.html">torch_long</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">losses</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fl">500</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">500</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">indices</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, <span class="va">batch_size</span><span class="op">)</span></span>
<span>  <span class="va">opt</span><span class="op">$</span><span class="fu">zero_grad</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">pred</span> <span class="op">=</span> <span class="fu">model_torch</span><span class="op">(</span><span class="va">X_torch</span><span class="op">[</span><span class="va">indices</span>, <span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nnf_cross_entropy.html">nnf_cross_entropy</a></span><span class="op">(</span><span class="va">pred</span>, <span class="va">Y_torch</span><span class="op">[</span><span class="va">indices</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">losses</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">loss</span><span class="op">)</span></span>
<span>  <span class="va">loss</span><span class="op">$</span><span class="fu">sum</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">backward</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">opt</span><span class="op">$</span><span class="fu">step</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">losses</span>, main <span class="op">=</span> <span class="st">"Torch training history"</span>, xlab <span class="op">=</span> <span class="st">"Epoch"</span>, ylab <span class="op">=</span> <span class="st">"Loss"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_0_torch-1.png" width="100%" style="display: block; margin: auto;"></div>
</div>
</div>
  <details><summary><strong><span style="color: #0011AA; font-size:18px;">Solution</span></strong>
    </summary><p>
</p>
<div class="panelset">
<div class="panel">
<p><span class="panel-name">Keras</span></p>
<div class="sourceCode" id="cb200"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/reset_states.html">reset_states</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html">compile</a></span><span class="op">(</span>loss <span class="op">=</span> <span class="va">loss_categorical_crossentropy</span>,</span>
<span>          <span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_adamax.html">optimizer_adamax</a></span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">0.005</span><span class="op">)</span>,</span>
<span>          metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">metric_categorical_accuracy</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">model_history2</span> <span class="op">=</span></span>
<span>  <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">X</span>, y <span class="op">=</span> <span class="va">Y</span>, epochs <span class="op">=</span> <span class="fl">30L</span>, batch_size <span class="op">=</span> <span class="fl">20L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/evaluate.html">evaluate</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span><span class="op">)</span></span>
<span><span class="co">#&gt;                 loss categorical_accuracy </span></span>
<span><span class="co">#&gt;           0.04047703           0.98000002</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model_history2</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_1-1.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb201"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">##########  -&gt; (very) Low learning rate: May take (very) long </span></span>
<span><span class="co">#           (and may need very many epochs) and get stuck in local optima.</span></span>
<span></span>
<span><span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/reset_states.html">reset_states</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html">compile</a></span><span class="op">(</span>loss <span class="op">=</span> <span class="va">loss_categorical_crossentropy</span>,</span>
<span>          <span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_adamax.html">optimizer_adamax</a></span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">0.00001</span><span class="op">)</span>,</span>
<span>          metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">metric_categorical_accuracy</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">model_history3</span> <span class="op">=</span></span>
<span>  <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">X</span>, y <span class="op">=</span> <span class="va">Y</span>, epochs <span class="op">=</span> <span class="fl">30L</span>, batch_size <span class="op">=</span> <span class="fl">20L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/evaluate.html">evaluate</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span><span class="op">)</span></span>
<span><span class="co">#&gt;                 loss categorical_accuracy </span></span>
<span><span class="co">#&gt;           0.04046927           0.98000002</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model_history3</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_1-2.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb202"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/reset_states.html">reset_states</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Try higher epoch number</span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html">compile</a></span><span class="op">(</span>loss <span class="op">=</span> <span class="va">loss_categorical_crossentropy</span>,</span>
<span>          <span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_adamax.html">optimizer_adamax</a></span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">0.00001</span><span class="op">)</span>,</span>
<span>          metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">metric_categorical_accuracy</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">model_history4</span> <span class="op">=</span></span>
<span>  <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">X</span>, y <span class="op">=</span> <span class="va">Y</span>, epochs <span class="op">=</span> <span class="fl">200L</span>, batch_size <span class="op">=</span> <span class="fl">20L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/evaluate.html">evaluate</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span><span class="op">)</span></span>
<span><span class="co">#&gt;                 loss categorical_accuracy </span></span>
<span><span class="co">#&gt;           0.04043195           0.98000002</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model_history4</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_1-3.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb203"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">##########  -&gt; (very) High learning rate (may skip optimum).</span></span>
<span></span>
<span><span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/reset_states.html">reset_states</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html">compile</a></span><span class="op">(</span>loss <span class="op">=</span> <span class="va">loss_categorical_crossentropy</span>,</span>
<span>          <span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_adamax.html">optimizer_adamax</a></span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,</span>
<span>          metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">metric_categorical_accuracy</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">model_history5</span> <span class="op">=</span></span>
<span>  <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">X</span>, y <span class="op">=</span> <span class="va">Y</span>, epochs <span class="op">=</span> <span class="fl">30L</span>, batch_size <span class="op">=</span> <span class="fl">20L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/evaluate.html">evaluate</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span><span class="op">)</span></span>
<span><span class="co">#&gt;                 loss categorical_accuracy </span></span>
<span><span class="co">#&gt;            1.1026534            0.3333333</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model_history5</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_1-4.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb204"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">##########  -&gt; Higher epoch number (possibly better fitting, maybe overfitting).</span></span>
<span></span>
<span><span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/reset_states.html">reset_states</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html">compile</a></span><span class="op">(</span>loss <span class="op">=</span> <span class="va">loss_categorical_crossentropy</span>,</span>
<span>          <span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_adamax.html">optimizer_adamax</a></span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,</span>
<span>          metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">metric_categorical_accuracy</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">model_history6</span> <span class="op">=</span></span>
<span>  <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">X</span>, y <span class="op">=</span> <span class="va">Y</span>, epochs <span class="op">=</span> <span class="fl">100L</span>, batch_size <span class="op">=</span> <span class="fl">20L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/evaluate.html">evaluate</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span><span class="op">)</span></span>
<span><span class="co">#&gt;                 loss categorical_accuracy </span></span>
<span><span class="co">#&gt;            1.1415949            0.3333333</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model_history6</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_1-5.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb205"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">##########</span></span>
<span></span>
<span><span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/reset_states.html">reset_states</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html">compile</a></span><span class="op">(</span>loss <span class="op">=</span> <span class="va">loss_categorical_crossentropy</span>,</span>
<span>          <span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_adamax.html">optimizer_adamax</a></span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>          metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">metric_categorical_accuracy</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">model_history7</span> <span class="op">=</span></span>
<span>  <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">X</span>, y <span class="op">=</span> <span class="va">Y</span>, epochs <span class="op">=</span> <span class="fl">100L</span>, batch_size <span class="op">=</span> <span class="fl">20L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/evaluate.html">evaluate</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span><span class="op">)</span></span>
<span><span class="co">#&gt;                 loss categorical_accuracy </span></span>
<span><span class="co">#&gt;            1.0997989            0.3333333</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model_history7</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_1-6.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb206"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">##########</span></span>
<span></span>
<span><span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/reset_states.html">reset_states</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html">compile</a></span><span class="op">(</span>loss <span class="op">=</span> <span class="va">loss_categorical_crossentropy</span>,</span>
<span>          <span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_adamax.html">optimizer_adamax</a></span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">0.00001</span><span class="op">)</span>,</span>
<span>          metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">metric_categorical_accuracy</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">model_history8</span> <span class="op">=</span></span>
<span>  <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">X</span>, y <span class="op">=</span> <span class="va">Y</span>, epochs <span class="op">=</span> <span class="fl">100L</span>, batch_size <span class="op">=</span> <span class="fl">20L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/evaluate.html">evaluate</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span><span class="op">)</span></span>
<span><span class="co">#&gt;                 loss categorical_accuracy </span></span>
<span><span class="co">#&gt;            1.0997801            0.3333333</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model_history8</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_1-7.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb207"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">##########  -&gt; Lower batch size.</span></span>
<span></span>
<span><span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/reset_states.html">reset_states</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html">compile</a></span><span class="op">(</span>loss <span class="op">=</span> <span class="va">loss_categorical_crossentropy</span>,</span>
<span>          <span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_adamax.html">optimizer_adamax</a></span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,</span>
<span>          metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">metric_categorical_accuracy</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">model_history9</span> <span class="op">=</span></span>
<span>  <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">X</span>, y <span class="op">=</span> <span class="va">Y</span>, epochs <span class="op">=</span> <span class="fl">100L</span>, batch_size <span class="op">=</span> <span class="fl">5L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/evaluate.html">evaluate</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span><span class="op">)</span></span>
<span><span class="co">#&gt;                 loss categorical_accuracy </span></span>
<span><span class="co">#&gt;            1.1278787            0.3333333</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model_history9</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_1-8.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb208"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">##########</span></span>
<span></span>
<span><span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/reset_states.html">reset_states</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html">compile</a></span><span class="op">(</span>loss <span class="op">=</span> <span class="va">loss_categorical_crossentropy</span>,</span>
<span>          <span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_adamax.html">optimizer_adamax</a></span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>          metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">metric_categorical_accuracy</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">model_history10</span> <span class="op">=</span></span>
<span>  <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">X</span>, y <span class="op">=</span> <span class="va">Y</span>, epochs <span class="op">=</span> <span class="fl">100L</span>, batch_size <span class="op">=</span> <span class="fl">5L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/evaluate.html">evaluate</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span><span class="op">)</span></span>
<span><span class="co">#&gt;                 loss categorical_accuracy </span></span>
<span><span class="co">#&gt;            1.1229721            0.3333333</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model_history10</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_1-9.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb209"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">##########</span></span>
<span></span>
<span><span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/reset_states.html">reset_states</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html">compile</a></span><span class="op">(</span>loss <span class="op">=</span> <span class="va">loss_categorical_crossentropy</span>,</span>
<span>          <span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_adamax.html">optimizer_adamax</a></span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">0.00001</span><span class="op">)</span>,</span>
<span>          metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">metric_categorical_accuracy</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">model_history11</span> <span class="op">=</span></span>
<span>  <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">X</span>, y <span class="op">=</span> <span class="va">Y</span>, epochs <span class="op">=</span> <span class="fl">100L</span>, batch_size <span class="op">=</span> <span class="fl">5L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/evaluate.html">evaluate</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span><span class="op">)</span></span>
<span><span class="co">#&gt;                 loss categorical_accuracy </span></span>
<span><span class="co">#&gt;            1.1222010            0.3333333</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model_history11</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_1-10.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb210"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">##########  -&gt; Higher batch size (faster but less accurate).</span></span>
<span></span>
<span><span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/reset_states.html">reset_states</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html">compile</a></span><span class="op">(</span>loss <span class="op">=</span> <span class="va">loss_categorical_crossentropy</span>,</span>
<span>          <span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_adamax.html">optimizer_adamax</a></span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,</span>
<span>          metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">metric_categorical_accuracy</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">model_history12</span> <span class="op">=</span></span>
<span>  <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">X</span>, y <span class="op">=</span> <span class="va">Y</span>, epochs <span class="op">=</span> <span class="fl">100L</span>, batch_size <span class="op">=</span> <span class="fl">50L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/evaluate.html">evaluate</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span><span class="op">)</span></span>
<span><span class="co">#&gt;                 loss categorical_accuracy </span></span>
<span><span class="co">#&gt;            1.1011598            0.3333333</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model_history12</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_1-11.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb211"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">##########</span></span>
<span></span>
<span><span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/reset_states.html">reset_states</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html">compile</a></span><span class="op">(</span>loss <span class="op">=</span> <span class="va">loss_categorical_crossentropy</span>,</span>
<span>          <span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_adamax.html">optimizer_adamax</a></span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>          metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">metric_categorical_accuracy</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">model_history13</span> <span class="op">=</span></span>
<span>  <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">X</span>, y <span class="op">=</span> <span class="va">Y</span>, epochs <span class="op">=</span> <span class="fl">100L</span>, batch_size <span class="op">=</span> <span class="fl">50L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/evaluate.html">evaluate</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span><span class="op">)</span></span>
<span><span class="co">#&gt;                 loss categorical_accuracy </span></span>
<span><span class="co">#&gt;            1.0986328            0.3333333</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model_history13</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_1-12.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb212"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">##########</span></span>
<span></span>
<span><span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/reset_states.html">reset_states</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html">compile</a></span><span class="op">(</span>loss <span class="op">=</span> <span class="va">loss_categorical_crossentropy</span>,</span>
<span>          <span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_adamax.html">optimizer_adamax</a></span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">0.00001</span><span class="op">)</span>,</span>
<span>          metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">metric_categorical_accuracy</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">model_history14</span> <span class="op">=</span></span>
<span>  <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">X</span>, y <span class="op">=</span> <span class="va">Y</span>, epochs <span class="op">=</span> <span class="fl">100L</span>, batch_size <span class="op">=</span> <span class="fl">50L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/evaluate.html">evaluate</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span><span class="op">)</span></span>
<span><span class="co">#&gt;                 loss categorical_accuracy </span></span>
<span><span class="co">#&gt;            1.0986325            0.3333333</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model_history14</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_1-13.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb213"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">####################</span></span>
<span><span class="co">####################</span></span>
<span></span>
<span><span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/reset_states.html">reset_states</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html">compile</a></span><span class="op">(</span>loss <span class="op">=</span> <span class="va">loss_categorical_crossentropy</span>,</span>
<span>          <span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_adamax.html">optimizer_adamax</a></span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span>,</span>
<span>          metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">metric_categorical_accuracy</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">model_history15</span> <span class="op">=</span></span>
<span>  <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">X</span>, y <span class="op">=</span> <span class="va">Y</span>, epochs <span class="op">=</span> <span class="fl">150L</span>, batch_size <span class="op">=</span> <span class="fl">50L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model_history15</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_1-14.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb214"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">##########  -&gt; shuffle = FALSE (some kind of overfitting)</span></span>
<span></span>
<span><span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/reset_states.html">reset_states</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html">compile</a></span><span class="op">(</span>loss <span class="op">=</span> <span class="va">loss_categorical_crossentropy</span>,</span>
<span>          <span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_adamax.html">optimizer_adamax</a></span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span>,</span>
<span>          metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">metric_categorical_accuracy</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">model_history16</span> <span class="op">=</span></span>
<span>  <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">X</span>, y <span class="op">=</span> <span class="va">Y</span>, epochs <span class="op">=</span> <span class="fl">150L</span>, batch_size <span class="op">=</span> <span class="fl">50L</span>, shuffle <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model_history16</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_1-15.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb215"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">##########  -&gt; shuffle = FALSE + lower batch size</span></span>
<span></span>
<span><span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/reset_states.html">reset_states</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html">compile</a></span><span class="op">(</span>loss <span class="op">=</span> <span class="va">loss_categorical_crossentropy</span>,</span>
<span>          <span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_adamax.html">optimizer_adamax</a></span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span>,</span>
<span>          metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">metric_categorical_accuracy</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">model_history17</span> <span class="op">=</span></span>
<span>  <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">X</span>, y <span class="op">=</span> <span class="va">Y</span>, epochs <span class="op">=</span> <span class="fl">150L</span>, batch_size <span class="op">=</span> <span class="fl">5L</span>, shuffle <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model_history17</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_1-16.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb216"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">##########  -&gt; shuffle = FALSE + higher batch size</span></span>
<span><span class="co">#           (Many samples are taken at once, so no "hopping" any longer.)</span></span>
<span></span>
<span><span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/reset_states.html">reset_states</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html">compile</a></span><span class="op">(</span>loss <span class="op">=</span> <span class="va">loss_categorical_crossentropy</span>,</span>
<span>          <span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_adamax.html">optimizer_adamax</a></span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span>,</span>
<span>          metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">metric_categorical_accuracy</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">model_history18</span> <span class="op">=</span></span>
<span>  <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">X</span>, y <span class="op">=</span> <span class="va">Y</span>, epochs <span class="op">=</span> <span class="fl">150L</span>, batch_size <span class="op">=</span> <span class="fl">75L</span>, shuffle <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model_history18</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_1-17.png" width="100%" style="display: block; margin: auto;"></div>
</div>
<div class="panel">
<p><span class="panel-name">Torch</span></p>
<div class="sourceCode" id="cb217"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">opt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/optim_adam.html">optim_adam</a></span><span class="op">(</span>params <span class="op">=</span> <span class="va">model_torch</span><span class="op">$</span><span class="va">parameters</span>, lr <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">batch_size</span> <span class="op">=</span> <span class="fl">20L</span></span>
<span><span class="va">X_torch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="va">Y_torch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="va">Yt</span>, dtype <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_dtype.html">torch_long</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">losses</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fl">500</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">500</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">indices</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, <span class="va">batch_size</span><span class="op">)</span></span>
<span>  <span class="va">opt</span><span class="op">$</span><span class="fu">zero_grad</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">pred</span> <span class="op">=</span> <span class="fu">model_torch</span><span class="op">(</span><span class="va">X_torch</span><span class="op">[</span><span class="va">indices</span>, <span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nnf_cross_entropy.html">nnf_cross_entropy</a></span><span class="op">(</span><span class="va">pred</span>, <span class="va">Y_torch</span><span class="op">[</span><span class="va">indices</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">losses</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">loss</span><span class="op">)</span></span>
<span>  <span class="va">loss</span><span class="op">$</span><span class="fu">sum</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">backward</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">opt</span><span class="op">$</span><span class="fu">step</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">losses</span>, main <span class="op">=</span> <span class="st">"Torch training history"</span>, xlab <span class="op">=</span> <span class="st">"Epoch"</span>, ylab <span class="op">=</span> <span class="st">"Loss"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_1_torch-1.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb218"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">##########</span></span>
<span></span>
<span><span class="co"># reset parameters</span></span>
<span></span>
<span><span class="va">.n</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">model_torch</span><span class="op">$</span><span class="va">children</span>, <span class="kw">function</span><span class="op">(</span><span class="va">layer</span><span class="op">)</span> <span class="op">{</span> <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">layer</span><span class="op">$</span><span class="va">parameters</span><span class="op">)</span><span class="op">)</span> <span class="va">layer</span><span class="op">$</span><span class="fu">reset_parameters</span><span class="op">(</span><span class="op">)</span> <span class="op">}</span> <span class="op">)</span></span>
<span><span class="va">opt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/optim_adam.html">optim_adam</a></span><span class="op">(</span>params <span class="op">=</span> <span class="va">model_torch</span><span class="op">$</span><span class="va">parameters</span>, lr <span class="op">=</span> <span class="fl">5.5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">batch_size</span> <span class="op">=</span> <span class="fl">20L</span></span>
<span><span class="va">X_torch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="va">Y_torch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="va">Yt</span>, dtype <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_dtype.html">torch_long</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">losses</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fl">500</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">500</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">indices</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, <span class="va">batch_size</span><span class="op">)</span></span>
<span>  <span class="va">opt</span><span class="op">$</span><span class="fu">zero_grad</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">pred</span> <span class="op">=</span> <span class="fu">model_torch</span><span class="op">(</span><span class="va">X_torch</span><span class="op">[</span><span class="va">indices</span>, <span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nnf_cross_entropy.html">nnf_cross_entropy</a></span><span class="op">(</span><span class="va">pred</span>, <span class="va">Y_torch</span><span class="op">[</span><span class="va">indices</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">losses</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">loss</span><span class="op">)</span></span>
<span>  <span class="va">loss</span><span class="op">$</span><span class="fu">sum</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">backward</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">opt</span><span class="op">$</span><span class="fu">step</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">losses</span>, main <span class="op">=</span> <span class="st">"Torch training history"</span>, xlab <span class="op">=</span> <span class="st">"Epoch"</span>, ylab <span class="op">=</span> <span class="st">"Loss"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_1_torch-2.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb219"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">##########</span></span>
<span></span>
<span><span class="co"># reset parameters</span></span>
<span></span>
<span><span class="va">.n</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">model_torch</span><span class="op">$</span><span class="va">children</span>, <span class="kw">function</span><span class="op">(</span><span class="va">layer</span><span class="op">)</span> <span class="op">{</span> <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">layer</span><span class="op">$</span><span class="va">parameters</span><span class="op">)</span><span class="op">)</span> <span class="va">layer</span><span class="op">$</span><span class="fu">reset_parameters</span><span class="op">(</span><span class="op">)</span> <span class="op">}</span> <span class="op">)</span></span>
<span><span class="va">opt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/optim_adam.html">optim_adam</a></span><span class="op">(</span>params <span class="op">=</span> <span class="va">model_torch</span><span class="op">$</span><span class="va">parameters</span>, lr <span class="op">=</span> <span class="fl">15.5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">batch_size</span> <span class="op">=</span> <span class="fl">20L</span></span>
<span><span class="va">X_torch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="va">Y_torch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="va">Yt</span>, dtype <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_dtype.html">torch_long</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">losses</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fl">500</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">500</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">indices</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, <span class="va">batch_size</span><span class="op">)</span></span>
<span>  <span class="va">opt</span><span class="op">$</span><span class="fu">zero_grad</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">pred</span> <span class="op">=</span> <span class="fu">model_torch</span><span class="op">(</span><span class="va">X_torch</span><span class="op">[</span><span class="va">indices</span>, <span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nnf_cross_entropy.html">nnf_cross_entropy</a></span><span class="op">(</span><span class="va">pred</span>, <span class="va">Y_torch</span><span class="op">[</span><span class="va">indices</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">losses</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">loss</span><span class="op">)</span></span>
<span>  <span class="va">loss</span><span class="op">$</span><span class="fu">sum</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">backward</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">opt</span><span class="op">$</span><span class="fu">step</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">losses</span>, main <span class="op">=</span> <span class="st">"Torch training history"</span>, xlab <span class="op">=</span> <span class="st">"Epoch"</span>, ylab <span class="op">=</span> <span class="st">"Loss"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_1_torch-3.png" width="100%" style="display: block; margin: auto;"></div>
</div>
</div>
<p>Play around with the parameters on your own!</p>
    
  </details><br><hr>
</div>
</div>
<div id="tree-based-machine-learning-algorithms" class="section level2" number="4.2">
<h2>
<span class="header-section-number">4.2</span> Tree-based Machine Learning Algorithms<a class="anchor" aria-label="anchor" href="#tree-based-machine-learning-algorithms"><i class="fas fa-link"></i></a>
</h2>
<p>Famous machine learning algorithms such as <em>Random Forest</em> and <em>Gradient Boosted trees</em> are based on classification and regression trees.
<strong>Hint</strong>: Tree-based algorithms are not distance based and thus do not need scaling.</p>
<p>If you want to know a little bit more about the concepts described in the following - like decision, classification and regression trees as well as random forests - you might watch the following videos:</p>
<ul>
<li><a href="https://www.youtube.com/watch?v=7VeUPuFGJHk" target="_blank" rel="noopener">Decision trees</a></li>
</ul>
<p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/7VeUPuFGJHk" frameborder="0" allow="accelerometer; autoplay; encrypted-media;
  gyroscope; picture-in-picture" allowfullscreen>
</iframe>
<br>
* <a href="https://www.youtube.com/watch?v=g9c66TUylZ4" target="_blank" rel="noopener">Regression trees</a>
<br><iframe width="560" height="315" src="https://www.youtube.com/embed/g9c66TUylZ4" frameborder="0" allow="accelerometer; autoplay; encrypted-media;
  gyroscope; picture-in-picture" allowfullscreen>
</iframe>
<br>
* <a href="https://www.youtube.com/watch?v=J4Wdy0Wc_xQ" target="_blank" rel="noopener">Random forests</a>
<br><iframe width="560" height="315" src="https://www.youtube.com/embed/J4Wdy0Wc_xQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media;
  gyroscope; picture-in-picture" allowfullscreen>
</iframe>
<br>
* <a href="https://www.youtube.com/watch?v=D0efHEJsfHo" target="_blank" rel="noopener">Pruning trees</a>
<br><iframe width="560" height="315" src="https://www.youtube.com/embed/D0efHEJsfHo" frameborder="0" allow="accelerometer; autoplay; encrypted-media;
  gyroscope; picture-in-picture" allowfullscreen>
</iframe>
<br>
After watching these videos, you should know what the different hyperparameters are doing and how to prevent trees / forests from doing something you don’t want.</p>
<div id="classification-and-regression-trees" class="section level3" number="4.2.1">
<h3>
<span class="header-section-number">4.2.1</span> Classification and Regression Trees<a class="anchor" aria-label="anchor" href="#classification-and-regression-trees"><i class="fas fa-link"></i></a>
</h3>
<p>Tree-based models in general use a series of if-then rules to generate predictions from one or more decision trees.
In this lecture, we will explore regression and classification trees by the example of the airquality data set. There is one important hyperparameter for regression trees: “minsplit.”</p>
<ul>
<li>It controls the depth of tree (see the help of rpart for a description).</li>
<li>It controls the complexity of the tree and can thus also be seen as a regularization parameter.</li>
</ul>
<p>We first prepare and visualize the data and afterwards fit a decision tree.</p>
<div class="sourceCode" id="cb220"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bethatkinson/rpart">rpart</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://www.milbo.org/rpart-plot/index.html">rpart.plot</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">airquality</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">airquality</span><span class="op">)</span>,<span class="op">]</span></span></code></pre></div>
<p>Fit and visualize one(!) regression tree:</p>
<div class="sourceCode" id="cb221"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/rpart/man/rpart.html">rpart</a></span><span class="op">(</span><span class="va">Ozone</span><span class="op">~</span><span class="va">.</span>, data <span class="op">=</span> <span class="va">data</span>, control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/rpart/man/rpart.control.html">rpart.control</a></span><span class="op">(</span>minsplit <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/rpart.plot/man/rpart.plot.html">rpart.plot</a></span><span class="op">(</span><span class="va">rt</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_23-1.png" width="100%" style="display: block; margin: auto;"></div>
<p>Visualize the predictions:</p>
<div class="sourceCode" id="cb222"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">rt</span>, <span class="va">data</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Temp</span>, <span class="va">data</span><span class="op">$</span><span class="va">Ozone</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Temp</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Temp</span><span class="op">)</span><span class="op">]</span>, <span class="va">pred</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Temp</span><span class="op">)</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_24-1.png" width="100%" style="display: block; margin: auto;"></div>
<p>The angular form of the prediction line is typical for regression trees and is a weakness of it.</p>
</div>
<div id="random-forest" class="section level3" number="4.2.2">
<h3>
<span class="header-section-number">4.2.2</span> Random Forest<a class="anchor" aria-label="anchor" href="#random-forest"><i class="fas fa-link"></i></a>
</h3>
<p>To overcome this weakness, a random forest uses an ensemble of regression/classification trees. Thus, the random forest is in principle nothing else than a normal regression/classification tree, but it uses the idea of the <em>“wisdom of the crowd”</em> : By asking many people (regression/classification trees) one can make a more informed decision (prediction/classification). When you want to buy a new phone for example you also wouldn’t go directly into the shop, but search in the internet and ask your friends and family.</p>
<p>There are two randomization steps with the random forest that are responsible for their success:</p>
<ul>
<li>Bootstrap samples for each tree (we will sample observations with replacement from the data set. For the phone this is like not everyone has experience about each phone).</li>
<li>At each split, we will sample a subset of predictors that is then considered as potential splitting criterion (for the phone this is like that not everyone has the same decision criteria).
Annotation: While building a decision tree (random forests consist of many decision trees), one splits the data at some point according to their features. For example if you have females and males, big and small people in a crowd, you con split this crowd by gender and then by size or by size and then by gender to build a decision tree.</li>
</ul>
<p>Applying the random forest follows the same principle as for the methods before: We visualize the data (we have already done this so often for the airquality data set, thus we skip it here), fit the algorithm and then plot the outcomes.</p>
<p>Fit a random forest and visualize the predictions:</p>
<div class="sourceCode" id="cb223"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://www.stat.berkeley.edu/~breiman/RandomForests/">randomForest</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">airquality</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">airquality</span><span class="op">)</span>,<span class="op">]</span></span>
<span></span>
<span><span class="va">rf</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/randomForest/man/randomForest.html">randomForest</a></span><span class="op">(</span><span class="va">Ozone</span><span class="op">~</span><span class="va">.</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span><span class="va">pred</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">rf</span>, <span class="va">data</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">Ozone</span><span class="op">~</span><span class="va">Temp</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Temp</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Temp</span><span class="op">)</span><span class="op">]</span>, <span class="va">pred</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Temp</span><span class="op">)</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_25-1.png" width="100%" style="display: block; margin: auto;"></div>
<p>One advantage of random forests is that we will get an importance of variables. At each split in each tree, the improvement in the split-criterion is the importance measure attributed to the splitting variable, and is accumulated over all the trees in the forest separately for each variable. Thus the variable importance shows us how important a variable is averaged over all trees.</p>
<div class="sourceCode" id="cb224"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rf</span><span class="op">$</span><span class="va">importance</span></span>
<span><span class="co">#&gt;         IncNodePurity</span></span>
<span><span class="co">#&gt; Solar.R      17969.59</span></span>
<span><span class="co">#&gt; Wind         31978.36</span></span>
<span><span class="co">#&gt; Temp         34176.71</span></span>
<span><span class="co">#&gt; Month        10753.73</span></span>
<span><span class="co">#&gt; Day          15436.47</span></span></code></pre></div>
<p>There are several important hyperparameters in a random forest that we can tune to get better results:</p>
<ul>
<li>Similar to the minsplit parameter in regression and classification trees, the hyperparameter “nodesize” controls for complexity <span class="math inline">\(\rightarrow\)</span> Minimum size of terminal nodes in the tree. Setting this number larger causes smaller trees to be grown (and thus take less time). Note that the default values are different for classification (1) and regression (5).</li>
<li>mtry: Number of features randomly sampled as candidates at each split.</li>
</ul>
</div>
<div id="boosted-regression-trees" class="section level3" number="4.2.3">
<h3>
<span class="header-section-number">4.2.3</span> Boosted Regression Trees<a class="anchor" aria-label="anchor" href="#boosted-regression-trees"><i class="fas fa-link"></i></a>
</h3>
<p>Random forests fit hundreds of trees independent of each other. Here, the idea of a boosted regression tree comes in. Maybe we could learn from the errors the previous weak learners made and thus enhance the performance of the algorithm.</p>
<p>A boosted regression tree (BRT) starts with a simple regression tree (weak learner) and then sequentially fits additional trees to improve the results.
There are two different strategies to do so:</p>
<ul>
<li>
<em>AdaBoost</em>: Wrong classified observations (by the previous tree) will get a higher weight and therefore the next trees will focus on difficult/missclassified observations.</li>
<li>
<em>Gradient boosting</em> (state of the art): Each sequential model will be fit on the residual errors of the previous model (strongly simplified, the actual algorithm is very complex).</li>
</ul>
<p>We can fit a boosted regression tree using xgboost, but before we have to transform the data into a xgb.Dmatrix.</p>
<div class="sourceCode" id="cb225"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/dmlc/xgboost">xgboost</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">airquality</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">airquality</span><span class="op">)</span>,<span class="op">]</span></span></code></pre></div>
<div class="sourceCode" id="cb226"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_xg</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.DMatrix.html">xgb.DMatrix</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>, label <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Ozone</span><span class="op">)</span></span>
<span><span class="va">brt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.train.html">xgboost</a></span><span class="op">(</span><span class="va">data_xg</span>, nrounds <span class="op">=</span> <span class="fl">16L</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]  train-rmse:39.724624 </span></span>
<span><span class="co">#&gt; [2]  train-rmse:30.225761 </span></span>
<span><span class="co">#&gt; [3]  train-rmse:23.134840 </span></span>
<span><span class="co">#&gt; [4]  train-rmse:17.899179 </span></span>
<span><span class="co">#&gt; [5]  train-rmse:14.097785 </span></span>
<span><span class="co">#&gt; [6]  train-rmse:11.375457 </span></span>
<span><span class="co">#&gt; [7]  train-rmse:9.391276 </span></span>
<span><span class="co">#&gt; [8]  train-rmse:7.889690 </span></span>
<span><span class="co">#&gt; [9]  train-rmse:6.646586 </span></span>
<span><span class="co">#&gt; [10] train-rmse:5.804859 </span></span>
<span><span class="co">#&gt; [11] train-rmse:5.128437 </span></span>
<span><span class="co">#&gt; [12] train-rmse:4.456416 </span></span>
<span><span class="co">#&gt; [13] train-rmse:4.069464 </span></span>
<span><span class="co">#&gt; [14] train-rmse:3.674615 </span></span>
<span><span class="co">#&gt; [15] train-rmse:3.424578 </span></span>
<span><span class="co">#&gt; [16] train-rmse:3.191301</span></span></code></pre></div>
<p>The parameter “nrounds” controls how many sequential trees we fit, in our example this was 16. When we predict on new data, we can limit the number of trees used to prevent overfitting (remember: each new tree tries to improve the predictions of the previous trees).</p>
<p>Let us visualize the predictions for different numbers of trees:</p>
<div class="sourceCode" id="cb227"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">oldpar</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">pred</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">brt</span>, newdata <span class="op">=</span> <span class="va">data_xg</span>, ntreelimit <span class="op">=</span> <span class="va">i</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Temp</span>, <span class="va">data</span><span class="op">$</span><span class="va">Ozone</span>, main <span class="op">=</span> <span class="va">i</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Temp</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Temp</span><span class="op">)</span><span class="op">]</span>, <span class="va">pred</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Temp</span><span class="op">)</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; [14:25:06] WARNING: amalgamation/../src/c_api/c_api.cc:785: `ntree_limit` is deprecated, use `iteration_range` instead.</span></span>
<span><span class="co">#&gt; [14:25:06] WARNING: amalgamation/../src/c_api/c_api.cc:785: `ntree_limit` is deprecated, use `iteration_range` instead.</span></span>
<span><span class="co">#&gt; [14:25:06] WARNING: amalgamation/../src/c_api/c_api.cc:785: `ntree_limit` is deprecated, use `iteration_range` instead.</span></span>
<span><span class="co">#&gt; [14:25:06] WARNING: amalgamation/../src/c_api/c_api.cc:785: `ntree_limit` is deprecated, use `iteration_range` instead.</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_29__BRT2-1.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb228"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span><span class="va">oldpar</span><span class="op">)</span></span></code></pre></div>
<p>There are also other ways to control for complexity of the boosted regression tree algorithm:</p>
<ul>
<li>max_depth: Maximum depth of each tree.</li>
<li>shrinkage (each tree will get a weight and the weight will decrease with the number of trees).</li>
</ul>
<p>When having specified the final model, we can obtain the importance of the variables like for random forests:</p>
<div class="sourceCode" id="cb229"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">xgboost</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.importance.html">xgb.importance</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">brt</span><span class="op">)</span></span>
<span><span class="co">#&gt;    Feature        Gain     Cover  Frequency</span></span>
<span><span class="co">#&gt; 1:    Temp 0.570071903 0.2958229 0.24836601</span></span>
<span><span class="co">#&gt; 2:    Wind 0.348230710 0.3419576 0.24183007</span></span>
<span><span class="co">#&gt; 3: Solar.R 0.058795542 0.1571072 0.30718954</span></span>
<span><span class="co">#&gt; 4:     Day 0.019529993 0.1779925 0.16993464</span></span>
<span><span class="co">#&gt; 5:   Month 0.003371853 0.0271197 0.03267974</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Ozone</span> <span class="op">-</span> <span class="va">pred</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="co"># RMSE</span></span>
<span><span class="co">#&gt; [1] 17.89918</span></span>
<span><span class="va">data_xg</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.DMatrix.html">xgb.DMatrix</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>, label <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Ozone</span><span class="op">)</span></span></code></pre></div>
<p>One important strength of xgboost is that we can directly do a cross-validation (which is independent of the boosted regression tree itself!) and specify its properties with the parameter “n-fold”:</p>
<div class="sourceCode" id="cb230"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="va">brt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.train.html">xgboost</a></span><span class="op">(</span><span class="va">data_xg</span>, nrounds <span class="op">=</span> <span class="fl">5L</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]  train-rmse:39.724624 </span></span>
<span><span class="co">#&gt; [2]  train-rmse:30.225761 </span></span>
<span><span class="co">#&gt; [3]  train-rmse:23.134840 </span></span>
<span><span class="co">#&gt; [4]  train-rmse:17.899179 </span></span>
<span><span class="co">#&gt; [5]  train-rmse:14.097785</span></span>
<span><span class="va">brt_cv</span> <span class="op">=</span> <span class="fu">xgboost</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.cv.html">xgb.cv</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data_xg</span>, nfold <span class="op">=</span> <span class="fl">3L</span>,</span>
<span>                         nrounds <span class="op">=</span> <span class="fl">3L</span>, nthreads <span class="op">=</span> <span class="fl">4L</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]  train-rmse:39.895106+2.127355   test-rmse:40.685477+5.745327 </span></span>
<span><span class="co">#&gt; [2]  train-rmse:30.367660+1.728788   test-rmse:32.255812+5.572963 </span></span>
<span><span class="co">#&gt; [3]  train-rmse:23.446237+1.366757   test-rmse:27.282435+5.746244</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">brt_cv</span><span class="op">)</span></span>
<span><span class="co">#&gt; ##### xgb.cv 3-folds</span></span>
<span><span class="co">#&gt;  iter train_rmse_mean train_rmse_std test_rmse_mean test_rmse_std</span></span>
<span><span class="co">#&gt;     1        39.89511       2.127355       40.68548      5.745327</span></span>
<span><span class="co">#&gt;     2        30.36766       1.728788       32.25581      5.572963</span></span>
<span><span class="co">#&gt;     3        23.44624       1.366757       27.28244      5.746244</span></span></code></pre></div>
<p>Annotation: The original data set is randomly partitioned into <span class="math inline">\(n\)</span> equal sized subsamples. Each time, the model is trained on <span class="math inline">\(n - 1\)</span> subsets (training set) and tested on the left out set (test set) to judge the performance.</p>
<p>If we do three-folded cross-validation, we actually fit three different boosted regression tree models (xgboost models) on <span class="math inline">\(\approx 67\%\)</span> of the data points. Afterwards, we judge the performance on the respective holdout. This now tells us how well the model performed.</p>
</div>
<div id="exercises-3" class="section level3" number="4.2.4">
<h3>
<span class="header-section-number">4.2.4</span> Exercises<a class="anchor" aria-label="anchor" href="#exercises-3"><i class="fas fa-link"></i></a>
</h3>
  <hr>
<strong><span style="color: #0011AA; font-size:18px;">1. Task</span></strong><br><p>We will use the following code snippet to see the influence of mincut on trees.</p>
<div class="sourceCode" id="cb231"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">tree</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">airquality</span></span>
<span><span class="va">rt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/tree/man/tree.html">tree</a></span><span class="op">(</span><span class="va">Ozone</span><span class="op">~</span><span class="va">.</span>, data <span class="op">=</span> <span class="va">data</span>,</span>
<span>          control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/tree/man/tree.control.html">tree.control</a></span><span class="op">(</span>mincut <span class="op">=</span> <span class="fl">1L</span>, nobs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">rt</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="va">rt</span><span class="op">)</span></span>
<span><span class="va">pred</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">rt</span>, <span class="va">data</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Temp</span>, <span class="va">data</span><span class="op">$</span><span class="va">Ozone</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Temp</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Temp</span><span class="op">)</span><span class="op">]</span>, <span class="va">pred</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Temp</span><span class="op">)</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Ozone</span> <span class="op">-</span> <span class="va">pred</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="co"># RMSE</span></span></code></pre></div>
<p>Try different mincut parameters and see what happens.
(Compare the root mean squared error for different mincut parameters and explain what you see.
Compare predictions for different mincut parameters and explain what happens.)
What was wrong in the snippet above?</p>
  <details><summary><strong><span style="color: #0011AA; font-size:18px;">Solution</span></strong>
    </summary><p>
</p>
<div class="sourceCode" id="cb232"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">tree</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">airquality</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">airquality</span><span class="op">)</span>,<span class="op">]</span></span>
<span></span>
<span><span class="va">doTask</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">mincut</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">rt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/tree/man/tree.html">tree</a></span><span class="op">(</span><span class="va">Ozone</span><span class="op">~</span><span class="va">.</span>, data <span class="op">=</span> <span class="va">data</span>,</span>
<span>            control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/tree/man/tree.control.html">tree.control</a></span><span class="op">(</span>mincut <span class="op">=</span> <span class="va">mincut</span>, nobs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">pred</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">rt</span>, <span class="va">data</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Temp</span>, <span class="va">data</span><span class="op">$</span><span class="va">Ozone</span>,</span>
<span>       main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span></span>
<span>         <span class="st">"mincut: "</span>, <span class="va">mincut</span>,</span>
<span>         <span class="st">"\nRMSE: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Ozone</span> <span class="op">-</span> <span class="va">pred</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Temp</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Temp</span><span class="op">)</span><span class="op">]</span>, <span class="va">pred</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Temp</span><span class="op">)</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">5</span>, <span class="fl">10</span>, <span class="fl">15</span>, <span class="fl">25</span>, <span class="fl">50</span>, <span class="fl">54</span>, <span class="fl">55</span>, <span class="fl">56</span>, <span class="fl">57</span>, <span class="fl">75</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span><span class="op">{</span> <span class="fu">doTask</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">}</span></span></code></pre></div>
<p><img src="05-fundamental_files/figure-html/chunk_chapter4_task_22-1.png" width="100%" style="display: block; margin: auto;"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_22-2.png" width="100%" style="display: block; margin: auto;"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_22-3.png" width="100%" style="display: block; margin: auto;"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_22-4.png" width="100%" style="display: block; margin: auto;"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_22-5.png" width="100%" style="display: block; margin: auto;"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_22-6.png" width="100%" style="display: block; margin: auto;"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_22-7.png" width="100%" style="display: block; margin: auto;"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_22-8.png" width="100%" style="display: block; margin: auto;"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_22-9.png" width="100%" style="display: block; margin: auto;"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_22-10.png" width="100%" style="display: block; margin: auto;"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_22-11.png" width="100%" style="display: block; margin: auto;"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_22-12.png" width="100%" style="display: block; margin: auto;"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_22-13.png" width="100%" style="display: block; margin: auto;"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_22-14.png" width="100%" style="display: block; margin: auto;">
Approximately at mincut = 15, prediction is the best (mind overfitting). After mincut = 56, the prediction has no information at all and the RMSE stays constant.</p>
<p>Mind the complete cases of the airquality data set, that was the error.</p>
    
  </details><br><hr>
<hr>
<strong><span style="color: #0011AA; font-size:18px;">2. Task</span></strong><br><p>We will use the following code snippet to explore a random forest:</p>
<div class="sourceCode" id="cb233"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://www.stat.berkeley.edu/~breiman/RandomForests/">randomForest</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">airquality</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">airquality</span><span class="op">)</span>,<span class="op">]</span></span>
<span></span>
<span><span class="va">rf</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/randomForest/man/randomForest.html">randomForest</a></span><span class="op">(</span><span class="va">Ozone</span><span class="op">~</span><span class="va">.</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pred</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">rf</span>, <span class="va">data</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/randomForest/man/importance.html">importance</a></span><span class="op">(</span><span class="va">rf</span><span class="op">)</span></span>
<span><span class="co">#&gt;         IncNodePurity</span></span>
<span><span class="co">#&gt; Solar.R      17969.59</span></span>
<span><span class="co">#&gt; Wind         31978.36</span></span>
<span><span class="co">#&gt; Temp         34176.71</span></span>
<span><span class="co">#&gt; Month        10753.73</span></span>
<span><span class="co">#&gt; Day          15436.47</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"RMSE: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Ozone</span> <span class="op">-</span> <span class="va">pred</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; RMSE:  9.507848</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Temp</span>, <span class="va">data</span><span class="op">$</span><span class="va">Ozone</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Temp</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Temp</span><span class="op">)</span><span class="op">]</span>, <span class="va">pred</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Temp</span><span class="op">)</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_23-1.png" width="100%" style="display: block; margin: auto;"></div>
<p>Try different values for the nodesize and mtry and describe how the predictions depend on these parameters.</p>
  <details><summary><strong><span style="color: #0011AA; font-size:18px;">Solution</span></strong>
    </summary><p>
</p>
<div class="sourceCode" id="cb234"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://www.stat.berkeley.edu/~breiman/RandomForests/">randomForest</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">airquality</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">airquality</span><span class="op">)</span>,<span class="op">]</span></span>
<span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">nodesize</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">5</span>, <span class="fl">15</span>, <span class="fl">50</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">mtry</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">rf</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/randomForest/man/randomForest.html">randomForest</a></span><span class="op">(</span><span class="va">Ozone</span><span class="op">~</span><span class="va">.</span>, data <span class="op">=</span> <span class="va">data</span>, mtry <span class="op">=</span> <span class="va">mtry</span>, nodesize <span class="op">=</span> <span class="va">nodesize</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">pred</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">rf</span>, <span class="va">data</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Temp</span>, <span class="va">data</span><span class="op">$</span><span class="va">Ozone</span>, main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span></span>
<span>        <span class="st">"mtry: "</span>, <span class="va">mtry</span>, <span class="st">"    nodesize: "</span>, <span class="va">nodesize</span>,</span>
<span>        <span class="st">"\nRMSE: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Ozone</span> <span class="op">-</span> <span class="va">pred</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Temp</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Temp</span><span class="op">)</span><span class="op">]</span>, <span class="va">pred</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Temp</span><span class="op">)</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="05-fundamental_files/figure-html/chunk_chapter4_task_24-1.png" width="100%" style="display: block; margin: auto;"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_24-2.png" width="100%" style="display: block; margin: auto;"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_24-3.png" width="100%" style="display: block; margin: auto;"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_24-4.png" width="100%" style="display: block; margin: auto;"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_24-5.png" width="100%" style="display: block; margin: auto;"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_24-6.png" width="100%" style="display: block; margin: auto;"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_24-7.png" width="100%" style="display: block; margin: auto;"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_24-8.png" width="100%" style="display: block; margin: auto;"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_24-9.png" width="100%" style="display: block; margin: auto;"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_24-10.png" width="100%" style="display: block; margin: auto;"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_24-11.png" width="100%" style="display: block; margin: auto;"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_24-12.png" width="100%" style="display: block; margin: auto;"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_24-13.png" width="100%" style="display: block; margin: auto;"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_24-14.png" width="100%" style="display: block; margin: auto;"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_24-15.png" width="100%" style="display: block; margin: auto;"></p>
<p>Higher numbers for mtry smooth the prediction curve and yield less overfitting. The same holds for the nodesize.
In other words: The bigger the nodesize, the smaller the trees and the more bias/less variance.</p>
    
  </details><br><hr>
<hr>
<strong><span style="color: #0011AA; font-size:18px;">3. Task</span></strong><br><div class="sourceCode" id="cb235"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/dmlc/xgboost">xgboost</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://yihui.org/animation/">animation</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="va">x1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>, <span class="fl">3</span>, length.out <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">x2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>, <span class="fl">3</span>, length.out <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span><span class="va">x1</span>, <span class="va">x2</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">t</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">^</span><span class="fl">2</span> <span class="op">-</span> <span class="va">t</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/image.html">image</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">y</span>, <span class="fl">100</span>, <span class="fl">100</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">"Original image"</span>, axes <span class="op">=</span> <span class="cn">FALSE</span>, las <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html">axis</a></span><span class="op">(</span><span class="fl">1</span>, at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, length.out <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>     labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>, <span class="fl">3</span>, length.out <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html">axis</a></span><span class="op">(</span><span class="fl">2</span>, at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, length.out <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>     labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>, <span class="fl">3</span>, length.out <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>, las <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">model</span> <span class="op">=</span> <span class="fu">xgboost</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.train.html">xgboost</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.DMatrix.html">xgb.DMatrix</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, label <span class="op">=</span> <span class="va">y</span><span class="op">)</span>,</span>
<span>                         nrounds <span class="op">=</span> <span class="fl">500L</span>, verbose <span class="op">=</span> <span class="fl">0L</span><span class="op">)</span></span>
<span><span class="va">pred</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">model</span>, newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.DMatrix.html">xgb.DMatrix</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>,</span>
<span>               ntreelimit <span class="op">=</span> <span class="fl">10L</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/animation/man/saveGIF.html">saveGIF</a></span><span class="op">(</span></span>
<span>  <span class="op">{</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">4</span>, <span class="fl">8</span>, <span class="fl">12</span>, <span class="fl">20</span>, <span class="fl">40</span>, <span class="fl">80</span>, <span class="fl">200</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="va">pred</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">model</span>, newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.DMatrix.html">xgb.DMatrix</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                     ntreelimit <span class="op">=</span> <span class="va">i</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/graphics/image.html">image</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">pred</span>, <span class="fl">100</span>, <span class="fl">100</span><span class="op">)</span>, main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Trees: "</span>, <span class="va">i</span><span class="op">)</span>,</span>
<span>            axes <span class="op">=</span> <span class="cn">FALSE</span>, las <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/graphics/axis.html">axis</a></span><span class="op">(</span><span class="fl">1</span>, at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, length.out <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>           labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>, <span class="fl">3</span>, length.out <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/graphics/axis.html">axis</a></span><span class="op">(</span><span class="fl">2</span>, at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, length.out <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>           labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>, <span class="fl">3</span>, length.out <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>, las <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span>,</span>
<span>  movie.name <span class="op">=</span> <span class="st">"boosting.gif"</span>, autobrowse <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="images/boosting.gif" width="100%" style="display: block; margin: auto;"></div>
<p>Run the above code and play with different parameters for xgboost (especially with parameters that control the complexity) and describe what you see!</p>
<p>Tip: have a look at the boosting.gif.</p>
  <details><summary><strong><span style="color: #0011AA; font-size:18px;">Solution</span></strong>
    </summary><p>
</p>
<div class="sourceCode" id="cb236"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/dmlc/xgboost">xgboost</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://yihui.org/animation/">animation</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="va">x1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>, <span class="fl">3</span>, length.out <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">x2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>, <span class="fl">3</span>, length.out <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span><span class="va">x1</span>, <span class="va">x2</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">t</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">^</span><span class="fl">2</span> <span class="op">-</span> <span class="va">t</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/image.html">image</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">y</span>, <span class="fl">100</span>, <span class="fl">100</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">"Original image"</span>, axes <span class="op">=</span> <span class="cn">FALSE</span>, las <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html">axis</a></span><span class="op">(</span><span class="fl">1</span>, at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, length.out <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>     labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>, <span class="fl">3</span>, length.out <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html">axis</a></span><span class="op">(</span><span class="fl">2</span>, at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, length.out <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>     labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>, <span class="fl">3</span>, length.out <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>, las <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">eta</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.1</span>, <span class="fl">.3</span>, <span class="fl">.5</span>, <span class="fl">.7</span>, <span class="fl">.9</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">max_depth</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">6</span>, <span class="fl">10</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">model</span> <span class="op">=</span> <span class="fu">xgboost</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.train.html">xgboost</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.DMatrix.html">xgb.DMatrix</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, label <span class="op">=</span> <span class="va">y</span><span class="op">)</span>,</span>
<span>                             max_depth <span class="op">=</span> <span class="va">max_depth</span>, eta <span class="op">=</span> <span class="va">eta</span>,</span>
<span>                             nrounds <span class="op">=</span> <span class="fl">500</span>, verbose <span class="op">=</span> <span class="fl">0L</span><span class="op">)</span></span>
<span>  </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/animation/man/saveGIF.html">saveGIF</a></span><span class="op">(</span></span>
<span>      <span class="op">{</span></span>
<span>        <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">4</span>, <span class="fl">8</span>, <span class="fl">12</span>, <span class="fl">20</span>, <span class="fl">40</span>, <span class="fl">80</span>, <span class="fl">200</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>          <span class="va">pred</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">model</span>, newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.DMatrix.html">xgb.DMatrix</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                         ntreelimit <span class="op">=</span> <span class="va">i</span><span class="op">)</span></span>
<span>          <span class="fu"><a href="https://rdrr.io/r/graphics/image.html">image</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">pred</span>, <span class="fl">100</span>, <span class="fl">100</span><span class="op">)</span>,</span>
<span>                main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"eta: "</span>, <span class="va">eta</span>,</span>
<span>                              <span class="st">"    max_depth: "</span>, <span class="va">max_depth</span>,</span>
<span>                              <span class="st">"    Trees: "</span>, <span class="va">i</span><span class="op">)</span>,</span>
<span>                axes <span class="op">=</span> <span class="cn">FALSE</span>, las <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>          <span class="fu"><a href="https://rdrr.io/r/graphics/axis.html">axis</a></span><span class="op">(</span><span class="fl">1</span>, at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, length.out <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>               labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>, <span class="fl">3</span>, length.out <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>          <span class="fu"><a href="https://rdrr.io/r/graphics/axis.html">axis</a></span><span class="op">(</span><span class="fl">2</span>, at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, length.out <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>               labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>, <span class="fl">3</span>, length.out <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>, las <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>      <span class="op">}</span>,</span>
<span>      movie.name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"boosting_"</span>, <span class="va">max_depth</span>, <span class="st">"_"</span>, <span class="va">eta</span>, <span class="st">".gif"</span><span class="op">)</span>,</span>
<span>      autobrowse <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>As the possibilities scale extremely, you must vary some parameters on yourself.
You may use for example the following parameters: “eta,” “gamma,” “max_depth,” “min_child_weight,” “subsample,” “colsample_bytree,” “num_parallel_tree,” “monotone_constraints” or “interaction_constraints.” Or you look into the documentation:</p>
<div class="sourceCode" id="cb237"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">?</span><span class="fu">xgboost</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/xgboost/man/xgb.train.html">xgboost</a></span></span></code></pre></div>
<p>Just some examples:</p>
<p><img src="images/boosting_3_0.1.gif" width="100%" style="display: block; margin: auto;"><img src="images/boosting_6_0.7.gif" width="100%" style="display: block; margin: auto;"><img src="images/boosting_20_0.9.gif" width="100%" style="display: block; margin: auto;"></p>
    
  </details><br><hr>
<strong><span style="color: #0011AA; font-size:18px;">4. Task</span></strong><br><p>We implemented a simplified boosted regression tree using R just for fun.
Go through the code line by line and try to understand it. Ask, if you have any questions you cannot solve.</p>
  <details><summary><strong><span style="color: #0011AA; font-size:18px;">Solution</span></strong>
    </summary><p>
</p>
<div class="sourceCode" id="cb238"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">tree</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="va">depth</span> <span class="op">=</span> <span class="fl">1L</span></span>
<span></span>
<span><span class="co">#### Simulate Data</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1000</span>, <span class="op">-</span><span class="fl">5</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="va">x</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">sin</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1000</span>, <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">cos</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1.8</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">x</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_30-1.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb239"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#### Helper function for single tree fit.</span></span>
<span><span class="va">get_model</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">control</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/tree/man/tree.control.html">tree.control</a></span><span class="op">(</span>nobs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, mincut <span class="op">=</span> <span class="fl">20L</span><span class="op">)</span></span>
<span>  <span class="va">model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/tree/man/tree.html">tree</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span>, control <span class="op">=</span> <span class="va">control</span><span class="op">)</span></span>
<span>  <span class="va">pred</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">model</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">model</span>, pred <span class="op">=</span> <span class="va">pred</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#### Boost function.</span></span>
<span><span class="va">get_boosting_model</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">depth</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">pred</span> <span class="op">=</span> <span class="cn">NULL</span></span>
<span>  <span class="va">m_list</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">depth</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="va">i</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="va">m</span> <span class="op">=</span> <span class="fu">get_model</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span></span>
<span>      <span class="va">pred</span> <span class="op">=</span> <span class="va">m</span><span class="op">$</span><span class="va">pred</span></span>
<span>    <span class="op">}</span><span class="kw">else</span><span class="op">{</span></span>
<span>      <span class="va">y_res</span> <span class="op">=</span> <span class="va">y</span> <span class="op">-</span> <span class="va">pred</span></span>
<span>      <span class="va">m</span> <span class="op">=</span> <span class="fu">get_model</span><span class="op">(</span><span class="va">x</span>, <span class="va">y_res</span><span class="op">)</span></span>
<span>      <span class="va">pred</span> <span class="op">=</span> <span class="va">pred</span> <span class="op">+</span> <span class="va">m</span><span class="op">$</span><span class="va">pred</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">m_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="va">m</span><span class="op">$</span><span class="va">model</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">model_list</span> <span class="op">&lt;&lt;-</span> <span class="va">m_list</span>  <span class="co"># This writes outside function scope!</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">pred</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">### Main.</span></span>
<span><span class="va">pred</span> <span class="op">=</span> <span class="fu">get_boosting_model</span><span class="op">(</span><span class="fl">10L</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">model_list</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 10</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model_list</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_30-2.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb240"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">]</span>, <span class="fu">get_boosting_model</span><span class="op">(</span><span class="fl">1L</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">]</span>,</span>
<span>      col <span class="op">=</span> <span class="st">'red'</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">]</span>, <span class="fu">get_boosting_model</span><span class="op">(</span><span class="fl">100L</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">]</span>,</span>
<span>      col <span class="op">=</span> <span class="st">'green'</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_30-3.png" width="100%" style="display: block; margin: auto;"></div>
    
  </details><br><hr>
</div>
</div>
<div id="distance-based-algorithms" class="section level2" number="4.3">
<h2>
<span class="header-section-number">4.3</span> Distance-based Algorithms<a class="anchor" aria-label="anchor" href="#distance-based-algorithms"><i class="fas fa-link"></i></a>
</h2>
<p>In this chapter, we introduce support-vector machines (SVMs) and other distance-based methods
<strong>Hint</strong>: Distance-based models need scaling!</p>
<div id="k-nearest-neighbor" class="section level3" number="4.3.1">
<h3>
<span class="header-section-number">4.3.1</span> K-Nearest-Neighbor<a class="anchor" aria-label="anchor" href="#k-nearest-neighbor"><i class="fas fa-link"></i></a>
</h3>
<p>K-nearest-neighbor (kNN) is a simple algorithm that stores all the available cases and classifies the new data based on a similarity measure. It is mostly used to classify a data point based on how its <span class="math inline">\(k\)</span> nearest neighbors are classified.</p>
<p>Let us first see an example:</p>
<div class="sourceCode" id="cb241"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">iris</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="va">iris</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="op">-</span><span class="fl">100</span>,<span class="fl">1</span><span class="op">]</span>, <span class="va">x</span><span class="op">[</span><span class="op">-</span><span class="fl">100</span>, <span class="fl">3</span><span class="op">]</span>, col <span class="op">=</span> <span class="va">y</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">100</span>,<span class="fl">1</span><span class="op">]</span>, <span class="va">x</span><span class="op">[</span><span class="fl">100</span>, <span class="fl">3</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">"blue"</span>, pch <span class="op">=</span> <span class="fl">18</span>, cex <span class="op">=</span> <span class="fl">1.3</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_32-1.png" width="100%" style="display: block; margin: auto;"></div>
<p>Which class would you decide for the blue point? What are the classes of the nearest points? Well, this procedure is used by the k-nearest-neighbors classifier and thus there is actually no “real” learning in a k-nearest-neighbors classification.</p>
<p>For applying a k-nearest-neighbors classification, we first have to scale the data set, because we deal with distances and want the same influence of all predictors. Imagine one variable has values from -10.000 to 10.000 and another from -1 to 1. Then the influence of the first variable on the distance to the other points is much stronger than the influence of the second variable.
On the iris data set, we have to split the data into training and test set on our own. Then we will follow the usual pipeline.</p>
<div class="sourceCode" id="cb242"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">=</span> <span class="va">iris</span></span>
<span><span class="va">data</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span>,<span class="fl">2</span>, <span class="va">scale</span><span class="op">)</span></span>
<span><span class="va">indices</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, <span class="fl">0.7</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">train</span> <span class="op">=</span> <span class="va">data</span><span class="op">[</span><span class="va">indices</span>,<span class="op">]</span></span>
<span><span class="va">test</span> <span class="op">=</span> <span class="va">data</span><span class="op">[</span><span class="op">-</span><span class="va">indices</span>,<span class="op">]</span></span></code></pre></div>
<p>Fit model and create predictions:</p>
<div class="sourceCode" id="cb243"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/KlausVigo/kknn">kknn</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="va">knn</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/kknn/man/kknn.html">kknn</a></span><span class="op">(</span><span class="va">Species</span><span class="op">~</span><span class="va">.</span>, train <span class="op">=</span> <span class="va">train</span>, test <span class="op">=</span> <span class="va">test</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">knn</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; kknn(formula = Species ~ ., train = train, test = test)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Response: "nominal"</span></span>
<span><span class="co">#&gt;           fit prob.setosa prob.versicolor prob.virginica</span></span>
<span><span class="co">#&gt; 1      setosa           1      0.00000000      0.0000000</span></span>
<span><span class="co">#&gt; 2      setosa           1      0.00000000      0.0000000</span></span>
<span><span class="co">#&gt; 3      setosa           1      0.00000000      0.0000000</span></span>
<span><span class="co">#&gt; 4      setosa           1      0.00000000      0.0000000</span></span>
<span><span class="co">#&gt; 5      setosa           1      0.00000000      0.0000000</span></span>
<span><span class="co">#&gt; 6      setosa           1      0.00000000      0.0000000</span></span>
<span><span class="co">#&gt; 7      setosa           1      0.00000000      0.0000000</span></span>
<span><span class="co">#&gt; 8      setosa           1      0.00000000      0.0000000</span></span>
<span><span class="co">#&gt; 9      setosa           1      0.00000000      0.0000000</span></span>
<span><span class="co">#&gt; 10     setosa           1      0.00000000      0.0000000</span></span>
<span><span class="co">#&gt; 11     setosa           1      0.00000000      0.0000000</span></span>
<span><span class="co">#&gt; 12     setosa           1      0.00000000      0.0000000</span></span>
<span><span class="co">#&gt; 13     setosa           1      0.00000000      0.0000000</span></span>
<span><span class="co">#&gt; 14 versicolor           0      0.86605852      0.1339415</span></span>
<span><span class="co">#&gt; 15 versicolor           0      0.74027417      0.2597258</span></span>
<span><span class="co">#&gt; 16 versicolor           0      0.91487300      0.0851270</span></span>
<span><span class="co">#&gt; 17 versicolor           0      0.98430840      0.0156916</span></span>
<span><span class="co">#&gt; 18 versicolor           0      0.91487300      0.0851270</span></span>
<span><span class="co">#&gt; 19 versicolor           0      1.00000000      0.0000000</span></span>
<span><span class="co">#&gt; 20 versicolor           0      1.00000000      0.0000000</span></span>
<span><span class="co">#&gt; 21 versicolor           0      1.00000000      0.0000000</span></span>
<span><span class="co">#&gt; 22 versicolor           0      1.00000000      0.0000000</span></span>
<span><span class="co">#&gt; 23 versicolor           0      1.00000000      0.0000000</span></span>
<span><span class="co">#&gt; 24 versicolor           0      1.00000000      0.0000000</span></span>
<span><span class="co">#&gt; 25 versicolor           0      1.00000000      0.0000000</span></span>
<span><span class="co">#&gt; 26 versicolor           0      1.00000000      0.0000000</span></span>
<span><span class="co">#&gt; 27 versicolor           0      0.86605852      0.1339415</span></span>
<span><span class="co">#&gt; 28 versicolor           0      1.00000000      0.0000000</span></span>
<span><span class="co">#&gt; 29  virginica           0      0.00000000      1.0000000</span></span>
<span><span class="co">#&gt; 30  virginica           0      0.00000000      1.0000000</span></span>
<span><span class="co">#&gt; 31  virginica           0      0.00000000      1.0000000</span></span>
<span><span class="co">#&gt; 32  virginica           0      0.00000000      1.0000000</span></span>
<span><span class="co">#&gt; 33  virginica           0      0.08512700      0.9148730</span></span>
<span><span class="co">#&gt; 34  virginica           0      0.22169561      0.7783044</span></span>
<span><span class="co">#&gt; 35  virginica           0      0.00000000      1.0000000</span></span>
<span><span class="co">#&gt; 36  virginica           0      0.23111986      0.7688801</span></span>
<span><span class="co">#&gt; 37 versicolor           0      1.00000000      0.0000000</span></span>
<span><span class="co">#&gt; 38  virginica           0      0.04881448      0.9511855</span></span>
<span><span class="co">#&gt; 39 versicolor           0      0.64309579      0.3569042</span></span>
<span><span class="co">#&gt; 40 versicolor           0      0.67748579      0.3225142</span></span>
<span><span class="co">#&gt; 41  virginica           0      0.17288113      0.8271189</span></span>
<span><span class="co">#&gt; 42  virginica           0      0.00000000      1.0000000</span></span>
<span><span class="co">#&gt; 43  virginica           0      0.00000000      1.0000000</span></span>
<span><span class="co">#&gt; 44  virginica           0      0.00000000      1.0000000</span></span>
<span><span class="co">#&gt; 45  virginica           0      0.35690421      0.6430958</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">test</span><span class="op">$</span><span class="va">Species</span>, <span class="fu"><a href="https://rdrr.io/r/stats/fitted.values.html">fitted</a></span><span class="op">(</span><span class="va">knn</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;             </span></span>
<span><span class="co">#&gt;              setosa versicolor virginica</span></span>
<span><span class="co">#&gt;   setosa         13          0         0</span></span>
<span><span class="co">#&gt;   versicolor      0         15         0</span></span>
<span><span class="co">#&gt;   virginica       0          3        14</span></span></code></pre></div>
</div>
<div id="support-vector-machines-svms" class="section level3" number="4.3.2">
<h3>
<span class="header-section-number">4.3.2</span> Support Vector Machines (SVMs)<a class="anchor" aria-label="anchor" href="#support-vector-machines-svms"><i class="fas fa-link"></i></a>
</h3>
<p>Support vectors machines have a different approach. They try to divide the predictor space into sectors for each class. To do so, a support-vector machine fits the parameters of a hyperplane (a <span class="math inline">\(n-1\)</span> dimensional subspace in a <span class="math inline">\(n\)</span>-dimensional space) in the predictor space by optimizing the distance between the hyperplane and the nearest point from each class.</p>
<p>Fitting a support-vector machine:</p>
<div class="sourceCode" id="cb244"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">e1071</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">iris</span></span>
<span><span class="va">data</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span>, <span class="fl">2</span>, <span class="va">scale</span><span class="op">)</span></span>
<span><span class="va">indices</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, <span class="fl">0.7</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">train</span> <span class="op">=</span> <span class="va">data</span><span class="op">[</span><span class="va">indices</span>,<span class="op">]</span></span>
<span><span class="va">test</span> <span class="op">=</span> <span class="va">data</span><span class="op">[</span><span class="op">-</span><span class="va">indices</span>,<span class="op">]</span></span>
<span></span>
<span><span class="va">sm</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/e1071/man/svm.html">svm</a></span><span class="op">(</span><span class="va">Species</span><span class="op">~</span><span class="va">.</span>, data <span class="op">=</span> <span class="va">train</span>, kernel <span class="op">=</span> <span class="st">"linear"</span><span class="op">)</span></span>
<span><span class="va">pred</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">sm</span>, newdata <span class="op">=</span> <span class="va">test</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb245"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">oldpar</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">test</span><span class="op">$</span><span class="va">Sepal.Length</span>, <span class="va">test</span><span class="op">$</span><span class="va">Petal.Length</span>,</span>
<span>     col <span class="op">=</span>  <span class="va">pred</span>, main <span class="op">=</span> <span class="st">"predicted"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">test</span><span class="op">$</span><span class="va">Sepal.Length</span>, <span class="va">test</span><span class="op">$</span><span class="va">Petal.Length</span>,</span>
<span>     col <span class="op">=</span>  <span class="va">test</span><span class="op">$</span><span class="va">Species</span>, main <span class="op">=</span> <span class="st">"observed"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_36-1.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb246"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span><span class="va">oldpar</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">pred</span> <span class="op">==</span> <span class="va">test</span><span class="op">$</span><span class="va">Species</span><span class="op">)</span> <span class="co"># Accuracy.</span></span>
<span><span class="co">#&gt; [1] 0.9777778</span></span></code></pre></div>
<p>Support-vector machines can only work on linearly separable problems. (A problem is called linearly separable if there exists at least one line in the plane with all of the points of one class on one side of the hyperplane and all the points of the others classes on the other side).</p>
<p>If this is not possible, we however, can use the so called <em>kernel trick</em>, which maps the predictor space into a (higher dimensional) space in which the problem is linear separable. After having identified the boundaries in the higher-dimensional space, we can project them back into the original dimensions.</p>
<div class="sourceCode" id="cb247"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>, <span class="fl">3</span>, length.out <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">x2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>, <span class="fl">3</span>, length.out <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span><span class="va">x1</span>, <span class="va">x2</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">X</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">t</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">^</span><span class="fl">2</span> <span class="op">-</span> <span class="va">t</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">0.62</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/image.html">image</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">y</span>, <span class="fl">100</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">animation</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/animation/man/saveGIF.html">saveGIF</a></span><span class="op">(</span></span>
<span>  <span class="op">{</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"truth"</span>, <span class="st">"linear"</span>, <span class="st">"radial"</span>, <span class="st">"sigmoid"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="kw">if</span><span class="op">(</span><span class="va">i</span> <span class="op">==</span> <span class="st">"truth"</span><span class="op">)</span><span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/graphics/image.html">image</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">y</span>, <span class="fl">100</span>,<span class="fl">100</span><span class="op">)</span>,</span>
<span>        main <span class="op">=</span> <span class="st">"Ground truth"</span>, axes <span class="op">=</span> <span class="cn">FALSE</span>, las <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>      <span class="op">}</span><span class="kw">else</span><span class="op">{</span></span>
<span>        <span class="va">sv</span> <span class="op">=</span> <span class="fu">e1071</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/e1071/man/svm.html">svm</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>, kernel <span class="op">=</span> <span class="va">i</span><span class="op">)</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/graphics/image.html">image</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">sv</span>, <span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, <span class="fl">100</span>, <span class="fl">100</span><span class="op">)</span>,</span>
<span>        main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Kernel: "</span>, <span class="va">i</span><span class="op">)</span>, axes <span class="op">=</span> <span class="cn">FALSE</span>, las <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/graphics/axis.html">axis</a></span><span class="op">(</span><span class="fl">1</span>, at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>, length.out <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>        labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>, <span class="fl">3</span>, length.out <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/graphics/axis.html">axis</a></span><span class="op">(</span><span class="fl">2</span>, at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>, length.out <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>        labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>, <span class="fl">3</span>, length.out <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>, las <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span>,</span>
<span>  movie.name <span class="op">=</span> <span class="st">"svm.gif"</span>, autobrowse <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="images/svm.gif" width="100%" style="display: block; margin: auto;"></div>
<p>As you have seen, this does not work with every kernel. Hence, the problem is to find the actual correct kernel, which is again an optimization procedure and can thus be approximated.</p>
</div>
<div id="exercises-4" class="section level3" number="4.3.3">
<h3>
<span class="header-section-number">4.3.3</span> Exercises<a class="anchor" aria-label="anchor" href="#exercises-4"><i class="fas fa-link"></i></a>
</h3>
  <hr>
<strong><span style="color: #0011AA; font-size:18px;">1. Task</span></strong><br><p>We will use the Sonar data set to explore support-vector machines and k-neartest-neighbor classifier.</p>
<div class="sourceCode" id="cb248"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">mlbench</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">Sonar</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">Sonar</span></span>
<span><span class="va">indices</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">Sonar</span><span class="op">)</span>, <span class="fl">0.5</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">Sonar</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Split the Sonar data set from the mlbench library into training- and testset with 50% in each group. Is this a useful split?
The response variable is “class.” So you are trying to classify the class.</p>
  <details><summary><strong><span style="color: #0011AA; font-size:18px;">Solution</span></strong>
    </summary><p>
</p>
<div class="sourceCode" id="cb249"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">mlbench</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">Sonar</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">Sonar</span></span>
<span><span class="co">#str(data)</span></span>
<span></span>
<span><span class="co"># Do not forget scaling! This may be done implicitly by most functions.</span></span>
<span><span class="co"># Here, it's done explicitly for teaching purposes.</span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind.data.frame</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  <span class="st">"class"</span> <span class="op">=</span> <span class="va">data</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">n</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">indicesTrain</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span><span class="op">(</span><span class="va">n</span>, <span class="op">(</span><span class="va">n</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%/%</a></span> <span class="fl">2</span><span class="op">)</span> <span class="co"># Take (at least) 50 % of the data.</span></span>
<span></span>
<span><span class="va">train</span> <span class="op">=</span> <span class="va">data</span><span class="op">[</span><span class="va">indicesTrain</span>,<span class="op">]</span></span>
<span><span class="va">test</span> <span class="op">=</span> <span class="va">data</span><span class="op">[</span><span class="op">-</span><span class="va">indicesTrain</span>,<span class="op">]</span></span>
<span></span>
<span><span class="va">labelsTrain</span> <span class="op">=</span> <span class="va">train</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">train</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">labelsTest</span> <span class="op">=</span> <span class="va">test</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">test</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<p>Until you have strong reasons for that, 50/50 is no really good decision. You waste data/power.
Do not forget scaling!</p>
    
  </details><br><hr>
<strong><span style="color: #0011AA; font-size:18px;">2. Task</span></strong><br><p>Fit a standard k-nearest-neighbor classifier and a support vector machine with a linear kernel (check help), and report what fitted better.</p>
  <details><summary><strong><span style="color: #0011AA; font-size:18px;">Solution</span></strong>
    </summary><p>
</p>
<div class="sourceCode" id="cb250"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">e1071</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/KlausVigo/kknn">kknn</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">knn</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/kknn/man/kknn.html">kknn</a></span><span class="op">(</span><span class="va">class</span><span class="op">~</span><span class="va">.</span>, train <span class="op">=</span> <span class="va">train</span>, test <span class="op">=</span> <span class="va">test</span>, scale <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>           kernel <span class="op">=</span> <span class="st">"rectangular"</span><span class="op">)</span></span>
<span><span class="va">predKNN</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">knn</span>, newdata <span class="op">=</span> <span class="va">test</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sm</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/e1071/man/svm.html">svm</a></span><span class="op">(</span><span class="va">class</span><span class="op">~</span><span class="va">.</span>, data <span class="op">=</span> <span class="va">train</span>, scale <span class="op">=</span> <span class="cn">FALSE</span>, kernel <span class="op">=</span> <span class="st">"linear"</span><span class="op">)</span></span>
<span><span class="va">predSVM</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">sm</span>, newdata <span class="op">=</span> <span class="va">test</span><span class="op">)</span></span></code></pre></div>
<pre><code>#&gt; K-nearest-neighbor, standard (rectangular) kernel:
#&gt;        labelsTest
#&gt; predKNN  M  R
#&gt;       M 46 29
#&gt;       R  8 21
#&gt; Correctly classified:  67  /  104</code></pre>
<pre><code>#&gt; Support-vector machine, linear kernel:
#&gt;        labelsTest
#&gt; predSVM  M  R
#&gt;       M 41 15
#&gt;       R 13 35
#&gt; Correctly classified:  76  /  104</code></pre>
<p>K-nearest neighbor fitted (slightly) better.</p>
    
  </details><br><hr>
<strong><span style="color: #0011AA; font-size:18px;">3. Task</span></strong><br><p>Calculate accuracies of both algorithms.</p>
  <details><summary><strong><span style="color: #0011AA; font-size:18px;">Solution</span></strong>
    </summary><p>
</p>
<div class="sourceCode" id="cb253"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">accKNN</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">predKNN</span> <span class="op">==</span> <span class="va">labelsTest</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.6442308</span></span>
<span><span class="op">(</span><span class="va">accSVM</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">predSVM</span> <span class="op">==</span> <span class="va">labelsTest</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.7307692</span></span></code></pre></div>
    
  </details><br><hr>
<strong><span style="color: #0011AA; font-size:18px;">4. Task</span></strong><br><p>Fit again with different kernels and compare accuracies.</p>
  <details><summary><strong><span style="color: #0011AA; font-size:18px;">Solution</span></strong>
    </summary><p>
</p>
<div class="sourceCode" id="cb254"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">knn</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/kknn/man/kknn.html">kknn</a></span><span class="op">(</span><span class="va">class</span><span class="op">~</span><span class="va">.</span>, train <span class="op">=</span> <span class="va">train</span>, test <span class="op">=</span> <span class="va">test</span>, scale <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>           kernel <span class="op">=</span> <span class="st">"optimal"</span><span class="op">)</span></span>
<span><span class="va">predKNN</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">knn</span>, newdata <span class="op">=</span> <span class="va">test</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sm</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/e1071/man/svm.html">svm</a></span><span class="op">(</span><span class="va">class</span><span class="op">~</span><span class="va">.</span>, data <span class="op">=</span> <span class="va">train</span>, scale <span class="op">=</span> <span class="cn">FALSE</span>, kernel <span class="op">=</span> <span class="st">"radial"</span><span class="op">)</span></span>
<span><span class="va">predSVM</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">sm</span>, newdata <span class="op">=</span> <span class="va">test</span><span class="op">)</span></span>
<span></span>
<span><span class="op">(</span><span class="va">accKNN</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">predKNN</span> <span class="op">==</span> <span class="va">labelsTest</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.75</span></span>
<span><span class="op">(</span><span class="va">accSVM</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">predSVM</span> <span class="op">==</span> <span class="va">labelsTest</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.8076923</span></span></code></pre></div>
    
  </details><br><hr>
<strong><span style="color: #0011AA; font-size:18px;">5. Task</span></strong><br><p>Try the fit again with a different seed for training and test set generation.</p>
  <details><summary><strong><span style="color: #0011AA; font-size:18px;">Solution</span></strong>
    </summary><p>
</p>
<div class="sourceCode" id="cb255"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">Sonar</span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind.data.frame</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  <span class="st">"class"</span> <span class="op">=</span> <span class="va">data</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">n</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">indicesTrain</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span><span class="op">(</span><span class="va">n</span>, <span class="op">(</span><span class="va">n</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%/%</a></span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">train</span> <span class="op">=</span> <span class="va">data</span><span class="op">[</span><span class="va">indicesTrain</span>,<span class="op">]</span></span>
<span><span class="va">test</span> <span class="op">=</span> <span class="va">data</span><span class="op">[</span><span class="op">-</span><span class="va">indicesTrain</span>,<span class="op">]</span></span>
<span></span>
<span><span class="va">labelsTrain</span> <span class="op">=</span> <span class="va">train</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">train</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">labelsTest</span> <span class="op">=</span> <span class="va">test</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">test</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co">#####</span></span>
<span></span>
<span><span class="va">knn</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/kknn/man/kknn.html">kknn</a></span><span class="op">(</span><span class="va">class</span><span class="op">~</span><span class="va">.</span>, train <span class="op">=</span> <span class="va">train</span>, test <span class="op">=</span> <span class="va">test</span>, scale <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>           kernel <span class="op">=</span> <span class="st">"rectangular"</span><span class="op">)</span></span>
<span><span class="va">predKNN</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">knn</span>, newdata <span class="op">=</span> <span class="va">test</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sm</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/e1071/man/svm.html">svm</a></span><span class="op">(</span><span class="va">class</span><span class="op">~</span><span class="va">.</span>, data <span class="op">=</span> <span class="va">train</span>, scale <span class="op">=</span> <span class="cn">FALSE</span>, kernel <span class="op">=</span> <span class="st">"linear"</span><span class="op">)</span></span>
<span><span class="va">predSVM</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">sm</span>, newdata <span class="op">=</span> <span class="va">test</span><span class="op">)</span></span>
<span></span>
<span><span class="op">(</span><span class="va">accKNN</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">predKNN</span> <span class="op">==</span> <span class="va">labelsTest</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.7115385</span></span>
<span><span class="op">(</span><span class="va">accSVM</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">predSVM</span> <span class="op">==</span> <span class="va">labelsTest</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.75</span></span>
<span></span>
<span><span class="co">#####</span></span>
<span></span>
<span><span class="va">knn</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/kknn/man/kknn.html">kknn</a></span><span class="op">(</span><span class="va">class</span><span class="op">~</span><span class="va">.</span>, train <span class="op">=</span> <span class="va">train</span>, test <span class="op">=</span> <span class="va">test</span>, scale <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>           kernel <span class="op">=</span> <span class="st">"optimal"</span><span class="op">)</span></span>
<span><span class="va">predKNN</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">knn</span>, newdata <span class="op">=</span> <span class="va">test</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sm</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/e1071/man/svm.html">svm</a></span><span class="op">(</span><span class="va">class</span><span class="op">~</span><span class="va">.</span>, data <span class="op">=</span> <span class="va">train</span>, scale <span class="op">=</span> <span class="cn">FALSE</span>, kernel <span class="op">=</span> <span class="st">"radial"</span><span class="op">)</span></span>
<span><span class="va">predSVM</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">sm</span>, newdata <span class="op">=</span> <span class="va">test</span><span class="op">)</span></span>
<span></span>
<span><span class="op">(</span><span class="va">accKNN</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">predKNN</span> <span class="op">==</span> <span class="va">labelsTest</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.8557692</span></span>
<span><span class="op">(</span><span class="va">accSVM</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">predSVM</span> <span class="op">==</span> <span class="va">labelsTest</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.8365385</span></span></code></pre></div>
    
  </details><br><hr>
</div>
</div>
<div id="artificial-neural-networks" class="section level2" number="4.4">
<h2>
<span class="header-section-number">4.4</span> Artificial Neural Networks<a class="anchor" aria-label="anchor" href="#artificial-neural-networks"><i class="fas fa-link"></i></a>
</h2>
<div class="panelset">
<div class="panel">
<p><span class="panel-name">Keras</span></p>
<p>Now, we will come to artificial neural networks (ANNs), for which the topic of regularization is very important. We can specify the regularization in each layer via the kernel_regularization (and/or the bias_regularization) argument.</p>
<div class="sourceCode" id="cb256"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/set_random_seed.html">set_random_seed</a></span><span class="op">(</span><span class="fl">321L</span>, disable_gpu <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># Already sets R's random seed.</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">airquality</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="co">#&gt;      Ozone           Solar.R           Wind             Temp           Month      </span></span>
<span><span class="co">#&gt;  Min.   :  1.00   Min.   :  7.0   Min.   : 1.700   Min.   :56.00   Min.   :5.000  </span></span>
<span><span class="co">#&gt;  1st Qu.: 18.00   1st Qu.:115.8   1st Qu.: 7.400   1st Qu.:72.00   1st Qu.:6.000  </span></span>
<span><span class="co">#&gt;  Median : 31.50   Median :205.0   Median : 9.700   Median :79.00   Median :7.000  </span></span>
<span><span class="co">#&gt;  Mean   : 42.13   Mean   :185.9   Mean   : 9.958   Mean   :77.88   Mean   :6.993  </span></span>
<span><span class="co">#&gt;  3rd Qu.: 63.25   3rd Qu.:258.8   3rd Qu.:11.500   3rd Qu.:85.00   3rd Qu.:8.000  </span></span>
<span><span class="co">#&gt;  Max.   :168.00   Max.   :334.0   Max.   :20.700   Max.   :97.00   Max.   :9.000  </span></span>
<span><span class="co">#&gt;  NA's   :37       NA's   :7                                                       </span></span>
<span><span class="co">#&gt;       Day      </span></span>
<span><span class="co">#&gt;  Min.   : 1.0  </span></span>
<span><span class="co">#&gt;  1st Qu.: 8.0  </span></span>
<span><span class="co">#&gt;  Median :16.0  </span></span>
<span><span class="co">#&gt;  Mean   :15.8  </span></span>
<span><span class="co">#&gt;  3rd Qu.:23.0  </span></span>
<span><span class="co">#&gt;  Max.   :31.0  </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,<span class="op">]</span> <span class="co"># Remove NAs.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="co">#&gt;      Ozone          Solar.R           Wind            Temp           Month      </span></span>
<span><span class="co">#&gt;  Min.   :  1.0   Min.   :  7.0   Min.   : 2.30   Min.   :57.00   Min.   :5.000  </span></span>
<span><span class="co">#&gt;  1st Qu.: 18.0   1st Qu.:113.5   1st Qu.: 7.40   1st Qu.:71.00   1st Qu.:6.000  </span></span>
<span><span class="co">#&gt;  Median : 31.0   Median :207.0   Median : 9.70   Median :79.00   Median :7.000  </span></span>
<span><span class="co">#&gt;  Mean   : 42.1   Mean   :184.8   Mean   : 9.94   Mean   :77.79   Mean   :7.216  </span></span>
<span><span class="co">#&gt;  3rd Qu.: 62.0   3rd Qu.:255.5   3rd Qu.:11.50   3rd Qu.:84.50   3rd Qu.:9.000  </span></span>
<span><span class="co">#&gt;  Max.   :168.0   Max.   :334.0   Max.   :20.70   Max.   :97.00   Max.   :9.000  </span></span>
<span><span class="co">#&gt;       Day       </span></span>
<span><span class="co">#&gt;  Min.   : 1.00  </span></span>
<span><span class="co">#&gt;  1st Qu.: 9.00  </span></span>
<span><span class="co">#&gt;  Median :16.00  </span></span>
<span><span class="co">#&gt;  Mean   :15.95  </span></span>
<span><span class="co">#&gt;  3rd Qu.:22.50  </span></span>
<span><span class="co">#&gt;  Max.   :31.00</span></span>
<span></span>
<span><span class="va">X</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="fl">2</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">Y</span> <span class="op">=</span> <span class="va">data</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">penalty</span> <span class="op">=</span> <span class="fl">0.1</span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">100L</span>, activation <span class="op">=</span> <span class="st">"relu"</span>,</span>
<span>             input_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fl">5L</span><span class="op">)</span>,</span>
<span>             kernel_regularizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l1</a></span><span class="op">(</span><span class="va">penalty</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">100L</span>, activation <span class="op">=</span> <span class="st">"relu"</span>,</span>
<span>             kernel_regularizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l1</a></span><span class="op">(</span><span class="va">penalty</span><span class="op">)</span> <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">100L</span>, activation <span class="op">=</span> <span class="st">"relu"</span>,</span>
<span>             kernel_regularizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l1</a></span><span class="op">(</span><span class="va">penalty</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span> <span class="co"># One output dimension with a linear activation function.</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">1L</span>, activation <span class="op">=</span> <span class="st">"linear"</span>,</span>
<span>             kernel_regularizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l1</a></span><span class="op">(</span><span class="va">penalty</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span> <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html">compile</a></span><span class="op">(</span></span>
<span>   loss <span class="op">=</span> <span class="va">loss_mean_squared_error</span>,</span>
<span>   <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_adamax.html">optimizer_adamax</a></span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">model_history</span> <span class="op">=</span></span>
<span> <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span> <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">X</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">Y</span>, ncol <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span>, epochs <span class="op">=</span> <span class="fl">100L</span>,</span>
<span>     batch_size <span class="op">=</span> <span class="fl">20L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span>, validation_split <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model_history</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_15-1.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb257"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">weights</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">model</span><span class="op">$</span><span class="va">weights</span>, <span class="kw">function</span><span class="op">(</span><span class="va">w</span><span class="op">)</span> <span class="va">w</span><span class="op">$</span><span class="fu">numpy</span><span class="op">(</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="fu">fields</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/fields/man/image.plot.html">image.plot</a></span><span class="op">(</span><span class="va">weights</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_15-2.png" width="100%" style="display: block; margin: auto;"></div>
</div>
<div class="panel">
<p><span class="panel-name">Torch</span></p>
<p>Again, we have to do the regularization on our own in Torch:</p>
<div class="sourceCode" id="cb258"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs">torch</a></span><span class="op">)</span></span>
<span><span class="va">torch_dataset</span> <span class="op">=</span> <span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/dataset.html">dataset</a></span><span class="op">(</span></span>
<span>    name <span class="op">=</span> <span class="st">"data"</span>,</span>
<span>    initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">X</span>,<span class="va">Y</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">self</span><span class="op">$</span><span class="va">X</span> <span class="op">=</span> <span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, dtype <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_dtype.html">torch_float32</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="va">self</span><span class="op">$</span><span class="va">Y</span> <span class="op">=</span> <span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span>, dtype <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_dtype.html">torch_float32</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    .getitem <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">index</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">x</span> <span class="op">=</span> <span class="va">self</span><span class="op">$</span><span class="va">X</span><span class="op">[</span><span class="va">index</span>,<span class="op">]</span></span>
<span>      <span class="va">y</span> <span class="op">=</span> <span class="va">self</span><span class="op">$</span><span class="va">Y</span><span class="op">[</span><span class="va">index</span>,<span class="op">]</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    .length <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">self</span><span class="op">$</span><span class="va">Y</span><span class="op">$</span><span class="fu">size</span><span class="op">(</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">airquality</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="co">#&gt;      Ozone           Solar.R           Wind             Temp           Month      </span></span>
<span><span class="co">#&gt;  Min.   :  1.00   Min.   :  7.0   Min.   : 1.700   Min.   :56.00   Min.   :5.000  </span></span>
<span><span class="co">#&gt;  1st Qu.: 18.00   1st Qu.:115.8   1st Qu.: 7.400   1st Qu.:72.00   1st Qu.:6.000  </span></span>
<span><span class="co">#&gt;  Median : 31.50   Median :205.0   Median : 9.700   Median :79.00   Median :7.000  </span></span>
<span><span class="co">#&gt;  Mean   : 42.13   Mean   :185.9   Mean   : 9.958   Mean   :77.88   Mean   :6.993  </span></span>
<span><span class="co">#&gt;  3rd Qu.: 63.25   3rd Qu.:258.8   3rd Qu.:11.500   3rd Qu.:85.00   3rd Qu.:8.000  </span></span>
<span><span class="co">#&gt;  Max.   :168.00   Max.   :334.0   Max.   :20.700   Max.   :97.00   Max.   :9.000  </span></span>
<span><span class="co">#&gt;  NA's   :37       NA's   :7                                                       </span></span>
<span><span class="co">#&gt;       Day      </span></span>
<span><span class="co">#&gt;  Min.   : 1.0  </span></span>
<span><span class="co">#&gt;  1st Qu.: 8.0  </span></span>
<span><span class="co">#&gt;  Median :16.0  </span></span>
<span><span class="co">#&gt;  Mean   :15.8  </span></span>
<span><span class="co">#&gt;  3rd Qu.:23.0  </span></span>
<span><span class="co">#&gt;  Max.   :31.0  </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,<span class="op">]</span> <span class="co"># Remove NAs.</span></span>
<span><span class="va">X</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="fl">2</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">Y</span> <span class="op">=</span> <span class="va">data</span><span class="op">[</span>,<span class="fl">1</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span></span>
<span></span>
<span><span class="va">dataset</span> <span class="op">=</span> <span class="fu">torch_dataset</span><span class="op">(</span><span class="va">X</span>,<span class="va">Y</span><span class="op">)</span></span>
<span><span class="va">dataloader</span> <span class="op">=</span> <span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/dataloader.html">dataloader</a></span><span class="op">(</span><span class="va">dataset</span>, batch_size <span class="op">=</span> <span class="fl">30L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">model_torch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_sequential.html">nn_sequential</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html">nn_linear</a></span><span class="op">(</span>in_features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, out_features <span class="op">=</span> <span class="fl">100L</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_relu.html">nn_relu</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html">nn_linear</a></span><span class="op">(</span><span class="fl">100L</span>, <span class="fl">100L</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_relu.html">nn_relu</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html">nn_linear</a></span><span class="op">(</span><span class="fl">100L</span>, <span class="fl">100L</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_relu.html">nn_relu</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html">nn_linear</a></span><span class="op">(</span><span class="fl">100L</span>, <span class="fl">1L</span><span class="op">)</span>,</span>
<span><span class="op">)</span></span>
<span><span class="va">opt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/optim_adam.html">optim_adam</a></span><span class="op">(</span>params <span class="op">=</span> <span class="va">model_torch</span><span class="op">$</span><span class="va">parameters</span>, lr <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">epochs</span> <span class="op">=</span> <span class="fl">50L</span></span>
<span><span class="va">opt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/optim_adam.html">optim_adam</a></span><span class="op">(</span><span class="va">model_torch</span><span class="op">$</span><span class="va">parameters</span>, <span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="va">train_losses</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">epoch</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">epochs</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">train_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">coro</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coro/man/collect.html">loop</a></span><span class="op">(</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">batch</span> <span class="kw">in</span> <span class="va">dataloader</span><span class="op">)</span> <span class="op">{</span> </span>
<span>      <span class="va">opt</span><span class="op">$</span><span class="fu">zero_grad</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">pred</span> <span class="op">=</span> <span class="fu">model_torch</span><span class="op">(</span><span class="va">batch</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="va">loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nnf_mse_loss.html">nnf_mse_loss</a></span><span class="op">(</span><span class="va">pred</span>, <span class="va">batch</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>        <span class="co"># Add L1 (only on the 'kernel weights'):</span></span>
<span>      </span>
<span>      <span class="kw">for</span><span class="op">(</span><span class="va">p</span> <span class="kw">in</span> <span class="va">model_torch</span><span class="op">$</span><span class="va">parameters</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="va">loss</span> <span class="op">=</span> <span class="va">loss</span> <span class="op">+</span> <span class="va">p</span><span class="op">$</span><span class="fu">abs</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">sum</span><span class="op">(</span><span class="op">)</span><span class="op">*</span><span class="fl">0.1</span></span>
<span>      <span class="op">}</span></span>
<span></span>
<span>      <span class="va">loss</span><span class="op">$</span><span class="fu">backward</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">opt</span><span class="op">$</span><span class="fu">step</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">train_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">train_loss</span>, <span class="va">loss</span><span class="op">$</span><span class="fu">item</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">train_losses</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">train_losses</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">train_loss</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="va">epoch</span><span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span><span class="fl">10</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"Loss at epoch %d: %3f\n"</span>, <span class="va">epoch</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">train_loss</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Loss at epoch 10: 398.715637</span></span>
<span><span class="co">#&gt; Loss at epoch 20: 362.533501</span></span>
<span><span class="co">#&gt; Loss at epoch 30: 378.814766</span></span>
<span><span class="co">#&gt; Loss at epoch 40: 288.005226</span></span>
<span><span class="co">#&gt; Loss at epoch 50: 265.120636</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">train_losses</span>, type <span class="op">=</span> <span class="st">"o"</span>, pch <span class="op">=</span> <span class="fl">15</span>,</span>
<span>        col <span class="op">=</span> <span class="st">"darkblue"</span>, lty <span class="op">=</span> <span class="fl">1</span>, xlab <span class="op">=</span> <span class="st">"Epoch"</span>,</span>
<span>        ylab <span class="op">=</span> <span class="st">"Loss"</span>, las <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_16_torch-1.png" width="100%" style="display: block; margin: auto;"></div>
<p>Let’s visualize the first (input) layer:</p>
<div class="sourceCode" id="cb259"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">fields</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/fields/man/image.plot.html">image.plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">model_torch</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">`0.weight`</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_17-1.png" width="100%" style="display: block; margin: auto;"></div>
</div>
</div>
<p>Additionally to the usual <span class="math inline">\(L1\)</span> and <span class="math inline">\(L2\)</span> regularization there is another regularization: the so called <strong>dropout-layer</strong> (we will learn about this in more detail later).</p>
<div id="exercise-1" class="section level3" number="4.4.1">
<h3>
<span class="header-section-number">4.4.1</span> Exercise<a class="anchor" aria-label="anchor" href="#exercise-1"><i class="fas fa-link"></i></a>
</h3>
  <strong><span style="color: #0011AA; font-size:18px;">1. Task</span></strong><br><p>The following code is our working example for the next exercises:</p>
<div class="panelset">
<div class="panel">
<p><span class="panel-name">Keras</span></p>
<div class="sourceCode" id="cb260"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/set_random_seed.html">set_random_seed</a></span><span class="op">(</span><span class="fl">321L</span>, disable_gpu <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># Already sets R's random seed.</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">airquality</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">airquality</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Ozone</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">1L</span>, activation <span class="op">=</span> <span class="st">"linear"</span>, input_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>, </span>
<span>             kernel_regularizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l1</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>,</span>
<span>             bias_regularizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l1</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html">compile</a></span><span class="op">(</span>loss <span class="op">=</span> <span class="va">loss_mean_squared_error</span>, <span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_adamax.html">optimizer_adamax</a></span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_history</span> <span class="op">=</span></span>
<span>  <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, epochs <span class="op">=</span> <span class="fl">60L</span>, batch_size <span class="op">=</span> <span class="fl">20L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model_history</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_2-1.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb261"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">l1</span> <span class="op">=</span> <span class="va">model</span><span class="op">$</span><span class="fu">get_weights</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">linear</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">linear</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; lm(formula = y ~ x)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residuals:</span></span>
<span><span class="co">#&gt;     Min      1Q  Median      3Q     Max </span></span>
<span><span class="co">#&gt; -37.014 -12.284  -3.302   8.454  95.348 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept)   42.099      1.980  21.264  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; xSolar.R       4.583      2.135   2.147   0.0341 *  </span></span>
<span><span class="co">#&gt; xWind        -11.806      2.293  -5.149 1.23e-06 ***</span></span>
<span><span class="co">#&gt; xTemp         18.067      2.610   6.922 3.66e-10 ***</span></span>
<span><span class="co">#&gt; xMonth        -4.479      2.230  -2.009   0.0471 *  </span></span>
<span><span class="co">#&gt; xDay           2.385      2.000   1.192   0.2358    </span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual standard error: 20.86 on 105 degrees of freedom</span></span>
<span><span class="co">#&gt; Multiple R-squared:  0.6249, Adjusted R-squared:  0.6071 </span></span>
<span><span class="co">#&gt; F-statistic: 34.99 on 5 and 105 DF,  p-value: &lt; 2.2e-16</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Linear:     "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">linear</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Linear:      42.099 4.583 -11.806 18.067 -4.479 2.385</span></span>
<span><span class="co"># The last parameter is the intercept (first parameter in lm).</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"L1:         "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="va">l1</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="va">l1</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>,</span>
<span>                            <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="va">l1</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="va">l1</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span> <span class="op">)</span><span class="op">]</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; L1:          36.766 1.193 -8.446 13.394 -0.108 0.034</span></span></code></pre></div>
</div>
<div class="panel">
<p><span class="panel-name">Torch</span></p>
<div class="sourceCode" id="cb262"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs">torch</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_manual_seed.html">torch_manual_seed</a></span><span class="op">(</span><span class="fl">321L</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">airquality</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">airquality</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Ozone</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">model_torch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_sequential.html">nn_sequential</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html">nn_linear</a></span><span class="op">(</span>in_features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, out_features <span class="op">=</span> <span class="fl">1L</span>,  bias <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">opt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/optim_adam.html">optim_adam</a></span><span class="op">(</span>params <span class="op">=</span> <span class="va">model_torch</span><span class="op">$</span><span class="va">parameters</span>, lr <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dataset</span> <span class="op">=</span> <span class="fu">torch_dataset</span><span class="op">(</span><span class="va">x</span>,<span class="va">y</span><span class="op">)</span></span>
<span><span class="va">dataloader</span> <span class="op">=</span> <span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/dataloader.html">dataloader</a></span><span class="op">(</span><span class="va">dataset</span>, batch_size <span class="op">=</span> <span class="fl">30L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lambda</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="fl">10.</span><span class="op">)</span></span>
<span></span>
<span><span class="va">epochs</span> <span class="op">=</span> <span class="fl">50L</span></span>
<span><span class="va">train_losses</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">epoch</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">epochs</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">train_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">coro</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coro/man/collect.html">loop</a></span><span class="op">(</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">batch</span> <span class="kw">in</span> <span class="va">dataloader</span><span class="op">)</span> <span class="op">{</span> </span>
<span>      <span class="va">opt</span><span class="op">$</span><span class="fu">zero_grad</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">pred</span> <span class="op">=</span> <span class="fu">model_torch</span><span class="op">(</span><span class="va">batch</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="va">loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nnf_mse_loss.html">nnf_mse_loss</a></span><span class="op">(</span><span class="va">pred</span>, <span class="va">batch</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="kw">for</span><span class="op">(</span><span class="va">p</span> <span class="kw">in</span> <span class="va">model_torch</span><span class="op">$</span><span class="va">parameters</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="co"># if(length(dim(p)) &gt; 1) loss = loss + torch_norm(p, p = 1L)</span></span>
<span>        <span class="va">loss</span> <span class="op">=</span> <span class="va">loss</span> <span class="op">+</span> <span class="va">lambda</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_norm.html">torch_norm</a></span><span class="op">(</span><span class="va">p</span>, p <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>      <span class="va">loss</span><span class="op">$</span><span class="fu">backward</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">opt</span><span class="op">$</span><span class="fu">step</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">train_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">train_loss</span>, <span class="va">loss</span><span class="op">$</span><span class="fu">item</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">train_losses</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">train_losses</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">train_loss</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="va">epoch</span><span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span><span class="fl">10</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"Loss at epoch %d: %3f\n"</span>, <span class="va">epoch</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">train_loss</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Loss at epoch 10: 1531.039734</span></span>
<span><span class="co">#&gt; Loss at epoch 20: 1140.322968</span></span>
<span><span class="co">#&gt; Loss at epoch 30: 1111.737778</span></span>
<span><span class="co">#&gt; Loss at epoch 40: 1114.639465</span></span>
<span><span class="co">#&gt; Loss at epoch 50: 1100.512360</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">train_losses</span>, type <span class="op">=</span> <span class="st">"o"</span>, pch <span class="op">=</span> <span class="fl">15</span>,</span>
<span>        col <span class="op">=</span> <span class="st">"darkblue"</span>, lty <span class="op">=</span> <span class="fl">1</span>, xlab <span class="op">=</span> <span class="st">"Epoch"</span>,</span>
<span>        ylab <span class="op">=</span> <span class="st">"Loss"</span>, las <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_2_torch-1.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb263"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span></span>
<span><span class="va">l1_torch</span> <span class="op">=</span> <span class="va">model_torch</span><span class="op">$</span><span class="va">parameters</span></span>
<span></span>
<span><span class="va">linear</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">linear</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; lm(formula = y ~ x)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residuals:</span></span>
<span><span class="co">#&gt;     Min      1Q  Median      3Q     Max </span></span>
<span><span class="co">#&gt; -37.014 -12.284  -3.302   8.454  95.348 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept)   42.099      1.980  21.264  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; xSolar.R       4.583      2.135   2.147   0.0341 *  </span></span>
<span><span class="co">#&gt; xWind        -11.806      2.293  -5.149 1.23e-06 ***</span></span>
<span><span class="co">#&gt; xTemp         18.067      2.610   6.922 3.66e-10 ***</span></span>
<span><span class="co">#&gt; xMonth        -4.479      2.230  -2.009   0.0471 *  </span></span>
<span><span class="co">#&gt; xDay           2.385      2.000   1.192   0.2358    </span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual standard error: 20.86 on 105 degrees of freedom</span></span>
<span><span class="co">#&gt; Multiple R-squared:  0.6249, Adjusted R-squared:  0.6071 </span></span>
<span><span class="co">#&gt; F-statistic: 34.99 on 5 and 105 DF,  p-value: &lt; 2.2e-16</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Linear:     "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">linear</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Linear:      42.099 4.583 -11.806 18.067 -4.479 2.385</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"L1:         "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span> <span class="va">l1_torch</span><span class="op">$</span><span class="va">`0.bias`</span> <span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span> <span class="va">l1_torch</span><span class="op">$</span><span class="va">`0.weight`</span> <span class="op">)</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; L1:          36.997 1.446 -8.213 13.754 -0.101 -0.033</span></span></code></pre></div>
</div>
</div>
<p>What happens if you change the regularization from <span class="math inline">\(L1\)</span> to <span class="math inline">\(L2\)</span>?</p>
  <details><summary><strong><span style="color: #0011AA; font-size:18px;">Solution</span></strong>
    </summary><p>
</p>
<div class="panelset">
<div class="panel">
<p><span class="panel-name">Keras</span></p>
<div class="sourceCode" id="cb264"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/set_random_seed.html">set_random_seed</a></span><span class="op">(</span><span class="fl">321L</span>, disable_gpu <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># Already sets R's random seed.</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">airquality</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">airquality</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Ozone</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">1L</span>, activation <span class="op">=</span> <span class="st">"linear"</span>, input_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>, </span>
<span>             kernel_regularizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l2</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>,</span>
<span>             bias_regularizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l2</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html">compile</a></span><span class="op">(</span>loss <span class="op">=</span> <span class="va">loss_mean_squared_error</span>, <span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_adamax.html">optimizer_adamax</a></span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_history</span> <span class="op">=</span></span>
<span>  <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, epochs <span class="op">=</span> <span class="fl">60L</span>, batch_size <span class="op">=</span> <span class="fl">20L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model_history</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_3-1.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb265"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">l2</span> <span class="op">=</span> <span class="va">model</span><span class="op">$</span><span class="fu">get_weights</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>#&gt; Linear:      42.099 4.583 -11.806 18.067 -4.479 2.385
#&gt; L1:          36.766 1.193 -8.446 13.394 -0.108 0.034
#&gt; L2:          3.756 0.976 -1.721 1.956 0.402 -0.112</code></pre>
</div>
<div class="panel">
<p><span class="panel-name">Torch</span></p>
<div class="sourceCode" id="cb267"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs">torch</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_manual_seed.html">torch_manual_seed</a></span><span class="op">(</span><span class="fl">321L</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">airquality</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">airquality</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Ozone</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">model_torch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_sequential.html">nn_sequential</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html">nn_linear</a></span><span class="op">(</span>in_features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, out_features <span class="op">=</span> <span class="fl">1L</span>,  bias <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">opt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/optim_adam.html">optim_adam</a></span><span class="op">(</span>params <span class="op">=</span> <span class="va">model_torch</span><span class="op">$</span><span class="va">parameters</span>, lr <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dataset</span> <span class="op">=</span> <span class="fu">torch_dataset</span><span class="op">(</span><span class="va">x</span>,<span class="va">y</span><span class="op">)</span></span>
<span><span class="va">dataloader</span> <span class="op">=</span> <span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/dataloader.html">dataloader</a></span><span class="op">(</span><span class="va">dataset</span>, batch_size <span class="op">=</span> <span class="fl">30L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lambda</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="fl">10.</span><span class="op">)</span></span>
<span></span>
<span><span class="va">epochs</span> <span class="op">=</span> <span class="fl">50L</span></span>
<span><span class="va">train_losses</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">epoch</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">epochs</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">train_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">coro</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coro/man/collect.html">loop</a></span><span class="op">(</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">batch</span> <span class="kw">in</span> <span class="va">dataloader</span><span class="op">)</span> <span class="op">{</span> </span>
<span>      <span class="va">opt</span><span class="op">$</span><span class="fu">zero_grad</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">pred</span> <span class="op">=</span> <span class="fu">model_torch</span><span class="op">(</span><span class="va">batch</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="va">loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nnf_mse_loss.html">nnf_mse_loss</a></span><span class="op">(</span><span class="va">pred</span>, <span class="va">batch</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="kw">for</span><span class="op">(</span><span class="va">p</span> <span class="kw">in</span> <span class="va">model_torch</span><span class="op">$</span><span class="va">parameters</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="co"># if(length(dim(p)) &gt; 1) loss = loss + torch_norm(p, p = 2L)</span></span>
<span>        <span class="va">loss</span> <span class="op">=</span> <span class="va">loss</span> <span class="op">+</span> <span class="va">lambda</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_norm.html">torch_norm</a></span><span class="op">(</span><span class="va">p</span>, p <span class="op">=</span> <span class="fl">2L</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>      <span class="va">loss</span><span class="op">$</span><span class="fu">backward</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">opt</span><span class="op">$</span><span class="fu">step</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">train_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">train_loss</span>, <span class="va">loss</span><span class="op">$</span><span class="fu">item</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">train_losses</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">train_losses</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">train_loss</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="va">epoch</span><span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span><span class="fl">10</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"Loss at epoch %d: %3f\n"</span>, <span class="va">epoch</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">train_loss</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Loss at epoch 10: 1422.089020</span></span>
<span><span class="co">#&gt; Loss at epoch 20: 1039.486465</span></span>
<span><span class="co">#&gt; Loss at epoch 30: 1012.695160</span></span>
<span><span class="co">#&gt; Loss at epoch 40: 1011.486572</span></span>
<span><span class="co">#&gt; Loss at epoch 50: 1000.638733</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">train_losses</span>, type <span class="op">=</span> <span class="st">"o"</span>, pch <span class="op">=</span> <span class="fl">15</span>,</span>
<span>        col <span class="op">=</span> <span class="st">"darkblue"</span>, lty <span class="op">=</span> <span class="fl">1</span>, xlab <span class="op">=</span> <span class="st">"Epoch"</span>,</span>
<span>        ylab <span class="op">=</span> <span class="st">"Loss"</span>, las <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_3_torch-1.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb268"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">l2_torch</span> <span class="op">=</span> <span class="va">model_torch</span><span class="op">$</span><span class="va">parameters</span></span>
<span></span>
<span><span class="va">linear</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">x</span><span class="op">)</span></span></code></pre></div>
<pre><code>#&gt; Linear:      42.099 4.583 -11.806 18.067 -4.479 2.385
#&gt; L1:          37.266 0.779 -6.594 14.665 -0.067 0.048
#&gt; L2:          37.334 4.262 -8.593 14.167 -2.081 0.365</code></pre>
</div>
</div>
<p>Weights 4 and 5 are strongly pushed towards zero with <span class="math inline">\(L1\)</span> regularization, but <span class="math inline">\(L2\)</span> regularization shrinks more in general.
<em>Note</em>: The weights are not similar to the linear model! (But often, they keep their sign.)</p>
    
  </details><br><hr>
<strong><span style="color: #0011AA; font-size:18px;">2. Task</span></strong><br><p>Try different regularization strengths, try to push the weights to zero. What is the strategy to push the parameters to zero?</p>
  <details><summary><strong><span style="color: #0011AA; font-size:18px;">Solution</span></strong>
    </summary><p>
</p>
<p><strong>Now with less regularization:</strong></p>
<div class="panelset">
<div class="panel">
<p><span class="panel-name">Keras</span></p>
<div class="sourceCode" id="cb270"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/set_random_seed.html">set_random_seed</a></span><span class="op">(</span><span class="fl">321L</span>, disable_gpu <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># Already sets R's random seed.</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">airquality</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">airquality</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Ozone</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">1L</span>, activation <span class="op">=</span> <span class="st">"linear"</span>, input_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>, </span>
<span>             kernel_regularizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l1</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>             bias_regularizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l1</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html">compile</a></span><span class="op">(</span>loss <span class="op">=</span> <span class="va">loss_mean_squared_error</span>, <span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_adamax.html">optimizer_adamax</a></span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_history</span> <span class="op">=</span></span>
<span>  <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, epochs <span class="op">=</span> <span class="fl">60L</span>, batch_size <span class="op">=</span> <span class="fl">20L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model_history</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_5-1.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb271"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">l1_lesser</span> <span class="op">=</span> <span class="va">model</span><span class="op">$</span><span class="fu">get_weights</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>#&gt; Linear:      42.099 4.583 -11.806 18.067 -4.479 2.385
#&gt; L1:          36.766 1.193 -8.446 13.394 -0.108 0.034
#&gt; L1, lesser:  41.087 4.164 -11.617 17.043 -3.571 1.986</code></pre>
<div class="sourceCode" id="cb273"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/set_random_seed.html">set_random_seed</a></span><span class="op">(</span><span class="fl">321L</span>, disable_gpu <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># Already sets R's random seed.</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">airquality</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">airquality</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Ozone</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">1L</span>, activation <span class="op">=</span> <span class="st">"linear"</span>, input_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>, </span>
<span>             kernel_regularizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l2</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>             bias_regularizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l2</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html">compile</a></span><span class="op">(</span>loss <span class="op">=</span> <span class="va">loss_mean_squared_error</span>, <span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_adamax.html">optimizer_adamax</a></span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_history</span> <span class="op">=</span></span>
<span>  <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, epochs <span class="op">=</span> <span class="fl">60L</span>, batch_size <span class="op">=</span> <span class="fl">20L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model_history</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_7-1.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb274"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">l2_lesser</span> <span class="op">=</span> <span class="va">model</span><span class="op">$</span><span class="fu">get_weights</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>#&gt; Linear:      42.099 4.583 -11.806 18.067 -4.479 2.385
#&gt; L2:          3.756 0.976 -1.721 1.956 0.402 -0.112
#&gt; L2, lesser:  20.999 3.726 -7.585 9.065 -0.065 0.669</code></pre>
</div>
<div class="panel">
<p><span class="panel-name">Torch</span></p>
<div class="sourceCode" id="cb276"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs">torch</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_manual_seed.html">torch_manual_seed</a></span><span class="op">(</span><span class="fl">321L</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">airquality</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">airquality</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Ozone</span>, ncol <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">model_torch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_sequential.html">nn_sequential</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html">nn_linear</a></span><span class="op">(</span>in_features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, out_features <span class="op">=</span> <span class="fl">1L</span>,  bias <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">opt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/optim_adam.html">optim_adam</a></span><span class="op">(</span>params <span class="op">=</span> <span class="va">model_torch</span><span class="op">$</span><span class="va">parameters</span>, lr <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dataset</span> <span class="op">=</span> <span class="fu">torch_dataset</span><span class="op">(</span><span class="va">x</span>,<span class="va">y</span><span class="op">)</span></span>
<span><span class="va">dataloader</span> <span class="op">=</span> <span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/dataloader.html">dataloader</a></span><span class="op">(</span><span class="va">dataset</span>, batch_size <span class="op">=</span> <span class="fl">30L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lambda</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="fl">1.</span><span class="op">)</span></span>
<span></span>
<span><span class="va">epochs</span> <span class="op">=</span> <span class="fl">50L</span></span>
<span><span class="va">train_losses</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">epoch</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">epochs</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">train_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">coro</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coro/man/collect.html">loop</a></span><span class="op">(</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">batch</span> <span class="kw">in</span> <span class="va">dataloader</span><span class="op">)</span> <span class="op">{</span> </span>
<span>      <span class="va">opt</span><span class="op">$</span><span class="fu">zero_grad</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">pred</span> <span class="op">=</span> <span class="fu">model_torch</span><span class="op">(</span><span class="va">batch</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="va">loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nnf_mse_loss.html">nnf_mse_loss</a></span><span class="op">(</span><span class="va">pred</span>, <span class="va">batch</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="kw">for</span><span class="op">(</span><span class="va">p</span> <span class="kw">in</span> <span class="va">model_torch</span><span class="op">$</span><span class="va">parameters</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="co"># if(length(dim(p)) &gt; 1) loss = loss + torch_norm(p, p = 2L)</span></span>
<span>        <span class="va">loss</span> <span class="op">=</span> <span class="va">loss</span> <span class="op">+</span> <span class="va">lambda</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_norm.html">torch_norm</a></span><span class="op">(</span><span class="va">p</span>, p <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>      <span class="va">loss</span><span class="op">$</span><span class="fu">backward</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">opt</span><span class="op">$</span><span class="fu">step</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">train_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">train_loss</span>, <span class="va">loss</span><span class="op">$</span><span class="fu">item</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">train_losses</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">train_losses</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">train_loss</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="va">epoch</span><span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span><span class="fl">10</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"Loss at epoch %d: %3f\n"</span>, <span class="va">epoch</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">train_loss</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Loss at epoch 10: 1099.858826</span></span>
<span><span class="co">#&gt; Loss at epoch 20: 582.395599</span></span>
<span><span class="co">#&gt; Loss at epoch 30: 504.676323</span></span>
<span><span class="co">#&gt; Loss at epoch 40: 493.882896</span></span>
<span><span class="co">#&gt; Loss at epoch 50: 486.528419</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">train_losses</span>, type <span class="op">=</span> <span class="st">"o"</span>, pch <span class="op">=</span> <span class="fl">15</span>,</span>
<span>        col <span class="op">=</span> <span class="st">"darkblue"</span>, lty <span class="op">=</span> <span class="fl">1</span>, xlab <span class="op">=</span> <span class="st">"Epoch"</span>,</span>
<span>        ylab <span class="op">=</span> <span class="st">"Loss"</span>, las <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_5_torch-1.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb277"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">l1_torch_lesser</span> <span class="op">=</span> <span class="va">model_torch</span><span class="op">$</span><span class="va">parameters</span></span>
<span></span>
<span><span class="va">linear</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">x</span><span class="op">)</span></span></code></pre></div>
<pre><code>#&gt; Linear:      42.099 4.583 -11.806 18.067 -4.479 2.385
#&gt; L1:          37.266 0.779 -6.594 14.665 -0.067 0.048
#&gt; L1 lesser:          41.631 3.814 -9.777 17.704 -3.5 0.993</code></pre>
<div class="sourceCode" id="cb279"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs">torch</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_manual_seed.html">torch_manual_seed</a></span><span class="op">(</span><span class="fl">321L</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">airquality</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">airquality</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Ozone</span>, ncol <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">model_torch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_sequential.html">nn_sequential</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html">nn_linear</a></span><span class="op">(</span>in_features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, out_features <span class="op">=</span> <span class="fl">1L</span>,  bias <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">opt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/optim_adam.html">optim_adam</a></span><span class="op">(</span>params <span class="op">=</span> <span class="va">model_torch</span><span class="op">$</span><span class="va">parameters</span>, lr <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dataset</span> <span class="op">=</span> <span class="fu">torch_dataset</span><span class="op">(</span><span class="va">x</span>,<span class="va">y</span><span class="op">)</span></span>
<span><span class="va">dataloader</span> <span class="op">=</span> <span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/dataloader.html">dataloader</a></span><span class="op">(</span><span class="va">dataset</span>, batch_size <span class="op">=</span> <span class="fl">30L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lambda</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="fl">1.</span><span class="op">)</span></span>
<span></span>
<span><span class="va">epochs</span> <span class="op">=</span> <span class="fl">50L</span></span>
<span><span class="va">train_losses</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">epoch</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">epochs</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">train_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">coro</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coro/man/collect.html">loop</a></span><span class="op">(</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">batch</span> <span class="kw">in</span> <span class="va">dataloader</span><span class="op">)</span> <span class="op">{</span> </span>
<span>      <span class="va">opt</span><span class="op">$</span><span class="fu">zero_grad</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">pred</span> <span class="op">=</span> <span class="fu">model_torch</span><span class="op">(</span><span class="va">batch</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="va">loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nnf_mse_loss.html">nnf_mse_loss</a></span><span class="op">(</span><span class="va">pred</span>, <span class="va">batch</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="kw">for</span><span class="op">(</span><span class="va">p</span> <span class="kw">in</span> <span class="va">model_torch</span><span class="op">$</span><span class="va">parameters</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="co"># if(length(dim(p)) &gt; 1) loss = loss + torch_norm(p, p = 2L)</span></span>
<span>        <span class="va">loss</span> <span class="op">=</span> <span class="va">loss</span> <span class="op">+</span> <span class="va">lambda</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_norm.html">torch_norm</a></span><span class="op">(</span><span class="va">p</span>, p <span class="op">=</span> <span class="fl">2L</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>      <span class="va">loss</span><span class="op">$</span><span class="fu">backward</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">opt</span><span class="op">$</span><span class="fu">step</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">train_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">train_loss</span>, <span class="va">loss</span><span class="op">$</span><span class="fu">item</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">train_losses</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">train_losses</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">train_loss</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="va">epoch</span><span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span><span class="fl">10</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"Loss at epoch %d: %3f\n"</span>, <span class="va">epoch</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">train_loss</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Loss at epoch 10: 1084.756989</span></span>
<span><span class="co">#&gt; Loss at epoch 20: 564.938286</span></span>
<span><span class="co">#&gt; Loss at epoch 30: 487.880241</span></span>
<span><span class="co">#&gt; Loss at epoch 40: 475.524956</span></span>
<span><span class="co">#&gt; Loss at epoch 50: 469.579903</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">train_losses</span>, type <span class="op">=</span> <span class="st">"o"</span>, pch <span class="op">=</span> <span class="fl">15</span>,</span>
<span>        col <span class="op">=</span> <span class="st">"darkblue"</span>, lty <span class="op">=</span> <span class="fl">1</span>, xlab <span class="op">=</span> <span class="st">"Epoch"</span>,</span>
<span>        ylab <span class="op">=</span> <span class="st">"Loss"</span>, las <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_6_torch-1.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb280"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span></span>
<span><span class="va">l2_torch_lesser</span> <span class="op">=</span> <span class="va">model_torch</span><span class="op">$</span><span class="va">parameters</span></span>
<span></span>
<span><span class="va">linear</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">x</span><span class="op">)</span></span></code></pre></div>
<pre><code>#&gt; Linear:      42.099 4.583 -11.806 18.067 -4.479 2.385
#&gt; L2:          37.334 4.262 -8.593 14.167 -2.081 0.365
#&gt; L2 lesser:          41.624 4.172 -10.056 17.798 -4.058 1.171</code></pre>
</div>
</div>
<p><strong>And with more regularization:</strong></p>
<div class="panelset">
<div class="panel">
<p><span class="panel-name">Keras</span></p>
<div class="sourceCode" id="cb282"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/set_random_seed.html">set_random_seed</a></span><span class="op">(</span><span class="fl">321L</span>, disable_gpu <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># Already sets R's random seed.</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">airquality</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">airquality</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Ozone</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">1L</span>, activation <span class="op">=</span> <span class="st">"linear"</span>, input_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>, </span>
<span>             kernel_regularizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l1</a></span><span class="op">(</span><span class="fl">25</span><span class="op">)</span>,</span>
<span>             bias_regularizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l1</a></span><span class="op">(</span><span class="fl">25</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html">compile</a></span><span class="op">(</span>loss <span class="op">=</span> <span class="va">loss_mean_squared_error</span>, <span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_adamax.html">optimizer_adamax</a></span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_history</span> <span class="op">=</span></span>
<span>  <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, epochs <span class="op">=</span> <span class="fl">60L</span>, batch_size <span class="op">=</span> <span class="fl">20L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model_history</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_9-1.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb283"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">l1_higher</span> <span class="op">=</span> <span class="va">model</span><span class="op">$</span><span class="fu">get_weights</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>#&gt; Linear:      42.099 4.583 -11.806 18.067 -4.479 2.385
#&gt; L1:          36.766 1.193 -8.446 13.394 -0.108 0.034
#&gt; L1, lesser:  41.087 4.164 -11.617 17.043 -3.571 1.986
#&gt; L1, higher:  29.367 0.112 -3.354 8.732 0.058 0.03</code></pre>
<div class="sourceCode" id="cb285"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/set_random_seed.html">set_random_seed</a></span><span class="op">(</span><span class="fl">321L</span>, disable_gpu <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># Already sets R's random seed.</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">airquality</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">airquality</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Ozone</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">1L</span>, activation <span class="op">=</span> <span class="st">"linear"</span>, input_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>, </span>
<span>             kernel_regularizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l2</a></span><span class="op">(</span><span class="fl">25</span><span class="op">)</span>,</span>
<span>             bias_regularizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l2</a></span><span class="op">(</span><span class="fl">25</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html">compile</a></span><span class="op">(</span>loss <span class="op">=</span> <span class="va">loss_mean_squared_error</span>, <span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_adamax.html">optimizer_adamax</a></span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_history</span> <span class="op">=</span></span>
<span>  <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, epochs <span class="op">=</span> <span class="fl">60L</span>, batch_size <span class="op">=</span> <span class="fl">20L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model_history</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_11-1.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb286"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">l2_higher</span> <span class="op">=</span> <span class="va">model</span><span class="op">$</span><span class="fu">get_weights</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>#&gt; Linear:      42.099 4.583 -11.806 18.067 -4.479 2.385
#&gt; L2:          3.756 0.976 -1.721 1.956 0.402 -0.112
#&gt; L2, lesser:  20.999 3.726 -7.585 9.065 -0.065 0.669
#&gt; L2, higher:  1.564 0.414 -0.797 0.83 0.165 0.048</code></pre>
</div>
<div class="panel">
<p><span class="panel-name">Torch</span></p>
<div class="sourceCode" id="cb288"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs">torch</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_manual_seed.html">torch_manual_seed</a></span><span class="op">(</span><span class="fl">321L</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">airquality</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">airquality</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Ozone</span>, ncol <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">model_torch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_sequential.html">nn_sequential</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html">nn_linear</a></span><span class="op">(</span>in_features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, out_features <span class="op">=</span> <span class="fl">1L</span>,  bias <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">opt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/optim_adam.html">optim_adam</a></span><span class="op">(</span>params <span class="op">=</span> <span class="va">model_torch</span><span class="op">$</span><span class="va">parameters</span>, lr <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dataset</span> <span class="op">=</span> <span class="fu">torch_dataset</span><span class="op">(</span><span class="va">x</span>,<span class="va">y</span><span class="op">)</span></span>
<span><span class="va">dataloader</span> <span class="op">=</span> <span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/dataloader.html">dataloader</a></span><span class="op">(</span><span class="va">dataset</span>, batch_size <span class="op">=</span> <span class="fl">30L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lambda</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="fl">25.</span><span class="op">)</span></span>
<span></span>
<span><span class="va">epochs</span> <span class="op">=</span> <span class="fl">50L</span></span>
<span><span class="va">train_losses</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">epoch</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">epochs</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">train_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">coro</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coro/man/collect.html">loop</a></span><span class="op">(</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">batch</span> <span class="kw">in</span> <span class="va">dataloader</span><span class="op">)</span> <span class="op">{</span> </span>
<span>      <span class="va">opt</span><span class="op">$</span><span class="fu">zero_grad</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">pred</span> <span class="op">=</span> <span class="fu">model_torch</span><span class="op">(</span><span class="va">batch</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="va">loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nnf_mse_loss.html">nnf_mse_loss</a></span><span class="op">(</span><span class="va">pred</span>, <span class="va">batch</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="kw">for</span><span class="op">(</span><span class="va">p</span> <span class="kw">in</span> <span class="va">model_torch</span><span class="op">$</span><span class="va">parameters</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="co"># if(length(dim(p)) &gt; 1) loss = loss + torch_norm(p, p = 2L)</span></span>
<span>        <span class="va">loss</span> <span class="op">=</span> <span class="va">loss</span> <span class="op">+</span> <span class="va">lambda</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_norm.html">torch_norm</a></span><span class="op">(</span><span class="va">p</span>, p <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>      <span class="va">loss</span><span class="op">$</span><span class="fu">backward</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">opt</span><span class="op">$</span><span class="fu">step</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">train_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">train_loss</span>, <span class="va">loss</span><span class="op">$</span><span class="fu">item</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">train_losses</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">train_losses</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">train_loss</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="va">epoch</span><span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span><span class="fl">10</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"Loss at epoch %d: %3f\n"</span>, <span class="va">epoch</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">train_loss</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Loss at epoch 10: 2087.138885</span></span>
<span><span class="co">#&gt; Loss at epoch 20: 1849.129852</span></span>
<span><span class="co">#&gt; Loss at epoch 30: 1875.545776</span></span>
<span><span class="co">#&gt; Loss at epoch 40: 1881.110138</span></span>
<span><span class="co">#&gt; Loss at epoch 50: 1850.213867</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">train_losses</span>, type <span class="op">=</span> <span class="st">"o"</span>, pch <span class="op">=</span> <span class="fl">15</span>,</span>
<span>        col <span class="op">=</span> <span class="st">"darkblue"</span>, lty <span class="op">=</span> <span class="fl">1</span>, xlab <span class="op">=</span> <span class="st">"Epoch"</span>,</span>
<span>        ylab <span class="op">=</span> <span class="st">"Loss"</span>, las <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_10_torch-1.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb289"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span></span>
<span><span class="va">l1_torch_higher</span> <span class="op">=</span> <span class="va">model_torch</span><span class="op">$</span><span class="va">parameters</span></span>
<span></span>
<span><span class="va">linear</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">x</span><span class="op">)</span></span></code></pre></div>
<pre><code>#&gt; Linear:      42.099 4.583 -11.806 18.067 -4.479 2.385
#&gt; L1:          37.266 0.779 -6.594 14.665 -0.067 0.048
#&gt; L1 lesser:          41.631 3.814 -9.777 17.704 -3.5 0.993
#&gt; L1 higher:          29.636 0.123 -1.257 10.496 -0.013 0.032</code></pre>
<div class="sourceCode" id="cb291"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs">torch</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_manual_seed.html">torch_manual_seed</a></span><span class="op">(</span><span class="fl">321L</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">airquality</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">airquality</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Ozone</span>, ncol <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">model_torch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_sequential.html">nn_sequential</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html">nn_linear</a></span><span class="op">(</span>in_features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, out_features <span class="op">=</span> <span class="fl">1L</span>,  bias <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">opt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/optim_adam.html">optim_adam</a></span><span class="op">(</span>params <span class="op">=</span> <span class="va">model_torch</span><span class="op">$</span><span class="va">parameters</span>, lr <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dataset</span> <span class="op">=</span> <span class="fu">torch_dataset</span><span class="op">(</span><span class="va">x</span>,<span class="va">y</span><span class="op">)</span></span>
<span><span class="va">dataloader</span> <span class="op">=</span> <span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/dataloader.html">dataloader</a></span><span class="op">(</span><span class="va">dataset</span>, batch_size <span class="op">=</span> <span class="fl">30L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lambda</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="fl">25.</span><span class="op">)</span></span>
<span></span>
<span><span class="va">epochs</span> <span class="op">=</span> <span class="fl">50L</span></span>
<span><span class="va">train_losses</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">epoch</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">epochs</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">train_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">coro</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coro/man/collect.html">loop</a></span><span class="op">(</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">batch</span> <span class="kw">in</span> <span class="va">dataloader</span><span class="op">)</span> <span class="op">{</span> </span>
<span>      <span class="va">opt</span><span class="op">$</span><span class="fu">zero_grad</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">pred</span> <span class="op">=</span> <span class="fu">model_torch</span><span class="op">(</span><span class="va">batch</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="va">loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nnf_mse_loss.html">nnf_mse_loss</a></span><span class="op">(</span><span class="va">pred</span>, <span class="va">batch</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="kw">for</span><span class="op">(</span><span class="va">p</span> <span class="kw">in</span> <span class="va">model_torch</span><span class="op">$</span><span class="va">parameters</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="co"># if(length(dim(p)) &gt; 1) loss = loss + torch_norm(p, p = 2L)</span></span>
<span>        <span class="va">loss</span> <span class="op">=</span> <span class="va">loss</span> <span class="op">+</span> <span class="va">lambda</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_norm.html">torch_norm</a></span><span class="op">(</span><span class="va">p</span>, p <span class="op">=</span> <span class="fl">2L</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>      <span class="va">loss</span><span class="op">$</span><span class="fu">backward</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">opt</span><span class="op">$</span><span class="fu">step</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">train_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">train_loss</span>, <span class="va">loss</span><span class="op">$</span><span class="fu">item</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">train_losses</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">train_losses</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">train_loss</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="va">epoch</span><span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span><span class="fl">10</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"Loss at epoch %d: %3f\n"</span>, <span class="va">epoch</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">train_loss</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Loss at epoch 10: 1937.392212</span></span>
<span><span class="co">#&gt; Loss at epoch 20: 1719.033783</span></span>
<span><span class="co">#&gt; Loss at epoch 30: 1739.214966</span></span>
<span><span class="co">#&gt; Loss at epoch 40: 1743.116486</span></span>
<span><span class="co">#&gt; Loss at epoch 50: 1720.508759</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">train_losses</span>, type <span class="op">=</span> <span class="st">"o"</span>, pch <span class="op">=</span> <span class="fl">15</span>,</span>
<span>        col <span class="op">=</span> <span class="st">"darkblue"</span>, lty <span class="op">=</span> <span class="fl">1</span>, xlab <span class="op">=</span> <span class="st">"Epoch"</span>,</span>
<span>        ylab <span class="op">=</span> <span class="st">"Loss"</span>, las <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_11_torch-1.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb292"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">l2_torch_higher</span> <span class="op">=</span> <span class="va">model_torch</span><span class="op">$</span><span class="va">parameters</span></span>
<span></span>
<span><span class="va">linear</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">linear</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; lm(formula = y ~ x)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residuals:</span></span>
<span><span class="co">#&gt;     Min      1Q  Median      3Q     Max </span></span>
<span><span class="co">#&gt; -37.014 -12.284  -3.302   8.454  95.348 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept)   42.099      1.980  21.264  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; xSolar.R       4.583      2.135   2.147   0.0341 *  </span></span>
<span><span class="co">#&gt; xWind        -11.806      2.293  -5.149 1.23e-06 ***</span></span>
<span><span class="co">#&gt; xTemp         18.067      2.610   6.922 3.66e-10 ***</span></span>
<span><span class="co">#&gt; xMonth        -4.479      2.230  -2.009   0.0471 *  </span></span>
<span><span class="co">#&gt; xDay           2.385      2.000   1.192   0.2358    </span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual standard error: 20.86 on 105 degrees of freedom</span></span>
<span><span class="co">#&gt; Multiple R-squared:  0.6249, Adjusted R-squared:  0.6071 </span></span>
<span><span class="co">#&gt; F-statistic: 34.99 on 5 and 105 DF,  p-value: &lt; 2.2e-16</span></span></code></pre></div>
<pre><code>#&gt; Linear:      42.099 4.583 -11.806 18.067 -4.479 2.385
#&gt; L2:          37.334 4.262 -8.593 14.167 -2.081 0.365
#&gt; L2 lesser:          41.624 4.172 -10.056 17.798 -4.058 1.171
#&gt; L2 higher:          30.026 3.192 -5.988 9.622 -0.353 -0.043</code></pre>
</div>
</div>
<p>For pushing weights towards zero, <span class="math inline">\(L1\)</span> regularization is used rather than <span class="math inline">\(L2\)</span>.
Higher regularization leads to smaller parameters (maybe in combination with smaller learning rates).</p>
<p>Play around on your own! Ask questions if you have any.</p>
    
  </details><br><hr>
<strong><span style="color: #0011AA; font-size:18px;">3. Task</span></strong><br><p>Use a combination of <span class="math inline">\(L1\)</span> and a <span class="math inline">\(L2\)</span> regularization (there is a Keras function for this). How is this kind of regularization called and what is the advantage of this approach?</p>
  <details><summary><strong><span style="color: #0011AA; font-size:18px;">Solution</span></strong>
    </summary><p>
</p>
<div class="panelset">
<div class="panel">
<p><span class="panel-name">Keras</span></p>
<div class="sourceCode" id="cb294"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/set_random_seed.html">set_random_seed</a></span><span class="op">(</span><span class="fl">321L</span>, disable_gpu <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># Already sets R's random seed.</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">airquality</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">airquality</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Ozone</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">1L</span>, activation <span class="op">=</span> <span class="st">"linear"</span>, input_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>, </span>
<span>             kernel_regularizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l1_l2</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>,</span>
<span>             bias_regularizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l1_l2</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html">compile</a></span><span class="op">(</span>loss <span class="op">=</span> <span class="va">loss_mean_squared_error</span>, <span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_adamax.html">optimizer_adamax</a></span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_history</span> <span class="op">=</span></span>
<span>  <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, epochs <span class="op">=</span> <span class="fl">60L</span>, batch_size <span class="op">=</span> <span class="fl">20L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model_history</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_13-1.png" width="100%" style="display: block; margin: auto;"></div>
</div>
<div class="panel">
<p><span class="panel-name">Torch</span></p>
<div class="sourceCode" id="cb295"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs">torch</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_manual_seed.html">torch_manual_seed</a></span><span class="op">(</span><span class="fl">321L</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">airquality</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">airquality</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Ozone</span>, ncol <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">model_torch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_sequential.html">nn_sequential</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html">nn_linear</a></span><span class="op">(</span>in_features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, out_features <span class="op">=</span> <span class="fl">1L</span>,  bias <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">opt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/optim_adam.html">optim_adam</a></span><span class="op">(</span>params <span class="op">=</span> <span class="va">model_torch</span><span class="op">$</span><span class="va">parameters</span>, lr <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dataset</span> <span class="op">=</span> <span class="fu">torch_dataset</span><span class="op">(</span><span class="va">x</span>,<span class="va">y</span><span class="op">)</span></span>
<span><span class="va">dataloader</span> <span class="op">=</span> <span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/dataloader.html">dataloader</a></span><span class="op">(</span><span class="va">dataset</span>, batch_size <span class="op">=</span> <span class="fl">30L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lambda</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="fl">10.</span><span class="op">)</span></span>
<span></span>
<span><span class="va">epochs</span> <span class="op">=</span> <span class="fl">50L</span></span>
<span><span class="va">train_losses</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">epoch</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">epochs</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">train_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">coro</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coro/man/collect.html">loop</a></span><span class="op">(</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">batch</span> <span class="kw">in</span> <span class="va">dataloader</span><span class="op">)</span> <span class="op">{</span> </span>
<span>      <span class="va">opt</span><span class="op">$</span><span class="fu">zero_grad</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">pred</span> <span class="op">=</span> <span class="fu">model_torch</span><span class="op">(</span><span class="va">batch</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="va">loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nnf_mse_loss.html">nnf_mse_loss</a></span><span class="op">(</span><span class="va">pred</span>, <span class="va">batch</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="kw">for</span><span class="op">(</span><span class="va">p</span> <span class="kw">in</span> <span class="va">model_torch</span><span class="op">$</span><span class="va">parameters</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="co"># if(length(dim(p)) &gt; 1) loss = loss + torch_norm(p, p = 2L)</span></span>
<span>        <span class="va">loss</span> <span class="op">=</span> <span class="va">loss</span> <span class="op">+</span> <span class="va">lambda</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_norm.html">torch_norm</a></span><span class="op">(</span><span class="va">p</span>, p <span class="op">=</span> <span class="fl">2L</span><span class="op">)</span> <span class="op">+</span> <span class="va">lambda</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_norm.html">torch_norm</a></span><span class="op">(</span><span class="va">p</span>, p <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>      <span class="va">loss</span><span class="op">$</span><span class="fu">backward</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">opt</span><span class="op">$</span><span class="fu">step</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">train_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">train_loss</span>, <span class="va">loss</span><span class="op">$</span><span class="fu">item</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">train_losses</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">train_losses</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">train_loss</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="va">epoch</span><span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span><span class="fl">10</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"Loss at epoch %d: %3f\n"</span>, <span class="va">epoch</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">train_loss</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Loss at epoch 10: 1860.722168</span></span>
<span><span class="co">#&gt; Loss at epoch 20: 1589.371826</span></span>
<span><span class="co">#&gt; Loss at epoch 30: 1598.806152</span></span>
<span><span class="co">#&gt; Loss at epoch 40: 1604.344147</span></span>
<span><span class="co">#&gt; Loss at epoch 50: 1583.508484</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">train_losses</span>, type <span class="op">=</span> <span class="st">"o"</span>, pch <span class="op">=</span> <span class="fl">15</span>,</span>
<span>        col <span class="op">=</span> <span class="st">"darkblue"</span>, lty <span class="op">=</span> <span class="fl">1</span>, xlab <span class="op">=</span> <span class="st">"Epoch"</span>,</span>
<span>        ylab <span class="op">=</span> <span class="st">"Loss"</span>, las <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_13_torch-1.png" width="100%" style="display: block; margin: auto;"></div>
</div>
</div>
<p>This kind of regularization is called <strong>Elastic net</strong>. It is a combination of LASSO (<span class="math inline">\(L1\)</span>) and Ridge. It is more flexible than <span class="math inline">\(L1\)</span> and less flexible than <span class="math inline">\(L2\)</span> and higher computational cost. Elastic net does shrinkage as well, but does not separate highly correlated parameters out that much.</p>
    
  </details><br><hr>
<strong><span style="color: #0011AA; font-size:18px;">4. Task</span></strong><br><p>Use a holdout/validation split!</p>
<div class="panelset">
<div class="panel">
<p><span class="panel-name">Keras</span></p>
<p>In Keras you can tell the model to keep a specific percentage of the data as holdout (validation_split argument in the fit function):</p>
<div class="sourceCode" id="cb296"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/set_random_seed.html">set_random_seed</a></span><span class="op">(</span><span class="fl">321L</span>, disable_gpu <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># Already sets R's random seed.</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">airquality</span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="fl">2</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="va">data</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">100L</span>, activation <span class="op">=</span> <span class="st">"relu"</span>, input_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fl">5L</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">100L</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">100L</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># One output dimension with a linear activation function.</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">1L</span>, activation <span class="op">=</span> <span class="st">"linear"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html">compile</a></span><span class="op">(</span>loss <span class="op">=</span> <span class="va">loss_mean_squared_error</span>, <span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_adamax.html">optimizer_adamax</a></span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_history</span> <span class="op">=</span></span>
<span>  <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">y</span>, ncol <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span>, epochs <span class="op">=</span> <span class="fl">50L</span>, batch_size <span class="op">=</span> <span class="fl">20L</span>,</span>
<span>        shuffle <span class="op">=</span> <span class="cn">TRUE</span>, validation_split <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model_history</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_14-1.png" width="100%" style="display: block; margin: auto;"></div>
</div>
<div class="panel">
<p><span class="panel-name">Torch</span></p>
<p>In Torch we create two dataloaders, one for the training data and one for the validation data:</p>
<div class="sourceCode" id="cb297"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs">torch</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_manual_seed.html">torch_manual_seed</a></span><span class="op">(</span><span class="fl">321L</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">airquality</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">airquality</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Ozone</span>, ncol <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">model_torch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_sequential.html">nn_sequential</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html">nn_linear</a></span><span class="op">(</span>in_features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, out_features <span class="op">=</span> <span class="fl">50L</span>,  bias <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_relu.html">nn_relu</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html">nn_linear</a></span><span class="op">(</span>in_features <span class="op">=</span> <span class="fl">50L</span>, out_features <span class="op">=</span> <span class="fl">50L</span>,  bias <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_relu.html">nn_relu</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html">nn_linear</a></span><span class="op">(</span>in_features <span class="op">=</span> <span class="fl">50L</span>, out_features <span class="op">=</span> <span class="fl">1L</span>,  bias <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">opt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/optim_adam.html">optim_adam</a></span><span class="op">(</span>params <span class="op">=</span> <span class="va">model_torch</span><span class="op">$</span><span class="va">parameters</span>, lr <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">indices</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="fl">0.8</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">dataset</span> <span class="op">=</span> <span class="fu">torch_dataset</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="va">indices</span>, <span class="op">]</span>,<span class="va">y</span><span class="op">[</span><span class="va">indices</span>, ,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">dataset_val</span> <span class="op">=</span> <span class="fu">torch_dataset</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="op">-</span><span class="va">indices</span>, <span class="op">]</span>,<span class="va">y</span><span class="op">[</span><span class="op">-</span><span class="va">indices</span>, ,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">dataloader</span> <span class="op">=</span> <span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/dataloader.html">dataloader</a></span><span class="op">(</span><span class="va">dataset</span>, batch_size <span class="op">=</span> <span class="fl">30L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">dataloader_val</span> <span class="op">=</span> <span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/dataloader.html">dataloader</a></span><span class="op">(</span><span class="va">dataset</span>, batch_size <span class="op">=</span> <span class="fl">30L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">epochs</span> <span class="op">=</span> <span class="fl">50L</span></span>
<span><span class="va">train_losses</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">val_losses</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">epoch</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">epochs</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">train_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">val_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">coro</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coro/man/collect.html">loop</a></span><span class="op">(</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">batch</span> <span class="kw">in</span> <span class="va">dataloader</span><span class="op">)</span> <span class="op">{</span> </span>
<span>      <span class="va">opt</span><span class="op">$</span><span class="fu">zero_grad</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">pred</span> <span class="op">=</span> <span class="fu">model_torch</span><span class="op">(</span><span class="va">batch</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="va">loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nnf_mse_loss.html">nnf_mse_loss</a></span><span class="op">(</span><span class="va">pred</span>, <span class="va">batch</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="va">loss</span><span class="op">$</span><span class="fu">backward</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">opt</span><span class="op">$</span><span class="fu">step</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">train_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">train_loss</span>, <span class="va">loss</span><span class="op">$</span><span class="fu">item</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="co">## Calculate validation loss ##</span></span>
<span>  <span class="fu">coro</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coro/man/collect.html">loop</a></span><span class="op">(</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">batch</span> <span class="kw">in</span> <span class="va">dataloader_val</span><span class="op">)</span> <span class="op">{</span> </span>
<span>      <span class="va">pred</span> <span class="op">=</span> <span class="fu">model_torch</span><span class="op">(</span><span class="va">batch</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="va">loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nnf_mse_loss.html">nnf_mse_loss</a></span><span class="op">(</span><span class="va">pred</span>, <span class="va">batch</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="va">val_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">val_loss</span>, <span class="va">loss</span><span class="op">$</span><span class="fu">item</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="va">train_losses</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">train_losses</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">train_loss</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">val_losses</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">val_losses</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">val_loss</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="va">epoch</span><span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span><span class="fl">10</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"Loss at epoch %d: %3f  Val loss: %3f\n"</span>, <span class="va">epoch</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">train_loss</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">val_loss</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Loss at epoch 10: 667.048848  Val loss: 541.639791</span></span>
<span><span class="co">#&gt; Loss at epoch 20: 312.970846  Val loss: 305.456772</span></span>
<span><span class="co">#&gt; Loss at epoch 30: 215.118795  Val loss: 210.573797</span></span>
<span><span class="co">#&gt; Loss at epoch 40: 145.177879  Val loss: 146.719173</span></span>
<span><span class="co">#&gt; Loss at epoch 50: 114.253807  Val loss: 104.073695</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html">matplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">train_losses</span>, <span class="va">val_losses</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"o"</span>, pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">15</span>, <span class="fl">16</span><span class="op">)</span>,</span>
<span>        col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"darkblue"</span>, <span class="st">"darkred"</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fl">1</span>, xlab <span class="op">=</span> <span class="st">"Epoch"</span>,</span>
<span>        ylab <span class="op">=</span> <span class="st">"Loss"</span>, las <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span><span class="op">(</span><span class="st">"topright"</span>, bty <span class="op">=</span> <span class="st">"n"</span>, </span>
<span>       legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Train loss"</span>, <span class="st">"Val loss"</span><span class="op">)</span>, </span>
<span>       pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">15</span>, <span class="fl">16</span><span class="op">)</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"darkblue"</span>, <span class="st">"darkred"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_14_torch-1.png" width="100%" style="display: block; margin: auto;"></div>
</div>
<div class="panel">
<p><span class="panel-name">Cito</span></p>
<p>As you might have noticed, there is no fit function in torch and we would have to write the fit/training function on our own. However there is a new package called <a href="https://github.com/citoverse/cito">‘cito’</a> (based on torch) that allows to do everything we need in one line of code.</p>
<div class="sourceCode" id="cb298"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># devtools::install_github("citoverse/cito")</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">cito</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">airquality</span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="va">data</span><span class="op">[</span>,<span class="fl">2</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="fl">2</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/cito/man/dnn.html">dnn</a></span><span class="op">(</span><span class="va">Ozone</span><span class="op">~</span><span class="va">.</span>, </span>
<span>            data <span class="op">=</span> <span class="va">data</span>, </span>
<span>            loss <span class="op">=</span> <span class="st">"mse"</span>, </span>
<span>            hidden <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">100L</span>, <span class="fl">3L</span><span class="op">)</span>, </span>
<span>            activation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"relu"</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>            validation <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span>
<span><span class="co">#&gt; Loss at epoch 1: training: 2727.625, validation: 2943.772, lr: 0.01000</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_14_cito-1.png" width="100%" style="display: block; margin: auto;"></div>
<pre><code>#&gt; Loss at epoch 2: training: 2219.949, validation: 1751.822, lr: 0.01000
#&gt; Loss at epoch 3: training: 1161.460, validation: 749.765, lr: 0.01000
#&gt; Loss at epoch 4: training: 839.385, validation: 670.991, lr: 0.01000
#&gt; Loss at epoch 5: training: 503.821, validation: 247.064, lr: 0.01000
#&gt; Loss at epoch 6: training: 397.692, validation: 237.813, lr: 0.01000
#&gt; Loss at epoch 7: training: 404.759, validation: 279.735, lr: 0.01000
#&gt; Loss at epoch 8: training: 385.765, validation: 499.828, lr: 0.01000
#&gt; Loss at epoch 9: training: 403.803, validation: 410.069, lr: 0.01000
#&gt; Loss at epoch 10: training: 364.150, validation: 302.399, lr: 0.01000
#&gt; Loss at epoch 11: training: 363.741, validation: 311.543, lr: 0.01000
#&gt; Loss at epoch 12: training: 335.237, validation: 395.540, lr: 0.01000
#&gt; Loss at epoch 13: training: 324.224, validation: 366.540, lr: 0.01000
#&gt; Loss at epoch 14: training: 305.847, validation: 297.235, lr: 0.01000
#&gt; Loss at epoch 15: training: 306.413, validation: 302.437, lr: 0.01000
#&gt; Loss at epoch 16: training: 300.281, validation: 346.101, lr: 0.01000
#&gt; Loss at epoch 17: training: 298.922, validation: 336.537, lr: 0.01000
#&gt; Loss at epoch 18: training: 294.127, validation: 308.364, lr: 0.01000
#&gt; Loss at epoch 19: training: 291.176, validation: 316.795, lr: 0.01000
#&gt; Loss at epoch 20: training: 284.996, validation: 336.547, lr: 0.01000
#&gt; Loss at epoch 21: training: 280.721, validation: 319.395, lr: 0.01000
#&gt; Loss at epoch 22: training: 276.327, validation: 304.193, lr: 0.01000
#&gt; Loss at epoch 23: training: 272.264, validation: 314.108, lr: 0.01000
#&gt; Loss at epoch 24: training: 267.946, validation: 317.537, lr: 0.01000
#&gt; Loss at epoch 25: training: 263.750, validation: 305.008, lr: 0.01000
#&gt; Loss at epoch 26: training: 259.456, validation: 306.201, lr: 0.01000
#&gt; Loss at epoch 27: training: 254.371, validation: 314.152, lr: 0.01000
#&gt; Loss at epoch 28: training: 249.940, validation: 309.370, lr: 0.01000
#&gt; Loss at epoch 29: training: 244.954, validation: 310.888, lr: 0.01000
#&gt; Loss at epoch 30: training: 239.748, validation: 317.827, lr: 0.01000
#&gt; Loss at epoch 31: training: 234.382, validation: 316.355, lr: 0.01000
#&gt; Loss at epoch 32: training: 228.147, validation: 317.936, lr: 0.01000</code></pre>
</div>
</div>
<p>Run the code and view the loss for the train and the validation (test) set in the viewer/plot panel. Increase the network size (e.g. number of hidden layers or the number of hidden neurons in each layer). What happens with the validation loss? Why?</p>
  <details><summary><strong><span style="color: #0011AA; font-size:18px;">Solution</span></strong>
    </summary><p>
</p>
<p>The training loss keeps decreasing, but the validation loss increases after a time. This increase in validation loss is due to overfitting.</p>
    
  </details><br><hr>
<strong><span style="color: #0011AA; font-size:18px;">5. Task</span></strong><br><p>Add <span class="math inline">\(L1\)</span> / <span class="math inline">\(L2\)</span> regularization to the neural network above and try to keep the test loss close to the training loss. Try higher epoch numbers!</p>
<p>Explain the strategy that helps to achieve this.</p>
  <details><summary><strong><span style="color: #0011AA; font-size:18px;">Solution</span></strong>
    </summary><p>
</p>
<p><strong>Adding regularization (</strong><span class="math inline">\(L1\)</span> <strong>and</strong> <span class="math inline">\(L2\)</span><strong>):</strong></p>
<div class="panelset">
<div class="panel">
<p><span class="panel-name">Keras</span></p>
<div class="sourceCode" id="cb300"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/set_random_seed.html">set_random_seed</a></span><span class="op">(</span><span class="fl">321L</span>, disable_gpu <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># Already sets R's random seed.</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">airquality</span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="fl">2</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="va">data</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">100L</span>, activation <span class="op">=</span> <span class="st">"relu"</span>, input_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fl">5L</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">100L</span>, kernel_regularizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l1_l2</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>,</span>
<span>              bias_regularizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l1</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">100L</span>, kernel_regularizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l1_l2</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>,</span>
<span>              bias_regularizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l1</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># One output dimension with a linear activation function.</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">1L</span>, activation <span class="op">=</span> <span class="st">"linear"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html">compile</a></span><span class="op">(</span>loss <span class="op">=</span> <span class="va">loss_mean_squared_error</span>, <span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_adamax.html">optimizer_adamax</a></span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_history</span> <span class="op">=</span></span>
<span>  <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">y</span>, ncol <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span>, epochs <span class="op">=</span> <span class="fl">150L</span>, batch_size <span class="op">=</span> <span class="fl">20L</span>,</span>
<span>        shuffle <span class="op">=</span> <span class="cn">TRUE</span>, validation_split <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model_history</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_15-1.png" width="100%" style="display: block; margin: auto;"></div>
</div>
<div class="panel">
<p><span class="panel-name">Torch</span></p>
<div class="sourceCode" id="cb301"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs">torch</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_manual_seed.html">torch_manual_seed</a></span><span class="op">(</span><span class="fl">321L</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">airquality</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">airquality</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Ozone</span>, ncol <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">model_torch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_sequential.html">nn_sequential</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html">nn_linear</a></span><span class="op">(</span>in_features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, out_features <span class="op">=</span> <span class="fl">50L</span>,  bias <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_relu.html">nn_relu</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html">nn_linear</a></span><span class="op">(</span>in_features <span class="op">=</span> <span class="fl">50L</span>, out_features <span class="op">=</span> <span class="fl">50L</span>,  bias <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_relu.html">nn_relu</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html">nn_linear</a></span><span class="op">(</span>in_features <span class="op">=</span> <span class="fl">50L</span>, out_features <span class="op">=</span> <span class="fl">1L</span>,  bias <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">opt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/optim_adam.html">optim_adam</a></span><span class="op">(</span>params <span class="op">=</span> <span class="va">model_torch</span><span class="op">$</span><span class="va">parameters</span>, lr <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">indices</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="fl">0.8</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">dataset</span> <span class="op">=</span> <span class="fu">torch_dataset</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="va">indices</span>, <span class="op">]</span>,<span class="va">y</span><span class="op">[</span><span class="va">indices</span>, ,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">dataset_val</span> <span class="op">=</span> <span class="fu">torch_dataset</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="op">-</span><span class="va">indices</span>, <span class="op">]</span>,<span class="va">y</span><span class="op">[</span><span class="op">-</span><span class="va">indices</span>, ,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">dataloader</span> <span class="op">=</span> <span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/dataloader.html">dataloader</a></span><span class="op">(</span><span class="va">dataset</span>, batch_size <span class="op">=</span> <span class="fl">30L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">dataloader_val</span> <span class="op">=</span> <span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/dataloader.html">dataloader</a></span><span class="op">(</span><span class="va">dataset</span>, batch_size <span class="op">=</span> <span class="fl">30L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">epochs</span> <span class="op">=</span> <span class="fl">50L</span></span>
<span><span class="va">train_losses</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">val_losses</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">lambda</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">epoch</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">epochs</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">train_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">val_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">coro</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coro/man/collect.html">loop</a></span><span class="op">(</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">batch</span> <span class="kw">in</span> <span class="va">dataloader</span><span class="op">)</span> <span class="op">{</span> </span>
<span>      <span class="va">opt</span><span class="op">$</span><span class="fu">zero_grad</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">pred</span> <span class="op">=</span> <span class="fu">model_torch</span><span class="op">(</span><span class="va">batch</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="va">loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nnf_mse_loss.html">nnf_mse_loss</a></span><span class="op">(</span><span class="va">pred</span>, <span class="va">batch</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="kw">for</span><span class="op">(</span><span class="va">p</span> <span class="kw">in</span> <span class="va">model_torch</span><span class="op">$</span><span class="va">parameters</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="va">loss</span> <span class="op">=</span> <span class="va">loss</span> <span class="op">+</span> <span class="va">lambda</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_norm.html">torch_norm</a></span><span class="op">(</span><span class="va">p</span>, p <span class="op">=</span> <span class="fl">2L</span><span class="op">)</span> <span class="op">+</span> <span class="va">lambda</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_norm.html">torch_norm</a></span><span class="op">(</span><span class="va">p</span>, p <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>      <span class="va">loss</span><span class="op">$</span><span class="fu">backward</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">opt</span><span class="op">$</span><span class="fu">step</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">train_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">train_loss</span>, <span class="va">loss</span><span class="op">$</span><span class="fu">item</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="co">## Calculate validation loss ##</span></span>
<span>  <span class="fu">coro</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coro/man/collect.html">loop</a></span><span class="op">(</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">batch</span> <span class="kw">in</span> <span class="va">dataloader_val</span><span class="op">)</span> <span class="op">{</span> </span>
<span>      <span class="va">pred</span> <span class="op">=</span> <span class="fu">model_torch</span><span class="op">(</span><span class="va">batch</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="va">loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nnf_mse_loss.html">nnf_mse_loss</a></span><span class="op">(</span><span class="va">pred</span>, <span class="va">batch</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="va">val_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">val_loss</span>, <span class="va">loss</span><span class="op">$</span><span class="fu">item</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="va">train_losses</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">train_losses</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">train_loss</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">val_losses</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">val_losses</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">val_loss</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="va">epoch</span><span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span><span class="fl">10</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"Loss at epoch %d: %3f  Val loss: %3f\n"</span>, <span class="va">epoch</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">train_loss</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">val_loss</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Loss at epoch 10: 300.949865  Val loss: 282.833649</span></span>
<span><span class="co">#&gt; Loss at epoch 20: 209.744151  Val loss: 221.161560</span></span>
<span><span class="co">#&gt; Loss at epoch 30: 226.921717  Val loss: 232.360367</span></span>
<span><span class="co">#&gt; Loss at epoch 40: 141.118450  Val loss: 100.483439</span></span>
<span><span class="co">#&gt; Loss at epoch 50: 82.738002  Val loss: 64.462316</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html">matplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">train_losses</span>, <span class="va">val_losses</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"o"</span>, pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">15</span>, <span class="fl">16</span><span class="op">)</span>,</span>
<span>        col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"darkblue"</span>, <span class="st">"darkred"</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fl">1</span>, xlab <span class="op">=</span> <span class="st">"Epoch"</span>,</span>
<span>        ylab <span class="op">=</span> <span class="st">"Loss"</span>, las <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span><span class="op">(</span><span class="st">"topright"</span>, bty <span class="op">=</span> <span class="st">"n"</span>, </span>
<span>       legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Train loss"</span>, <span class="st">"Val loss"</span><span class="op">)</span>, </span>
<span>       pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">15</span>, <span class="fl">16</span><span class="op">)</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"darkblue"</span>, <span class="st">"darkred"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_141_torch-1.png" width="100%" style="display: block; margin: auto;"></div>
</div>
<div class="panel">
<p><span class="panel-name">Cito</span></p>
<div class="sourceCode" id="cb302"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># devtools::install_github("citoverse/cito")</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">cito</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">airquality</span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="va">data</span><span class="op">[</span>,<span class="fl">2</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="fl">2</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/cito/man/dnn.html">dnn</a></span><span class="op">(</span><span class="va">Ozone</span><span class="op">~</span><span class="va">.</span>, </span>
<span>            data <span class="op">=</span> <span class="va">data</span>, </span>
<span>            loss <span class="op">=</span> <span class="st">"mse"</span>, </span>
<span>            hidden <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">100L</span>, <span class="fl">3L</span><span class="op">)</span>, </span>
<span>            activation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"relu"</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>            validation <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>            lambda <span class="op">=</span> <span class="fl">5.</span>,</span>
<span>            alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="co">#&gt; Loss at epoch 1: training: 5132.135, validation: 4803.128, lr: 0.01000</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_15_cito-1.png" width="100%" style="display: block; margin: auto;"></div>
<pre><code>#&gt; Loss at epoch 2: training: 4037.754, validation: 4055.183, lr: 0.01000
#&gt; Loss at epoch 3: training: 3452.531, validation: 3794.270, lr: 0.01000
#&gt; Loss at epoch 4: training: 3333.292, validation: 3802.902, lr: 0.01000
#&gt; Loss at epoch 5: training: 3276.066, validation: 3594.412, lr: 0.01000
#&gt; Loss at epoch 6: training: 3033.098, validation: 3234.983, lr: 0.01000
#&gt; Loss at epoch 7: training: 2651.150, validation: 2627.195, lr: 0.01000
#&gt; Loss at epoch 8: training: 2032.167, validation: 1708.311, lr: 0.01000
#&gt; Loss at epoch 9: training: 1506.195, validation: 1635.094, lr: 0.01000
#&gt; Loss at epoch 10: training: 1518.036, validation: 1269.873, lr: 0.01000
#&gt; Loss at epoch 11: training: 1225.803, validation: 1164.637, lr: 0.01000
#&gt; Loss at epoch 12: training: 1197.830, validation: 1069.938, lr: 0.01000
#&gt; Loss at epoch 13: training: 1067.111, validation: 1020.187, lr: 0.01000
#&gt; Loss at epoch 14: training: 1013.407, validation: 1091.277, lr: 0.01000
#&gt; Loss at epoch 15: training: 980.605, validation: 935.250, lr: 0.01000
#&gt; Loss at epoch 16: training: 931.649, validation: 868.834, lr: 0.01000
#&gt; Loss at epoch 17: training: 907.558, validation: 848.919, lr: 0.01000
#&gt; Loss at epoch 18: training: 865.158, validation: 883.693, lr: 0.01000
#&gt; Loss at epoch 19: training: 852.313, validation: 852.561, lr: 0.01000
#&gt; Loss at epoch 20: training: 828.706, validation: 792.463, lr: 0.01000
#&gt; Loss at epoch 21: training: 810.910, validation: 770.522, lr: 0.01000
#&gt; Loss at epoch 22: training: 789.190, validation: 780.262, lr: 0.01000
#&gt; Loss at epoch 23: training: 773.155, validation: 772.059, lr: 0.01000
#&gt; Loss at epoch 24: training: 759.146, validation: 743.177, lr: 0.01000
#&gt; Loss at epoch 25: training: 746.524, validation: 727.122, lr: 0.01000
#&gt; Loss at epoch 26: training: 733.988, validation: 725.905, lr: 0.01000
#&gt; Loss at epoch 27: training: 723.263, validation: 720.861, lr: 0.01000
#&gt; Loss at epoch 28: training: 714.193, validation: 709.049, lr: 0.01000
#&gt; Loss at epoch 29: training: 705.598, validation: 696.874, lr: 0.01000
#&gt; Loss at epoch 30: training: 695.459, validation: 694.254, lr: 0.01000
#&gt; Loss at epoch 31: training: 687.815, validation: 687.747, lr: 0.01000
#&gt; Loss at epoch 32: training: 680.873, validation: 680.050, lr: 0.01000</code></pre>
</div>
</div>
<p><strong>Adding higher regularization (</strong><span class="math inline">\(L1\)</span> <strong>and</strong> <span class="math inline">\(L2\)</span><strong>):</strong></p>
<div class="panelset">
<div class="panel">
<p><span class="panel-name">Keras</span></p>
<div class="sourceCode" id="cb304"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/set_random_seed.html">set_random_seed</a></span><span class="op">(</span><span class="fl">321L</span>, disable_gpu <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># Already sets R's random seed.</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">airquality</span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="fl">2</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="va">data</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">100L</span>, activation <span class="op">=</span> <span class="st">"relu"</span>, input_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fl">5L</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">100L</span>, kernel_regularizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l1_l2</a></span><span class="op">(</span><span class="fl">15</span><span class="op">)</span>,</span>
<span>              bias_regularizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l1</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">100L</span>, kernel_regularizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l1_l2</a></span><span class="op">(</span><span class="fl">15</span><span class="op">)</span>,</span>
<span>              bias_regularizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l1</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># One output dimension with a linear activation function.</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">1L</span>, activation <span class="op">=</span> <span class="st">"linear"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html">compile</a></span><span class="op">(</span>loss <span class="op">=</span> <span class="va">loss_mean_squared_error</span>, <span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_adamax.html">optimizer_adamax</a></span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_history</span> <span class="op">=</span></span>
<span>  <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">y</span>, ncol <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span>, epochs <span class="op">=</span> <span class="fl">150L</span>, batch_size <span class="op">=</span> <span class="fl">20L</span>,</span>
<span>        shuffle <span class="op">=</span> <span class="cn">TRUE</span>, validation_split <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model_history</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_16-1.png" width="100%" style="display: block; margin: auto;"></div>
</div>
<div class="panel">
<p><span class="panel-name">Torch</span></p>
<div class="sourceCode" id="cb305"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs">torch</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_manual_seed.html">torch_manual_seed</a></span><span class="op">(</span><span class="fl">321L</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">airquality</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">airquality</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Ozone</span>, ncol <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">model_torch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_sequential.html">nn_sequential</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html">nn_linear</a></span><span class="op">(</span>in_features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, out_features <span class="op">=</span> <span class="fl">50L</span>,  bias <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_relu.html">nn_relu</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html">nn_linear</a></span><span class="op">(</span>in_features <span class="op">=</span> <span class="fl">50L</span>, out_features <span class="op">=</span> <span class="fl">50L</span>,  bias <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_relu.html">nn_relu</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html">nn_linear</a></span><span class="op">(</span>in_features <span class="op">=</span> <span class="fl">50L</span>, out_features <span class="op">=</span> <span class="fl">1L</span>,  bias <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">opt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/optim_adam.html">optim_adam</a></span><span class="op">(</span>params <span class="op">=</span> <span class="va">model_torch</span><span class="op">$</span><span class="va">parameters</span>, lr <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">indices</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="fl">0.8</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">dataset</span> <span class="op">=</span> <span class="fu">torch_dataset</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="va">indices</span>, <span class="op">]</span>,<span class="va">y</span><span class="op">[</span><span class="va">indices</span>, ,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">dataset_val</span> <span class="op">=</span> <span class="fu">torch_dataset</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="op">-</span><span class="va">indices</span>, <span class="op">]</span>,<span class="va">y</span><span class="op">[</span><span class="op">-</span><span class="va">indices</span>, ,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">dataloader</span> <span class="op">=</span> <span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/dataloader.html">dataloader</a></span><span class="op">(</span><span class="va">dataset</span>, batch_size <span class="op">=</span> <span class="fl">30L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">dataloader_val</span> <span class="op">=</span> <span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/dataloader.html">dataloader</a></span><span class="op">(</span><span class="va">dataset</span>, batch_size <span class="op">=</span> <span class="fl">30L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">epochs</span> <span class="op">=</span> <span class="fl">50L</span></span>
<span><span class="va">train_losses</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">val_losses</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">lambda</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="fl">15.01</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">epoch</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">epochs</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">train_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">val_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">coro</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coro/man/collect.html">loop</a></span><span class="op">(</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">batch</span> <span class="kw">in</span> <span class="va">dataloader</span><span class="op">)</span> <span class="op">{</span> </span>
<span>      <span class="va">opt</span><span class="op">$</span><span class="fu">zero_grad</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">pred</span> <span class="op">=</span> <span class="fu">model_torch</span><span class="op">(</span><span class="va">batch</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="va">loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nnf_mse_loss.html">nnf_mse_loss</a></span><span class="op">(</span><span class="va">pred</span>, <span class="va">batch</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="kw">for</span><span class="op">(</span><span class="va">p</span> <span class="kw">in</span> <span class="va">model_torch</span><span class="op">$</span><span class="va">parameters</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="va">loss</span> <span class="op">=</span> <span class="va">loss</span> <span class="op">+</span> <span class="va">lambda</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_norm.html">torch_norm</a></span><span class="op">(</span><span class="va">p</span>, p <span class="op">=</span> <span class="fl">2L</span><span class="op">)</span> <span class="op">+</span> <span class="va">lambda</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_norm.html">torch_norm</a></span><span class="op">(</span><span class="va">p</span>, p <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>      <span class="va">loss</span><span class="op">$</span><span class="fu">backward</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">opt</span><span class="op">$</span><span class="fu">step</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">train_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">train_loss</span>, <span class="va">loss</span><span class="op">$</span><span class="fu">item</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="co">## Calculate validation loss ##</span></span>
<span>  <span class="fu">coro</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coro/man/collect.html">loop</a></span><span class="op">(</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">batch</span> <span class="kw">in</span> <span class="va">dataloader_val</span><span class="op">)</span> <span class="op">{</span> </span>
<span>      <span class="va">pred</span> <span class="op">=</span> <span class="fu">model_torch</span><span class="op">(</span><span class="va">batch</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="va">loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nnf_mse_loss.html">nnf_mse_loss</a></span><span class="op">(</span><span class="va">pred</span>, <span class="va">batch</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="va">val_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">val_loss</span>, <span class="va">loss</span><span class="op">$</span><span class="fu">item</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="va">train_losses</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">train_losses</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">train_loss</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">val_losses</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">val_losses</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">val_loss</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="va">epoch</span><span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span><span class="fl">10</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"Loss at epoch %d: %3f  Val loss: %3f\n"</span>, <span class="va">epoch</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">train_loss</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">val_loss</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Loss at epoch 10: 1944.234131  Val loss: 356.418696</span></span>
<span><span class="co">#&gt; Loss at epoch 20: 1554.797770  Val loss: 333.019099</span></span>
<span><span class="co">#&gt; Loss at epoch 30: 1410.753906  Val loss: 315.205480</span></span>
<span><span class="co">#&gt; Loss at epoch 40: 1357.596029  Val loss: 308.515640</span></span>
<span><span class="co">#&gt; Loss at epoch 50: 1323.215129  Val loss: 311.642059</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html">matplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">train_losses</span>, <span class="va">val_losses</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"o"</span>, pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">15</span>, <span class="fl">16</span><span class="op">)</span>,</span>
<span>        col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"darkblue"</span>, <span class="st">"darkred"</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fl">1</span>, xlab <span class="op">=</span> <span class="st">"Epoch"</span>,</span>
<span>        ylab <span class="op">=</span> <span class="st">"Loss"</span>, las <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span><span class="op">(</span><span class="st">"topright"</span>, bty <span class="op">=</span> <span class="st">"n"</span>, </span>
<span>       legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Train loss"</span>, <span class="st">"Val loss"</span><span class="op">)</span>, </span>
<span>       pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">15</span>, <span class="fl">16</span><span class="op">)</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"darkblue"</span>, <span class="st">"darkred"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_142_torch-1.png" width="100%" style="display: block; margin: auto;"></div>
</div>
<div class="panel">
<p><span class="panel-name">Cito</span></p>
<div class="sourceCode" id="cb306"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># devtools::install_github("citoverse/cito")</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">cito</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">airquality</span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="va">data</span><span class="op">[</span>,<span class="fl">2</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="fl">2</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/cito/man/dnn.html">dnn</a></span><span class="op">(</span><span class="va">Ozone</span><span class="op">~</span><span class="va">.</span>, </span>
<span>            data <span class="op">=</span> <span class="va">data</span>, </span>
<span>            loss <span class="op">=</span> <span class="st">"mse"</span>, </span>
<span>            hidden <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">100L</span>, <span class="fl">3L</span><span class="op">)</span>, </span>
<span>            activation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"relu"</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>            validation <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>            lambda <span class="op">=</span> <span class="fl">15.</span>,</span>
<span>            alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="co">#&gt; Loss at epoch 1: training: 9552.711, validation: 8833.547, lr: 0.01000</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_16_cito-1.png" width="100%" style="display: block; margin: auto;"></div>
<pre><code>#&gt; Loss at epoch 2: training: 6291.424, validation: 6609.855, lr: 0.01000
#&gt; Loss at epoch 3: training: 4579.450, validation: 5919.222, lr: 0.01000
#&gt; Loss at epoch 4: training: 4309.572, validation: 6043.946, lr: 0.01000
#&gt; Loss at epoch 5: training: 4259.564, validation: 5675.108, lr: 0.01000
#&gt; Loss at epoch 6: training: 3825.695, validation: 5207.552, lr: 0.01000
#&gt; Loss at epoch 7: training: 3425.054, validation: 5009.489, lr: 0.01000
#&gt; Loss at epoch 8: training: 3317.930, validation: 4927.411, lr: 0.01000
#&gt; Loss at epoch 9: training: 3175.219, validation: 4710.522, lr: 0.01000
#&gt; Loss at epoch 10: training: 2984.521, validation: 4582.708, lr: 0.01000
#&gt; Loss at epoch 11: training: 2884.176, validation: 4484.433, lr: 0.01000
#&gt; Loss at epoch 12: training: 2782.358, validation: 4367.329, lr: 0.01000
#&gt; Loss at epoch 13: training: 2683.173, validation: 4267.801, lr: 0.01000
#&gt; Loss at epoch 14: training: 2615.296, validation: 4177.524, lr: 0.01000
#&gt; Loss at epoch 15: training: 2514.327, validation: 4042.495, lr: 0.01000
#&gt; Loss at epoch 16: training: 2414.864, validation: 3891.489, lr: 0.01000
#&gt; Loss at epoch 17: training: 2278.778, validation: 3689.674, lr: 0.01000
#&gt; Loss at epoch 18: training: 2108.258, validation: 3383.650, lr: 0.01000
#&gt; Loss at epoch 19: training: 1878.854, validation: 3008.444, lr: 0.01000
#&gt; Loss at epoch 20: training: 1694.769, validation: 2751.500, lr: 0.01000
#&gt; Loss at epoch 21: training: 1668.852, validation: 2631.541, lr: 0.01000
#&gt; Loss at epoch 22: training: 1638.752, validation: 2559.595, lr: 0.01000
#&gt; Loss at epoch 23: training: 1553.259, validation: 2487.396, lr: 0.01000
#&gt; Loss at epoch 24: training: 1476.663, validation: 2376.811, lr: 0.01000
#&gt; Loss at epoch 25: training: 1405.264, validation: 2221.899, lr: 0.01000
#&gt; Loss at epoch 26: training: 1332.830, validation: 2051.245, lr: 0.01000
#&gt; Loss at epoch 27: training: 1261.815, validation: 1904.627, lr: 0.01000
#&gt; Loss at epoch 28: training: 1205.749, validation: 1804.344, lr: 0.01000
#&gt; Loss at epoch 29: training: 1164.656, validation: 1711.746, lr: 0.01000
#&gt; Loss at epoch 30: training: 1126.807, validation: 1653.241, lr: 0.01000
#&gt; Loss at epoch 31: training: 1095.497, validation: 1604.578, lr: 0.01000
#&gt; Loss at epoch 32: training: 1068.875, validation: 1576.547, lr: 0.01000</code></pre>
</div>
</div>
<p><em>Keep in mind: With higher regularization, both the training and the validation loss keep relatively high!</em></p>
<p><strong>Adding normal regularization (</strong><span class="math inline">\(L1\)</span> <strong>and</strong> <span class="math inline">\(L2\)</span><strong>) and use a larger learning rate:</strong></p>
<div class="panelset">
<div class="panel">
<p><span class="panel-name">Keras</span></p>
<div class="sourceCode" id="cb308"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/set_random_seed.html">set_random_seed</a></span><span class="op">(</span><span class="fl">321L</span>, disable_gpu <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># Already sets R's random seed.</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">airquality</span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="fl">2</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="va">data</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">100L</span>, activation <span class="op">=</span> <span class="st">"relu"</span>, input_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fl">5L</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">100L</span>, kernel_regularizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l1_l2</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>,</span>
<span>              bias_regularizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l1</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">100L</span>, kernel_regularizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l1_l2</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>,</span>
<span>              bias_regularizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l1</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># One output dimension with a linear activation function.</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">1L</span>, activation <span class="op">=</span> <span class="st">"linear"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html">compile</a></span><span class="op">(</span>loss <span class="op">=</span> <span class="va">loss_mean_squared_error</span>, <span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_adamax.html">optimizer_adamax</a></span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_history</span> <span class="op">=</span></span>
<span>  <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">y</span>, ncol <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span>, epochs <span class="op">=</span> <span class="fl">150L</span>, batch_size <span class="op">=</span> <span class="fl">20L</span>,</span>
<span>        shuffle <span class="op">=</span> <span class="cn">TRUE</span>, validation_split <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model_history</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_17-1.png" width="100%" style="display: block; margin: auto;"></div>
</div>
<div class="panel">
<p><span class="panel-name">Torch</span></p>
<div class="sourceCode" id="cb309"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs">torch</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_manual_seed.html">torch_manual_seed</a></span><span class="op">(</span><span class="fl">321L</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">airquality</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">airquality</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Ozone</span>, ncol <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">model_torch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_sequential.html">nn_sequential</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html">nn_linear</a></span><span class="op">(</span>in_features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, out_features <span class="op">=</span> <span class="fl">100L</span>,  bias <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_relu.html">nn_relu</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html">nn_linear</a></span><span class="op">(</span>in_features <span class="op">=</span> <span class="fl">100L</span>, out_features <span class="op">=</span> <span class="fl">100L</span>,  bias <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_relu.html">nn_relu</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html">nn_linear</a></span><span class="op">(</span>in_features <span class="op">=</span> <span class="fl">100L</span>, out_features <span class="op">=</span> <span class="fl">1L</span>,  bias <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">opt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/optim_adam.html">optim_adam</a></span><span class="op">(</span>params <span class="op">=</span> <span class="va">model_torch</span><span class="op">$</span><span class="va">parameters</span>, lr <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">indices</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="fl">0.8</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">dataset</span> <span class="op">=</span> <span class="fu">torch_dataset</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="va">indices</span>, <span class="op">]</span>,<span class="va">y</span><span class="op">[</span><span class="va">indices</span>, ,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">dataset_val</span> <span class="op">=</span> <span class="fu">torch_dataset</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="op">-</span><span class="va">indices</span>, <span class="op">]</span>,<span class="va">y</span><span class="op">[</span><span class="op">-</span><span class="va">indices</span>, ,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">dataloader</span> <span class="op">=</span> <span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/dataloader.html">dataloader</a></span><span class="op">(</span><span class="va">dataset</span>, batch_size <span class="op">=</span> <span class="fl">30L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">dataloader_val</span> <span class="op">=</span> <span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/dataloader.html">dataloader</a></span><span class="op">(</span><span class="va">dataset</span>, batch_size <span class="op">=</span> <span class="fl">30L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">epochs</span> <span class="op">=</span> <span class="fl">50L</span></span>
<span><span class="va">train_losses</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">val_losses</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">lambda</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="fl">5.01</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">epoch</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">epochs</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">train_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">val_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">coro</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coro/man/collect.html">loop</a></span><span class="op">(</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">batch</span> <span class="kw">in</span> <span class="va">dataloader</span><span class="op">)</span> <span class="op">{</span> </span>
<span>      <span class="va">opt</span><span class="op">$</span><span class="fu">zero_grad</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">pred</span> <span class="op">=</span> <span class="fu">model_torch</span><span class="op">(</span><span class="va">batch</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="va">loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nnf_mse_loss.html">nnf_mse_loss</a></span><span class="op">(</span><span class="va">pred</span>, <span class="va">batch</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="kw">for</span><span class="op">(</span><span class="va">p</span> <span class="kw">in</span> <span class="va">model_torch</span><span class="op">$</span><span class="va">parameters</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="va">loss</span> <span class="op">=</span> <span class="va">loss</span> <span class="op">+</span> <span class="va">lambda</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_norm.html">torch_norm</a></span><span class="op">(</span><span class="va">p</span>, p <span class="op">=</span> <span class="fl">2L</span><span class="op">)</span> <span class="op">+</span> <span class="va">lambda</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_norm.html">torch_norm</a></span><span class="op">(</span><span class="va">p</span>, p <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>      <span class="va">loss</span><span class="op">$</span><span class="fu">backward</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">opt</span><span class="op">$</span><span class="fu">step</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">train_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">train_loss</span>, <span class="va">loss</span><span class="op">$</span><span class="fu">item</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="co">## Calculate validation loss ##</span></span>
<span>  <span class="fu">coro</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coro/man/collect.html">loop</a></span><span class="op">(</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">batch</span> <span class="kw">in</span> <span class="va">dataloader_val</span><span class="op">)</span> <span class="op">{</span> </span>
<span>      <span class="va">pred</span> <span class="op">=</span> <span class="fu">model_torch</span><span class="op">(</span><span class="va">batch</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="va">loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nnf_mse_loss.html">nnf_mse_loss</a></span><span class="op">(</span><span class="va">pred</span>, <span class="va">batch</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="va">val_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">val_loss</span>, <span class="va">loss</span><span class="op">$</span><span class="fu">item</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="va">train_losses</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">train_losses</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">train_loss</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">val_losses</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">val_losses</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">val_loss</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="va">epoch</span><span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span><span class="fl">10</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"Loss at epoch %d: %3f  Val loss: %3f\n"</span>, <span class="va">epoch</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">train_loss</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">val_loss</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Loss at epoch 10: 3204.276042  Val loss: 330.965973</span></span>
<span><span class="co">#&gt; Loss at epoch 20: 1794.335531  Val loss: 299.112269</span></span>
<span><span class="co">#&gt; Loss at epoch 30: 1603.631795  Val loss: 309.878225</span></span>
<span><span class="co">#&gt; Loss at epoch 40: 1629.516439  Val loss: 310.106389</span></span>
<span><span class="co">#&gt; Loss at epoch 50: 1622.235474  Val loss: 306.825373</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html">matplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">train_losses</span>, <span class="va">val_losses</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"o"</span>, pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">15</span>, <span class="fl">16</span><span class="op">)</span>,</span>
<span>        col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"darkblue"</span>, <span class="st">"darkred"</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fl">1</span>, xlab <span class="op">=</span> <span class="st">"Epoch"</span>,</span>
<span>        ylab <span class="op">=</span> <span class="st">"Loss"</span>, las <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span><span class="op">(</span><span class="st">"topright"</span>, bty <span class="op">=</span> <span class="st">"n"</span>, </span>
<span>       legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Train loss"</span>, <span class="st">"Val loss"</span><span class="op">)</span>, </span>
<span>       pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">15</span>, <span class="fl">16</span><span class="op">)</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"darkblue"</span>, <span class="st">"darkred"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_143_torch-1.png" width="100%" style="display: block; margin: auto;"></div>
</div>
<div class="panel">
<p><span class="panel-name">Cito</span></p>
<div class="sourceCode" id="cb310"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># devtools::install_github("citoverse/cito")</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">cito</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">airquality</span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="va">data</span><span class="op">[</span>,<span class="fl">2</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="fl">2</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/cito/man/dnn.html">dnn</a></span><span class="op">(</span><span class="va">Ozone</span><span class="op">~</span><span class="va">.</span>, </span>
<span>            data <span class="op">=</span> <span class="va">data</span>, </span>
<span>            loss <span class="op">=</span> <span class="st">"mse"</span>, </span>
<span>            hidden <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">100L</span>, <span class="fl">3L</span><span class="op">)</span>, </span>
<span>            activation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"relu"</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>            validation <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>            lambda <span class="op">=</span> <span class="fl">5.</span>,</span>
<span>            lr <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>            alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="co">#&gt; Loss at epoch 1: training: 16327.440, validation: 9144.548, lr: 0.20000</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_17_cito-1.png" width="100%" style="display: block; margin: auto;"></div>
<pre><code>#&gt; Loss at epoch 2: training: 8257.439, validation: 10667.663, lr: 0.20000
#&gt; Loss at epoch 3: training: 9044.628, validation: 9300.070, lr: 0.20000
#&gt; Loss at epoch 4: training: 10603.996, validation: 13365.126, lr: 0.20000
#&gt; Loss at epoch 5: training: 12835.686, validation: 12399.452, lr: 0.20000
#&gt; Loss at epoch 6: training: 11700.891, validation: 11565.099, lr: 0.20000
#&gt; Loss at epoch 7: training: 11422.474, validation: 11568.539, lr: 0.20000
#&gt; Loss at epoch 8: training: 11357.537, validation: 11374.830, lr: 0.20000
#&gt; Loss at epoch 9: training: 10686.151, validation: 10641.263, lr: 0.20000
#&gt; Loss at epoch 10: training: 10102.818, validation: 11116.869, lr: 0.20000
#&gt; Loss at epoch 11: training: 10570.798, validation: 10257.980, lr: 0.20000
#&gt; Loss at epoch 12: training: 9340.195, validation: 9118.415, lr: 0.20000
#&gt; Loss at epoch 13: training: 8630.348, validation: 9357.287, lr: 0.20000
#&gt; Loss at epoch 14: training: 8727.984, validation: 8561.631, lr: 0.20000
#&gt; Loss at epoch 15: training: 7800.990, validation: 7962.877, lr: 0.20000
#&gt; Loss at epoch 16: training: 7334.145, validation: 7406.061, lr: 0.20000
#&gt; Loss at epoch 17: training: 6769.643, validation: 6981.447, lr: 0.20000
#&gt; Loss at epoch 18: training: 6306.741, validation: 6560.812, lr: 0.20000
#&gt; Loss at epoch 19: training: 5819.032, validation: 6281.702, lr: 0.20000
#&gt; Loss at epoch 20: training: 5548.384, validation: 5723.558, lr: 0.20000
#&gt; Loss at epoch 21: training: 5083.281, validation: 5456.334, lr: 0.20000
#&gt; Loss at epoch 22: training: 4798.322, validation: 5083.321, lr: 0.20000
#&gt; Loss at epoch 23: training: 4363.521, validation: 4730.824, lr: 0.20000
#&gt; Loss at epoch 24: training: 4066.876, validation: 4505.259, lr: 0.20000
#&gt; Loss at epoch 25: training: 3808.684, validation: 4172.278, lr: 0.20000
#&gt; Loss at epoch 26: training: 3513.810, validation: 3944.718, lr: 0.20000
#&gt; Loss at epoch 27: training: 3254.075, validation: 3783.761, lr: 0.20000
#&gt; Loss at epoch 28: training: 3112.667, validation: 3505.463, lr: 0.20000
#&gt; Loss at epoch 29: training: 2900.247, validation: 3282.843, lr: 0.20000
#&gt; Loss at epoch 30: training: 2720.389, validation: 3258.859, lr: 0.20000
#&gt; Loss at epoch 31: training: 2549.015, validation: 3055.973, lr: 0.20000
#&gt; Loss at epoch 32: training: 2407.888, validation: 2907.814, lr: 0.20000</code></pre>
</div>
</div>
<p><strong>Adding normal regularization (</strong><span class="math inline">\(L1\)</span> <strong>and</strong> <span class="math inline">\(L2\)</span><strong>) and use a very low learning rate:</strong></p>
<div class="panelset">
<div class="panel">
<p><span class="panel-name">Keras</span></p>
<div class="sourceCode" id="cb312"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/set_random_seed.html">set_random_seed</a></span><span class="op">(</span><span class="fl">321L</span>, disable_gpu <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># Already sets R's random seed.</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">airquality</span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="fl">2</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="va">data</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">100L</span>, activation <span class="op">=</span> <span class="st">"relu"</span>, input_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fl">5L</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">100L</span>, kernel_regularizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l1_l2</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>,</span>
<span>              bias_regularizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l1</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">100L</span>, kernel_regularizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l1_l2</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>,</span>
<span>              bias_regularizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l1</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># One output dimension with a linear activation function.</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">1L</span>, activation <span class="op">=</span> <span class="st">"linear"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html">compile</a></span><span class="op">(</span>loss <span class="op">=</span> <span class="va">loss_mean_squared_error</span>, <span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_adamax.html">optimizer_adamax</a></span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">0.001</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_history</span> <span class="op">=</span></span>
<span>  <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">y</span>, ncol <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span>, epochs <span class="op">=</span> <span class="fl">150L</span>, batch_size <span class="op">=</span> <span class="fl">20L</span>,</span>
<span>        shuffle <span class="op">=</span> <span class="cn">TRUE</span>, validation_split <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model_history</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_18-1.png" width="100%" style="display: block; margin: auto;"></div>
</div>
<div class="panel">
<p><span class="panel-name">Torch</span></p>
<div class="sourceCode" id="cb313"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs">torch</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_manual_seed.html">torch_manual_seed</a></span><span class="op">(</span><span class="fl">321L</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">airquality</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">airquality</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Ozone</span>, ncol <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">model_torch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_sequential.html">nn_sequential</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html">nn_linear</a></span><span class="op">(</span>in_features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, out_features <span class="op">=</span> <span class="fl">100L</span>,  bias <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_relu.html">nn_relu</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html">nn_linear</a></span><span class="op">(</span>in_features <span class="op">=</span> <span class="fl">100L</span>, out_features <span class="op">=</span> <span class="fl">100L</span>,  bias <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_relu.html">nn_relu</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html">nn_linear</a></span><span class="op">(</span>in_features <span class="op">=</span> <span class="fl">100L</span>, out_features <span class="op">=</span> <span class="fl">1L</span>,  bias <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">opt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/optim_adam.html">optim_adam</a></span><span class="op">(</span>params <span class="op">=</span> <span class="va">model_torch</span><span class="op">$</span><span class="va">parameters</span>, lr <span class="op">=</span> <span class="fl">0.001</span><span class="op">)</span></span>
<span></span>
<span><span class="va">indices</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="fl">0.8</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">dataset</span> <span class="op">=</span> <span class="fu">torch_dataset</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="va">indices</span>, <span class="op">]</span>,<span class="va">y</span><span class="op">[</span><span class="va">indices</span>, ,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">dataset_val</span> <span class="op">=</span> <span class="fu">torch_dataset</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="op">-</span><span class="va">indices</span>, <span class="op">]</span>,<span class="va">y</span><span class="op">[</span><span class="op">-</span><span class="va">indices</span>, ,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">dataloader</span> <span class="op">=</span> <span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/dataloader.html">dataloader</a></span><span class="op">(</span><span class="va">dataset</span>, batch_size <span class="op">=</span> <span class="fl">30L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">dataloader_val</span> <span class="op">=</span> <span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/dataloader.html">dataloader</a></span><span class="op">(</span><span class="va">dataset</span>, batch_size <span class="op">=</span> <span class="fl">30L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">epochs</span> <span class="op">=</span> <span class="fl">50L</span></span>
<span><span class="va">train_losses</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">val_losses</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">lambda</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="fl">5.01</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">epoch</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">epochs</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">train_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">val_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">coro</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coro/man/collect.html">loop</a></span><span class="op">(</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">batch</span> <span class="kw">in</span> <span class="va">dataloader</span><span class="op">)</span> <span class="op">{</span> </span>
<span>      <span class="va">opt</span><span class="op">$</span><span class="fu">zero_grad</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">pred</span> <span class="op">=</span> <span class="fu">model_torch</span><span class="op">(</span><span class="va">batch</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="va">loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nnf_mse_loss.html">nnf_mse_loss</a></span><span class="op">(</span><span class="va">pred</span>, <span class="va">batch</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="kw">for</span><span class="op">(</span><span class="va">p</span> <span class="kw">in</span> <span class="va">model_torch</span><span class="op">$</span><span class="va">parameters</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="va">loss</span> <span class="op">=</span> <span class="va">loss</span> <span class="op">+</span> <span class="va">lambda</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_norm.html">torch_norm</a></span><span class="op">(</span><span class="va">p</span>, p <span class="op">=</span> <span class="fl">2L</span><span class="op">)</span> <span class="op">+</span> <span class="va">lambda</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_norm.html">torch_norm</a></span><span class="op">(</span><span class="va">p</span>, p <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>      <span class="va">loss</span><span class="op">$</span><span class="fu">backward</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">opt</span><span class="op">$</span><span class="fu">step</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">train_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">train_loss</span>, <span class="va">loss</span><span class="op">$</span><span class="fu">item</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="co">## Calculate validation loss ##</span></span>
<span>  <span class="fu">coro</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coro/man/collect.html">loop</a></span><span class="op">(</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">batch</span> <span class="kw">in</span> <span class="va">dataloader_val</span><span class="op">)</span> <span class="op">{</span> </span>
<span>      <span class="va">pred</span> <span class="op">=</span> <span class="fu">model_torch</span><span class="op">(</span><span class="va">batch</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="va">loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nnf_mse_loss.html">nnf_mse_loss</a></span><span class="op">(</span><span class="va">pred</span>, <span class="va">batch</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="va">val_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">val_loss</span>, <span class="va">loss</span><span class="op">$</span><span class="fu">item</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="va">train_losses</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">train_losses</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">train_loss</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">val_losses</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">val_losses</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">val_loss</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="va">epoch</span><span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span><span class="fl">10</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"Loss at epoch %d: %3f  Val loss: %3f\n"</span>, <span class="va">epoch</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">train_loss</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">val_loss</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Loss at epoch 10: 4884.132324  Val loss: 2972.590088</span></span>
<span><span class="co">#&gt; Loss at epoch 20: 3938.917399  Val loss: 2947.057292</span></span>
<span><span class="co">#&gt; Loss at epoch 30: 3391.578451  Val loss: 2912.526693</span></span>
<span><span class="co">#&gt; Loss at epoch 40: 3227.987549  Val loss: 2897.406576</span></span>
<span><span class="co">#&gt; Loss at epoch 50: 3073.570109  Val loss: 2700.849609</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html">matplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">train_losses</span>, <span class="va">val_losses</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"o"</span>, pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">15</span>, <span class="fl">16</span><span class="op">)</span>,</span>
<span>        col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"darkblue"</span>, <span class="st">"darkred"</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fl">1</span>, xlab <span class="op">=</span> <span class="st">"Epoch"</span>,</span>
<span>        ylab <span class="op">=</span> <span class="st">"Loss"</span>, las <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span><span class="op">(</span><span class="st">"topright"</span>, bty <span class="op">=</span> <span class="st">"n"</span>, </span>
<span>       legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Train loss"</span>, <span class="st">"Val loss"</span><span class="op">)</span>, </span>
<span>       pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">15</span>, <span class="fl">16</span><span class="op">)</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"darkblue"</span>, <span class="st">"darkred"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_144_torch-1.png" width="100%" style="display: block; margin: auto;"></div>
</div>
<div class="panel">
<p><span class="panel-name">Cito</span></p>
<div class="sourceCode" id="cb314"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># devtools::install_github("citoverse/cito")</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">cito</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">airquality</span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="va">data</span><span class="op">[</span>,<span class="fl">2</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="fl">2</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/cito/man/dnn.html">dnn</a></span><span class="op">(</span><span class="va">Ozone</span><span class="op">~</span><span class="va">.</span>, </span>
<span>            data <span class="op">=</span> <span class="va">data</span>, </span>
<span>            loss <span class="op">=</span> <span class="st">"mse"</span>, </span>
<span>            hidden <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">100L</span>, <span class="fl">3L</span><span class="op">)</span>, </span>
<span>            activation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"relu"</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>            validation <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>            lambda <span class="op">=</span> <span class="fl">5.</span>,</span>
<span>            lr <span class="op">=</span> <span class="fl">0.001</span>,</span>
<span>            alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="co">#&gt; Loss at epoch 1: training: 5269.452, validation: 6856.531, lr: 0.00100</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_18_cito-1.png" width="100%" style="display: block; margin: auto;"></div>
<pre><code>#&gt; Loss at epoch 2: training: 5116.475, validation: 6706.862, lr: 0.00100
#&gt; Loss at epoch 3: training: 4968.938, validation: 6562.477, lr: 0.00100
#&gt; Loss at epoch 4: training: 4826.538, validation: 6422.984, lr: 0.00100
#&gt; Loss at epoch 5: training: 4689.030, validation: 6288.589, lr: 0.00100
#&gt; Loss at epoch 6: training: 4556.492, validation: 6158.768, lr: 0.00100
#&gt; Loss at epoch 7: training: 4428.344, validation: 6033.175, lr: 0.00100
#&gt; Loss at epoch 8: training: 4304.363, validation: 5911.759, lr: 0.00100
#&gt; Loss at epoch 9: training: 4184.625, validation: 5794.792, lr: 0.00100
#&gt; Loss at epoch 10: training: 4069.390, validation: 5682.192, lr: 0.00100
#&gt; Loss at epoch 11: training: 3958.662, validation: 5574.551, lr: 0.00100
#&gt; Loss at epoch 12: training: 3852.800, validation: 5471.527, lr: 0.00100
#&gt; Loss at epoch 13: training: 3751.311, validation: 5372.250, lr: 0.00100
#&gt; Loss at epoch 14: training: 3653.724, validation: 5277.475, lr: 0.00100
#&gt; Loss at epoch 15: training: 3560.818, validation: 5187.348, lr: 0.00100
#&gt; Loss at epoch 16: training: 3472.308, validation: 5101.110, lr: 0.00100
#&gt; Loss at epoch 17: training: 3387.640, validation: 5019.347, lr: 0.00100
#&gt; Loss at epoch 18: training: 3308.011, validation: 4942.825, lr: 0.00100
#&gt; Loss at epoch 19: training: 3233.465, validation: 4871.195, lr: 0.00100
#&gt; Loss at epoch 20: training: 3163.757, validation: 4804.116, lr: 0.00100
#&gt; Loss at epoch 21: training: 3098.194, validation: 4740.721, lr: 0.00100
#&gt; Loss at epoch 22: training: 3036.596, validation: 4681.640, lr: 0.00100
#&gt; Loss at epoch 23: training: 2979.298, validation: 4626.847, lr: 0.00100
#&gt; Loss at epoch 24: training: 2926.640, validation: 4576.861, lr: 0.00100
#&gt; Loss at epoch 25: training: 2878.261, validation: 4530.707, lr: 0.00100
#&gt; Loss at epoch 26: training: 2833.971, validation: 4488.954, lr: 0.00100
#&gt; Loss at epoch 27: training: 2794.252, validation: 4451.900, lr: 0.00100
#&gt; Loss at epoch 28: training: 2759.278, validation: 4419.588, lr: 0.00100
#&gt; Loss at epoch 29: training: 2728.856, validation: 4391.416, lr: 0.00100
#&gt; Loss at epoch 30: training: 2702.543, validation: 4367.263, lr: 0.00100
#&gt; Loss at epoch 31: training: 2680.425, validation: 4347.477, lr: 0.00100
#&gt; Loss at epoch 32: training: 2662.657, validation: 4332.176, lr: 0.00100</code></pre>
</div>
</div>
<p>Look at the constantly lower validation loss.</p>
<p><strong>Adding low regularization (</strong><span class="math inline">\(L1\)</span> <strong>and</strong> <span class="math inline">\(L2\)</span><strong>) and use a very low learning rate:</strong></p>
<div class="panelset">
<div class="panel">
<p><span class="panel-name">Keras</span></p>
<div class="sourceCode" id="cb316"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/set_random_seed.html">set_random_seed</a></span><span class="op">(</span><span class="fl">321L</span>, disable_gpu <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># Already sets R's random seed.</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">airquality</span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="fl">2</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="va">data</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">100L</span>, activation <span class="op">=</span> <span class="st">"relu"</span>, input_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fl">5L</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">100L</span>, kernel_regularizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l1_l2</a></span><span class="op">(</span><span class="fl">.5</span><span class="op">)</span>,</span>
<span>              bias_regularizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l1</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">100L</span>, kernel_regularizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l1_l2</a></span><span class="op">(</span><span class="fl">.5</span><span class="op">)</span>,</span>
<span>              bias_regularizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l1</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># One output dimension with a linear activation function.</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">1L</span>, activation <span class="op">=</span> <span class="st">"linear"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html">compile</a></span><span class="op">(</span>loss <span class="op">=</span> <span class="va">loss_mean_squared_error</span>, <span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_adamax.html">optimizer_adamax</a></span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">0.001</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_history</span> <span class="op">=</span></span>
<span>  <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">y</span>, ncol <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span>, epochs <span class="op">=</span> <span class="fl">150L</span>, batch_size <span class="op">=</span> <span class="fl">20L</span>,</span>
<span>        shuffle <span class="op">=</span> <span class="cn">TRUE</span>, validation_split <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model_history</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_19-1.png" width="100%" style="display: block; margin: auto;"></div>
</div>
<div class="panel">
<p><span class="panel-name">Torch</span></p>
<div class="sourceCode" id="cb317"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs">torch</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_manual_seed.html">torch_manual_seed</a></span><span class="op">(</span><span class="fl">321L</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">airquality</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">airquality</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Ozone</span>, ncol <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">model_torch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_sequential.html">nn_sequential</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html">nn_linear</a></span><span class="op">(</span>in_features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, out_features <span class="op">=</span> <span class="fl">100L</span>,  bias <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_relu.html">nn_relu</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html">nn_linear</a></span><span class="op">(</span>in_features <span class="op">=</span> <span class="fl">100L</span>, out_features <span class="op">=</span> <span class="fl">100L</span>,  bias <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_relu.html">nn_relu</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html">nn_linear</a></span><span class="op">(</span>in_features <span class="op">=</span> <span class="fl">100L</span>, out_features <span class="op">=</span> <span class="fl">1L</span>,  bias <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">opt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/optim_adam.html">optim_adam</a></span><span class="op">(</span>params <span class="op">=</span> <span class="va">model_torch</span><span class="op">$</span><span class="va">parameters</span>, lr <span class="op">=</span> <span class="fl">0.001</span><span class="op">)</span></span>
<span></span>
<span><span class="va">indices</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="fl">0.8</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">dataset</span> <span class="op">=</span> <span class="fu">torch_dataset</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="va">indices</span>, <span class="op">]</span>,<span class="va">y</span><span class="op">[</span><span class="va">indices</span>, ,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">dataset_val</span> <span class="op">=</span> <span class="fu">torch_dataset</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="op">-</span><span class="va">indices</span>, <span class="op">]</span>,<span class="va">y</span><span class="op">[</span><span class="op">-</span><span class="va">indices</span>, ,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">dataloader</span> <span class="op">=</span> <span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/dataloader.html">dataloader</a></span><span class="op">(</span><span class="va">dataset</span>, batch_size <span class="op">=</span> <span class="fl">30L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">dataloader_val</span> <span class="op">=</span> <span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/dataloader.html">dataloader</a></span><span class="op">(</span><span class="va">dataset</span>, batch_size <span class="op">=</span> <span class="fl">30L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">epochs</span> <span class="op">=</span> <span class="fl">50L</span></span>
<span><span class="va">train_losses</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">val_losses</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">lambda</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">epoch</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">epochs</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">train_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">val_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">coro</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coro/man/collect.html">loop</a></span><span class="op">(</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">batch</span> <span class="kw">in</span> <span class="va">dataloader</span><span class="op">)</span> <span class="op">{</span> </span>
<span>      <span class="va">opt</span><span class="op">$</span><span class="fu">zero_grad</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">pred</span> <span class="op">=</span> <span class="fu">model_torch</span><span class="op">(</span><span class="va">batch</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="va">loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nnf_mse_loss.html">nnf_mse_loss</a></span><span class="op">(</span><span class="va">pred</span>, <span class="va">batch</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="kw">for</span><span class="op">(</span><span class="va">p</span> <span class="kw">in</span> <span class="va">model_torch</span><span class="op">$</span><span class="va">parameters</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="va">loss</span> <span class="op">=</span> <span class="va">loss</span> <span class="op">+</span> <span class="va">lambda</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_norm.html">torch_norm</a></span><span class="op">(</span><span class="va">p</span>, p <span class="op">=</span> <span class="fl">2L</span><span class="op">)</span> <span class="op">+</span> <span class="va">lambda</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_norm.html">torch_norm</a></span><span class="op">(</span><span class="va">p</span>, p <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>      <span class="va">loss</span><span class="op">$</span><span class="fu">backward</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">opt</span><span class="op">$</span><span class="fu">step</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">train_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">train_loss</span>, <span class="va">loss</span><span class="op">$</span><span class="fu">item</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="co">## Calculate validation loss ##</span></span>
<span>  <span class="fu">coro</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coro/man/collect.html">loop</a></span><span class="op">(</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">batch</span> <span class="kw">in</span> <span class="va">dataloader_val</span><span class="op">)</span> <span class="op">{</span> </span>
<span>      <span class="va">pred</span> <span class="op">=</span> <span class="fu">model_torch</span><span class="op">(</span><span class="va">batch</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="va">loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nnf_mse_loss.html">nnf_mse_loss</a></span><span class="op">(</span><span class="va">pred</span>, <span class="va">batch</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="va">val_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">val_loss</span>, <span class="va">loss</span><span class="op">$</span><span class="fu">item</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="va">train_losses</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">train_losses</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">train_loss</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">val_losses</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">val_losses</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">val_loss</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="va">epoch</span><span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span><span class="fl">10</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"Loss at epoch %d: %3f  Val loss: %3f\n"</span>, <span class="va">epoch</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">train_loss</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">val_loss</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Loss at epoch 10: 3108.818441  Val loss: 2841.741455</span></span>
<span><span class="co">#&gt; Loss at epoch 20: 2590.243896  Val loss: 2306.140015</span></span>
<span><span class="co">#&gt; Loss at epoch 30: 1566.245809  Val loss: 1252.434570</span></span>
<span><span class="co">#&gt; Loss at epoch 40: 815.307373  Val loss: 510.054240</span></span>
<span><span class="co">#&gt; Loss at epoch 50: 672.642598  Val loss: 376.353760</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html">matplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">train_losses</span>, <span class="va">val_losses</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"o"</span>, pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">15</span>, <span class="fl">16</span><span class="op">)</span>,</span>
<span>        col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"darkblue"</span>, <span class="st">"darkred"</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fl">1</span>, xlab <span class="op">=</span> <span class="st">"Epoch"</span>,</span>
<span>        ylab <span class="op">=</span> <span class="st">"Loss"</span>, las <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span><span class="op">(</span><span class="st">"topright"</span>, bty <span class="op">=</span> <span class="st">"n"</span>, </span>
<span>       legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Train loss"</span>, <span class="st">"Val loss"</span><span class="op">)</span>, </span>
<span>       pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">15</span>, <span class="fl">16</span><span class="op">)</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"darkblue"</span>, <span class="st">"darkred"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_145_torch-1.png" width="100%" style="display: block; margin: auto;"></div>
</div>
<div class="panel">
<p><span class="panel-name">Cito</span></p>
<div class="sourceCode" id="cb318"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># devtools::install_github("citoverse/cito")</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">cito</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">airquality</span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="va">data</span><span class="op">[</span>,<span class="fl">2</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="fl">2</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/cito/man/dnn.html">dnn</a></span><span class="op">(</span><span class="va">Ozone</span><span class="op">~</span><span class="va">.</span>, </span>
<span>            data <span class="op">=</span> <span class="va">data</span>, </span>
<span>            loss <span class="op">=</span> <span class="st">"mse"</span>, </span>
<span>            hidden <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">100L</span>, <span class="fl">3L</span><span class="op">)</span>, </span>
<span>            activation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"relu"</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>            validation <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>            lambda <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>            lr <span class="op">=</span> <span class="fl">0.001</span>,</span>
<span>            alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="co">#&gt; Loss at epoch 1: training: 2785.256, validation: 4461.933, lr: 0.00100</span></span></code></pre></div>
<div class="inline-figure"><img src="05-fundamental_files/figure-html/chunk_chapter4_task_19_cito-1.png" width="100%" style="display: block; margin: auto;"></div>
<pre><code>#&gt; Loss at epoch 2: training: 2764.665, validation: 4439.806, lr: 0.00100
#&gt; Loss at epoch 3: training: 2744.952, validation: 4417.255, lr: 0.00100
#&gt; Loss at epoch 4: training: 2724.453, validation: 4392.339, lr: 0.00100
#&gt; Loss at epoch 5: training: 2701.842, validation: 4363.474, lr: 0.00100
#&gt; Loss at epoch 6: training: 2675.523, validation: 4328.545, lr: 0.00100
#&gt; Loss at epoch 7: training: 2643.902, validation: 4284.910, lr: 0.00100
#&gt; Loss at epoch 8: training: 2604.654, validation: 4229.163, lr: 0.00100
#&gt; Loss at epoch 9: training: 2555.259, validation: 4157.910, lr: 0.00100
#&gt; Loss at epoch 10: training: 2492.967, validation: 4067.148, lr: 0.00100
#&gt; Loss at epoch 11: training: 2414.684, validation: 3952.364, lr: 0.00100
#&gt; Loss at epoch 12: training: 2317.212, validation: 3809.021, lr: 0.00100
#&gt; Loss at epoch 13: training: 2197.632, validation: 3632.981, lr: 0.00100
#&gt; Loss at epoch 14: training: 2053.995, validation: 3420.942, lr: 0.00100
#&gt; Loss at epoch 15: training: 1885.708, validation: 3171.264, lr: 0.00100
#&gt; Loss at epoch 16: training: 1694.612, validation: 2885.631, lr: 0.00100
#&gt; Loss at epoch 17: training: 1486.422, validation: 2569.979, lr: 0.00100
#&gt; Loss at epoch 18: training: 1271.472, validation: 2236.279, lr: 0.00100
#&gt; Loss at epoch 19: training: 1065.475, validation: 1903.281, lr: 0.00100
#&gt; Loss at epoch 20: training: 887.979, validation: 1595.156, lr: 0.00100
#&gt; Loss at epoch 21: training: 756.957, validation: 1336.443, lr: 0.00100
#&gt; Loss at epoch 22: training: 679.964, validation: 1143.067, lr: 0.00100
#&gt; Loss at epoch 23: training: 646.783, validation: 1014.218, lr: 0.00100
#&gt; Loss at epoch 24: training: 632.946, validation: 934.839, lr: 0.00100
#&gt; Loss at epoch 25: training: 615.736, validation: 887.774, lr: 0.00100
#&gt; Loss at epoch 26: training: 587.875, validation: 862.232, lr: 0.00100
#&gt; Loss at epoch 27: training: 555.525, validation: 852.343, lr: 0.00100
#&gt; Loss at epoch 28: training: 527.259, validation: 852.554, lr: 0.00100
#&gt; Loss at epoch 29: training: 507.079, validation: 856.364, lr: 0.00100
#&gt; Loss at epoch 30: training: 494.097, validation: 857.859, lr: 0.00100
#&gt; Loss at epoch 31: training: 485.339, validation: 853.622, lr: 0.00100
#&gt; Loss at epoch 32: training: 478.174, validation: 843.091, lr: 0.00100</code></pre>
</div>
</div>
<p>Play around with regularization kind (<span class="math inline">\(L1\)</span>, <span class="math inline">\(L2\)</span>, <span class="math inline">\(L1,L2\)</span>) strength and the learning rate also on your own!</p>
    
  </details><br><hr>
</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="tensorflowintro.html"><span class="header-section-number">3</span> Introduction to TensorFlow, Keras, and Torch</a></div>
<div class="next"><a href="workflow.html"><span class="header-section-number">5</span> Machine Learning workflow</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#fundamental"><span class="header-section-number">4</span> Common Machine Learning algorithms</a></li>
<li>
<a class="nav-link" href="#machine-learning-principles"><span class="header-section-number">4.1</span> Machine Learning Principles</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#optimization"><span class="header-section-number">4.1.1</span> Optimization</a></li>
<li><a class="nav-link" href="#questions-2"><span class="header-section-number">4.1.2</span> Questions</a></li>
<li><a class="nav-link" href="#advanced-optimization-example"><span class="header-section-number">4.1.3</span> Advanced Optimization Example</a></li>
<li><a class="nav-link" href="#regularization"><span class="header-section-number">4.1.4</span> Regularization</a></li>
<li><a class="nav-link" href="#exerexer"><span class="header-section-number">4.1.5</span> Exercise</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#tree-based-machine-learning-algorithms"><span class="header-section-number">4.2</span> Tree-based Machine Learning Algorithms</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#classification-and-regression-trees"><span class="header-section-number">4.2.1</span> Classification and Regression Trees</a></li>
<li><a class="nav-link" href="#random-forest"><span class="header-section-number">4.2.2</span> Random Forest</a></li>
<li><a class="nav-link" href="#boosted-regression-trees"><span class="header-section-number">4.2.3</span> Boosted Regression Trees</a></li>
<li><a class="nav-link" href="#exercises-3"><span class="header-section-number">4.2.4</span> Exercises</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#distance-based-algorithms"><span class="header-section-number">4.3</span> Distance-based Algorithms</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#k-nearest-neighbor"><span class="header-section-number">4.3.1</span> K-Nearest-Neighbor</a></li>
<li><a class="nav-link" href="#support-vector-machines-svms"><span class="header-section-number">4.3.2</span> Support Vector Machines (SVMs)</a></li>
<li><a class="nav-link" href="#exercises-4"><span class="header-section-number">4.3.3</span> Exercises</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#artificial-neural-networks"><span class="header-section-number">4.4</span> Artificial Neural Networks</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#exercise-1"><span class="header-section-number">4.4.1</span> Exercise</a></li></ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/TheoreticalEcology/machinelearning/blob/master/book/05-fundamental.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/TheoreticalEcology/machinelearning/edit/master/book/05-fundamental.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Machine Learning and AI in TensorFlow and R</strong>" was written by Maximilian Pichler and Florian Hartig. It was last built on 2022-07-14.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
