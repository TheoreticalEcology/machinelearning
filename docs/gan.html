<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 8 Generative Modeling and Reinforcement Learning | Machine Learning and AI in TensorFlow and R</title>
<meta name="author" content="Maximilian Pichler and Florian Hartig">
<meta name="description" content="We will explore more machine learning ideas today.  8.1 Autoencoder An autoencoder (AE) is a type of artificial neural network for unsupervised learning. The idea is similar to data compression:...">
<meta name="generator" content="bookdown 0.27 with bs4_book()">
<meta property="og:title" content="Chapter 8 Generative Modeling and Reinforcement Learning | Machine Learning and AI in TensorFlow and R">
<meta property="og:type" content="book">
<meta property="og:description" content="We will explore more machine learning ideas today.  8.1 Autoencoder An autoencoder (AE) is a type of artificial neural network for unsupervised learning. The idea is similar to data compression:...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 8 Generative Modeling and Reinforcement Learning | Machine Learning and AI in TensorFlow and R">
<meta name="twitter:description" content="We will explore more machine learning ideas today.  8.1 Autoencoder An autoencoder (AE) is a type of artificial neural network for unsupervised learning. The idea is similar to data compression:...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><link href="libs/panelset-0.2.6/panelset.css" rel="stylesheet">
<script src="libs/panelset-0.2.6/panelset.js"></script><script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script><script src="libs/viz-1.8.2/viz.js"></script><link href="libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">
<script src="libs/grViz-binding-1.0.9/grViz.js"></script><style>
    #content {
        font-size: 0.95rem;
    }


    </style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
<link rel="stylesheet" href="panel.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Machine Learning and AI in TensorFlow and R</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"><span class="header-section-number">1</span> Prerequisites</a></li>
<li><a class="" href="introduction.html"><span class="header-section-number">2</span> Introduction to Machine Learning</a></li>
<li><a class="" href="tensorflowintro.html"><span class="header-section-number">3</span> Introduction to TensorFlow, Keras, and Torch</a></li>
<li><a class="" href="fundamental.html"><span class="header-section-number">4</span> Common Machine Learning algorithms</a></li>
<li><a class="" href="workflow.html"><span class="header-section-number">5</span> Machine Learning workflow</a></li>
<li><a class="" href="deep.html"><span class="header-section-number">6</span> Deep Learning</a></li>
<li><a class="" href="interpretation.html"><span class="header-section-number">7</span> Interpretation and Causality With Machine Learning</a></li>
<li><a class="active" href="gan.html"><span class="header-section-number">8</span> Generative Modeling and Reinforcement Learning</a></li>
<li><a class="" href="datasets.html"><span class="header-section-number">9</span> Data sets</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/TheoreticalEcology/machinelearning">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="gan" class="section level1" number="8">
<h1>
<span class="header-section-number">8</span> Generative Modeling and Reinforcement Learning<a class="anchor" aria-label="anchor" href="#gan"><i class="fas fa-link"></i></a>
</h1>
<!-- Put this here (right after the first markdown headline) and only here for each document! -->
<script src="./scripts/multipleChoice.js"></script><p>We will explore more machine learning ideas today.</p>
<div id="autoencoder" class="section level2" number="8.1">
<h2>
<span class="header-section-number">8.1</span> Autoencoder<a class="anchor" aria-label="anchor" href="#autoencoder"><i class="fas fa-link"></i></a>
</h2>
<p>An autoencoder (AE) is a type of artificial neural network for unsupervised learning. The idea is similar to data compression: The first part of the network compresses (encodes) the data to a low dimensional space (e.g. 2-4 dimensions) and the second part of the network decompresses (reverses the encoding) and learns to reconstruct the data (think of a hourglass).</p>
<p>Why is this useful? The method is similar to a dimension reduction technique (e.g. PCA) but with the advantage that we don’t have to make any distributional assumptions (but see PCA). For instance, we could first train an autoencoder on genomic expression data with thousands of features, compress them into 2-4 dimensions, and then use them for clustering.</p>
<div id="autoencoder---deep-neural-network-mnist" class="section level3" number="8.1.1">
<h3>
<span class="header-section-number">8.1.1</span> Autoencoder - Deep Neural Network MNIST<a class="anchor" aria-label="anchor" href="#autoencoder---deep-neural-network-mnist"><i class="fas fa-link"></i></a>
</h3>
<p>We now will write an autoencoder for the MNIST data set.</p>
<p>Let’s start with the (usual) MNIST example:</p>
<div class="sourceCode" id="cb405"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/set_random_seed.html">set_random_seed</a></span><span class="op">(</span><span class="fl">321L</span>, disable_gpu <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># Already sets R's random seed.</span></span>
<span><span class="co">#&gt; Loaded Tensorflow version 2.9.1</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/dataset_mnist.html">dataset_mnist</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>We don’t need the labels here, our images will be the inputs and at the same time the outputs of our final autoencoder.</p>
<div class="sourceCode" id="cb406"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rotate</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">2</span>, <span class="va">rev</span><span class="op">)</span><span class="op">)</span> <span class="op">}</span></span>
<span></span>
<span><span class="va">imgPlot</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">img</span>, <span class="va">title</span> <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">col</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/gray.colors.html">grey.colors</a></span><span class="op">(</span><span class="fl">255</span><span class="op">)</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">title</span> <span class="op">!=</span> <span class="st">""</span><span class="op">)</span><span class="op">{</span> <span class="va">main</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Label: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">title</span><span class="op">)</span><span class="op">)</span> <span class="op">}</span></span>
<span>  <span class="kw">else</span><span class="op">{</span> <span class="va">main</span> <span class="op">=</span> <span class="st">""</span> <span class="op">}</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/image.html">image</a></span><span class="op">(</span><span class="fu"><a href="http://talgalili.github.io/dendextend/reference/rotate.html">rotate</a></span><span class="op">(</span><span class="va">img</span><span class="op">)</span>, col <span class="op">=</span> <span class="va">col</span>, xlab <span class="op">=</span> <span class="st">""</span>, ylab <span class="op">=</span> <span class="st">""</span>, axes <span class="op">=</span> <span class="cn">FALSE</span>, main <span class="op">=</span> <span class="va">main</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">train</span> <span class="op">=</span> <span class="va">data</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">test</span> <span class="op">=</span> <span class="va">data</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">train_x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span><span class="op">(</span><span class="va">train</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">/</span><span class="fl">255</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">train</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="fl">784L</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">test_x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span><span class="op">(</span><span class="va">test</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">/</span><span class="fl">255</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">test</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="fl">784L</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Our encoder: image (784 dimensions) <span class="math inline">\(\rightarrow\)</span> 2 dimensions</p>
<div class="sourceCode" id="cb407"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">down_size_model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">down_size_model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">100L</span>, input_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">784L</span><span class="op">)</span>, activation <span class="op">=</span> <span class="st">"relu"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">20L</span>, activation <span class="op">=</span> <span class="st">"relu"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">2L</span>, activation <span class="op">=</span> <span class="st">"linear"</span><span class="op">)</span></span></code></pre></div>
<p>Our decoder: 2 dimensions <span class="math inline">\(\rightarrow\)</span> 784 dimensions (our image)</p>
<div class="sourceCode" id="cb408"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">up_size_model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">up_size_model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">20L</span>, input_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2L</span><span class="op">)</span>, activation <span class="op">=</span> <span class="st">"relu"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">100L</span>, activation <span class="op">=</span> <span class="st">"relu"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">784L</span>, activation <span class="op">=</span> <span class="st">"sigmoid"</span><span class="op">)</span></span></code></pre></div>
<p>We can use the non-sequential model type to connect the two models. (We did the same in the transfer learning chapter.)</p>
<div class="sourceCode" id="cb409"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">autoencoder</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model.html">keras_model</a></span><span class="op">(</span>inputs <span class="op">=</span> <span class="va">down_size_model</span><span class="op">$</span><span class="va">input</span>, </span>
<span>                          outputs <span class="op">=</span> <span class="fu">up_size_model</span><span class="op">(</span><span class="va">down_size_model</span><span class="op">$</span><span class="va">output</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">autoencoder</span><span class="op">$</span><span class="fu">compile</span><span class="op">(</span>loss <span class="op">=</span> <span class="va">loss_binary_crossentropy</span>,</span>
<span>                    optimizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_adamax.html">optimizer_adamax</a></span><span class="op">(</span><span class="fl">0.01</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">autoencoder</span><span class="op">)</span></span>
<span><span class="co">#&gt; Model: "model"</span></span>
<span><span class="co">#&gt; __________________________________________________________________________________________</span></span>
<span><span class="co">#&gt;  Layer (type)                           Output Shape                        Param #       </span></span>
<span><span class="co">#&gt; ==========================================================================================</span></span>
<span><span class="co">#&gt;  dense_2_input (InputLayer)             [(None, 784)]                       0             </span></span>
<span><span class="co">#&gt;  dense_2 (Dense)                        (None, 100)                         78500         </span></span>
<span><span class="co">#&gt;  dense_1 (Dense)                        (None, 20)                          2020          </span></span>
<span><span class="co">#&gt;  dense (Dense)                          (None, 2)                           42            </span></span>
<span><span class="co">#&gt;  sequential_1 (Sequential)              (None, 784)                         81344         </span></span>
<span><span class="co">#&gt; ==========================================================================================</span></span>
<span><span class="co">#&gt; Total params: 161,906</span></span>
<span><span class="co">#&gt; Trainable params: 161,906</span></span>
<span><span class="co">#&gt; Non-trainable params: 0</span></span>
<span><span class="co">#&gt; __________________________________________________________________________________________</span></span></code></pre></div>
<p>We will now show an example of an image before and after the unfitted autoencoder, so we see that we have to train the autoencoder.</p>
<div class="sourceCode" id="cb410"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">image</span> <span class="op">=</span> <span class="fu">autoencoder</span><span class="op">(</span><span class="va">train_x</span><span class="op">[</span><span class="fl">1</span>,,drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">oldpar</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">imgPlot</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span><span class="op">(</span><span class="va">train_x</span><span class="op">[</span><span class="fl">1</span>,,drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">28</span>, <span class="fl">28</span><span class="op">)</span><span class="op">)</span>, title <span class="op">=</span> <span class="st">"Before"</span><span class="op">)</span></span>
<span><span class="fu">imgPlot</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span><span class="op">(</span><span class="va">image</span><span class="op">$</span><span class="fu">numpy</span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">28</span>, <span class="fl">28</span><span class="op">)</span><span class="op">)</span>, title <span class="op">=</span> <span class="st">"After"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="09-GAN_files/figure-html/chunk_chapter7_6__AEmnistoutput-1.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb411"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span><span class="va">oldpar</span><span class="op">)</span></span></code></pre></div>
<p>Fit the autoencoder (inputs == outputs!):</p>
<div class="sourceCode" id="cb412"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/set_random_seed.html">set_random_seed</a></span><span class="op">(</span><span class="fl">123L</span>, disable_gpu <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># Already sets R's random seed.</span></span>
<span></span>
<span><span class="va">autoencoder</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">train_x</span>, y <span class="op">=</span> <span class="va">train_x</span>, epochs <span class="op">=</span> <span class="fl">5L</span>, batch_size <span class="op">=</span> <span class="fl">128L</span><span class="op">)</span></span></code></pre></div>
<p>Visualization of the latent variables:</p>
<div class="sourceCode" id="cb413"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred_dim</span> <span class="op">=</span> <span class="fu">down_size_model</span><span class="op">(</span><span class="va">test_x</span><span class="op">)</span></span>
<span><span class="va">reconstr_pred</span> <span class="op">=</span> <span class="fu">up_size_model</span><span class="op">(</span><span class="va">pred_dim</span><span class="op">)</span></span>
<span><span class="fu">imgPlot</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span><span class="op">(</span><span class="va">reconstr_pred</span><span class="op">[</span><span class="fl">10</span>,<span class="op">]</span><span class="op">$</span><span class="fu">numpy</span><span class="op">(</span><span class="op">)</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">28L</span>, <span class="fl">28L</span><span class="op">)</span><span class="op">)</span>, title <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="09-GAN_files/figure-html/chunk_chapter7_8__AEvisualization-1.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb414"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ownColors</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"limegreen"</span>, <span class="st">"purple"</span>, <span class="st">"yellow"</span>, <span class="st">"grey"</span>, <span class="st">"orange"</span>,</span>
<span>              <span class="st">"black"</span>, <span class="st">"red"</span>, <span class="st">"navy"</span>, <span class="st">"sienna"</span>, <span class="st">"springgreen"</span><span class="op">)</span></span>
<span><span class="va">oldpar</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">pred_dim</span><span class="op">$</span><span class="fu">numpy</span><span class="op">(</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, <span class="va">pred_dim</span><span class="op">$</span><span class="fu">numpy</span><span class="op">(</span><span class="op">)</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, col <span class="op">=</span> <span class="va">ownColors</span><span class="op">[</span><span class="va">test</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">+</span><span class="fl">1L</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="09-GAN_files/figure-html/chunk_chapter7_9__AEvisualizationContinuation-1.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb415"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span><span class="va">oldpar</span><span class="op">)</span></span></code></pre></div>
<p>The picture above shows the 2-dimensional encoded values of the numbers in the MNIST data set and the number they are depicting via the respective color.</p>
</div>
<div id="autoencoder---mnist-convolutional-neural-networks" class="section level3" number="8.1.2">
<h3>
<span class="header-section-number">8.1.2</span> Autoencoder - MNIST Convolutional Neural Networks<a class="anchor" aria-label="anchor" href="#autoencoder---mnist-convolutional-neural-networks"><i class="fas fa-link"></i></a>
</h3>
<p>We can also use convolutional neural networks instead or on the side of deep neural networks. Moreover, there is an inverse convolutional layer (layer_conv_2d_transpose; “deconvolution”):</p>
<p>Prepare data:</p>
<div class="sourceCode" id="cb416"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">keras</span><span class="op">$</span><span class="va">datasets</span><span class="op">$</span><span class="va">mnist</span><span class="op">$</span><span class="fu">load_data</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">train</span> <span class="op">=</span> <span class="va">data</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">train_x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span><span class="op">(</span><span class="va">train</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">/</span><span class="fl">255</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">train</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, <span class="fl">1L</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">test_x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span><span class="op">(</span><span class="va">data</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">/</span><span class="fl">255</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">data</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">/</span><span class="fl">255</span><span class="op">)</span>, <span class="fl">1L</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Then define the downsize model:</p>
<div class="sourceCode" id="cb417"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">down_size_model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">down_size_model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_conv_2d.html">layer_conv_2d</a></span><span class="op">(</span>filters <span class="op">=</span> <span class="fl">32L</span>, activation <span class="op">=</span> <span class="st">"relu"</span>, kernel_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2L</span>, <span class="fl">2L</span><span class="op">)</span>, </span>
<span>                          input_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">28L</span>, <span class="fl">28L</span>, <span class="fl">1L</span><span class="op">)</span>,</span>
<span>               strides <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4L</span>, <span class="fl">4L</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_conv_2d.html">layer_conv_2d</a></span><span class="op">(</span>filters <span class="op">=</span> <span class="fl">16L</span>, activation <span class="op">=</span> <span class="st">"relu"</span>, </span>
<span>                           kernel_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">7L</span>, <span class="fl">7L</span><span class="op">)</span>, strides <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1L</span>, <span class="fl">1L</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_flatten.html">layer_flatten</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">2L</span>, activation <span class="op">=</span> <span class="st">"linear"</span><span class="op">)</span></span></code></pre></div>
<p>Define the upsize model:</p>
<div class="sourceCode" id="cb418"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">up_size_model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">up_size_model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">8L</span>, activation <span class="op">=</span> <span class="st">"relu"</span>, input_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2L</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_reshape.html">layer_reshape</a></span><span class="op">(</span>target_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1L</span>, <span class="fl">1L</span>, <span class="fl">8L</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_conv_2d_transpose.html">layer_conv_2d_transpose</a></span><span class="op">(</span>filters <span class="op">=</span> <span class="fl">16L</span>, kernel_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">7</span>, <span class="fl">7</span><span class="op">)</span>,</span>
<span>                         activation <span class="op">=</span> <span class="st">"relu"</span>, strides <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1L</span>, <span class="fl">1L</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_conv_2d_transpose.html">layer_conv_2d_transpose</a></span><span class="op">(</span>filters <span class="op">=</span> <span class="fl">32L</span>, activation <span class="op">=</span> <span class="st">"relu"</span>,</span>
<span>                         kernel_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>, strides <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4L</span>, <span class="fl">4L</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_conv_2d.html">layer_conv_2d</a></span><span class="op">(</span>filters <span class="op">=</span> <span class="fl">1</span>, kernel_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1L</span>, <span class="fl">1L</span><span class="op">)</span>,</span>
<span>               strides <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1L</span>, <span class="fl">1L</span><span class="op">)</span>, activation <span class="op">=</span> <span class="st">"sigmoid"</span><span class="op">)</span></span></code></pre></div>
<p>Combine the two models and fit it:</p>
<div class="sourceCode" id="cb419"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/set_random_seed.html">set_random_seed</a></span><span class="op">(</span><span class="fl">321L</span>, disable_gpu <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># Already sets R's random seed.</span></span>
<span></span>
<span><span class="va">autoencoder</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">keras</span><span class="op">$</span><span class="va">models</span><span class="op">$</span><span class="fu">Model</span><span class="op">(</span>inputs <span class="op">=</span> <span class="va">down_size_model</span><span class="op">$</span><span class="va">input</span>,</span>
<span>                                    outputs <span class="op">=</span> <span class="fu">up_size_model</span><span class="op">(</span><span class="va">down_size_model</span><span class="op">$</span><span class="va">output</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">autoencoder</span><span class="op">$</span><span class="fu">compile</span><span class="op">(</span>loss <span class="op">=</span> <span class="va">loss_binary_crossentropy</span>,</span>
<span>                    optimizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_rmsprop.html">optimizer_rmsprop</a></span><span class="op">(</span><span class="fl">0.001</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">autoencoder</span><span class="op">$</span><span class="fu">fit</span><span class="op">(</span>x <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="fu">constant</span><span class="op">(</span><span class="va">train_x</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="fu">constant</span><span class="op">(</span><span class="va">train_x</span><span class="op">)</span>,</span>
<span>                epochs <span class="op">=</span> <span class="fl">10L</span>, batch_size <span class="op">=</span> <span class="fl">128L</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;keras.callbacks.History object at 0x7fdecc353750&gt;</span></span></code></pre></div>
<p>Test it:</p>
<div class="sourceCode" id="cb420"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred_dim</span> <span class="op">=</span> <span class="fu">down_size_model</span><span class="op">(</span><span class="va">tf</span><span class="op">$</span><span class="fu">constant</span><span class="op">(</span><span class="va">test_x</span>, <span class="st">"float32"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">reconstr_pred</span> <span class="op">=</span> <span class="fu">autoencoder</span><span class="op">(</span><span class="va">tf</span><span class="op">$</span><span class="fu">constant</span><span class="op">(</span><span class="va">test_x</span>, <span class="st">"float32"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">imgPlot</span><span class="op">(</span><span class="va">reconstr_pred</span><span class="op">[</span><span class="fl">10</span>,,,<span class="op">]</span><span class="op">$</span><span class="fu">numpy</span><span class="op">(</span><span class="op">)</span><span class="op">[</span>,,<span class="fl">1</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="09-GAN_files/figure-html/chunk_chapter7_14-1.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb421"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">ownColors</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"limegreen"</span>, <span class="st">"purple"</span>, <span class="st">"yellow"</span>, <span class="st">"grey"</span>, <span class="st">"orange"</span>,</span>
<span>              <span class="st">"black"</span>, <span class="st">"red"</span>, <span class="st">"navy"</span>, <span class="st">"sienna"</span>, <span class="st">"springgreen"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">pred_dim</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">$</span><span class="fu">numpy</span><span class="op">(</span><span class="op">)</span>, <span class="va">pred_dim</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">$</span><span class="fu">numpy</span><span class="op">(</span><span class="op">)</span>, col <span class="op">=</span> <span class="va">ownColors</span><span class="op">[</span><span class="va">test</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">+</span><span class="fl">1L</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="09-GAN_files/figure-html/chunk_chapter7_14-2.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb422"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">## Generate new images!</span></span>
<span><span class="va">new</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu">imgPlot</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span><span class="op">(</span><span class="fu">up_size_model</span><span class="op">(</span><span class="va">new</span><span class="op">)</span><span class="op">$</span><span class="fu">numpy</span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">28L</span>, <span class="fl">28L</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="09-GAN_files/figure-html/chunk_chapter7_14-3.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb423"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">new</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">5</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu">imgPlot</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span><span class="op">(</span><span class="fu">up_size_model</span><span class="op">(</span><span class="va">new</span><span class="op">)</span><span class="op">$</span><span class="fu">numpy</span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">28L</span>, <span class="fl">28L</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="09-GAN_files/figure-html/chunk_chapter7_14-4.png" width="100%" style="display: block; margin: auto;"></div>
</div>
<div id="VAE" class="section level3" number="8.1.3">
<h3>
<span class="header-section-number">8.1.3</span> Variational Autoencoder (VAE)<a class="anchor" aria-label="anchor" href="#VAE"><i class="fas fa-link"></i></a>
</h3>
<p>The difference between a variational and a normal autoencoder is that a variational autoencoder assumes a distribution for the latent variables (latent variables cannot be observed and are composed of other variables) and the parameters of this distribution are learned. Thus new objects can be generated by inserting valid (!) (with regard to the assumed distribution) “seeds” to the decoder.
To achieve the property that more or less randomly chosen points in the low dimensional latent space are meaningful and yield suitable results after decoding, the latent space/training process must be regularized.
In this process, the input to the VAE is encoded to a distribution in the latent space rather than a single point.</p>
<p>For building variational autoencoders, we will use TensorFlow probability, but first, we need to split the data again.</p>
<div class="sourceCode" id="cb424"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tfprobability">tfprobability</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">keras</span><span class="op">$</span><span class="va">datasets</span><span class="op">$</span><span class="va">mnist</span><span class="op">$</span><span class="fu">load_data</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Loaded Tensorflow version 2.9.1</span></span>
<span><span class="va">train</span> <span class="op">=</span> <span class="va">data</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">train_x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span><span class="op">(</span><span class="va">train</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">/</span><span class="fl">255</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">train</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, <span class="fl">1L</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We will use TensorFlow probability to define priors for our latent variables.</p>
<div class="sourceCode" id="cb425"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tfprobability">tfprobability</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/set_random_seed.html">set_random_seed</a></span><span class="op">(</span><span class="fl">321L</span>, disable_gpu <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># Already sets R's random seed.</span></span>
<span></span>
<span><span class="va">tfp</span> <span class="op">=</span> <span class="fu">reticulate</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/reticulate/reference/import.html">import</a></span><span class="op">(</span><span class="st">"tensorflow_probability"</span><span class="op">)</span></span></code></pre></div>
<p>Build the two networks:</p>
<div class="sourceCode" id="cb426"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">encoded</span> <span class="op">=</span> <span class="fl">2L</span></span>
<span><span class="va">prior</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/tfprobability/man/tfd_independent.html">tfd_independent</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/tfprobability/man/tfd_normal.html">tfd_normal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.0</span>, <span class="fl">0.0</span><span class="op">)</span>, <span class="fl">1.0</span><span class="op">)</span>, <span class="fl">1L</span><span class="op">)</span></span>
<span></span>
<span><span class="va">down_size_model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">down_size_model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_conv_2d.html">layer_conv_2d</a></span><span class="op">(</span>filters <span class="op">=</span> <span class="fl">32L</span>, activation <span class="op">=</span> <span class="st">"relu"</span>, kernel_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2L</span>, <span class="fl">2L</span><span class="op">)</span>,</span>
<span>               input_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">28L</span>, <span class="fl">28L</span>, <span class="fl">1L</span><span class="op">)</span>, strides <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4L</span>, <span class="fl">4L</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_conv_2d.html">layer_conv_2d</a></span><span class="op">(</span>filters <span class="op">=</span> <span class="fl">16L</span>, activation <span class="op">=</span> <span class="st">"relu"</span>,</span>
<span>               kernel_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">7L</span>, <span class="fl">7L</span><span class="op">)</span>, strides <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1L</span>, <span class="fl">1L</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_flatten.html">layer_flatten</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">4L</span>, activation <span class="op">=</span> <span class="st">"linear"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tfprobability/man/layer_independent_normal.html">layer_independent_normal</a></span><span class="op">(</span><span class="fl">2L</span>,</span>
<span>                           activity_regularizer <span class="op">=</span></span>
<span>                             <span class="va">tfp</span><span class="op">$</span><span class="va">layers</span><span class="op">$</span><span class="fu">KLDivergenceRegularizer</span><span class="op">(</span>distribution_b <span class="op">=</span> <span class="va">prior</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">up_size_model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">up_size_model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">8L</span>, activation <span class="op">=</span> <span class="st">"relu"</span>, input_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2L</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_reshape.html">layer_reshape</a></span><span class="op">(</span>target_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1L</span>, <span class="fl">1L</span>, <span class="fl">8L</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_conv_2d_transpose.html">layer_conv_2d_transpose</a></span><span class="op">(</span>filters <span class="op">=</span> <span class="fl">16L</span>, kernel_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">7</span>, <span class="fl">7</span><span class="op">)</span>,</span>
<span>                         activation <span class="op">=</span> <span class="st">"relu"</span>, strides <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1L</span>, <span class="fl">1L</span><span class="op">)</span>,</span>
<span>                         use_bias <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_conv_2d_transpose.html">layer_conv_2d_transpose</a></span><span class="op">(</span>filters <span class="op">=</span> <span class="fl">32L</span>, activation <span class="op">=</span> <span class="st">"relu"</span>,</span>
<span>                         kernel_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2L</span>, <span class="fl">2L</span><span class="op">)</span>, strides <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4L</span>, <span class="fl">4L</span><span class="op">)</span>,</span>
<span>                         use_bias <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_conv_2d.html">layer_conv_2d</a></span><span class="op">(</span>filters <span class="op">=</span> <span class="fl">1</span>, kernel_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1L</span>, <span class="fl">1L</span><span class="op">)</span>,</span>
<span>               strides <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1L</span>, <span class="fl">1L</span><span class="op">)</span>, activation <span class="op">=</span> <span class="st">"sigmoid"</span>,</span>
<span>               use_bias <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">VAE</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model.html">keras_model</a></span><span class="op">(</span>inputs <span class="op">=</span> <span class="va">down_size_model</span><span class="op">$</span><span class="va">inputs</span>,</span>
<span>                  outputs <span class="op">=</span> <span class="fu">up_size_model</span><span class="op">(</span><span class="va">down_size_model</span><span class="op">$</span><span class="va">outputs</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Compile and fit model:</p>
<div class="sourceCode" id="cb427"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/set_random_seed.html">set_random_seed</a></span><span class="op">(</span><span class="fl">321L</span>, disable_gpu <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># Already sets R's random seed.</span></span>
<span></span>
<span><span class="va">loss_binary</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">true</span>, <span class="va">pred</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/loss-functions.html">loss_binary_crossentropy</a></span><span class="op">(</span><span class="va">true</span>, <span class="va">pred</span><span class="op">)</span> <span class="op">*</span> <span class="fl">28.0</span> <span class="op">*</span> <span class="fl">28.0</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">VAE</span><span class="op">$</span><span class="fu">compile</span><span class="op">(</span>loss <span class="op">=</span> <span class="va">loss_binary</span>, optimizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_adamax.html">optimizer_adamax</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">VAE</span><span class="op">$</span><span class="fu">fit</span><span class="op">(</span><span class="va">train_x</span>, <span class="va">train_x</span>, epochs <span class="op">=</span> <span class="fl">5L</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;keras.callbacks.History object at 0x7fe5e0554790&gt;</span></span></code></pre></div>
<p>And show that it works:</p>
<div class="sourceCode" id="cb428"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dist</span> <span class="op">=</span> <span class="fu">down_size_model</span><span class="op">(</span><span class="va">train_x</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2000</span>,,,,drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">images</span> <span class="op">=</span> <span class="fu">up_size_model</span><span class="op">(</span><span class="va">dist</span><span class="op">$</span><span class="fu">sample</span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ownColors</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"limegreen"</span>, <span class="st">"purple"</span>, <span class="st">"yellow"</span>, <span class="st">"grey"</span>, <span class="st">"orange"</span>,</span>
<span>              <span class="st">"black"</span>, <span class="st">"red"</span>, <span class="st">"navy"</span>, <span class="st">"sienna"</span>, <span class="st">"springgreen"</span><span class="op">)</span></span>
<span><span class="va">oldpar</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">imgPlot</span><span class="op">(</span><span class="va">images</span><span class="op">[</span><span class="fl">1</span>,,,<span class="fl">1</span><span class="op">]</span><span class="op">$</span><span class="fu">numpy</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="09-GAN_files/figure-html/chunk_chapter7_19__VAEmnist-1.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb429"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">dist</span><span class="op">$</span><span class="fu">mean</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">numpy</span><span class="op">(</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, <span class="va">dist</span><span class="op">$</span><span class="fu">mean</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">numpy</span><span class="op">(</span><span class="op">)</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, col <span class="op">=</span> <span class="va">ownColors</span><span class="op">[</span><span class="va">train</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">+</span><span class="fl">1L</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="09-GAN_files/figure-html/chunk_chapter7_19__VAEmnist-2.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb430"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span><span class="va">oldpar</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div id="GANS" class="section level2" number="8.2">
<h2>
<span class="header-section-number">8.2</span> Generative Adversarial Networks (GANs)<a class="anchor" aria-label="anchor" href="#GANS"><i class="fas fa-link"></i></a>
</h2>
<p>The idea of a generative adversarial network (GAN) is that two neural networks contest against each other in a “game.” One network is creating data and is trying to “trick” the other network into deciding the generated data is real. The <em>generator</em> (similar to the decoder in autoencoders) creates new images from noise. The <em>discriminator</em> is getting a mix of true (from the data set) and artificially generated images from the generator. Thereby, the loss of the generator rises when fakes are identified as fakes by the discriminator (simple binary cross entropy loss, 0/1…). The loss of the discriminator rises when fakes are identified as real images (class 0) or real images as fakes (class 1), again with binary cross entropy.</p>
<p><strong>Binary cross entropy:</strong>
Entropy or <em>Shannon entropy</em> (named after Claude Shannon) <span class="math inline">\(\mathbf{H}\)</span> (uppercase “eta”) in context of information theory is the expected value of information content or the mean/average information content of an “event” compared to all possible outcomes.
Encountering an event with low probability holds more information than encountering an event with high probability.</p>
<p><em>Binary cross entropy</em> is a measure to determine the similarity of two (discrete) probability distributions <span class="math inline">\(A~(\mathrm{true~distribution}), B~(\mathrm{predicted~distribution})\)</span> according to the inherent information.</p>
<p>It is not (!) symmetric, in general: <span class="math inline">\(\textbf{H}_{A}(B) \neq \textbf{H}_{B}(A)\)</span>.
The minimum value depends on the distribution of <span class="math inline">\(A\)</span> and is the entropy of <span class="math inline">\(A\)</span>:
<span class="math display">\[\mathrm{min}~\textbf{H}_{A}(B) = \underset{B}{\mathrm{min}}~\textbf{H}_{A}(B) = \textbf{H}_{A}(B = A) = \textbf{H}_{A}(A) = \textbf{H}(A)\]</span></p>
<p>The setup:</p>
<ul>
<li>Outcomes <span class="math inline">\(y_{i} \in \{0, 1\}\)</span> (labels).</li>
<li>Predictions <span class="math inline">\(\hat{y}_{i} \in[0, 1]\)</span> (probabilities).</li>
</ul>
<p>The binary cross entropy or log loss of a system of outcomes/predictions is then defined as follows:
<span class="math display">\[
  \textbf{H}_{A}(B) =
  -\frac{1}{N} \sum_{i = 1}^{N} y_{i} \cdot \mathrm{log} \left( p(y_{i}) \right) + (1 -y_{i}) \cdot \mathrm{log} \left( 1-p(y_{i}) \right) =\\
  = -\frac{1}{N} \sum_{i = 1}^{N} y_{i} \cdot \mathrm{log} (\hat{y}_{i}) + (1 -y_{i}) \cdot \mathrm{log} \left( 1- \hat{y}_{i} \right)
\]</span>
High predicted probabilities of having the label for originally labeled data (1) yield a low loss as well as predicting a low probability of having the label for originally unlabeled data (0). Mind the properties of probabilities and the logarithm.</p>
<p>A possible application of generative adversarial networks is to create pictures that look like real photographs e.g. <strong><a href="https://thispersondoesnotexist.com/" target="_blank" rel="noopener">https://thispersondoesnotexist.com/</a></strong>. Visit that site (several times)!.
However, the application of generative adversarial networks today is much wider than just the creation of data. For example, generative adversarial networks can also be used to “augment” data, i.e. to create new data and thereby improve the fitted model.</p>
<div id="mnist---generative-adversarial-networks-based-on-deep-neural-networks" class="section level3" number="8.2.1">
<h3>
<span class="header-section-number">8.2.1</span> MNIST - Generative Adversarial Networks Based on Deep Neural Networks<a class="anchor" aria-label="anchor" href="#mnist---generative-adversarial-networks-based-on-deep-neural-networks"><i class="fas fa-link"></i></a>
</h3>
<p>We will now explore this on the MNIST data set.</p>
<div class="sourceCode" id="cb431"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/set_random_seed.html">set_random_seed</a></span><span class="op">(</span><span class="fl">321L</span>, disable_gpu <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># Already sets R's random seed.</span></span>
<span></span>
<span><span class="va">rotate</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">2</span>, <span class="va">rev</span><span class="op">)</span><span class="op">)</span> <span class="op">}</span></span>
<span><span class="va">imgPlot</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">img</span>, <span class="va">title</span> <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">col</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/gray.colors.html">grey.colors</a></span><span class="op">(</span><span class="fl">255</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/image.html">image</a></span><span class="op">(</span><span class="fu"><a href="http://talgalili.github.io/dendextend/reference/rotate.html">rotate</a></span><span class="op">(</span><span class="va">img</span><span class="op">)</span>, col <span class="op">=</span> <span class="va">col</span>, xlab <span class="op">=</span> <span class="st">""</span>, ylab <span class="op">=</span> <span class="st">""</span>, axes <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Label: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">title</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We don’t need the test set here.</p>
<div class="sourceCode" id="cb432"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/dataset_mnist.html">dataset_mnist</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">train</span> <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">train</span></span>
<span><span class="va">train_x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span><span class="op">(</span><span class="op">(</span><span class="va">train</span><span class="op">$</span><span class="va">x</span><span class="op">-</span><span class="fl">127.5</span><span class="op">)</span><span class="op">/</span><span class="fl">127.5</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">train</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="fl">784L</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We need a function to sample images for the discriminator.</p>
<div class="sourceCode" id="cb433"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">batch_size</span> <span class="op">=</span> <span class="fl">32L</span></span>
<span><span class="va">dataset</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">Dataset</span><span class="op">$</span><span class="fu">from_tensor_slices</span><span class="op">(</span><span class="va">tf</span><span class="op">$</span><span class="fu">constant</span><span class="op">(</span><span class="va">train_x</span>, <span class="st">"float32"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">dataset</span><span class="op">$</span><span class="fu">batch</span><span class="op">(</span><span class="va">batch_size</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;BatchDataset element_spec=TensorSpec(shape=(None, 784), dtype=tf.float32, name=None)&gt;</span></span></code></pre></div>
<p>Define generator model:</p>
<div class="sourceCode" id="cb434"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">get_generator</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">generator</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">generator</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">200L</span>, input_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">100L</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_activation_leaky_relu.html">layer_activation_leaky_relu</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">200L</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_activation_leaky_relu.html">layer_activation_leaky_relu</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">784L</span>, activation <span class="op">=</span> <span class="st">"tanh"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">generator</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>And we also test the generator model:</p>
<div class="sourceCode" id="cb435"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">generator</span> <span class="op">=</span> <span class="fu">get_generator</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">sample</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">random</span><span class="op">$</span><span class="fu">normal</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1L</span>, <span class="fl">100L</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">imgPlot</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span><span class="op">(</span><span class="fu">generator</span><span class="op">(</span><span class="va">sample</span><span class="op">)</span><span class="op">$</span><span class="fu">numpy</span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">28L</span>, <span class="fl">28L</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="09-GAN_files/figure-html/chunk_chapter7_24-1.png" width="100%" style="display: block; margin: auto;"></div>
<p>In the discriminator, noise (random vector with 100 values) is passed through the network such that the output corresponds to the number of pixels of one MNIST image (784). We therefore define the discriminator function now.</p>
<div class="sourceCode" id="cb436"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">get_discriminator</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">discriminator</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">discriminator</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">200L</span>, input_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">784L</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_activation_leaky_relu.html">layer_activation_leaky_relu</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">100L</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_activation_leaky_relu.html">layer_activation_leaky_relu</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">1L</span>, activation <span class="op">=</span> <span class="st">"sigmoid"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">discriminator</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>And we also test the discriminator function.</p>
<div class="sourceCode" id="cb437"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">discriminator</span> <span class="op">=</span> <span class="fu">get_discriminator</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">discriminator</span><span class="op">(</span><span class="fu">generator</span><span class="op">(</span><span class="va">tf</span><span class="op">$</span><span class="va">random</span><span class="op">$</span><span class="fu">normal</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1L</span>, <span class="fl">100L</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; tf.Tensor([[0.5089391]], shape=(1, 1), dtype=float32)</span></span></code></pre></div>
<p>We also have to define the loss functions for both networks.We use the already known binary cross entropy. However, we have to encode the real and predicted values for the two networks individually.</p>
<p>The discriminator will get two losses - one for identifying fake images as fake, and one for identifying real MNIST images as real images.</p>
<p>The generator will just get one loss - was it able to deceive the discriminator?</p>
<div class="sourceCode" id="cb438"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ce</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">keras</span><span class="op">$</span><span class="va">losses</span><span class="op">$</span><span class="fu">BinaryCrossentropy</span><span class="op">(</span>from_logits <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">loss_discriminator</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">real</span>, <span class="va">fake</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">real_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/Metrics/man/ce.html">ce</a></span><span class="op">(</span><span class="va">tf</span><span class="op">$</span><span class="fu">ones_like</span><span class="op">(</span><span class="va">real</span><span class="op">)</span>, <span class="va">real</span><span class="op">)</span></span>
<span>  <span class="va">fake_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/Metrics/man/ce.html">ce</a></span><span class="op">(</span><span class="va">tf</span><span class="op">$</span><span class="fu">zeros_like</span><span class="op">(</span><span class="va">fake</span><span class="op">)</span>, <span class="va">fake</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">real_loss</span> <span class="op">+</span> <span class="va">fake_loss</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">loss_generator</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">fake</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/Metrics/man/ce.html">ce</a></span><span class="op">(</span><span class="va">tf</span><span class="op">$</span><span class="fu">ones_like</span><span class="op">(</span><span class="va">fake</span><span class="op">)</span>, <span class="va">fake</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Each network will get its own optimizer (in a GAN the networks are treated independently):</p>
<div class="sourceCode" id="cb439"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gen_opt</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">keras</span><span class="op">$</span><span class="va">optimizers</span><span class="op">$</span><span class="fu">RMSprop</span><span class="op">(</span><span class="fl">1e-4</span><span class="op">)</span></span>
<span><span class="va">disc_opt</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">keras</span><span class="op">$</span><span class="va">optimizers</span><span class="op">$</span><span class="fu">RMSprop</span><span class="op">(</span><span class="fl">1e-4</span><span class="op">)</span></span></code></pre></div>
<p>We have to write our own training loop here (we cannot use the fit function).
In each iteration (for each batch) we will do the following (the GradientTape records computations to do automatic differentiation):</p>
<ol style="list-style-type: decimal">
<li>Sample noise.</li>
<li>Generator creates images from the noise.</li>
<li>Discriminator makes predictions for fake images and real images (response is a probability between [0,1]).</li>
<li>Calculate loss for generator.</li>
<li>Calculate loss for discriminator.</li>
<li>Calculate gradients for weights and the loss.</li>
<li>Update weights of generator.</li>
<li>Update weights of discriminator.</li>
<li>Return losses.</li>
</ol>
<div class="sourceCode" id="cb440"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">generator</span> <span class="op">=</span> <span class="fu">get_generator</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">discriminator</span> <span class="op">=</span> <span class="fu">get_discriminator</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">train_step</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">images</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">noise</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">random</span><span class="op">$</span><span class="fu">normal</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">128L</span>, <span class="fl">100L</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">tf</span><span class="op">$</span><span class="fu">GradientTape</span><span class="op">(</span>persistent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://rstudio.github.io/reticulate/reference/with-as-operator.html">%as%</a></span> <span class="va">tape</span>,</span>
<span>    <span class="op">{</span></span>
<span>      <span class="va">gen_images</span> <span class="op">=</span> <span class="fu">generator</span><span class="op">(</span><span class="va">noise</span><span class="op">)</span></span>
<span>      <span class="va">fake_output</span> <span class="op">=</span> <span class="fu">discriminator</span><span class="op">(</span><span class="va">gen_images</span><span class="op">)</span></span>
<span>      <span class="va">real_output</span> <span class="op">=</span> <span class="fu">discriminator</span><span class="op">(</span><span class="va">images</span><span class="op">)</span></span>
<span>      <span class="va">gen_loss</span> <span class="op">=</span> <span class="fu">loss_generator</span><span class="op">(</span><span class="va">fake_output</span><span class="op">)</span></span>
<span>      <span class="va">disc_loss</span> <span class="op">=</span> <span class="fu">loss_discriminator</span><span class="op">(</span><span class="va">real_output</span>, <span class="va">fake_output</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">gen_grads</span> <span class="op">=</span> <span class="va">tape</span><span class="op">$</span><span class="fu">gradient</span><span class="op">(</span><span class="va">gen_loss</span>, <span class="va">generator</span><span class="op">$</span><span class="va">weights</span><span class="op">)</span></span>
<span>  <span class="va">disc_grads</span> <span class="op">=</span> <span class="va">tape</span><span class="op">$</span><span class="fu">gradient</span><span class="op">(</span><span class="va">disc_loss</span>, <span class="va">discriminator</span><span class="op">$</span><span class="va">weights</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">tape</span><span class="op">)</span></span>
<span>  <span class="va">gen_opt</span><span class="op">$</span><span class="fu">apply_gradients</span><span class="op">(</span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/transpose.html">transpose</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">gen_grads</span>, <span class="va">generator</span><span class="op">$</span><span class="va">weights</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">disc_opt</span><span class="op">$</span><span class="fu">apply_gradients</span><span class="op">(</span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/transpose.html">transpose</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">disc_grads</span>, <span class="va">discriminator</span><span class="op">$</span><span class="va">weights</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">gen_loss</span>, <span class="va">disc_loss</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">train_step</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="fu">`function`</span><span class="op">(</span><span class="fu">reticulate</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/reticulate/reference/py_func.html">py_func</a></span><span class="op">(</span><span class="va">train_step</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Now we can finally train our networks in a training loop:</p>
<ol style="list-style-type: decimal">
<li>Create networks.</li>
<li>Get batch of images.</li>
<li>Run train_step function.</li>
<li>Print losses.</li>
<li>Repeat step 2-4 for number of epochs.</li>
</ol>
<div class="sourceCode" id="cb441"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/set_random_seed.html">set_random_seed</a></span><span class="op">(</span><span class="fl">321L</span>, disable_gpu <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># Already sets R's random seed.</span></span>
<span></span>
<span><span class="va">batch_size</span> <span class="op">=</span> <span class="fl">128L</span></span>
<span><span class="va">epochs</span> <span class="op">=</span> <span class="fl">20L</span></span>
<span><span class="va">steps</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">train_x</span><span class="op">)</span><span class="op">/</span><span class="va">batch_size</span><span class="op">)</span></span>
<span><span class="va">counter</span> <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="va">gen_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">disc_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dataset2</span> <span class="op">=</span> <span class="va">dataset</span><span class="op">$</span><span class="fu">prefetch</span><span class="op">(</span><span class="va">tf</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">AUTOTUNE</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">e</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">epochs</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">dat</span> <span class="op">=</span> <span class="fu">reticulate</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/reticulate/reference/iterate.html">as_iterator</a></span><span class="op">(</span><span class="va">dataset2</span><span class="op">$</span><span class="fu">batch</span><span class="op">(</span><span class="va">batch_size</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu">coro</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coro/man/collect.html">loop</a></span><span class="op">(</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">images</span> <span class="kw">in</span> <span class="va">dat</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="va">losses</span> <span class="op">=</span> <span class="fu">train_step</span><span class="op">(</span><span class="va">images</span><span class="op">)</span></span>
<span>      <span class="va">gen_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">gen_loss</span>, <span class="va">tf</span><span class="op">$</span><span class="fu">reduce_sum</span><span class="op">(</span><span class="va">losses</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="fu">numpy</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="va">disc_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">disc_loss</span>, <span class="va">tf</span><span class="op">$</span><span class="fu">reduce_sum</span><span class="op">(</span><span class="va">losses</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="fu">numpy</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span>   </span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">epochs</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span> <span class="fl">5</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">{</span> <span class="co">#Print output every 5 steps.</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Gen: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">gen_loss</span><span class="op">)</span>, <span class="st">" Disc: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">disc_loss</span><span class="op">)</span>, <span class="st">" \n"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">noise</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">random</span><span class="op">$</span><span class="fu">normal</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1L</span>, <span class="fl">100L</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">epochs</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span> <span class="fl">10</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">{</span>  <span class="co">#Plot image every 10 steps.</span></span>
<span>    <span class="fu">imgPlot</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span><span class="op">(</span><span class="fu">generator</span><span class="op">(</span><span class="va">noise</span><span class="op">)</span><span class="op">$</span><span class="fu">numpy</span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">28L</span>, <span class="fl">28L</span><span class="op">)</span><span class="op">)</span>, <span class="st">"Gen"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Gen:  0.6884934  Disc:  1.085609</span></span></code></pre></div>
<div class="inline-figure"><img src="09-GAN_files/figure-html/chunk_chapter7_30-1.png" width="100%" style="display: block; margin: auto;"></div>
<pre><code>#&gt; Gen:  0.7152359  Disc:  1.162967</code></pre>
<div class="inline-figure"><img src="09-GAN_files/figure-html/chunk_chapter7_30-2.png" width="100%" style="display: block; margin: auto;"></div>
<pre><code>#&gt; Gen:  0.7213668  Disc:  1.175857</code></pre>
<div class="inline-figure"><img src="09-GAN_files/figure-html/chunk_chapter7_30-3.png" width="100%" style="display: block; margin: auto;"></div>
<pre><code>#&gt; Gen:  0.7423671  Disc:  1.166635</code></pre>
<div class="inline-figure"><img src="09-GAN_files/figure-html/chunk_chapter7_30-4.png" width="100%" style="display: block; margin: auto;"></div>
<pre><code>#&gt; Gen:  0.7599397  Disc:  1.165749</code></pre>
<div class="inline-figure"><img src="09-GAN_files/figure-html/chunk_chapter7_30-5.png" width="100%" style="display: block; margin: auto;"></div>
<pre><code>#&gt; Gen:  0.7712564  Disc:  1.181281</code></pre>
<div class="inline-figure"><img src="09-GAN_files/figure-html/chunk_chapter7_30-6.png" width="100%" style="display: block; margin: auto;"></div>
<pre><code>#&gt; Gen:  0.8222006  Disc:  1.106725</code></pre>
<div class="inline-figure"><img src="09-GAN_files/figure-html/chunk_chapter7_30-7.png" width="100%" style="display: block; margin: auto;"></div>
<pre><code>#&gt; Gen:  0.9214915  Disc:  1.115732</code></pre>
<div class="inline-figure"><img src="09-GAN_files/figure-html/chunk_chapter7_30-8.png" width="100%" style="display: block; margin: auto;"></div>
<pre><code>#&gt; Gen:  0.9310804  Disc:  1.18354</code></pre>
<div class="inline-figure"><img src="09-GAN_files/figure-html/chunk_chapter7_30-9.png" width="100%" style="display: block; margin: auto;"></div>
<pre><code>#&gt; Gen:  0.9413241  Disc:  1.22591</code></pre>
<div class="inline-figure"><img src="09-GAN_files/figure-html/chunk_chapter7_30-10.png" width="100%" style="display: block; margin: auto;"></div>
<pre><code>#&gt; Gen:  0.952243  Disc:  1.252399</code></pre>
<div class="inline-figure"><img src="09-GAN_files/figure-html/chunk_chapter7_30-11.png" width="100%" style="display: block; margin: auto;"></div>
<pre><code>#&gt; Gen:  0.9622479  Disc:  1.270034</code></pre>
<div class="inline-figure"><img src="09-GAN_files/figure-html/chunk_chapter7_30-12.png" width="100%" style="display: block; margin: auto;"></div>
<pre><code>#&gt; Gen:  0.9704371  Disc:  1.283249</code></pre>
<div class="inline-figure"><img src="09-GAN_files/figure-html/chunk_chapter7_30-13.png" width="100%" style="display: block; margin: auto;"></div>
<pre><code>#&gt; Gen:  0.9778271  Disc:  1.29094</code></pre>
<div class="inline-figure"><img src="09-GAN_files/figure-html/chunk_chapter7_30-14.png" width="100%" style="display: block; margin: auto;"></div>
<pre><code>#&gt; Gen:  0.9859265  Disc:  1.297595</code></pre>
<div class="inline-figure"><img src="09-GAN_files/figure-html/chunk_chapter7_30-15.png" width="100%" style="display: block; margin: auto;"></div>
<pre><code>#&gt; Gen:  0.9939315  Disc:  1.301899</code></pre>
<div class="inline-figure"><img src="09-GAN_files/figure-html/chunk_chapter7_30-16.png" width="100%" style="display: block; margin: auto;"></div>
<pre><code>#&gt; Gen:  1.004366  Disc:  1.304773</code></pre>
<div class="inline-figure"><img src="09-GAN_files/figure-html/chunk_chapter7_30-17.png" width="100%" style="display: block; margin: auto;"></div>
<pre><code>#&gt; Gen:  1.019454  Disc:  1.307742</code></pre>
<div class="inline-figure"><img src="09-GAN_files/figure-html/chunk_chapter7_30-18.png" width="100%" style="display: block; margin: auto;"></div>
<pre><code>#&gt; Gen:  1.029843  Disc:  1.310403</code></pre>
<div class="inline-figure"><img src="09-GAN_files/figure-html/chunk_chapter7_30-19.png" width="100%" style="display: block; margin: auto;"></div>
<pre><code>#&gt; Gen:  1.043565  Disc:  1.316857</code></pre>
<div class="inline-figure"><img src="09-GAN_files/figure-html/chunk_chapter7_30-20.png" width="100%" style="display: block; margin: auto;"></div>
</div>
<div id="flower---gan" class="section level3" number="8.2.2">
<h3>
<span class="header-section-number">8.2.2</span> Flower - GAN<a class="anchor" aria-label="anchor" href="#flower---gan"><i class="fas fa-link"></i></a>
</h3>
<p>We can now also do the same for the flower data set. We will write this completely on our own following the steps also done for the MNIST data set.</p>
<div class="sourceCode" id="cb461"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; ── Attaching packages ───────────────────────────────────────────────── tidyverse 1.3.1 ──</span></span>
<span><span class="co">#&gt; ✔ ggplot2 3.3.6     ✔ purrr   0.3.4</span></span>
<span><span class="co">#&gt; ✔ tibble  3.1.7     ✔ dplyr   1.0.9</span></span>
<span><span class="co">#&gt; ✔ tidyr   1.2.0     ✔ stringr 1.4.0</span></span>
<span><span class="co">#&gt; ✔ readr   2.1.2     ✔ forcats 0.5.1</span></span>
<span><span class="co">#&gt; ── Conflicts ──────────────────────────────────────────────────── tidyverse_conflicts() ──</span></span>
<span><span class="co">#&gt; ✖ dplyr::filter() masks stats::filter()</span></span>
<span><span class="co">#&gt; ✖ dplyr::lag()    masks stats::lag()</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/TheoreticalEcology/">EcoData</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="fu">EcoData</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/EcoData/man/dataset_flower.html">dataset_flower</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">train</span> <span class="op">=</span> <span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">train</span><span class="op">-</span><span class="fl">127.5</span><span class="op">)</span><span class="op">/</span><span class="fl">127.5</span></span>
<span><span class="va">test</span> <span class="op">=</span> <span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">test</span><span class="op">-</span><span class="fl">127.5</span><span class="op">)</span><span class="op">/</span><span class="fl">127.5</span></span>
<span><span class="va">train_x</span> <span class="op">=</span> <span class="fu">abind</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/abind/man/abind.html">abind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">train</span>, <span class="va">test</span><span class="op">)</span>, along <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span></span>
<span><span class="va">dataset</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">Dataset</span><span class="op">$</span><span class="fu">from_tensor_slices</span><span class="op">(</span><span class="va">tf</span><span class="op">$</span><span class="fu">constant</span><span class="op">(</span><span class="va">train_x</span>, <span class="st">"float32"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Define the generator model and test it:</p>
<div class="sourceCode" id="cb462"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/set_random_seed.html">set_random_seed</a></span><span class="op">(</span><span class="fl">321L</span>, disable_gpu <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># Already sets R's random seed.</span></span>
<span></span>
<span><span class="va">get_generator</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">generator</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">generator</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">20L</span><span class="op">*</span><span class="fl">20L</span><span class="op">*</span><span class="fl">128L</span>, input_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">100L</span><span class="op">)</span>,</span>
<span>                use_bias <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_activation_leaky_relu.html">layer_activation_leaky_relu</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_reshape.html">layer_reshape</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">20L</span>, <span class="fl">20L</span>, <span class="fl">128L</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dropout.html">layer_dropout</a></span><span class="op">(</span><span class="fl">0.3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_conv_2d_transpose.html">layer_conv_2d_transpose</a></span><span class="op">(</span>filters <span class="op">=</span> <span class="fl">256L</span>, kernel_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3L</span>, <span class="fl">3L</span><span class="op">)</span>,</span>
<span>                            padding <span class="op">=</span> <span class="st">"same"</span>, strides <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1L</span>, <span class="fl">1L</span><span class="op">)</span>,</span>
<span>                            use_bias <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_activation_leaky_relu.html">layer_activation_leaky_relu</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dropout.html">layer_dropout</a></span><span class="op">(</span><span class="fl">0.3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_conv_2d_transpose.html">layer_conv_2d_transpose</a></span><span class="op">(</span>filters <span class="op">=</span> <span class="fl">128L</span>, kernel_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5L</span>, <span class="fl">5L</span><span class="op">)</span>,</span>
<span>                            padding <span class="op">=</span> <span class="st">"same"</span>, strides <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1L</span>, <span class="fl">1L</span><span class="op">)</span>,</span>
<span>                            use_bias <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_activation_leaky_relu.html">layer_activation_leaky_relu</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dropout.html">layer_dropout</a></span><span class="op">(</span><span class="fl">0.3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_conv_2d_transpose.html">layer_conv_2d_transpose</a></span><span class="op">(</span>filters <span class="op">=</span> <span class="fl">64L</span>, kernel_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5L</span>, <span class="fl">5L</span><span class="op">)</span>,</span>
<span>                            padding <span class="op">=</span> <span class="st">"same"</span>, strides <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2L</span>, <span class="fl">2L</span><span class="op">)</span>,</span>
<span>                            use_bias <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_activation_leaky_relu.html">layer_activation_leaky_relu</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dropout.html">layer_dropout</a></span><span class="op">(</span><span class="fl">0.3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_conv_2d_transpose.html">layer_conv_2d_transpose</a></span><span class="op">(</span>filters <span class="op">=</span> <span class="fl">3L</span>, kernel_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5L</span>, <span class="fl">5L</span><span class="op">)</span>,</span>
<span>                            padding <span class="op">=</span> <span class="st">"same"</span>, strides <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2L</span>, <span class="fl">2L</span><span class="op">)</span>,</span>
<span>                            activation <span class="op">=</span> <span class="st">"tanh"</span>, use_bias <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">generator</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">generator</span> <span class="op">=</span> <span class="fu">get_generator</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">image</span> <span class="op">=</span> <span class="fu">generator</span><span class="op">(</span><span class="va">tf</span><span class="op">$</span><span class="va">random</span><span class="op">$</span><span class="fu">normal</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1L</span>,<span class="fl">100L</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="fu">numpy</span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span>,,,<span class="op">]</span></span>
<span><span class="va">image</span> <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/rescale.html">rescale</a></span><span class="op">(</span><span class="va">image</span>, to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">255</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">image</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/image_to_array.html">image_to_array</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">`/`</span><span class="op">(</span><span class="va">.</span>, <span class="fl">255</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/grDevices/as.raster.html">as.raster</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="09-GAN_files/figure-html/chunk_chapter7_32-1.png" width="100%" style="display: block; margin: auto;"></div>
<p>Define the discriminator and test it:</p>
<div class="sourceCode" id="cb463"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/set_random_seed.html">set_random_seed</a></span><span class="op">(</span><span class="fl">321L</span>, disable_gpu <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># Already sets R's random seed.</span></span>
<span></span>
<span><span class="va">get_discriminator</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">discriminator</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">discriminator</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_conv_2d.html">layer_conv_2d</a></span><span class="op">(</span>filters <span class="op">=</span> <span class="fl">64L</span>, kernel_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5L</span>, <span class="fl">5L</span><span class="op">)</span>,</span>
<span>                  strides <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2L</span>, <span class="fl">2L</span><span class="op">)</span>, padding <span class="op">=</span> <span class="st">"same"</span>,</span>
<span>                  input_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">80L</span>, <span class="fl">80L</span>, <span class="fl">3L</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_activation_leaky_relu.html">layer_activation_leaky_relu</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dropout.html">layer_dropout</a></span><span class="op">(</span><span class="fl">0.3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_conv_2d.html">layer_conv_2d</a></span><span class="op">(</span>filters <span class="op">=</span> <span class="fl">128L</span>, kernel_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5L</span>, <span class="fl">5L</span><span class="op">)</span>,</span>
<span>                  strides <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2L</span>, <span class="fl">2L</span><span class="op">)</span>, padding <span class="op">=</span> <span class="st">"same"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_activation_leaky_relu.html">layer_activation_leaky_relu</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dropout.html">layer_dropout</a></span><span class="op">(</span><span class="fl">0.3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_conv_2d.html">layer_conv_2d</a></span><span class="op">(</span>filters <span class="op">=</span> <span class="fl">256L</span>, kernel_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3L</span>, <span class="fl">3L</span><span class="op">)</span>,</span>
<span>                  strides <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2L</span>, <span class="fl">2L</span><span class="op">)</span>, padding <span class="op">=</span> <span class="st">"same"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_activation_leaky_relu.html">layer_activation_leaky_relu</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dropout.html">layer_dropout</a></span><span class="op">(</span><span class="fl">0.3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_flatten.html">layer_flatten</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">1L</span>, activation <span class="op">=</span> <span class="st">"sigmoid"</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">discriminator</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">discriminator</span> <span class="op">=</span> <span class="fu">get_discriminator</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">discriminator</span></span>
<span><span class="co">#&gt; Model: "sequential_7"</span></span>
<span><span class="co">#&gt; __________________________________________________________________________________________</span></span>
<span><span class="co">#&gt;  Layer (type)                           Output Shape                        Param #       </span></span>
<span><span class="co">#&gt; ==========================================================================================</span></span>
<span><span class="co">#&gt;  conv2d_5 (Conv2D)                      (None, 40, 40, 64)                  4864          </span></span>
<span><span class="co">#&gt;  leaky_re_lu_14 (LeakyReLU)             (None, 40, 40, 64)                  0             </span></span>
<span><span class="co">#&gt;  dropout_6 (Dropout)                    (None, 40, 40, 64)                  0             </span></span>
<span><span class="co">#&gt;  conv2d_4 (Conv2D)                      (None, 20, 20, 128)                 204928        </span></span>
<span><span class="co">#&gt;  leaky_re_lu_13 (LeakyReLU)             (None, 20, 20, 128)                 0             </span></span>
<span><span class="co">#&gt;  dropout_5 (Dropout)                    (None, 20, 20, 128)                 0             </span></span>
<span><span class="co">#&gt;  conv2d_3 (Conv2D)                      (None, 10, 10, 256)                 295168        </span></span>
<span><span class="co">#&gt;  leaky_re_lu_12 (LeakyReLU)             (None, 10, 10, 256)                 0             </span></span>
<span><span class="co">#&gt;  dropout_4 (Dropout)                    (None, 10, 10, 256)                 0             </span></span>
<span><span class="co">#&gt;  flatten_1 (Flatten)                    (None, 25600)                       0             </span></span>
<span><span class="co">#&gt;  dense_15 (Dense)                       (None, 1)                           25601         </span></span>
<span><span class="co">#&gt; ==========================================================================================</span></span>
<span><span class="co">#&gt; Total params: 530,561</span></span>
<span><span class="co">#&gt; Trainable params: 530,561</span></span>
<span><span class="co">#&gt; Non-trainable params: 0</span></span>
<span><span class="co">#&gt; __________________________________________________________________________________________</span></span>
<span><span class="fu">discriminator</span><span class="op">(</span><span class="fu">generator</span><span class="op">(</span><span class="va">tf</span><span class="op">$</span><span class="va">random</span><span class="op">$</span><span class="fu">normal</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1L</span>, <span class="fl">100L</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; tf.Tensor([[0.4999608]], shape=(1, 1), dtype=float32)</span></span></code></pre></div>
<p>Define the loss functions:</p>
<div class="sourceCode" id="cb464"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ce</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">keras</span><span class="op">$</span><span class="va">losses</span><span class="op">$</span><span class="fu">BinaryCrossentropy</span><span class="op">(</span>from_logits <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                        label_smoothing <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">loss_discriminator</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">real</span>, <span class="va">fake</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">real_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/Metrics/man/ce.html">ce</a></span><span class="op">(</span><span class="va">tf</span><span class="op">$</span><span class="fu">ones_like</span><span class="op">(</span><span class="va">real</span><span class="op">)</span>, <span class="va">real</span><span class="op">)</span></span>
<span>  <span class="va">fake_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/Metrics/man/ce.html">ce</a></span><span class="op">(</span><span class="va">tf</span><span class="op">$</span><span class="fu">zeros_like</span><span class="op">(</span><span class="va">fake</span><span class="op">)</span>, <span class="va">fake</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">real_loss</span><span class="op">+</span><span class="va">fake_loss</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">loss_generator</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">fake</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/Metrics/man/ce.html">ce</a></span><span class="op">(</span><span class="va">tf</span><span class="op">$</span><span class="fu">ones_like</span><span class="op">(</span><span class="va">fake</span><span class="op">)</span>, <span class="va">fake</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Define the optimizers and the batch function:</p>
<div class="sourceCode" id="cb465"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gen_opt</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">keras</span><span class="op">$</span><span class="va">optimizers</span><span class="op">$</span><span class="fu">RMSprop</span><span class="op">(</span><span class="fl">1e-4</span><span class="op">)</span></span>
<span><span class="va">disc_opt</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">keras</span><span class="op">$</span><span class="va">optimizers</span><span class="op">$</span><span class="fu">RMSprop</span><span class="op">(</span><span class="fl">1e-4</span><span class="op">)</span></span></code></pre></div>
<p>Define functions for the generator and discriminator:</p>
<div class="sourceCode" id="cb466"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">generator</span> <span class="op">=</span> <span class="fu">get_generator</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">discriminator</span> <span class="op">=</span> <span class="fu">get_discriminator</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">train_step</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">images</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">noise</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">random</span><span class="op">$</span><span class="fu">normal</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">32L</span>, <span class="fl">100L</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">tf</span><span class="op">$</span><span class="fu">GradientTape</span><span class="op">(</span>persistent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://rstudio.github.io/reticulate/reference/with-as-operator.html">%as%</a></span> <span class="va">tape</span>,</span>
<span>    <span class="op">{</span></span>
<span>      <span class="va">gen_images</span> <span class="op">=</span> <span class="fu">generator</span><span class="op">(</span><span class="va">noise</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="va">real_output</span> <span class="op">=</span> <span class="fu">discriminator</span><span class="op">(</span><span class="va">images</span><span class="op">)</span></span>
<span>      <span class="va">fake_output</span> <span class="op">=</span> <span class="fu">discriminator</span><span class="op">(</span><span class="va">gen_images</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="va">gen_loss</span> <span class="op">=</span> <span class="fu">loss_generator</span><span class="op">(</span><span class="va">fake_output</span><span class="op">)</span></span>
<span>      <span class="va">disc_loss</span> <span class="op">=</span> <span class="fu">loss_discriminator</span><span class="op">(</span><span class="va">real_output</span>, <span class="va">fake_output</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">gen_grads</span> <span class="op">=</span> <span class="va">tape</span><span class="op">$</span><span class="fu">gradient</span><span class="op">(</span><span class="va">gen_loss</span>, <span class="va">generator</span><span class="op">$</span><span class="va">weights</span><span class="op">)</span></span>
<span>  <span class="va">disc_grads</span> <span class="op">=</span> <span class="va">tape</span><span class="op">$</span><span class="fu">gradient</span><span class="op">(</span><span class="va">disc_loss</span>, <span class="va">discriminator</span><span class="op">$</span><span class="va">weights</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">tape</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">gen_opt</span><span class="op">$</span><span class="fu">apply_gradients</span><span class="op">(</span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/transpose.html">transpose</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">gen_grads</span>,</span>
<span>                                                <span class="va">generator</span><span class="op">$</span><span class="va">weights</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">disc_opt</span><span class="op">$</span><span class="fu">apply_gradients</span><span class="op">(</span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/transpose.html">transpose</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">disc_grads</span>,</span>
<span>                                                 <span class="va">discriminator</span><span class="op">$</span><span class="va">weights</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">gen_loss</span>, <span class="va">disc_loss</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">train_step</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="fu">`function`</span><span class="op">(</span><span class="fu">reticulate</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/reticulate/reference/py_func.html">py_func</a></span><span class="op">(</span><span class="va">train_step</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Do the training:</p>
<div class="sourceCode" id="cb467"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/set_random_seed.html">set_random_seed</a></span><span class="op">(</span><span class="fl">321L</span>, disable_gpu <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># Already sets R's random seed.</span></span>
<span></span>
<span><span class="va">batch_size</span> <span class="op">=</span> <span class="fl">32L</span></span>
<span><span class="va">epochs</span> <span class="op">=</span> <span class="fl">30L</span></span>
<span><span class="va">steps</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">train_x</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">/</span><span class="va">batch_size</span><span class="op">)</span></span>
<span><span class="va">counter</span> <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="va">gen_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">disc_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dataset</span> <span class="op">=</span> <span class="va">dataset</span><span class="op">$</span><span class="fu">prefetch</span><span class="op">(</span><span class="va">tf</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">AUTOTUNE</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">e</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">epochs</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">dat</span> <span class="op">=</span> <span class="fu">reticulate</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/reticulate/reference/iterate.html">as_iterator</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">$</span><span class="fu">batch</span><span class="op">(</span><span class="va">batch_size</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu">coro</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coro/man/collect.html">loop</a></span><span class="op">(</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">images</span> <span class="kw">in</span> <span class="va">dat</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="va">losses</span> <span class="op">=</span> <span class="fu">train_step</span><span class="op">(</span><span class="va">images</span><span class="op">)</span></span>
<span>      <span class="va">gen_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">gen_loss</span>, <span class="va">tf</span><span class="op">$</span><span class="fu">reduce_sum</span><span class="op">(</span><span class="va">losses</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="fu">numpy</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="va">disc_loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">disc_loss</span>, <span class="va">tf</span><span class="op">$</span><span class="fu">reduce_sum</span><span class="op">(</span><span class="va">losses</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="fu">numpy</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span>   </span>
<span>  <span class="va">noise</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">random</span><span class="op">$</span><span class="fu">normal</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1L</span>, <span class="fl">100L</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">image</span> <span class="op">=</span> <span class="fu">generator</span><span class="op">(</span><span class="va">noise</span><span class="op">)</span><span class="op">$</span><span class="fu">numpy</span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span>,,,<span class="op">]</span></span>
<span>  <span class="va">image</span> <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/rescale.html">rescale</a></span><span class="op">(</span><span class="va">image</span>, to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">255</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">e</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span> <span class="fl">10</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">image</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/keras/man/image_to_array.html">image_to_array</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu">`/`</span><span class="op">(</span><span class="va">.</span>, <span class="fl">255</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/grDevices/as.raster.html">as.raster</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>   </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Gen: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">gen_loss</span><span class="op">)</span>, <span class="st">" Disc: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">disc_loss</span><span class="op">)</span>, <span class="st">" \n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Gen:  1.143774  Disc:  0.7957661  </span></span>
<span><span class="co">#&gt; Gen:  1.497174  Disc:  0.7416704  </span></span>
<span><span class="co">#&gt; Gen:  1.723195  Disc:  0.7223008  </span></span>
<span><span class="co">#&gt; Gen:  1.830423  Disc:  0.73045  </span></span>
<span><span class="co">#&gt; Gen:  1.842911  Disc:  0.753501  </span></span>
<span><span class="co">#&gt; Gen:  1.8544  Disc:  0.7677898  </span></span>
<span><span class="co">#&gt; Gen:  1.796528  Disc:  0.8014661  </span></span>
<span><span class="co">#&gt; Gen:  1.728089  Disc:  0.8346844  </span></span>
<span><span class="co">#&gt; Gen:  1.674429  Disc:  0.8570877</span></span></code></pre></div>
<div class="inline-figure"><img src="09-GAN_files/figure-html/chunk_chapter7_37-1.png" width="100%" style="display: block; margin: auto;"></div>
<pre><code>#&gt; Gen:  1.617773  Disc:  0.8798137  
#&gt; Gen:  1.569825  Disc:  0.8988503  
#&gt; Gen:  1.527545  Disc:  0.9151082  
#&gt; Gen:  1.493145  Disc:  0.9310999  
#&gt; Gen:  1.463344  Disc:  0.9436654  
#&gt; Gen:  1.434633  Disc:  0.9576464  
#&gt; Gen:  1.406997  Disc:  0.9707255  
#&gt; Gen:  1.382015  Disc:  0.9831676  
#&gt; Gen:  1.359031  Disc:  0.9945794  
#&gt; Gen:  1.33527  Disc:  1.007315</code></pre>
<div class="inline-figure"><img src="09-GAN_files/figure-html/chunk_chapter7_37-2.png" width="100%" style="display: block; margin: auto;"></div>
<pre><code>#&gt; Gen:  1.312788  Disc:  1.018794  
#&gt; Gen:  1.292069  Disc:  1.030401  
#&gt; Gen:  1.275383  Disc:  1.038811  
#&gt; Gen:  1.259953  Disc:  1.046686  
#&gt; Gen:  1.245397  Disc:  1.05389  
#&gt; Gen:  1.232108  Disc:  1.060455  
#&gt; Gen:  1.22031  Disc:  1.065932  
#&gt; Gen:  1.209019  Disc:  1.071359  
#&gt; Gen:  1.198599  Disc:  1.075818  
#&gt; Gen:  1.189716  Disc:  1.079902</code></pre>
<div class="inline-figure"><img src="09-GAN_files/figure-html/chunk_chapter7_37-3.png" width="100%" style="display: block; margin: auto;"></div>
<pre><code>#&gt; Gen:  1.181944  Disc:  1.082428</code></pre>
<div class="sourceCode" id="cb471"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/set_random_seed.html">set_random_seed</a></span><span class="op">(</span><span class="fl">321L</span>, disable_gpu <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># Already sets R's random seed.</span></span>
<span></span>
<span><span class="va">noise</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">random</span><span class="op">$</span><span class="fu">normal</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1L</span>, <span class="fl">100L</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">image</span> <span class="op">=</span> <span class="fu">generator</span><span class="op">(</span><span class="va">noise</span><span class="op">)</span><span class="op">$</span><span class="fu">numpy</span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span>,,,<span class="op">]</span></span>
<span><span class="va">image</span> <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/rescale.html">rescale</a></span><span class="op">(</span><span class="va">image</span>, to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">255</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">image</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/image_to_array.html">image_to_array</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">`/`</span><span class="op">(</span><span class="va">.</span>, <span class="fl">255</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/grDevices/as.raster.html">as.raster</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="09-GAN_files/figure-html/chunk_chapter7_38-1.png" width="100%" style="display: block; margin: auto;"></div>
<p>More images:</p>
<p><img src="images/flower2.png" width="150%" height="150%" style="display: block; margin: auto;"><img src="images/flower3.png" width="150%" height="150%" style="display: block; margin: auto;"><img src="images/flower4.png" width="150%" height="150%" style="display: block; margin: auto;"><img src="images/flower5.png" width="150%" height="150%" style="display: block; margin: auto;"></p>
</div>
</div>
<div id="reinforcement-learning" class="section level2" number="8.3">
<h2>
<span class="header-section-number">8.3</span> Reinforcement learning<a class="anchor" aria-label="anchor" href="#reinforcement-learning"><i class="fas fa-link"></i></a>
</h2>
<p>This is just a teaser, run/adapt it if you like.</p>
<p>Objective: Train a neural network capable of balancing a pole.</p>
<p>The environment is run on a local server, please install <a href="https://github.com/openai/gym-http-api" target="_blank" rel="noopener">gym</a>.</p>
<p>Or go through this <a href="https://colab.research.google.com/github/tensorflow/agents/blob/master/docs/tutorials/6_reinforce_tutorial.ipynb" target="_blank" rel="noopener">colab book</a>.</p>
<div class="sourceCode" id="cb472"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb472-1"><a href="gan.html#cb472-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(keras)</span>
<span id="cb472-2"><a href="gan.html#cb472-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tensorflow)</span>
<span id="cb472-3"><a href="gan.html#cb472-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gym)</span>
<span id="cb472-4"><a href="gan.html#cb472-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set_random_seed</span>(321L, <span class="at">disable_gpu =</span> <span class="cn">FALSE</span>)  <span class="co"># Already sets R's random seed.</span></span>
<span id="cb472-5"><a href="gan.html#cb472-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb472-6"><a href="gan.html#cb472-6" aria-hidden="true" tabindex="-1"></a>remote_base <span class="ot">=</span>´ <span class="st">"http://127.0.0.1:5000"</span></span>
<span id="cb472-7"><a href="gan.html#cb472-7" aria-hidden="true" tabindex="-1"></a>client <span class="ot">=</span> <span class="fu">create_GymClient</span>(remote_base)</span>
<span id="cb472-8"><a href="gan.html#cb472-8" aria-hidden="true" tabindex="-1"></a>env <span class="ot">=</span> gym<span class="sc">::</span><span class="fu">env_create</span>(client, <span class="st">"CartPole-v1"</span>)</span>
<span id="cb472-9"><a href="gan.html#cb472-9" aria-hidden="true" tabindex="-1"></a>gym<span class="sc">::</span><span class="fu">env_list_all</span>(client)</span>
<span id="cb472-10"><a href="gan.html#cb472-10" aria-hidden="true" tabindex="-1"></a><span class="fu">env_reset</span>(client, env)</span>
<span id="cb472-11"><a href="gan.html#cb472-11" aria-hidden="true" tabindex="-1"></a><span class="co"># action = env_action_space_sample(client, env)</span></span>
<span id="cb472-12"><a href="gan.html#cb472-12" aria-hidden="true" tabindex="-1"></a>step <span class="ot">=</span> <span class="fu">env_step</span>(client, env, <span class="dv">1</span>)</span>
<span id="cb472-13"><a href="gan.html#cb472-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb472-14"><a href="gan.html#cb472-14" aria-hidden="true" tabindex="-1"></a><span class="fu">env_reset</span>(client, env)</span>
<span id="cb472-15"><a href="gan.html#cb472-15" aria-hidden="true" tabindex="-1"></a>goal_steps <span class="ot">=</span> <span class="dv">500</span></span>
<span id="cb472-16"><a href="gan.html#cb472-16" aria-hidden="true" tabindex="-1"></a>score_requirement <span class="ot">=</span> <span class="dv">60</span></span>
<span id="cb472-17"><a href="gan.html#cb472-17" aria-hidden="true" tabindex="-1"></a>intial_games <span class="ot">=</span> <span class="dv">1000</span></span>
<span id="cb472-18"><a href="gan.html#cb472-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb472-19"><a href="gan.html#cb472-19" aria-hidden="true" tabindex="-1"></a>state_size <span class="ot">=</span> 4L</span>
<span id="cb472-20"><a href="gan.html#cb472-20" aria-hidden="true" tabindex="-1"></a>action_size <span class="ot">=</span> 2L</span>
<span id="cb472-21"><a href="gan.html#cb472-21" aria-hidden="true" tabindex="-1"></a>gamma <span class="ot">=</span> <span class="fl">0.95</span></span>
<span id="cb472-22"><a href="gan.html#cb472-22" aria-hidden="true" tabindex="-1"></a>epsilon <span class="ot">=</span> <span class="fl">0.95</span></span>
<span id="cb472-23"><a href="gan.html#cb472-23" aria-hidden="true" tabindex="-1"></a>epsilon_min <span class="ot">=</span> <span class="fl">0.01</span></span>
<span id="cb472-24"><a href="gan.html#cb472-24" aria-hidden="true" tabindex="-1"></a>epsilon_decay <span class="ot">=</span> <span class="fl">0.995</span></span>
<span id="cb472-25"><a href="gan.html#cb472-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb472-26"><a href="gan.html#cb472-26" aria-hidden="true" tabindex="-1"></a>model <span class="ot">=</span> <span class="fu">keras_model_sequential</span>()</span>
<span id="cb472-27"><a href="gan.html#cb472-27" aria-hidden="true" tabindex="-1"></a>model <span class="sc">%&gt;%</span> </span>
<span id="cb472-28"><a href="gan.html#cb472-28" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_dense</span>(<span class="at">input_shape =</span> <span class="fu">c</span>(4L), <span class="at">units =</span> 20L, <span class="at">activation =</span> <span class="st">"relu"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb472-29"><a href="gan.html#cb472-29" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_dense</span>(<span class="at">units =</span> 20L, <span class="at">activation =</span> <span class="st">"relu"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb472-30"><a href="gan.html#cb472-30" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_dense</span>(2L, <span class="at">activation =</span> <span class="st">"linear"</span>)</span>
<span id="cb472-31"><a href="gan.html#cb472-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb472-32"><a href="gan.html#cb472-32" aria-hidden="true" tabindex="-1"></a>model <span class="sc">%&gt;%</span> </span>
<span id="cb472-33"><a href="gan.html#cb472-33" aria-hidden="true" tabindex="-1"></a> keras<span class="sc">::</span><span class="fu">compile</span>(<span class="at">loss =</span> loss_mean_squared_error, <span class="at">optimizer =</span> <span class="fu">optimizer_adamax</span>())</span>
<span id="cb472-34"><a href="gan.html#cb472-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb472-35"><a href="gan.html#cb472-35" aria-hidden="true" tabindex="-1"></a>memory <span class="ot">=</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> 8000L, 11L)</span>
<span id="cb472-36"><a href="gan.html#cb472-36" aria-hidden="true" tabindex="-1"></a>counter <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb472-37"><a href="gan.html#cb472-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb472-38"><a href="gan.html#cb472-38" aria-hidden="true" tabindex="-1"></a>remember <span class="ot">=</span> <span class="cf">function</span>(memory, state, action, reward, next_state, done){</span>
<span id="cb472-39"><a href="gan.html#cb472-39" aria-hidden="true" tabindex="-1"></a>  memory[counter,] <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="fu">c</span>(state, action, reward, next_state, done))</span>
<span id="cb472-40"><a href="gan.html#cb472-40" aria-hidden="true" tabindex="-1"></a>  counter <span class="ot">&lt;&lt;-</span> counter<span class="sc">+</span><span class="dv">1</span></span>
<span id="cb472-41"><a href="gan.html#cb472-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(memory)</span>
<span id="cb472-42"><a href="gan.html#cb472-42" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb472-43"><a href="gan.html#cb472-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb472-44"><a href="gan.html#cb472-44" aria-hidden="true" tabindex="-1"></a><span class="co"># memory: state 1:4, action 5, reward 6, next_state 7:10, done 11</span></span>
<span id="cb472-45"><a href="gan.html#cb472-45" aria-hidden="true" tabindex="-1"></a>act <span class="ot">=</span> <span class="cf">function</span>(state){</span>
<span id="cb472-46"><a href="gan.html#cb472-46" aria-hidden="true" tabindex="-1"></a> <span class="cf">if</span>(<span class="fu">runif</span>(<span class="dv">1</span>) <span class="sc">&lt;=</span> epsilon){ <span class="fu">return</span>(<span class="fu">sample</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="dv">1</span>)) }</span>
<span id="cb472-47"><a href="gan.html#cb472-47" aria-hidden="true" tabindex="-1"></a> act_prob <span class="ot">=</span> <span class="fu">predict</span>(model, <span class="fu">matrix</span>(state, <span class="at">nrow =</span> 1L))</span>
<span id="cb472-48"><a href="gan.html#cb472-48" aria-hidden="true" tabindex="-1"></a> <span class="fu">return</span>(<span class="fu">which.max</span>(act_prob) <span class="sc">-</span> 1L)</span>
<span id="cb472-49"><a href="gan.html#cb472-49" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb472-50"><a href="gan.html#cb472-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb472-51"><a href="gan.html#cb472-51" aria-hidden="true" tabindex="-1"></a>replay <span class="ot">=</span> <span class="cf">function</span>(<span class="at">batch_size =</span> 25L, memory, counter){</span>
<span id="cb472-52"><a href="gan.html#cb472-52" aria-hidden="true" tabindex="-1"></a>  indices <span class="ot">=</span> <span class="fu">sample.int</span>(counter, batch_size)</span>
<span id="cb472-53"><a href="gan.html#cb472-53" aria-hidden="true" tabindex="-1"></a>  batch <span class="ot">=</span> memory[indices,,drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb472-54"><a href="gan.html#cb472-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb472-55"><a href="gan.html#cb472-55" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(batch)){</span>
<span id="cb472-56"><a href="gan.html#cb472-56" aria-hidden="true" tabindex="-1"></a>    target <span class="ot">=</span> batch[i,<span class="dv">6</span>] <span class="co"># Reward.</span></span>
<span id="cb472-57"><a href="gan.html#cb472-57" aria-hidden="true" tabindex="-1"></a>    action <span class="ot">=</span> batch[i,<span class="dv">5</span>] <span class="co"># Action.</span></span>
<span id="cb472-58"><a href="gan.html#cb472-58" aria-hidden="true" tabindex="-1"></a>    state <span class="ot">=</span> <span class="fu">matrix</span>(memory[i, <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>], <span class="at">nrow =</span> 1L)</span>
<span id="cb472-59"><a href="gan.html#cb472-59" aria-hidden="true" tabindex="-1"></a>    next_state <span class="ot">=</span> <span class="fu">matrix</span>(memory[i,<span class="dv">7</span><span class="sc">:</span><span class="dv">10</span>], <span class="at">nrow =</span>1L)</span>
<span id="cb472-60"><a href="gan.html#cb472-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span>batch[i,<span class="dv">11</span>]){ <span class="co"># Not done.</span></span>
<span id="cb472-61"><a href="gan.html#cb472-61" aria-hidden="true" tabindex="-1"></a>      target <span class="ot">=</span> (batch[i,<span class="dv">6</span>] <span class="sc">+</span> gamma <span class="sc">*</span> <span class="fu">predict</span>(model,</span>
<span id="cb472-62"><a href="gan.html#cb472-62" aria-hidden="true" tabindex="-1"></a>                                            <span class="fu">matrix</span>(next_state, <span class="at">nrow =</span> 1L)))[<span class="dv">1</span>,<span class="dv">1</span>]</span>
<span id="cb472-63"><a href="gan.html#cb472-63" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb472-64"><a href="gan.html#cb472-64" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb472-65"><a href="gan.html#cb472-65" aria-hidden="true" tabindex="-1"></a>    target_f <span class="ot">=</span> <span class="fu">predict</span>(model, <span class="fu">matrix</span>(state, <span class="at">nrow =</span> 1L))</span>
<span id="cb472-66"><a href="gan.html#cb472-66" aria-hidden="true" tabindex="-1"></a>    target_f[action<span class="sc">+</span>1L] <span class="ot">=</span> target</span>
<span id="cb472-67"><a href="gan.html#cb472-67" aria-hidden="true" tabindex="-1"></a>    model<span class="sc">$</span><span class="fu">fit</span>(<span class="at">x =</span> state, <span class="at">y =</span> target_f, <span class="at">epochs =</span> 1L, <span class="at">verbose =</span> 0L)</span>
<span id="cb472-68"><a href="gan.html#cb472-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb472-69"><a href="gan.html#cb472-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(epsilon <span class="sc">&gt;</span> epsilon_min){ epsilon <span class="ot">&lt;&lt;-</span> epsilon_decay<span class="sc">*</span>epsilon }</span>
<span id="cb472-70"><a href="gan.html#cb472-70" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb472-71"><a href="gan.html#cb472-71" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb472-72"><a href="gan.html#cb472-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb472-73"><a href="gan.html#cb472-73" aria-hidden="true" tabindex="-1"></a>done <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb472-74"><a href="gan.html#cb472-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb472-75"><a href="gan.html#cb472-75" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(e <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>){</span>
<span id="cb472-76"><a href="gan.html#cb472-76" aria-hidden="true" tabindex="-1"></a>  state <span class="ot">=</span> <span class="fu">unlist</span>(<span class="fu">env_reset</span>(client, env))</span>
<span id="cb472-77"><a href="gan.html#cb472-77" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb472-78"><a href="gan.html#cb472-78" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(time <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">500</span>){</span>
<span id="cb472-79"><a href="gan.html#cb472-79" aria-hidden="true" tabindex="-1"></a>    action <span class="ot">=</span> <span class="fu">act</span>(state)</span>
<span id="cb472-80"><a href="gan.html#cb472-80" aria-hidden="true" tabindex="-1"></a>    response <span class="ot">=</span> <span class="fu">env_step</span>(client, env, <span class="at">action =</span> action)</span>
<span id="cb472-81"><a href="gan.html#cb472-81" aria-hidden="true" tabindex="-1"></a>    done <span class="ot">=</span> <span class="fu">as.integer</span>(response<span class="sc">$</span>done)</span>
<span id="cb472-82"><a href="gan.html#cb472-82" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb472-83"><a href="gan.html#cb472-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span>done){ reward <span class="ot">=</span> response<span class="sc">$</span>reward }</span>
<span id="cb472-84"><a href="gan.html#cb472-84" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>{ reward <span class="ot">=</span> <span class="sc">-</span><span class="dv">10</span> }</span>
<span id="cb472-85"><a href="gan.html#cb472-85" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb472-86"><a href="gan.html#cb472-86" aria-hidden="true" tabindex="-1"></a>    next_state <span class="ot">=</span> <span class="fu">unlist</span>(response<span class="sc">$</span>observation)</span>
<span id="cb472-87"><a href="gan.html#cb472-87" aria-hidden="true" tabindex="-1"></a>    memory <span class="ot">=</span> <span class="fu">remember</span>(memory, state, action, reward, next_state, done)</span>
<span id="cb472-88"><a href="gan.html#cb472-88" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb472-89"><a href="gan.html#cb472-89" aria-hidden="true" tabindex="-1"></a>    state <span class="ot">=</span> next_state</span>
<span id="cb472-90"><a href="gan.html#cb472-90" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(done){</span>
<span id="cb472-91"><a href="gan.html#cb472-91" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"episode"</span>, e<span class="sc">/</span><span class="dv">500</span>, <span class="st">" score: "</span>, time, <span class="st">" eps: "</span>, epsilon, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb472-92"><a href="gan.html#cb472-92" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span>()</span>
<span id="cb472-93"><a href="gan.html#cb472-93" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb472-94"><a href="gan.html#cb472-94" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb472-95"><a href="gan.html#cb472-95" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(counter <span class="sc">&gt;</span> 32L){ <span class="fu">replay</span>(32L, memory, counter<span class="sc">-</span>1L) }</span>
<span id="cb472-96"><a href="gan.html#cb472-96" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb472-97"><a href="gan.html#cb472-97" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="exercises-8" class="section level2" number="8.4">
<h2>
<span class="header-section-number">8.4</span> Exercises<a class="anchor" aria-label="anchor" href="#exercises-8"><i class="fas fa-link"></i></a>
</h2>
  <hr>
<strong><span style="color: #0011AA; font-size:18px;">1. Task</span></strong><br><p>Read section <a href="gan.html#VAE">8.1.3</a> on variational autoencoders and try to transfer the examples with MNIST to our flower data set.</p>
  <details><summary><strong><span style="color: #0011AA; font-size:18px;">Solution</span></strong>
    </summary><p>
</p>
<p>Split the data:</p>
<div class="sourceCode" id="cb473"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tfprobability">tfprobability</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/set_random_seed.html">set_random_seed</a></span><span class="op">(</span><span class="fl">321L</span>, disable_gpu <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># Already sets R's random seed.</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="fu">EcoData</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/EcoData/man/dataset_flower.html">dataset_flower</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">test</span> <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">test</span><span class="op">/</span><span class="fl">255</span></span>
<span><span class="va">train</span> <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">train</span><span class="op">/</span><span class="fl">255</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span></code></pre></div>
<p>Build the variational autoencoder:</p>
<div class="sourceCode" id="cb474"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">encoded</span> <span class="op">=</span> <span class="fl">10L</span></span>
<span><span class="va">prior</span> <span class="op">=</span> <span class="va">tfp</span><span class="op">$</span><span class="va">distributions</span><span class="op">$</span><span class="fu">Independent</span><span class="op">(</span></span>
<span>  <span class="va">tfp</span><span class="op">$</span><span class="va">distributions</span><span class="op">$</span><span class="fu">Normal</span><span class="op">(</span>loc<span class="op">=</span><span class="va">tf</span><span class="op">$</span><span class="fu">zeros</span><span class="op">(</span><span class="va">encoded</span><span class="op">)</span>, scale <span class="op">=</span> <span class="fl">1.</span><span class="op">)</span>,</span>
<span>  reinterpreted_batch_ndims <span class="op">=</span> <span class="fl">1L</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">down_size_model</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">keras</span><span class="op">$</span><span class="va">models</span><span class="op">$</span><span class="fu">Sequential</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  <span class="va">tf</span><span class="op">$</span><span class="va">keras</span><span class="op">$</span><span class="va">layers</span><span class="op">$</span><span class="fu">InputLayer</span><span class="op">(</span>input_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">80L</span>, <span class="fl">80L</span>, <span class="fl">3L</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="va">tf</span><span class="op">$</span><span class="va">keras</span><span class="op">$</span><span class="va">layers</span><span class="op">$</span><span class="fu">Conv2D</span><span class="op">(</span>filters <span class="op">=</span> <span class="fl">32L</span>, activation <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">nn</span><span class="op">$</span><span class="va">leaky_relu</span>,</span>
<span>                         kernel_size <span class="op">=</span> <span class="fl">5L</span>, strides <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span>,</span>
<span>  <span class="va">tf</span><span class="op">$</span><span class="va">keras</span><span class="op">$</span><span class="va">layers</span><span class="op">$</span><span class="fu">Conv2D</span><span class="op">(</span>filters <span class="op">=</span> <span class="fl">32L</span>, activation <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">nn</span><span class="op">$</span><span class="va">leaky_relu</span>,</span>
<span>                         kernel_size <span class="op">=</span> <span class="fl">5L</span>, strides <span class="op">=</span> <span class="fl">2L</span><span class="op">)</span>,</span>
<span>  <span class="va">tf</span><span class="op">$</span><span class="va">keras</span><span class="op">$</span><span class="va">layers</span><span class="op">$</span><span class="fu">Conv2D</span><span class="op">(</span>filters <span class="op">=</span> <span class="fl">64L</span>, activation <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">nn</span><span class="op">$</span><span class="va">leaky_relu</span>,</span>
<span>                         kernel_size <span class="op">=</span> <span class="fl">5L</span>, strides <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span>,</span>
<span>  <span class="va">tf</span><span class="op">$</span><span class="va">keras</span><span class="op">$</span><span class="va">layers</span><span class="op">$</span><span class="fu">Conv2D</span><span class="op">(</span>filters <span class="op">=</span> <span class="fl">64L</span>, activation <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">nn</span><span class="op">$</span><span class="va">leaky_relu</span>,</span>
<span>                         kernel_size <span class="op">=</span> <span class="fl">5L</span>, strides <span class="op">=</span> <span class="fl">2L</span><span class="op">)</span>,</span>
<span>  <span class="va">tf</span><span class="op">$</span><span class="va">keras</span><span class="op">$</span><span class="va">layers</span><span class="op">$</span><span class="fu">Conv2D</span><span class="op">(</span>filters <span class="op">=</span> <span class="fl">128L</span>, activation <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">nn</span><span class="op">$</span><span class="va">leaky_relu</span>,</span>
<span>                         kernel_size <span class="op">=</span> <span class="fl">7L</span>, strides <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span>,</span>
<span>  <span class="va">tf</span><span class="op">$</span><span class="va">keras</span><span class="op">$</span><span class="va">layers</span><span class="op">$</span><span class="fu">Flatten</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="va">tf</span><span class="op">$</span><span class="va">keras</span><span class="op">$</span><span class="va">layers</span><span class="op">$</span><span class="fu">Dense</span><span class="op">(</span>units <span class="op">=</span> <span class="va">tfp</span><span class="op">$</span><span class="va">layers</span><span class="op">$</span><span class="va">MultivariateNormalTriL</span><span class="op">$</span><span class="fu">params_size</span><span class="op">(</span><span class="va">encoded</span><span class="op">)</span>,</span>
<span>                        activation <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span>,</span>
<span>  <span class="va">tfp</span><span class="op">$</span><span class="va">layers</span><span class="op">$</span><span class="fu">MultivariateNormalTriL</span><span class="op">(</span></span>
<span>    <span class="va">encoded</span>, </span>
<span>    activity_regularizer <span class="op">=</span> <span class="va">tfp</span><span class="op">$</span><span class="va">layers</span><span class="op">$</span><span class="fu">KLDivergenceRegularizer</span><span class="op">(</span><span class="va">prior</span>, weight <span class="op">=</span> <span class="fl">0.0002</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">up_size_model</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">keras</span><span class="op">$</span><span class="va">models</span><span class="op">$</span><span class="fu">Sequential</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  <span class="va">tf</span><span class="op">$</span><span class="va">keras</span><span class="op">$</span><span class="va">layers</span><span class="op">$</span><span class="fu">InputLayer</span><span class="op">(</span>input_shape <span class="op">=</span> <span class="va">encoded</span><span class="op">)</span>,</span>
<span>  <span class="va">tf</span><span class="op">$</span><span class="va">keras</span><span class="op">$</span><span class="va">layers</span><span class="op">$</span><span class="fu">Dense</span><span class="op">(</span>units <span class="op">=</span> <span class="fl">8192L</span>, activation <span class="op">=</span> <span class="st">"relu"</span><span class="op">)</span>,</span>
<span>  <span class="va">tf</span><span class="op">$</span><span class="va">keras</span><span class="op">$</span><span class="va">layers</span><span class="op">$</span><span class="fu">Reshape</span><span class="op">(</span>target_shape <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">8L</span>, <span class="fl">8L</span>, <span class="fl">128L</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="va">tf</span><span class="op">$</span><span class="va">keras</span><span class="op">$</span><span class="va">layers</span><span class="op">$</span><span class="fu">Conv2DTranspose</span><span class="op">(</span>filters <span class="op">=</span> <span class="fl">128L</span>, kernel_size <span class="op">=</span> <span class="fl">7L</span>,</span>
<span>                                  activation <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">nn</span><span class="op">$</span><span class="va">leaky_relu</span>, strides <span class="op">=</span> <span class="fl">1L</span>,</span>
<span>                                  use_bias <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="va">tf</span><span class="op">$</span><span class="va">keras</span><span class="op">$</span><span class="va">layers</span><span class="op">$</span><span class="fu">Conv2DTranspose</span><span class="op">(</span>filters <span class="op">=</span> <span class="fl">64L</span>, kernel_size <span class="op">=</span> <span class="fl">5L</span>,</span>
<span>                                  activation <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">nn</span><span class="op">$</span><span class="va">leaky_relu</span>, strides <span class="op">=</span> <span class="fl">2L</span>,</span>
<span>                                  use_bias <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="va">tf</span><span class="op">$</span><span class="va">keras</span><span class="op">$</span><span class="va">layers</span><span class="op">$</span><span class="fu">Conv2DTranspose</span><span class="op">(</span>filters <span class="op">=</span> <span class="fl">64L</span>, kernel_size <span class="op">=</span> <span class="fl">5L</span>,</span>
<span>                                  activation <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">nn</span><span class="op">$</span><span class="va">leaky_relu</span>, strides <span class="op">=</span> <span class="fl">1L</span>,</span>
<span>                                  use_bias <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="va">tf</span><span class="op">$</span><span class="va">keras</span><span class="op">$</span><span class="va">layers</span><span class="op">$</span><span class="fu">Conv2DTranspose</span><span class="op">(</span>filters <span class="op">=</span> <span class="fl">32L</span>, kernel_size <span class="op">=</span> <span class="fl">5L</span>,</span>
<span>                                  activation <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">nn</span><span class="op">$</span><span class="va">leaky_relu</span>, strides <span class="op">=</span> <span class="fl">2L</span>,</span>
<span>                                  use_bias <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="va">tf</span><span class="op">$</span><span class="va">keras</span><span class="op">$</span><span class="va">layers</span><span class="op">$</span><span class="fu">Conv2DTranspose</span><span class="op">(</span>filters <span class="op">=</span> <span class="fl">32L</span>, kernel_size <span class="op">=</span> <span class="fl">5L</span>,</span>
<span>                                  activation <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">nn</span><span class="op">$</span><span class="va">leaky_relu</span>, strides <span class="op">=</span> <span class="fl">1L</span>,</span>
<span>                                  use_bias <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="va">tf</span><span class="op">$</span><span class="va">keras</span><span class="op">$</span><span class="va">layers</span><span class="op">$</span><span class="fu">Conv2DTranspose</span><span class="op">(</span>filters <span class="op">=</span> <span class="fl">3L</span>, kernel_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4L</span>, <span class="fl">4L</span><span class="op">)</span>,</span>
<span>                                  activation <span class="op">=</span> <span class="st">"sigmoid"</span>, strides <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1L</span>, <span class="fl">1L</span><span class="op">)</span>,</span>
<span>                                  use_bias <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">VAE</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">keras</span><span class="op">$</span><span class="va">models</span><span class="op">$</span><span class="fu">Model</span><span class="op">(</span>inputs <span class="op">=</span> <span class="va">down_size_model</span><span class="op">$</span><span class="va">inputs</span>, </span>
<span>                            outputs <span class="op">=</span> <span class="fu">up_size_model</span><span class="op">(</span><span class="va">down_size_model</span><span class="op">$</span><span class="va">outputs</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">VAE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Model: "model_1"</span></span>
<span><span class="co">#&gt; __________________________________________________________________________________________</span></span>
<span><span class="co">#&gt;  Layer (type)                           Output Shape                        Param #       </span></span>
<span><span class="co">#&gt; ==========================================================================================</span></span>
<span><span class="co">#&gt;  input_1 (InputLayer)                   [(None, 80, 80, 3)]                 0             </span></span>
<span><span class="co">#&gt;  conv2d_9 (Conv2D)                      (None, 76, 76, 32)                  2432          </span></span>
<span><span class="co">#&gt;  conv2d_10 (Conv2D)                     (None, 36, 36, 32)                  25632         </span></span>
<span><span class="co">#&gt;  conv2d_11 (Conv2D)                     (None, 32, 32, 64)                  51264         </span></span>
<span><span class="co">#&gt;  conv2d_12 (Conv2D)                     (None, 14, 14, 64)                  102464        </span></span>
<span><span class="co">#&gt;  conv2d_13 (Conv2D)                     (None, 8, 8, 128)                   401536        </span></span>
<span><span class="co">#&gt;  flatten_3 (Flatten)                    (None, 8192)                        0             </span></span>
<span><span class="co">#&gt;  dense_18 (Dense)                       (None, 65)                          532545        </span></span>
<span><span class="co">#&gt;  multivariate_normal_tri_l (Multivariat  ((None, 10),                       0             </span></span>
<span><span class="co">#&gt;  eNormalTriL)                            (None, 10))                                      </span></span>
<span><span class="co">#&gt;  sequential_11 (Sequential)             (None, 80, 80, 3)                   1278464       </span></span>
<span><span class="co">#&gt; ==========================================================================================</span></span>
<span><span class="co">#&gt; Total params: 2,394,337</span></span>
<span><span class="co">#&gt; Trainable params: 2,394,337</span></span>
<span><span class="co">#&gt; Non-trainable params: 0</span></span>
<span><span class="co">#&gt; __________________________________________________________________________________________</span></span></code></pre></div>
<p>Compile and train model:</p>
<div class="sourceCode" id="cb475"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">be</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">true</span>, <span class="va">pred</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">tf</span><span class="op">$</span><span class="va">losses</span><span class="op">$</span><span class="fu">binary_crossentropy</span><span class="op">(</span><span class="va">true</span>, <span class="va">pred</span><span class="op">)</span> <span class="op">*</span> <span class="fl">80.0</span> <span class="op">*</span> <span class="fl">80.0</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">VAE</span><span class="op">$</span><span class="fu">compile</span><span class="op">(</span>loss <span class="op">=</span> <span class="va">be</span>,</span>
<span>            optimizer <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">keras</span><span class="op">$</span><span class="va">optimizers</span><span class="op">$</span><span class="fu">Adamax</span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">0.0003</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">VAE</span><span class="op">$</span><span class="fu">fit</span><span class="op">(</span>x <span class="op">=</span> <span class="va">train</span>, y <span class="op">=</span> <span class="va">train</span>, epochs <span class="op">=</span> <span class="fl">50L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span>, batch_size <span class="op">=</span> <span class="fl">20L</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;keras.callbacks.History object at 0x7fe56aba9b90&gt;</span></span>
<span></span>
<span><span class="va">dist</span> <span class="op">=</span> <span class="fu">down_size_model</span><span class="op">(</span><span class="va">train</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,,,<span class="op">]</span><span class="op">)</span></span>
<span><span class="va">images</span> <span class="op">=</span> <span class="fu">up_size_model</span><span class="op">(</span> <span class="va">dist</span><span class="op">$</span><span class="fu">sample</span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="op">]</span> <span class="op">)</span></span>
<span></span>
<span><span class="va">oldpar</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">)</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/rescale.html">rescale</a></span><span class="op">(</span><span class="va">images</span><span class="op">[</span><span class="fl">1</span>,,,<span class="op">]</span><span class="op">$</span><span class="fu">numpy</span><span class="op">(</span><span class="op">)</span>, to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">255</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/image_to_array.html">image_to_array</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">`/`</span><span class="op">(</span><span class="va">.</span>, <span class="fl">255</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/grDevices/as.raster.html">as.raster</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/rescale.html">rescale</a></span><span class="op">(</span><span class="va">images</span><span class="op">[</span><span class="fl">2</span>,,,<span class="op">]</span><span class="op">$</span><span class="fu">numpy</span><span class="op">(</span><span class="op">)</span>, to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">255</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/image_to_array.html">image_to_array</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">`/`</span><span class="op">(</span><span class="va">.</span>, <span class="fl">255</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/grDevices/as.raster.html">as.raster</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/rescale.html">rescale</a></span><span class="op">(</span><span class="va">images</span><span class="op">[</span><span class="fl">3</span>,,,<span class="op">]</span><span class="op">$</span><span class="fu">numpy</span><span class="op">(</span><span class="op">)</span>, to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">255</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/image_to_array.html">image_to_array</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">`/`</span><span class="op">(</span><span class="va">.</span>, <span class="fl">255</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/grDevices/as.raster.html">as.raster</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="09-GAN_files/figure-html/chunk_chapter7_task_2__VAEflower-1.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb476"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span><span class="va">oldpar</span><span class="op">)</span></span></code></pre></div>
    
  </details><br><hr>
<strong><span style="color: #0011AA; font-size:18px;">2. Task</span></strong><br><p>Go through the R examples on generative adversarial networks (<a href="gan.html#GANS">8.2</a>) and compare the flower example with the MNIST example - where are the differences - and why?</p>
  <details><summary><strong><span style="color: #0011AA; font-size:18px;">Solution</span></strong>
    </summary><p>
</p>
<p>The MNIST example uses a “simple” deep neural network which is sufficient for a classification that easy. The flower example uses a much more expensive convolutional neural network to classify the images.</p>
    
  </details><br><hr>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="interpretation.html"><span class="header-section-number">7</span> Interpretation and Causality With Machine Learning</a></div>
<div class="next"><a href="datasets.html"><span class="header-section-number">9</span> Data sets</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#gan"><span class="header-section-number">8</span> Generative Modeling and Reinforcement Learning</a></li>
<li>
<a class="nav-link" href="#autoencoder"><span class="header-section-number">8.1</span> Autoencoder</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#autoencoder---deep-neural-network-mnist"><span class="header-section-number">8.1.1</span> Autoencoder - Deep Neural Network MNIST</a></li>
<li><a class="nav-link" href="#autoencoder---mnist-convolutional-neural-networks"><span class="header-section-number">8.1.2</span> Autoencoder - MNIST Convolutional Neural Networks</a></li>
<li><a class="nav-link" href="#VAE"><span class="header-section-number">8.1.3</span> Variational Autoencoder (VAE)</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#GANS"><span class="header-section-number">8.2</span> Generative Adversarial Networks (GANs)</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#mnist---generative-adversarial-networks-based-on-deep-neural-networks"><span class="header-section-number">8.2.1</span> MNIST - Generative Adversarial Networks Based on Deep Neural Networks</a></li>
<li><a class="nav-link" href="#flower---gan"><span class="header-section-number">8.2.2</span> Flower - GAN</a></li>
</ul>
</li>
<li><a class="nav-link" href="#reinforcement-learning"><span class="header-section-number">8.3</span> Reinforcement learning</a></li>
<li><a class="nav-link" href="#exercises-8"><span class="header-section-number">8.4</span> Exercises</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/TheoreticalEcology/machinelearning/blob/master/book/09-GAN.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/TheoreticalEcology/machinelearning/edit/master/book/09-GAN.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Machine Learning and AI in TensorFlow and R</strong>" was written by Maximilian Pichler and Florian Hartig. It was last built on 2022-07-11.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
