<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>7 Generative Modeling and Reinforcement Learning | Machine Learning and AI in TensorFlow and R</title>
  <meta name="description" content="7 Generative Modeling and Reinforcement Learning | Machine Learning and AI in TensorFlow and R" />
  <meta name="generator" content="bookdown 0.24 and GitBook 2.6.7" />

  <meta property="og:title" content="7 Generative Modeling and Reinforcement Learning | Machine Learning and AI in TensorFlow and R" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="7 Generative Modeling and Reinforcement Learning | Machine Learning and AI in TensorFlow and R" />
  <meta name="github-repo" content="rstudio/bookdown-demo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="7 Generative Modeling and Reinforcement Learning | Machine Learning and AI in TensorFlow and R" />
  
  <meta name="twitter:description" content="7 Generative Modeling and Reinforcement Learning | Machine Learning and AI in TensorFlow and R" />
  

<meta name="author" content="Maximilian Pichler and Florian Hartig" />


<meta name="date" content="2021-11-19" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="interpretation.html"/>
<link rel="next" href="datasets.html"/>
<script src="libs/header-attrs-2.11/header-attrs.js"></script>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>
<script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script>
<script src="libs/viz-1.8.2/viz.js"></script>
<link href="libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet" />
<script src="libs/grViz-binding-1.0.6.1/grViz.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    background-color: #ffffff;
    color: #a0a0a0;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #a0a0a0;  padding-left: 4px; }
div.sourceCode
  { color: #1f1c1b; background-color: #ffffff; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span { color: #1f1c1b; } /* Normal */
code span.al { color: #bf0303; background-color: #f7e6e6; font-weight: bold; } /* Alert */
code span.an { color: #ca60ca; } /* Annotation */
code span.at { color: #0057ae; } /* Attribute */
code span.bn { color: #b08000; } /* BaseN */
code span.bu { color: #644a9b; font-weight: bold; } /* BuiltIn */
code span.cf { color: #1f1c1b; font-weight: bold; } /* ControlFlow */
code span.ch { color: #924c9d; } /* Char */
code span.cn { color: #aa5500; } /* Constant */
code span.co { color: #898887; } /* Comment */
code span.cv { color: #0095ff; } /* CommentVar */
code span.do { color: #607880; } /* Documentation */
code span.dt { color: #0057ae; } /* DataType */
code span.dv { color: #b08000; } /* DecVal */
code span.er { color: #bf0303; text-decoration: underline; } /* Error */
code span.ex { color: #0095ff; font-weight: bold; } /* Extension */
code span.fl { color: #b08000; } /* Float */
code span.fu { color: #644a9b; } /* Function */
code span.im { color: #ff5500; } /* Import */
code span.in { color: #b08000; } /* Information */
code span.kw { color: #1f1c1b; font-weight: bold; } /* Keyword */
code span.op { color: #1f1c1b; } /* Operator */
code span.ot { color: #006e28; } /* Other */
code span.pp { color: #006e28; } /* Preprocessor */
code span.re { color: #0057ae; background-color: #e0e9f8; } /* RegionMarker */
code span.sc { color: #3daee9; } /* SpecialChar */
code span.ss { color: #ff5500; } /* SpecialString */
code span.st { color: #bf0303; } /* String */
code span.va { color: #0057ae; } /* Variable */
code span.vs { color: #bf0303; } /* VerbatimString */
code span.wa { color: #bf0303; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Prerequisites</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#r-system"><i class="fa fa-check"></i><b>1.1</b> R System</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#tensorflow-and-keras"><i class="fa fa-check"></i><b>1.2</b> TensorFlow and Keras</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#torch-for-r"><i class="fa fa-check"></i><b>1.3</b> Torch for R</a></li>
<li class="chapter" data-level="1.4" data-path="index.html"><a href="index.html#ecodata"><i class="fa fa-check"></i><b>1.4</b> EcoData</a></li>
<li class="chapter" data-level="1.5" data-path="index.html"><a href="index.html#further-used-libraries"><i class="fa fa-check"></i><b>1.5</b> Further Used Libraries</a></li>
<li class="chapter" data-level="1.6" data-path="index.html"><a href="index.html#linuxunix-systems-have-to-fulfill-some-durther-dependencies"><i class="fa fa-check"></i><b>1.6</b> Linux/UNIX systems have to fulfill some durther dependencies</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="reminder.html"><a href="reminder.html"><i class="fa fa-check"></i><b>2</b> Reminders About Basic Operations in R</a>
<ul>
<li class="chapter" data-level="2.1" data-path="reminder.html"><a href="reminder.html#your-r-system"><i class="fa fa-check"></i><b>2.1</b> Your R System</a></li>
<li class="chapter" data-level="2.2" data-path="reminder.html"><a href="reminder.html#data-types-in-r"><i class="fa fa-check"></i><b>2.2</b> Data types in R</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="reminder.html"><a href="reminder.html#test-your-knowledge"><i class="fa fa-check"></i><b>2.2.1</b> Test Your Knowledge</a></li>
<li class="chapter" data-level="2.2.2" data-path="reminder.html"><a href="reminder.html#iris-data"><i class="fa fa-check"></i><b>2.2.2</b> Iris Data</a></li>
<li class="chapter" data-level="2.2.3" data-path="reminder.html"><a href="reminder.html#dynamic-typing"><i class="fa fa-check"></i><b>2.2.3</b> Dynamic typing</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="reminder.html"><a href="reminder.html#data-selection-slicing-and-subsetting"><i class="fa fa-check"></i><b>2.3</b> Data selection, Slicing and Subsetting</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="reminder.html"><a href="reminder.html#subsetting-and-slicing-for-single-data-types"><i class="fa fa-check"></i><b>2.3.1</b> Subsetting and Slicing for Single Data Types</a></li>
<li class="chapter" data-level="2.3.2" data-path="reminder.html"><a href="reminder.html#logic-and-slicing"><i class="fa fa-check"></i><b>2.3.2</b> Logic and Slicing</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="reminder.html"><a href="reminder.html#applying-functions-and-aggregates-across-a-data-set"><i class="fa fa-check"></i><b>2.4</b> Applying Functions and Aggregates Across a Data set</a>
<ul>
<li class="chapter" data-level="2.4.1" data-path="reminder.html"><a href="reminder.html#functions"><i class="fa fa-check"></i><b>2.4.1</b> Functions</a></li>
<li class="chapter" data-level="2.4.2" data-path="reminder.html"><a href="reminder.html#the-apply-function"><i class="fa fa-check"></i><b>2.4.2</b> The apply() Function</a></li>
<li class="chapter" data-level="2.4.3" data-path="reminder.html"><a href="reminder.html#the-aggregate-function"><i class="fa fa-check"></i><b>2.4.3</b> The aggregate() Function</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="reminder.html"><a href="reminder.html#plotting"><i class="fa fa-check"></i><b>2.5</b> Plotting</a></li>
<li class="chapter" data-level="2.6" data-path="reminder.html"><a href="reminder.html#additional-resources"><i class="fa fa-check"></i><b>2.6</b> Additional Resources</a>
<ul>
<li class="chapter" data-level="2.6.1" data-path="reminder.html"><a href="reminder.html#books"><i class="fa fa-check"></i><b>2.6.1</b> Books</a></li>
<li class="chapter" data-level="2.6.2" data-path="reminder.html"><a href="reminder.html#instructional-videos"><i class="fa fa-check"></i><b>2.6.2</b> Instructional videos</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>3</b> Introduction to Machine Learning</a>
<ul>
<li class="chapter" data-level="3.1" data-path="introduction.html"><a href="introduction.html#unsupervised-learning"><i class="fa fa-check"></i><b>3.1</b> Unsupervised Learning</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="introduction.html"><a href="introduction.html#hierarchical-clustering"><i class="fa fa-check"></i><b>3.1.1</b> Hierarchical Clustering</a></li>
<li class="chapter" data-level="3.1.2" data-path="introduction.html"><a href="introduction.html#k-means-clustering"><i class="fa fa-check"></i><b>3.1.2</b> K-means Clustering</a></li>
<li class="chapter" data-level="3.1.3" data-path="introduction.html"><a href="introduction.html#density-based-clustering"><i class="fa fa-check"></i><b>3.1.3</b> Density-based Clustering</a></li>
<li class="chapter" data-level="3.1.4" data-path="introduction.html"><a href="introduction.html#model-based-clustering"><i class="fa fa-check"></i><b>3.1.4</b> Model-based Clustering</a></li>
<li class="chapter" data-level="3.1.5" data-path="introduction.html"><a href="introduction.html#ordination"><i class="fa fa-check"></i><b>3.1.5</b> Ordination</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="introduction.html"><a href="introduction.html#supervised-learning-regression-and-classification"><i class="fa fa-check"></i><b>3.2</b> Supervised Learning: Regression and Classification</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="introduction.html"><a href="introduction.html#supervised-regression-using-random-forest"><i class="fa fa-check"></i><b>3.2.1</b> Supervised Regression Using Random Forest</a></li>
<li class="chapter" data-level="3.2.2" data-path="introduction.html"><a href="introduction.html#supervised-classification-using-random-forest"><i class="fa fa-check"></i><b>3.2.2</b> Supervised Classification Using Random Forest</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="introduction.html"><a href="introduction.html#basicMath"><i class="fa fa-check"></i><b>3.3</b> Small Introduction Into the Underlying Mathematical Concepts of all Following Lessons - Optional</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="introduction.html"><a href="introduction.html#caveat-about-learning-rates-and-activation-functions"><i class="fa fa-check"></i><b>3.3.1</b> Caveat About Learning Rates and Activation Functions</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="introduction.html"><a href="introduction.html#introduction-to-tensorflow"><i class="fa fa-check"></i><b>3.4</b> Introduction to TensorFlow</a>
<ul>
<li class="chapter" data-level="3.4.1" data-path="introduction.html"><a href="introduction.html#tensorflow-data-containers"><i class="fa fa-check"></i><b>3.4.1</b> TensorFlow Data Containers</a></li>
<li class="chapter" data-level="3.4.2" data-path="introduction.html"><a href="introduction.html#basic-operations"><i class="fa fa-check"></i><b>3.4.2</b> Basic Operations</a></li>
<li class="chapter" data-level="3.4.3" data-path="introduction.html"><a href="introduction.html#tensorflow-data-types---good-practice-with-r-tensorflow"><i class="fa fa-check"></i><b>3.4.3</b> TensorFlow Data Types - Good Practice With R-TensorFlow</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="introduction.html"><a href="introduction.html#introduction-to-pytorch"><i class="fa fa-check"></i><b>3.5</b> Introduction to PyTorch</a>
<ul>
<li class="chapter" data-level="3.5.1" data-path="introduction.html"><a href="introduction.html#pytorch-data-containers"><i class="fa fa-check"></i><b>3.5.1</b> PyTorch Data Containers</a></li>
<li class="chapter" data-level="3.5.2" data-path="introduction.html"><a href="introduction.html#basic-operations-1"><i class="fa fa-check"></i><b>3.5.2</b> Basic Operations</a></li>
<li class="chapter" data-level="3.5.3" data-path="introduction.html"><a href="introduction.html#torch-data-types---good-practice-with-r-torch"><i class="fa fa-check"></i><b>3.5.3</b> Torch Data Types - Good Practice With R-Torch</a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="introduction.html"><a href="introduction.html#first-steps-with-the-keras-framework"><i class="fa fa-check"></i><b>3.6</b> First Steps With the Keras Framework</a>
<ul>
<li class="chapter" data-level="3.6.1" data-path="introduction.html"><a href="introduction.html#example-workflow-in-keras"><i class="fa fa-check"></i><b>3.6.1</b> Example Workflow in Keras</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="fundamental.html"><a href="fundamental.html"><i class="fa fa-check"></i><b>4</b> Fundamental Principles and Techniques</a>
<ul>
<li class="chapter" data-level="4.1" data-path="fundamental.html"><a href="fundamental.html#machine-learning-principles"><i class="fa fa-check"></i><b>4.1</b> Machine Learning Principles</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="fundamental.html"><a href="fundamental.html#optimization"><i class="fa fa-check"></i><b>4.1.1</b> Optimization</a></li>
<li class="chapter" data-level="4.1.2" data-path="fundamental.html"><a href="fundamental.html#advanced-optimization-example"><i class="fa fa-check"></i><b>4.1.2</b> Advanced Optimization Example</a></li>
<li class="chapter" data-level="4.1.3" data-path="fundamental.html"><a href="fundamental.html#regularization"><i class="fa fa-check"></i><b>4.1.3</b> Regularization</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="fundamental.html"><a href="fundamental.html#artificial-neural-networks"><i class="fa fa-check"></i><b>4.2</b> Artificial Neural Networks</a></li>
<li class="chapter" data-level="4.3" data-path="fundamental.html"><a href="fundamental.html#tree-based-machine-learning-algorithms"><i class="fa fa-check"></i><b>4.3</b> Tree-based Machine Learning Algorithms</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="fundamental.html"><a href="fundamental.html#classification-and-regression-trees"><i class="fa fa-check"></i><b>4.3.1</b> Classification and Regression Trees</a></li>
<li class="chapter" data-level="4.3.2" data-path="fundamental.html"><a href="fundamental.html#random-forest"><i class="fa fa-check"></i><b>4.3.2</b> Random Forest</a></li>
<li class="chapter" data-level="4.3.3" data-path="fundamental.html"><a href="fundamental.html#boosted-regression-trees"><i class="fa fa-check"></i><b>4.3.3</b> Boosted Regression Trees</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="fundamental.html"><a href="fundamental.html#distance-based-algorithms"><i class="fa fa-check"></i><b>4.4</b> Distance-based Algorithms</a>
<ul>
<li class="chapter" data-level="4.4.1" data-path="fundamental.html"><a href="fundamental.html#k-nearest-neighbor"><i class="fa fa-check"></i><b>4.4.1</b> K-Nearest-Neighbor</a></li>
<li class="chapter" data-level="4.4.2" data-path="fundamental.html"><a href="fundamental.html#support-vector-machines-svms"><i class="fa fa-check"></i><b>4.4.2</b> Support Vector Machines (SVMs)</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="fundamental.html"><a href="fundamental.html#the-standard-machine-learning-pipeline-at-the-eexample-of-the-titanic-data-set"><i class="fa fa-check"></i><b>4.5</b> The Standard Machine Learning Pipeline at the Eexample of the Titanic Data set</a>
<ul>
<li class="chapter" data-level="4.5.1" data-path="fundamental.html"><a href="fundamental.html#data-cleaning"><i class="fa fa-check"></i><b>4.5.1</b> Data Cleaning</a></li>
<li class="chapter" data-level="4.5.2" data-path="fundamental.html"><a href="fundamental.html#preprocessing-and-feature-selection"><i class="fa fa-check"></i><b>4.5.2</b> Preprocessing and Feature Selection</a></li>
<li class="chapter" data-level="4.5.3" data-path="fundamental.html"><a href="fundamental.html#split-data-for-training-and-testing"><i class="fa fa-check"></i><b>4.5.3</b> Split Data for Training and Testing</a></li>
<li class="chapter" data-level="4.5.4" data-path="fundamental.html"><a href="fundamental.html#model-fitting"><i class="fa fa-check"></i><b>4.5.4</b> Model Fitting</a></li>
<li class="chapter" data-level="4.5.5" data-path="fundamental.html"><a href="fundamental.html#model-evaluation"><i class="fa fa-check"></i><b>4.5.5</b> Model Evaluation</a></li>
<li class="chapter" data-level="4.5.6" data-path="fundamental.html"><a href="fundamental.html#predictions-and-submission"><i class="fa fa-check"></i><b>4.5.6</b> Predictions and Submission</a></li>
</ul></li>
<li class="chapter" data-level="4.6" data-path="fundamental.html"><a href="fundamental.html#mlr"><i class="fa fa-check"></i><b>4.6</b> Bonus - Machine Learning Pipelines with mlr3</a>
<ul>
<li class="chapter" data-level="4.6.1" data-path="fundamental.html"><a href="fundamental.html#mlr3---the-basic-workflow"><i class="fa fa-check"></i><b>4.6.1</b> mlr3 - The Basic Workflow</a></li>
<li class="chapter" data-level="4.6.2" data-path="fundamental.html"><a href="fundamental.html#mlr3---hyperparameter-tuning"><i class="fa fa-check"></i><b>4.6.2</b> mlr3 - Hyperparameter Tuning</a></li>
<li class="chapter" data-level="4.6.3" data-path="fundamental.html"><a href="fundamental.html#mlr3---hyperparameter-tuning-with-oversampling"><i class="fa fa-check"></i><b>4.6.3</b> mlr3 - Hyperparameter Tuning with Oversampling</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="deep.html"><a href="deep.html"><i class="fa fa-check"></i><b>5</b> Deep Learning</a>
<ul>
<li class="chapter" data-level="5.1" data-path="deep.html"><a href="deep.html#network-architectures"><i class="fa fa-check"></i><b>5.1</b> Network Architectures</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="deep.html"><a href="deep.html#deep-neural-networks-dnns"><i class="fa fa-check"></i><b>5.1.1</b> Deep Neural Networks (DNNs)</a></li>
<li class="chapter" data-level="5.1.2" data-path="deep.html"><a href="deep.html#convolutional-neural-networks-cnns"><i class="fa fa-check"></i><b>5.1.2</b> Convolutional Neural Networks (CNNs)</a></li>
<li class="chapter" data-level="5.1.3" data-path="deep.html"><a href="deep.html#recurrent-neural-networks-rnns"><i class="fa fa-check"></i><b>5.1.3</b> Recurrent Neural Networks (RNNs)</a></li>
<li class="chapter" data-level="5.1.4" data-path="deep.html"><a href="deep.html#natural-language-processing-nlp"><i class="fa fa-check"></i><b>5.1.4</b> Natural Language Processing (NLP)</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="deep.html"><a href="deep.html#case-study-dropout-and-early-stopping-in-a-deep-neural-network"><i class="fa fa-check"></i><b>5.2</b> Case Study: Dropout and Early Stopping in a Deep Neural Network</a></li>
<li class="chapter" data-level="5.3" data-path="deep.html"><a href="deep.html#case-study-fitting-a-convolutional-neural-network-on-mnist"><i class="fa fa-check"></i><b>5.3</b> Case Study: Fitting a Convolutional Neural Network on MNIST</a></li>
<li class="chapter" data-level="5.4" data-path="deep.html"><a href="deep.html#advanced-training-techniques"><i class="fa fa-check"></i><b>5.4</b> Advanced Training Techniques</a>
<ul>
<li class="chapter" data-level="5.4.1" data-path="deep.html"><a href="deep.html#data-augmentation"><i class="fa fa-check"></i><b>5.4.1</b> Data Augmentation</a></li>
<li class="chapter" data-level="5.4.2" data-path="deep.html"><a href="deep.html#transfer"><i class="fa fa-check"></i><b>5.4.2</b> Transfer Learning</a></li>
<li class="chapter" data-level="5.4.3" data-path="deep.html"><a href="deep.html#influence-of-batch-size-and-learning-rate"><i class="fa fa-check"></i><b>5.4.3</b> Influence of Batch Size and Learning Rate</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="interpretation.html"><a href="interpretation.html"><i class="fa fa-check"></i><b>6</b> Interpretation and Causality With Machine Learning</a>
<ul>
<li class="chapter" data-level="6.1" data-path="interpretation.html"><a href="interpretation.html#explainable-ai"><i class="fa fa-check"></i><b>6.1</b> Explainable AI</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="interpretation.html"><a href="interpretation.html#a-practical-example"><i class="fa fa-check"></i><b>6.1.1</b> A Practical Example</a></li>
<li class="chapter" data-level="6.1.2" data-path="interpretation.html"><a href="interpretation.html#feature-importance"><i class="fa fa-check"></i><b>6.1.2</b> Feature Importance</a></li>
<li class="chapter" data-level="6.1.3" data-path="interpretation.html"><a href="interpretation.html#partial-dependencies"><i class="fa fa-check"></i><b>6.1.3</b> Partial Dependencies</a></li>
<li class="chapter" data-level="6.1.4" data-path="interpretation.html"><a href="interpretation.html#accumulated-local-effects"><i class="fa fa-check"></i><b>6.1.4</b> Accumulated Local Effects</a></li>
<li class="chapter" data-level="6.1.5" data-path="interpretation.html"><a href="interpretation.html#friedmans-h-statistic"><i class="fa fa-check"></i><b>6.1.5</b> Friedman’s H-statistic</a></li>
<li class="chapter" data-level="6.1.6" data-path="interpretation.html"><a href="interpretation.html#global-explainer---simplifying-the-machine-learning-model"><i class="fa fa-check"></i><b>6.1.6</b> Global Explainer - Simplifying the Machine Learning Model</a></li>
<li class="chapter" data-level="6.1.7" data-path="interpretation.html"><a href="interpretation.html#local-explainer---lime-explaining-single-instances-observations"><i class="fa fa-check"></i><b>6.1.7</b> Local Explainer - LIME Explaining Single Instances (observations)</a></li>
<li class="chapter" data-level="6.1.8" data-path="interpretation.html"><a href="interpretation.html#local-explainer---shapley"><i class="fa fa-check"></i><b>6.1.8</b> Local Explainer - Shapley</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="interpretation.html"><a href="interpretation.html#causal-inference-and-machine-learning"><i class="fa fa-check"></i><b>6.2</b> Causal Inference and Machine Learning</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="interpretation.html"><a href="interpretation.html#causalInference"><i class="fa fa-check"></i><b>6.2.1</b> Causal Inference on Static Data</a></li>
<li class="chapter" data-level="6.2.2" data-path="interpretation.html"><a href="interpretation.html#structural-equation-models"><i class="fa fa-check"></i><b>6.2.2</b> Structural Equation Models</a></li>
<li class="chapter" data-level="6.2.3" data-path="interpretation.html"><a href="interpretation.html#automatic-causal-discovery"><i class="fa fa-check"></i><b>6.2.3</b> Automatic Causal Discovery</a></li>
<li class="chapter" data-level="6.2.4" data-path="interpretation.html"><a href="interpretation.html#causal-inference-on-dynamic-data"><i class="fa fa-check"></i><b>6.2.4</b> Causal Inference on Dynamic Data</a></li>
<li class="chapter" data-level="6.2.5" data-path="interpretation.html"><a href="interpretation.html#outlook-for-machine-learning"><i class="fa fa-check"></i><b>6.2.5</b> Outlook for Machine Learning</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="gan.html"><a href="gan.html"><i class="fa fa-check"></i><b>7</b> Generative Modeling and Reinforcement Learning</a>
<ul>
<li class="chapter" data-level="7.1" data-path="gan.html"><a href="gan.html#autoencoder"><i class="fa fa-check"></i><b>7.1</b> Autoencoder</a>
<ul>
<li class="chapter" data-level="7.1.1" data-path="gan.html"><a href="gan.html#autoencoder---deep-neural-network-mnist"><i class="fa fa-check"></i><b>7.1.1</b> Autoencoder - Deep Neural Network MNIST</a></li>
<li class="chapter" data-level="7.1.2" data-path="gan.html"><a href="gan.html#autoencoder---mnist-convolutional-neural-networks"><i class="fa fa-check"></i><b>7.1.2</b> Autoencoder - MNIST Convolutional Neural Networks</a></li>
<li class="chapter" data-level="7.1.3" data-path="gan.html"><a href="gan.html#VAE"><i class="fa fa-check"></i><b>7.1.3</b> Variational Autoencoder (VAE)</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="gan.html"><a href="gan.html#GANS"><i class="fa fa-check"></i><b>7.2</b> Generative Adversarial Networks (GANs)</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="gan.html"><a href="gan.html#mnist---generative-adversarial-networks-based-on-deep-neural-networks"><i class="fa fa-check"></i><b>7.2.1</b> MNIST - Generative Adversarial Networks Based on Deep Neural Networks</a></li>
<li class="chapter" data-level="7.2.2" data-path="gan.html"><a href="gan.html#flower---gan"><i class="fa fa-check"></i><b>7.2.2</b> Flower - GAN</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="gan.html"><a href="gan.html#reinforcement-learning"><i class="fa fa-check"></i><b>7.3</b> Reinforcement learning</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="datasets.html"><a href="datasets.html"><i class="fa fa-check"></i><b>8</b> Data sets</a>
<ul>
<li class="chapter" data-level="8.1" data-path="datasets.html"><a href="datasets.html#titanic"><i class="fa fa-check"></i><b>8.1</b> Titanic</a></li>
<li class="chapter" data-level="8.2" data-path="datasets.html"><a href="datasets.html#plant-pollinator-database"><i class="fa fa-check"></i><b>8.2</b> Plant-pollinator Database</a></li>
<li class="chapter" data-level="8.3" data-path="datasets.html"><a href="datasets.html#wine"><i class="fa fa-check"></i><b>8.3</b> Wine</a></li>
<li class="chapter" data-level="8.4" data-path="datasets.html"><a href="datasets.html#nasa"><i class="fa fa-check"></i><b>8.4</b> Nasa</a></li>
<li class="chapter" data-level="8.5" data-path="datasets.html"><a href="datasets.html#flower"><i class="fa fa-check"></i><b>8.5</b> Flower</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Machine Learning and AI in TensorFlow and R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="gan" class="section level1" number="7">
<h1><span class="header-section-number">7</span> Generative Modeling and Reinforcement Learning</h1>
<!-- Put this here (right after the first markdown headline) and only here for each document! -->
<script src="./scripts/multipleChoice.js"></script>
<p>We will explore more machine learning ideas today.</p>
<div id="autoencoder" class="section level2" number="7.1">
<h2><span class="header-section-number">7.1</span> Autoencoder</h2>
<p>An autoencoder (AE) is a type of artificial neural network for unsupervised learning. The idea is similar to data compression: The first part of the network compresses (encodes) the data to a low dimensional space (e.g. 2-4 dimensions) and the second part of the network decompresses (reverses the encoding) and learns to reconstruct the data (think of a hourglass).</p>
<p>Why is this useful? The method is similar to a dimension reduction technique (e.g. PCA) but with the advantage that we don’t have to make any distributional assumptions (but see PCA). For instance, we could first train an autoencoder on genomic expression data with thousands of features, compress them into 2-4 dimensions, and then use them for clustering.</p>
<div id="autoencoder---deep-neural-network-mnist" class="section level3" number="7.1.1">
<h3><span class="header-section-number">7.1.1</span> Autoencoder - Deep Neural Network MNIST</h3>
<p>We now will write an autoencoder for the MNIST data set.</p>
<p>Let’s start with the (usual) MNIST example:</p>
<div class="sourceCode" id="cb863"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb863-1"><a href="gan.html#cb863-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(keras)</span>
<span id="cb863-2"><a href="gan.html#cb863-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tensorflow)</span>
<span id="cb863-3"><a href="gan.html#cb863-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set_random_seed</span>(321L, <span class="at">disable_gpu =</span> <span class="cn">FALSE</span>)  <span class="co"># Already sets R&#39;s random seed.</span></span>
<span id="cb863-4"><a href="gan.html#cb863-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb863-5"><a href="gan.html#cb863-5" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> keras<span class="sc">::</span><span class="fu">dataset_mnist</span>()</span></code></pre></div>
<p>We don’t need the labels here, our images will be the inputs and at the same time the outputs of our final autoencoder.</p>
<div class="sourceCode" id="cb864"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb864-1"><a href="gan.html#cb864-1" aria-hidden="true" tabindex="-1"></a>rotate <span class="ot">=</span> <span class="cf">function</span>(x){ <span class="fu">t</span>(<span class="fu">apply</span>(x, <span class="dv">2</span>, rev)) }</span>
<span id="cb864-2"><a href="gan.html#cb864-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb864-3"><a href="gan.html#cb864-3" aria-hidden="true" tabindex="-1"></a>imgPlot <span class="ot">=</span> <span class="cf">function</span>(img, <span class="at">title =</span> <span class="st">&quot;&quot;</span>){</span>
<span id="cb864-4"><a href="gan.html#cb864-4" aria-hidden="true" tabindex="-1"></a>  col <span class="ot">=</span> <span class="fu">grey.colors</span>(<span class="dv">255</span>)</span>
<span id="cb864-5"><a href="gan.html#cb864-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(title <span class="sc">!=</span> <span class="st">&quot;&quot;</span>){ main <span class="ot">=</span> <span class="fu">paste0</span>(<span class="st">&quot;Label: &quot;</span>, <span class="fu">as.character</span>(title)) }</span>
<span id="cb864-6"><a href="gan.html#cb864-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>{ main <span class="ot">=</span> <span class="st">&quot;&quot;</span> }</span>
<span id="cb864-7"><a href="gan.html#cb864-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">image</span>(<span class="fu">rotate</span>(img), <span class="at">col =</span> col, <span class="at">xlab =</span> <span class="st">&quot;&quot;</span>, <span class="at">ylab =</span> <span class="st">&quot;&quot;</span>, <span class="at">axes =</span> <span class="cn">FALSE</span>, <span class="at">main =</span> main)</span>
<span id="cb864-8"><a href="gan.html#cb864-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb864-9"><a href="gan.html#cb864-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb864-10"><a href="gan.html#cb864-10" aria-hidden="true" tabindex="-1"></a>train <span class="ot">=</span> data[[<span class="dv">1</span>]]</span>
<span id="cb864-11"><a href="gan.html#cb864-11" aria-hidden="true" tabindex="-1"></a>test <span class="ot">=</span> data[[<span class="dv">2</span>]]</span>
<span id="cb864-12"><a href="gan.html#cb864-12" aria-hidden="true" tabindex="-1"></a>train_x <span class="ot">=</span> <span class="fu">array</span>(train[[<span class="dv">1</span>]]<span class="sc">/</span><span class="dv">255</span>, <span class="fu">c</span>(<span class="fu">dim</span>(train[[<span class="dv">1</span>]])[<span class="dv">1</span>], 784L))</span>
<span id="cb864-13"><a href="gan.html#cb864-13" aria-hidden="true" tabindex="-1"></a>test_x <span class="ot">=</span> <span class="fu">array</span>(test[[<span class="dv">1</span>]]<span class="sc">/</span><span class="dv">255</span>, <span class="fu">c</span>(<span class="fu">dim</span>(test[[<span class="dv">1</span>]])[<span class="dv">1</span>], 784L))</span></code></pre></div>
<p>Our encoder: image (784 dimensions) <span class="math inline">\(\rightarrow\)</span> 2 dimensions</p>
<div class="sourceCode" id="cb865"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb865-1"><a href="gan.html#cb865-1" aria-hidden="true" tabindex="-1"></a>down_size_model <span class="ot">=</span> <span class="fu">keras_model_sequential</span>()</span>
<span id="cb865-2"><a href="gan.html#cb865-2" aria-hidden="true" tabindex="-1"></a>down_size_model <span class="sc">%&gt;%</span> </span>
<span id="cb865-3"><a href="gan.html#cb865-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> 100L, <span class="at">input_shape =</span> <span class="fu">c</span>(784L), <span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb865-4"><a href="gan.html#cb865-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> 20L, <span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb865-5"><a href="gan.html#cb865-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> 2L, <span class="at">activation =</span> <span class="st">&quot;linear&quot;</span>)</span></code></pre></div>
<p>Our decoder: 2 dimensions <span class="math inline">\(\rightarrow\)</span> 784 dimensions (our image)</p>
<div class="sourceCode" id="cb866"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb866-1"><a href="gan.html#cb866-1" aria-hidden="true" tabindex="-1"></a>up_size_model <span class="ot">=</span> <span class="fu">keras_model_sequential</span>()</span>
<span id="cb866-2"><a href="gan.html#cb866-2" aria-hidden="true" tabindex="-1"></a>up_size_model <span class="sc">%&gt;%</span> </span>
<span id="cb866-3"><a href="gan.html#cb866-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> 20L, <span class="at">input_shape =</span> <span class="fu">c</span>(2L), <span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb866-4"><a href="gan.html#cb866-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> 100L, <span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb866-5"><a href="gan.html#cb866-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> 784L, <span class="at">activation =</span> <span class="st">&quot;sigmoid&quot;</span>)</span></code></pre></div>
<p>We can use the non-sequential model type to connect the two models. (We did the same in the transfer learning chapter.)</p>
<div class="sourceCode" id="cb867"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb867-1"><a href="gan.html#cb867-1" aria-hidden="true" tabindex="-1"></a>autoencoder <span class="ot">=</span> <span class="fu">keras_model</span>(<span class="at">inputs =</span> down_size_model<span class="sc">$</span>input, </span>
<span id="cb867-2"><a href="gan.html#cb867-2" aria-hidden="true" tabindex="-1"></a>                          <span class="at">outputs =</span> <span class="fu">up_size_model</span>(down_size_model<span class="sc">$</span>output))</span>
<span id="cb867-3"><a href="gan.html#cb867-3" aria-hidden="true" tabindex="-1"></a>autoencoder<span class="sc">$</span><span class="fu">compile</span>(<span class="at">loss =</span> loss_binary_crossentropy,</span>
<span id="cb867-4"><a href="gan.html#cb867-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">optimizer =</span> <span class="fu">optimizer_adamax</span>(<span class="fl">0.01</span>))</span>
<span id="cb867-5"><a href="gan.html#cb867-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(autoencoder)</span></code></pre></div>
<pre><code>## Model: &quot;model_2&quot;
## ________________________________________________________________________________________________________
##  Layer (type)                                 Output Shape                              Param #         
## ========================================================================================================
##  dense_212_input (InputLayer)                 [(None, 784)]                             0               
##                                                                                                         
##  dense_212 (Dense)                            (None, 100)                               78500           
##                                                                                                         
##  dense_211 (Dense)                            (None, 20)                                2020            
##                                                                                                         
##  dense_210 (Dense)                            (None, 2)                                 42              
##                                                                                                         
##  sequential_62 (Sequential)                   (None, 784)                               81344           
##                                                                                                         
## ========================================================================================================
## Total params: 161,906
## Trainable params: 161,906
## Non-trainable params: 0
## ________________________________________________________________________________________________________</code></pre>
<p>We will now show an example of an image before and after the unfitted autoencoder, so we see that we have to train the autoencoder.</p>
<div class="sourceCode" id="cb869"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb869-1"><a href="gan.html#cb869-1" aria-hidden="true" tabindex="-1"></a>image <span class="ot">=</span> <span class="fu">autoencoder</span>(train_x[<span class="dv">1</span>,,<span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb869-2"><a href="gan.html#cb869-2" aria-hidden="true" tabindex="-1"></a>oldpar <span class="ot">=</span> <span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb869-3"><a href="gan.html#cb869-3" aria-hidden="true" tabindex="-1"></a><span class="fu">imgPlot</span>(<span class="fu">array</span>(train_x[<span class="dv">1</span>,,<span class="at">drop =</span> <span class="cn">FALSE</span>], <span class="fu">c</span>(<span class="dv">28</span>, <span class="dv">28</span>)), <span class="at">title =</span> <span class="st">&quot;Before&quot;</span>)</span>
<span id="cb869-4"><a href="gan.html#cb869-4" aria-hidden="true" tabindex="-1"></a><span class="fu">imgPlot</span>(<span class="fu">array</span>(image<span class="sc">$</span><span class="fu">numpy</span>(), <span class="fu">c</span>(<span class="dv">28</span>, <span class="dv">28</span>)), <span class="at">title =</span> <span class="st">&quot;After&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/chunk_chapter7_6__AEmnistoutput-1.png" width="672" /></p>
<div class="sourceCode" id="cb870"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb870-1"><a href="gan.html#cb870-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(oldpar)</span></code></pre></div>
<p>Fit the autoencoder (inputs == outputs!):</p>
<div class="sourceCode" id="cb871"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb871-1"><a href="gan.html#cb871-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tensorflow)</span>
<span id="cb871-2"><a href="gan.html#cb871-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(keras)</span>
<span id="cb871-3"><a href="gan.html#cb871-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set_random_seed</span>(123L, <span class="at">disable_gpu =</span> <span class="cn">FALSE</span>)  <span class="co"># Already sets R&#39;s random seed.</span></span>
<span id="cb871-4"><a href="gan.html#cb871-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb871-5"><a href="gan.html#cb871-5" aria-hidden="true" tabindex="-1"></a>autoencoder <span class="sc">%&gt;%</span> </span>
<span id="cb871-6"><a href="gan.html#cb871-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(<span class="at">x =</span> train_x, <span class="at">y =</span> train_x, <span class="at">epochs =</span> 5L, <span class="at">batch_size =</span> 128L)</span></code></pre></div>
<p>Visualization of the latent variables:</p>
<div class="sourceCode" id="cb872"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb872-1"><a href="gan.html#cb872-1" aria-hidden="true" tabindex="-1"></a>pred_dim <span class="ot">=</span> <span class="fu">down_size_model</span>(test_x)</span>
<span id="cb872-2"><a href="gan.html#cb872-2" aria-hidden="true" tabindex="-1"></a>reconstr_pred <span class="ot">=</span> <span class="fu">up_size_model</span>(pred_dim)</span>
<span id="cb872-3"><a href="gan.html#cb872-3" aria-hidden="true" tabindex="-1"></a><span class="fu">imgPlot</span>(<span class="fu">array</span>(reconstr_pred[<span class="dv">10</span>,]<span class="sc">$</span><span class="fu">numpy</span>(), <span class="at">dim =</span> <span class="fu">c</span>(28L, 28L)), <span class="at">title =</span> <span class="st">&quot;&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/chunk_chapter7_8__AEvisualization-1.png" width="672" /></p>
<div class="sourceCode" id="cb873"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb873-1"><a href="gan.html#cb873-1" aria-hidden="true" tabindex="-1"></a>ownColors <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;limegreen&quot;</span>, <span class="st">&quot;purple&quot;</span>, <span class="st">&quot;yellow&quot;</span>, <span class="st">&quot;grey&quot;</span>, <span class="st">&quot;orange&quot;</span>,</span>
<span id="cb873-2"><a href="gan.html#cb873-2" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;black&quot;</span>, <span class="st">&quot;red&quot;</span>, <span class="st">&quot;navy&quot;</span>, <span class="st">&quot;sienna&quot;</span>, <span class="st">&quot;springgreen&quot;</span>)</span>
<span id="cb873-3"><a href="gan.html#cb873-3" aria-hidden="true" tabindex="-1"></a>oldpar <span class="ot">=</span> <span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb873-4"><a href="gan.html#cb873-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pred_dim<span class="sc">$</span><span class="fu">numpy</span>()[,<span class="dv">1</span>], pred_dim<span class="sc">$</span><span class="fu">numpy</span>()[,<span class="dv">2</span>], <span class="at">col =</span> ownColors[test[[<span class="dv">2</span>]]<span class="sc">+</span>1L])</span></code></pre></div>
<p><img src="_main_files/figure-html/chunk_chapter7_9__AEvisualizationContinuation-1.png" width="672" /></p>
<div class="sourceCode" id="cb874"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb874-1"><a href="gan.html#cb874-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(oldpar)</span></code></pre></div>
<p>The picture above shows the 2-dimensional encoded values of the numbers in the MNIST data set and the number they are depicting via the respective color.</p>
</div>
<div id="autoencoder---mnist-convolutional-neural-networks" class="section level3" number="7.1.2">
<h3><span class="header-section-number">7.1.2</span> Autoencoder - MNIST Convolutional Neural Networks</h3>
<p>We can also use convolutional neural networks instead or on the side of deep neural networks. Moreover, there is an inverse convolutional layer (layer_conv_2d_transpose; “deconvolution”):</p>
<p>Prepare data:</p>
<div class="sourceCode" id="cb875"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb875-1"><a href="gan.html#cb875-1" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> tf<span class="sc">$</span>keras<span class="sc">$</span>datasets<span class="sc">$</span>mnist<span class="sc">$</span><span class="fu">load_data</span>()</span>
<span id="cb875-2"><a href="gan.html#cb875-2" aria-hidden="true" tabindex="-1"></a>train <span class="ot">=</span> data[[<span class="dv">1</span>]]</span>
<span id="cb875-3"><a href="gan.html#cb875-3" aria-hidden="true" tabindex="-1"></a>train_x <span class="ot">=</span> <span class="fu">array</span>(train[[<span class="dv">1</span>]]<span class="sc">/</span><span class="dv">255</span>, <span class="fu">c</span>(<span class="fu">dim</span>(train[[<span class="dv">1</span>]]), 1L))</span>
<span id="cb875-4"><a href="gan.html#cb875-4" aria-hidden="true" tabindex="-1"></a>test_x <span class="ot">=</span> <span class="fu">array</span>(data[[<span class="dv">2</span>]][[<span class="dv">1</span>]]<span class="sc">/</span><span class="dv">255</span>, <span class="fu">c</span>(<span class="fu">dim</span>(data[[<span class="dv">2</span>]][[<span class="dv">1</span>]]<span class="sc">/</span><span class="dv">255</span>), 1L))</span></code></pre></div>
<p>Then define the downsize model:</p>
<div class="sourceCode" id="cb876"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb876-1"><a href="gan.html#cb876-1" aria-hidden="true" tabindex="-1"></a>down_size_model <span class="ot">=</span> <span class="fu">keras_model_sequential</span>()</span>
<span id="cb876-2"><a href="gan.html#cb876-2" aria-hidden="true" tabindex="-1"></a>down_size_model <span class="sc">%&gt;%</span> </span>
<span id="cb876-3"><a href="gan.html#cb876-3" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_conv_2d</span>(<span class="at">filters =</span> 32L, <span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>, <span class="at">kernel_size =</span> <span class="fu">c</span>(2L, 2L), </span>
<span id="cb876-4"><a href="gan.html#cb876-4" aria-hidden="true" tabindex="-1"></a>                          <span class="at">input_shape =</span> <span class="fu">c</span>(28L, 28L, 1L),</span>
<span id="cb876-5"><a href="gan.html#cb876-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">strides =</span> <span class="fu">c</span>(4L, 4L)) <span class="sc">%&gt;%</span> </span>
<span id="cb876-6"><a href="gan.html#cb876-6" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_conv_2d</span>(<span class="at">filters =</span> 16L, <span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>, </span>
<span id="cb876-7"><a href="gan.html#cb876-7" aria-hidden="true" tabindex="-1"></a>                           <span class="at">kernel_size =</span> <span class="fu">c</span>(7L, 7L), <span class="at">strides =</span> <span class="fu">c</span>(1L, 1L)) <span class="sc">%&gt;%</span> </span>
<span id="cb876-8"><a href="gan.html#cb876-8" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_flatten</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb876-9"><a href="gan.html#cb876-9" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_dense</span>(<span class="at">units =</span> 2L, <span class="at">activation =</span> <span class="st">&quot;linear&quot;</span>)</span></code></pre></div>
<p>Define the upsize model:</p>
<div class="sourceCode" id="cb877"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb877-1"><a href="gan.html#cb877-1" aria-hidden="true" tabindex="-1"></a>up_size_model <span class="ot">=</span> <span class="fu">keras_model_sequential</span>()</span>
<span id="cb877-2"><a href="gan.html#cb877-2" aria-hidden="true" tabindex="-1"></a>up_size_model <span class="sc">%&gt;%</span> </span>
<span id="cb877-3"><a href="gan.html#cb877-3" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_dense</span>(<span class="at">units =</span> 8L, <span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>, <span class="at">input_shape =</span> <span class="fu">c</span>(2L)) <span class="sc">%&gt;%</span> </span>
<span id="cb877-4"><a href="gan.html#cb877-4" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_reshape</span>(<span class="at">target_shape =</span> <span class="fu">c</span>(1L, 1L, 8L)) <span class="sc">%&gt;%</span> </span>
<span id="cb877-5"><a href="gan.html#cb877-5" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_conv_2d_transpose</span>(<span class="at">filters =</span> 16L, <span class="at">kernel_size =</span> <span class="fu">c</span>(<span class="dv">7</span>, <span class="dv">7</span>),</span>
<span id="cb877-6"><a href="gan.html#cb877-6" aria-hidden="true" tabindex="-1"></a>                         <span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>, <span class="at">strides =</span> <span class="fu">c</span>(1L, 1L)) <span class="sc">%&gt;%</span> </span>
<span id="cb877-7"><a href="gan.html#cb877-7" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_conv_2d_transpose</span>(<span class="at">filters =</span> 32L, <span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>,</span>
<span id="cb877-8"><a href="gan.html#cb877-8" aria-hidden="true" tabindex="-1"></a>                         <span class="at">kernel_size =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>), <span class="at">strides =</span> <span class="fu">c</span>(4L, 4L)) <span class="sc">%&gt;%</span> </span>
<span id="cb877-9"><a href="gan.html#cb877-9" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_conv_2d</span>(<span class="at">filters =</span> <span class="dv">1</span>, <span class="at">kernel_size =</span> <span class="fu">c</span>(1L, 1L),</span>
<span id="cb877-10"><a href="gan.html#cb877-10" aria-hidden="true" tabindex="-1"></a>               <span class="at">strides =</span> <span class="fu">c</span>(1L, 1L), <span class="at">activation =</span> <span class="st">&quot;sigmoid&quot;</span>)</span></code></pre></div>
<p>Combine the two models and fit it:</p>
<div class="sourceCode" id="cb878"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb878-1"><a href="gan.html#cb878-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tensorflow)</span>
<span id="cb878-2"><a href="gan.html#cb878-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(keras)</span>
<span id="cb878-3"><a href="gan.html#cb878-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set_random_seed</span>(321L, <span class="at">disable_gpu =</span> <span class="cn">FALSE</span>)  <span class="co"># Already sets R&#39;s random seed.</span></span>
<span id="cb878-4"><a href="gan.html#cb878-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb878-5"><a href="gan.html#cb878-5" aria-hidden="true" tabindex="-1"></a>autoencoder <span class="ot">=</span> tf<span class="sc">$</span>keras<span class="sc">$</span>models<span class="sc">$</span><span class="fu">Model</span>(<span class="at">inputs =</span> down_size_model<span class="sc">$</span>input,</span>
<span id="cb878-6"><a href="gan.html#cb878-6" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">outputs =</span> <span class="fu">up_size_model</span>(down_size_model<span class="sc">$</span>output))</span>
<span id="cb878-7"><a href="gan.html#cb878-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb878-8"><a href="gan.html#cb878-8" aria-hidden="true" tabindex="-1"></a>autoencoder<span class="sc">$</span><span class="fu">compile</span>(<span class="at">loss =</span> loss_binary_crossentropy,</span>
<span id="cb878-9"><a href="gan.html#cb878-9" aria-hidden="true" tabindex="-1"></a>                    <span class="at">optimizer =</span> <span class="fu">optimizer_rmsprop</span>(<span class="fl">0.001</span>))</span>
<span id="cb878-10"><a href="gan.html#cb878-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb878-11"><a href="gan.html#cb878-11" aria-hidden="true" tabindex="-1"></a>autoencoder<span class="sc">$</span><span class="fu">fit</span>(<span class="at">x =</span> tf<span class="sc">$</span><span class="fu">constant</span>(train_x), <span class="at">y =</span> tf<span class="sc">$</span><span class="fu">constant</span>(train_x),</span>
<span id="cb878-12"><a href="gan.html#cb878-12" aria-hidden="true" tabindex="-1"></a>                <span class="at">epochs =</span> 10L, <span class="at">batch_size =</span> 128L)</span></code></pre></div>
<pre><code>## &lt;keras.callbacks.History&gt;</code></pre>
<p>Test it:</p>
<div class="sourceCode" id="cb880"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb880-1"><a href="gan.html#cb880-1" aria-hidden="true" tabindex="-1"></a>pred_dim <span class="ot">=</span> <span class="fu">down_size_model</span>(tf<span class="sc">$</span><span class="fu">constant</span>(test_x, <span class="st">&quot;float32&quot;</span>))</span>
<span id="cb880-2"><a href="gan.html#cb880-2" aria-hidden="true" tabindex="-1"></a>reconstr_pred <span class="ot">=</span> <span class="fu">autoencoder</span>(tf<span class="sc">$</span><span class="fu">constant</span>(test_x, <span class="st">&quot;float32&quot;</span>))</span>
<span id="cb880-3"><a href="gan.html#cb880-3" aria-hidden="true" tabindex="-1"></a><span class="fu">imgPlot</span>(reconstr_pred[<span class="dv">10</span>,,,]<span class="sc">$</span><span class="fu">numpy</span>()[,,<span class="dv">1</span>])</span></code></pre></div>
<p><img src="_main_files/figure-html/chunk_chapter7_14-1.png" width="672" /></p>
<div class="sourceCode" id="cb881"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb881-1"><a href="gan.html#cb881-1" aria-hidden="true" tabindex="-1"></a>ownColors <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;limegreen&quot;</span>, <span class="st">&quot;purple&quot;</span>, <span class="st">&quot;yellow&quot;</span>, <span class="st">&quot;grey&quot;</span>, <span class="st">&quot;orange&quot;</span>,</span>
<span id="cb881-2"><a href="gan.html#cb881-2" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;black&quot;</span>, <span class="st">&quot;red&quot;</span>, <span class="st">&quot;navy&quot;</span>, <span class="st">&quot;sienna&quot;</span>, <span class="st">&quot;springgreen&quot;</span>)</span>
<span id="cb881-3"><a href="gan.html#cb881-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pred_dim[,<span class="dv">1</span>]<span class="sc">$</span><span class="fu">numpy</span>(), pred_dim[,<span class="dv">2</span>]<span class="sc">$</span><span class="fu">numpy</span>(), <span class="at">col =</span> ownColors[test[[<span class="dv">2</span>]]<span class="sc">+</span>1L])</span></code></pre></div>
<p><img src="_main_files/figure-html/chunk_chapter7_14-2.png" width="672" /></p>
<div class="sourceCode" id="cb882"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb882-1"><a href="gan.html#cb882-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Generate new images!</span></span>
<span id="cb882-2"><a href="gan.html#cb882-2" aria-hidden="true" tabindex="-1"></a>new <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">10</span>), <span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb882-3"><a href="gan.html#cb882-3" aria-hidden="true" tabindex="-1"></a><span class="fu">imgPlot</span>(<span class="fu">array</span>(<span class="fu">up_size_model</span>(new)<span class="sc">$</span><span class="fu">numpy</span>(), <span class="fu">c</span>(28L, 28L)))</span></code></pre></div>
<p><img src="_main_files/figure-html/chunk_chapter7_14-3.png" width="672" /></p>
<div class="sourceCode" id="cb883"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb883-1"><a href="gan.html#cb883-1" aria-hidden="true" tabindex="-1"></a>new <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">5</span>), <span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb883-2"><a href="gan.html#cb883-2" aria-hidden="true" tabindex="-1"></a><span class="fu">imgPlot</span>(<span class="fu">array</span>(<span class="fu">up_size_model</span>(new)<span class="sc">$</span><span class="fu">numpy</span>(), <span class="fu">c</span>(28L, 28L)))</span></code></pre></div>
<p><img src="_main_files/figure-html/chunk_chapter7_14-4.png" width="672" /></p>
</div>
<div id="VAE" class="section level3" number="7.1.3">
<h3><span class="header-section-number">7.1.3</span> Variational Autoencoder (VAE)</h3>
<p>The difference between a variational and a normal autoencoder is that a variational autoencoder assumes a distribution for the latent variables (latent variables cannot be observed and are composed of other variables) and the parameters of this distribution are learned. Thus new objects can be generated by inserting valid (!) (with regard to the assumed distribution) “seeds” to the decoder.
To achieve the property that more or less randomly chosen points in the low dimensional latent space are meaningful and yield suitable results after decoding, the latent space/training process must be regularized.
In this process, the input to the VAE is encoded to a distribution in the latent space rather than a single point.</p>
<p>For building variational autoencoders, we will use TensorFlow probability, but first, we need to split the data again.</p>
<div class="sourceCode" id="cb884"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb884-1"><a href="gan.html#cb884-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tfprobability)</span></code></pre></div>
<pre><code>## 
## Attaching package: &#39;tfprobability&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:Rgraphviz&#39;:
## 
##     shape</code></pre>
<div class="sourceCode" id="cb887"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb887-1"><a href="gan.html#cb887-1" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> tf<span class="sc">$</span>keras<span class="sc">$</span>datasets<span class="sc">$</span>mnist<span class="sc">$</span><span class="fu">load_data</span>()</span>
<span id="cb887-2"><a href="gan.html#cb887-2" aria-hidden="true" tabindex="-1"></a>train <span class="ot">=</span> data[[<span class="dv">1</span>]]</span>
<span id="cb887-3"><a href="gan.html#cb887-3" aria-hidden="true" tabindex="-1"></a>train_x <span class="ot">=</span> <span class="fu">array</span>(train[[<span class="dv">1</span>]]<span class="sc">/</span><span class="dv">255</span>, <span class="fu">c</span>(<span class="fu">dim</span>(train[[<span class="dv">1</span>]]), 1L))</span></code></pre></div>
<p>We will use TensorFlow probability to define priors for our latent variables.</p>
<div class="sourceCode" id="cb888"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb888-1"><a href="gan.html#cb888-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tfprobability)</span>
<span id="cb888-2"><a href="gan.html#cb888-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set_random_seed</span>(321L, <span class="at">disable_gpu =</span> <span class="cn">FALSE</span>)  <span class="co"># Already sets R&#39;s random seed.</span></span>
<span id="cb888-3"><a href="gan.html#cb888-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb888-4"><a href="gan.html#cb888-4" aria-hidden="true" tabindex="-1"></a>tfp <span class="ot">=</span> reticulate<span class="sc">::</span><span class="fu">import</span>(<span class="st">&quot;tensorflow_probability&quot;</span>)</span></code></pre></div>
<p>Build the two networks:</p>
<div class="sourceCode" id="cb889"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb889-1"><a href="gan.html#cb889-1" aria-hidden="true" tabindex="-1"></a>encoded <span class="ot">=</span> 2L</span>
<span id="cb889-2"><a href="gan.html#cb889-2" aria-hidden="true" tabindex="-1"></a>prior <span class="ot">=</span> <span class="fu">tfd_independent</span>(<span class="fu">tfd_normal</span>(<span class="fu">c</span>(<span class="fl">0.0</span>, <span class="fl">0.0</span>), <span class="fl">1.0</span>), 1L)</span>
<span id="cb889-3"><a href="gan.html#cb889-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb889-4"><a href="gan.html#cb889-4" aria-hidden="true" tabindex="-1"></a>down_size_model <span class="ot">=</span> <span class="fu">keras_model_sequential</span>()</span>
<span id="cb889-5"><a href="gan.html#cb889-5" aria-hidden="true" tabindex="-1"></a>down_size_model <span class="sc">%&gt;%</span> </span>
<span id="cb889-6"><a href="gan.html#cb889-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_conv_2d</span>(<span class="at">filters =</span> 32L, <span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>, <span class="at">kernel_size =</span> <span class="fu">c</span>(2L, 2L),</span>
<span id="cb889-7"><a href="gan.html#cb889-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">input_shape =</span> <span class="fu">c</span>(28L, 28L, 1L), <span class="at">strides =</span> <span class="fu">c</span>(4L, 4L)) <span class="sc">%&gt;%</span> </span>
<span id="cb889-8"><a href="gan.html#cb889-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_conv_2d</span>(<span class="at">filters =</span> 16L, <span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>,</span>
<span id="cb889-9"><a href="gan.html#cb889-9" aria-hidden="true" tabindex="-1"></a>               <span class="at">kernel_size =</span> <span class="fu">c</span>(7L, 7L), <span class="at">strides =</span> <span class="fu">c</span>(1L, 1L)) <span class="sc">%&gt;%</span> </span>
<span id="cb889-10"><a href="gan.html#cb889-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_flatten</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb889-11"><a href="gan.html#cb889-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> 4L, <span class="at">activation =</span> <span class="st">&quot;linear&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb889-12"><a href="gan.html#cb889-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_independent_normal</span>(2L,</span>
<span id="cb889-13"><a href="gan.html#cb889-13" aria-hidden="true" tabindex="-1"></a>                           <span class="at">activity_regularizer =</span></span>
<span id="cb889-14"><a href="gan.html#cb889-14" aria-hidden="true" tabindex="-1"></a>                             tfp<span class="sc">$</span>layers<span class="sc">$</span><span class="fu">KLDivergenceRegularizer</span>(<span class="at">distribution_b =</span> prior))</span>
<span id="cb889-15"><a href="gan.html#cb889-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb889-16"><a href="gan.html#cb889-16" aria-hidden="true" tabindex="-1"></a>up_size_model <span class="ot">=</span> <span class="fu">keras_model_sequential</span>()</span>
<span id="cb889-17"><a href="gan.html#cb889-17" aria-hidden="true" tabindex="-1"></a>up_size_model <span class="sc">%&gt;%</span> </span>
<span id="cb889-18"><a href="gan.html#cb889-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> 8L, <span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>, <span class="at">input_shape =</span> <span class="fu">c</span>(2L)) <span class="sc">%&gt;%</span> </span>
<span id="cb889-19"><a href="gan.html#cb889-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_reshape</span>(<span class="at">target_shape =</span> <span class="fu">c</span>(1L, 1L, 8L)) <span class="sc">%&gt;%</span> </span>
<span id="cb889-20"><a href="gan.html#cb889-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_conv_2d_transpose</span>(<span class="at">filters =</span> 16L, <span class="at">kernel_size =</span> <span class="fu">c</span>(<span class="dv">7</span>, <span class="dv">7</span>),</span>
<span id="cb889-21"><a href="gan.html#cb889-21" aria-hidden="true" tabindex="-1"></a>                         <span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>, <span class="at">strides =</span> <span class="fu">c</span>(1L, 1L),</span>
<span id="cb889-22"><a href="gan.html#cb889-22" aria-hidden="true" tabindex="-1"></a>                         <span class="at">use_bias =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb889-23"><a href="gan.html#cb889-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_conv_2d_transpose</span>(<span class="at">filters =</span> 32L, <span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>,</span>
<span id="cb889-24"><a href="gan.html#cb889-24" aria-hidden="true" tabindex="-1"></a>                         <span class="at">kernel_size =</span> <span class="fu">c</span>(2L, 2L), <span class="at">strides =</span> <span class="fu">c</span>(4L, 4L),</span>
<span id="cb889-25"><a href="gan.html#cb889-25" aria-hidden="true" tabindex="-1"></a>                         <span class="at">use_bias =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb889-26"><a href="gan.html#cb889-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_conv_2d</span>(<span class="at">filters =</span> <span class="dv">1</span>, <span class="at">kernel_size =</span> <span class="fu">c</span>(1L, 1L),</span>
<span id="cb889-27"><a href="gan.html#cb889-27" aria-hidden="true" tabindex="-1"></a>               <span class="at">strides =</span> <span class="fu">c</span>(1L, 1L), <span class="at">activation =</span> <span class="st">&quot;sigmoid&quot;</span>,</span>
<span id="cb889-28"><a href="gan.html#cb889-28" aria-hidden="true" tabindex="-1"></a>               <span class="at">use_bias =</span> <span class="cn">FALSE</span>)</span>
<span id="cb889-29"><a href="gan.html#cb889-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb889-30"><a href="gan.html#cb889-30" aria-hidden="true" tabindex="-1"></a>VAE <span class="ot">=</span> <span class="fu">keras_model</span>(<span class="at">inputs =</span> down_size_model<span class="sc">$</span>inputs,</span>
<span id="cb889-31"><a href="gan.html#cb889-31" aria-hidden="true" tabindex="-1"></a>                  <span class="at">outputs =</span> <span class="fu">up_size_model</span>(down_size_model<span class="sc">$</span>outputs))</span></code></pre></div>
<p>Compile and fit model:</p>
<div class="sourceCode" id="cb890"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb890-1"><a href="gan.html#cb890-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tensorflow)</span>
<span id="cb890-2"><a href="gan.html#cb890-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(keras)</span>
<span id="cb890-3"><a href="gan.html#cb890-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set_random_seed</span>(321L, <span class="at">disable_gpu =</span> <span class="cn">FALSE</span>)  <span class="co"># Already sets R&#39;s random seed.</span></span>
<span id="cb890-4"><a href="gan.html#cb890-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb890-5"><a href="gan.html#cb890-5" aria-hidden="true" tabindex="-1"></a>loss_binary <span class="ot">=</span> <span class="cf">function</span>(true, pred){</span>
<span id="cb890-6"><a href="gan.html#cb890-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">loss_binary_crossentropy</span>(true, pred) <span class="sc">*</span> <span class="fl">28.0</span> <span class="sc">*</span> <span class="fl">28.0</span>)</span>
<span id="cb890-7"><a href="gan.html#cb890-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb890-8"><a href="gan.html#cb890-8" aria-hidden="true" tabindex="-1"></a>VAE<span class="sc">$</span><span class="fu">compile</span>(<span class="at">loss =</span> loss_binary, <span class="at">optimizer =</span> <span class="fu">optimizer_adamax</span>())</span>
<span id="cb890-9"><a href="gan.html#cb890-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb890-10"><a href="gan.html#cb890-10" aria-hidden="true" tabindex="-1"></a>VAE<span class="sc">$</span><span class="fu">fit</span>(train_x, train_x, <span class="at">epochs =</span> 5L)</span></code></pre></div>
<pre><code>## &lt;keras.callbacks.History&gt;</code></pre>
<p>And show that it works:</p>
<div class="sourceCode" id="cb892"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb892-1"><a href="gan.html#cb892-1" aria-hidden="true" tabindex="-1"></a>dist <span class="ot">=</span> <span class="fu">down_size_model</span>(train_x[<span class="dv">1</span><span class="sc">:</span><span class="dv">2000</span>,,,,<span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb892-2"><a href="gan.html#cb892-2" aria-hidden="true" tabindex="-1"></a>images <span class="ot">=</span> <span class="fu">up_size_model</span>(dist<span class="sc">$</span><span class="fu">sample</span>()[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,])</span>
<span id="cb892-3"><a href="gan.html#cb892-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb892-4"><a href="gan.html#cb892-4" aria-hidden="true" tabindex="-1"></a>ownColors <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;limegreen&quot;</span>, <span class="st">&quot;purple&quot;</span>, <span class="st">&quot;yellow&quot;</span>, <span class="st">&quot;grey&quot;</span>, <span class="st">&quot;orange&quot;</span>,</span>
<span id="cb892-5"><a href="gan.html#cb892-5" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;black&quot;</span>, <span class="st">&quot;red&quot;</span>, <span class="st">&quot;navy&quot;</span>, <span class="st">&quot;sienna&quot;</span>, <span class="st">&quot;springgreen&quot;</span>)</span>
<span id="cb892-6"><a href="gan.html#cb892-6" aria-hidden="true" tabindex="-1"></a>oldpar <span class="ot">=</span> <span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb892-7"><a href="gan.html#cb892-7" aria-hidden="true" tabindex="-1"></a><span class="fu">imgPlot</span>(images[<span class="dv">1</span>,,,<span class="dv">1</span>]<span class="sc">$</span><span class="fu">numpy</span>())</span></code></pre></div>
<p><img src="_main_files/figure-html/chunk_chapter7_19__VAEmnist-1.png" width="672" /></p>
<div class="sourceCode" id="cb893"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb893-1"><a href="gan.html#cb893-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(dist<span class="sc">$</span><span class="fu">mean</span>()<span class="sc">$</span><span class="fu">numpy</span>()[,<span class="dv">1</span>], dist<span class="sc">$</span><span class="fu">mean</span>()<span class="sc">$</span><span class="fu">numpy</span>()[,<span class="dv">2</span>], <span class="at">col =</span> ownColors[train[[<span class="dv">2</span>]]<span class="sc">+</span>1L])</span></code></pre></div>
<p><img src="_main_files/figure-html/chunk_chapter7_19__VAEmnist-2.png" width="672" /></p>
<div class="sourceCode" id="cb894"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb894-1"><a href="gan.html#cb894-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(oldpar)</span></code></pre></div>
</div>
</div>
<div id="GANS" class="section level2" number="7.2">
<h2><span class="header-section-number">7.2</span> Generative Adversarial Networks (GANs)</h2>
<p>The idea of a generative adversarial network (GAN) is that two neural networks contest against each other in a “game.” One network is creating data and is trying to “trick” the other network into deciding the generated data is real. The <em>generator</em> (similar to the decoder in autoencoders) creates new images from noise. The <em>discriminator</em> is getting a mix of true (from the data set) and artificially generated images from the generator. Thereby, the loss of the generator rises when fakes are identified as fakes by the discriminator (simple binary cross entropy loss, 0/1…). The loss of the discriminator rises when fakes are identified as real images (class 0) or real images as fakes (class 1), again with binary cross entropy.</p>
<p><strong>Binary cross entropy:</strong>
Entropy or <em>Shannon entropy</em> (named after Claude Shannon) <span class="math inline">\(\mathbf{H}\)</span> (uppercase “eta”) in context of information theory is the expected value of information content or the mean/average information content of an “event” compared to all possible outcomes.
Encountering an event with low probability holds more information than encountering an event with high probability.</p>
<p><em>Binary cross entropy</em> is a measure to determine the similarity of two (discrete) probability distributions <span class="math inline">\(A~(\mathrm{true~distribution}), B~(\mathrm{predicted~distribution})\)</span> according to the inherent information.</p>
<p>It is not (!) symmetric, in general: <span class="math inline">\(\textbf{H}_{A}(B) \neq \textbf{H}_{B}(A)\)</span>.
The minimum value depends on the distribution of <span class="math inline">\(A\)</span> and is the entropy of <span class="math inline">\(A\)</span>:
<span class="math display">\[\mathrm{min}~\textbf{H}_{A}(B) = \underset{B}{\mathrm{min}}~\textbf{H}_{A}(B) = \textbf{H}_{A}(B = A) = \textbf{H}_{A}(A) = \textbf{H}(A)\]</span></p>
<p>The setup:</p>
<ul>
<li>Outcomes <span class="math inline">\(y_{i} \in \{0, 1\}\)</span> (labels).</li>
<li>Predictions <span class="math inline">\(\hat{y}_{i} \in[0, 1]\)</span> (probabilities).</li>
</ul>
<p>The binary cross entropy or log loss of a system of outcomes/predictions is then defined as follows:
<span class="math display">\[
  \textbf{H}_{A}(B) =
  -\frac{1}{N} \sum_{i = 1}^{N} y_{i} \cdot \mathrm{log} \left( p(y_{i}) \right) + (1 -y_{i}) \cdot \mathrm{log} \left( 1-p(y_{i}) \right) =\\
  = -\frac{1}{N} \sum_{i = 1}^{N} y_{i} \cdot \mathrm{log} (\hat{y}_{i}) + (1 -y_{i}) \cdot \mathrm{log} \left( 1- \hat{y}_{i} \right)
\]</span>
High predicted probabilities of having the label for originally labeled data (1) yield a low loss as well as predicting a low probability of having the label for originally unlabeled data (0). Mind the properties of probabilities and the logarithm.</p>
<p>A possible application of generative adversarial networks is to create pictures that look like real photographs e.g. <strong><a href="https://thispersondoesnotexist.com/" target="_blank" rel="noopener">https://thispersondoesnotexist.com/</a></strong>. Visit that site (several times)!.
However, the application of generative adversarial networks today is much wider than just the creation of data. For example, generative adversarial networks can also be used to “augment” data, i.e. to create new data and thereby improve the fitted model.</p>
<div id="mnist---generative-adversarial-networks-based-on-deep-neural-networks" class="section level3" number="7.2.1">
<h3><span class="header-section-number">7.2.1</span> MNIST - Generative Adversarial Networks Based on Deep Neural Networks</h3>
<p>We will now explore this on the MNIST data set.</p>
<div class="sourceCode" id="cb895"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb895-1"><a href="gan.html#cb895-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(keras)</span>
<span id="cb895-2"><a href="gan.html#cb895-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tensorflow)</span>
<span id="cb895-3"><a href="gan.html#cb895-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set_random_seed</span>(321L, <span class="at">disable_gpu =</span> <span class="cn">FALSE</span>)  <span class="co"># Already sets R&#39;s random seed.</span></span>
<span id="cb895-4"><a href="gan.html#cb895-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb895-5"><a href="gan.html#cb895-5" aria-hidden="true" tabindex="-1"></a>rotate <span class="ot">=</span> <span class="cf">function</span>(x){ <span class="fu">t</span>(<span class="fu">apply</span>(x, <span class="dv">2</span>, rev)) }</span>
<span id="cb895-6"><a href="gan.html#cb895-6" aria-hidden="true" tabindex="-1"></a>imgPlot <span class="ot">=</span> <span class="cf">function</span>(img, <span class="at">title =</span> <span class="st">&quot;&quot;</span>){</span>
<span id="cb895-7"><a href="gan.html#cb895-7" aria-hidden="true" tabindex="-1"></a>  col <span class="ot">=</span> <span class="fu">grey.colors</span>(<span class="dv">255</span>)</span>
<span id="cb895-8"><a href="gan.html#cb895-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">image</span>(<span class="fu">rotate</span>(img), <span class="at">col =</span> col, <span class="at">xlab =</span> <span class="st">&quot;&quot;</span>, <span class="at">ylab =</span> <span class="st">&quot;&quot;</span>, <span class="at">axes =</span> <span class="cn">FALSE</span>,</span>
<span id="cb895-9"><a href="gan.html#cb895-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">main =</span> <span class="fu">paste0</span>(<span class="st">&quot;Label: &quot;</span>, <span class="fu">as.character</span>(title)))</span>
<span id="cb895-10"><a href="gan.html#cb895-10" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>We don’t need the test set here.</p>
<div class="sourceCode" id="cb896"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb896-1"><a href="gan.html#cb896-1" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> <span class="fu">dataset_mnist</span>()</span>
<span id="cb896-2"><a href="gan.html#cb896-2" aria-hidden="true" tabindex="-1"></a>train <span class="ot">=</span> data<span class="sc">$</span>train</span>
<span id="cb896-3"><a href="gan.html#cb896-3" aria-hidden="true" tabindex="-1"></a>train_x <span class="ot">=</span> <span class="fu">array</span>((train<span class="sc">$</span>x<span class="fl">-127.5</span>)<span class="sc">/</span><span class="fl">127.5</span>, <span class="fu">c</span>(<span class="fu">dim</span>(train<span class="sc">$</span>x)[<span class="dv">1</span>], 784L))</span></code></pre></div>
<p>We need a function to sample images for the discriminator.</p>
<div class="sourceCode" id="cb897"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb897-1"><a href="gan.html#cb897-1" aria-hidden="true" tabindex="-1"></a>batch_size <span class="ot">=</span> 32L</span>
<span id="cb897-2"><a href="gan.html#cb897-2" aria-hidden="true" tabindex="-1"></a>dataset <span class="ot">=</span> tf<span class="sc">$</span>data<span class="sc">$</span>Dataset<span class="sc">$</span><span class="fu">from_tensor_slices</span>(tf<span class="sc">$</span><span class="fu">constant</span>(train_x, <span class="st">&quot;float32&quot;</span>))</span>
<span id="cb897-3"><a href="gan.html#cb897-3" aria-hidden="true" tabindex="-1"></a>dataset<span class="sc">$</span><span class="fu">batch</span>(batch_size)</span></code></pre></div>
<pre><code>## &lt;BatchDataset shapes: (None, 784), types: tf.float32&gt;</code></pre>
<p>Define generator model:</p>
<div class="sourceCode" id="cb899"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb899-1"><a href="gan.html#cb899-1" aria-hidden="true" tabindex="-1"></a>get_generator <span class="ot">=</span> <span class="cf">function</span>(){</span>
<span id="cb899-2"><a href="gan.html#cb899-2" aria-hidden="true" tabindex="-1"></a>  generator <span class="ot">=</span> <span class="fu">keras_model_sequential</span>()</span>
<span id="cb899-3"><a href="gan.html#cb899-3" aria-hidden="true" tabindex="-1"></a>  generator <span class="sc">%&gt;%</span> </span>
<span id="cb899-4"><a href="gan.html#cb899-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> 200L, <span class="at">input_shape =</span> <span class="fu">c</span>(100L)) <span class="sc">%&gt;%</span> </span>
<span id="cb899-5"><a href="gan.html#cb899-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_activation_leaky_relu</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb899-6"><a href="gan.html#cb899-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> 200L) <span class="sc">%&gt;%</span> </span>
<span id="cb899-7"><a href="gan.html#cb899-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_activation_leaky_relu</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb899-8"><a href="gan.html#cb899-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> 784L, <span class="at">activation =</span> <span class="st">&quot;tanh&quot;</span>)</span>
<span id="cb899-9"><a href="gan.html#cb899-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb899-10"><a href="gan.html#cb899-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(generator)</span>
<span id="cb899-11"><a href="gan.html#cb899-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>And we also test the generator model:</p>
<div class="sourceCode" id="cb900"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb900-1"><a href="gan.html#cb900-1" aria-hidden="true" tabindex="-1"></a>generator <span class="ot">=</span> <span class="fu">get_generator</span>()</span>
<span id="cb900-2"><a href="gan.html#cb900-2" aria-hidden="true" tabindex="-1"></a>sample <span class="ot">=</span> tf<span class="sc">$</span>random<span class="sc">$</span><span class="fu">normal</span>(<span class="fu">c</span>(1L, 100L))</span>
<span id="cb900-3"><a href="gan.html#cb900-3" aria-hidden="true" tabindex="-1"></a><span class="fu">imgPlot</span>(<span class="fu">array</span>(<span class="fu">generator</span>(sample)<span class="sc">$</span><span class="fu">numpy</span>(), <span class="fu">c</span>(28L, 28L)))</span></code></pre></div>
<p><img src="_main_files/figure-html/chunk_chapter7_24-1.png" width="672" /></p>
<p>In the discriminator, noise (random vector with 100 values) is passed through the network such that the output corresponds to the number of pixels of one MNIST image (784). We therefore define the discriminator function now.</p>
<div class="sourceCode" id="cb901"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb901-1"><a href="gan.html#cb901-1" aria-hidden="true" tabindex="-1"></a>get_discriminator <span class="ot">=</span> <span class="cf">function</span>(){</span>
<span id="cb901-2"><a href="gan.html#cb901-2" aria-hidden="true" tabindex="-1"></a>  discriminator <span class="ot">=</span> <span class="fu">keras_model_sequential</span>()</span>
<span id="cb901-3"><a href="gan.html#cb901-3" aria-hidden="true" tabindex="-1"></a>  discriminator <span class="sc">%&gt;%</span> </span>
<span id="cb901-4"><a href="gan.html#cb901-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> 200L, <span class="at">input_shape =</span> <span class="fu">c</span>(784L)) <span class="sc">%&gt;%</span> </span>
<span id="cb901-5"><a href="gan.html#cb901-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_activation_leaky_relu</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb901-6"><a href="gan.html#cb901-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> 100L) <span class="sc">%&gt;%</span> </span>
<span id="cb901-7"><a href="gan.html#cb901-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_activation_leaky_relu</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb901-8"><a href="gan.html#cb901-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> 1L, <span class="at">activation =</span> <span class="st">&quot;sigmoid&quot;</span>)</span>
<span id="cb901-9"><a href="gan.html#cb901-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb901-10"><a href="gan.html#cb901-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(discriminator)</span>
<span id="cb901-11"><a href="gan.html#cb901-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>And we also test the discriminator function.</p>
<div class="sourceCode" id="cb902"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb902-1"><a href="gan.html#cb902-1" aria-hidden="true" tabindex="-1"></a>discriminator <span class="ot">=</span> <span class="fu">get_discriminator</span>()</span>
<span id="cb902-2"><a href="gan.html#cb902-2" aria-hidden="true" tabindex="-1"></a><span class="fu">discriminator</span>(<span class="fu">generator</span>(tf<span class="sc">$</span>random<span class="sc">$</span><span class="fu">normal</span>(<span class="fu">c</span>(1L, 100L))))</span></code></pre></div>
<pre><code>## tf.Tensor([[0.5089391]], shape=(1, 1), dtype=float32)</code></pre>
<p>We also have to define the loss functions for both networks.We use the already known binary cross entropy. However, we have to encode the real and predicted values for the two networks individually.</p>
<p>The discriminator will get two losses - one for identifying fake images as fake, and one for identifying real MNIST images as real images.</p>
<p>The generator will just get one loss - was it able to deceive the discriminator?</p>
<div class="sourceCode" id="cb904"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb904-1"><a href="gan.html#cb904-1" aria-hidden="true" tabindex="-1"></a>ce <span class="ot">=</span> tf<span class="sc">$</span>keras<span class="sc">$</span>losses<span class="sc">$</span><span class="fu">BinaryCrossentropy</span>(<span class="at">from_logits =</span> <span class="cn">TRUE</span>)</span>
<span id="cb904-2"><a href="gan.html#cb904-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb904-3"><a href="gan.html#cb904-3" aria-hidden="true" tabindex="-1"></a>loss_discriminator <span class="ot">=</span> <span class="cf">function</span>(real, fake){</span>
<span id="cb904-4"><a href="gan.html#cb904-4" aria-hidden="true" tabindex="-1"></a>  real_loss <span class="ot">=</span> <span class="fu">ce</span>(tf<span class="sc">$</span><span class="fu">ones_like</span>(real), real)</span>
<span id="cb904-5"><a href="gan.html#cb904-5" aria-hidden="true" tabindex="-1"></a>  fake_loss <span class="ot">=</span> <span class="fu">ce</span>(tf<span class="sc">$</span><span class="fu">zeros_like</span>(fake), fake)</span>
<span id="cb904-6"><a href="gan.html#cb904-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(real_loss <span class="sc">+</span> fake_loss)</span>
<span id="cb904-7"><a href="gan.html#cb904-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb904-8"><a href="gan.html#cb904-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb904-9"><a href="gan.html#cb904-9" aria-hidden="true" tabindex="-1"></a>loss_generator <span class="ot">=</span> <span class="cf">function</span>(fake){</span>
<span id="cb904-10"><a href="gan.html#cb904-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">ce</span>(tf<span class="sc">$</span><span class="fu">ones_like</span>(fake), fake))</span>
<span id="cb904-11"><a href="gan.html#cb904-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Each network will get its own optimizer (in a GAN the networks are treated independently):</p>
<div class="sourceCode" id="cb905"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb905-1"><a href="gan.html#cb905-1" aria-hidden="true" tabindex="-1"></a>gen_opt <span class="ot">=</span> tf<span class="sc">$</span>keras<span class="sc">$</span>optimizers<span class="sc">$</span><span class="fu">RMSprop</span>(<span class="fl">1e-4</span>)</span>
<span id="cb905-2"><a href="gan.html#cb905-2" aria-hidden="true" tabindex="-1"></a>disc_opt <span class="ot">=</span> tf<span class="sc">$</span>keras<span class="sc">$</span>optimizers<span class="sc">$</span><span class="fu">RMSprop</span>(<span class="fl">1e-4</span>)</span></code></pre></div>
<p>We have to write our own training loop here (we cannot use the fit function).
In each iteration (for each batch) we will do the following (the GradientTape records computations to do automatic differentiation):</p>
<ol style="list-style-type: decimal">
<li>Sample noise.</li>
<li>Generator creates images from the noise.</li>
<li>Discriminator makes predictions for fake images and real images (response is a probability between [0,1]).</li>
<li>Calculate loss for generator.</li>
<li>Calculate loss for discriminator.</li>
<li>Calculate gradients for weights and the loss.</li>
<li>Update weights of generator.</li>
<li>Update weights of discriminator.</li>
<li>Return losses.</li>
</ol>
<div class="sourceCode" id="cb906"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb906-1"><a href="gan.html#cb906-1" aria-hidden="true" tabindex="-1"></a>generator <span class="ot">=</span> <span class="fu">get_generator</span>()</span>
<span id="cb906-2"><a href="gan.html#cb906-2" aria-hidden="true" tabindex="-1"></a>discriminator <span class="ot">=</span> <span class="fu">get_discriminator</span>()</span>
<span id="cb906-3"><a href="gan.html#cb906-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb906-4"><a href="gan.html#cb906-4" aria-hidden="true" tabindex="-1"></a>train_step <span class="ot">=</span> <span class="cf">function</span>(images){</span>
<span id="cb906-5"><a href="gan.html#cb906-5" aria-hidden="true" tabindex="-1"></a>  noise <span class="ot">=</span> tf<span class="sc">$</span>random<span class="sc">$</span><span class="fu">normal</span>(<span class="fu">c</span>(128L, 100L))</span>
<span id="cb906-6"><a href="gan.html#cb906-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">with</span>(tf<span class="sc">$</span><span class="fu">GradientTape</span>(<span class="at">persistent =</span> <span class="cn">TRUE</span>) <span class="sc">%as%</span> tape,</span>
<span id="cb906-7"><a href="gan.html#cb906-7" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb906-8"><a href="gan.html#cb906-8" aria-hidden="true" tabindex="-1"></a>      gen_images <span class="ot">=</span> <span class="fu">generator</span>(noise)</span>
<span id="cb906-9"><a href="gan.html#cb906-9" aria-hidden="true" tabindex="-1"></a>      fake_output <span class="ot">=</span> <span class="fu">discriminator</span>(gen_images)</span>
<span id="cb906-10"><a href="gan.html#cb906-10" aria-hidden="true" tabindex="-1"></a>      real_output <span class="ot">=</span> <span class="fu">discriminator</span>(images)</span>
<span id="cb906-11"><a href="gan.html#cb906-11" aria-hidden="true" tabindex="-1"></a>      gen_loss <span class="ot">=</span> <span class="fu">loss_generator</span>(fake_output)</span>
<span id="cb906-12"><a href="gan.html#cb906-12" aria-hidden="true" tabindex="-1"></a>      disc_loss <span class="ot">=</span> <span class="fu">loss_discriminator</span>(real_output, fake_output)</span>
<span id="cb906-13"><a href="gan.html#cb906-13" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb906-14"><a href="gan.html#cb906-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb906-15"><a href="gan.html#cb906-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb906-16"><a href="gan.html#cb906-16" aria-hidden="true" tabindex="-1"></a>  gen_grads <span class="ot">=</span> tape<span class="sc">$</span><span class="fu">gradient</span>(gen_loss, generator<span class="sc">$</span>weights)</span>
<span id="cb906-17"><a href="gan.html#cb906-17" aria-hidden="true" tabindex="-1"></a>  disc_grads <span class="ot">=</span> tape<span class="sc">$</span><span class="fu">gradient</span>(disc_loss, discriminator<span class="sc">$</span>weights)</span>
<span id="cb906-18"><a href="gan.html#cb906-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(tape)</span>
<span id="cb906-19"><a href="gan.html#cb906-19" aria-hidden="true" tabindex="-1"></a>  gen_opt<span class="sc">$</span><span class="fu">apply_gradients</span>(purrr<span class="sc">::</span><span class="fu">transpose</span>(<span class="fu">list</span>(gen_grads, generator<span class="sc">$</span>weights)))</span>
<span id="cb906-20"><a href="gan.html#cb906-20" aria-hidden="true" tabindex="-1"></a>  disc_opt<span class="sc">$</span><span class="fu">apply_gradients</span>(purrr<span class="sc">::</span><span class="fu">transpose</span>(<span class="fu">list</span>(disc_grads, discriminator<span class="sc">$</span>weights)))</span>
<span id="cb906-21"><a href="gan.html#cb906-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb906-22"><a href="gan.html#cb906-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">c</span>(gen_loss, disc_loss))</span>
<span id="cb906-23"><a href="gan.html#cb906-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb906-24"><a href="gan.html#cb906-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb906-25"><a href="gan.html#cb906-25" aria-hidden="true" tabindex="-1"></a>train_step <span class="ot">=</span> tf<span class="sc">$</span><span class="st">`</span><span class="at">function</span><span class="st">`</span>(reticulate<span class="sc">::</span><span class="fu">py_func</span>(train_step))</span></code></pre></div>
<p>Now we can finally train our networks in a training loop:</p>
<ol style="list-style-type: decimal">
<li>Create networks.</li>
<li>Get batch of images.</li>
<li>Run train_step function.</li>
<li>Print losses.</li>
<li>Repeat step 2-4 for number of epochs.</li>
</ol>
<div class="sourceCode" id="cb907"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb907-1"><a href="gan.html#cb907-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tensorflow)</span>
<span id="cb907-2"><a href="gan.html#cb907-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(keras)</span>
<span id="cb907-3"><a href="gan.html#cb907-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set_random_seed</span>(321L, <span class="at">disable_gpu =</span> <span class="cn">FALSE</span>)  <span class="co"># Already sets R&#39;s random seed.</span></span>
<span id="cb907-4"><a href="gan.html#cb907-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb907-5"><a href="gan.html#cb907-5" aria-hidden="true" tabindex="-1"></a>batch_size <span class="ot">=</span> 128L</span>
<span id="cb907-6"><a href="gan.html#cb907-6" aria-hidden="true" tabindex="-1"></a>epochs <span class="ot">=</span> 20L</span>
<span id="cb907-7"><a href="gan.html#cb907-7" aria-hidden="true" tabindex="-1"></a>steps <span class="ot">=</span> <span class="fu">as.integer</span>(<span class="fu">nrow</span>(train_x)<span class="sc">/</span>batch_size)</span>
<span id="cb907-8"><a href="gan.html#cb907-8" aria-hidden="true" tabindex="-1"></a>counter <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb907-9"><a href="gan.html#cb907-9" aria-hidden="true" tabindex="-1"></a>gen_loss <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb907-10"><a href="gan.html#cb907-10" aria-hidden="true" tabindex="-1"></a>disc_loss <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb907-11"><a href="gan.html#cb907-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb907-12"><a href="gan.html#cb907-12" aria-hidden="true" tabindex="-1"></a>dataset2 <span class="ot">=</span> dataset<span class="sc">$</span><span class="fu">prefetch</span>(tf<span class="sc">$</span>data<span class="sc">$</span>AUTOTUNE)</span>
<span id="cb907-13"><a href="gan.html#cb907-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb907-14"><a href="gan.html#cb907-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(e <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>epochs){</span>
<span id="cb907-15"><a href="gan.html#cb907-15" aria-hidden="true" tabindex="-1"></a>  dat <span class="ot">=</span> reticulate<span class="sc">::</span><span class="fu">as_iterator</span>(dataset2<span class="sc">$</span><span class="fu">batch</span>(batch_size))</span>
<span id="cb907-16"><a href="gan.html#cb907-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb907-17"><a href="gan.html#cb907-17" aria-hidden="true" tabindex="-1"></a>  coro<span class="sc">::</span><span class="fu">loop</span>(</span>
<span id="cb907-18"><a href="gan.html#cb907-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(images <span class="cf">in</span> dat){</span>
<span id="cb907-19"><a href="gan.html#cb907-19" aria-hidden="true" tabindex="-1"></a>      losses <span class="ot">=</span> <span class="fu">train_step</span>(images)</span>
<span id="cb907-20"><a href="gan.html#cb907-20" aria-hidden="true" tabindex="-1"></a>      gen_loss <span class="ot">=</span> <span class="fu">c</span>(gen_loss, tf<span class="sc">$</span><span class="fu">reduce_sum</span>(losses[[<span class="dv">1</span>]])<span class="sc">$</span><span class="fu">numpy</span>())</span>
<span id="cb907-21"><a href="gan.html#cb907-21" aria-hidden="true" tabindex="-1"></a>      disc_loss <span class="ot">=</span> <span class="fu">c</span>(disc_loss, tf<span class="sc">$</span><span class="fu">reduce_sum</span>(losses[[<span class="dv">2</span>]])<span class="sc">$</span><span class="fu">numpy</span>())</span>
<span id="cb907-22"><a href="gan.html#cb907-22" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb907-23"><a href="gan.html#cb907-23" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb907-24"><a href="gan.html#cb907-24" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb907-25"><a href="gan.html#cb907-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(epochs <span class="sc">%%</span> <span class="dv">5</span> <span class="sc">==</span> <span class="dv">0</span>){ <span class="co">#Print output every 5 steps.</span></span>
<span id="cb907-26"><a href="gan.html#cb907-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">&quot;Gen: &quot;</span>, <span class="fu">mean</span>(gen_loss), <span class="st">&quot; Disc: &quot;</span>, <span class="fu">mean</span>(disc_loss), <span class="st">&quot; </span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb907-27"><a href="gan.html#cb907-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb907-28"><a href="gan.html#cb907-28" aria-hidden="true" tabindex="-1"></a>  noise <span class="ot">=</span> tf<span class="sc">$</span>random<span class="sc">$</span><span class="fu">normal</span>(<span class="fu">c</span>(1L, 100L))</span>
<span id="cb907-29"><a href="gan.html#cb907-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(epochs <span class="sc">%%</span> <span class="dv">10</span> <span class="sc">==</span> <span class="dv">0</span>){  <span class="co">#Plot image every 10 steps.</span></span>
<span id="cb907-30"><a href="gan.html#cb907-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">imgPlot</span>(<span class="fu">array</span>(<span class="fu">generator</span>(noise)<span class="sc">$</span><span class="fu">numpy</span>(), <span class="fu">c</span>(28L, 28L)), <span class="st">&quot;Gen&quot;</span>)</span>
<span id="cb907-31"><a href="gan.html#cb907-31" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb907-32"><a href="gan.html#cb907-32" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## Gen:  0.6883632  Disc:  1.086055</code></pre>
<p><img src="_main_files/figure-html/chunk_chapter7_30-1.png" width="672" /></p>
<pre><code>## Gen:  0.7164299  Disc:  1.163737</code></pre>
<p><img src="_main_files/figure-html/chunk_chapter7_30-2.png" width="672" /></p>
<pre><code>## Gen:  0.7246124  Disc:  1.169931</code></pre>
<p><img src="_main_files/figure-html/chunk_chapter7_30-3.png" width="672" /></p>
<pre><code>## Gen:  0.7456345  Disc:  1.170835</code></pre>
<p><img src="_main_files/figure-html/chunk_chapter7_30-4.png" width="672" /></p>
<pre><code>## Gen:  0.7647617  Disc:  1.166425</code></pre>
<p><img src="_main_files/figure-html/chunk_chapter7_30-5.png" width="672" /></p>
<pre><code>## Gen:  0.7748129  Disc:  1.182352</code></pre>
<p><img src="_main_files/figure-html/chunk_chapter7_30-6.png" width="672" /></p>
<pre><code>## Gen:  0.854375  Disc:  1.087074</code></pre>
<p><img src="_main_files/figure-html/chunk_chapter7_30-7.png" width="672" /></p>
<pre><code>## Gen:  0.88686  Disc:  1.14963</code></pre>
<p><img src="_main_files/figure-html/chunk_chapter7_30-8.png" width="672" /></p>
<pre><code>## Gen:  0.8885204  Disc:  1.210371</code></pre>
<p><img src="_main_files/figure-html/chunk_chapter7_30-9.png" width="672" /></p>
<pre><code>## Gen:  0.8914993  Disc:  1.249861</code></pre>
<p><img src="_main_files/figure-html/chunk_chapter7_30-10.png" width="672" /></p>
<pre><code>## Gen:  0.8898634  Disc:  1.284225</code></pre>
<p><img src="_main_files/figure-html/chunk_chapter7_30-11.png" width="672" /></p>
<pre><code>## Gen:  0.8886764  Disc:  1.306691</code></pre>
<p><img src="_main_files/figure-html/chunk_chapter7_30-12.png" width="672" /></p>
<pre><code>## Gen:  0.8881942  Disc:  1.322189</code></pre>
<p><img src="_main_files/figure-html/chunk_chapter7_30-13.png" width="672" /></p>
<pre><code>## Gen:  0.888625  Disc:  1.332328</code></pre>
<p><img src="_main_files/figure-html/chunk_chapter7_30-14.png" width="672" /></p>
<pre><code>## Gen:  0.8893886  Disc:  1.33952</code></pre>
<p><img src="_main_files/figure-html/chunk_chapter7_30-15.png" width="672" /></p>
<pre><code>## Gen:  0.890981  Disc:  1.344293</code></pre>
<p><img src="_main_files/figure-html/chunk_chapter7_30-16.png" width="672" /></p>
<pre><code>## Gen:  0.8932191  Disc:  1.346911</code></pre>
<p><img src="_main_files/figure-html/chunk_chapter7_30-17.png" width="672" /></p>
<pre><code>## Gen:  0.8957275  Disc:  1.34975</code></pre>
<p><img src="_main_files/figure-html/chunk_chapter7_30-18.png" width="672" /></p>
<pre><code>## Gen:  0.900085  Disc:  1.351894</code></pre>
<p><img src="_main_files/figure-html/chunk_chapter7_30-19.png" width="672" /></p>
<pre><code>## Gen:  0.9044505  Disc:  1.35396</code></pre>
<p><img src="_main_files/figure-html/chunk_chapter7_30-20.png" width="672" /></p>
</div>
<div id="flower---gan" class="section level3" number="7.2.2">
<h3><span class="header-section-number">7.2.2</span> Flower - GAN</h3>
<p>We can now also do the same for the flower data set. We will write this completely on our own following the steps also done for the MNIST data set.</p>
<div class="sourceCode" id="cb928"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb928-1"><a href="gan.html#cb928-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(keras)</span>
<span id="cb928-2"><a href="gan.html#cb928-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb928-3"><a href="gan.html#cb928-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tensorflow)</span>
<span id="cb928-4"><a href="gan.html#cb928-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(EcoData)</span>
<span id="cb928-5"><a href="gan.html#cb928-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb928-6"><a href="gan.html#cb928-6" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> EcoData<span class="sc">::</span><span class="fu">dataset_flower</span>()</span>
<span id="cb928-7"><a href="gan.html#cb928-7" aria-hidden="true" tabindex="-1"></a>train <span class="ot">=</span> (data<span class="sc">$</span>train<span class="fl">-127.5</span>)<span class="sc">/</span><span class="fl">127.5</span></span>
<span id="cb928-8"><a href="gan.html#cb928-8" aria-hidden="true" tabindex="-1"></a>test <span class="ot">=</span> (data<span class="sc">$</span>test<span class="fl">-127.5</span>)<span class="sc">/</span><span class="fl">127.5</span></span>
<span id="cb928-9"><a href="gan.html#cb928-9" aria-hidden="true" tabindex="-1"></a>train_x <span class="ot">=</span> abind<span class="sc">::</span><span class="fu">abind</span>(<span class="fu">list</span>(train, test), <span class="at">along =</span> 1L)</span>
<span id="cb928-10"><a href="gan.html#cb928-10" aria-hidden="true" tabindex="-1"></a>dataset <span class="ot">=</span> tf<span class="sc">$</span>data<span class="sc">$</span>Dataset<span class="sc">$</span><span class="fu">from_tensor_slices</span>(tf<span class="sc">$</span><span class="fu">constant</span>(train_x, <span class="st">&quot;float32&quot;</span>))</span></code></pre></div>
<p>Define the generator model and test it:</p>
<div class="sourceCode" id="cb929"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb929-1"><a href="gan.html#cb929-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tensorflow)</span>
<span id="cb929-2"><a href="gan.html#cb929-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(keras)</span>
<span id="cb929-3"><a href="gan.html#cb929-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set_random_seed</span>(321L, <span class="at">disable_gpu =</span> <span class="cn">FALSE</span>)  <span class="co"># Already sets R&#39;s random seed.</span></span>
<span id="cb929-4"><a href="gan.html#cb929-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb929-5"><a href="gan.html#cb929-5" aria-hidden="true" tabindex="-1"></a>get_generator <span class="ot">=</span> <span class="cf">function</span>(){</span>
<span id="cb929-6"><a href="gan.html#cb929-6" aria-hidden="true" tabindex="-1"></a>  generator <span class="ot">=</span> <span class="fu">keras_model_sequential</span>()</span>
<span id="cb929-7"><a href="gan.html#cb929-7" aria-hidden="true" tabindex="-1"></a>  generator <span class="sc">%&gt;%</span> </span>
<span id="cb929-8"><a href="gan.html#cb929-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_dense</span>(<span class="at">units =</span> 20L<span class="sc">*</span>20L<span class="sc">*</span>128L, <span class="at">input_shape =</span> <span class="fu">c</span>(100L),</span>
<span id="cb929-9"><a href="gan.html#cb929-9" aria-hidden="true" tabindex="-1"></a>                <span class="at">use_bias =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb929-10"><a href="gan.html#cb929-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_activation_leaky_relu</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb929-11"><a href="gan.html#cb929-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_reshape</span>(<span class="fu">c</span>(20L, 20L, 128L)) <span class="sc">%&gt;%</span> </span>
<span id="cb929-12"><a href="gan.html#cb929-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_dropout</span>(<span class="fl">0.3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb929-13"><a href="gan.html#cb929-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_conv_2d_transpose</span>(<span class="at">filters =</span> 256L, <span class="at">kernel_size =</span> <span class="fu">c</span>(3L, 3L),</span>
<span id="cb929-14"><a href="gan.html#cb929-14" aria-hidden="true" tabindex="-1"></a>                            <span class="at">padding =</span> <span class="st">&quot;same&quot;</span>, <span class="at">strides =</span> <span class="fu">c</span>(1L, 1L),</span>
<span id="cb929-15"><a href="gan.html#cb929-15" aria-hidden="true" tabindex="-1"></a>                            <span class="at">use_bias =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb929-16"><a href="gan.html#cb929-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_activation_leaky_relu</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb929-17"><a href="gan.html#cb929-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_dropout</span>(<span class="fl">0.3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb929-18"><a href="gan.html#cb929-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_conv_2d_transpose</span>(<span class="at">filters =</span> 128L, <span class="at">kernel_size =</span> <span class="fu">c</span>(5L, 5L),</span>
<span id="cb929-19"><a href="gan.html#cb929-19" aria-hidden="true" tabindex="-1"></a>                            <span class="at">padding =</span> <span class="st">&quot;same&quot;</span>, <span class="at">strides =</span> <span class="fu">c</span>(1L, 1L),</span>
<span id="cb929-20"><a href="gan.html#cb929-20" aria-hidden="true" tabindex="-1"></a>                            <span class="at">use_bias =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb929-21"><a href="gan.html#cb929-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_activation_leaky_relu</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb929-22"><a href="gan.html#cb929-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_dropout</span>(<span class="fl">0.3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb929-23"><a href="gan.html#cb929-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_conv_2d_transpose</span>(<span class="at">filters =</span> 64L, <span class="at">kernel_size =</span> <span class="fu">c</span>(5L, 5L),</span>
<span id="cb929-24"><a href="gan.html#cb929-24" aria-hidden="true" tabindex="-1"></a>                            <span class="at">padding =</span> <span class="st">&quot;same&quot;</span>, <span class="at">strides =</span> <span class="fu">c</span>(2L, 2L),</span>
<span id="cb929-25"><a href="gan.html#cb929-25" aria-hidden="true" tabindex="-1"></a>                            <span class="at">use_bias =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb929-26"><a href="gan.html#cb929-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_activation_leaky_relu</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb929-27"><a href="gan.html#cb929-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_dropout</span>(<span class="fl">0.3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb929-28"><a href="gan.html#cb929-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_conv_2d_transpose</span>(<span class="at">filters =</span> 3L, <span class="at">kernel_size =</span> <span class="fu">c</span>(5L, 5L),</span>
<span id="cb929-29"><a href="gan.html#cb929-29" aria-hidden="true" tabindex="-1"></a>                            <span class="at">padding =</span> <span class="st">&quot;same&quot;</span>, <span class="at">strides =</span> <span class="fu">c</span>(2L, 2L),</span>
<span id="cb929-30"><a href="gan.html#cb929-30" aria-hidden="true" tabindex="-1"></a>                            <span class="at">activation =</span> <span class="st">&quot;tanh&quot;</span>, <span class="at">use_bias =</span> <span class="cn">FALSE</span>)</span>
<span id="cb929-31"><a href="gan.html#cb929-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(generator)</span>
<span id="cb929-32"><a href="gan.html#cb929-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb929-33"><a href="gan.html#cb929-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb929-34"><a href="gan.html#cb929-34" aria-hidden="true" tabindex="-1"></a>generator <span class="ot">=</span> <span class="fu">get_generator</span>()</span>
<span id="cb929-35"><a href="gan.html#cb929-35" aria-hidden="true" tabindex="-1"></a>image <span class="ot">=</span> <span class="fu">generator</span>(tf<span class="sc">$</span>random<span class="sc">$</span><span class="fu">normal</span>(<span class="fu">c</span>(1L,100L)))<span class="sc">$</span><span class="fu">numpy</span>()[<span class="dv">1</span>,,,]</span>
<span id="cb929-36"><a href="gan.html#cb929-36" aria-hidden="true" tabindex="-1"></a>image <span class="ot">=</span> scales<span class="sc">::</span><span class="fu">rescale</span>(image, <span class="at">to =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">255</span>))</span>
<span id="cb929-37"><a href="gan.html#cb929-37" aria-hidden="true" tabindex="-1"></a>image <span class="sc">%&gt;%</span> </span>
<span id="cb929-38"><a href="gan.html#cb929-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">image_to_array</span>() <span class="sc">%&gt;%</span></span>
<span id="cb929-39"><a href="gan.html#cb929-39" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">/</span><span class="st">`</span>(., <span class="dv">255</span>) <span class="sc">%&gt;%</span></span>
<span id="cb929-40"><a href="gan.html#cb929-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.raster</span>() <span class="sc">%&gt;%</span></span>
<span id="cb929-41"><a href="gan.html#cb929-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/chunk_chapter7_32-1.png" width="672" /></p>
<p>Define the discriminator and test it:</p>
<div class="sourceCode" id="cb930"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb930-1"><a href="gan.html#cb930-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tensorflow)</span>
<span id="cb930-2"><a href="gan.html#cb930-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(keras)</span>
<span id="cb930-3"><a href="gan.html#cb930-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set_random_seed</span>(321L, <span class="at">disable_gpu =</span> <span class="cn">FALSE</span>)  <span class="co"># Already sets R&#39;s random seed.</span></span>
<span id="cb930-4"><a href="gan.html#cb930-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb930-5"><a href="gan.html#cb930-5" aria-hidden="true" tabindex="-1"></a>get_discriminator <span class="ot">=</span> <span class="cf">function</span>(){</span>
<span id="cb930-6"><a href="gan.html#cb930-6" aria-hidden="true" tabindex="-1"></a>  discriminator <span class="ot">=</span> <span class="fu">keras_model_sequential</span>()</span>
<span id="cb930-7"><a href="gan.html#cb930-7" aria-hidden="true" tabindex="-1"></a>  discriminator <span class="sc">%&gt;%</span> </span>
<span id="cb930-8"><a href="gan.html#cb930-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_conv_2d</span>(<span class="at">filters =</span> 64L, <span class="at">kernel_size =</span> <span class="fu">c</span>(5L, 5L),</span>
<span id="cb930-9"><a href="gan.html#cb930-9" aria-hidden="true" tabindex="-1"></a>                  <span class="at">strides =</span> <span class="fu">c</span>(2L, 2L), <span class="at">padding =</span> <span class="st">&quot;same&quot;</span>,</span>
<span id="cb930-10"><a href="gan.html#cb930-10" aria-hidden="true" tabindex="-1"></a>                  <span class="at">input_shape =</span> <span class="fu">c</span>(80L, 80L, 3L)) <span class="sc">%&gt;%</span></span>
<span id="cb930-11"><a href="gan.html#cb930-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_activation_leaky_relu</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb930-12"><a href="gan.html#cb930-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_dropout</span>(<span class="fl">0.3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb930-13"><a href="gan.html#cb930-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_conv_2d</span>(<span class="at">filters =</span> 128L, <span class="at">kernel_size =</span> <span class="fu">c</span>(5L, 5L),</span>
<span id="cb930-14"><a href="gan.html#cb930-14" aria-hidden="true" tabindex="-1"></a>                  <span class="at">strides =</span> <span class="fu">c</span>(2L, 2L), <span class="at">padding =</span> <span class="st">&quot;same&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb930-15"><a href="gan.html#cb930-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_activation_leaky_relu</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb930-16"><a href="gan.html#cb930-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_dropout</span>(<span class="fl">0.3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb930-17"><a href="gan.html#cb930-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_conv_2d</span>(<span class="at">filters =</span> 256L, <span class="at">kernel_size =</span> <span class="fu">c</span>(3L, 3L),</span>
<span id="cb930-18"><a href="gan.html#cb930-18" aria-hidden="true" tabindex="-1"></a>                  <span class="at">strides =</span> <span class="fu">c</span>(2L, 2L), <span class="at">padding =</span> <span class="st">&quot;same&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb930-19"><a href="gan.html#cb930-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_activation_leaky_relu</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb930-20"><a href="gan.html#cb930-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_dropout</span>(<span class="fl">0.3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb930-21"><a href="gan.html#cb930-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_flatten</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb930-22"><a href="gan.html#cb930-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">layer_dense</span>(<span class="at">units =</span> 1L, <span class="at">activation =</span> <span class="st">&quot;sigmoid&quot;</span>)</span>
<span id="cb930-23"><a href="gan.html#cb930-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(discriminator)</span>
<span id="cb930-24"><a href="gan.html#cb930-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb930-25"><a href="gan.html#cb930-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb930-26"><a href="gan.html#cb930-26" aria-hidden="true" tabindex="-1"></a>discriminator <span class="ot">=</span> <span class="fu">get_discriminator</span>()</span>
<span id="cb930-27"><a href="gan.html#cb930-27" aria-hidden="true" tabindex="-1"></a>discriminator</span></code></pre></div>
<pre><code>## Model
## Model: &quot;sequential_72&quot;
## __________________________________________________________________________________________________________________
##  Layer (type)                                      Output Shape                                 Param #           
## ==================================================================================================================
##  conv2d_47 (Conv2D)                                (None, 40, 40, 64)                           4864              
##                                                                                                                   
##  leaky_re_lu_14 (LeakyReLU)                        (None, 40, 40, 64)                           0                 
##                                                                                                                   
##  dropout_106 (Dropout)                             (None, 40, 40, 64)                           0                 
##                                                                                                                   
##  conv2d_46 (Conv2D)                                (None, 20, 20, 128)                          204928            
##                                                                                                                   
##  leaky_re_lu_13 (LeakyReLU)                        (None, 20, 20, 128)                          0                 
##                                                                                                                   
##  dropout_105 (Dropout)                             (None, 20, 20, 128)                          0                 
##                                                                                                                   
##  conv2d_45 (Conv2D)                                (None, 10, 10, 256)                          295168            
##                                                                                                                   
##  leaky_re_lu_12 (LeakyReLU)                        (None, 10, 10, 256)                          0                 
##                                                                                                                   
##  dropout_104 (Dropout)                             (None, 10, 10, 256)                          0                 
##                                                                                                                   
##  flatten_20 (Flatten)                              (None, 25600)                                0                 
##                                                                                                                   
##  dense_233 (Dense)                                 (None, 1)                                    25601             
##                                                                                                                   
## ==================================================================================================================
## Total params: 530,561
## Trainable params: 530,561
## Non-trainable params: 0
## __________________________________________________________________________________________________________________</code></pre>
<div class="sourceCode" id="cb932"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb932-1"><a href="gan.html#cb932-1" aria-hidden="true" tabindex="-1"></a><span class="fu">discriminator</span>(<span class="fu">generator</span>(tf<span class="sc">$</span>random<span class="sc">$</span><span class="fu">normal</span>(<span class="fu">c</span>(1L, 100L))))</span></code></pre></div>
<pre><code>## tf.Tensor([[0.4999608]], shape=(1, 1), dtype=float32)</code></pre>
<p>Define the loss functions:</p>
<div class="sourceCode" id="cb934"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb934-1"><a href="gan.html#cb934-1" aria-hidden="true" tabindex="-1"></a>ce <span class="ot">=</span> tf<span class="sc">$</span>keras<span class="sc">$</span>losses<span class="sc">$</span><span class="fu">BinaryCrossentropy</span>(<span class="at">from_logits =</span> <span class="cn">TRUE</span>,</span>
<span id="cb934-2"><a href="gan.html#cb934-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">label_smoothing =</span> <span class="fl">0.1</span>)</span>
<span id="cb934-3"><a href="gan.html#cb934-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb934-4"><a href="gan.html#cb934-4" aria-hidden="true" tabindex="-1"></a>loss_discriminator <span class="ot">=</span> <span class="cf">function</span>(real, fake){</span>
<span id="cb934-5"><a href="gan.html#cb934-5" aria-hidden="true" tabindex="-1"></a>  real_loss <span class="ot">=</span> <span class="fu">ce</span>(tf<span class="sc">$</span><span class="fu">ones_like</span>(real), real)</span>
<span id="cb934-6"><a href="gan.html#cb934-6" aria-hidden="true" tabindex="-1"></a>  fake_loss <span class="ot">=</span> <span class="fu">ce</span>(tf<span class="sc">$</span><span class="fu">zeros_like</span>(fake), fake)</span>
<span id="cb934-7"><a href="gan.html#cb934-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(real_loss<span class="sc">+</span>fake_loss)</span>
<span id="cb934-8"><a href="gan.html#cb934-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb934-9"><a href="gan.html#cb934-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb934-10"><a href="gan.html#cb934-10" aria-hidden="true" tabindex="-1"></a>loss_generator <span class="ot">=</span> <span class="cf">function</span>(fake){</span>
<span id="cb934-11"><a href="gan.html#cb934-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">ce</span>(tf<span class="sc">$</span><span class="fu">ones_like</span>(fake), fake))</span>
<span id="cb934-12"><a href="gan.html#cb934-12" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Define the optimizers and the batch function:</p>
<div class="sourceCode" id="cb935"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb935-1"><a href="gan.html#cb935-1" aria-hidden="true" tabindex="-1"></a>gen_opt <span class="ot">=</span> tf<span class="sc">$</span>keras<span class="sc">$</span>optimizers<span class="sc">$</span><span class="fu">RMSprop</span>(<span class="fl">1e-4</span>)</span>
<span id="cb935-2"><a href="gan.html#cb935-2" aria-hidden="true" tabindex="-1"></a>disc_opt <span class="ot">=</span> tf<span class="sc">$</span>keras<span class="sc">$</span>optimizers<span class="sc">$</span><span class="fu">RMSprop</span>(<span class="fl">1e-4</span>)</span></code></pre></div>
<p>Define functions for the generator and discriminator:</p>
<div class="sourceCode" id="cb936"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb936-1"><a href="gan.html#cb936-1" aria-hidden="true" tabindex="-1"></a>generator <span class="ot">=</span> <span class="fu">get_generator</span>()</span>
<span id="cb936-2"><a href="gan.html#cb936-2" aria-hidden="true" tabindex="-1"></a>discriminator <span class="ot">=</span> <span class="fu">get_discriminator</span>()</span>
<span id="cb936-3"><a href="gan.html#cb936-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb936-4"><a href="gan.html#cb936-4" aria-hidden="true" tabindex="-1"></a>train_step <span class="ot">=</span> <span class="cf">function</span>(images){</span>
<span id="cb936-5"><a href="gan.html#cb936-5" aria-hidden="true" tabindex="-1"></a>  noise <span class="ot">=</span> tf<span class="sc">$</span>random<span class="sc">$</span><span class="fu">normal</span>(<span class="fu">c</span>(32L, 100L))</span>
<span id="cb936-6"><a href="gan.html#cb936-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb936-7"><a href="gan.html#cb936-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">with</span>(tf<span class="sc">$</span><span class="fu">GradientTape</span>(<span class="at">persistent =</span> <span class="cn">TRUE</span>) <span class="sc">%as%</span> tape,</span>
<span id="cb936-8"><a href="gan.html#cb936-8" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb936-9"><a href="gan.html#cb936-9" aria-hidden="true" tabindex="-1"></a>      gen_images <span class="ot">=</span> <span class="fu">generator</span>(noise)</span>
<span id="cb936-10"><a href="gan.html#cb936-10" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb936-11"><a href="gan.html#cb936-11" aria-hidden="true" tabindex="-1"></a>      real_output <span class="ot">=</span> <span class="fu">discriminator</span>(images)</span>
<span id="cb936-12"><a href="gan.html#cb936-12" aria-hidden="true" tabindex="-1"></a>      fake_output <span class="ot">=</span> <span class="fu">discriminator</span>(gen_images)</span>
<span id="cb936-13"><a href="gan.html#cb936-13" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb936-14"><a href="gan.html#cb936-14" aria-hidden="true" tabindex="-1"></a>      gen_loss <span class="ot">=</span> <span class="fu">loss_generator</span>(fake_output)</span>
<span id="cb936-15"><a href="gan.html#cb936-15" aria-hidden="true" tabindex="-1"></a>      disc_loss <span class="ot">=</span> <span class="fu">loss_discriminator</span>(real_output, fake_output)</span>
<span id="cb936-16"><a href="gan.html#cb936-16" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb936-17"><a href="gan.html#cb936-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb936-18"><a href="gan.html#cb936-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb936-19"><a href="gan.html#cb936-19" aria-hidden="true" tabindex="-1"></a>  gen_grads <span class="ot">=</span> tape<span class="sc">$</span><span class="fu">gradient</span>(gen_loss, generator<span class="sc">$</span>weights)</span>
<span id="cb936-20"><a href="gan.html#cb936-20" aria-hidden="true" tabindex="-1"></a>  disc_grads <span class="ot">=</span> tape<span class="sc">$</span><span class="fu">gradient</span>(disc_loss, discriminator<span class="sc">$</span>weights)</span>
<span id="cb936-21"><a href="gan.html#cb936-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(tape)</span>
<span id="cb936-22"><a href="gan.html#cb936-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb936-23"><a href="gan.html#cb936-23" aria-hidden="true" tabindex="-1"></a>  gen_opt<span class="sc">$</span><span class="fu">apply_gradients</span>(purrr<span class="sc">::</span><span class="fu">transpose</span>(<span class="fu">list</span>(gen_grads,</span>
<span id="cb936-24"><a href="gan.html#cb936-24" aria-hidden="true" tabindex="-1"></a>                                                generator<span class="sc">$</span>weights)))</span>
<span id="cb936-25"><a href="gan.html#cb936-25" aria-hidden="true" tabindex="-1"></a>  disc_opt<span class="sc">$</span><span class="fu">apply_gradients</span>(purrr<span class="sc">::</span><span class="fu">transpose</span>(<span class="fu">list</span>(disc_grads,</span>
<span id="cb936-26"><a href="gan.html#cb936-26" aria-hidden="true" tabindex="-1"></a>                                                 discriminator<span class="sc">$</span>weights)))</span>
<span id="cb936-27"><a href="gan.html#cb936-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb936-28"><a href="gan.html#cb936-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">c</span>(gen_loss, disc_loss))</span>
<span id="cb936-29"><a href="gan.html#cb936-29" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb936-30"><a href="gan.html#cb936-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb936-31"><a href="gan.html#cb936-31" aria-hidden="true" tabindex="-1"></a>train_step <span class="ot">=</span> tf<span class="sc">$</span><span class="st">`</span><span class="at">function</span><span class="st">`</span>(reticulate<span class="sc">::</span><span class="fu">py_func</span>(train_step))</span></code></pre></div>
<p>Do the training:</p>
<div class="sourceCode" id="cb937"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb937-1"><a href="gan.html#cb937-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tensorflow)</span>
<span id="cb937-2"><a href="gan.html#cb937-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(keras)</span>
<span id="cb937-3"><a href="gan.html#cb937-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set_random_seed</span>(321L, <span class="at">disable_gpu =</span> <span class="cn">FALSE</span>)  <span class="co"># Already sets R&#39;s random seed.</span></span>
<span id="cb937-4"><a href="gan.html#cb937-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb937-5"><a href="gan.html#cb937-5" aria-hidden="true" tabindex="-1"></a>batch_size <span class="ot">=</span> 32L</span>
<span id="cb937-6"><a href="gan.html#cb937-6" aria-hidden="true" tabindex="-1"></a>epochs <span class="ot">=</span> 30L</span>
<span id="cb937-7"><a href="gan.html#cb937-7" aria-hidden="true" tabindex="-1"></a>steps <span class="ot">=</span> <span class="fu">as.integer</span>(<span class="fu">dim</span>(train_x)[<span class="dv">1</span>]<span class="sc">/</span>batch_size)</span>
<span id="cb937-8"><a href="gan.html#cb937-8" aria-hidden="true" tabindex="-1"></a>counter <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb937-9"><a href="gan.html#cb937-9" aria-hidden="true" tabindex="-1"></a>gen_loss <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb937-10"><a href="gan.html#cb937-10" aria-hidden="true" tabindex="-1"></a>disc_loss <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb937-11"><a href="gan.html#cb937-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb937-12"><a href="gan.html#cb937-12" aria-hidden="true" tabindex="-1"></a>dataset <span class="ot">=</span> dataset<span class="sc">$</span><span class="fu">prefetch</span>(tf<span class="sc">$</span>data<span class="sc">$</span>AUTOTUNE)</span>
<span id="cb937-13"><a href="gan.html#cb937-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb937-14"><a href="gan.html#cb937-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(e <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>epochs){</span>
<span id="cb937-15"><a href="gan.html#cb937-15" aria-hidden="true" tabindex="-1"></a>  dat <span class="ot">=</span> reticulate<span class="sc">::</span><span class="fu">as_iterator</span>(dataset<span class="sc">$</span><span class="fu">batch</span>(batch_size))</span>
<span id="cb937-16"><a href="gan.html#cb937-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb937-17"><a href="gan.html#cb937-17" aria-hidden="true" tabindex="-1"></a>  coro<span class="sc">::</span><span class="fu">loop</span>(</span>
<span id="cb937-18"><a href="gan.html#cb937-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(images <span class="cf">in</span> dat){</span>
<span id="cb937-19"><a href="gan.html#cb937-19" aria-hidden="true" tabindex="-1"></a>      losses <span class="ot">=</span> <span class="fu">train_step</span>(images)</span>
<span id="cb937-20"><a href="gan.html#cb937-20" aria-hidden="true" tabindex="-1"></a>      gen_loss <span class="ot">=</span> <span class="fu">c</span>(gen_loss, tf<span class="sc">$</span><span class="fu">reduce_sum</span>(losses[[<span class="dv">1</span>]])<span class="sc">$</span><span class="fu">numpy</span>())</span>
<span id="cb937-21"><a href="gan.html#cb937-21" aria-hidden="true" tabindex="-1"></a>      disc_loss <span class="ot">=</span> <span class="fu">c</span>(disc_loss, tf<span class="sc">$</span><span class="fu">reduce_sum</span>(losses[[<span class="dv">2</span>]])<span class="sc">$</span><span class="fu">numpy</span>())</span>
<span id="cb937-22"><a href="gan.html#cb937-22" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb937-23"><a href="gan.html#cb937-23" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb937-24"><a href="gan.html#cb937-24" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb937-25"><a href="gan.html#cb937-25" aria-hidden="true" tabindex="-1"></a>  noise <span class="ot">=</span> tf<span class="sc">$</span>random<span class="sc">$</span><span class="fu">normal</span>(<span class="fu">c</span>(1L, 100L))</span>
<span id="cb937-26"><a href="gan.html#cb937-26" aria-hidden="true" tabindex="-1"></a>  image <span class="ot">=</span> <span class="fu">generator</span>(noise)<span class="sc">$</span><span class="fu">numpy</span>()[<span class="dv">1</span>,,,]</span>
<span id="cb937-27"><a href="gan.html#cb937-27" aria-hidden="true" tabindex="-1"></a>  image <span class="ot">=</span> scales<span class="sc">::</span><span class="fu">rescale</span>(image, <span class="at">to =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">255</span>))</span>
<span id="cb937-28"><a href="gan.html#cb937-28" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(e <span class="sc">%%</span> <span class="dv">10</span> <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb937-29"><a href="gan.html#cb937-29" aria-hidden="true" tabindex="-1"></a>    image <span class="sc">%&gt;%</span> </span>
<span id="cb937-30"><a href="gan.html#cb937-30" aria-hidden="true" tabindex="-1"></a>      <span class="fu">image_to_array</span>() <span class="sc">%&gt;%</span></span>
<span id="cb937-31"><a href="gan.html#cb937-31" aria-hidden="true" tabindex="-1"></a>        <span class="st">`</span><span class="at">/</span><span class="st">`</span>(., <span class="dv">255</span>) <span class="sc">%&gt;%</span></span>
<span id="cb937-32"><a href="gan.html#cb937-32" aria-hidden="true" tabindex="-1"></a>        <span class="fu">as.raster</span>() <span class="sc">%&gt;%</span></span>
<span id="cb937-33"><a href="gan.html#cb937-33" aria-hidden="true" tabindex="-1"></a>        <span class="fu">plot</span>()</span>
<span id="cb937-34"><a href="gan.html#cb937-34" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb937-35"><a href="gan.html#cb937-35" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb937-36"><a href="gan.html#cb937-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;Gen: &quot;</span>, <span class="fu">mean</span>(gen_loss), <span class="st">&quot; Disc: &quot;</span>, <span class="fu">mean</span>(disc_loss), <span class="st">&quot; </span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb937-37"><a href="gan.html#cb937-37" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## Gen:  1.149357  Disc:  0.8001182  
## Gen:  1.5089  Disc:  0.7430979  
## Gen:  1.698984  Disc:  0.7419785  
## Gen:  1.790281  Disc:  0.7449237  
## Gen:  1.82084  Disc:  0.7540591  
## Gen:  1.796408  Disc:  0.7812456  
## Gen:  1.735721  Disc:  0.8152333  
## Gen:  1.655125  Disc:  0.8589529  
## Gen:  1.599357  Disc:  0.8842102</code></pre>
<p><img src="_main_files/figure-html/chunk_chapter7_37-1.png" width="672" /></p>
<pre><code>## Gen:  1.549184  Disc:  0.9052329  
## Gen:  1.504676  Disc:  0.9234332  
## Gen:  1.46387  Disc:  0.9415495  
## Gen:  1.439547  Disc:  0.9518118  
## Gen:  1.411166  Disc:  0.963441  
## Gen:  1.38764  Disc:  0.9735227  
## Gen:  1.361992  Disc:  0.9863029  
## Gen:  1.334074  Disc:  1.002124  
## Gen:  1.307651  Disc:  1.017834  
## Gen:  1.283841  Disc:  1.030556</code></pre>
<p><img src="_main_files/figure-html/chunk_chapter7_37-2.png" width="672" /></p>
<pre><code>## Gen:  1.262961  Disc:  1.041403  
## Gen:  1.245325  Disc:  1.049907  
## Gen:  1.228488  Disc:  1.058534  
## Gen:  1.213941  Disc:  1.065773  
## Gen:  1.199879  Disc:  1.072757  
## Gen:  1.187363  Disc:  1.078638  
## Gen:  1.176552  Disc:  1.083673  
## Gen:  1.16801  Disc:  1.086775  
## Gen:  1.161602  Disc:  1.089686  
## Gen:  1.15672  Disc:  1.091906</code></pre>
<p><img src="_main_files/figure-html/chunk_chapter7_37-3.png" width="672" /></p>
<pre><code>## Gen:  1.151876  Disc:  1.093815</code></pre>
<div class="sourceCode" id="cb942"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb942-1"><a href="gan.html#cb942-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tensorflow)</span>
<span id="cb942-2"><a href="gan.html#cb942-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(keras)</span>
<span id="cb942-3"><a href="gan.html#cb942-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set_random_seed</span>(321L, <span class="at">disable_gpu =</span> <span class="cn">FALSE</span>)  <span class="co"># Already sets R&#39;s random seed.</span></span>
<span id="cb942-4"><a href="gan.html#cb942-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb942-5"><a href="gan.html#cb942-5" aria-hidden="true" tabindex="-1"></a>noise <span class="ot">=</span> tf<span class="sc">$</span>random<span class="sc">$</span><span class="fu">normal</span>(<span class="fu">c</span>(1L, 100L))</span>
<span id="cb942-6"><a href="gan.html#cb942-6" aria-hidden="true" tabindex="-1"></a>image <span class="ot">=</span> <span class="fu">generator</span>(noise)<span class="sc">$</span><span class="fu">numpy</span>()[<span class="dv">1</span>,,,]</span>
<span id="cb942-7"><a href="gan.html#cb942-7" aria-hidden="true" tabindex="-1"></a>image <span class="ot">=</span> scales<span class="sc">::</span><span class="fu">rescale</span>(image, <span class="at">to =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">255</span>))</span>
<span id="cb942-8"><a href="gan.html#cb942-8" aria-hidden="true" tabindex="-1"></a>image <span class="sc">%&gt;%</span> </span>
<span id="cb942-9"><a href="gan.html#cb942-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">image_to_array</span>() <span class="sc">%&gt;%</span></span>
<span id="cb942-10"><a href="gan.html#cb942-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">/</span><span class="st">`</span>(., <span class="dv">255</span>) <span class="sc">%&gt;%</span></span>
<span id="cb942-11"><a href="gan.html#cb942-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.raster</span>() <span class="sc">%&gt;%</span></span>
<span id="cb942-12"><a href="gan.html#cb942-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/chunk_chapter7_38-1.png" width="672" /></p>
<p>More images:</p>
<p><img src="images/flower2.png" width="150%" height="150%" /><img src="images/flower3.png" width="150%" height="150%" /><img src="images/flower4.png" width="150%" height="150%" /><img src="images/flower5.png" width="150%" height="150%" /></p>
</div>
</div>
<div id="reinforcement-learning" class="section level2" number="7.3">
<h2><span class="header-section-number">7.3</span> Reinforcement learning</h2>
<p>This is just a teaser, run/adapt it if you like.</p>
<p>Objective: Train a neural network capable of balancing a pole.</p>
<p>The environment is run on a local server, please install <a href="https://github.com/openai/gym-http-api" target="_blank" rel="noopener">gym</a>.</p>
<p>Or go through this <a href="https://colab.research.google.com/github/tensorflow/agents/blob/master/docs/tutorials/6_reinforce_tutorial.ipynb" target="_blank" rel="noopener">colab book</a>.</p>
<div class="sourceCode" id="cb943"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb943-1"><a href="gan.html#cb943-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(keras)</span>
<span id="cb943-2"><a href="gan.html#cb943-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tensorflow)</span>
<span id="cb943-3"><a href="gan.html#cb943-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gym)</span>
<span id="cb943-4"><a href="gan.html#cb943-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set_random_seed</span>(321L, <span class="at">disable_gpu =</span> <span class="cn">FALSE</span>)  <span class="co"># Already sets R&#39;s random seed.</span></span>
<span id="cb943-5"><a href="gan.html#cb943-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb943-6"><a href="gan.html#cb943-6" aria-hidden="true" tabindex="-1"></a>remote_base <span class="ot">=</span>´ <span class="st">&quot;http://127.0.0.1:5000&quot;</span></span>
<span id="cb943-7"><a href="gan.html#cb943-7" aria-hidden="true" tabindex="-1"></a>client <span class="ot">=</span> <span class="fu">create_GymClient</span>(remote_base)</span>
<span id="cb943-8"><a href="gan.html#cb943-8" aria-hidden="true" tabindex="-1"></a>env <span class="ot">=</span> gym<span class="sc">::</span><span class="fu">env_create</span>(client, <span class="st">&quot;CartPole-v1&quot;</span>)</span>
<span id="cb943-9"><a href="gan.html#cb943-9" aria-hidden="true" tabindex="-1"></a>gym<span class="sc">::</span><span class="fu">env_list_all</span>(client)</span>
<span id="cb943-10"><a href="gan.html#cb943-10" aria-hidden="true" tabindex="-1"></a><span class="fu">env_reset</span>(client, env)</span>
<span id="cb943-11"><a href="gan.html#cb943-11" aria-hidden="true" tabindex="-1"></a><span class="co"># action = env_action_space_sample(client, env)</span></span>
<span id="cb943-12"><a href="gan.html#cb943-12" aria-hidden="true" tabindex="-1"></a>step <span class="ot">=</span> <span class="fu">env_step</span>(client, env, <span class="dv">1</span>)</span>
<span id="cb943-13"><a href="gan.html#cb943-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb943-14"><a href="gan.html#cb943-14" aria-hidden="true" tabindex="-1"></a><span class="fu">env_reset</span>(client, env)</span>
<span id="cb943-15"><a href="gan.html#cb943-15" aria-hidden="true" tabindex="-1"></a>goal_steps <span class="ot">=</span> <span class="dv">500</span></span>
<span id="cb943-16"><a href="gan.html#cb943-16" aria-hidden="true" tabindex="-1"></a>score_requirement <span class="ot">=</span> <span class="dv">60</span></span>
<span id="cb943-17"><a href="gan.html#cb943-17" aria-hidden="true" tabindex="-1"></a>intial_games <span class="ot">=</span> <span class="dv">1000</span></span>
<span id="cb943-18"><a href="gan.html#cb943-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb943-19"><a href="gan.html#cb943-19" aria-hidden="true" tabindex="-1"></a>state_size <span class="ot">=</span> 4L</span>
<span id="cb943-20"><a href="gan.html#cb943-20" aria-hidden="true" tabindex="-1"></a>action_size <span class="ot">=</span> 2L</span>
<span id="cb943-21"><a href="gan.html#cb943-21" aria-hidden="true" tabindex="-1"></a>gamma <span class="ot">=</span> <span class="fl">0.95</span></span>
<span id="cb943-22"><a href="gan.html#cb943-22" aria-hidden="true" tabindex="-1"></a>epsilon <span class="ot">=</span> <span class="fl">0.95</span></span>
<span id="cb943-23"><a href="gan.html#cb943-23" aria-hidden="true" tabindex="-1"></a>epsilon_min <span class="ot">=</span> <span class="fl">0.01</span></span>
<span id="cb943-24"><a href="gan.html#cb943-24" aria-hidden="true" tabindex="-1"></a>epsilon_decay <span class="ot">=</span> <span class="fl">0.995</span></span>
<span id="cb943-25"><a href="gan.html#cb943-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb943-26"><a href="gan.html#cb943-26" aria-hidden="true" tabindex="-1"></a>model <span class="ot">=</span> <span class="fu">keras_model_sequential</span>()</span>
<span id="cb943-27"><a href="gan.html#cb943-27" aria-hidden="true" tabindex="-1"></a>model <span class="sc">%&gt;%</span> </span>
<span id="cb943-28"><a href="gan.html#cb943-28" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_dense</span>(<span class="at">input_shape =</span> <span class="fu">c</span>(4L), <span class="at">units =</span> 20L, <span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb943-29"><a href="gan.html#cb943-29" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_dense</span>(<span class="at">units =</span> 20L, <span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb943-30"><a href="gan.html#cb943-30" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_dense</span>(2L, <span class="at">activation =</span> <span class="st">&quot;linear&quot;</span>)</span>
<span id="cb943-31"><a href="gan.html#cb943-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb943-32"><a href="gan.html#cb943-32" aria-hidden="true" tabindex="-1"></a>model <span class="sc">%&gt;%</span> </span>
<span id="cb943-33"><a href="gan.html#cb943-33" aria-hidden="true" tabindex="-1"></a> keras<span class="sc">::</span><span class="fu">compile</span>(<span class="at">loss =</span> loss_mean_squared_error, <span class="at">optimizer =</span> <span class="fu">optimizer_adamax</span>())</span>
<span id="cb943-34"><a href="gan.html#cb943-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb943-35"><a href="gan.html#cb943-35" aria-hidden="true" tabindex="-1"></a>memory <span class="ot">=</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> 8000L, 11L)</span>
<span id="cb943-36"><a href="gan.html#cb943-36" aria-hidden="true" tabindex="-1"></a>counter <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb943-37"><a href="gan.html#cb943-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb943-38"><a href="gan.html#cb943-38" aria-hidden="true" tabindex="-1"></a>remember <span class="ot">=</span> <span class="cf">function</span>(memory, state, action, reward, next_state, done){</span>
<span id="cb943-39"><a href="gan.html#cb943-39" aria-hidden="true" tabindex="-1"></a>  memory[counter,] <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="fu">c</span>(state, action, reward, next_state, done))</span>
<span id="cb943-40"><a href="gan.html#cb943-40" aria-hidden="true" tabindex="-1"></a>  counter <span class="ot">&lt;&lt;-</span> counter<span class="sc">+</span><span class="dv">1</span></span>
<span id="cb943-41"><a href="gan.html#cb943-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(memory)</span>
<span id="cb943-42"><a href="gan.html#cb943-42" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb943-43"><a href="gan.html#cb943-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb943-44"><a href="gan.html#cb943-44" aria-hidden="true" tabindex="-1"></a><span class="co"># memory: state 1:4, action 5, reward 6, next_state 7:10, done 11</span></span>
<span id="cb943-45"><a href="gan.html#cb943-45" aria-hidden="true" tabindex="-1"></a>act <span class="ot">=</span> <span class="cf">function</span>(state){</span>
<span id="cb943-46"><a href="gan.html#cb943-46" aria-hidden="true" tabindex="-1"></a> <span class="cf">if</span>(<span class="fu">runif</span>(<span class="dv">1</span>) <span class="sc">&lt;=</span> epsilon){ <span class="fu">return</span>(<span class="fu">sample</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="dv">1</span>)) }</span>
<span id="cb943-47"><a href="gan.html#cb943-47" aria-hidden="true" tabindex="-1"></a> act_prob <span class="ot">=</span> <span class="fu">predict</span>(model, <span class="fu">matrix</span>(state, <span class="at">nrow =</span> 1L))</span>
<span id="cb943-48"><a href="gan.html#cb943-48" aria-hidden="true" tabindex="-1"></a> <span class="fu">return</span>(<span class="fu">which.max</span>(act_prob) <span class="sc">-</span> 1L)</span>
<span id="cb943-49"><a href="gan.html#cb943-49" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb943-50"><a href="gan.html#cb943-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb943-51"><a href="gan.html#cb943-51" aria-hidden="true" tabindex="-1"></a>replay <span class="ot">=</span> <span class="cf">function</span>(<span class="at">batch_size =</span> 25L, memory, counter){</span>
<span id="cb943-52"><a href="gan.html#cb943-52" aria-hidden="true" tabindex="-1"></a>  indices <span class="ot">=</span> <span class="fu">sample.int</span>(counter, batch_size)</span>
<span id="cb943-53"><a href="gan.html#cb943-53" aria-hidden="true" tabindex="-1"></a>  batch <span class="ot">=</span> memory[indices,,drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb943-54"><a href="gan.html#cb943-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb943-55"><a href="gan.html#cb943-55" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(batch)){</span>
<span id="cb943-56"><a href="gan.html#cb943-56" aria-hidden="true" tabindex="-1"></a>    target <span class="ot">=</span> batch[i,<span class="dv">6</span>] <span class="co"># Reward.</span></span>
<span id="cb943-57"><a href="gan.html#cb943-57" aria-hidden="true" tabindex="-1"></a>    action <span class="ot">=</span> batch[i,<span class="dv">5</span>] <span class="co"># Action.</span></span>
<span id="cb943-58"><a href="gan.html#cb943-58" aria-hidden="true" tabindex="-1"></a>    state <span class="ot">=</span> <span class="fu">matrix</span>(memory[i, <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>], <span class="at">nrow =</span> 1L)</span>
<span id="cb943-59"><a href="gan.html#cb943-59" aria-hidden="true" tabindex="-1"></a>    next_state <span class="ot">=</span> <span class="fu">matrix</span>(memory[i,<span class="dv">7</span><span class="sc">:</span><span class="dv">10</span>], <span class="at">nrow =</span>1L)</span>
<span id="cb943-60"><a href="gan.html#cb943-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span>batch[i,<span class="dv">11</span>]){ <span class="co"># Not done.</span></span>
<span id="cb943-61"><a href="gan.html#cb943-61" aria-hidden="true" tabindex="-1"></a>      target <span class="ot">=</span> (batch[i,<span class="dv">6</span>] <span class="sc">+</span> gamma <span class="sc">*</span> <span class="fu">predict</span>(model,</span>
<span id="cb943-62"><a href="gan.html#cb943-62" aria-hidden="true" tabindex="-1"></a>                                            <span class="fu">matrix</span>(next_state, <span class="at">nrow =</span> 1L)))[<span class="dv">1</span>,<span class="dv">1</span>]</span>
<span id="cb943-63"><a href="gan.html#cb943-63" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb943-64"><a href="gan.html#cb943-64" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb943-65"><a href="gan.html#cb943-65" aria-hidden="true" tabindex="-1"></a>    target_f <span class="ot">=</span> <span class="fu">predict</span>(model, <span class="fu">matrix</span>(state, <span class="at">nrow =</span> 1L))</span>
<span id="cb943-66"><a href="gan.html#cb943-66" aria-hidden="true" tabindex="-1"></a>    target_f[action<span class="sc">+</span>1L] <span class="ot">=</span> target</span>
<span id="cb943-67"><a href="gan.html#cb943-67" aria-hidden="true" tabindex="-1"></a>    model<span class="sc">$</span><span class="fu">fit</span>(<span class="at">x =</span> state, <span class="at">y =</span> target_f, <span class="at">epochs =</span> 1L, <span class="at">verbose =</span> 0L)</span>
<span id="cb943-68"><a href="gan.html#cb943-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb943-69"><a href="gan.html#cb943-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(epsilon <span class="sc">&gt;</span> epsilon_min){ epsilon <span class="ot">&lt;&lt;-</span> epsilon_decay<span class="sc">*</span>epsilon }</span>
<span id="cb943-70"><a href="gan.html#cb943-70" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb943-71"><a href="gan.html#cb943-71" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb943-72"><a href="gan.html#cb943-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb943-73"><a href="gan.html#cb943-73" aria-hidden="true" tabindex="-1"></a>done <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb943-74"><a href="gan.html#cb943-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb943-75"><a href="gan.html#cb943-75" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(e <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>){</span>
<span id="cb943-76"><a href="gan.html#cb943-76" aria-hidden="true" tabindex="-1"></a>  state <span class="ot">=</span> <span class="fu">unlist</span>(<span class="fu">env_reset</span>(client, env))</span>
<span id="cb943-77"><a href="gan.html#cb943-77" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb943-78"><a href="gan.html#cb943-78" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(time <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">500</span>){</span>
<span id="cb943-79"><a href="gan.html#cb943-79" aria-hidden="true" tabindex="-1"></a>    action <span class="ot">=</span> <span class="fu">act</span>(state)</span>
<span id="cb943-80"><a href="gan.html#cb943-80" aria-hidden="true" tabindex="-1"></a>    response <span class="ot">=</span> <span class="fu">env_step</span>(client, env, <span class="at">action =</span> action)</span>
<span id="cb943-81"><a href="gan.html#cb943-81" aria-hidden="true" tabindex="-1"></a>    done <span class="ot">=</span> <span class="fu">as.integer</span>(response<span class="sc">$</span>done)</span>
<span id="cb943-82"><a href="gan.html#cb943-82" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb943-83"><a href="gan.html#cb943-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span>done){ reward <span class="ot">=</span> response<span class="sc">$</span>reward }</span>
<span id="cb943-84"><a href="gan.html#cb943-84" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>{ reward <span class="ot">=</span> <span class="sc">-</span><span class="dv">10</span> }</span>
<span id="cb943-85"><a href="gan.html#cb943-85" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb943-86"><a href="gan.html#cb943-86" aria-hidden="true" tabindex="-1"></a>    next_state <span class="ot">=</span> <span class="fu">unlist</span>(response<span class="sc">$</span>observation)</span>
<span id="cb943-87"><a href="gan.html#cb943-87" aria-hidden="true" tabindex="-1"></a>    memory <span class="ot">=</span> <span class="fu">remember</span>(memory, state, action, reward, next_state, done)</span>
<span id="cb943-88"><a href="gan.html#cb943-88" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb943-89"><a href="gan.html#cb943-89" aria-hidden="true" tabindex="-1"></a>    state <span class="ot">=</span> next_state</span>
<span id="cb943-90"><a href="gan.html#cb943-90" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(done){</span>
<span id="cb943-91"><a href="gan.html#cb943-91" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">&quot;episode&quot;</span>, e<span class="sc">/</span><span class="dv">500</span>, <span class="st">&quot; score: &quot;</span>, time, <span class="st">&quot; eps: &quot;</span>, epsilon, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb943-92"><a href="gan.html#cb943-92" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span>()</span>
<span id="cb943-93"><a href="gan.html#cb943-93" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb943-94"><a href="gan.html#cb943-94" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb943-95"><a href="gan.html#cb943-95" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(counter <span class="sc">&gt;</span> 32L){ <span class="fu">replay</span>(32L, memory, counter<span class="sc">-</span>1L) }</span>
<span id="cb943-96"><a href="gan.html#cb943-96" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb943-97"><a href="gan.html#cb943-97" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
  <hr/>
  <strong><span style="color: #0011AA; font-size:25px;">Task</span></strong><br/>
<p>Read section <a href="gan.html#VAE">7.1.3</a> on variational autoencoders and try to transfer the examples with MNIST to our flower data set.</p>
  <details>
    <summary>
      <strong><span style="color: #0011AA; font-size:25px;">Solution</span></strong>
    </summary>
    <p>
<p>Split the data:</p>
<div class="sourceCode" id="cb944"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb944-1"><a href="gan.html#cb944-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(keras)</span>
<span id="cb944-2"><a href="gan.html#cb944-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tensorflow)</span>
<span id="cb944-3"><a href="gan.html#cb944-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tfprobability)</span>
<span id="cb944-4"><a href="gan.html#cb944-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set_random_seed</span>(321L, <span class="at">disable_gpu =</span> <span class="cn">FALSE</span>)  <span class="co"># Already sets R&#39;s random seed.</span></span>
<span id="cb944-5"><a href="gan.html#cb944-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb944-6"><a href="gan.html#cb944-6" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> EcoData<span class="sc">::</span><span class="fu">dataset_flower</span>()</span>
<span id="cb944-7"><a href="gan.html#cb944-7" aria-hidden="true" tabindex="-1"></a>test <span class="ot">=</span> data<span class="sc">$</span>test<span class="sc">/</span><span class="dv">255</span></span>
<span id="cb944-8"><a href="gan.html#cb944-8" aria-hidden="true" tabindex="-1"></a>train <span class="ot">=</span> data<span class="sc">$</span>train<span class="sc">/</span><span class="dv">255</span></span>
<span id="cb944-9"><a href="gan.html#cb944-9" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(data)</span></code></pre></div>
<p>Build the variational autoencoder:</p>
<div class="sourceCode" id="cb945"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb945-1"><a href="gan.html#cb945-1" aria-hidden="true" tabindex="-1"></a>encoded <span class="ot">=</span> 10L</span>
<span id="cb945-2"><a href="gan.html#cb945-2" aria-hidden="true" tabindex="-1"></a>prior <span class="ot">=</span> tfp<span class="sc">$</span>distributions<span class="sc">$</span><span class="fu">Independent</span>(</span>
<span id="cb945-3"><a href="gan.html#cb945-3" aria-hidden="true" tabindex="-1"></a>  tfp<span class="sc">$</span>distributions<span class="sc">$</span><span class="fu">Normal</span>(<span class="at">loc=</span>tf<span class="sc">$</span><span class="fu">zeros</span>(encoded), <span class="at">scale =</span> <span class="fl">1.</span>),</span>
<span id="cb945-4"><a href="gan.html#cb945-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">reinterpreted_batch_ndims =</span> 1L</span>
<span id="cb945-5"><a href="gan.html#cb945-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb945-6"><a href="gan.html#cb945-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb945-7"><a href="gan.html#cb945-7" aria-hidden="true" tabindex="-1"></a>down_size_model <span class="ot">=</span> tf<span class="sc">$</span>keras<span class="sc">$</span>models<span class="sc">$</span><span class="fu">Sequential</span>(<span class="fu">list</span>(</span>
<span id="cb945-8"><a href="gan.html#cb945-8" aria-hidden="true" tabindex="-1"></a>  tf<span class="sc">$</span>keras<span class="sc">$</span>layers<span class="sc">$</span><span class="fu">InputLayer</span>(<span class="at">input_shape =</span> <span class="fu">c</span>(80L, 80L, 3L)),</span>
<span id="cb945-9"><a href="gan.html#cb945-9" aria-hidden="true" tabindex="-1"></a>  tf<span class="sc">$</span>keras<span class="sc">$</span>layers<span class="sc">$</span><span class="fu">Conv2D</span>(<span class="at">filters =</span> 32L, <span class="at">activation =</span> tf<span class="sc">$</span>nn<span class="sc">$</span>leaky_relu,</span>
<span id="cb945-10"><a href="gan.html#cb945-10" aria-hidden="true" tabindex="-1"></a>                         <span class="at">kernel_size =</span> 5L, <span class="at">strides =</span> 1L),</span>
<span id="cb945-11"><a href="gan.html#cb945-11" aria-hidden="true" tabindex="-1"></a>  tf<span class="sc">$</span>keras<span class="sc">$</span>layers<span class="sc">$</span><span class="fu">Conv2D</span>(<span class="at">filters =</span> 32L, <span class="at">activation =</span> tf<span class="sc">$</span>nn<span class="sc">$</span>leaky_relu,</span>
<span id="cb945-12"><a href="gan.html#cb945-12" aria-hidden="true" tabindex="-1"></a>                         <span class="at">kernel_size =</span> 5L, <span class="at">strides =</span> 2L),</span>
<span id="cb945-13"><a href="gan.html#cb945-13" aria-hidden="true" tabindex="-1"></a>  tf<span class="sc">$</span>keras<span class="sc">$</span>layers<span class="sc">$</span><span class="fu">Conv2D</span>(<span class="at">filters =</span> 64L, <span class="at">activation =</span> tf<span class="sc">$</span>nn<span class="sc">$</span>leaky_relu,</span>
<span id="cb945-14"><a href="gan.html#cb945-14" aria-hidden="true" tabindex="-1"></a>                         <span class="at">kernel_size =</span> 5L, <span class="at">strides =</span> 1L),</span>
<span id="cb945-15"><a href="gan.html#cb945-15" aria-hidden="true" tabindex="-1"></a>  tf<span class="sc">$</span>keras<span class="sc">$</span>layers<span class="sc">$</span><span class="fu">Conv2D</span>(<span class="at">filters =</span> 64L, <span class="at">activation =</span> tf<span class="sc">$</span>nn<span class="sc">$</span>leaky_relu,</span>
<span id="cb945-16"><a href="gan.html#cb945-16" aria-hidden="true" tabindex="-1"></a>                         <span class="at">kernel_size =</span> 5L, <span class="at">strides =</span> 2L),</span>
<span id="cb945-17"><a href="gan.html#cb945-17" aria-hidden="true" tabindex="-1"></a>  tf<span class="sc">$</span>keras<span class="sc">$</span>layers<span class="sc">$</span><span class="fu">Conv2D</span>(<span class="at">filters =</span> 128L, <span class="at">activation =</span> tf<span class="sc">$</span>nn<span class="sc">$</span>leaky_relu,</span>
<span id="cb945-18"><a href="gan.html#cb945-18" aria-hidden="true" tabindex="-1"></a>                         <span class="at">kernel_size =</span> 7L, <span class="at">strides =</span> 1L),</span>
<span id="cb945-19"><a href="gan.html#cb945-19" aria-hidden="true" tabindex="-1"></a>  tf<span class="sc">$</span>keras<span class="sc">$</span>layers<span class="sc">$</span><span class="fu">Flatten</span>(),</span>
<span id="cb945-20"><a href="gan.html#cb945-20" aria-hidden="true" tabindex="-1"></a>  tf<span class="sc">$</span>keras<span class="sc">$</span>layers<span class="sc">$</span><span class="fu">Dense</span>(<span class="at">units =</span> tfp<span class="sc">$</span>layers<span class="sc">$</span>MultivariateNormalTriL<span class="sc">$</span><span class="fu">params_size</span>(encoded),</span>
<span id="cb945-21"><a href="gan.html#cb945-21" aria-hidden="true" tabindex="-1"></a>                        <span class="at">activation =</span> <span class="cn">NULL</span>),</span>
<span id="cb945-22"><a href="gan.html#cb945-22" aria-hidden="true" tabindex="-1"></a>  tfp<span class="sc">$</span>layers<span class="sc">$</span><span class="fu">MultivariateNormalTriL</span>(</span>
<span id="cb945-23"><a href="gan.html#cb945-23" aria-hidden="true" tabindex="-1"></a>    encoded, </span>
<span id="cb945-24"><a href="gan.html#cb945-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">activity_regularizer =</span> tfp<span class="sc">$</span>layers<span class="sc">$</span><span class="fu">KLDivergenceRegularizer</span>(prior, <span class="at">weight =</span> <span class="fl">0.0002</span>)</span>
<span id="cb945-25"><a href="gan.html#cb945-25" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb945-26"><a href="gan.html#cb945-26" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb945-27"><a href="gan.html#cb945-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb945-28"><a href="gan.html#cb945-28" aria-hidden="true" tabindex="-1"></a>up_size_model <span class="ot">=</span> tf<span class="sc">$</span>keras<span class="sc">$</span>models<span class="sc">$</span><span class="fu">Sequential</span>(<span class="fu">list</span>(</span>
<span id="cb945-29"><a href="gan.html#cb945-29" aria-hidden="true" tabindex="-1"></a>  tf<span class="sc">$</span>keras<span class="sc">$</span>layers<span class="sc">$</span><span class="fu">InputLayer</span>(<span class="at">input_shape =</span> encoded),</span>
<span id="cb945-30"><a href="gan.html#cb945-30" aria-hidden="true" tabindex="-1"></a>  tf<span class="sc">$</span>keras<span class="sc">$</span>layers<span class="sc">$</span><span class="fu">Dense</span>(<span class="at">units =</span> 8192L, <span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>),</span>
<span id="cb945-31"><a href="gan.html#cb945-31" aria-hidden="true" tabindex="-1"></a>  tf<span class="sc">$</span>keras<span class="sc">$</span>layers<span class="sc">$</span><span class="fu">Reshape</span>(<span class="at">target_shape =</span>  <span class="fu">c</span>(8L, 8L, 128L)),</span>
<span id="cb945-32"><a href="gan.html#cb945-32" aria-hidden="true" tabindex="-1"></a>  tf<span class="sc">$</span>keras<span class="sc">$</span>layers<span class="sc">$</span><span class="fu">Conv2DTranspose</span>(<span class="at">filters =</span> 128L, <span class="at">kernel_size =</span> 7L,</span>
<span id="cb945-33"><a href="gan.html#cb945-33" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">activation =</span> tf<span class="sc">$</span>nn<span class="sc">$</span>leaky_relu, <span class="at">strides =</span> 1L,</span>
<span id="cb945-34"><a href="gan.html#cb945-34" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">use_bias =</span> <span class="cn">FALSE</span>),</span>
<span id="cb945-35"><a href="gan.html#cb945-35" aria-hidden="true" tabindex="-1"></a>  tf<span class="sc">$</span>keras<span class="sc">$</span>layers<span class="sc">$</span><span class="fu">Conv2DTranspose</span>(<span class="at">filters =</span> 64L, <span class="at">kernel_size =</span> 5L,</span>
<span id="cb945-36"><a href="gan.html#cb945-36" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">activation =</span> tf<span class="sc">$</span>nn<span class="sc">$</span>leaky_relu, <span class="at">strides =</span> 2L,</span>
<span id="cb945-37"><a href="gan.html#cb945-37" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">use_bias =</span> <span class="cn">FALSE</span>),</span>
<span id="cb945-38"><a href="gan.html#cb945-38" aria-hidden="true" tabindex="-1"></a>  tf<span class="sc">$</span>keras<span class="sc">$</span>layers<span class="sc">$</span><span class="fu">Conv2DTranspose</span>(<span class="at">filters =</span> 64L, <span class="at">kernel_size =</span> 5L,</span>
<span id="cb945-39"><a href="gan.html#cb945-39" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">activation =</span> tf<span class="sc">$</span>nn<span class="sc">$</span>leaky_relu, <span class="at">strides =</span> 1L,</span>
<span id="cb945-40"><a href="gan.html#cb945-40" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">use_bias =</span> <span class="cn">FALSE</span>),</span>
<span id="cb945-41"><a href="gan.html#cb945-41" aria-hidden="true" tabindex="-1"></a>  tf<span class="sc">$</span>keras<span class="sc">$</span>layers<span class="sc">$</span><span class="fu">Conv2DTranspose</span>(<span class="at">filters =</span> 32L, <span class="at">kernel_size =</span> 5L,</span>
<span id="cb945-42"><a href="gan.html#cb945-42" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">activation =</span> tf<span class="sc">$</span>nn<span class="sc">$</span>leaky_relu, <span class="at">strides =</span> 2L,</span>
<span id="cb945-43"><a href="gan.html#cb945-43" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">use_bias =</span> <span class="cn">FALSE</span>),</span>
<span id="cb945-44"><a href="gan.html#cb945-44" aria-hidden="true" tabindex="-1"></a>  tf<span class="sc">$</span>keras<span class="sc">$</span>layers<span class="sc">$</span><span class="fu">Conv2DTranspose</span>(<span class="at">filters =</span> 32L, <span class="at">kernel_size =</span> 5L,</span>
<span id="cb945-45"><a href="gan.html#cb945-45" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">activation =</span> tf<span class="sc">$</span>nn<span class="sc">$</span>leaky_relu, <span class="at">strides =</span> 1L,</span>
<span id="cb945-46"><a href="gan.html#cb945-46" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">use_bias =</span> <span class="cn">FALSE</span>),</span>
<span id="cb945-47"><a href="gan.html#cb945-47" aria-hidden="true" tabindex="-1"></a>  tf<span class="sc">$</span>keras<span class="sc">$</span>layers<span class="sc">$</span><span class="fu">Conv2DTranspose</span>(<span class="at">filters =</span> 3L, <span class="at">kernel_size =</span> <span class="fu">c</span>(4L, 4L),</span>
<span id="cb945-48"><a href="gan.html#cb945-48" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">activation =</span> <span class="st">&quot;sigmoid&quot;</span>, <span class="at">strides =</span> <span class="fu">c</span>(1L, 1L),</span>
<span id="cb945-49"><a href="gan.html#cb945-49" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">use_bias =</span> <span class="cn">FALSE</span>)</span>
<span id="cb945-50"><a href="gan.html#cb945-50" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb945-51"><a href="gan.html#cb945-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb945-52"><a href="gan.html#cb945-52" aria-hidden="true" tabindex="-1"></a>VAE <span class="ot">=</span> tf<span class="sc">$</span>keras<span class="sc">$</span>models<span class="sc">$</span><span class="fu">Model</span>(<span class="at">inputs =</span> down_size_model<span class="sc">$</span>inputs, </span>
<span id="cb945-53"><a href="gan.html#cb945-53" aria-hidden="true" tabindex="-1"></a>                            <span class="at">outputs =</span> <span class="fu">up_size_model</span>(down_size_model<span class="sc">$</span>outputs))</span>
<span id="cb945-54"><a href="gan.html#cb945-54" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(VAE)</span></code></pre></div>
<pre><code>## Model: &quot;model_5&quot;
## __________________________________________________________________________________________________________________
##  Layer (type)                                      Output Shape                                 Param #           
## ==================================================================================================================
##  input_4 (InputLayer)                              [(None, 80, 80, 3)]                          0                 
##                                                                                                                   
##  conv2d_51 (Conv2D)                                (None, 76, 76, 32)                           2432              
##                                                                                                                   
##  conv2d_52 (Conv2D)                                (None, 36, 36, 32)                           25632             
##                                                                                                                   
##  conv2d_53 (Conv2D)                                (None, 32, 32, 64)                           51264             
##                                                                                                                   
##  conv2d_54 (Conv2D)                                (None, 14, 14, 64)                           102464            
##                                                                                                                   
##  conv2d_55 (Conv2D)                                (None, 8, 8, 128)                            401536            
##                                                                                                                   
##  flatten_22 (Flatten)                              (None, 8192)                                 0                 
##                                                                                                                   
##  dense_236 (Dense)                                 (None, 65)                                   532545            
##                                                                                                                   
##  multivariate_normal_tri_l (MultivariateNormalTriL  ((None, 10),                                0                 
##  )                                                  (None, 10))                                                   
##                                                                                                                   
##  sequential_76 (Sequential)                        (None, 80, 80, 3)                            1278464           
##                                                                                                                   
## ==================================================================================================================
## Total params: 2,394,337
## Trainable params: 2,394,337
## Non-trainable params: 0
## __________________________________________________________________________________________________________________</code></pre>
<p>Compile and train model:</p>
<div class="sourceCode" id="cb947"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb947-1"><a href="gan.html#cb947-1" aria-hidden="true" tabindex="-1"></a>be <span class="ot">=</span> <span class="cf">function</span>(true, pred){</span>
<span id="cb947-2"><a href="gan.html#cb947-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(tf<span class="sc">$</span>losses<span class="sc">$</span><span class="fu">binary_crossentropy</span>(true, pred) <span class="sc">*</span> <span class="fl">80.0</span> <span class="sc">*</span> <span class="fl">80.0</span>)</span>
<span id="cb947-3"><a href="gan.html#cb947-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb947-4"><a href="gan.html#cb947-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb947-5"><a href="gan.html#cb947-5" aria-hidden="true" tabindex="-1"></a>VAE<span class="sc">$</span><span class="fu">compile</span>(<span class="at">loss =</span> be,</span>
<span id="cb947-6"><a href="gan.html#cb947-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">optimizer =</span> tf<span class="sc">$</span>keras<span class="sc">$</span>optimizers<span class="sc">$</span><span class="fu">Adamax</span>(<span class="at">learning_rate =</span> <span class="fl">0.0003</span>))</span>
<span id="cb947-7"><a href="gan.html#cb947-7" aria-hidden="true" tabindex="-1"></a>VAE<span class="sc">$</span><span class="fu">fit</span>(<span class="at">x =</span> train, <span class="at">y =</span> train, <span class="at">epochs =</span> 50L, <span class="at">shuffle =</span> <span class="cn">TRUE</span>, <span class="at">batch_size =</span> 20L)</span></code></pre></div>
<pre><code>## &lt;keras.callbacks.History&gt;</code></pre>
<div class="sourceCode" id="cb949"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb949-1"><a href="gan.html#cb949-1" aria-hidden="true" tabindex="-1"></a>dist <span class="ot">=</span> <span class="fu">down_size_model</span>(train[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,,,])</span>
<span id="cb949-2"><a href="gan.html#cb949-2" aria-hidden="true" tabindex="-1"></a>images <span class="ot">=</span> <span class="fu">up_size_model</span>( dist<span class="sc">$</span><span class="fu">sample</span>()[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,] )</span>
<span id="cb949-3"><a href="gan.html#cb949-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb949-4"><a href="gan.html#cb949-4" aria-hidden="true" tabindex="-1"></a>oldpar <span class="ot">=</span> <span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">1</span>), <span class="at">mar =</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="dv">4</span>))</span>
<span id="cb949-5"><a href="gan.html#cb949-5" aria-hidden="true" tabindex="-1"></a>scales<span class="sc">::</span><span class="fu">rescale</span>(images[<span class="dv">1</span>,,,]<span class="sc">$</span><span class="fu">numpy</span>(), <span class="at">to =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">255</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb949-6"><a href="gan.html#cb949-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">image_to_array</span>() <span class="sc">%&gt;%</span></span>
<span id="cb949-7"><a href="gan.html#cb949-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">/</span><span class="st">`</span>(., <span class="dv">255</span>) <span class="sc">%&gt;%</span></span>
<span id="cb949-8"><a href="gan.html#cb949-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.raster</span>() <span class="sc">%&gt;%</span></span>
<span id="cb949-9"><a href="gan.html#cb949-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>()</span>
<span id="cb949-10"><a href="gan.html#cb949-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb949-11"><a href="gan.html#cb949-11" aria-hidden="true" tabindex="-1"></a>scales<span class="sc">::</span><span class="fu">rescale</span>(images[<span class="dv">2</span>,,,]<span class="sc">$</span><span class="fu">numpy</span>(), <span class="at">to =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">255</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb949-12"><a href="gan.html#cb949-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">image_to_array</span>() <span class="sc">%&gt;%</span></span>
<span id="cb949-13"><a href="gan.html#cb949-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">/</span><span class="st">`</span>(., <span class="dv">255</span>) <span class="sc">%&gt;%</span></span>
<span id="cb949-14"><a href="gan.html#cb949-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.raster</span>() <span class="sc">%&gt;%</span></span>
<span id="cb949-15"><a href="gan.html#cb949-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>()</span>
<span id="cb949-16"><a href="gan.html#cb949-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb949-17"><a href="gan.html#cb949-17" aria-hidden="true" tabindex="-1"></a>scales<span class="sc">::</span><span class="fu">rescale</span>(images[<span class="dv">3</span>,,,]<span class="sc">$</span><span class="fu">numpy</span>(), <span class="at">to =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">255</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb949-18"><a href="gan.html#cb949-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">image_to_array</span>() <span class="sc">%&gt;%</span></span>
<span id="cb949-19"><a href="gan.html#cb949-19" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">/</span><span class="st">`</span>(., <span class="dv">255</span>) <span class="sc">%&gt;%</span></span>
<span id="cb949-20"><a href="gan.html#cb949-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.raster</span>() <span class="sc">%&gt;%</span></span>
<span id="cb949-21"><a href="gan.html#cb949-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/chunk_chapter7_task_2__VAEflower-1.png" width="672" /></p>
<div class="sourceCode" id="cb950"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb950-1"><a href="gan.html#cb950-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(oldpar)</span></code></pre></div>
    </p>
  </details>
  <br/><hr/>
  <strong><span style="color: #0011AA; font-size:25px;">Task</span></strong><br/>
<p>Go through the R examples on generative adversarial networks (<a href="gan.html#GANS">7.2</a>) and compare the flower example with the MNIST example - where are the differences - and why?</p>
  <details>
    <summary>
      <strong><span style="color: #0011AA; font-size:25px;">Solution</span></strong>
    </summary>
    <p>
<p>The MNIST example uses a “simple” deep neural network which is sufficient for a classification that easy. The flower example uses a much more expensive convolutional neural network to classify the images.</p>
    </p>
  </details>
  <br/><hr/>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="interpretation.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="datasets.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
