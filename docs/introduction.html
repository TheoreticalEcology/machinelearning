<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 3 Introduction to Machine Learning | Machine Learning and AI in TensorFlow and R</title>
<meta name="author" content="Maximilian Pichler and Florian Hartig">
<meta name="description" content="There are three basic machine learning tasks: Supervised learning Unsupervised learning Reinforcement learning In supervised learning, you train algorithms using labeled data, what means that you...">
<meta name="generator" content="bookdown 0.27 with bs4_book()">
<meta property="og:title" content="Chapter 3 Introduction to Machine Learning | Machine Learning and AI in TensorFlow and R">
<meta property="og:type" content="book">
<meta property="og:description" content="There are three basic machine learning tasks: Supervised learning Unsupervised learning Reinforcement learning In supervised learning, you train algorithms using labeled data, what means that you...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 3 Introduction to Machine Learning | Machine Learning and AI in TensorFlow and R">
<meta name="twitter:description" content="There are three basic machine learning tasks: Supervised learning Unsupervised learning Reinforcement learning In supervised learning, you train algorithms using labeled data, what means that you...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><link href="libs/panelset-0.2.6/panelset.css" rel="stylesheet">
<script src="libs/panelset-0.2.6/panelset.js"></script><style>
    #content {
        font-size: 0.95rem;
    }
    </style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<link rel="stylesheet" href="panel.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Machine Learning and AI in TensorFlow and R</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"><span class="header-section-number">1</span> Prerequisites</a></li>
<li><a class="" href="reminder.html"><span class="header-section-number">2</span> Reminders About Basic Operations in R</a></li>
<li><a class="active" href="introduction.html"><span class="header-section-number">3</span> Introduction to Machine Learning</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/TheoreticalEcology/machinelearning">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="introduction" class="section level1" number="3">
<h1>
<span class="header-section-number">3</span> Introduction to Machine Learning<a class="anchor" aria-label="anchor" href="#introduction"><i class="fas fa-link"></i></a>
</h1>
<!-- Put this here (right after the first markdown headline) and only here for each document! -->
<script src="./scripts/multipleChoice.js"></script><p>There are three basic machine learning tasks:</p>
<ul>
<li>Supervised learning</li>
<li>Unsupervised learning</li>
<li>Reinforcement learning</li>
</ul>
<p>In <strong>supervised learning</strong>, you train algorithms using labeled data, what means that you already know the correct answer for a part of the data (the so called <em>training data</em>).</p>
<p><strong>Unsupervised learning</strong> in contrast is a technique, where one does not need to monitor the model or apply labels. Instead, you allow the model to work on its own to discover information.</p>
<p><strong>Reinforcement learning</strong> is a technique that emulates a game-like situation. The algorithm finds a solution by trial and error and gets either <em>rewards</em> or <em>penalties</em> for every action. As in games, the goal is to maximize the rewards. We will talk more about this technique on the last day of the course.</p>
<p>For the moment, we will focus on the first two tasks, supervised and unsupervised learning. To do so, we will begin with a small example. But before you start with the code, here is a video to prepare you for what we will do in the class:</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/1AVrWvRvfxs" frameborder="0" allow="accelerometer; autoplay; encrypted-media;
  gyroscope; picture-in-picture" allowfullscreen>
</iframe>
<div id="unsupervised-learning" class="section level2" number="3.1">
<h2>
<span class="header-section-number">3.1</span> Unsupervised Learning<a class="anchor" aria-label="anchor" href="#unsupervised-learning"><i class="fas fa-link"></i></a>
</h2>
<p>In unsupervised learning, we want to identify patterns in data without having any examples (supervision) about what the correct patterns / classes are. As an example, consider the iris data set. Here, we have 150 observations of 4 floral traits:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">iris</span> <span class="op">=</span> <span class="fu">datasets</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/r/datasets/iris.html">iris</a></span></span>
<span><span class="va">colors</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html">hcl.colors</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">traits</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">iris</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span> </span>
<span><span class="va">species</span> <span class="op">=</span> <span class="va">iris</span><span class="op">$</span><span class="va">Species</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/image.html">image</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">species</span><span class="op">)</span> , z <span class="op">=</span> <span class="va">traits</span>, </span>
<span>      ylab <span class="op">=</span> <span class="st">"Floral trait"</span>, xlab <span class="op">=</span> <span class="st">"Individual"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/segments.html">segments</a></span><span class="op">(</span><span class="fl">50.5</span>, <span class="fl">0</span>, <span class="fl">50.5</span>, <span class="fl">5</span>, col <span class="op">=</span> <span class="st">"black"</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/segments.html">segments</a></span><span class="op">(</span><span class="fl">100.5</span>, <span class="fl">0</span>, <span class="fl">100.5</span>, <span class="fl">5</span>, col <span class="op">=</span> <span class="st">"black"</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:chunk-chapter3-1-iris-plot"></span>
<img src="03-intro_files/figure-html/chunk-chapter3-1-iris-plot-1.png" alt="Trait distributions of iris dataset" width="100%"><p class="caption">
Figure 3.1: Trait distributions of iris dataset
</p>
</div>
<p>The observations are from 3 species and indeed those species tend to have different traits, meaning that the observations form 3 clusters.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/pairs.html">pairs</a></span><span class="op">(</span><span class="va">traits</span>, pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">species</span><span class="op">)</span>, col <span class="op">=</span> <span class="va">colors</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">species</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:chunk-chapter3-2"></span>
<img src="03-intro_files/figure-html/chunk-chapter3-2-1.png" alt="Scatterplots for trait-trait combinations." width="100%"><p class="caption">
Figure 3.2: Scatterplots for trait-trait combinations.
</p>
</div>
<p>However, imagine we don’t know what species are, what is basically the situation in which people in the antique have been. The people just noted that some plants have different flowers than others, and decided to give them different names. This kind of process is what unsupervised learning does.</p>
<div id="hierarchical-clustering" class="section level3" number="3.1.1">
<h3>
<span class="header-section-number">3.1.1</span> Hierarchical Clustering<a class="anchor" aria-label="anchor" href="#hierarchical-clustering"><i class="fas fa-link"></i></a>
</h3>
<p>A cluster refers to a collection of data points aggregated together because of certain similarities.</p>
<p>In hierarchical clustering, a hierarchy (tree) between data points is built.</p>
<ul>
<li>Agglomerative: Start with each data point in their own cluster, merge them up hierarchically.</li>
<li>Divisive: Start with all data points in one cluster, and split hierarchically.</li>
</ul>
<p>Merges / splits are done according to linkage criterion, which measures distance between (potential) clusters. Cut the tree at a certain height to get clusters.</p>
<p>Here an example</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#Reminder: traits = as.matrix(iris[,1:4]).</span></span>
<span></span>
<span><span class="va">d</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/dist.html">dist</a></span><span class="op">(</span><span class="va">traits</span><span class="op">)</span></span>
<span><span class="va">hc</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/hclust.html">hclust</a></span><span class="op">(</span><span class="va">d</span>, method <span class="op">=</span> <span class="st">"complete"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">hc</span>, main<span class="op">=</span><span class="st">""</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/rect.hclust.html">rect.hclust</a></span><span class="op">(</span><span class="va">hc</span>, k <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>  <span class="co"># Draw rectangles around the branches.</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:chunk-chapter3-3"></span>
<img src="03-intro_files/figure-html/chunk-chapter3-3-1.png" alt="Results of hierarchical clustering. Red rectangle is drawn around the corresponding clusters." width="100%"><p class="caption">
Figure 3.3: Results of hierarchical clustering. Red rectangle is drawn around the corresponding clusters.
</p>
</div>
<p>Same plot, but with colors for true species identity</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://ape-package.ird.fr/">ape</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/as.phylo.html">as.phylo</a></span><span class="op">(</span><span class="va">hc</span><span class="op">)</span>, </span>
<span>     tip.color <span class="op">=</span> <span class="va">colors</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">species</span><span class="op">)</span><span class="op">]</span>, </span>
<span>     direction <span class="op">=</span> <span class="st">"downwards"</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:chunk-chapter3-4"></span>
<img src="03-intro_files/figure-html/chunk-chapter3-4-1.png" alt="Results of hierarchical clustering. Colors correspond to the three species classes." width="100%"><p class="caption">
Figure 3.4: Results of hierarchical clustering. Colors correspond to the three species classes.
</p>
</div>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">hcRes3</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/cutree.html">cutree</a></span><span class="op">(</span><span class="va">hc</span>, k <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>   <span class="co">#Cut a dendrogram tree into groups.</span></span></code></pre></div>
<p>Calculate confusion matrix. Note we are switching labels here so that it fits to the species.</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tmp</span> <span class="op">=</span> <span class="va">hcRes3</span></span>
<span><span class="va">tmp</span><span class="op">[</span><span class="va">hcRes3</span> <span class="op">==</span> <span class="fl">2</span><span class="op">]</span> <span class="op">=</span> <span class="fl">3</span></span>
<span><span class="va">tmp</span><span class="op">[</span><span class="va">hcRes3</span> <span class="op">==</span> <span class="fl">3</span><span class="op">]</span> <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="va">hcRes3</span> <span class="op">=</span> <span class="va">tmp</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">hcRes3</span>, <span class="va">species</span><span class="op">)</span></span></code></pre></div>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:chunk-chapter3-5-kable">Table 3.1: </span>Confusion matrix for predicted and observed species classes.</caption>
<thead><tr class="header">
<th align="right">setosa</th>
<th align="right">versicolor</th>
<th align="right">virginica</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">50</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="right">0</td>
<td align="right">27</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="right">0</td>
<td align="right">23</td>
<td align="right">49</td>
</tr>
</tbody>
</table></div>
<p>Note that results might change if you choose a different agglomeration method, distance metric or scale of your variables. Compare, e.g. to this example:</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hc</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/hclust.html">hclust</a></span><span class="op">(</span><span class="va">d</span>, method <span class="op">=</span> <span class="st">"ward.D2"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/as.phylo.html">as.phylo</a></span><span class="op">(</span><span class="va">hc</span><span class="op">)</span>, </span>
<span>     tip.color <span class="op">=</span> <span class="va">colors</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">species</span><span class="op">)</span><span class="op">]</span>, </span>
<span>     direction <span class="op">=</span> <span class="st">"downwards"</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:chunk-chapter3-6-a"></span>
<img src="03-intro_files/figure-html/chunk-chapter3-6-a-1.png" alt="Results of hierarchical clustering. Colors correspond to the three species classes. Different agglomeration method" width="100%"><p class="caption">
Figure 3.5: Results of hierarchical clustering. Colors correspond to the three species classes. Different agglomeration method
</p>
</div>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hcRes3</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/cutree.html">cutree</a></span><span class="op">(</span><span class="va">hc</span>, k <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>   <span class="co">#Cut a dendrogram tree into groups.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">hcRes3</span>, <span class="va">species</span><span class="op">)</span></span></code></pre></div>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:chunk-chapter3-6-kable">Table 3.2: </span>Confusion matrix for predicted and observed species classes.</caption>
<thead><tr class="header">
<th align="right">setosa</th>
<th align="right">versicolor</th>
<th align="right">virginica</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">50</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="right">0</td>
<td align="right">49</td>
<td align="right">15</td>
</tr>
<tr class="odd">
<td align="right">0</td>
<td align="right">1</td>
<td align="right">35</td>
</tr>
</tbody>
</table></div>
<p>Which method is best?</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://talgalili.github.io/dendextend/">dendextend</a></span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="va">methods</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ward.D"</span>, <span class="st">"single"</span>, <span class="st">"complete"</span>, <span class="st">"average"</span>,</span>
<span>             <span class="st">"mcquitty"</span>, <span class="st">"median"</span>, <span class="st">"centroid"</span>, <span class="st">"ward.D2"</span><span class="op">)</span></span>
<span><span class="va">out</span> <span class="op">=</span> <span class="fu"><a href="http://talgalili.github.io/dendextend/reference/dendlist.html">dendlist</a></span><span class="op">(</span><span class="op">)</span>   <span class="co"># Create a dendlist object from several dendrograms.</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">method</span> <span class="kw">in</span> <span class="va">methods</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">res</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/hclust.html">hclust</a></span><span class="op">(</span><span class="va">d</span>, method <span class="op">=</span> <span class="va">method</span><span class="op">)</span>   </span>
<span>  <span class="va">out</span> <span class="op">=</span> <span class="fu"><a href="http://talgalili.github.io/dendextend/reference/dendlist.html">dendlist</a></span><span class="op">(</span><span class="va">out</span>, <span class="fu"><a href="https://rdrr.io/r/stats/dendrogram.html">as.dendrogram</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span> <span class="op">=</span> <span class="va">methods</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span><span class="co">#&gt; $ward.D</span></span>
<span><span class="co">#&gt; 'dendrogram' with 2 branches and 150 members total, at height 199.6205 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $single</span></span>
<span><span class="co">#&gt; 'dendrogram' with 2 branches and 150 members total, at height 1.640122 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $complete</span></span>
<span><span class="co">#&gt; 'dendrogram' with 2 branches and 150 members total, at height 7.085196 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $average</span></span>
<span><span class="co">#&gt; 'dendrogram' with 2 branches and 150 members total, at height 4.062683 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $mcquitty</span></span>
<span><span class="co">#&gt; 'dendrogram' with 2 branches and 150 members total, at height 4.497283 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $median</span></span>
<span><span class="co">#&gt; 'dendrogram' with 2 branches and 150 members total, at height 2.82744 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $centroid</span></span>
<span><span class="co">#&gt; 'dendrogram' with 2 branches and 150 members total, at height 2.994307 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $ward.D2</span></span>
<span><span class="co">#&gt; 'dendrogram' with 2 branches and 150 members total, at height 32.44761 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; attr(,"class")</span></span>
<span><span class="co">#&gt; [1] "dendlist"</span></span>
<span></span>
<span><span class="va">get_ordered_3_clusters</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">dend</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># order.dendrogram function returns the order (index)</span></span>
<span>  <span class="co"># or the "label" attribute for the leaves.</span></span>
<span>  <span class="co"># cutree: Cut the tree (dendrogram) into groups of data.</span></span>
<span>  <span class="fu">cutree</span><span class="op">(</span><span class="va">dend</span>, k <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/order.dendrogram.html">order.dendrogram</a></span><span class="op">(</span><span class="va">dend</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span><span class="va">dend_3_clusters</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">out</span>, <span class="va">get_ordered_3_clusters</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate Fowlkes-Mallows Index (determine the similarity between clusterings)</span></span>
<span><span class="va">compare_clusters_to_iris</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">clus</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="http://talgalili.github.io/dendextend/reference/FM_index.html">FM_index</a></span><span class="op">(</span><span class="va">clus</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, each <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>, assume_sorted_vectors <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">clusters_performance</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">dend_3_clusters</span>, <span class="va">compare_clusters_to_iris</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/dotchart.html">dotchart</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="va">clusters_performance</span><span class="op">)</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.3</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>         xlab <span class="op">=</span> <span class="st">"Fowlkes-Mallows index"</span>,</span>
<span>         main <span class="op">=</span> <span class="st">"Performance of linkage methods</span></span>
<span><span class="st">         in detecting the 3 species \n in our example"</span>,</span>
<span>         pch <span class="op">=</span> <span class="fl">19</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="03-intro_files/figure-html/chunk_chapter3_8-1.png" width="100%" style="display: block; margin: auto;"></div>
<p>We might conclude that ward.D2 works best here. However, as we will learn later, optimizing the method without a hold-out for testing implies that our model may be overfitting. We should check this using cross-validation.</p>
</div>
<div id="k-means-clustering" class="section level3" number="3.1.2">
<h3>
<span class="header-section-number">3.1.2</span> K-means Clustering<a class="anchor" aria-label="anchor" href="#k-means-clustering"><i class="fas fa-link"></i></a>
</h3>
<p>Another example for an unsupervised learning algorithm is k-means clustering, one of the simplest and most popular unsupervised machine learning algorithms.</p>
<p>To start with the algorithm, you first have to specify the number of clusters (for our example the number of species). Each cluster has a centroid, which is the assumed or real location representing the center of the cluster (for our example this would be how an average plant of a specific species would look like). The algorithm starts by randomly putting centroids somewhere. Afterwards each data point is assigned to the respective cluster that raises the overall in-cluster sum of squares (variance) related to the distance to the centroid least of all. After the algorithm has placed all data points into a cluster the centroids get updated. By iterating this procedure until the assignment doesn’t change any longer, the algorithm can find the (locally) optimal centroids and the data points belonging to this cluster.
Note that results might differ according to the initial positions of the centroids. Thus several (locally) optimal solutions might be found.</p>
<p>The “k” in K-means refers to the number of clusters and the ‘means’ refers to averaging the data-points to find the centroids.</p>
<p>A typical pipeline for using k-means clustering looks the same as for other algorithms. After having visualized the data, we fit a model, visualize the results and have a look at the performance by use of the confusion matrix. By setting a fixed seed, we can ensure that results are reproducible.</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#Reminder: traits = as.matrix(iris[,1:4]).</span></span>
<span></span>
<span><span class="va">kc</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/kmeans.html">kmeans</a></span><span class="op">(</span><span class="va">traits</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">kc</span><span class="op">)</span></span>
<span><span class="co">#&gt; K-means clustering with 3 clusters of sizes 50, 62, 38</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Cluster means:</span></span>
<span><span class="co">#&gt;   Sepal.Length Sepal.Width Petal.Length Petal.Width</span></span>
<span><span class="co">#&gt; 1     5.006000    3.428000     1.462000    0.246000</span></span>
<span><span class="co">#&gt; 2     5.901613    2.748387     4.393548    1.433871</span></span>
<span><span class="co">#&gt; 3     6.850000    3.073684     5.742105    2.071053</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Clustering vector:</span></span>
<span><span class="co">#&gt;   [1] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1</span></span>
<span><span class="co">#&gt;  [28] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 2 2 3 2</span></span>
<span><span class="co">#&gt;  [55] 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 3 2 2 2</span></span>
<span><span class="co">#&gt;  [82] 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 3 2 3 3 3 3 2 3</span></span>
<span><span class="co">#&gt; [109] 3 3 3 3 3 2 2 3 3 3 3 2 3 2 3 2 3 3 2 2 3 3 3 3 3 2 3</span></span>
<span><span class="co">#&gt; [136] 3 3 3 2 3 3 3 2 3 3 3 2 3 3 2</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Within cluster sum of squares by cluster:</span></span>
<span><span class="co">#&gt; [1] 15.15100 39.82097 23.87947</span></span>
<span><span class="co">#&gt;  (between_SS / total_SS =  88.4 %)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Available components:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [1] "cluster"      "centers"      "totss"       </span></span>
<span><span class="co">#&gt; [4] "withinss"     "tot.withinss" "betweenss"   </span></span>
<span><span class="co">#&gt; [7] "size"         "iter"         "ifault"</span></span></code></pre></div>
<p><em>Visualizing the results.</em>
Color codes true species identity, symbol shows cluster result.</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">iris</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Sepal.Length"</span>, <span class="st">"Sepal.Width"</span><span class="op">)</span><span class="op">]</span>,</span>
<span>     col <span class="op">=</span>  <span class="va">colors</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">species</span><span class="op">)</span><span class="op">]</span>, pch <span class="op">=</span> <span class="va">kc</span><span class="op">$</span><span class="va">cluster</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span><span class="va">kc</span><span class="op">$</span><span class="va">centers</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Sepal.Length"</span>, <span class="st">"Sepal.Width"</span><span class="op">)</span><span class="op">]</span>,</span>
<span>       col <span class="op">=</span> <span class="va">colors</span>, pch <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, cex <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="03-intro_files/figure-html/chunk_chapter3_10-1.png" width="100%" style="display: block; margin: auto;"></div>
<p>We see that there are are some discrepancies. Confusion matrix:</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Species</span>, <span class="va">kc</span><span class="op">$</span><span class="va">cluster</span><span class="op">)</span></span>
<span><span class="co">#&gt;             </span></span>
<span><span class="co">#&gt;               1  2  3</span></span>
<span><span class="co">#&gt;   setosa     50  0  0</span></span>
<span><span class="co">#&gt;   versicolor  0 48  2</span></span>
<span><span class="co">#&gt;   virginica   0 14 36</span></span></code></pre></div>
<p>If you want to animate the clustering process, you could run</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://yihui.org/animation/">animation</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/animation/man/saveGIF.html">saveGIF</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/animation/man/kmeans.ani.html">kmeans.ani</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">traits</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span>, col <span class="op">=</span> <span class="va">colors</span><span class="op">)</span>,</span>
<span>        interval <span class="op">=</span> <span class="fl">1</span>, ani.width <span class="op">=</span> <span class="fl">800</span>, ani.height <span class="op">=</span> <span class="fl">800</span><span class="op">)</span></span></code></pre></div>
<p><strong>Elbow technique</strong> to determine the probably best suited number of clusters:</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="va">getSumSq</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">k</span><span class="op">)</span><span class="op">{</span> <span class="fu"><a href="https://rdrr.io/r/stats/kmeans.html">kmeans</a></span><span class="op">(</span><span class="va">traits</span>, <span class="va">k</span>, nstart <span class="op">=</span> <span class="fl">25</span><span class="op">)</span><span class="op">$</span><span class="va">tot.withinss</span> <span class="op">}</span></span>
<span></span>
<span><span class="co">#Perform algorithm for different cluster sizes and retrieve variance.</span></span>
<span><span class="va">iris.kmeans1to10</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="va">getSumSq</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="va">iris.kmeans1to10</span>, type <span class="op">=</span> <span class="st">"b"</span>, pch <span class="op">=</span> <span class="fl">19</span>, frame <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>     xlab <span class="op">=</span> <span class="st">"Number of clusters K"</span>,</span>
<span>     ylab <span class="op">=</span> <span class="st">"Total within-clusters sum of squares"</span>,</span>
<span>     col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"red"</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="fl">8</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="03-intro_files/figure-html/chunk_chapter3_13-1.png" width="100%" style="display: block; margin: auto;"></div>
<p>Often, one is interested in sparse models. Furthermore, higher k than necessary tends to overfitting. At the kink in the picture, the sum of squares dropped enough and k is still low enough.
But keep in mind, this is only a rule of thumb and might be wrong in some special cases.</p>
</div>
<div id="density-based-clustering" class="section level3" number="3.1.3">
<h3>
<span class="header-section-number">3.1.3</span> Density-based Clustering<a class="anchor" aria-label="anchor" href="#density-based-clustering"><i class="fas fa-link"></i></a>
</h3>
<p>Determine the affinity of a data point according to the affinity of its k nearest neighbors.
This is a very general description as there are many ways to do so.</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Reminder: traits = as.matrix(iris[,1:4]).</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mhahsler/dbscan">dbscan</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/dbscan/man/kNNdist.html">kNNdistplot</a></span><span class="op">(</span><span class="va">traits</span>, k <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>   <span class="co"># Calculate and plot k-nearest-neighbor distances.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="fl">0.4</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="03-intro_files/figure-html/chunk_chapter3_14-1.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">dc</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/dbscan/man/dbscan.html">dbscan</a></span><span class="op">(</span><span class="va">traits</span>, eps <span class="op">=</span> <span class="fl">0.4</span>, minPts <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">dc</span><span class="op">)</span></span>
<span><span class="co">#&gt; DBSCAN clustering for 150 objects.</span></span>
<span><span class="co">#&gt; Parameters: eps = 0.4, minPts = 6</span></span>
<span><span class="co">#&gt; The clustering contains 4 cluster(s) and 32 noise points.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  0  1  2  3  4 </span></span>
<span><span class="co">#&gt; 32 46 36 14 22 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Available fields: cluster, eps, minPts</span></span></code></pre></div>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://www.sthda.com/english/rpkgs/factoextra">factoextra</a></span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/factoextra/man/fviz_cluster.html">fviz_cluster</a></span><span class="op">(</span><span class="va">dc</span>, <span class="va">traits</span>, geom <span class="op">=</span> <span class="st">"point"</span>, ggtheme <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_light</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="03-intro_files/figure-html/chunk_chapter3_16-1.png" width="100%" style="display: block; margin: auto;"></div>
</div>
<div id="model-based-clustering" class="section level3" number="3.1.4">
<h3>
<span class="header-section-number">3.1.4</span> Model-based Clustering<a class="anchor" aria-label="anchor" href="#model-based-clustering"><i class="fas fa-link"></i></a>
</h3>
<p>The last class of methods for unsupervised clustering are so-called <em>model-based clustering methods</em>.</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mclust-org.github.io/mclust/">mclust</a></span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mb</span> <span class="op">=</span> <span class="fu"><a href="https://mclust-org.github.io/mclust/reference/Mclust.html">Mclust</a></span><span class="op">(</span><span class="va">traits</span><span class="op">)</span></span></code></pre></div>
<p>Mclust automatically compares a number of candidate models (clusters, shape) according to BIC (The BIC is a criterion for classifying algorithms depending their prediction quality and their usage of parameters). We can look at the selected model via:</p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mb</span><span class="op">$</span><span class="va">G</span> <span class="co"># Two clusters.</span></span>
<span><span class="co">#&gt; [1] 2</span></span>
<span><span class="va">mb</span><span class="op">$</span><span class="va">modelName</span> <span class="co"># &gt; Ellipsoidal, equal shape.</span></span>
<span><span class="co">#&gt; [1] "VEV"</span></span></code></pre></div>
<p>We see that the algorithm prefers having 2 clusters. For better comparability to the other 2 methods, we will override this by setting:</p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mb3</span> <span class="op">=</span> <span class="fu"><a href="https://mclust-org.github.io/mclust/reference/Mclust.html">Mclust</a></span><span class="op">(</span><span class="va">traits</span>, <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p>Result in terms of the predicted densities for 3 clusters</p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">mb3</span>, <span class="st">"density"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="03-intro_files/figure-html/chunk_chapter3_21-1.png" width="100%" style="display: block; margin: auto;"></div>
<p>Predicted clusters:</p>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">mb3</span>, what<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"classification"</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="03-intro_files/figure-html/chunk_chapter3_22-1.png" width="100%" style="display: block; margin: auto;"></div>
<p>Confusion matrix:</p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Species</span>, <span class="va">mb3</span><span class="op">$</span><span class="va">classification</span><span class="op">)</span></span>
<span><span class="co">#&gt;             </span></span>
<span><span class="co">#&gt;               1  2  3</span></span>
<span><span class="co">#&gt;   setosa     50  0  0</span></span>
<span><span class="co">#&gt;   versicolor  0 45  5</span></span>
<span><span class="co">#&gt;   virginica   0  0 50</span></span></code></pre></div>
</div>
<div id="ordination" class="section level3" number="3.1.5">
<h3>
<span class="header-section-number">3.1.5</span> Ordination<a class="anchor" aria-label="anchor" href="#ordination"><i class="fas fa-link"></i></a>
</h3>
<p>Ordination is used in explorative analysis and compared to clustering, similar objects are ordered together.
So there is a relationship between clustering and ordination. Here a PCA ordination on on the iris data set.</p>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pcTraits</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/prcomp.html">prcomp</a></span><span class="op">(</span><span class="va">traits</span>, center <span class="op">=</span> <span class="cn">TRUE</span>, scale. <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/biplot.html">biplot</a></span><span class="op">(</span><span class="va">pcTraits</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.25</span>, <span class="fl">0.25</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.25</span>, <span class="fl">0.25</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="03-intro_files/figure-html/chunk_chapter3_24-1.png" width="100%" style="display: block; margin: auto;"></div>
<p>You can cluster the results of this ordination, ordinate before clustering, or superimpose one on the other.</p>
</div>
<div id="exercises" class="section level3" number="3.1.6">
<h3>
<span class="header-section-number">3.1.6</span> Exercises<a class="anchor" aria-label="anchor" href="#exercises"><i class="fas fa-link"></i></a>
</h3>
  <hr>
<strong><span style="color: #0011AA; font-size:25px;">Tasks</span></strong><br><p>Go through the 4(5) algorithms above, and check if they are sensitive (i.e. if results change) if you scale the input features (= predictors), instead of using the raw data. Discuss in your group: Which is more appropriate for this analysis and/or in general: Scaling or not scaling?</p>
  <details><summary><strong><span style="color: #0011AA; font-size:25px;">Solution</span></strong>
    </summary><p>
  <strong><span style="font-size:20px;">Hierarchical Clustering</span></strong>
</p>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://talgalili.github.io/dendextend/">dendextend</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">methods</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ward.D"</span>, <span class="st">"single"</span>, <span class="st">"complete"</span>, <span class="st">"average"</span>,</span>
<span>            <span class="st">"mcquitty"</span>, <span class="st">"median"</span>, <span class="st">"centroid"</span>, <span class="st">"ward.D2"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cluster_all_methods</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">distances</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">out</span> <span class="op">=</span> <span class="fu"><a href="http://talgalili.github.io/dendextend/reference/dendlist.html">dendlist</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">method</span> <span class="kw">in</span> <span class="va">methods</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">res</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/hclust.html">hclust</a></span><span class="op">(</span><span class="va">distances</span>, method <span class="op">=</span> <span class="va">method</span><span class="op">)</span>   </span>
<span>    <span class="va">out</span> <span class="op">=</span> <span class="fu"><a href="http://talgalili.github.io/dendextend/reference/dendlist.html">dendlist</a></span><span class="op">(</span><span class="va">out</span>, <span class="fu"><a href="https://rdrr.io/r/stats/dendrogram.html">as.dendrogram</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span> <span class="op">=</span> <span class="va">methods</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">get_ordered_3_clusters</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">dend</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu">cutree</span><span class="op">(</span><span class="va">dend</span>, k <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/order.dendrogram.html">order.dendrogram</a></span><span class="op">(</span><span class="va">dend</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">compare_clusters_to_iris</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">clus</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="http://talgalili.github.io/dendextend/reference/FM_index.html">FM_index</a></span><span class="op">(</span><span class="va">clus</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, each <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>, assume_sorted_vectors <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">do_clustering</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">traits</span>, <span class="va">scale</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span>  <span class="va">headline</span> <span class="op">=</span> <span class="st">"Performance of linkage methods\nin detecting the 3 species\n"</span></span>
<span>  </span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">scale</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">traits</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">traits</span><span class="op">)</span>  <span class="co"># Do scaling on copy of traits.</span></span>
<span>    <span class="va">headline</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">headline</span>, <span class="st">"Scaled"</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="kw">else</span><span class="op">{</span> <span class="va">headline</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">headline</span>, <span class="st">"Not scaled"</span><span class="op">)</span> <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">distances</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/dist.html">dist</a></span><span class="op">(</span><span class="va">traits</span><span class="op">)</span></span>
<span>  <span class="va">out</span> <span class="op">=</span> <span class="fu">cluster_all_methods</span><span class="op">(</span><span class="va">distances</span><span class="op">)</span></span>
<span>  <span class="va">dend_3_clusters</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">out</span>, <span class="va">get_ordered_3_clusters</span><span class="op">)</span></span>
<span>  <span class="va">clusters_performance</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">dend_3_clusters</span>, <span class="va">compare_clusters_to_iris</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/dotchart.html">dotchart</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="va">clusters_performance</span><span class="op">)</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.3</span>,<span class="fl">1</span><span class="op">)</span>,</span>
<span>           xlab <span class="op">=</span> <span class="st">"Fowlkes-Mallows index"</span>,</span>
<span>           main <span class="op">=</span> <span class="va">headline</span>,</span>
<span>           pch <span class="op">=</span> <span class="fl">19</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">traits</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">iris</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Do clustering on unscaled data.</span></span>
<span><span class="fu">do_clustering</span><span class="op">(</span><span class="va">traits</span>, <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="03-intro_files/figure-html/chunk_chapter3_task_0-1.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Do clustering on scaled data.</span></span>
<span><span class="fu">do_clustering</span><span class="op">(</span><span class="va">traits</span>, <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="03-intro_files/figure-html/chunk_chapter3_task_0-2.png" width="100%" style="display: block; margin: auto;"></div>
<p>It seems that scaling is harmful for hierarchical clustering. But this might be a deception.
<strong>Be careful:</strong> If you have data on different units or magnitudes, scaling is definitely useful! Otherwise variables with higher values get higher influence.</p>
  <strong><span style="font-size:20px;">K-means Clustering</span></strong>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">do_clustering</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">traits</span>, <span class="va">scale</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">scale</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">traits</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">traits</span><span class="op">)</span>  <span class="co"># Do scaling on copy of traits.</span></span>
<span>    <span class="va">headline</span> <span class="op">=</span> <span class="st">"K-means Clustering\nScaled\nSum of all tries: "</span></span>
<span>  <span class="op">}</span><span class="kw">else</span><span class="op">{</span> <span class="va">headline</span> <span class="op">=</span> <span class="st">"K-means Clustering\nNot scaled\nSum of all tries: "</span> <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">getSumSq</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">k</span><span class="op">)</span><span class="op">{</span> <span class="fu"><a href="https://rdrr.io/r/stats/kmeans.html">kmeans</a></span><span class="op">(</span><span class="va">traits</span>, <span class="va">k</span>, nstart <span class="op">=</span> <span class="fl">25</span><span class="op">)</span><span class="op">$</span><span class="va">tot.withinss</span> <span class="op">}</span></span>
<span>  <span class="va">iris.kmeans1to10</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="va">getSumSq</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">headline</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">headline</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">iris.kmeans1to10</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="va">iris.kmeans1to10</span>, type <span class="op">=</span> <span class="st">"b"</span>, pch <span class="op">=</span> <span class="fl">19</span>, frame <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>       main <span class="op">=</span> <span class="va">headline</span>,</span>
<span>       xlab <span class="op">=</span> <span class="st">"Number of clusters K"</span>,</span>
<span>       ylab <span class="op">=</span> <span class="st">"Total within-clusters sum of squares"</span>,</span>
<span>       col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"red"</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="fl">8</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">traits</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">iris</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Do clustering on unscaled data.</span></span>
<span><span class="fu">do_clustering</span><span class="op">(</span><span class="va">traits</span>, <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="03-intro_files/figure-html/chunk_chapter3_task_1-1.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Do clustering on scaled data.</span></span>
<span><span class="fu">do_clustering</span><span class="op">(</span><span class="va">traits</span>, <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="03-intro_files/figure-html/chunk_chapter3_task_1-2.png" width="100%" style="display: block; margin: auto;"></div>
<p>It seems that scaling is harmful for K-means clustering. But this might be a deception.
<strong><em>Be careful:</em></strong> If you have data on different units or magnitudes, scaling is definitely useful! Otherwise variables with higher values get higher influence.</p>
  <strong><span style="font-size:20px;">Density-based Clustering</span></strong>
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mhahsler/dbscan">dbscan</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">correct</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">iris</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co"># Start at 1. Noise points will get 0 later.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">correct</span><span class="op">)</span> <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">correct</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">correct</span></span>
<span><span class="co">#&gt;   [1] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1</span></span>
<span><span class="co">#&gt;  [28] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 2 2 2 2</span></span>
<span><span class="co">#&gt;  [55] 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2</span></span>
<span><span class="co">#&gt;  [82] 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 3 3 3 3 3 3 3 3</span></span>
<span><span class="co">#&gt; [109] 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3</span></span>
<span><span class="co">#&gt; [136] 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3</span></span>
<span><span class="co">#&gt; Levels: 1 2 3</span></span>
<span></span>
<span><span class="va">do_clustering</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">traits</span>, <span class="va">scale</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">scale</span><span class="op">)</span><span class="op">{</span> <span class="va">traits</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">traits</span><span class="op">)</span> <span class="op">}</span> <span class="co"># Do scaling on copy of traits.</span></span>
<span>  </span>
<span>  <span class="co">#####</span></span>
<span>  <span class="co"># Play around with the parameters "eps" and "minPts" on your own!</span></span>
<span>  <span class="co">#####</span></span>
<span>  <span class="va">dc</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/dbscan/man/dbscan.html">dbscan</a></span><span class="op">(</span><span class="va">traits</span>, eps <span class="op">=</span> <span class="fl">0.41</span>, minPts <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">labels</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">dc</span><span class="op">$</span><span class="va">cluster</span><span class="op">)</span></span>
<span>  <span class="va">noise</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">dc</span><span class="op">$</span><span class="va">cluster</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">labels</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"noise"</span>, <span class="fl">1</span><span class="op">:</span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">labels</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">tbl</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">correct</span>, <span class="va">labels</span><span class="op">)</span></span>
<span>  <span class="va">correct_classified</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">correct</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">correct_classified</span> <span class="op">=</span> <span class="va">correct_classified</span> <span class="op">+</span> <span class="va">tbl</span><span class="op">[</span><span class="va">i</span>, <span class="va">i</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span> <span class="kw">if</span><span class="op">(</span><span class="va">scale</span><span class="op">)</span><span class="op">{</span> <span class="st">"Scaled"</span> <span class="op">}</span><span class="kw">else</span><span class="op">{</span> <span class="st">"Not scaled"</span> <span class="op">}</span>, <span class="st">"\n\n"</span> <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Confusion matrix:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">tbl</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"\nCorrect classified points: "</span>, <span class="va">correct_classified</span>, <span class="st">" / "</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">iris</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"\nSum of noise points: "</span>, <span class="va">noise</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">traits</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">iris</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Do clustering on unscaled data.</span></span>
<span><span class="fu">do_clustering</span><span class="op">(</span><span class="va">traits</span>, <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Not scaled </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Confusion matrix:</span></span>
<span><span class="co">#&gt;        labels</span></span>
<span><span class="co">#&gt; correct noise  1  2  3  4</span></span>
<span><span class="co">#&gt;       1     3 47  0  0  0</span></span>
<span><span class="co">#&gt;       2     5  0 38  3  4</span></span>
<span><span class="co">#&gt;       3    17  0  0 33  0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Correct classified points:  118  /  150</span></span>
<span><span class="co">#&gt; Sum of noise points:  25</span></span>
<span></span>
<span><span class="co"># Do clustering on scaled data.</span></span>
<span><span class="fu">do_clustering</span><span class="op">(</span><span class="va">traits</span>, <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Scaled </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Confusion matrix:</span></span>
<span><span class="co">#&gt;        labels</span></span>
<span><span class="co">#&gt; correct noise  1  2  3  4</span></span>
<span><span class="co">#&gt;       1     9 41  0  0  0</span></span>
<span><span class="co">#&gt;       2    14  0 36  0  0</span></span>
<span><span class="co">#&gt;       3    36  0  1  4  9</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Correct classified points:  81  /  150</span></span>
<span><span class="co">#&gt; Sum of noise points:  59</span></span></code></pre></div>
<p>It seems that scaling is harmful for density based clustering. But this might be a deception.
<strong><em>Be careful:</em></strong> If you have data on different units or magnitudes, scaling is definitely useful! Otherwise variables with higher values get higher influence.</p>
  <strong><span style="font-size:20px;">Model-based Clustering</span></strong>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mclust-org.github.io/mclust/">mclust</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">do_clustering</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">traits</span>, <span class="va">scale</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">scale</span><span class="op">)</span><span class="op">{</span> <span class="va">traits</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">traits</span><span class="op">)</span> <span class="op">}</span> <span class="co"># Do scaling on copy of traits.</span></span>
<span>  </span>
<span>  <span class="va">mb3</span> <span class="op">=</span> <span class="fu"><a href="https://mclust-org.github.io/mclust/reference/Mclust.html">Mclust</a></span><span class="op">(</span><span class="va">traits</span>, <span class="fl">3</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">tbl</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Species</span>, <span class="va">mb3</span><span class="op">$</span><span class="va">classification</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span> <span class="kw">if</span><span class="op">(</span><span class="va">scale</span><span class="op">)</span><span class="op">{</span> <span class="st">"Scaled"</span> <span class="op">}</span><span class="kw">else</span><span class="op">{</span> <span class="st">"Not scaled"</span> <span class="op">}</span>, <span class="st">"\n\n"</span> <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Confusion matrix:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">tbl</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"\nCorrect classified points: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="va">tbl</span><span class="op">)</span><span class="op">)</span>, <span class="st">" / "</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">iris</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">traits</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">iris</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Do clustering on unscaled data.</span></span>
<span><span class="fu">do_clustering</span><span class="op">(</span><span class="va">traits</span>, <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Not scaled </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Confusion matrix:</span></span>
<span><span class="co">#&gt;             </span></span>
<span><span class="co">#&gt;               1  2  3</span></span>
<span><span class="co">#&gt;   setosa     50  0  0</span></span>
<span><span class="co">#&gt;   versicolor  0 45  5</span></span>
<span><span class="co">#&gt;   virginica   0  0 50</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Correct classified points:  145  /  150</span></span>
<span></span>
<span><span class="co"># Do clustering on scaled data.</span></span>
<span><span class="fu">do_clustering</span><span class="op">(</span><span class="va">traits</span>, <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Scaled </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Confusion matrix:</span></span>
<span><span class="co">#&gt;             </span></span>
<span><span class="co">#&gt;               1  2  3</span></span>
<span><span class="co">#&gt;   setosa     50  0  0</span></span>
<span><span class="co">#&gt;   versicolor  0 45  5</span></span>
<span><span class="co">#&gt;   virginica   0  0 50</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Correct classified points:  145  /  150</span></span></code></pre></div>
<p>For model based clustering, scaling does not matter.</p>
  <strong><span style="font-size:20px;">Ordination</span></strong>
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">traits</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">iris</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/biplot.html">biplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/prcomp.html">prcomp</a></span><span class="op">(</span><span class="va">traits</span>, center <span class="op">=</span> <span class="cn">TRUE</span>, scale. <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>       main <span class="op">=</span> <span class="st">"Use integrated scaling"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="03-intro_files/figure-html/chunk_chapter3_task_4-1.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/biplot.html">biplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/prcomp.html">prcomp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">traits</span><span class="op">)</span>, center <span class="op">=</span> <span class="cn">FALSE</span>, scale. <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>       main <span class="op">=</span> <span class="st">"Scale explicitly"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="03-intro_files/figure-html/chunk_chapter3_task_4-2.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/biplot.html">biplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/prcomp.html">prcomp</a></span><span class="op">(</span><span class="va">traits</span>, center <span class="op">=</span> <span class="cn">FALSE</span>, scale. <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>       main <span class="op">=</span> <span class="st">"No scaling at all"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="03-intro_files/figure-html/chunk_chapter3_task_4-3.png" width="100%" style="display: block; margin: auto;"></div>
<p>For PCA ordination, scaling matters.
Because we are interested in directions of maximal variance, all parameters should be scaled, or the one with the highest values might dominate all others.</p>
    
  </details><br><hr>
</div>
</div>
<div id="supervised-learning-regression-and-classification" class="section level2" number="3.2">
<h2>
<span class="header-section-number">3.2</span> Supervised Learning: Regression and Classification<a class="anchor" aria-label="anchor" href="#supervised-learning-regression-and-classification"><i class="fas fa-link"></i></a>
</h2>
<p>The two most prominent branches of supervised learning are regression and classification. Fundamentally, classification is about predicting a label and regression is about predicting a quantity. The following video explains that in more depth:</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/i04Pfrb71vk" frameborder="0" allow="accelerometer; autoplay; encrypted-media;
  gyroscope; picture-in-picture" allowfullscreen>
</iframe>
<div id="supervised-regression-using-random-forest" class="section level3" number="3.2.1">
<h3>
<span class="header-section-number">3.2.1</span> Supervised Regression Using Random Forest<a class="anchor" aria-label="anchor" href="#supervised-regression-using-random-forest"><i class="fas fa-link"></i></a>
</h3>
<p>The random forest (RF) algorithm is possibly the most widely used machine learning algorithm and can be used for regression and classification. We will talk more about the algorithm tomorrow.</p>
<p>For the moment, we want to go through a typical workflow for a supervised regression: First, we visualize the data. Next, we fit the model and lastly we visualize the results. We will again use the iris data set that we used before. The goal is now to predict Sepal.Length based on the information about the other variables (including species).</p>
<p>Fitting the model:</p>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://www.stat.berkeley.edu/~breiman/RandomForests/">randomForest</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/randomForest/man/randomForest.html">randomForest</a></span><span class="op">(</span><span class="va">Sepal.Length</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">iris</span><span class="op">)</span>   <span class="co"># ~.: Against all others.</span></span>
<span><span class="co"># str(m1)</span></span>
<span><span class="co"># m1$type</span></span>
<span><span class="co"># predict(m1)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">m1</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt;  randomForest(formula = Sepal.Length ~ ., data = iris) </span></span>
<span><span class="co">#&gt;                Type of random forest: regression</span></span>
<span><span class="co">#&gt;                      Number of trees: 500</span></span>
<span><span class="co">#&gt; No. of variables tried at each split: 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;           Mean of squared residuals: 0.1364625</span></span>
<span><span class="co">#&gt;                     % Var explained: 79.97</span></span></code></pre></div>
<p>Visualization of the results:</p>
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">oldpar</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">m1</span><span class="op">)</span>, <span class="va">iris</span><span class="op">$</span><span class="va">Sepal.Length</span>, xlab <span class="op">=</span> <span class="st">"Predicted"</span>, ylab <span class="op">=</span> <span class="st">"Observed"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/randomForest/man/varImpPlot.html">varImpPlot</a></span><span class="op">(</span><span class="va">m1</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="03-intro_files/figure-html/chunk_chapter3_28-1.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span><span class="va">oldpar</span><span class="op">)</span></span></code></pre></div>
<p>To understand the structure of a random forest in more detail, we can use a package from GitHub.</p>
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">reprtree</span><span class="fu">:::</span><span class="fu">plot.getTree</span><span class="op">(</span><span class="va">m1</span>, <span class="va">iris</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="03-intro_files/figure-html/chunk_chapter3_29-1.png" width="100%" style="display: block; margin: auto;"></div>
<p>Here, one of the regression trees is shown.</p>
</div>
<div id="supervised-classification-using-random-forest" class="section level3" number="3.2.2">
<h3>
<span class="header-section-number">3.2.2</span> Supervised Classification Using Random Forest<a class="anchor" aria-label="anchor" href="#supervised-classification-using-random-forest"><i class="fas fa-link"></i></a>
</h3>
<p>With the random forest, we can also do classification. The steps are the same as for regression tasks, but we can additionally see how well it performed by looking at the confusion matrix. Each row of this matrix contains the instances in a predicted class and each column represents the instances in the actual class. Thus the diagonals are the correctly predicted classes and the off-diagonal elements are the falsely classified elements.</p>
<p>Fitting the model:</p>
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="va">m1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/randomForest/man/randomForest.html">randomForest</a></span><span class="op">(</span><span class="va">Species</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">iris</span><span class="op">)</span></span></code></pre></div>
<p>Visualizing one of the fitted models:</p>
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">oldpar</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">reprtree</span><span class="fu">:::</span><span class="fu">plot.getTree</span><span class="op">(</span><span class="va">m1</span>, <span class="va">iris</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="03-intro_files/figure-html/chunk_chapter3_31-1.png" width="100%" style="display: block; margin: auto;"></div>
<p>Visualizing results ecologically:</p>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Petal.Width</span>, <span class="va">iris</span><span class="op">$</span><span class="va">Petal.Length</span>, col <span class="op">=</span> <span class="va">iris</span><span class="op">$</span><span class="va">Species</span>, main <span class="op">=</span> <span class="st">"Observed"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Petal.Width</span>, <span class="va">iris</span><span class="op">$</span><span class="va">Petal.Length</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">m1</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">"Predicted"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="03-intro_files/figure-html/chunk_chapter3_32-1.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span><span class="va">oldpar</span><span class="op">)</span>   <span class="co">#Reset par.</span></span></code></pre></div>
<p>Confusion matrix:</p>
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">m1</span><span class="op">)</span>, <span class="va">iris</span><span class="op">$</span><span class="va">Species</span><span class="op">)</span></span>
<span><span class="co">#&gt;             </span></span>
<span><span class="co">#&gt;              setosa versicolor virginica</span></span>
<span><span class="co">#&gt;   setosa         50          0         0</span></span>
<span><span class="co">#&gt;   versicolor      0         47         4</span></span>
<span><span class="co">#&gt;   virginica       0          3        46</span></span></code></pre></div>
  <hr>
<details><summary><strong><span style="color: #0011AA; font-size:25px;">Questions</span></strong>
    </summary><p>
      <script>
        makeMultipleChoiceForm(
         'Using a random forest on the iris dataset, which parameter would be more important (remember there is a function to check this) to predict Petal.Width?',
          'radio',
          [
            {
              'answer':'Species.',
              'correct':true,
              'explanationIfSelected':'',
              'explanationIfNotSelected':'',
              'explanationGeneral':''
            },
            {
              'answer':'Sepal.Width.',
              'correct':false,
              'explanationIfSelected':'',
              'explanationIfNotSelected':'',
              'explanationGeneral':''
            },
          ],
          ''
        );
      </script></p>
  </details><hr>
</div>
</div>
<div id="basicMath" class="section level2" number="3.3">
<h2>
<span class="header-section-number">3.3</span> Small Introduction Into the Underlying Mathematical Concepts of all Following Lessons - Optional<a class="anchor" aria-label="anchor" href="#basicMath"><i class="fas fa-link"></i></a>
</h2>
<p>If are not yet familiar with the underlying concepts of neural networks and want to know more about that, it is suggested to read / view the following videos / sites. Consider the Links and videos with descriptions in parentheses as optional bonus.</p>
<p><em><strong>This might be useful to understand the further concepts in more depth.</strong></em></p>
<ul>
<li><p>(<a href="https://en.wikipedia.org/wiki/Newton%27s_method#Description" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Newton%27s_method#Description</a> (Especially the animated graphic is interesting).)</p></li>
<li><p><a href="https://en.wikipedia.org/wiki/Gradient_descent#Description" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Gradient_descent#Description</a></p></li>
<li><p><a href="https://mlfromscratch.com/neural-networks-explained/#/" target="_blank" rel="noopener">Neural networks (Backpropagation, etc.)</a>.</p></li>
<li><p><a href="https://mlfromscratch.com/activation-functions-explained/#/" target="_blank" rel="noopener">Activation functions in detail</a> (requires the above as prerequisite).</p></li>
</ul>
<p><em><strong>Videos about the topic</strong></em>:</p>
<ul>
<li><strong>Gradient descent explained</strong></li>
</ul>
<iframe width="560" height="315" src="https://www.youtube.com/embed/sDv4f4s2SB8" frameborder="0" allow="accelerometer; autoplay; clipboard-write;
  encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
</iframe>
<ul>
<li>(Stochastic gradient descent explained)</li>
</ul>
<iframe width="560" height="315" src="https://www.youtube.com/embed/vMh0zPT0tLI" frameborder="0" allow="accelerometer; autoplay; clipboard-write;
  encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
</iframe>
<ul>
<li>(Entropy explained)</li>
</ul>
<iframe width="560" height="315" src="https://www.youtube.com/embed/YtebGVx-Fxw" frameborder="0" allow="accelerometer; autoplay; clipboard-write;
  encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
</iframe>
<ul>
<li><strong>Short explanation of entropy, cross entropy and Kullback–Leibler divergence</strong></li>
</ul>
<iframe width="560" height="315" src="https://www.youtube.com/embed/ErfnhcEV1O8" frameborder="0" allow="accelerometer; autoplay; clipboard-write;
  encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
</iframe>
<ul>
<li><strong>Deep Learning (chapter 1)</strong></li>
</ul>
<iframe width="560" height="315" src="https://www.youtube.com/embed/aircAruvnKk" frameborder="0" allow="accelerometer; autoplay; clipboard-write;
  encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
</iframe>
<ul>
<li><strong>How neural networks learn - Deep Learning (chapter 2)</strong></li>
</ul>
<iframe width="560" height="315" src="https://www.youtube.com/embed/IHZwWFHWa-w" frameborder="0" allow="accelerometer; autoplay; clipboard-write;
  encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
</iframe>
<ul>
<li><strong>Backpropagation - Deep Learning (chapter 3)</strong></li>
</ul>
<iframe width="560" height="315" src="https://www.youtube.com/embed/Ilg3gGewQ5U" frameborder="0" allow="accelerometer; autoplay; clipboard-write;
  encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
</iframe>
<ul>
<li><strong>Another video about backpropagation (extends the previous one) - Deep Learning (chapter 4)</strong></li>
</ul>
<iframe width="560" height="315" src="https://www.youtube.com/embed/tIeHLnjs5U8" frameborder="0" allow="accelerometer; autoplay; clipboard-write;
  encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
</iframe>
<div id="caveat-about-learning-rates-and-activation-functions" class="section level3" number="3.3.1">
<h3>
<span class="header-section-number">3.3.1</span> Caveat About Learning Rates and Activation Functions<a class="anchor" aria-label="anchor" href="#caveat-about-learning-rates-and-activation-functions"><i class="fas fa-link"></i></a>
</h3>
<p>Depending on activation functions, it might occur that the network won’t get updated, even with high learning rates (called <em>vanishing gradient</em>, especially for “sigmoid” functions).
Furthermore, updates might overshoot (called <em>exploding gradients</em>) or activation functions will result in many zeros (especially for “relu,” <em>dying relu</em>).</p>
<p>In general, the first layers of a network tend to learn (much) more slowly than subsequent ones.</p>
</div>
</div>
<div id="introduction-to-tensorflow" class="section level2" number="3.4">
<h2>
<span class="header-section-number">3.4</span> Introduction to TensorFlow<a class="anchor" aria-label="anchor" href="#introduction-to-tensorflow"><i class="fas fa-link"></i></a>
</h2>
<p>One of the most commonly used frameworks for machine learning is <strong>TensorFlow</strong>. TensorFlow is an open source <a href="https://en.wikipedia.org/wiki/Linear_algebra" target="_blank" rel="noopener">linear algebra</a> library with focus on neural networks, published by Google in 2015. TensorFlow supports several interesting features, in particular automatic differentiation, several gradient optimizers and CPU and GPU parallelization.</p>
<p>These advantages are nicely explained in the following video:</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/MotG3XI2qSs" frameborder="0" allow="accelerometer; autoplay; encrypted-media;
  gyroscope; picture-in-picture" allowfullscreen>
</iframe>
<p>To sum up the most important points of the video:</p>
<ul>
<li>TensorFlow is a math library which is highly optimized for neural networks.</li>
<li>If a GPU is available, computations can be easily run on the GPU but even on a CPU TensorFlow is still very fast.</li>
<li>The “backend” (i.e. all the functions and all computations) are written in C++ and CUDA (CUDA is a programming language for NVIDIA GPUs).</li>
<li>The interface (the part of TensorFlow we use) is written in Python and is also available in R, which means, we can write the code in R/Python but it will be executed by the (compiled) C++ backend.</li>
</ul>
<p>All operations in TensorFlow are written in C++ and are highly optimized. But don’t worry, we don’t have to use C++ to use TensorFlow because there are several bindings for other languages. TensorFlow officially supports a Python API, but meanwhile there are several community carried APIs for other languages:</p>
<ul>
<li>R</li>
<li>Go</li>
<li>Rust</li>
<li>Swift</li>
<li>JavaScript</li>
</ul>
<p>In this course we will use TensorFlow with the <a href="https://tensorflow.rstudio.com/" target="_blank" rel="noopener">https://tensorflow.rstudio.com/</a> binding, that was developed and published 2017 by the RStudio team. First, they developed an R package (reticulate) for calling Python in R. Actually, we are using the Python TensorFlow module in R (more about this later).</p>
<p>TensorFlow offers different levels of API. We could implement a neural network completely by ourselves or we could use Keras which is provided as a submodule by TensorFlow. Keras is a powerful module for building and training neural networks. It allows us building and training neural networks in a few lines of codes. Since the end of 2018, Keras and TensorFlow are completly interoperable, allowing us to utilize the best of both. In this course, we will show how we can use Keras for neural networks but also how we can use the TensorFlow’s automatic differenation for using complex objective functions.</p>
<p>Useful links:</p>
<ul>
<li>
<a href="https://www.tensorflow.org/api_docs/python/tf" target="_blank" rel="noopener">TensorFlow documentation</a> (This is for the Python API, but just replace the “.” with “$.”)</li>
<li><a href="https://tensorflow.rstudio.com/" target="_blank" rel="noopener">Rstudio TensorFlow website</a></li>
</ul>
<div id="tensorflow-data-containers" class="section level3" number="3.4.1">
<h3>
<span class="header-section-number">3.4.1</span> TensorFlow Data Containers<a class="anchor" aria-label="anchor" href="#tensorflow-data-containers"><i class="fas fa-link"></i></a>
</h3>
<p>TensorFlow has two data containers (structures):</p>
<ul>
<li>constant (tf$constant): Creates a constant (immutable) value in the computation graph.</li>
<li>variable (tf$Variable): Creates a mutable value in the computation graph (used as parameter/weight in models).</li>
</ul>
<p>To get started with TensorFlow, we have to load the library and check if the installation worked.</p>
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Don't worry about weird messages. TensorFlow supports additional optimizations.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/exists.html">exists</a></span><span class="op">(</span><span class="st">"tf"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span></span>
<span><span class="va">immutable</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="fu">constant</span><span class="op">(</span><span class="fl">5.0</span><span class="op">)</span></span>
<span><span class="co">#&gt; Loaded Tensorflow version 2.9.1</span></span>
<span><span class="va">mutable</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="fu">constant</span><span class="op">(</span><span class="fl">5.0</span><span class="op">)</span></span></code></pre></div>
<p>Don’t worry about weird messages (they will only appear once at the start of the session).</p>
</div>
<div id="basic-operations" class="section level3" number="3.4.2">
<h3>
<span class="header-section-number">3.4.2</span> Basic Operations<a class="anchor" aria-label="anchor" href="#basic-operations"><i class="fas fa-link"></i></a>
</h3>
<p>We now can define the variables and do some math with them:</p>
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">a</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="fu">constant</span><span class="op">(</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">b</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="fu">constant</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span></span>
<span><span class="co">#&gt; tf.Tensor(5.0, shape=(), dtype=float32)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span></span>
<span><span class="co">#&gt; tf.Tensor(10.0, shape=(), dtype=float32)</span></span>
<span><span class="va">c</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="fu">add</span><span class="op">(</span><span class="va">a</span>, <span class="va">b</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">c</span><span class="op">)</span></span>
<span><span class="co">#&gt; tf.Tensor(15.0, shape=(), dtype=float32)</span></span>
<span><span class="va">tf</span><span class="op">$</span><span class="fu">print</span><span class="op">(</span><span class="va">c</span><span class="op">)</span> <span class="co"># Prints to stderr. For stdout, use k_print_tensor(..., message).</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/k_print_tensor.html">k_print_tensor</a></span><span class="op">(</span><span class="va">c</span><span class="op">)</span> <span class="co"># Comes out of Keras!</span></span>
<span><span class="co">#&gt; tf.Tensor(15.0, shape=(), dtype=float32)</span></span></code></pre></div>
<p>Normal R methods such as print() are provided by the R package “tensorflow.”</p>
<p>The TensorFlow library (created by the RStudio team) built R methods for all common operations:</p>
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">`+.tensorflow.tensor`</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">a</span>, <span class="va">b</span><span class="op">)</span><span class="op">{</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">tf</span><span class="op">$</span><span class="fu">add</span><span class="op">(</span><span class="va">a</span>,<span class="va">b</span><span class="op">)</span><span class="op">)</span> <span class="op">}</span></span>
<span><span class="co"># Mind the backticks.</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/k_print_tensor.html">k_print_tensor</a></span><span class="op">(</span><span class="va">a</span><span class="op">+</span><span class="va">b</span><span class="op">)</span></span>
<span><span class="co">#&gt; tf.Tensor(15.0, shape=(), dtype=float32)</span></span></code></pre></div>
<p>Their operators also automatically transform R numbers into constant tensors when attempting to add a tensor to an R number:</p>
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span> <span class="op">=</span> <span class="va">c</span> <span class="op">+</span> <span class="fl">5</span>  <span class="co"># 5 is automatically converted to a tensor.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span></span>
<span><span class="co">#&gt; tf.Tensor(20.0, shape=(), dtype=float32)</span></span></code></pre></div>
<p>TensorFlow containers are objects, what means that they are not just simple variables of type numeric (class(5)), but they instead have so called methods. Methods are changing the state of a class (which for most of our purposes here is the values of the object).
For instance, there is a method to transform the tensor object back to an R object:</p>
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "tensorflow.tensor"                               </span></span>
<span><span class="co">#&gt; [2] "tensorflow.python.framework.ops.EagerTensor"     </span></span>
<span><span class="co">#&gt; [3] "tensorflow.python.framework.ops._EagerTensorBase"</span></span>
<span><span class="co">#&gt; [4] "tensorflow.python.framework.ops.Tensor"          </span></span>
<span><span class="co">#&gt; [5] "tensorflow.python.types.internal.NativeObject"   </span></span>
<span><span class="co">#&gt; [6] "tensorflow.python.types.core.Tensor"             </span></span>
<span><span class="co">#&gt; [7] "python.builtin.object"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="fu">numpy</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "numeric"</span></span></code></pre></div>
</div>
<div id="tensorflow-data-types---good-practice-with-r-tensorflow" class="section level3" number="3.4.3">
<h3>
<span class="header-section-number">3.4.3</span> TensorFlow Data Types - Good Practice With R-TensorFlow<a class="anchor" aria-label="anchor" href="#tensorflow-data-types---good-practice-with-r-tensorflow"><i class="fas fa-link"></i></a>
</h3>
<p>R uses dynamic typing, what means you can assign a number, character, function or whatever to a variable and the the type is automatically inferred.
In other languages you have to state the type explicitly, e.g. in C:</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb88-1"><a href="introduction.html#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> a <span class="op">=</span> <span class="dv">5</span><span class="op">;</span></span>
<span id="cb88-2"><a href="introduction.html#cb88-2" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> a <span class="op">=</span> <span class="fl">5.0</span><span class="op">;</span></span>
<span id="cb88-3"><a href="introduction.html#cb88-3" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> a <span class="op">=</span> <span class="st">"a"</span><span class="op">;</span></span></code></pre></div>
<p>While TensorFlow tries to infer the type dynamically, you must often state it explicitly.
Common important types:</p>
<ul>
<li>float32 (floating point number with 32 bits, “single precision”)</li>
<li>float64 (floating point number with 64 bits, “double precision”)</li>
<li>int8 (integer with 8 bits)</li>
</ul>
<p>The reason why TensorFlow is so explicit about types is that many GPUs (e.g. the NVIDIA GeForces) can handle only up to 32 bit numbers! (you do not need high precision in graphical modeling)</p>
<p>But let us see in practice what we have to do with these types and how to specifcy them:</p>
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r_matrix</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">10</span><span class="op">*</span><span class="fl">10</span><span class="op">)</span>, <span class="fl">10</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">m</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="fu">constant</span><span class="op">(</span><span class="va">r_matrix</span>, dtype <span class="op">=</span> <span class="st">"float32"</span><span class="op">)</span> </span>
<span><span class="va">b</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="fu">constant</span><span class="op">(</span><span class="fl">2.0</span>, dtype <span class="op">=</span> <span class="st">"float64"</span><span class="op">)</span></span>
<span><span class="va">c</span> <span class="op">=</span> <span class="va">m</span> <span class="op">/</span> <span class="va">b</span> <span class="co"># Doesn't work! We try to divide float32/float64.</span></span></code></pre></div>
<p>So what went wrong here? We tried to divide a float32 by a float64 number, but we can only divide numbers of the same type!</p>
<div class="sourceCode" id="cb90"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r_matrix</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">10</span><span class="op">*</span><span class="fl">10</span><span class="op">)</span>, <span class="fl">10</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">m</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="fu">constant</span><span class="op">(</span><span class="va">r_matrix</span>, dtype <span class="op">=</span> <span class="st">"float64"</span><span class="op">)</span></span>
<span><span class="va">b</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="fu">constant</span><span class="op">(</span><span class="fl">2.0</span>, dtype <span class="op">=</span> <span class="st">"float64"</span><span class="op">)</span></span>
<span><span class="va">c</span> <span class="op">=</span> <span class="va">m</span> <span class="op">/</span> <span class="va">b</span> <span class="co"># Now it works.</span></span></code></pre></div>
<p>We can also specify the type of the object by providing an object e.g. tf$float64.</p>
<div class="sourceCode" id="cb91"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r_matrix</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">10</span><span class="op">*</span><span class="fl">10</span><span class="op">)</span>, <span class="fl">10</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">m</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="fu">constant</span><span class="op">(</span><span class="va">r_matrix</span>, dtype <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">float64</span><span class="op">)</span></span></code></pre></div>
<p>In TensorFlow, arguments often require exact/explicit data types:
TensorFlow often expects integers as arguments. In R however an integer is normally saved as float.
Thus, we have to use an “L” after an integer to tell the R interpreter that it should be treated as an integer:</p>
<div class="sourceCode" id="cb92"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/integer.html">is.integer</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/integer.html">is.integer</a></span><span class="op">(</span><span class="fl">5L</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">r_matrix</span><span class="op">)</span>, <span class="fl">5</span>, <span class="fl">20</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">tf</span><span class="op">$</span><span class="fu">reshape</span><span class="op">(</span><span class="va">r_matrix</span>, shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="fu">numpy</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">tf</span><span class="op">$</span><span class="fu">reshape</span><span class="op">(</span><span class="va">r_matrix</span>, shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5L</span>, <span class="fl">20L</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="fu">numpy</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Skipping the “L” is one of the most common errors when using R-TensorFlow!</p>
</div>
<div id="exercises-1" class="section level3" number="3.4.4">
<h3>
<span class="header-section-number">3.4.4</span> Exercises<a class="anchor" aria-label="anchor" href="#exercises-1"><i class="fas fa-link"></i></a>
</h3>
  <hr>
<strong><span style="color: #0011AA; font-size:25px;">Tasks</span></strong><br><p>To run TensorFlow from R, note that you can access the different mathematical operations in TensorFlow via tf$…, e.g. there is a tf$math$… for all common math operations or the tf$linalg$… for different linear algebra operations.
Tip: type tf$ and then hit the tab key to list all available options (sometimes you have to do this directly in the console).</p>
<p>An example: How to get the maximum value of a vector?</p>
<div class="sourceCode" id="cb93"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fl">100</span><span class="op">:</span><span class="fl">1</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html">as.double</a></span><span class="op">(</span><span class="fl">100</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>  <span class="co"># R solution. Integer!</span></span>
<span><span class="va">tf</span><span class="op">$</span><span class="va">math</span><span class="op">$</span><span class="fu">reduce_max</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="co"># TensorFlow solution. Integer!</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>  <span class="co"># Float!</span></span>
<span><span class="va">tf</span><span class="op">$</span><span class="va">math</span><span class="op">$</span><span class="fu">reduce_max</span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="co"># Float!</span></span></code></pre></div>
<p>Rewrite the following expressions (a to g) in TensorFlow:</p>
<div class="sourceCode" id="cb94"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">=</span> <span class="fl">100</span><span class="op">:</span><span class="fl">1</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html">as.double</a></span><span class="op">(</span><span class="fl">100</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># a)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span></span>
<span><span class="co"># b)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 50.5</span></span>
<span></span>
<span><span class="co"># c) Tip: Use Google!</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html">which.max</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span></span>
<span><span class="co"># d) </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html">which.min</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 100</span></span>
<span></span>
<span><span class="co"># e) Tip: Use Google! </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt;   [1] 100  99  98  97  96  95  94  93  92  91  90  89  88</span></span>
<span><span class="co">#&gt;  [14]  87  86  85  84  83  82  81  80  79  78  77  76  75</span></span>
<span><span class="co">#&gt;  [27]  74  73  72  71  70  69  68  67  66  65  64  63  62</span></span>
<span><span class="co">#&gt;  [40]  61  60  59  58  57  56  55  54  53  52  51  50  49</span></span>
<span><span class="co">#&gt;  [53]  48  47  46  45  44  43  42  41  40  39  38  37  36</span></span>
<span><span class="co">#&gt;  [66]  35  34  33  32  31  30  29  28  27  26  25  24  23</span></span>
<span><span class="co">#&gt;  [79]  22  21  20  19  18  17  16  15  14  13  12  11  10</span></span>
<span><span class="co">#&gt;  [92]   9   8   7   6   5   4   3   2   1</span></span>
<span></span>
<span><span class="co"># f) Tip: See tf$reshape.</span></span>
<span><span class="va">m</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">y</span>, <span class="fl">10</span>, <span class="fl">10</span><span class="op">)</span> <span class="co"># Mind: We use y here! (Float)</span></span>
<span><span class="va">m_2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">m</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span><span class="op">)</span>  <span class="co"># m %*% m is the normal matrix multiplication.</span></span>
<span><span class="va">m_2_log</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">m_2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">m_2_log</span><span class="op">)</span></span>
<span><span class="co">#&gt;           [,1]     [,2]     [,3]     [,4]     [,5]     [,6]</span></span>
<span><span class="co">#&gt;  [1,] 10.55841 10.54402 10.52943 10.51461 10.49957 10.48431</span></span>
<span><span class="co">#&gt;  [2,] 10.54402 10.52969 10.51515 10.50040 10.48542 10.47022</span></span>
<span><span class="co">#&gt;  [3,] 10.52943 10.51515 10.50067 10.48598 10.47107 10.45593</span></span>
<span><span class="co">#&gt;  [4,] 10.51461 10.50040 10.48598 10.47135 10.45651 10.44144</span></span>
<span><span class="co">#&gt;  [5,] 10.49957 10.48542 10.47107 10.45651 10.44173 10.42674</span></span>
<span><span class="co">#&gt;  [6,] 10.48431 10.47022 10.45593 10.44144 10.42674 10.41181</span></span>
<span><span class="co">#&gt;  [7,] 10.46880 10.45478 10.44057 10.42614 10.41151 10.39666</span></span>
<span><span class="co">#&gt;  [8,] 10.45305 10.43910 10.42496 10.41061 10.39605 10.38127</span></span>
<span><span class="co">#&gt;  [9,] 10.43705 10.42317 10.40910 10.39482 10.38034 10.36565</span></span>
<span><span class="co">#&gt; [10,] 10.42079 10.40699 10.39299 10.37879 10.36439 10.34977</span></span>
<span><span class="co">#&gt;           [,7]     [,8]     [,9]    [,10]</span></span>
<span><span class="co">#&gt;  [1,] 10.46880 10.45305 10.43705 10.42079</span></span>
<span><span class="co">#&gt;  [2,] 10.45478 10.43910 10.42317 10.40699</span></span>
<span><span class="co">#&gt;  [3,] 10.44057 10.42496 10.40910 10.39299</span></span>
<span><span class="co">#&gt;  [4,] 10.42614 10.41061 10.39482 10.37879</span></span>
<span><span class="co">#&gt;  [5,] 10.41151 10.39605 10.38034 10.36439</span></span>
<span><span class="co">#&gt;  [6,] 10.39666 10.38127 10.36565 10.34977</span></span>
<span><span class="co">#&gt;  [7,] 10.38158 10.36628 10.35073 10.33495</span></span>
<span><span class="co">#&gt;  [8,] 10.36628 10.35105 10.33559 10.31989</span></span>
<span><span class="co">#&gt;  [9,] 10.35073 10.33559 10.32022 10.30461</span></span>
<span><span class="co">#&gt; [10,] 10.33495 10.31989 10.30461 10.28909</span></span>
<span></span>
<span><span class="co"># g) Custom mean function i.e. rewrite the function using TensorFlow. </span></span>
<span><span class="va">mean_R</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">result</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">mean_R</span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>    <span class="co"># Test for equality.</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
  <details><summary><strong><span style="color: #0011AA; font-size:25px;">Solution</span></strong>
    </summary><p>
</p>
<div class="sourceCode" id="cb95"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fl">100</span><span class="op">:</span><span class="fl">1</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html">as.double</a></span><span class="op">(</span><span class="fl">100</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># a)    min(x)</span></span>
<span><span class="va">tf</span><span class="op">$</span><span class="va">math</span><span class="op">$</span><span class="fu">reduce_min</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="co"># Integer!</span></span>
<span><span class="co">#&gt; tf.Tensor(1, shape=(), dtype=int32)</span></span>
<span><span class="va">tf</span><span class="op">$</span><span class="va">math</span><span class="op">$</span><span class="fu">reduce_min</span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="co"># Float!</span></span>
<span><span class="co">#&gt; tf.Tensor(1.0, shape=(), dtype=float32)</span></span>
<span></span>
<span><span class="co"># b)    mean(x)</span></span>
<span><span class="co"># Check out the difference here:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 50.5</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 50.5</span></span>
<span><span class="va">tf</span><span class="op">$</span><span class="va">math</span><span class="op">$</span><span class="fu">reduce_mean</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>  <span class="co"># Integer!</span></span>
<span><span class="co">#&gt; tf.Tensor(50, shape=(), dtype=int32)</span></span>
<span><span class="va">tf</span><span class="op">$</span><span class="va">math</span><span class="op">$</span><span class="fu">reduce_mean</span><span class="op">(</span><span class="va">y</span><span class="op">)</span>  <span class="co"># Float!</span></span>
<span><span class="co">#&gt; tf.Tensor(50.5, shape=(), dtype=float32)</span></span>
<span></span>
<span><span class="co"># c)    which.max(x)</span></span>
<span><span class="va">tf</span><span class="op">$</span><span class="fu">argmax</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; tf.Tensor(0, shape=(), dtype=int64)</span></span>
<span><span class="va">tf</span><span class="op">$</span><span class="fu">argmax</span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span><span class="co">#&gt; tf.Tensor(0, shape=(), dtype=int64)</span></span>
<span></span>
<span><span class="co"># d)    which.min(x)</span></span>
<span><span class="va">tf</span><span class="op">$</span><span class="fu">argmin</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; tf.Tensor(99, shape=(), dtype=int64)</span></span>
<span></span>
<span><span class="co"># e)    order(x)</span></span>
<span><span class="va">tf</span><span class="op">$</span><span class="fu">argsort</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; tf.Tensor(</span></span>
<span><span class="co">#&gt; [99 98 97 96 95 94 93 92 91 90 89 88 87 86 85 84 83 82 81 80 79 78 77 76</span></span>
<span><span class="co">#&gt;  75 74 73 72 71 70 69 68 67 66 65 64 63 62 61 60 59 58 57 56 55 54 53 52</span></span>
<span><span class="co">#&gt;  51 50 49 48 47 46 45 44 43 42 41 40 39 38 37 36 35 34 33 32 31 30 29 28</span></span>
<span><span class="co">#&gt;  27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10  9  8  7  6  5  4</span></span>
<span><span class="co">#&gt;   3  2  1  0], shape=(100), dtype=int32)</span></span>
<span></span>
<span><span class="co"># f)</span></span>
<span><span class="co"># m = matrix(y, 10, 10)</span></span>
<span><span class="co"># m_2 = abs(m %*% m)</span></span>
<span><span class="co"># m_2_log = log(m_2)</span></span>
<span></span>
<span><span class="co"># Mind: We use y here! TensorFlow just accepts floats in the following lines!</span></span>
<span><span class="va">mTF</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="fu">reshape</span><span class="op">(</span><span class="va">y</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fl">10L</span>, <span class="fl">10L</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">m_2TF</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">math</span><span class="op">$</span><span class="fu">abs</span><span class="op">(</span> <span class="va">tf</span><span class="op">$</span><span class="fu">matmul</span><span class="op">(</span><span class="va">mTF</span>, <span class="va">tf</span><span class="op">$</span><span class="fu">transpose</span><span class="op">(</span><span class="va">mTF</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="va">m_2_logTF</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">math</span><span class="op">$</span><span class="fu">log</span><span class="op">(</span><span class="va">m_2TF</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">m_2_logTF</span><span class="op">)</span></span>
<span><span class="co">#&gt; tf.Tensor(</span></span>
<span><span class="co">#&gt; [[11.4217415 11.311237  11.186988  11.045079  10.87965   10.68132</span></span>
<span><span class="co">#&gt;   10.433674  10.103771   9.608109   8.582045 ]</span></span>
<span><span class="co">#&gt;  [11.311237  11.200746  11.076511  10.934624  10.769221  10.570931</span></span>
<span><span class="co">#&gt;   10.323348   9.993557   9.498147   8.473241 ]</span></span>
<span><span class="co">#&gt;  [11.186988  11.076511  10.952296  10.810434  10.645067  10.446828</span></span>
<span><span class="co">#&gt;   10.199324   9.869672   9.374583   8.351139 ]</span></span>
<span><span class="co">#&gt;  [11.045079  10.934624  10.810434  10.668606  10.503284  10.305112</span></span>
<span><span class="co">#&gt;   10.057709   9.728241   9.233569   8.212026 ]</span></span>
<span><span class="co">#&gt;  [10.87965   10.769221  10.645067  10.503284  10.338025  10.139942</span></span>
<span><span class="co">#&gt;    9.892679   9.563459   9.069353   8.0503845]</span></span>
<span><span class="co">#&gt;  [10.68132   10.570931  10.446828  10.305112  10.139942   9.941987</span></span>
<span><span class="co">#&gt;    9.694924   9.366061   8.872768   7.857481 ]</span></span>
<span><span class="co">#&gt;  [10.433674  10.323348  10.199324  10.057709   9.892679   9.694924</span></span>
<span><span class="co">#&gt;    9.448175   9.119869   8.62784    7.6182513]</span></span>
<span><span class="co">#&gt;  [10.103771   9.993557   9.869672   9.728241   9.563459   9.366061</span></span>
<span><span class="co">#&gt;    9.119869   8.79255    8.302762   7.30317  ]</span></span>
<span><span class="co">#&gt;  [ 9.608109   9.498147   9.374583   9.233569   9.069353   8.872768</span></span>
<span><span class="co">#&gt;    8.62784    8.302762   7.818028   6.8405466]</span></span>
<span><span class="co">#&gt;  [ 8.582045   8.473241   8.351139   8.212026   8.0503845  7.857481</span></span>
<span><span class="co">#&gt;    7.6182513  7.30317    6.8405466  5.9532433]], shape=(10, 10), dtype=float32)</span></span>
<span></span>
<span><span class="co"># g)    # Custom mean function</span></span>
<span><span class="va">mean_TF</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">result</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">math</span><span class="op">$</span><span class="fu">reduce_sum</span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span> <span class="va">result</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">)</span>  <span class="co"># If y is an R object.</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">mean_TF</span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span><span class="co">#&gt; tf.Tensor(True, shape=(), dtype=bool)</span></span></code></pre></div>
    
  </details><br><hr>
<strong><span style="color: #0011AA; font-size:25px;">Task</span></strong><br><p>This exercise compares the speed of R to TensorFlow.
The first exercise is to rewrite the following function in TensorFlow:</p>
<div class="sourceCode" id="cb96"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">do_something_R</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0.0</span>, <span class="fl">10L</span>, <span class="fl">10L</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">mean_per_row</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">1</span>, <span class="va">mean</span><span class="op">)</span></span>
<span>  <span class="va">result</span> <span class="op">=</span> <span class="va">x</span> <span class="op">-</span> <span class="va">mean_per_row</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Here, we provide a skeleton for a TensorFlow function:</p>
<div class="sourceCode" id="cb97"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">do_something_TF</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0.0</span>, <span class="fl">10L</span>, <span class="fl">10L</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>   <span class="va">...</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We can compare the speed using the Microbenchmark package:</p>
<div class="sourceCode" id="cb98"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0.0</span>, <span class="fl">100L</span>, <span class="fl">100L</span><span class="op">)</span></span>
<span><span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="fu">do_something_R</span><span class="op">(</span><span class="va">test</span><span class="op">)</span>, <span class="fu">do_something_TF</span><span class="op">(</span><span class="va">test</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Try different matrix sizes for the test matrix and compare the speed.</p>
<p>Tip: Have a look at the the tf.reduce_mean documentation and the “axis” argument.</p>
<p><br></p>
<p>Compare the following with different matrix sizes:</p>
<ul>
<li>test = matrix(0.0, 1000L, 500L)</li>
<li>testTF = tf$constant(test)</li>
</ul>
<p>Also try the following:</p>
<div class="sourceCode" id="cb99"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span></span>
<span>   <span class="va">tf</span><span class="op">$</span><span class="fu">matmul</span><span class="op">(</span><span class="va">testTF</span>, <span class="va">tf</span><span class="op">$</span><span class="fu">transpose</span><span class="op">(</span><span class="va">testTF</span><span class="op">)</span><span class="op">)</span>, <span class="co"># TensorFlow style.</span></span>
<span>   <span class="va">test</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">test</span><span class="op">)</span>  <span class="co"># R style.</span></span>
<span><span class="op">)</span></span></code></pre></div>
  <details><summary><strong><span style="color: #0011AA; font-size:25px;">Solution</span></strong>
    </summary><p>
</p>
<div class="sourceCode" id="cb100"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">do_something_TF</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0.0</span>, <span class="fl">10L</span>, <span class="fl">10L</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="fu">constant</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>  <span class="co"># Remember, this is a local copy!</span></span>
<span>  <span class="va">mean_per_row</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="fu">reduce_mean</span><span class="op">(</span><span class="va">x</span>, axis <span class="op">=</span> <span class="fl">0L</span><span class="op">)</span></span>
<span>  <span class="va">result</span> <span class="op">=</span> <span class="va">x</span> <span class="op">-</span> <span class="va">mean_per_row</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb101"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0.0</span>, <span class="fl">100L</span>, <span class="fl">100L</span><span class="op">)</span></span>
<span><span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="fu">do_something_R</span><span class="op">(</span><span class="va">test</span><span class="op">)</span>, <span class="fu">do_something_TF</span><span class="op">(</span><span class="va">test</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Unit: microseconds</span></span>
<span><span class="co">#&gt;                   expr      min        lq      mean</span></span>
<span><span class="co">#&gt;   do_something_R(test)  488.105  515.1465  578.6744</span></span>
<span><span class="co">#&gt;  do_something_TF(test) 2348.819 2455.7905 2654.4844</span></span>
<span><span class="co">#&gt;    median       uq       max neval cld</span></span>
<span><span class="co">#&gt;   557.570  589.306  2631.497   100  a </span></span>
<span><span class="co">#&gt;  2506.715 2582.320 12534.910   100   b</span></span>
<span></span>
<span><span class="va">test</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0.0</span>, <span class="fl">1000L</span>, <span class="fl">500L</span><span class="op">)</span></span>
<span><span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="fu">do_something_R</span><span class="op">(</span><span class="va">test</span><span class="op">)</span>, <span class="fu">do_something_TF</span><span class="op">(</span><span class="va">test</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Unit: milliseconds</span></span>
<span><span class="co">#&gt;                   expr      min       lq      mean</span></span>
<span><span class="co">#&gt;   do_something_R(test) 8.807962 9.449509 12.806207</span></span>
<span><span class="co">#&gt;  do_something_TF(test) 3.737344 4.251434  5.149071</span></span>
<span><span class="co">#&gt;     median       uq      max neval cld</span></span>
<span><span class="co">#&gt;  12.010741 15.20489 27.11427   100   b</span></span>
<span><span class="co">#&gt;   4.695778  5.19169 14.26088   100  a</span></span></code></pre></div>
<p>Why is R faster (the first time)?</p>
<ul>
<li><ol style="list-style-type: lower-alpha">
<li>The R functions we used (apply, mean, “-”) are also implemented in C.</li>
</ol></li>
<li><ol start="2" style="list-style-type: lower-alpha">
<li>The problem is not large enough and TensorFlow has an overhead.</li>
</ol></li>
</ul>
<p><br></p>
<div class="sourceCode" id="cb102"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0.0</span>, <span class="fl">1000L</span>, <span class="fl">500L</span><span class="op">)</span></span>
<span><span class="va">testTF</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="fu">constant</span><span class="op">(</span><span class="va">test</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span></span>
<span>  <span class="va">tf</span><span class="op">$</span><span class="fu">matmul</span><span class="op">(</span><span class="va">testTF</span>, <span class="va">tf</span><span class="op">$</span><span class="fu">transpose</span><span class="op">(</span><span class="va">testTF</span><span class="op">)</span><span class="op">)</span>,  <span class="co"># TensorFlow style.</span></span>
<span>  <span class="va">test</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">test</span><span class="op">)</span> <span class="co"># R style.</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Unit: milliseconds</span></span>
<span><span class="co">#&gt;                                     expr      min        lq</span></span>
<span><span class="co">#&gt;  tf$matmul(testTF, tf$transpose(testTF)) 6.438021 16.264679</span></span>
<span><span class="co">#&gt;                         test %*% t(test) 7.808996  9.460024</span></span>
<span><span class="co">#&gt;      mean   median       uq       max neval cld</span></span>
<span><span class="co">#&gt;  17.84026 17.90731 20.25642  33.91409   100   a</span></span>
<span><span class="co">#&gt;  17.99433 12.18004 21.16537 230.14897   100   a</span></span></code></pre></div>
    
  </details><br><hr>
<strong><span style="color: #0011AA; font-size:25px;">Task</span></strong><br><p>Google to find out how to write the following tasks in TensorFlow:</p>
<div class="sourceCode" id="cb103"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">A</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">5</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># i)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/solve.html">solve</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span>  <span class="co"># Solve equation AX = B. If just A  is given, invert it.</span></span>
<span><span class="co">#&gt;      [,1] [,2]       [,3]</span></span>
<span><span class="co">#&gt; [1,]    1  0.0 -0.6666667</span></span>
<span><span class="co">#&gt; [2,]   -1  0.5 -0.1666667</span></span>
<span><span class="co">#&gt; [3,]    0  0.0  0.3333333</span></span>
<span></span>
<span><span class="co"># j)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span> <span class="co"># Diagonal of A, if no matrix is given, construct diagonal matrix.</span></span>
<span><span class="co">#&gt; [1] 1 2 3</span></span>
<span></span>
<span><span class="co"># k)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span><span class="op">)</span> <span class="co"># Diagonal matrix with entries diag(A).</span></span>
<span><span class="co">#&gt;      [,1] [,2] [,3]</span></span>
<span><span class="co">#&gt; [1,]    1    0    0</span></span>
<span><span class="co">#&gt; [2,]    0    2    0</span></span>
<span><span class="co">#&gt; [3,]    0    0    3</span></span>
<span></span>
<span><span class="co"># l)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/eigen.html">eigen</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span></span>
<span><span class="co">#&gt; eigen() decomposition</span></span>
<span><span class="co">#&gt; $values</span></span>
<span><span class="co">#&gt; [1] 3 2 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $vectors</span></span>
<span><span class="co">#&gt;           [,1] [,2]       [,3]</span></span>
<span><span class="co">#&gt; [1,] 0.1400280    0  0.4472136</span></span>
<span><span class="co">#&gt; [2,] 0.9801961    1 -0.8944272</span></span>
<span><span class="co">#&gt; [3,] 0.1400280    0  0.0000000</span></span>
<span></span>
<span><span class="co"># m)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/det.html">det</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 6</span></span></code></pre></div>
  <details><summary><strong><span style="color: #0011AA; font-size:25px;">Solution</span></strong>
    </summary><p>
</p>
<div class="sourceCode" id="cb104"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">A</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1.</span>, <span class="fl">2.</span>, <span class="fl">0.</span>, <span class="fl">0.</span>, <span class="fl">2.</span>, <span class="fl">0.</span>, <span class="fl">2.</span>, <span class="fl">5.</span>, <span class="fl">3.</span><span class="op">)</span>, <span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co"># Do not use the "L" form here!</span></span>
<span></span>
<span><span class="co"># i)    solve(A)</span></span>
<span><span class="va">tf</span><span class="op">$</span><span class="va">linalg</span><span class="op">$</span><span class="fu">inv</span><span class="op">(</span><span class="va">A</span><span class="op">)</span></span>
<span><span class="co">#&gt; tf.Tensor(</span></span>
<span><span class="co">#&gt; [[ 1.          0.         -0.66666667]</span></span>
<span><span class="co">#&gt;  [-1.          0.5        -0.16666667]</span></span>
<span><span class="co">#&gt;  [ 0.          0.          0.33333333]], shape=(3, 3), dtype=float64)</span></span>
<span></span>
<span><span class="co"># j)    diag(A)</span></span>
<span><span class="va">tf</span><span class="op">$</span><span class="va">linalg</span><span class="op">$</span><span class="fu">diag_part</span><span class="op">(</span><span class="va">A</span><span class="op">)</span></span>
<span><span class="co">#&gt; tf.Tensor([1. 2. 3.], shape=(3), dtype=float64)</span></span>
<span></span>
<span><span class="co"># k)    diag(diag(A))</span></span>
<span><span class="va">tf</span><span class="op">$</span><span class="va">linalg</span><span class="op">$</span><span class="fu">diag</span><span class="op">(</span><span class="va">tf</span><span class="op">$</span><span class="va">linalg</span><span class="op">$</span><span class="fu">diag_part</span><span class="op">(</span><span class="va">A</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; tf.Tensor(</span></span>
<span><span class="co">#&gt; [[1. 0. 0.]</span></span>
<span><span class="co">#&gt;  [0. 2. 0.]</span></span>
<span><span class="co">#&gt;  [0. 0. 3.]], shape=(3, 3), dtype=float64)</span></span>
<span></span>
<span><span class="co"># l)    eigen(A)</span></span>
<span><span class="va">tf</span><span class="op">$</span><span class="va">linalg</span><span class="op">$</span><span class="fu">eigh</span><span class="op">(</span><span class="va">A</span><span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; tf.Tensor([-0.56155281  3.          3.56155281], shape=(3), dtype=float64)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; tf.Tensor(</span></span>
<span><span class="co">#&gt; [[-0.78820544  0.         -0.61541221]</span></span>
<span><span class="co">#&gt;  [ 0.61541221  0.         -0.78820544]</span></span>
<span><span class="co">#&gt;  [ 0.          1.         -0.        ]], shape=(3, 3), dtype=float64)</span></span>
<span></span>
<span><span class="co"># m)    det(A)</span></span>
<span><span class="va">tf</span><span class="op">$</span><span class="va">linalg</span><span class="op">$</span><span class="fu">det</span><span class="op">(</span><span class="va">A</span><span class="op">)</span></span>
<span><span class="co">#&gt; tf.Tensor(6.0, shape=(), dtype=float64)</span></span></code></pre></div>
    
  </details><br><hr>
<strong><span style="color: #0011AA; font-size:25px;">Task</span></strong><br><p>TensorFlow supports automatic differentiation (analytical and not numerical!).
Let’s have a look at the function <span class="math inline">\(f(x) = 5 x^2 + 3\)</span> with derivative <span class="math inline">\(f'(x) = 10x\)</span>.
So for <span class="math inline">\(f'(5)\)</span> we will get <span class="math inline">\(10\)</span>.</p>
<p>Let’s do this in TensorFlow. Define the function:</p>
<div class="sourceCode" id="cb105"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">f</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fl">5.0</span> <span class="op">*</span> <span class="va">tf</span><span class="op">$</span><span class="fu">square</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">+</span> <span class="fl">3.0</span><span class="op">)</span> <span class="op">}</span></span></code></pre></div>
<p>We want to calculate the derivative for <span class="math inline">\(x = 2.0\)</span>:</p>
<div class="sourceCode" id="cb106"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="fu">constant</span><span class="op">(</span><span class="fl">2.0</span><span class="op">)</span></span></code></pre></div>
<p>To do automatic differentiation, we have to forward <span class="math inline">\(x\)</span> through the function within the tf$GradientTape() environment. We have also have to tell TensorFlow which value to “watch”:</p>
<div class="sourceCode" id="cb107"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">tf</span><span class="op">$</span><span class="fu">GradientTape</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rstudio.github.io/reticulate/reference/with-as-operator.html">%as%</a></span> <span class="va">tape</span>,</span>
<span>  <span class="op">{</span></span>
<span>    <span class="va">tape</span><span class="op">$</span><span class="fu">watch</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="va">y</span> <span class="op">=</span> <span class="fu">f</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>To print the gradient:</p>
<div class="sourceCode" id="cb108"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">tape</span><span class="op">$</span><span class="fu">gradient</span><span class="op">(</span><span class="va">y</span>, <span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; tf.Tensor(20.0, shape=(), dtype=float32)</span></span></code></pre></div>
<p>We can also calculate the second order derivative <span class="math inline">\(f''(x) = 10\)</span>:</p>
<div class="sourceCode" id="cb109"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">tf</span><span class="op">$</span><span class="fu">GradientTape</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rstudio.github.io/reticulate/reference/with-as-operator.html">%as%</a></span> <span class="va">first</span>,</span>
<span>  <span class="op">{</span></span>
<span>    <span class="va">first</span><span class="op">$</span><span class="fu">watch</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">tf</span><span class="op">$</span><span class="fu">GradientTape</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rstudio.github.io/reticulate/reference/with-as-operator.html">%as%</a></span> <span class="va">second</span>,</span>
<span>      <span class="op">{</span></span>
<span>        <span class="va">second</span><span class="op">$</span><span class="fu">watch</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>        <span class="va">y</span> <span class="op">=</span> <span class="fu">f</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>        <span class="va">g</span> <span class="op">=</span> <span class="va">first</span><span class="op">$</span><span class="fu">gradient</span><span class="op">(</span><span class="va">y</span>, <span class="va">x</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="op">(</span><span class="va">second</span><span class="op">$</span><span class="fu">gradient</span><span class="op">(</span><span class="va">g</span>, <span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; tf.Tensor(10.0, shape=(), dtype=float32)</span></span></code></pre></div>
<p>What is happening here? Think about and discuss it.</p>
<p>A more advanced example: <em>Linear regression</em></p>
<p>In this case we first simulate data following <span class="math inline">\(\boldsymbol{y} = \boldsymbol{X} \boldsymbol{w} + \boldsymbol{\epsilon}\)</span> (<span class="math inline">\(\boldsymbol{\epsilon}\)</span> follows a normal distribution == error).</p>
<div class="sourceCode" id="cb110"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/set_random_seed.html">set_random_seed</a></span><span class="op">(</span><span class="fl">321L</span>, disable_gpu <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># Already sets R's random seed.</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">500</span>, <span class="op">-</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fl">100</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">w</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="va">x</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">w</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">0</span>, <span class="fl">0.25</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<p>In R we would do the following to fit a linear regression model:</p>
<div class="sourceCode" id="cb111"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; lm(formula = y ~ x)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residuals:</span></span>
<span><span class="co">#&gt;      Min       1Q   Median       3Q      Max </span></span>
<span><span class="co">#&gt; -0.67893 -0.16399  0.00968  0.15058  0.51099 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept) 0.004865   0.027447   0.177     0.86    </span></span>
<span><span class="co">#&gt; x1          2.191511   0.023243  94.287   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; x2          2.741690   0.025328 108.249   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; x3          1.179181   0.023644  49.872   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; x4          0.591873   0.025154  23.530   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; x5          2.302417   0.022575 101.991   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  </span></span>
<span><span class="co">#&gt; 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual standard error: 0.2645 on 94 degrees of freedom</span></span>
<span><span class="co">#&gt; Multiple R-squared:  0.9974, Adjusted R-squared:  0.9972 </span></span>
<span><span class="co">#&gt; F-statistic:  7171 on 5 and 94 DF,  p-value: &lt; 2.2e-16</span></span></code></pre></div>
<p>Let’s build our own model in TensorFlow.
Here, we use now the variable data container type (remember they are mutable and we need this type for the weights (<span class="math inline">\(\boldsymbol{w}\)</span>) of the regression model). We want our model to learn these weights.</p>
<p>The input (predictors, independent variables or features, <span class="math inline">\(\boldsymbol{X}\)</span>) and the observed (response, <span class="math inline">\(\boldsymbol{y}\)</span>) are constant and will not be learned/optimized.</p>
<div class="sourceCode" id="cb112"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/set_random_seed.html">set_random_seed</a></span><span class="op">(</span><span class="fl">321L</span>, disable_gpu <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># Already sets R's random seed.</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">500</span>, <span class="op">-</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fl">100</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">w</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="va">x</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">w</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">0</span>, <span class="fl">0.25</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Weights we want to learn.</span></span>
<span><span class="co"># We know the real weights but in reality we wouldn't know them.</span></span>
<span><span class="co"># So use guessed ones.</span></span>
<span><span class="va">wTF</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="fu">Variable</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">0</span>, <span class="fl">0.01</span><span class="op">)</span>, <span class="fl">5</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">xTF</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="fu">constant</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="va">yTF</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="fu">constant</span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># We need an optimizer which updates the weights (wTF).</span></span>
<span><span class="va">optimizer</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">keras</span><span class="op">$</span><span class="va">optimizers</span><span class="op">$</span><span class="fu">Adamax</span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">100</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">tf</span><span class="op">$</span><span class="fu">GradientTape</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rstudio.github.io/reticulate/reference/with-as-operator.html">%as%</a></span> <span class="va">tape</span>,</span>
<span>    <span class="op">{</span></span>
<span>      <span class="va">pred</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="fu">matmul</span><span class="op">(</span><span class="va">xTF</span>, <span class="va">wTF</span><span class="op">)</span></span>
<span>      <span class="va">loss</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="fu">sqrt</span><span class="op">(</span><span class="va">tf</span><span class="op">$</span><span class="fu">reduce_mean</span><span class="op">(</span><span class="va">tf</span><span class="op">$</span><span class="fu">square</span><span class="op">(</span><span class="va">yTF</span> <span class="op">-</span> <span class="va">pred</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="va">i</span><span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span><span class="fl">10</span><span class="op">)</span><span class="op">{</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/k_print_tensor.html">k_print_tensor</a></span><span class="op">(</span><span class="va">loss</span>, message <span class="op">=</span> <span class="st">"Loss: "</span><span class="op">)</span> <span class="op">}</span>  <span class="co"># Every 10 times.</span></span>
<span>  <span class="va">grads</span> <span class="op">=</span> <span class="va">tape</span><span class="op">$</span><span class="fu">gradient</span><span class="op">(</span><span class="va">loss</span>, <span class="va">wTF</span><span class="op">)</span></span>
<span>  <span class="va">optimizer</span><span class="op">$</span><span class="fu">apply_gradients</span><span class="op">(</span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/transpose.html">transpose</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">grads</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">wTF</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/k_print_tensor.html">k_print_tensor</a></span><span class="op">(</span><span class="va">wTF</span>, message <span class="op">=</span> <span class="st">"Resulting weights:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;tf.Variable 'Variable:0' shape=(5, 1) dtype=float64, numpy=</span></span>
<span><span class="co">#&gt; array([[2.19290567],</span></span>
<span><span class="co">#&gt;        [2.74534135],</span></span>
<span><span class="co">#&gt;        [1.1714656 ],</span></span>
<span><span class="co">#&gt;        [0.58811305],</span></span>
<span><span class="co">#&gt;        [2.30174942]])&gt;</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Original weights: "</span>, <span class="va">w</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Original weights:  2.217 2.719 1.165 0.593 2.303</span></span></code></pre></div>
<p>Discuss the code, go through the code line by line and try to understand it.</p>
<p>Additional exercise:</p>
<p>Play around with the simulation, increase/decrease the number of weights, add an intercept (you also need an additional variable in model).</p>
  <details><summary><strong><span style="color: #0011AA; font-size:25px;">Solution</span></strong>
    </summary><p>
</p>
<div class="sourceCode" id="cb113"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/set_random_seed.html">set_random_seed</a></span><span class="op">(</span><span class="fl">321L</span>, disable_gpu <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># Already sets R's random seed.</span></span>
<span></span>
<span><span class="va">numberOfWeights</span> <span class="op">=</span> <span class="fl">3</span></span>
<span><span class="va">numberOfFeatures</span> <span class="op">=</span> <span class="fl">10000</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">numberOfFeatures</span> <span class="op">*</span> <span class="va">numberOfWeights</span>, <span class="op">-</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>           <span class="va">numberOfFeatures</span>, <span class="va">numberOfWeights</span><span class="op">)</span></span>
<span><span class="va">w</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">numberOfWeights</span>, <span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">intercept</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">.5</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="va">intercept</span> <span class="op">+</span> <span class="va">x</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">w</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">numberOfFeatures</span>, <span class="fl">0</span>, <span class="fl">0.25</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Guessed weights and intercept.</span></span>
<span><span class="va">wTF</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="fu">Variable</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">numberOfWeights</span>, <span class="fl">0</span>, <span class="fl">0.01</span><span class="op">)</span>, <span class="va">numberOfWeights</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">interceptTF</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="fu">Variable</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">.5</span><span class="op">)</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span> <span class="co"># Double, not float32.</span></span>
<span></span>
<span><span class="va">xTF</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="fu">constant</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="va">yTF</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="fu">constant</span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span></span>
<span><span class="va">optimizer</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">keras</span><span class="op">$</span><span class="va">optimizers</span><span class="op">$</span><span class="fu">Adamax</span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">100</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">tf</span><span class="op">$</span><span class="fu">GradientTape</span><span class="op">(</span>persistent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://rstudio.github.io/reticulate/reference/with-as-operator.html">%as%</a></span> <span class="va">tape</span>,</span>
<span>    <span class="op">{</span></span>
<span>      <span class="va">pred</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="fu">add</span><span class="op">(</span><span class="va">interceptTF</span>, <span class="va">tf</span><span class="op">$</span><span class="fu">matmul</span><span class="op">(</span><span class="va">xTF</span>, <span class="va">wTF</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="va">loss</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="fu">sqrt</span><span class="op">(</span><span class="va">tf</span><span class="op">$</span><span class="fu">reduce_mean</span><span class="op">(</span><span class="va">tf</span><span class="op">$</span><span class="fu">square</span><span class="op">(</span><span class="va">yTF</span> <span class="op">-</span> <span class="va">pred</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="va">i</span><span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span><span class="fl">10</span><span class="op">)</span><span class="op">{</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/k_print_tensor.html">k_print_tensor</a></span><span class="op">(</span><span class="va">loss</span>, message <span class="op">=</span> <span class="st">"Loss: "</span><span class="op">)</span> <span class="op">}</span>  <span class="co"># Every 10 times.</span></span>
<span>  <span class="va">grads</span> <span class="op">=</span> <span class="va">tape</span><span class="op">$</span><span class="fu">gradient</span><span class="op">(</span><span class="va">loss</span>, <span class="va">wTF</span><span class="op">)</span></span>
<span>  <span class="va">optimizer</span><span class="op">$</span><span class="fu">apply_gradients</span><span class="op">(</span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/transpose.html">transpose</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">grads</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">wTF</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">grads</span> <span class="op">=</span> <span class="va">tape</span><span class="op">$</span><span class="fu">gradient</span><span class="op">(</span><span class="va">loss</span>, <span class="va">interceptTF</span><span class="op">)</span></span>
<span>  <span class="va">optimizer</span><span class="op">$</span><span class="fu">apply_gradients</span><span class="op">(</span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/transpose.html">transpose</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">grads</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">interceptTF</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/k_print_tensor.html">k_print_tensor</a></span><span class="op">(</span><span class="va">wTF</span>, message <span class="op">=</span> <span class="st">"Resulting weights:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;tf.Variable 'Variable:0' shape=(3, 1) dtype=float64, numpy=</span></span>
<span><span class="co">#&gt; array([[2.46391571],</span></span>
<span><span class="co">#&gt;        [2.45852885],</span></span>
<span><span class="co">#&gt;        [1.00566707]])&gt;</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Original weights: "</span>, <span class="va">w</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Original weights:  2.47 2.465 1.003</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/k_print_tensor.html">k_print_tensor</a></span><span class="op">(</span><span class="va">interceptTF</span>, message <span class="op">=</span> <span class="st">"Resulting intercept:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;tf.Variable 'Variable:0' shape=(1, 1) dtype=float64, numpy=array([[4.22135068]])&gt;</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Original intercept: "</span>, <span class="va">intercept</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Original intercept:  4.09</span></span></code></pre></div>
    
  </details><br><hr>
</div>
</div>
<div id="introduction-to-pytorch" class="section level2" number="3.5">
<h2>
<span class="header-section-number">3.5</span> Introduction to PyTorch<a class="anchor" aria-label="anchor" href="#introduction-to-pytorch"><i class="fas fa-link"></i></a>
</h2>
<p>PyTorch is another famous library for deep learning. Like TensorFlow, Torch itself is written in C++ with an API for Python. In 2020, the RStudio team released R-Torch, and while R-TensorFlow calls the Python API in the background, the R-Torch API is built directly on the C++ Torch library!</p>
<p>Useful links:</p>
<ul>
<li>
<a href="https://pytorch.org/docs/stable/index.html" target="_blank" rel="noopener">PyTorch documentation</a> (This is for the Python API, bust just replace the “.” with “$.”)</li>
<li><a href="https://torch.mlverse.org/" target="_blank" rel="noopener">R-Torch website</a></li>
</ul>
<p>To get started with Torch, we have to load the library and check if the installation worked.</p>
<div class="sourceCode" id="cb114"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs">torch</a></span><span class="op">)</span></span></code></pre></div>
<div id="pytorch-data-containers" class="section level3" number="3.5.1">
<h3>
<span class="header-section-number">3.5.1</span> PyTorch Data Containers<a class="anchor" aria-label="anchor" href="#pytorch-data-containers"><i class="fas fa-link"></i></a>
</h3>
<p>Unlike TensorFlow, Torch doesn’t have two data containers for mutable and immutable variables. All variables are initialized via the torch_tensor function:</p>
<div class="sourceCode" id="cb115"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">a</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="fl">1.</span><span class="op">)</span></span></code></pre></div>
<p>To mark variables as mutable (and to track their operations for automatic differentiation) we have to set the argument ‘requires_grad’ to true in the torch_tensor function:</p>
<div class="sourceCode" id="cb116"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mutable</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="fl">5</span>, requires_grad <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co"># tf$Variable(...)</span></span>
<span><span class="va">immutable</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="fl">5</span>, requires_grad <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="co"># tf$constant(...)</span></span></code></pre></div>
</div>
<div id="basic-operations-1" class="section level3" number="3.5.2">
<h3>
<span class="header-section-number">3.5.2</span> Basic Operations<a class="anchor" aria-label="anchor" href="#basic-operations-1"><i class="fas fa-link"></i></a>
</h3>
<p>We now can define the variables and do some math with them:</p>
<div class="sourceCode" id="cb117"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">a</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="fl">5.</span><span class="op">)</span></span>
<span><span class="va">b</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="fl">10.</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt;  5</span></span>
<span><span class="co">#&gt; [ CPUFloatType{1} ]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt;  10</span></span>
<span><span class="co">#&gt; [ CPUFloatType{1} ]</span></span>
<span><span class="va">c</span> <span class="op">=</span> <span class="va">a</span><span class="op">$</span><span class="fu">add</span><span class="op">(</span><span class="va">b</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">c</span><span class="op">)</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt;  15</span></span>
<span><span class="co">#&gt; [ CPUFloatType{1} ]</span></span></code></pre></div>
<p>The R-Torch package provides all common R methods (an advantage over TensorFlow).</p>
<div class="sourceCode" id="cb118"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">a</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="fl">5.</span><span class="op">)</span></span>
<span><span class="va">b</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="fl">10.</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">a</span><span class="op">+</span><span class="va">b</span><span class="op">)</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt;  15</span></span>
<span><span class="co">#&gt; [ CPUFloatType{1} ]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">a</span><span class="op">/</span><span class="va">b</span><span class="op">)</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt;  0.5000</span></span>
<span><span class="co">#&gt; [ CPUFloatType{1} ]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">a</span><span class="op">*</span><span class="va">b</span><span class="op">)</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt;  50</span></span>
<span><span class="co">#&gt; [ CPUFloatType{1} ]</span></span></code></pre></div>
<p>Their operators also automatically transform R numbers into tensors when attempting to add a tensor to a R number:</p>
<div class="sourceCode" id="cb119"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span> <span class="op">=</span> <span class="va">a</span> <span class="op">+</span> <span class="fl">5</span>  <span class="co"># 5 is automatically converted to a tensor.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt;  10</span></span>
<span><span class="co">#&gt; [ CPUFloatType{1} ]</span></span></code></pre></div>
<p>As for TensorFlow, we have to explicitly transform the tensors back to R:</p>
<div class="sourceCode" id="cb120"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "torch_tensor" "R7"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "numeric"</span></span></code></pre></div>
</div>
<div id="torch-data-types---good-practice-with-r-torch" class="section level3" number="3.5.3">
<h3>
<span class="header-section-number">3.5.3</span> Torch Data Types - Good Practice With R-Torch<a class="anchor" aria-label="anchor" href="#torch-data-types---good-practice-with-r-torch"><i class="fas fa-link"></i></a>
</h3>
<p>Similar to TensorFlow:</p>
<div class="sourceCode" id="cb121"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r_matrix</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">10</span><span class="op">*</span><span class="fl">10</span><span class="op">)</span>, <span class="fl">10</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">m</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="va">r_matrix</span>, dtype <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_dtype.html">torch_float32</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="va">b</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="fl">2.0</span>, dtype <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_dtype.html">torch_float64</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">c</span> <span class="op">=</span> <span class="va">m</span> <span class="op">/</span> <span class="va">b</span> </span></code></pre></div>
<p>But here’s a difference! With TensorFlow we would get an error, but with R-Torch, m is automatically casted to a double (float64). However, this is still bad practice!</p>
<p>During the course we will try to provide the corresponding PyTorch code snippets for all Keras/TensorFlow examples.</p>
</div>
<div id="exercises-2" class="section level3" number="3.5.4">
<h3>
<span class="header-section-number">3.5.4</span> Exercises<a class="anchor" aria-label="anchor" href="#exercises-2"><i class="fas fa-link"></i></a>
</h3>
  <hr>
<strong><span style="color: #0011AA; font-size:25px;">Tasks</span></strong><br><p>Rewrite the following expressions (a to g) in torch:</p>
<div class="sourceCode" id="cb122"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">=</span> <span class="fl">100</span><span class="op">:</span><span class="fl">1</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html">as.double</a></span><span class="op">(</span><span class="fl">100</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># a)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span></span>
<span><span class="co"># b)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 50.5</span></span>
<span></span>
<span><span class="co"># c) Tip: Use Google!</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html">which.max</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span></span>
<span><span class="co"># d) </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html">which.min</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 100</span></span>
<span></span>
<span><span class="co"># e) Tip: Use Google! </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt;   [1] 100  99  98  97  96  95  94  93  92  91  90  89  88</span></span>
<span><span class="co">#&gt;  [14]  87  86  85  84  83  82  81  80  79  78  77  76  75</span></span>
<span><span class="co">#&gt;  [27]  74  73  72  71  70  69  68  67  66  65  64  63  62</span></span>
<span><span class="co">#&gt;  [40]  61  60  59  58  57  56  55  54  53  52  51  50  49</span></span>
<span><span class="co">#&gt;  [53]  48  47  46  45  44  43  42  41  40  39  38  37  36</span></span>
<span><span class="co">#&gt;  [66]  35  34  33  32  31  30  29  28  27  26  25  24  23</span></span>
<span><span class="co">#&gt;  [79]  22  21  20  19  18  17  16  15  14  13  12  11  10</span></span>
<span><span class="co">#&gt;  [92]   9   8   7   6   5   4   3   2   1</span></span>
<span></span>
<span><span class="co"># f) Tip: See tf$reshape.</span></span>
<span><span class="va">m</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">y</span>, <span class="fl">10</span>, <span class="fl">10</span><span class="op">)</span> <span class="co"># Mind: We use y here! (Float)</span></span>
<span><span class="va">m_2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">m</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span><span class="op">)</span>  <span class="co"># m %*% m is the normal matrix multiplication.</span></span>
<span><span class="va">m_2_log</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">m_2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">m_2_log</span><span class="op">)</span></span>
<span><span class="co">#&gt;           [,1]     [,2]     [,3]     [,4]     [,5]     [,6]</span></span>
<span><span class="co">#&gt;  [1,] 10.55841 10.54402 10.52943 10.51461 10.49957 10.48431</span></span>
<span><span class="co">#&gt;  [2,] 10.54402 10.52969 10.51515 10.50040 10.48542 10.47022</span></span>
<span><span class="co">#&gt;  [3,] 10.52943 10.51515 10.50067 10.48598 10.47107 10.45593</span></span>
<span><span class="co">#&gt;  [4,] 10.51461 10.50040 10.48598 10.47135 10.45651 10.44144</span></span>
<span><span class="co">#&gt;  [5,] 10.49957 10.48542 10.47107 10.45651 10.44173 10.42674</span></span>
<span><span class="co">#&gt;  [6,] 10.48431 10.47022 10.45593 10.44144 10.42674 10.41181</span></span>
<span><span class="co">#&gt;  [7,] 10.46880 10.45478 10.44057 10.42614 10.41151 10.39666</span></span>
<span><span class="co">#&gt;  [8,] 10.45305 10.43910 10.42496 10.41061 10.39605 10.38127</span></span>
<span><span class="co">#&gt;  [9,] 10.43705 10.42317 10.40910 10.39482 10.38034 10.36565</span></span>
<span><span class="co">#&gt; [10,] 10.42079 10.40699 10.39299 10.37879 10.36439 10.34977</span></span>
<span><span class="co">#&gt;           [,7]     [,8]     [,9]    [,10]</span></span>
<span><span class="co">#&gt;  [1,] 10.46880 10.45305 10.43705 10.42079</span></span>
<span><span class="co">#&gt;  [2,] 10.45478 10.43910 10.42317 10.40699</span></span>
<span><span class="co">#&gt;  [3,] 10.44057 10.42496 10.40910 10.39299</span></span>
<span><span class="co">#&gt;  [4,] 10.42614 10.41061 10.39482 10.37879</span></span>
<span><span class="co">#&gt;  [5,] 10.41151 10.39605 10.38034 10.36439</span></span>
<span><span class="co">#&gt;  [6,] 10.39666 10.38127 10.36565 10.34977</span></span>
<span><span class="co">#&gt;  [7,] 10.38158 10.36628 10.35073 10.33495</span></span>
<span><span class="co">#&gt;  [8,] 10.36628 10.35105 10.33559 10.31989</span></span>
<span><span class="co">#&gt;  [9,] 10.35073 10.33559 10.32022 10.30461</span></span>
<span><span class="co">#&gt; [10,] 10.33495 10.31989 10.30461 10.28909</span></span>
<span></span>
<span><span class="co"># g) Custom mean function i.e. rewrite the function using TensorFlow. </span></span>
<span><span class="va">mean_R</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">result</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">mean_R</span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>    <span class="co"># Test for equality.</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
  <details><summary><strong><span style="color: #0011AA; font-size:25px;">Solution</span></strong>
    </summary><p>
</p>
<div class="sourceCode" id="cb123"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs">torch</a></span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fl">100</span><span class="op">:</span><span class="fl">1</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html">as.double</a></span><span class="op">(</span><span class="fl">100</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># a)    min(x)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_min.html">torch_min</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="co"># Integer!</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt; 1</span></span>
<span><span class="co">#&gt; [ CPULongType{} ]</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_min.html">torch_min</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="co"># Float!</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt; 1</span></span>
<span><span class="co">#&gt; [ CPUFloatType{} ]</span></span>
<span></span>
<span><span class="co"># b)    mean(x)</span></span>
<span><span class="co"># Check out the difference here:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 50.5</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 50.5</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_mean.html">torch_mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="va">x</span>, dtype <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_dtype.html">torch_float32</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>  <span class="co"># Integer! Why?</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt; 50.5</span></span>
<span><span class="co">#&gt; [ CPUFloatType{} ]</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_mean.html">torch_mean</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>  <span class="co"># Float!</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt; 50.5</span></span>
<span><span class="co">#&gt; [ CPUFloatType{} ]</span></span>
<span></span>
<span><span class="co"># c)    which.max(x)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_argmax.html">torch_argmax</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt; 1</span></span>
<span><span class="co">#&gt; [ CPULongType{} ]</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_argmax.html">torch_argmax</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt; 1</span></span>
<span><span class="co">#&gt; [ CPULongType{} ]</span></span>
<span></span>
<span><span class="co"># d)    which.min(x)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_argmin.html">torch_argmin</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt; 100</span></span>
<span><span class="co">#&gt; [ CPULongType{} ]</span></span>
<span></span>
<span><span class="co"># e)    order(x)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_argsort.html">torch_argsort</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt;  100</span></span>
<span><span class="co">#&gt;   99</span></span>
<span><span class="co">#&gt;   98</span></span>
<span><span class="co">#&gt;   97</span></span>
<span><span class="co">#&gt;   96</span></span>
<span><span class="co">#&gt;   95</span></span>
<span><span class="co">#&gt;   94</span></span>
<span><span class="co">#&gt;   93</span></span>
<span><span class="co">#&gt;   92</span></span>
<span><span class="co">#&gt;   91</span></span>
<span><span class="co">#&gt;   90</span></span>
<span><span class="co">#&gt;   89</span></span>
<span><span class="co">#&gt;   88</span></span>
<span><span class="co">#&gt;   87</span></span>
<span><span class="co">#&gt;   86</span></span>
<span><span class="co">#&gt;   85</span></span>
<span><span class="co">#&gt;   84</span></span>
<span><span class="co">#&gt;   83</span></span>
<span><span class="co">#&gt;   82</span></span>
<span><span class="co">#&gt;   81</span></span>
<span><span class="co">#&gt;   80</span></span>
<span><span class="co">#&gt;   79</span></span>
<span><span class="co">#&gt;   78</span></span>
<span><span class="co">#&gt;   77</span></span>
<span><span class="co">#&gt;   76</span></span>
<span><span class="co">#&gt;   75</span></span>
<span><span class="co">#&gt;   74</span></span>
<span><span class="co">#&gt;   73</span></span>
<span><span class="co">#&gt;   72</span></span>
<span><span class="co">#&gt;   71</span></span>
<span><span class="co">#&gt; ... [the output was truncated (use n=-1 to disable)]</span></span>
<span><span class="co">#&gt; [ CPULongType{100} ]</span></span>
<span></span>
<span><span class="co"># f)</span></span>
<span><span class="co"># m = matrix(y, 10, 10)</span></span>
<span><span class="co"># m_2 = abs(m %*% m)</span></span>
<span><span class="co"># m_2_log = log(m_2)</span></span>
<span></span>
<span><span class="co"># Mind: We use y here! </span></span>
<span><span class="va">mTorch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_reshape.html">torch_reshape</a></span><span class="op">(</span><span class="va">y</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mTorch2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_abs.html">torch_abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_matmul.html">torch_matmul</a></span><span class="op">(</span><span class="va">mTorch</span>, <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_t.html">torch_t</a></span><span class="op">(</span><span class="va">mTorch</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co"># hard to read!</span></span>
<span></span>
<span><span class="co"># Better:</span></span>
<span><span class="va">mTorch2</span> <span class="op">=</span> <span class="va">mTorch</span><span class="op">$</span><span class="fu">matmul</span><span class="op">(</span> <span class="va">mTorch</span><span class="op">$</span><span class="fu">t</span><span class="op">(</span><span class="op">)</span> <span class="op">)</span><span class="op">$</span><span class="fu">abs</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">mTorch2_log</span> <span class="op">=</span> <span class="va">mTorch</span><span class="op">$</span><span class="fu">log</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">mTorch2_log</span><span class="op">)</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt;  4.6052  4.5951  4.5850  4.5747  4.5643  4.5539  4.5433  4.5326  4.5218  4.5109</span></span>
<span><span class="co">#&gt;  4.4998  4.4886  4.4773  4.4659  4.4543  4.4427  4.4308  4.4188  4.4067  4.3944</span></span>
<span><span class="co">#&gt;  4.3820  4.3694  4.3567  4.3438  4.3307  4.3175  4.3041  4.2905  4.2767  4.2627</span></span>
<span><span class="co">#&gt;  4.2485  4.2341  4.2195  4.2047  4.1897  4.1744  4.1589  4.1431  4.1271  4.1109</span></span>
<span><span class="co">#&gt;  4.0943  4.0775  4.0604  4.0431  4.0254  4.0073  3.9890  3.9703  3.9512  3.9318</span></span>
<span><span class="co">#&gt;  3.9120  3.8918  3.8712  3.8501  3.8286  3.8067  3.7842  3.7612  3.7377  3.7136</span></span>
<span><span class="co">#&gt;  3.6889  3.6636  3.6376  3.6109  3.5835  3.5553  3.5264  3.4965  3.4657  3.4340</span></span>
<span><span class="co">#&gt;  3.4012  3.3673  3.3322  3.2958  3.2581  3.2189  3.1781  3.1355  3.0910  3.0445</span></span>
<span><span class="co">#&gt;  2.9957  2.9444  2.8904  2.8332  2.7726  2.7081  2.6391  2.5649  2.4849  2.3979</span></span>
<span><span class="co">#&gt;  2.3026  2.1972  2.0794  1.9459  1.7918  1.6094  1.3863  1.0986  0.6931  0.0000</span></span>
<span><span class="co">#&gt; [ CPUFloatType{10,10} ]</span></span>
<span></span>
<span><span class="co"># g)    # Custom mean function</span></span>
<span><span class="va">mean_Torch</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">result</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_sum.html">torch_sum</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span> <span class="va">result</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">)</span>  <span class="co"># If y is an R object.</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">mean_Torch</span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt;  1</span></span>
<span><span class="co">#&gt; [ CPUBoolType{1} ]</span></span></code></pre></div>
    
  </details><br><hr>
<strong><span style="color: #0011AA; font-size:25px;">Task</span></strong><br><p>This exercise compares the speed of R to torch
The first exercise is to rewrite the following function in torch:</p>
<div class="sourceCode" id="cb124"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">do_something_R</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0.0</span>, <span class="fl">10L</span>, <span class="fl">10L</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">mean_per_row</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">1</span>, <span class="va">mean</span><span class="op">)</span></span>
<span>  <span class="va">result</span> <span class="op">=</span> <span class="va">x</span> <span class="op">-</span> <span class="va">mean_per_row</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Here, we provide a skeleton for a TensorFlow function:</p>
<div class="sourceCode" id="cb125"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">do_something_torch</span><span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0.0</span>, <span class="fl">10L</span>, <span class="fl">10L</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>   <span class="va">...</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We can compare the speed using the Microbenchmark package:</p>
<div class="sourceCode" id="cb126"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0.0</span>, <span class="fl">100L</span>, <span class="fl">100L</span><span class="op">)</span></span>
<span><span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="fu">do_something_R</span><span class="op">(</span><span class="va">test</span><span class="op">)</span>, <span class="fu">do_something_torch</span><span class="op">(</span><span class="va">test</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Try different matrix sizes for the test matrix and compare the speed.</p>
<p>Tip: Have a look at the the torch_mean documentation and the “dim” argument.</p>
<p><br></p>
<p>Compare the following with different matrix sizes:</p>
<ul>
<li>test = matrix(0.0, 1000L, 500L)</li>
<li>testTorch = torch_tensor(test)</li>
</ul>
<p>Also try the following:</p>
<div class="sourceCode" id="cb127"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span></span>
<span>   <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_matmul.html">torch_matmul</a></span><span class="op">(</span><span class="va">testTorch</span>, <span class="va">testTorch</span><span class="op">$</span><span class="fu">t</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>, <span class="co"># Torch style.</span></span>
<span>   <span class="va">test</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">test</span><span class="op">)</span>  <span class="co"># R style.</span></span>
<span><span class="op">)</span></span></code></pre></div>
  <details><summary><strong><span style="color: #0011AA; font-size:25px;">Solution</span></strong>
    </summary><p>
</p>
<div class="sourceCode" id="cb128"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">do_something_torch</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0.0</span>, <span class="fl">10L</span>, <span class="fl">10L</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>  <span class="co"># Remember, this is a local copy!</span></span>
<span>  <span class="va">mean_per_row</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_mean.html">torch_mean</a></span><span class="op">(</span><span class="va">x</span>, dim <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">result</span> <span class="op">=</span> <span class="va">x</span> <span class="op">-</span> <span class="va">mean_per_row</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb129"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0.0</span>, <span class="fl">100L</span>, <span class="fl">100L</span><span class="op">)</span></span>
<span><span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="fu">do_something_R</span><span class="op">(</span><span class="va">test</span><span class="op">)</span>, <span class="fu">do_something_torch</span><span class="op">(</span><span class="va">test</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Unit: microseconds</span></span>
<span><span class="co">#&gt;                      expr     min       lq     mean</span></span>
<span><span class="co">#&gt;      do_something_R(test) 469.494 501.0335 533.5923</span></span>
<span><span class="co">#&gt;  do_something_torch(test) 288.284 303.1915 380.8973</span></span>
<span><span class="co">#&gt;    median       uq      max neval cld</span></span>
<span><span class="co">#&gt;  514.6685 526.7010 2597.007   100   b</span></span>
<span><span class="co">#&gt;  326.8505 377.0325 3030.417   100  a</span></span>
<span></span>
<span><span class="va">test</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0.0</span>, <span class="fl">1000L</span>, <span class="fl">500L</span><span class="op">)</span></span>
<span><span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="fu">do_something_R</span><span class="op">(</span><span class="va">test</span><span class="op">)</span>, <span class="fu">do_something_torch</span><span class="op">(</span><span class="va">test</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Unit: milliseconds</span></span>
<span><span class="co">#&gt;                      expr      min       lq      mean</span></span>
<span><span class="co">#&gt;      do_something_R(test) 8.441663 8.629451 10.594149</span></span>
<span><span class="co">#&gt;  do_something_torch(test) 2.107049 2.322623  2.827194</span></span>
<span><span class="co">#&gt;    median       uq      max neval cld</span></span>
<span><span class="co">#&gt;  8.746467 12.70234 31.92455   100   b</span></span>
<span><span class="co">#&gt;  2.582252  2.84635 10.64425   100  a</span></span></code></pre></div>
<p>Why is R faster (the first time)?</p>
<ul>
<li><ol style="list-style-type: lower-alpha">
<li>The R functions we used (apply, mean, “-”) are also implemented in C.</li>
</ol></li>
<li><ol start="2" style="list-style-type: lower-alpha">
<li>The problem is not large enough and torch has an overhead.</li>
</ol></li>
</ul>
<p><br></p>
<div class="sourceCode" id="cb130"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0.0</span>, <span class="fl">1000L</span>, <span class="fl">500L</span><span class="op">)</span></span>
<span><span class="va">testTorch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="va">test</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span></span>
<span>   <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_matmul.html">torch_matmul</a></span><span class="op">(</span><span class="va">testTorch</span>, <span class="va">testTorch</span><span class="op">$</span><span class="fu">t</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>, <span class="co"># Torch style.</span></span>
<span>   <span class="va">test</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">test</span><span class="op">)</span>  <span class="co"># R style.</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Unit: milliseconds</span></span>
<span><span class="co">#&gt;                                    expr      min        lq</span></span>
<span><span class="co">#&gt;  torch_matmul(testTorch, testTorch$t()) 3.857475  4.227933</span></span>
<span><span class="co">#&gt;                        test %*% t(test) 8.401205 10.052670</span></span>
<span><span class="co">#&gt;      mean    median       uq       max neval cld</span></span>
<span><span class="co">#&gt;   7.60400  4.609556 11.47081  29.26671   100  a </span></span>
<span><span class="co">#&gt;  19.64731 16.737911 20.81175 264.60567   100   b</span></span></code></pre></div>
    
  </details><br><hr>
<strong><span style="color: #0011AA; font-size:25px;">Task</span></strong><br><p>Google to find out how to write the following tasks in torch:</p>
<div class="sourceCode" id="cb131"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">A</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">5</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># i)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/solve.html">solve</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span>  <span class="co"># Solve equation AX = B. If just A  is given, invert it.</span></span>
<span><span class="co">#&gt;      [,1] [,2]       [,3]</span></span>
<span><span class="co">#&gt; [1,]    1  0.0 -0.6666667</span></span>
<span><span class="co">#&gt; [2,]   -1  0.5 -0.1666667</span></span>
<span><span class="co">#&gt; [3,]    0  0.0  0.3333333</span></span>
<span></span>
<span><span class="co"># j)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span> <span class="co"># Diagonal of A, if no matrix is given, construct diagonal matrix.</span></span>
<span><span class="co">#&gt; [1] 1 2 3</span></span>
<span></span>
<span><span class="co"># k)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span><span class="op">)</span> <span class="co"># Diagonal matrix with entries diag(A).</span></span>
<span><span class="co">#&gt;      [,1] [,2] [,3]</span></span>
<span><span class="co">#&gt; [1,]    1    0    0</span></span>
<span><span class="co">#&gt; [2,]    0    2    0</span></span>
<span><span class="co">#&gt; [3,]    0    0    3</span></span>
<span></span>
<span><span class="co"># l)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/eigen.html">eigen</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span></span>
<span><span class="co">#&gt; eigen() decomposition</span></span>
<span><span class="co">#&gt; $values</span></span>
<span><span class="co">#&gt; [1] 3 2 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $vectors</span></span>
<span><span class="co">#&gt;           [,1] [,2]       [,3]</span></span>
<span><span class="co">#&gt; [1,] 0.1400280    0  0.4472136</span></span>
<span><span class="co">#&gt; [2,] 0.9801961    1 -0.8944272</span></span>
<span><span class="co">#&gt; [3,] 0.1400280    0  0.0000000</span></span>
<span></span>
<span><span class="co"># m)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/det.html">det</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 6</span></span></code></pre></div>
  <details><summary><strong><span style="color: #0011AA; font-size:25px;">Solution</span></strong>
    </summary><p>
</p>
<div class="sourceCode" id="cb132"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs">torch</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">A</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1.</span>, <span class="fl">2.</span>, <span class="fl">0.</span>, <span class="fl">0.</span>, <span class="fl">2.</span>, <span class="fl">0.</span>, <span class="fl">2.</span>, <span class="fl">5.</span>, <span class="fl">3.</span><span class="op">)</span>, <span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co"># Do not use the "L" form here!</span></span>
<span></span>
<span><span class="co"># i)    solve(A)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/linalg_inv.html">linalg_inv</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt;  1.0000  0.0000 -0.6667</span></span>
<span><span class="co">#&gt; -1.0000  0.5000 -0.1667</span></span>
<span><span class="co">#&gt;  0.0000  0.0000  0.3333</span></span>
<span><span class="co">#&gt; [ CPUFloatType{3,3} ]</span></span>
<span></span>
<span><span class="co"># j)    diag(A)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_diag.html">torch_diag</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt;  1</span></span>
<span><span class="co">#&gt;  2</span></span>
<span><span class="co">#&gt;  3</span></span>
<span><span class="co">#&gt; [ CPUFloatType{3} ]</span></span>
<span></span>
<span><span class="co"># k)    diag(diag(A))</span></span>
<span><span class="va">tf</span><span class="op">$</span><span class="va">linalg</span><span class="op">$</span><span class="fu">diag</span><span class="op">(</span><span class="va">tf</span><span class="op">$</span><span class="va">linalg</span><span class="op">$</span><span class="fu">diag_part</span><span class="op">(</span><span class="va">A</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; tf.Tensor(</span></span>
<span><span class="co">#&gt; [[1. 0. 0.]</span></span>
<span><span class="co">#&gt;  [0. 2. 0.]</span></span>
<span><span class="co">#&gt;  [0. 0. 3.]], shape=(3, 3), dtype=float64)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_diag.html">torch_diag</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span><span class="op">$</span><span class="fu">diag</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt;  1  0  0</span></span>
<span><span class="co">#&gt;  0  2  0</span></span>
<span><span class="co">#&gt;  0  0  3</span></span>
<span><span class="co">#&gt; [ CPUFloatType{3,3} ]</span></span>
<span></span>
<span><span class="co"># l)    eigen(A)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/linalg_eigh.html">linalg_eigh</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt; -0.5616</span></span>
<span><span class="co">#&gt;  3.0000</span></span>
<span><span class="co">#&gt;  3.5616</span></span>
<span><span class="co">#&gt; [ CPUFloatType{3} ]</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt; -0.7882  0.0000  0.6154</span></span>
<span><span class="co">#&gt;  0.6154  0.0000  0.7882</span></span>
<span><span class="co">#&gt;  0.0000  1.0000  0.0000</span></span>
<span><span class="co">#&gt; [ CPUFloatType{3,3} ]</span></span>
<span></span>
<span><span class="co"># m)    det(A)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/linalg_det.html">linalg_det</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt; 6</span></span>
<span><span class="co">#&gt; [ CPUFloatType{} ]</span></span></code></pre></div>
    
  </details><br><hr>
<strong><span style="color: #0011AA; font-size:25px;">Task</span></strong><br><p>Torch supports automatic differentiation (analytical and not numerical!).
Let’s have a look at the function <span class="math inline">\(f(x) = 5 x^2 + 3\)</span> with derivative <span class="math inline">\(f'(x) = 10x\)</span>.
So for <span class="math inline">\(f'(5)\)</span> we will get <span class="math inline">\(10\)</span>.</p>
<p>Let’s do this in torch Define the function:</p>
<div class="sourceCode" id="cb133"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">f</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fl">5.0</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_pow.html">torch_pow</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">2.</span><span class="op">)</span> <span class="op">+</span> <span class="fl">3.0</span><span class="op">)</span> <span class="op">}</span></span></code></pre></div>
<p>We want to calculate the derivative for <span class="math inline">\(x = 2.0\)</span>:</p>
<div class="sourceCode" id="cb134"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="fl">2.0</span>, requires_grad <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>To do automatic differentiation, we have to forward <span class="math inline">\(x\)</span> through the function and call the $backward() method of the result:</p>
<div class="sourceCode" id="cb135"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y</span> <span class="op">=</span> <span class="fu">f</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="va">y</span><span class="op">$</span><span class="fu">backward</span><span class="op">(</span>retain_graph<span class="op">=</span><span class="cn">TRUE</span> <span class="op">)</span></span></code></pre></div>
<p>To print the gradient:</p>
<div class="sourceCode" id="cb136"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span><span class="op">$</span><span class="va">grad</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt;  20</span></span>
<span><span class="co">#&gt; [ CPUFloatType{1} ]</span></span></code></pre></div>
<p>We can also calculate the second order derivative <span class="math inline">\(f''(x) = 10\)</span>:</p>
<div class="sourceCode" id="cb137"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="fl">2.0</span>, requires_grad <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="fu">f</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="va">grad</span> <span class="op">=</span> <span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/autograd_grad.html">autograd_grad</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">x</span>, retain_graph <span class="op">=</span> <span class="cn">TRUE</span>, create_graph <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="co"># first</span></span>
<span><span class="op">(</span><span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/autograd_grad.html">autograd_grad</a></span><span class="op">(</span><span class="va">grad</span>, <span class="va">x</span>, retain_graph <span class="op">=</span> <span class="cn">TRUE</span>, create_graph <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="co"># second</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt;  10</span></span>
<span><span class="co">#&gt; [ CPUFloatType{1} ][ grad_fn = &lt;MulBackward0&gt; ]</span></span></code></pre></div>
<p>What is happening here? Think about and discuss it.</p>
<p>A more advanced example: <em>Linear regression</em></p>
<p>In this case we first simulate data following <span class="math inline">\(\boldsymbol{y} = \boldsymbol{X} \boldsymbol{w} + \boldsymbol{\epsilon}\)</span> (<span class="math inline">\(\boldsymbol{\epsilon}\)</span> follows a normal distribution == error).</p>
<div class="sourceCode" id="cb138"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/set_random_seed.html">set_random_seed</a></span><span class="op">(</span><span class="fl">321L</span>, disable_gpu <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># Already sets R's random seed.</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">500</span>, <span class="op">-</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fl">100</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">w</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="va">x</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">w</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">0</span>, <span class="fl">0.25</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<p>In R we would do the following to fit a linear regression model:</p>
<div class="sourceCode" id="cb139"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; lm(formula = y ~ x)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residuals:</span></span>
<span><span class="co">#&gt;      Min       1Q   Median       3Q      Max </span></span>
<span><span class="co">#&gt; -0.67893 -0.16399  0.00968  0.15058  0.51099 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept) 0.004865   0.027447   0.177     0.86    </span></span>
<span><span class="co">#&gt; x1          2.191511   0.023243  94.287   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; x2          2.741690   0.025328 108.249   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; x3          1.179181   0.023644  49.872   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; x4          0.591873   0.025154  23.530   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; x5          2.302417   0.022575 101.991   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  </span></span>
<span><span class="co">#&gt; 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual standard error: 0.2645 on 94 degrees of freedom</span></span>
<span><span class="co">#&gt; Multiple R-squared:  0.9974, Adjusted R-squared:  0.9972 </span></span>
<span><span class="co">#&gt; F-statistic:  7171 on 5 and 94 DF,  p-value: &lt; 2.2e-16</span></span></code></pre></div>
<p>Let’s build our own model in TensorFlow.
Here, we use now the variable data container type (remember they are mutable and we need this type for the weights (<span class="math inline">\(\boldsymbol{w}\)</span>) of the regression model). We want our model to learn these weights.</p>
<p>The input (predictors, independent variables or features, <span class="math inline">\(\boldsymbol{X}\)</span>) and the observed (response, <span class="math inline">\(\boldsymbol{y}\)</span>) are constant and will not be learned/optimized.</p>
<div class="sourceCode" id="cb140"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs">torch</a></span><span class="op">)</span></span>
<span><span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_manual_seed.html">torch_manual_seed</a></span><span class="op">(</span><span class="fl">42L</span><span class="op">)</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">500</span>, <span class="op">-</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fl">100</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">w</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="va">x</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">w</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">0</span>, <span class="fl">0.25</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Weights we want to learn.</span></span>
<span><span class="co"># We know the real weights but in reality we wouldn't know them.</span></span>
<span><span class="co"># So use guessed ones.</span></span>
<span><span class="va">wTorch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">0</span>, <span class="fl">0.01</span><span class="op">)</span>, <span class="fl">5</span>, <span class="fl">1</span><span class="op">)</span>, requires_grad <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">xTorch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="va">yTorch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># We need an optimizer which updates the weights (wTF).</span></span>
<span><span class="va">optimizer</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/optim_adam.html">optim_adam</a></span><span class="op">(</span>params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">wTorch</span><span class="op">)</span>, lr <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">100</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">pred</span> <span class="op">=</span> <span class="va">xTorch</span><span class="op">$</span><span class="fu">matmul</span><span class="op">(</span><span class="va">wTorch</span><span class="op">)</span></span>
<span>  <span class="va">loss</span> <span class="op">=</span> <span class="op">(</span><span class="va">yTorch</span> <span class="op">-</span> <span class="va">pred</span><span class="op">)</span><span class="op">$</span><span class="fu">pow</span><span class="op">(</span><span class="fl">2.0</span><span class="op">)</span><span class="op">$</span><span class="fu">mean</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">sqrt</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="va">i</span><span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span><span class="fl">10</span><span class="op">)</span><span class="op">{</span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Loss: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">loss</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">}</span>  <span class="co"># Every 10 times.</span></span>
<span>  <span class="va">loss</span><span class="op">$</span><span class="fu">backward</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">optimizer</span><span class="op">$</span><span class="fu">step</span><span class="op">(</span><span class="op">)</span> <span class="co"># do optimization step</span></span>
<span>  <span class="va">optimizer</span><span class="op">$</span><span class="fu">zero_grad</span><span class="op">(</span><span class="op">)</span> <span class="co"># reset gradients</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; [1] "Loss: 4.4065318107605"</span></span>
<span><span class="co">#&gt; [1] "Loss: 2.37925982475281"</span></span>
<span><span class="co">#&gt; [1] "Loss: 0.901207089424133"</span></span>
<span><span class="co">#&gt; [1] "Loss: 0.403193950653076"</span></span>
<span><span class="co">#&gt; [1] "Loss: 0.296265482902527"</span></span>
<span><span class="co">#&gt; [1] "Loss: 0.268377900123596"</span></span>
<span><span class="co">#&gt; [1] "Loss: 0.232994794845581"</span></span>
<span><span class="co">#&gt; [1] "Loss: 0.219554618000984"</span></span>
<span><span class="co">#&gt; [1] "Loss: 0.215328559279442"</span></span>
<span><span class="co">#&gt; [1] "Loss: 0.213282063603401"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Inferred weights: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">wTorch</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inferred weights:  0.701 3.089 1.801 1.123 3.452</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Original weights: "</span>, <span class="va">w</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Original weights:  0.67 3.085 1.787 1.121 3.455</span></span></code></pre></div>
<p>Discuss the code, go through the code line by line and try to understand it.</p>
<p>Additional exercise:</p>
<p>Play around with the simulation, increase/decrease the number of weights, add an intercept (you also need an additional variable in model).</p>
  <details><summary><strong><span style="color: #0011AA; font-size:25px;">Solution</span></strong>
    </summary><p>
</p>
<div class="sourceCode" id="cb141"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs">torch</a></span><span class="op">)</span></span>
<span><span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_manual_seed.html">torch_manual_seed</a></span><span class="op">(</span><span class="fl">42L</span><span class="op">)</span></span>
<span></span>
<span><span class="va">numberOfWeights</span> <span class="op">=</span> <span class="fl">3</span></span>
<span><span class="va">numberOfFeatures</span> <span class="op">=</span> <span class="fl">10000</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">numberOfFeatures</span> <span class="op">*</span> <span class="va">numberOfWeights</span>, <span class="op">-</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>           <span class="va">numberOfFeatures</span>, <span class="va">numberOfWeights</span><span class="op">)</span></span>
<span><span class="va">w</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">numberOfWeights</span>, <span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">intercept</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">.5</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="va">intercept</span> <span class="op">+</span> <span class="va">x</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">w</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">numberOfFeatures</span>, <span class="fl">0</span>, <span class="fl">0.25</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Guessed weights and intercept.</span></span>
<span><span class="va">wTorch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">numberOfWeights</span>, <span class="fl">0</span>, <span class="fl">0.01</span><span class="op">)</span>, <span class="va">numberOfWeights</span>, <span class="fl">1</span><span class="op">)</span>, requires_grad <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">interceptTorch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">.5</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>, requires_grad <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co"># Double, not float32.</span></span>
<span></span>
<span><span class="va">xTorch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="va">yTorch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># We need an optimizer which updates the weights (wTF).</span></span>
<span><span class="va">optimizer</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/optim_adam.html">optim_adam</a></span><span class="op">(</span>params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">wTorch</span>, <span class="va">interceptTorch</span><span class="op">)</span>, lr <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">100</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">pred</span> <span class="op">=</span> <span class="va">xTorch</span><span class="op">$</span><span class="fu">matmul</span><span class="op">(</span><span class="va">wTorch</span><span class="op">)</span><span class="op">$</span><span class="fu">add</span><span class="op">(</span><span class="va">interceptTorch</span><span class="op">)</span></span>
<span>  <span class="va">loss</span> <span class="op">=</span> <span class="op">(</span><span class="va">yTorch</span> <span class="op">-</span> <span class="va">pred</span><span class="op">)</span><span class="op">$</span><span class="fu">pow</span><span class="op">(</span><span class="fl">2.0</span><span class="op">)</span><span class="op">$</span><span class="fu">mean</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">sqrt</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="va">i</span><span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span><span class="fl">10</span><span class="op">)</span><span class="op">{</span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Loss: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">loss</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">}</span>  <span class="co"># Every 10 times.</span></span>
<span>  <span class="va">loss</span><span class="op">$</span><span class="fu">backward</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">optimizer</span><span class="op">$</span><span class="fu">step</span><span class="op">(</span><span class="op">)</span> <span class="co"># do optimization step</span></span>
<span>  <span class="va">optimizer</span><span class="op">$</span><span class="fu">zero_grad</span><span class="op">(</span><span class="op">)</span> <span class="co"># reset gradients</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; [1] "Loss: 3.51533484458923"</span></span>
<span><span class="co">#&gt; [1] "Loss: 1.74870145320892"</span></span>
<span><span class="co">#&gt; [1] "Loss: 0.414169400930405"</span></span>
<span><span class="co">#&gt; [1] "Loss: 0.518697261810303"</span></span>
<span><span class="co">#&gt; [1] "Loss: 0.293963462114334"</span></span>
<span><span class="co">#&gt; [1] "Loss: 0.263338685035706"</span></span>
<span><span class="co">#&gt; [1] "Loss: 0.258341372013092"</span></span>
<span><span class="co">#&gt; [1] "Loss: 0.254723280668259"</span></span>
<span><span class="co">#&gt; [1] "Loss: 0.252453774213791"</span></span>
<span><span class="co">#&gt; [1] "Loss: 0.25116890668869"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Inferred weights: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">wTorch</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inferred weights:  3.118 -0.349 2.107</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Original weights: "</span>, <span class="va">w</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Original weights:  3.131 -0.353 2.11</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Inferred intercept: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">interceptTorch</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inferred intercept:  2.836</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Original intercept: "</span>, <span class="va">intercept</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Original intercept:  2.832</span></span></code></pre></div>
    
  </details><br><hr>
</div>
</div>
<div id="first-steps-with-the-keras-framework" class="section level2" number="3.6">
<h2>
<span class="header-section-number">3.6</span> First Steps With the Keras Framework<a class="anchor" aria-label="anchor" href="#first-steps-with-the-keras-framework"><i class="fas fa-link"></i></a>
</h2>
<p>We have seen that we can use TensorFlow directly out of R, and we could use this knowledge to implement a neural network in TensorFlow directly in R. However, this can be quite cumbersome. For simple problems, it is usually faster to use a higher-level API that helps us with implementing the machine learning models in TensorFlow. The most common of those is Keras.</p>
<p>Keras is a powerful framework for building and training neural networks with a few lines of codes. Since the end of 2018, Keras and TensorFlow are completely interoperable, allowing us to utilize the best of both.</p>
<p>The objective of this lesson is to familiarize yourself with Keras. If you have installed TensorFlow, Keras can be found within TensorFlow: tf.keras. However, the RStudio team has built an R package on top of tf.keras, and it is more convenient to use this. To load the Keras package, type</p>
<div class="sourceCode" id="cb142"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span></span></code></pre></div>
<div id="example-workflow-in-keras-and-torch" class="section level3" number="3.6.1">
<h3>
<span class="header-section-number">3.6.1</span> Example Workflow in Keras and Torch<a class="anchor" aria-label="anchor" href="#example-workflow-in-keras-and-torch"><i class="fas fa-link"></i></a>
</h3>
<p>To show how Keras works, we will now build a small classifier to predict the three species of the iris data set. Load the necessary packages and data sets:</p>
<div class="sourceCode" id="cb143"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs">torch</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/set_random_seed.html">set_random_seed</a></span><span class="op">(</span><span class="fl">321L</span>, disable_gpu <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># Already sets R's random seed.</span></span>
<span><span class="co">#&gt; Loaded Tensorflow version 2.9.1</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Sepal.Length Sepal.Width Petal.Length Petal.Width Species</span></span>
<span><span class="co">#&gt; 1          5.1         3.5          1.4         0.2  setosa</span></span>
<span><span class="co">#&gt; 2          4.9         3.0          1.4         0.2  setosa</span></span>
<span><span class="co">#&gt; 3          4.7         3.2          1.3         0.2  setosa</span></span>
<span><span class="co">#&gt; 4          4.6         3.1          1.5         0.2  setosa</span></span>
<span><span class="co">#&gt; 5          5.0         3.6          1.4         0.2  setosa</span></span>
<span><span class="co">#&gt; 6          5.4         3.9          1.7         0.4  setosa</span></span></code></pre></div>
<p>For neural networks, it is beneficial to scale the predictors (scaling = centering and standardization, see ?scale).
We also split our data into predictors (X) and response (Y = the three species).</p>
<div class="sourceCode" id="cb144"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">X</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">iris</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">Y</span> <span class="op">=</span> <span class="va">iris</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span></span></code></pre></div>
<p>Additionally, Keras/TensorFlow cannot handle factors and we have to create contrasts (one-hot encoding).
To do so, we have to specify the number of categories. This can be tricky for a beginner, because in other programming languages like Python and C++, arrays start at zero. Thus, when we would specify 3 as number of classes for our three species, we would have the classes 0,1,2,3. Keep this in mind.</p>
<div class="sourceCode" id="cb145"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/to_categorical.html">to_categorical</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1L</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span> <span class="co"># 3 columns, one for each level of the response.</span></span>
<span><span class="co">#&gt;      [,1] [,2] [,3]</span></span>
<span><span class="co">#&gt; [1,]    1    0    0</span></span>
<span><span class="co">#&gt; [2,]    1    0    0</span></span>
<span><span class="co">#&gt; [3,]    1    0    0</span></span>
<span><span class="co">#&gt; [4,]    1    0    0</span></span>
<span><span class="co">#&gt; [5,]    1    0    0</span></span>
<span><span class="co">#&gt; [6,]    1    0    0</span></span></code></pre></div>
<p>After having prepared the data, we will now see a typical workflow to specify a model in Keras/Torch.</p>
<p><strong>1. Initialize a sequential model in Keras:</strong></p>
<div class="sourceCode" id="cb146"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>A sequential Keras model is a higher order type of model within Keras and consists of one input and one output model.</p>
<p><strong>2. Add hidden layers to the model (we will learn more about hidden layers during the next days).</strong></p>
<p>When specifying the hidden layers, we also have to specify the shape and a so called <em>activation function</em>.
You can think of the activation function as decision for what is forwarded to the next neuron (but we will learn more about it later).
If you want to know this topic in even more depth, consider watching the videos presented in section <a href="introduction.html#basicMath">3.3</a>.</p>
<p>The shape of the input is the number of predictors (here 4) and the shape of the output is the number of classes (here 3).</p>
<div class="panelset">
<div class="panel">
<p><span class="panel-name">Keras</span></p>
<div class="sourceCode" id="cb147"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">20L</span>, activation <span class="op">=</span> <span class="st">"relu"</span>, input_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fl">4L</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">20L</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">20L</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">3L</span>, activation <span class="op">=</span> <span class="st">"softmax"</span><span class="op">)</span> </span></code></pre></div>
</div>
<div class="panel">
<p><span class="panel-name">torch</span></p>
<p>The Torch syntax is very similar, we will give a list of layers to the “nn_sequential” function. Here, we have to specify the softmax activation function as an extra layer:</p>
<div class="sourceCode" id="cb148"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_torch</span> <span class="op">=</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_sequential.html">nn_sequential</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html">nn_linear</a></span><span class="op">(</span><span class="fl">4L</span>, <span class="fl">20L</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html">nn_linear</a></span><span class="op">(</span><span class="fl">20L</span>, <span class="fl">20L</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html">nn_linear</a></span><span class="op">(</span><span class="fl">20L</span>, <span class="fl">20L</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html">nn_linear</a></span><span class="op">(</span><span class="fl">20L</span>, <span class="fl">3L</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_softmax.html">nn_softmax</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</div>
</div>
<ul>
<li>softmax scales a potential multidimensional vector to the interval <span class="math inline">\((0, 1]\)</span> for each component. The sum of all components equals 1. This might be very useful for example for handling probabilities. <strong>Ensure ther the labels start at 0! Otherwise the softmax function does not work well!</strong>
</li>
</ul>
<p><strong>3. Compile the model with a loss function (here: cross entropy) and an optimizer (here: Adamax).</strong></p>
<p>We will learn about other options later, so for now, do not worry about the “<strong>learning_rate</strong>” (“<strong>lr</strong>” in Torch or earlier in TensorFlow) argument, cross entropy or the optimizer.</p>
<div class="panelset">
<div class="panel">
<p><span class="panel-name">Keras</span></p>
<div class="sourceCode" id="cb149"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html">compile</a></span><span class="op">(</span>loss <span class="op">=</span> <span class="va">loss_categorical_crossentropy</span>,</span>
<span>          <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_adamax.html">optimizer_adamax</a></span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">0.001</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span><span class="co">#&gt; Model: "sequential"</span></span>
<span><span class="co">#&gt; ____________________________________________________________</span></span>
<span><span class="co">#&gt;  Layer (type)              Output Shape            Param #  </span></span>
<span><span class="co">#&gt; ============================================================</span></span>
<span><span class="co">#&gt;  dense_3 (Dense)           (None, 20)              100      </span></span>
<span><span class="co">#&gt;  dense_2 (Dense)           (None, 20)              420      </span></span>
<span><span class="co">#&gt;  dense_1 (Dense)           (None, 20)              420      </span></span>
<span><span class="co">#&gt;  dense (Dense)             (None, 3)               63       </span></span>
<span><span class="co">#&gt; ============================================================</span></span>
<span><span class="co">#&gt; Total params: 1,003</span></span>
<span><span class="co">#&gt; Trainable params: 1,003</span></span>
<span><span class="co">#&gt; Non-trainable params: 0</span></span>
<span><span class="co">#&gt; ____________________________________________________________</span></span></code></pre></div>
</div>
<div class="panel">
<p><span class="panel-name">torch</span></p>
<p>Specify optimizer and the parameters which will be trained (in our case the parameters of the network):</p>
<div class="sourceCode" id="cb150"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">optimizer_torch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/optim_adam.html">optim_adam</a></span><span class="op">(</span>params <span class="op">=</span> <span class="va">model_torch</span><span class="op">$</span><span class="va">parameters</span>, lr <span class="op">=</span> <span class="fl">0.001</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<p><strong>4. Fit model in 30 iterations (epochs)</strong></p>
<div class="sourceCode" id="cb151"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/set_random_seed.html">set_random_seed</a></span><span class="op">(</span><span class="fl">321L</span>, disable_gpu <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># Already sets R's random seed.</span></span>
<span></span>
<span><span class="va">model_history</span> <span class="op">=</span></span>
<span>  <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">X</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">Y</span>, <span class="fl">2</span>, <span class="va">as.integer</span><span class="op">)</span>, epochs <span class="op">=</span> <span class="fl">30L</span>,</span>
<span>        batch_size <span class="op">=</span> <span class="fl">20L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<details><summary><strong><span style="color: #CC2FAA;">Torch</span></strong>
</summary><p>
</p>
<p>In Torch, we jump directly to the training loop, however, here we have to write our own training loop:</p>
<ol style="list-style-type: decimal">
<li>Get a batch of data.
<ol start="2" style="list-style-type: decimal">
<li>Predict on batch.</li>
<li>Ccalculate loss between predictions and true labels.</li>
<li>Backpropagate error.</li>
<li>Update weights.</li>
<li>Go to step 1 and repeat.</li>
</ol>
</li>
</ol>
<div class="sourceCode" id="cb152"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs">torch</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_manual_seed.html">torch_manual_seed</a></span><span class="op">(</span><span class="fl">321L</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate number of training steps.</span></span>
<span><span class="va">epochs</span> <span class="op">=</span> <span class="fl">30</span></span>
<span><span class="va">batch_size</span> <span class="op">=</span> <span class="fl">20</span></span>
<span><span class="va">steps</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">/</span><span class="va">batch_size</span> <span class="op">*</span> <span class="va">epochs</span><span class="op">)</span></span>
<span></span>
<span><span class="va">X_torch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="va">Y_torch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">Y</span>, <span class="fl">1</span>, <span class="va">which.max</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># Set model into training status.</span></span>
<span><span class="va">model_torch</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">log_losses</span> <span class="op">=</span> <span class="cn">NULL</span></span>
<span></span>
<span><span class="co"># Training loop.</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">steps</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># Get batch.</span></span>
<span>  <span class="va">indices</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, <span class="va">batch_size</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Reset backpropagation.</span></span>
<span>  <span class="va">optimizer_torch</span><span class="op">$</span><span class="fu">zero_grad</span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Predict and calculate loss.</span></span>
<span>  <span class="va">pred</span> <span class="op">=</span> <span class="fu">model_torch</span><span class="op">(</span><span class="va">X_torch</span><span class="op">[</span><span class="va">indices</span>, <span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">loss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nnf_cross_entropy.html">nnf_cross_entropy</a></span><span class="op">(</span><span class="va">pred</span>, <span class="va">Y_torch</span><span class="op">[</span><span class="va">indices</span><span class="op">]</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Backpropagation and weight update.</span></span>
<span>  <span class="va">loss</span><span class="op">$</span><span class="fu">backward</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">optimizer_torch</span><span class="op">$</span><span class="fu">step</span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">log_losses</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">loss</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>

</details><p><br></p>
<p><strong>5. Plot training history:</strong></p>
<div class="sourceCode" id="cb153"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model_history</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="03-intro_files/figure-html/chunk_chapter3_72-1.png" width="100%" style="display: block; margin: auto;"></div>
<details><summary><strong><span style="color: #CC2FAA;">Torch</span></strong>
</summary><p>
</p>
<div class="sourceCode" id="cb154"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">log_losses</span>, xlab <span class="op">=</span> <span class="st">"steps"</span>, ylab <span class="op">=</span> <span class="st">"loss"</span>, las <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="03-intro_files/figure-html/chunk_chapter3_73-1.png" width="100%" style="display: block; margin: auto;"></div>

</details><p><br></p>
<p><strong>6. Create predictions:</strong></p>
<div class="sourceCode" id="cb155"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">predictions</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">X</span><span class="op">)</span> <span class="co"># Probabilities for each class.</span></span></code></pre></div>
<p>Get probabilities:</p>
<div class="sourceCode" id="cb156"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">predictions</span><span class="op">)</span> <span class="co"># Quasi-probabilities for each species.</span></span>
<span><span class="co">#&gt;           [,1]       [,2]        [,3]</span></span>
<span><span class="co">#&gt; [1,] 0.9819264 0.01476339 0.003310232</span></span>
<span><span class="co">#&gt; [2,] 0.9563531 0.03986335 0.003783490</span></span>
<span><span class="co">#&gt; [3,] 0.9830711 0.01501246 0.001916326</span></span>
<span><span class="co">#&gt; [4,] 0.9789233 0.01915258 0.001923956</span></span>
<span><span class="co">#&gt; [5,] 0.9871404 0.01057778 0.002281806</span></span>
<span><span class="co">#&gt; [6,] 0.9808626 0.01525488 0.003882431</span></span></code></pre></div>
<p>For each plant, we want to know for which species we got the highest probability:</p>
<div class="sourceCode" id="cb157"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">preds</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">predictions</span>, <span class="fl">1</span>, <span class="va">which.max</span><span class="op">)</span> </span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">preds</span><span class="op">)</span></span>
<span><span class="co">#&gt;   [1] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1</span></span>
<span><span class="co">#&gt;  [28] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 3 3 3 2</span></span>
<span><span class="co">#&gt;  [55] 3 2 3 2 2 2 2 3 2 3 2 3 3 2 2 2 3 2 2 2 2 3 3 3 3 2 2</span></span>
<span><span class="co">#&gt;  [82] 2 2 3 2 3 3 2 2 2 2 3 2 2 2 2 2 2 2 2 3 3 3 3 3 3 2 3</span></span>
<span><span class="co">#&gt; [109] 3 3 3 3 3 3 3 3 3 3 3 2 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3</span></span>
<span><span class="co">#&gt; [136] 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3</span></span></code></pre></div>
<details><summary><strong><span style="color: #CC2FAA;">Torch</span></strong>
</summary><p>
</p>
<div class="sourceCode" id="cb158"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_torch</span><span class="op">$</span><span class="fu">eval</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">preds_torch</span> <span class="op">=</span> <span class="fu">model_torch</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">preds_torch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">preds_torch</span>, <span class="fl">1</span>, <span class="va">which.max</span><span class="op">)</span> </span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">preds_torch</span><span class="op">)</span></span>
<span><span class="co">#&gt;   [1] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1</span></span>
<span><span class="co">#&gt;  [28] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 3 2 3 2</span></span>
<span><span class="co">#&gt;  [55] 2 2 3 2 2 2 2 2 2 2 2 2 2 2 2 2 3 2 2 2 2 2 2 3 2 2 2</span></span>
<span><span class="co">#&gt;  [82] 2 2 2 2 2 3 2 2 2 2 2 2 2 2 2 2 2 2 2 3 3 3 3 3 3 2 3</span></span>
<span><span class="co">#&gt; [109] 3 3 3 3 3 3 3 3 3 3 3 2 3 3 3 3 3 3 3 3 3 3 3 3 3 2 2</span></span>
<span><span class="co">#&gt; [136] 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">preds_torch</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Species</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.9333333</span></span></code></pre></div>

</details><p><br></p>
<p><strong>7. Calculate Accuracy (how often we have been correct):</strong></p>
<div class="sourceCode" id="cb159"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">preds</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Species</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.8666667</span></span></code></pre></div>
<p><strong>8. Plot predictions, to see if we have done a good job:</strong></p>
<div class="sourceCode" id="cb160"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">oldpar</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Sepal.Length</span>, <span class="va">iris</span><span class="op">$</span><span class="va">Petal.Length</span>, col <span class="op">=</span> <span class="va">iris</span><span class="op">$</span><span class="va">Species</span>,</span>
<span>     main <span class="op">=</span> <span class="st">"Observed"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Sepal.Length</span>, <span class="va">iris</span><span class="op">$</span><span class="va">Petal.Length</span>, col <span class="op">=</span> <span class="va">preds</span>,</span>
<span>     main <span class="op">=</span> <span class="st">"Predicted"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="03-intro_files/figure-html/chunk_chapter3_79-1.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb161"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span><span class="va">oldpar</span><span class="op">)</span>   <span class="co"># Reset par.</span></span></code></pre></div>
<p>So you see, building a neural network is very easy with Keras and you can already do it on your own.</p>
  <hr>
<details><summary><strong><span style="color: #0011AA; font-size:25px;">Questions</span></strong>
    </summary><p>
      <script>
        makeMultipleChoiceForm(
         'Have a look at the following two textbooks on machine learning (&apos;<a href="https://www.statlearning.com/" target="_blank" rel="noopener">An Introduction to Statistical Learning</a>&apos; and &apos;<a href="https://web.stanford.edu/~hastie/ElemStatLearn/" target="_blank" rel="noopener">The Elements of Statistical Learning</a>&apos;) - Which of the following statements is true?',
          'checkbox',
          [
            {
              'answer':'Both books can be downloaded for free.',
              'correct':true,
              'explanationIfSelected':'',
              'explanationIfNotSelected':'',
              'explanationGeneral':''
            },
            {
              'answer':'The elements of Statistical Learning was published earlier than the Introduction to Statistical Learning.',
              'correct':true,
              'explanationIfSelected':'',
              'explanationIfNotSelected':'',
              'explanationGeneral':''
            },
            {
              'answer':'The book "an Introduction to Statistical Learning" also includes an online course with videos to the different topics on their website.',
              'correct':true,
              'explanationIfSelected':'',
              'explanationIfNotSelected':'',
              'explanationGeneral':''
            },
            {
              'answer':'Higher model complexity is always better for predicting.',
              'correct':false,
              'explanationIfSelected':'',
              'explanationIfNotSelected':'',
              'explanationGeneral':''
            }
          ],
          ''
        );
      </script><img src="images/biasVarianceTradeoff.png" alt="bias variance tradeoff"><script>
        makeMultipleChoiceForm(
          'Which of the following statements about the bias-variance trade-off is correct?',
          'checkbox',
          [
            {
              'answer':'The goal of considering the bias-variance trade-off is to get the bias of the model as small as possible.',
              'correct':false,
              'explanationIfSelected':'',
              'explanationIfNotSelected':'',
              'explanationGeneral':''
            },
            {
              'answer':'The goal of considering the bias-variance trade-off is to realize that increasing complexity typically leads to more flexibility (allowing you to reduce bias) but at the cost of uncertainty (variance) in the estimated parameters.',
              'correct':true,
              'explanationIfSelected':'',
              'explanationIfNotSelected':'',
              'explanationGeneral':''
            },
            {
             'answer':'Through the bias-variance trade-off, we see that model complexity also depends on what we want to optimize for: bias, variance (rarely), or total error of the model.',
              'correct':true,
              'explanationIfSelected':'',
              'explanationIfNotSelected':'',
              'explanationGeneral':''
            }
          ],
          ''
        );
      </script></p>
  </details><hr>
<strong><span style="color: #0011AA; font-size:25px;">Task</span></strong><br><p>We will now build a regression for the airquality data set with Keras. We want to predict the variable “Ozone.”</p>
<ol start="0" style="list-style-type: decimal">
<li>Load and prepare the data set:</li>
</ol>
<div class="sourceCode" id="cb162"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/set_random_seed.html">set_random_seed</a></span><span class="op">(</span><span class="fl">321L</span>, disable_gpu <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># Already sets R's random seed.</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">airquality</span></span></code></pre></div>
<p>Explore the data with summary() and plot():</p>
<div class="sourceCode" id="cb163"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="co">#&gt;      Ozone           Solar.R           Wind       </span></span>
<span><span class="co">#&gt;  Min.   :  1.00   Min.   :  7.0   Min.   : 1.700  </span></span>
<span><span class="co">#&gt;  1st Qu.: 18.00   1st Qu.:115.8   1st Qu.: 7.400  </span></span>
<span><span class="co">#&gt;  Median : 31.50   Median :205.0   Median : 9.700  </span></span>
<span><span class="co">#&gt;  Mean   : 42.13   Mean   :185.9   Mean   : 9.958  </span></span>
<span><span class="co">#&gt;  3rd Qu.: 63.25   3rd Qu.:258.8   3rd Qu.:11.500  </span></span>
<span><span class="co">#&gt;  Max.   :168.00   Max.   :334.0   Max.   :20.700  </span></span>
<span><span class="co">#&gt;  NA's   :37       NA's   :7                       </span></span>
<span><span class="co">#&gt;       Temp           Month            Day      </span></span>
<span><span class="co">#&gt;  Min.   :56.00   Min.   :5.000   Min.   : 1.0  </span></span>
<span><span class="co">#&gt;  1st Qu.:72.00   1st Qu.:6.000   1st Qu.: 8.0  </span></span>
<span><span class="co">#&gt;  Median :79.00   Median :7.000   Median :16.0  </span></span>
<span><span class="co">#&gt;  Mean   :77.88   Mean   :6.993   Mean   :15.8  </span></span>
<span><span class="co">#&gt;  3rd Qu.:85.00   3rd Qu.:8.000   3rd Qu.:23.0  </span></span>
<span><span class="co">#&gt;  Max.   :97.00   Max.   :9.000   Max.   :31.0  </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="03-intro_files/figure-html/chunk_chapter3_task_27-1.png" width="100%" style="display: block; margin: auto;"></div>
<ol style="list-style-type: decimal">
<li><p>There are NAs in the data, which we have to remove because Keras cannot handle NAs.
If you don’t know how to remove NAs from a data.frame, use Google (e.g. with the query: “remove-rows-with-all-or-some-nas-missing-values-in-data-frame”).</p></li>
<li><p>Split the data in predictors (<span class="math inline">\(\boldsymbol{X}\)</span>) and response (<span class="math inline">\(\boldsymbol{y}\)</span>, Ozone) and scale the <span class="math inline">\(\boldsymbol{X}\)</span> matrix.</p></li>
<li><p>Build a sequential Keras model.</p></li>
<li><p>Add hidden layers (input and output layer are already specified, you have to add hidden layers between them):</p></li>
</ol>
<div class="sourceCode" id="cb164"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">20L</span>, activation <span class="op">=</span> <span class="st">"relu"</span>, input_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fl">5L</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>   <span class="va">....</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">1L</span>, activation <span class="op">=</span> <span class="st">"linear"</span><span class="op">)</span></span></code></pre></div>
<ul>
<li>Why do we use 5L as input shape?</li>
<li>Why only one output node and “linear” activation layer?</li>
</ul>
<ol start="5" style="list-style-type: decimal">
<li>Compile model.</li>
</ol>
<div class="sourceCode" id="cb165"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html">compile</a></span><span class="op">(</span>loss <span class="op">=</span> <span class="va">loss_mean_squared_error</span>, <span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_adamax.html">optimizer_adamax</a></span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>What is the “mean_squared_error” loss?</p>
<ol start="6" style="list-style-type: decimal">
<li>Fit model:</li>
</ol>
<p>Tip: Only matrices are accepted for <span class="math inline">\(\boldsymbol{X}\)</span> and <span class="math inline">\(\boldsymbol{y}\)</span> by Keras. R often drops a one column matrix into a vector (change it back to a matrix!)</p>
<ol start="7" style="list-style-type: decimal">
<li><p>Plot training history.</p></li>
<li><p>Create predictions.</p></li>
<li><p>Compare your Keras model with a linear model:</p></li>
</ol>
<div class="sourceCode" id="cb166"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">Ozone</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span><span class="va">pred_lm</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit</span>, <span class="va">data</span><span class="op">)</span></span>
<span><span class="va">rmse_lm</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="op">(</span><span class="va">y</span> <span class="op">-</span> <span class="va">pred_lm</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">rmse_keras</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="op">(</span><span class="va">y</span> <span class="op">-</span> <span class="va">pred_keras</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">rmse_lm</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">rmse_keras</span><span class="op">)</span></span></code></pre></div>
  <details><summary><strong><span style="color: #0011AA; font-size:25px;">Solution</span></strong>
    </summary><p>
</p>
<div class="sourceCode" id="cb167"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">=</span> <span class="va">airquality</span></span></code></pre></div>
<p><strong>1. There are NAs in the data, which we have to remove because Keras cannot handle NAs.</strong></p>
<div class="sourceCode" id="cb168"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">=</span> <span class="va">data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,<span class="op">]</span>  <span class="co"># Remove NAs.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="co">#&gt;      Ozone          Solar.R           Wind      </span></span>
<span><span class="co">#&gt;  Min.   :  1.0   Min.   :  7.0   Min.   : 2.30  </span></span>
<span><span class="co">#&gt;  1st Qu.: 18.0   1st Qu.:113.5   1st Qu.: 7.40  </span></span>
<span><span class="co">#&gt;  Median : 31.0   Median :207.0   Median : 9.70  </span></span>
<span><span class="co">#&gt;  Mean   : 42.1   Mean   :184.8   Mean   : 9.94  </span></span>
<span><span class="co">#&gt;  3rd Qu.: 62.0   3rd Qu.:255.5   3rd Qu.:11.50  </span></span>
<span><span class="co">#&gt;  Max.   :168.0   Max.   :334.0   Max.   :20.70  </span></span>
<span><span class="co">#&gt;       Temp           Month            Day       </span></span>
<span><span class="co">#&gt;  Min.   :57.00   Min.   :5.000   Min.   : 1.00  </span></span>
<span><span class="co">#&gt;  1st Qu.:71.00   1st Qu.:6.000   1st Qu.: 9.00  </span></span>
<span><span class="co">#&gt;  Median :79.00   Median :7.000   Median :16.00  </span></span>
<span><span class="co">#&gt;  Mean   :77.79   Mean   :7.216   Mean   :15.95  </span></span>
<span><span class="co">#&gt;  3rd Qu.:84.50   3rd Qu.:9.000   3rd Qu.:22.50  </span></span>
<span><span class="co">#&gt;  Max.   :97.00   Max.   :9.000   Max.   :31.00</span></span></code></pre></div>
<p><strong>2. Split the data in predictors and response and scale the matrix.</strong></p>
<div class="sourceCode" id="cb169"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="fl">2</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="va">data</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span></code></pre></div>
<p><strong>3. Build sequential Keras model.</strong></p>
<div class="sourceCode" id="cb170"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/set_random_seed.html">set_random_seed</a></span><span class="op">(</span><span class="fl">321L</span>, disable_gpu <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># Already sets R's random seed.</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><strong>4. Add hidden layers (input and output layer are already specified, you have to add hidden layers between them).</strong></p>
<div class="sourceCode" id="cb171"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">20L</span>, activation <span class="op">=</span> <span class="st">"relu"</span>, input_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fl">5L</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">20L</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">20L</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">1L</span>, activation <span class="op">=</span> <span class="st">"linear"</span><span class="op">)</span></span></code></pre></div>
<p>We use 5L as input shape, because we have 5 predictors. Analogously, we use 1L for our 1d response.
Because we do not want any compression, dilation or other nonlinear effects, we use the simple linear layer (equal to no activation function at all). For more about activation functions, look for example <a href="https://en.wikipedia.org/wiki/Activation_function" target="_blank" rel="noopener">here</a>. Or wait for the next days.
You may also have seen the previously shown link <a href="https://mlfromscratch.com/activation-functions-explained/#/" target="_blank" rel="noopener">about activation functions in more detail</a>.</p>
<p><strong>5. Compile model.</strong></p>
<div class="sourceCode" id="cb172"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html">compile</a></span><span class="op">(</span>loss <span class="op">=</span> <span class="va">loss_mean_squared_error</span>, <span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_adamax.html">optimizer_adamax</a></span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The mean_squared_error is the ordinary least squares approach in regression analysis.</p>
<p><strong>6. Fit model.</strong></p>
<div class="sourceCode" id="cb173"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_history</span> <span class="op">=</span></span>
<span>  <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">y</span>, ncol <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span>, epochs <span class="op">=</span> <span class="fl">100L</span>,</span>
<span>      batch_size <span class="op">=</span> <span class="fl">20L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><strong>7. Plot training history.</strong></p>
<div class="sourceCode" id="cb174"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model_history</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="03-intro_files/figure-html/chunk_chapter3_task_38-1.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb175"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/evaluate.html">evaluate</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span></span>
<span><span class="co">#&gt;     loss </span></span>
<span><span class="co">#&gt; 173.4729</span></span></code></pre></div>
<p><strong>8. Create predictions.</strong></p>
<div class="sourceCode" id="cb176"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred_keras</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">x</span><span class="op">)</span></span></code></pre></div>
<p><strong>9. Compare Keras model with a linear model.</strong></p>
<div class="sourceCode" id="cb177"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">Ozone</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span><span class="va">pred_lm</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit</span>, <span class="va">data</span><span class="op">)</span></span>
<span><span class="va">rmse_lm</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="op">(</span><span class="va">y</span> <span class="op">-</span> <span class="va">pred_lm</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rmse_keras</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="op">(</span><span class="va">y</span> <span class="op">-</span> <span class="va">pred_keras</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">rmse_lm</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 14.78897</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">rmse_keras</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 9.621961</span></span></code></pre></div>
<p><strong>Look at this slightly more complex model and compare the loss plot and the accuracy in contrast to the former.</strong></p>
<div class="sourceCode" id="cb178"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/set_random_seed.html">set_random_seed</a></span><span class="op">(</span><span class="fl">321L</span>, disable_gpu <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># Already sets R's random seed.</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">20L</span>, activation <span class="op">=</span> <span class="st">"relu"</span>, input_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fl">5L</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">20L</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">30L</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">20L</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">1L</span>, activation <span class="op">=</span> <span class="st">"linear"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html">compile</a></span><span class="op">(</span>loss <span class="op">=</span> <span class="va">loss_mean_squared_error</span>, <span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_adamax.html">optimizer_adamax</a></span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_history</span> <span class="op">=</span></span>
<span>  <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">y</span>, ncol <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span>, epochs <span class="op">=</span> <span class="fl">100L</span>,</span>
<span>      batch_size <span class="op">=</span> <span class="fl">20L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model_history</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="03-intro_files/figure-html/chunk_chapter3_task_41-1.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb179"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/evaluate.html">evaluate</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span></span>
<span><span class="co">#&gt;     loss </span></span>
<span><span class="co">#&gt; 105.1682</span></span>
<span></span>
<span><span class="va">pred_keras</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">x</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">Ozone</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span><span class="va">pred_lm</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit</span>, <span class="va">data</span><span class="op">)</span></span>
<span><span class="va">rmse_lm</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="op">(</span><span class="va">y</span> <span class="op">-</span> <span class="va">pred_lm</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rmse_keras</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="op">(</span><span class="va">y</span> <span class="op">-</span> <span class="va">pred_keras</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">rmse_lm</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 14.78897</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">rmse_keras</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 7.798208</span></span></code></pre></div>
<p>You see, the more complex model works better, because it can learn the coherences better.
But keep the overfitting problem in mind!</p>
<p><strong>Look at the little change in learning rates for the next 2 models and compare the loss plot and the accuracy in contrast to the former.</strong></p>
<div class="sourceCode" id="cb180"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/set_random_seed.html">set_random_seed</a></span><span class="op">(</span><span class="fl">321L</span>, disable_gpu <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># Already sets R's random seed.</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">20L</span>, activation <span class="op">=</span> <span class="st">"relu"</span>, input_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fl">5L</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">20L</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">30L</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">20L</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">1L</span>, activation <span class="op">=</span> <span class="st">"linear"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html">compile</a></span><span class="op">(</span>loss <span class="op">=</span> <span class="va">loss_mean_squared_error</span>, <span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_adamax.html">optimizer_adamax</a></span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_history</span> <span class="op">=</span></span>
<span>  <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">y</span>, ncol <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span>, epochs <span class="op">=</span> <span class="fl">100L</span>,</span>
<span>      batch_size <span class="op">=</span> <span class="fl">20L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model_history</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="03-intro_files/figure-html/chunk_chapter3_task_42-1.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb181"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/evaluate.html">evaluate</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span></span>
<span><span class="co">#&gt;     loss </span></span>
<span><span class="co">#&gt; 116.6115</span></span>
<span></span>
<span><span class="va">pred_keras</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">x</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">Ozone</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span><span class="va">pred_lm</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit</span>, <span class="va">data</span><span class="op">)</span></span>
<span><span class="va">rmse_lm</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="op">(</span><span class="va">y</span> <span class="op">-</span> <span class="va">pred_lm</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rmse_keras</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="op">(</span><span class="va">y</span> <span class="op">-</span> <span class="va">pred_keras</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">rmse_lm</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 14.78897</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">rmse_keras</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 8.247861</span></span></code></pre></div>
<p>You can see, the higher learning rate yields a little bit worse results. The optimum is jumped over.</p>
<div class="sourceCode" id="cb182"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/set_random_seed.html">set_random_seed</a></span><span class="op">(</span><span class="fl">321L</span>, disable_gpu <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># Already sets R's random seed.</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">20L</span>, activation <span class="op">=</span> <span class="st">"relu"</span>, input_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fl">5L</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">20L</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">30L</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">20L</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">1L</span>, activation <span class="op">=</span> <span class="st">"linear"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html">compile</a></span><span class="op">(</span>loss <span class="op">=</span> <span class="va">loss_mean_squared_error</span>, <span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_adamax.html">optimizer_adamax</a></span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_history</span> <span class="op">=</span></span>
<span>  <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">y</span>, ncol <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span>, epochs <span class="op">=</span> <span class="fl">100L</span>,</span>
<span>      batch_size <span class="op">=</span> <span class="fl">20L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model_history</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="03-intro_files/figure-html/chunk_chapter3_task_43-1.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb183"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/evaluate.html">evaluate</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span></span>
<span><span class="co">#&gt;     loss </span></span>
<span><span class="co">#&gt; 238.9949</span></span>
<span></span>
<span><span class="va">pred_keras</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">x</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">Ozone</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span><span class="va">pred_lm</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit</span>, <span class="va">data</span><span class="op">)</span></span>
<span><span class="va">rmse_lm</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="op">(</span><span class="va">y</span> <span class="op">-</span> <span class="va">pred_lm</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rmse_keras</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="op">(</span><span class="va">y</span> <span class="op">-</span> <span class="va">pred_keras</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">rmse_lm</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 14.78897</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">rmse_keras</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 11.58784</span></span></code></pre></div>
<p>You can see, that for the lower learning rate, the optimum (compared to the run with learning rate 0.05) is not yet reached (to few epochs have gone by).
But also here, mind the overfitting problem. For too many epochs, things might get worse!</p>
    
  </details><br><hr>
<strong><span style="color: #0011AA; font-size:25px;">Task</span></strong><br><p>This task is about the airquality example, go through the code line by line and try to understand it.
Note, this is TensorFlow intermingled with Keras.</p>
<div class="sourceCode" id="cb184"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/set_random_seed.html">set_random_seed</a></span><span class="op">(</span><span class="fl">321L</span>, disable_gpu <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># Already sets R's random seed.</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">airquality</span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,<span class="op">]</span>  <span class="co"># Remove NAs.</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="fl">2</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="va">data</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="va">layers</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">keras</span><span class="op">$</span><span class="va">layers</span></span>
<span><span class="va">model</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">keras</span><span class="op">$</span><span class="va">models</span><span class="op">$</span><span class="fu">Sequential</span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="va">layers</span><span class="op">$</span><span class="fu">InputLayer</span><span class="op">(</span>input_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fl">5L</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="va">layers</span><span class="op">$</span><span class="fu">Dense</span><span class="op">(</span>units <span class="op">=</span> <span class="fl">20L</span>, activation <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">nn</span><span class="op">$</span><span class="va">relu</span><span class="op">)</span>,</span>
<span>    <span class="va">layers</span><span class="op">$</span><span class="fu">Dense</span><span class="op">(</span>units <span class="op">=</span> <span class="fl">20L</span>, activation <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">nn</span><span class="op">$</span><span class="va">relu</span><span class="op">)</span>,</span>
<span>    <span class="va">layers</span><span class="op">$</span><span class="fu">Dense</span><span class="op">(</span>units <span class="op">=</span> <span class="fl">20L</span>, activation <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">nn</span><span class="op">$</span><span class="va">relu</span><span class="op">)</span>,</span>
<span>    <span class="va">layers</span><span class="op">$</span><span class="fu">Dense</span><span class="op">(</span>units <span class="op">=</span> <span class="fl">1L</span>, activation <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="co"># No activation == "linear".</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">epochs</span> <span class="op">=</span> <span class="fl">200L</span></span>
<span><span class="va">optimizer</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">keras</span><span class="op">$</span><span class="va">optimizers</span><span class="op">$</span><span class="fu">Adamax</span><span class="op">(</span><span class="fl">0.01</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Stochastic gradient optimization is more efficient</span></span>
<span><span class="co"># in each optimization step, we use a random subset of the data.</span></span>
<span><span class="va">get_batch</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">batch_size</span> <span class="op">=</span> <span class="fl">32L</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">indices</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, size <span class="op">=</span> <span class="va">batch_size</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>bX <span class="op">=</span> <span class="va">x</span><span class="op">[</span><span class="va">indices</span>,<span class="op">]</span>, bY <span class="op">=</span> <span class="va">y</span><span class="op">[</span><span class="va">indices</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">get_batch</span><span class="op">(</span><span class="op">)</span> <span class="co"># Try out this function.</span></span>
<span><span class="co">#&gt; $bX</span></span>
<span><span class="co">#&gt;         Solar.R        Wind        Temp      Month</span></span>
<span><span class="co">#&gt; 87  -1.13877323 -0.37654514  0.44147123 -0.1467431</span></span>
<span><span class="co">#&gt; 117  0.58361881 -1.83815816  0.33653910  0.5319436</span></span>
<span><span class="co">#&gt; 129 -1.01809608  1.56290291  0.65133550  1.2106304</span></span>
<span><span class="co">#&gt; 121  0.44100036 -2.14734553  1.70065685  0.5319436</span></span>
<span><span class="co">#&gt; 91   0.74817856 -0.71384046  0.54640337 -0.1467431</span></span>
<span><span class="co">#&gt; 137 -1.76410028  0.26993754 -0.71278225  1.2106304</span></span>
<span><span class="co">#&gt; 21  -1.93963068 -0.06735777 -1.97196786 -1.5041165</span></span>
<span><span class="co">#&gt; 141 -1.73118833  0.10128988 -0.18812157  1.2106304</span></span>
<span><span class="co">#&gt; 78   0.97856221  0.10128988  0.44147123 -0.1467431</span></span>
<span><span class="co">#&gt; 15  -1.31430363  0.91642022 -2.07689999 -1.5041165</span></span>
<span><span class="co">#&gt; 38  -0.63412333 -0.06735777  0.44147123 -0.8254298</span></span>
<span><span class="co">#&gt; 49  -1.62148183 -0.20789749 -1.34237505 -0.8254298</span></span>
<span><span class="co">#&gt; 123  0.03508631 -1.02302783  1.70065685  0.5319436</span></span>
<span><span class="co">#&gt; 136  0.58361881 -1.02302783 -0.08318944  1.2106304</span></span>
<span><span class="co">#&gt; 120  0.19964606 -0.06735777  2.01545325  0.5319436</span></span>
<span><span class="co">#&gt; 114 -1.63245248  1.22560759 -0.60785011  0.5319436</span></span>
<span><span class="co">#&gt; 145 -1.87380678 -0.20789749 -0.71278225  1.2106304</span></span>
<span><span class="co">#&gt; 140  0.43002971  1.08506788 -1.13251078  1.2106304</span></span>
<span><span class="co">#&gt; 64   0.56167751 -0.20789749  0.33653910 -0.1467431</span></span>
<span><span class="co">#&gt; 118  0.33129386 -0.54519280  0.86119977  0.5319436</span></span>
<span><span class="co">#&gt; 128 -0.98518413 -0.71384046  0.96613190  1.2106304</span></span>
<span><span class="co">#&gt; 62   0.92370896 -1.64140257  0.65133550 -0.1467431</span></span>
<span><span class="co">#&gt; 125  0.13382216 -1.36032314  1.49079258  1.2106304</span></span>
<span><span class="co">#&gt; 4    1.40641756  0.43858520 -1.65717146 -1.5041165</span></span>
<span><span class="co">#&gt; 79   1.09923936 -1.02302783  0.65133550 -0.1467431</span></span>
<span><span class="co">#&gt; 82  -1.95060133 -0.85438017 -0.39798584 -0.1467431</span></span>
<span><span class="co">#&gt; 149  0.08993956 -0.85438017 -0.81771438  1.2106304</span></span>
<span><span class="co">#&gt; 17   1.34059366  0.57912491 -1.23744292 -1.5041165</span></span>
<span><span class="co">#&gt; 48   1.08826871  3.02451593 -0.60785011 -0.8254298</span></span>
<span><span class="co">#&gt; 130  0.73720791  0.26993754  0.23160696  1.2106304</span></span>
<span><span class="co">#&gt; 132  0.49585361  0.26993754 -0.29305371  1.2106304</span></span>
<span><span class="co">#&gt; 30   0.41905906 -1.19167548  0.12667483 -1.5041165</span></span>
<span><span class="co">#&gt;            Day</span></span>
<span><span class="co">#&gt; 87   1.1546835</span></span>
<span><span class="co">#&gt; 117  1.0398360</span></span>
<span><span class="co">#&gt; 129 -1.1422676</span></span>
<span><span class="co">#&gt; 121  1.4992262</span></span>
<span><span class="co">#&gt; 91   1.6140738</span></span>
<span><span class="co">#&gt; 137 -0.2234871</span></span>
<span><span class="co">#&gt; 21   0.5804458</span></span>
<span><span class="co">#&gt; 141  0.2359031</span></span>
<span><span class="co">#&gt; 78   0.1210555</span></span>
<span><span class="co">#&gt; 15  -0.1086396</span></span>
<span><span class="co">#&gt; 38  -1.0274200</span></span>
<span><span class="co">#&gt; 49   0.2359031</span></span>
<span><span class="co">#&gt; 123  1.7289213</span></span>
<span><span class="co">#&gt; 136 -0.3383347</span></span>
<span><span class="co">#&gt; 120  1.3843787</span></span>
<span><span class="co">#&gt; 114  0.6952933</span></span>
<span><span class="co">#&gt; 145  0.6952933</span></span>
<span><span class="co">#&gt; 140  0.1210555</span></span>
<span><span class="co">#&gt; 64  -1.4868103</span></span>
<span><span class="co">#&gt; 118  1.1546835</span></span>
<span><span class="co">#&gt; 128 -1.2571152</span></span>
<span><span class="co">#&gt; 62  -1.7165054</span></span>
<span><span class="co">#&gt; 125 -1.6016578</span></span>
<span><span class="co">#&gt; 4   -1.3719627</span></span>
<span><span class="co">#&gt; 79   0.2359031</span></span>
<span><span class="co">#&gt; 82   0.5804458</span></span>
<span><span class="co">#&gt; 149  1.1546835</span></span>
<span><span class="co">#&gt; 17   0.1210555</span></span>
<span><span class="co">#&gt; 48   0.1210555</span></span>
<span><span class="co">#&gt; 130 -1.0274200</span></span>
<span><span class="co">#&gt; 132 -0.7977249</span></span>
<span><span class="co">#&gt; 30   1.6140738</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $bY</span></span>
<span><span class="co">#&gt;  [1]  20 168  32 118  64   9   1  13  35  18  29  20  85  28</span></span>
<span><span class="co">#&gt; [15]  76   9  23  18  32  73  47 135  78  18  61  16  30  34</span></span>
<span><span class="co">#&gt; [29]  37  20  21 115</span></span>
<span></span>
<span></span>
<span><span class="va">steps</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">/</span><span class="fl">32</span><span class="op">)</span> <span class="op">*</span> <span class="va">epochs</span>  <span class="co"># We need nrow(x)/32 steps for each epoch.</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">steps</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># Get data.</span></span>
<span>  <span class="va">batch</span> <span class="op">=</span> <span class="fu">get_batch</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Transform it into tensors.</span></span>
<span>  <span class="va">bX</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="fu">constant</span><span class="op">(</span><span class="va">batch</span><span class="op">$</span><span class="va">bX</span><span class="op">)</span></span>
<span>  <span class="va">bY</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="fu">constant</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">batch</span><span class="op">$</span><span class="va">bY</span>, ncol <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Automatic differentiation:</span></span>
<span>  <span class="co"># Record computations with respect to our model variables.</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">tf</span><span class="op">$</span><span class="fu">GradientTape</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rstudio.github.io/reticulate/reference/with-as-operator.html">%as%</a></span> <span class="va">tape</span>,</span>
<span>    <span class="op">{</span></span>
<span>      <span class="va">pred</span> <span class="op">=</span> <span class="fu">model</span><span class="op">(</span><span class="va">bX</span><span class="op">)</span> <span class="co"># We record the operation for our model weights.</span></span>
<span>      <span class="va">loss</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="fu">reduce_mean</span><span class="op">(</span><span class="va">tf</span><span class="op">$</span><span class="va">keras</span><span class="op">$</span><span class="va">losses</span><span class="op">$</span><span class="fu">mean_squared_error</span><span class="op">(</span><span class="va">bY</span>, <span class="va">pred</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Calculate the gradients for our model$weights at the loss / backpropagation.</span></span>
<span>  <span class="va">gradients</span> <span class="op">=</span> <span class="va">tape</span><span class="op">$</span><span class="fu">gradient</span><span class="op">(</span><span class="va">loss</span>, <span class="va">model</span><span class="op">$</span><span class="va">weights</span><span class="op">)</span> </span>
<span></span>
<span>  <span class="co"># Update our model weights with the learning rate specified above.</span></span>
<span>  <span class="va">optimizer</span><span class="op">$</span><span class="fu">apply_gradients</span><span class="op">(</span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/transpose.html">transpose</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">gradients</span>, <span class="va">model</span><span class="op">$</span><span class="va">weights</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> </span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="op">!</span> <span class="va">i</span><span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span><span class="fl">30</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Loss: "</span>, <span class="va">loss</span><span class="op">$</span><span class="fu">numpy</span><span class="op">(</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span> <span class="co"># Print loss every 30 steps (not epochs!).</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Loss:  645.1247 </span></span>
<span><span class="co">#&gt; Loss:  257.9622 </span></span>
<span><span class="co">#&gt; Loss:  257.9248 </span></span>
<span><span class="co">#&gt; Loss:  424.3474 </span></span>
<span><span class="co">#&gt; Loss:  132.1914 </span></span>
<span><span class="co">#&gt; Loss:  201.8619 </span></span>
<span><span class="co">#&gt; Loss:  225.3891 </span></span>
<span><span class="co">#&gt; Loss:  111.7508 </span></span>
<span><span class="co">#&gt; Loss:  343.3166 </span></span>
<span><span class="co">#&gt; Loss:  255.3797 </span></span>
<span><span class="co">#&gt; Loss:  245.1779 </span></span>
<span><span class="co">#&gt; Loss:  227.4517 </span></span>
<span><span class="co">#&gt; Loss:  222.4553 </span></span>
<span><span class="co">#&gt; Loss:  348.0878 </span></span>
<span><span class="co">#&gt; Loss:  365.9766 </span></span>
<span><span class="co">#&gt; Loss:  178.8896 </span></span>
<span><span class="co">#&gt; Loss:  220.2557 </span></span>
<span><span class="co">#&gt; Loss:  344.3786 </span></span>
<span><span class="co">#&gt; Loss:  238.2619 </span></span>
<span><span class="co">#&gt; Loss:  324.3969</span></span></code></pre></div>
<p>Now change the code from above for the iris data set.
Tip: In tf$keras$losses$… you can find various loss functions.</p>
  <details><summary><strong><span style="color: #0011AA; font-size:25px;">Solution</span></strong>
    </summary><p>
</p>
<div class="sourceCode" id="cb185"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/set_random_seed.html">set_random_seed</a></span><span class="op">(</span><span class="fl">321L</span>, disable_gpu <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># Already sets R's random seed.</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">iris</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="va">iris</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/to_categorical.html">to_categorical</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span><span class="op">-</span><span class="fl">1L</span>, <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="va">layers</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">keras</span><span class="op">$</span><span class="va">layers</span></span>
<span><span class="va">model</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">keras</span><span class="op">$</span><span class="va">models</span><span class="op">$</span><span class="fu">Sequential</span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="va">layers</span><span class="op">$</span><span class="fu">InputLayer</span><span class="op">(</span>input_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fl">4L</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="va">layers</span><span class="op">$</span><span class="fu">Dense</span><span class="op">(</span>units <span class="op">=</span> <span class="fl">20L</span>, activation <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">nn</span><span class="op">$</span><span class="va">relu</span><span class="op">)</span>,</span>
<span>    <span class="va">layers</span><span class="op">$</span><span class="fu">Dense</span><span class="op">(</span>units <span class="op">=</span> <span class="fl">20L</span>, activation <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">nn</span><span class="op">$</span><span class="va">relu</span><span class="op">)</span>,</span>
<span>    <span class="va">layers</span><span class="op">$</span><span class="fu">Dense</span><span class="op">(</span>units <span class="op">=</span> <span class="fl">20L</span>, activation <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">nn</span><span class="op">$</span><span class="va">relu</span><span class="op">)</span>,</span>
<span>    <span class="va">layers</span><span class="op">$</span><span class="fu">Dense</span><span class="op">(</span>units <span class="op">=</span> <span class="fl">3L</span>, activation <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">nn</span><span class="op">$</span><span class="va">softmax</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">epochs</span> <span class="op">=</span> <span class="fl">200L</span></span>
<span><span class="va">optimizer</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">keras</span><span class="op">$</span><span class="va">optimizers</span><span class="op">$</span><span class="fu">Adamax</span><span class="op">(</span><span class="fl">0.01</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Stochastic gradient optimization is more efficient.</span></span>
<span><span class="va">get_batch</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">batch_size</span> <span class="op">=</span> <span class="fl">32L</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">indices</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, size <span class="op">=</span> <span class="va">batch_size</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>bX <span class="op">=</span> <span class="va">x</span><span class="op">[</span><span class="va">indices</span>,<span class="op">]</span>, bY <span class="op">=</span> <span class="va">y</span><span class="op">[</span><span class="va">indices</span>,<span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">steps</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">/</span><span class="fl">32</span><span class="op">)</span> <span class="op">*</span> <span class="va">epochs</span> <span class="co"># We need nrow(x)/32 steps for each epoch.</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">steps</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">batch</span> <span class="op">=</span> <span class="fu">get_batch</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">bX</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="fu">constant</span><span class="op">(</span><span class="va">batch</span><span class="op">$</span><span class="va">bX</span><span class="op">)</span></span>
<span>  <span class="va">bY</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="fu">constant</span><span class="op">(</span><span class="va">batch</span><span class="op">$</span><span class="va">bY</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Automatic differentiation.</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">tf</span><span class="op">$</span><span class="fu">GradientTape</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rstudio.github.io/reticulate/reference/with-as-operator.html">%as%</a></span> <span class="va">tape</span>,</span>
<span>    <span class="op">{</span></span>
<span>      <span class="va">pred</span> <span class="op">=</span> <span class="fu">model</span><span class="op">(</span><span class="va">bX</span><span class="op">)</span> <span class="co"># we record the operation for our model weights</span></span>
<span>      <span class="va">loss</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="fu">reduce_mean</span><span class="op">(</span><span class="va">tf</span><span class="op">$</span><span class="va">keras</span><span class="op">$</span><span class="va">losses</span><span class="op">$</span><span class="fu">categorical_crossentropy</span><span class="op">(</span><span class="va">bY</span>, <span class="va">pred</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Calculate the gradients for the loss at our model$weights / backpropagation.</span></span>
<span>  <span class="va">gradients</span> <span class="op">=</span> <span class="va">tape</span><span class="op">$</span><span class="fu">gradient</span><span class="op">(</span><span class="va">loss</span>, <span class="va">model</span><span class="op">$</span><span class="va">weights</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Update our model weights with the learning rate specified above.</span></span>
<span>  <span class="va">optimizer</span><span class="op">$</span><span class="fu">apply_gradients</span><span class="op">(</span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/transpose.html">transpose</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">gradients</span>, <span class="va">model</span><span class="op">$</span><span class="va">weights</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="op">!</span> <span class="va">i</span><span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span><span class="fl">30</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Loss: "</span>, <span class="va">loss</span><span class="op">$</span><span class="fu">numpy</span><span class="op">(</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span> <span class="co"># Print loss every 30 steps (not epochs!).</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Loss:  0.002592299 </span></span>
<span><span class="co">#&gt; Loss:  0.0004166169 </span></span>
<span><span class="co">#&gt; Loss:  0.0005878718 </span></span>
<span><span class="co">#&gt; Loss:  0.0001814893 </span></span>
<span><span class="co">#&gt; Loss:  0.0003771982 </span></span>
<span><span class="co">#&gt; Loss:  0.0006105618 </span></span>
<span><span class="co">#&gt; Loss:  0.0003895268 </span></span>
<span><span class="co">#&gt; Loss:  0.0001912034 </span></span>
<span><span class="co">#&gt; Loss:  0.0002297373 </span></span>
<span><span class="co">#&gt; Loss:  0.0001141062 </span></span>
<span><span class="co">#&gt; Loss:  0.0002618438 </span></span>
<span><span class="co">#&gt; Loss:  0.0001288175 </span></span>
<span><span class="co">#&gt; Loss:  5.752431e-05 </span></span>
<span><span class="co">#&gt; Loss:  0.000256366 </span></span>
<span><span class="co">#&gt; Loss:  0.0002148773 </span></span>
<span><span class="co">#&gt; Loss:  0.0001434388 </span></span>
<span><span class="co">#&gt; Loss:  0.0001920019 </span></span>
<span><span class="co">#&gt; Loss:  0.0001954518 </span></span>
<span><span class="co">#&gt; Loss:  7.47276e-05 </span></span>
<span><span class="co">#&gt; Loss:  2.274193e-05 </span></span>
<span><span class="co">#&gt; Loss:  0.000115741 </span></span>
<span><span class="co">#&gt; Loss:  2.059802e-05 </span></span>
<span><span class="co">#&gt; Loss:  7.065996e-05 </span></span>
<span><span class="co">#&gt; Loss:  1.295879e-05 </span></span>
<span><span class="co">#&gt; Loss:  6.738321e-05 </span></span>
<span><span class="co">#&gt; Loss:  2.543455e-05</span></span></code></pre></div>
<p>Remarks:</p>
<ul>
<li>Mind the different input and output layer numbers.</li>
<li>The loss function increases randomly, because different subsets of the data were drawn.
This is a downside of stochastic gradient descent.</li>
<li>A positive thing about stochastic gradient descent is, that local valleys or hills may be left and global ones can be found instead.</li>
</ul></details><br><hr>
</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="reminder.html"><span class="header-section-number">2</span> Reminders About Basic Operations in R</a></div>
<div class="next"><a href="references.html">References</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#introduction"><span class="header-section-number">3</span> Introduction to Machine Learning</a></li>
<li>
<a class="nav-link" href="#unsupervised-learning"><span class="header-section-number">3.1</span> Unsupervised Learning</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#hierarchical-clustering"><span class="header-section-number">3.1.1</span> Hierarchical Clustering</a></li>
<li><a class="nav-link" href="#k-means-clustering"><span class="header-section-number">3.1.2</span> K-means Clustering</a></li>
<li><a class="nav-link" href="#density-based-clustering"><span class="header-section-number">3.1.3</span> Density-based Clustering</a></li>
<li><a class="nav-link" href="#model-based-clustering"><span class="header-section-number">3.1.4</span> Model-based Clustering</a></li>
<li><a class="nav-link" href="#ordination"><span class="header-section-number">3.1.5</span> Ordination</a></li>
<li><a class="nav-link" href="#exercises"><span class="header-section-number">3.1.6</span> Exercises</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#supervised-learning-regression-and-classification"><span class="header-section-number">3.2</span> Supervised Learning: Regression and Classification</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#supervised-regression-using-random-forest"><span class="header-section-number">3.2.1</span> Supervised Regression Using Random Forest</a></li>
<li><a class="nav-link" href="#supervised-classification-using-random-forest"><span class="header-section-number">3.2.2</span> Supervised Classification Using Random Forest</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#basicMath"><span class="header-section-number">3.3</span> Small Introduction Into the Underlying Mathematical Concepts of all Following Lessons - Optional</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#caveat-about-learning-rates-and-activation-functions"><span class="header-section-number">3.3.1</span> Caveat About Learning Rates and Activation Functions</a></li></ul>
</li>
<li>
<a class="nav-link" href="#introduction-to-tensorflow"><span class="header-section-number">3.4</span> Introduction to TensorFlow</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#tensorflow-data-containers"><span class="header-section-number">3.4.1</span> TensorFlow Data Containers</a></li>
<li><a class="nav-link" href="#basic-operations"><span class="header-section-number">3.4.2</span> Basic Operations</a></li>
<li><a class="nav-link" href="#tensorflow-data-types---good-practice-with-r-tensorflow"><span class="header-section-number">3.4.3</span> TensorFlow Data Types - Good Practice With R-TensorFlow</a></li>
<li><a class="nav-link" href="#exercises-1"><span class="header-section-number">3.4.4</span> Exercises</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#introduction-to-pytorch"><span class="header-section-number">3.5</span> Introduction to PyTorch</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#pytorch-data-containers"><span class="header-section-number">3.5.1</span> PyTorch Data Containers</a></li>
<li><a class="nav-link" href="#basic-operations-1"><span class="header-section-number">3.5.2</span> Basic Operations</a></li>
<li><a class="nav-link" href="#torch-data-types---good-practice-with-r-torch"><span class="header-section-number">3.5.3</span> Torch Data Types - Good Practice With R-Torch</a></li>
<li><a class="nav-link" href="#exercises-2"><span class="header-section-number">3.5.4</span> Exercises</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#first-steps-with-the-keras-framework"><span class="header-section-number">3.6</span> First Steps With the Keras Framework</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#example-workflow-in-keras-and-torch"><span class="header-section-number">3.6.1</span> Example Workflow in Keras and Torch</a></li></ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/TheoreticalEcology/machinelearning/blob/master/book/03-intro.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/TheoreticalEcology/machinelearning/edit/master/book/03-intro.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Machine Learning and AI in TensorFlow and R</strong>" was written by Maximilian Pichler and Florian Hartig. It was last built on 2022-07-05.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
