<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 7 Interpretation and Causality With Machine Learning | Machine Learning and AI in TensorFlow and R</title>
<meta name="author" content="Maximilian Pichler and Florian Hartig">
<meta name="description" content="7.1 Explainable AI The goal of explainable AI (xAI, aka interpretable machine learning) is to explain why a fitted machine learning model makes certain predictions. A typical example is to...">
<meta name="generator" content="bookdown 0.27 with bs4_book()">
<meta property="og:title" content="Chapter 7 Interpretation and Causality With Machine Learning | Machine Learning and AI in TensorFlow and R">
<meta property="og:type" content="book">
<meta property="og:description" content="7.1 Explainable AI The goal of explainable AI (xAI, aka interpretable machine learning) is to explain why a fitted machine learning model makes certain predictions. A typical example is to...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 7 Interpretation and Causality With Machine Learning | Machine Learning and AI in TensorFlow and R">
<meta name="twitter:description" content="7.1 Explainable AI The goal of explainable AI (xAI, aka interpretable machine learning) is to explain why a fitted machine learning model makes certain predictions. A typical example is to...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><link href="libs/panelset-0.2.6/panelset.css" rel="stylesheet">
<script src="libs/panelset-0.2.6/panelset.js"></script><script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script><script src="libs/viz-1.8.2/viz.js"></script><link href="libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">
<script src="libs/grViz-binding-1.0.9/grViz.js"></script><style>
    #content {
        font-size: 0.95rem;
    }


    </style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
<link rel="stylesheet" href="panel.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Machine Learning and AI in TensorFlow and R</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"><span class="header-section-number">1</span> Prerequisites</a></li>
<li><a class="" href="introduction.html"><span class="header-section-number">2</span> Introduction to Machine Learning</a></li>
<li><a class="" href="tensorflowintro.html"><span class="header-section-number">3</span> Introduction to TensorFlow, Keras, and Torch</a></li>
<li><a class="" href="fundamental.html"><span class="header-section-number">4</span> Common Machine Learning algorithms</a></li>
<li><a class="" href="workflow.html"><span class="header-section-number">5</span> Machine Learning workflow</a></li>
<li><a class="" href="deep.html"><span class="header-section-number">6</span> Deep Learning</a></li>
<li><a class="active" href="interpretation.html"><span class="header-section-number">7</span> Interpretation and Causality With Machine Learning</a></li>
<li><a class="" href="gan.html"><span class="header-section-number">8</span> Generative Modeling and Reinforcement Learning</a></li>
<li><a class="" href="datasets.html"><span class="header-section-number">9</span> Data sets</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/TheoreticalEcology/machinelearning">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="interpretation" class="section level1" number="7">
<h1>
<span class="header-section-number">7</span> Interpretation and Causality With Machine Learning<a class="anchor" aria-label="anchor" href="#interpretation"><i class="fas fa-link"></i></a>
</h1>
<!-- Put this here (right after the first markdown headline) and only here for each document! -->
<script src="./scripts/multipleChoice.js"></script><div id="explainable-ai" class="section level2" number="7.1">
<h2>
<span class="header-section-number">7.1</span> Explainable AI<a class="anchor" aria-label="anchor" href="#explainable-ai"><i class="fas fa-link"></i></a>
</h2>
<p>The goal of explainable AI (xAI, aka interpretable machine learning) is to explain <strong>why</strong> a fitted machine learning model makes certain predictions. A typical example is to understand how important different variables are for predictions. The incentives for doing so range from a better technical understanding of the models over understanding which data is important for improving predictions to questions of fairness and discrimination (e.g. to understand if an algorithm uses skin color to make a decision).</p>
<div id="a-practical-example" class="section level3" number="7.1.1">
<h3>
<span class="header-section-number">7.1.1</span> A Practical Example<a class="anchor" aria-label="anchor" href="#a-practical-example"><i class="fas fa-link"></i></a>
</h3>
<p>In this lecture we will work with another famous data set, the <em>Boston housing</em> data set:</p>
<p>We will fit a random forest and use the iml package for xAI, see <a href="https://christophm.github.io/interpretable-ml-book/" target="_blank" rel="noopener">https://christophm.github.io/interpretable-ml-book/</a>.</p>
<div class="sourceCode" id="cb377"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://christophm.github.io/iml/">iml</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://www.stat.berkeley.edu/~breiman/RandomForests/">randomForest</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; randomForest 4.7-1.1</span></span>
<span><span class="co">#&gt; Type rfNews() to see new features/changes/bug fixes.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"Boston"</span>, package <span class="op">=</span> <span class="st">"MASS"</span><span class="op">)</span></span>
<span><span class="va">rf</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/randomForest/man/randomForest.html">randomForest</a></span><span class="op">(</span><span class="va">medv</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">Boston</span>, ntree <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span></code></pre></div>
<p>xAI packages are written generic, i.e. they can handle almost all machine learning models.
When we want to use them, we first have to create a predictor object, that holds the model and the data. The iml package uses R6 classes, that means new objects can be created by calling Predictor$new(). (Do not worry if you do not know what R6 classes are, just use the command.)</p>
<div class="sourceCode" id="cb378"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">X</span> <span class="op">=</span> <span class="va">Boston</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">Boston</span><span class="op">)</span> <span class="op">!=</span> <span class="st">"medv"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">predictor</span> <span class="op">=</span> <span class="va"><a href="https://christophm.github.io/iml/reference/Predictor.html">Predictor</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">rf</span>, data <span class="op">=</span> <span class="va">X</span>, y <span class="op">=</span> <span class="va">Boston</span><span class="op">$</span><span class="va">medv</span><span class="op">)</span></span>
<span><span class="co"># "Predictor" is an object generator.</span></span></code></pre></div>
</div>
<div id="feature-importance" class="section level3" number="7.1.2">
<h3>
<span class="header-section-number">7.1.2</span> Feature Importance<a class="anchor" aria-label="anchor" href="#feature-importance"><i class="fas fa-link"></i></a>
</h3>
<p>Feature importance should not be mistaken with the random forest variable importance though they are related. It tells us how important the individual variables are for predictions, can be calculated for all machine learning models and is based on a permutation approach (have a look at the book):</p>
<div class="sourceCode" id="cb379"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">imp</span> <span class="op">=</span> <span class="va"><a href="https://christophm.github.io/iml/reference/FeatureImp.html">FeatureImp</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">predictor</span>, loss <span class="op">=</span> <span class="st">"mae"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">imp</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="08-xAI_files/figure-html/chunk_chapter6_2-1.png" width="100%" style="display: block; margin: auto;"></div>
</div>
<div id="partial-dependencies" class="section level3" number="7.1.3">
<h3>
<span class="header-section-number">7.1.3</span> Partial Dependencies<a class="anchor" aria-label="anchor" href="#partial-dependencies"><i class="fas fa-link"></i></a>
</h3>
<p>Partial dependencies are similar to allEffects plots for normal regressions. The idea is to visualize “marginal effects” of predictors (with the “feature” argument we specify the variable we want to visualize):</p>
<div class="sourceCode" id="cb380"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">eff</span> <span class="op">=</span> <span class="va"><a href="https://christophm.github.io/iml/reference/FeatureEffect.html">FeatureEffect</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">predictor</span>, feature <span class="op">=</span> <span class="st">"rm"</span>, method <span class="op">=</span> <span class="st">"pdp"</span>,</span>
<span>                        grid.size <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">eff</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="08-xAI_files/figure-html/chunk_chapter6_3-1.png" width="100%" style="display: block; margin: auto;"></div>
<p>Partial dependencies can also be plotted for single observations:</p>
<div class="sourceCode" id="cb381"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">eff</span> <span class="op">=</span> <span class="va"><a href="https://christophm.github.io/iml/reference/FeatureEffect.html">FeatureEffect</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">predictor</span>, feature <span class="op">=</span> <span class="st">"rm"</span>, method <span class="op">=</span> <span class="st">"pdp+ice"</span>,</span>
<span>                        grid.size <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">eff</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="08-xAI_files/figure-html/chunk_chapter6_4-1.png" width="100%" style="display: block; margin: auto;"></div>
<p>One disadvantage of partial dependencies is that they are sensitive to correlated predictors. Accumulated local effects can be used for accounting for correlation of predictors.</p>
</div>
<div id="accumulated-local-effects" class="section level3" number="7.1.4">
<h3>
<span class="header-section-number">7.1.4</span> Accumulated Local Effects<a class="anchor" aria-label="anchor" href="#accumulated-local-effects"><i class="fas fa-link"></i></a>
</h3>
<p>Accumulated local effects (ALE) are basically partial dependencies plots but try to correct for correlations between predictors.</p>
<div class="sourceCode" id="cb382"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ale</span> <span class="op">=</span> <span class="va"><a href="https://christophm.github.io/iml/reference/FeatureEffect.html">FeatureEffect</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">predictor</span>, feature <span class="op">=</span> <span class="st">"rm"</span>, method <span class="op">=</span> <span class="st">"ale"</span><span class="op">)</span></span>
<span><span class="va">ale</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="08-xAI_files/figure-html/chunk_chapter6_5-1.png" width="100%" style="display: block; margin: auto;"></div>
<p>If there is no collinearity, you shouldn’t see much difference between partial dependencies and ALE plots.</p>
</div>
<div id="friedmans-h-statistic" class="section level3" number="7.1.5">
<h3>
<span class="header-section-number">7.1.5</span> Friedman’s H-statistic<a class="anchor" aria-label="anchor" href="#friedmans-h-statistic"><i class="fas fa-link"></i></a>
</h3>
<p>The H-statistic can be used to find interactions between predictors. However, again, keep in mind that the H-statistic is sensible to correlation between predictors:</p>
<div class="sourceCode" id="cb383"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">interact</span> <span class="op">=</span> <span class="va"><a href="https://christophm.github.io/iml/reference/Interaction.html">Interaction</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">predictor</span>, <span class="st">"lstat"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">interact</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="08-xAI_files/figure-html/chunk_chapter6_6-1.png" width="100%" style="display: block; margin: auto;"></div>
</div>
<div id="global-explainer---simplifying-the-machine-learning-model" class="section level3" number="7.1.6">
<h3>
<span class="header-section-number">7.1.6</span> Global Explainer - Simplifying the Machine Learning Model<a class="anchor" aria-label="anchor" href="#global-explainer---simplifying-the-machine-learning-model"><i class="fas fa-link"></i></a>
</h3>
<p>Another idea is simplifying the machine learning model with another simpler model such as a decision tree. We create predictions with the machine learning model for a lot of different input values and then we fit a decision tree on these predictions. We can then interpret the easier model.</p>
<div class="sourceCode" id="cb384"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://partykit.r-forge.r-project.org/partykit/">partykit</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">tree</span> <span class="op">=</span> <span class="va"><a href="https://christophm.github.io/iml/reference/TreeSurrogate.html">TreeSurrogate</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">predictor</span>, maxdepth <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">tree</span><span class="op">$</span><span class="va">tree</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="08-xAI_files/figure-html/chunk_chapter6_7-1.png" width="100%" style="display: block; margin: auto;"></div>
</div>
<div id="local-explainer---lime-explaining-single-instances-observations" class="section level3" number="7.1.7">
<h3>
<span class="header-section-number">7.1.7</span> Local Explainer - LIME Explaining Single Instances (observations)<a class="anchor" aria-label="anchor" href="#local-explainer---lime-explaining-single-instances-observations"><i class="fas fa-link"></i></a>
</h3>
<p>The global approach is to simplify the entire machine learning-black-box model via a simpler model, which is then interpretable.</p>
<p>However, sometimes we are only interested in understanding how single predictions are generated. The LIME (Local interpretable model-agnostic explanations) approach explores the feature space around one observation and based on this locally fits a simpler model (e.g. a linear model):</p>
<div class="sourceCode" id="cb385"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lime.explain</span> <span class="op">=</span> <span class="va"><a href="https://christophm.github.io/iml/reference/LocalModel.html">LocalModel</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">predictor</span>, x.interest <span class="op">=</span> <span class="va">X</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span><span class="op">)</span></span>
<span><span class="va">lime.explain</span><span class="op">$</span><span class="va">results</span></span>
<span><span class="co">#&gt;               beta x.recoded    effect x.original feature feature.value</span></span>
<span><span class="co">#&gt; rm       4.1893817     6.575 27.545185      6.575      rm      rm=6.575</span></span>
<span><span class="co">#&gt; ptratio -0.5307031    15.300 -8.119758       15.3 ptratio  ptratio=15.3</span></span>
<span><span class="co">#&gt; lstat   -0.4398104     4.980 -2.190256       4.98   lstat    lstat=4.98</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">lime.explain</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="08-xAI_files/figure-html/chunk_chapter6_8-1.png" width="100%" style="display: block; margin: auto;"></div>
</div>
<div id="local-explainer---shapley" class="section level3" number="7.1.8">
<h3>
<span class="header-section-number">7.1.8</span> Local Explainer - Shapley<a class="anchor" aria-label="anchor" href="#local-explainer---shapley"><i class="fas fa-link"></i></a>
</h3>
<p>The Shapley method computes the so called Shapley value, feature contributions for single predictions, and is based on an approach from cooperative game theory. The idea is that each feature value of the instance is a “player” in a game, where the prediction is the reward. The Shapley value tells us how to fairly distribute the reward among the features.</p>
<div class="sourceCode" id="cb386"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">shapley</span> <span class="op">=</span> <span class="va"><a href="https://christophm.github.io/iml/reference/Shapley.html">Shapley</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">predictor</span>, x.interest <span class="op">=</span> <span class="va">X</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span><span class="op">)</span></span>
<span><span class="va">shapley</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="08-xAI_files/figure-html/chunk_chapter6_9-1.png" width="100%" style="display: block; margin: auto;"></div>
</div>
</div>
<div id="causal-inference-and-machine-learning" class="section level2" number="7.2">
<h2>
<span class="header-section-number">7.2</span> Causal Inference and Machine Learning<a class="anchor" aria-label="anchor" href="#causal-inference-and-machine-learning"><i class="fas fa-link"></i></a>
</h2>
<p>xAI aims at explaining how predictions are being made. In general, xAI != causality. xAI methods measure which variables are used for predictions by the algorithm, or how far variables improve predictions. The important point to note here: If a variable causes something, we could also expect that it helps predicting the very thing. The opposite, however, is not generally true - very often it is possible that a variable that doesn’t cause anything can predict something.</p>
<p>In statistics courses (in particular our course: Advanced Biostatistics), we discuss the issue of causality at full length. Here, we don’t want to go into the details, but again, you should in general resist to interpret indicators of importance in xAI as causal effects. They tell you something about what’s going on in the algorithm, not about what’s going on in reality.</p>
<div id="causalInference" class="section level3" number="7.2.1">
<h3>
<span class="header-section-number">7.2.1</span> Causal Inference on Static Data<a class="anchor" aria-label="anchor" href="#causalInference"><i class="fas fa-link"></i></a>
</h3>
<p>Methods for causal inference depend on whether we have dynamic or static data. The latter is the more common case. With static data, the problem is confounding. If you have several correlated predictors, you can get spurious correlations between a given predictor and the response, although there is no causal effect in general.</p>
<p>Multiple regression and few other methods are able to correct for other predictors and thus isolate the causal effect. The same is not necessarily true for machine learning algorithms and xAI methods. This is not a bug, but a feature - for making good predictions, it is often no problem, but rather an advantage to also use non-causal predictors.</p>
<p>Here an example for the indicators of variable importance in the random forest algorithm. The purpose of this script is to show that random forest variable importance will split importance values for collinear variables evenly, even if collinearity is low enough so that variables are separable and would be correctly separated by an lm / ANOVA.</p>
<p>We first simulate a data set with 2 predictors that are strongly correlated, but only one of them has an effect on the response.</p>
<div class="sourceCode" id="cb387"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Simulation parameters.</span></span>
<span><span class="va">n</span> <span class="op">=</span> <span class="fl">1000</span></span>
<span><span class="va">col</span> <span class="op">=</span> <span class="fl">0.7</span></span>
<span></span>
<span><span class="co"># Create collinear predictors.</span></span>
<span><span class="va">x1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">x2</span> <span class="op">=</span> <span class="va">col</span> <span class="op">*</span> <span class="va">x1</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">col</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Response is only influenced by x1.</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="va">x1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span></code></pre></div>
<p>lm / anova correctly identify <span class="math inline">\(x1\)</span> as causal variable.</p>
<div class="sourceCode" id="cb388"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x1</span> <span class="op">+</span> <span class="va">x2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; lm(formula = y ~ x1 + x2)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residuals:</span></span>
<span><span class="co">#&gt;     Min      1Q  Median      3Q     Max </span></span>
<span><span class="co">#&gt; -3.0709 -0.6939  0.0102  0.6976  3.3373 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept)  0.02837    0.08705   0.326 0.744536    </span></span>
<span><span class="co">#&gt; x1           1.07383    0.27819   3.860 0.000121 ***</span></span>
<span><span class="co">#&gt; x2          -0.04547    0.37370  -0.122 0.903186    </span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual standard error: 1.011 on 997 degrees of freedom</span></span>
<span><span class="co">#&gt; Multiple R-squared:  0.08104,    Adjusted R-squared:  0.0792 </span></span>
<span><span class="co">#&gt; F-statistic: 43.96 on 2 and 997 DF,  p-value: &lt; 2.2e-16</span></span></code></pre></div>
<p>Fit random forest and show variable importance:</p>
<div class="sourceCode" id="cb389"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/randomForest/man/randomForest.html">randomForest</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x1</span> <span class="op">+</span> <span class="va">x2</span>, importance <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/randomForest/man/varImpPlot.html">varImpPlot</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="08-xAI_files/figure-html/chunk_chapter6_12-1.png" width="100%" style="display: block; margin: auto;"></div>
<p>Variable importance is now split nearly evenly.</p>
<p>Task: understand why this is - remember:</p>
<ul>
<li>How the random forest works - variables are randomly hidden from the regression tree when the trees for the forest are built.</li>
<li>Remember that as <span class="math inline">\(x1 \propto x2\)</span>, we can use <span class="math inline">\(x2\)</span> as a replacement for <span class="math inline">\(x1\)</span>.</li>
<li>Remember that the variable importance measures the average contributions of the different variables in the trees of the forest.</li>
</ul>
</div>
<div id="structural-equation-models" class="section level3" number="7.2.2">
<h3>
<span class="header-section-number">7.2.2</span> Structural Equation Models<a class="anchor" aria-label="anchor" href="#structural-equation-models"><i class="fas fa-link"></i></a>
</h3>
<p>If causal relationships get more complicated, it will not be possible to adjust correctly with a simple lm. In this case, in statistics, we will usually use structural equation models (SEMs). Structural equation models are designed to estimate entire causal diagrams. There are two main SEM packages in R: For anything that is non-normal, you will currently have to estimate the directed acyclic graph (that depicts causal relations) piece-wise with CRAN package piecewiseSEM. Example for a vegetation data set:</p>
<div class="sourceCode" id="cb390"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jslefche/">piecewiseSEM</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">mod</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/piecewiseSEM/man/psem.html">psem</a></span><span class="op">(</span></span>
<span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">rich</span> <span class="op">~</span> <span class="va">distance</span> <span class="op">+</span> <span class="va">elev</span> <span class="op">+</span> <span class="va">abiotic</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span> <span class="va">hetero</span> <span class="op">+</span> <span class="va">firesev</span> <span class="op">+</span> <span class="va">cover</span>,</span>
<span>    data <span class="op">=</span> <span class="va">keeley</span><span class="op">)</span>,</span>
<span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">firesev</span> <span class="op">~</span> <span class="va">elev</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span> <span class="va">cover</span>, data <span class="op">=</span> <span class="va">keeley</span><span class="op">)</span>,</span>
<span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">cover</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">elev</span> <span class="op">+</span> <span class="va">hetero</span> <span class="op">+</span> <span class="va">abiotic</span>, data <span class="op">=</span> <span class="va">keeley</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></span></code></pre></div>
<p>For linear structural equation models, we can estimate the entire directed acyclic graph at once. This also allows having unobserved variables in the directed acyclic graph. One of the most popular packages for this is lavaan.</p>
<div class="sourceCode" id="cb391"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lavaan.ugent.be">lavaan</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">mod</span> <span class="op">=</span> <span class="st">"</span></span>
<span><span class="st"> rich ~ distance + elev + abiotic + age + hetero + firesev + cover</span></span>
<span><span class="st"> firesev ~ elev + age + cover</span></span>
<span><span class="st"> cover ~ age + elev + abiotic</span></span>
<span><span class="st">"</span></span>
<span><span class="va">fit</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/lavaan/man/sem.html">sem</a></span><span class="op">(</span><span class="va">mod</span>, data <span class="op">=</span> <span class="va">keeley</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span><span class="co">#&gt; lavaan 0.6-12 ended normally after 1 iterations</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   Estimator                                         ML</span></span>
<span><span class="co">#&gt;   Optimization method                           NLMINB</span></span>
<span><span class="co">#&gt;   Number of model parameters                        16</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   Number of observations                            90</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Model Test User Model:</span></span>
<span><span class="co">#&gt;                                                       </span></span>
<span><span class="co">#&gt;   Test statistic                                10.437</span></span>
<span><span class="co">#&gt;   Degrees of freedom                                 5</span></span>
<span><span class="co">#&gt;   P-value (Chi-square)                           0.064</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Parameter Estimates:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   Standard errors                             Standard</span></span>
<span><span class="co">#&gt;   Information                                 Expected</span></span>
<span><span class="co">#&gt;   Information saturated (h1) model          Structured</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Regressions:</span></span>
<span><span class="co">#&gt;                    Estimate   Std.Err  z-value  P(&gt;|z|)</span></span>
<span><span class="co">#&gt;   rich ~                                               </span></span>
<span><span class="co">#&gt;     distance           0.616    0.177    3.485    0.000</span></span>
<span><span class="co">#&gt;     elev              -0.009    0.006   -1.644    0.100</span></span>
<span><span class="co">#&gt;     abiotic            0.488    0.156    3.134    0.002</span></span>
<span><span class="co">#&gt;     age                0.024    0.105    0.229    0.819</span></span>
<span><span class="co">#&gt;     hetero            44.414    9.831    4.517    0.000</span></span>
<span><span class="co">#&gt;     firesev           -1.018    0.759   -1.341    0.180</span></span>
<span><span class="co">#&gt;     cover             12.400    3.841    3.228    0.001</span></span>
<span><span class="co">#&gt;   firesev ~                                            </span></span>
<span><span class="co">#&gt;     elev              -0.001    0.001   -0.951    0.342</span></span>
<span><span class="co">#&gt;     age                0.047    0.013    3.757    0.000</span></span>
<span><span class="co">#&gt;     cover             -1.521    0.509   -2.991    0.003</span></span>
<span><span class="co">#&gt;   cover ~                                              </span></span>
<span><span class="co">#&gt;     age               -0.009    0.002   -3.875    0.000</span></span>
<span><span class="co">#&gt;     elev               0.000    0.000    2.520    0.012</span></span>
<span><span class="co">#&gt;     abiotic           -0.000    0.004   -0.115    0.909</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Variances:</span></span>
<span><span class="co">#&gt;                    Estimate   Std.Err  z-value  P(&gt;|z|)</span></span>
<span><span class="co">#&gt;    .rich              97.844   14.586    6.708    0.000</span></span>
<span><span class="co">#&gt;    .firesev            1.887    0.281    6.708    0.000</span></span>
<span><span class="co">#&gt;    .cover              0.081    0.012    6.708    0.000</span></span></code></pre></div>
<p>The default plot options are not so nice as before.</p>
<div class="sourceCode" id="cb392"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/alishinski/lavaanPlot">lavaanPlot</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/lavaanPlot/man/lavaanPlot.html">lavaanPlot</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">fit</span><span class="op">)</span></span></code></pre></div>
<div id="htmlwidget-c178c715e4eb61ca4c30" style="width:100%;height:480px;" class="grViz html-widget"></div>
<script type="application/json" data-for="htmlwidget-c178c715e4eb61ca4c30">{"x":{"diagram":" digraph plot { \n graph [ overlap = true, fontsize = 10 ] \n node [ shape = box ] \n node [shape = box] \n distance; elev; abiotic; age; hetero; firesev; cover; rich \n node [shape = oval] \n  \n \n edge [ color = black ] \n distance->rich elev->rich abiotic->rich age->rich hetero->rich firesev->rich cover->rich elev->firesev age->firesev cover->firesev age->cover elev->cover abiotic->cover  \n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script><p>Another plotting option is using semPlot.</p>
<div class="sourceCode" id="cb393"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/SachaEpskamp/semPlot">semPlot</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/semPlot/man/semPaths.html">semPaths</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="08-xAI_files/figure-html/chunk_chapter6_16-1.png" width="100%" style="display: block; margin: auto;"></div>
</div>
<div id="automatic-causal-discovery" class="section level3" number="7.2.3">
<h3>
<span class="header-section-number">7.2.3</span> Automatic Causal Discovery<a class="anchor" aria-label="anchor" href="#automatic-causal-discovery"><i class="fas fa-link"></i></a>
</h3>
<p>But how to get the causal graph? In statistics, it is common to “guess” it and afterwards do residual checks, in the same way as we guess the structure of a regression. For more complicated problems, however, this is unsatisfying. Some groups therefore work on so-called causal discovery algorithms, i.e. algorithms that automatically generate causal graphs from data. One of the most classic algorithms of this sort is the <em>PC algorithm</em>. Here an example using the pcalg package:</p>
<div class="sourceCode" id="cb394"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://pcalg.r-forge.r-project.org/">pcalg</a></span><span class="op">)</span></span></code></pre></div>
<p>Loading the data:</p>
<div class="sourceCode" id="cb395"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"gmG"</span>, package <span class="op">=</span> <span class="st">"pcalg"</span><span class="op">)</span> <span class="co"># Loads data sets gmG and gmG8.</span></span>
<span><span class="va">suffStat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>C <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span><span class="op">(</span><span class="va">gmG8</span><span class="op">$</span><span class="va">x</span><span class="op">)</span>, n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">gmG8</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">varNames</span> <span class="op">=</span> <span class="va">gmG8</span><span class="op">$</span><span class="va">g</span><span class="op">@</span><span class="va">nodes</span></span></code></pre></div>
<p>First, the skeleton algorithm creates a basic graph without connections (a skeleton of the graph).</p>
<div class="sourceCode" id="cb396"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">skel.gmG8</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/pcalg/man/skeleton.html">skeleton</a></span><span class="op">(</span><span class="va">suffStat</span>, indepTest <span class="op">=</span> <span class="va">gaussCItest</span>,</span>
<span>labels <span class="op">=</span> <span class="va">varNames</span>, alpha <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="fu">Rgraphviz</span><span class="fu">::</span><span class="fu">plot</span><span class="op">(</span><span class="va">skel.gmG8</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in !is.null(main) &amp;&amp; nchar(main) &gt; 0: 'length(x) = 2 &gt; 1' in coercion to</span></span>
<span><span class="co">#&gt; 'logical(1)'</span></span></code></pre></div>
<div class="inline-figure"><img src="08-xAI_files/figure-html/chunk_chapter6_19-1.png" width="100%" style="display: block; margin: auto;"></div>
<p>What is missing here is the direction of the errors. The PC algorithm now makes tests for conditional independence, which allows fixing a part (but typically not all) of the directions of the causal arrows.</p>
<div class="sourceCode" id="cb397"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pc.gmG8</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/pcalg/man/pc.html">pc</a></span><span class="op">(</span><span class="va">suffStat</span>, indepTest <span class="op">=</span> <span class="va">gaussCItest</span>,</span>
<span>labels <span class="op">=</span> <span class="va">varNames</span>, alpha <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="fu">Rgraphviz</span><span class="fu">::</span><span class="fu">plot</span><span class="op">(</span><span class="va">pc.gmG8</span> <span class="op">)</span></span>
<span><span class="co">#&gt; Warning in !is.null(main) &amp;&amp; nchar(main) &gt; 0: 'length(x) = 2 &gt; 1' in coercion to</span></span>
<span><span class="co">#&gt; 'logical(1)'</span></span></code></pre></div>
<div class="inline-figure"><img src="08-xAI_files/figure-html/chunk_chapter6_20-1.png" width="100%" style="display: block; margin: auto;"></div>
</div>
<div id="causal-inference-on-dynamic-data" class="section level3" number="7.2.4">
<h3>
<span class="header-section-number">7.2.4</span> Causal Inference on Dynamic Data<a class="anchor" aria-label="anchor" href="#causal-inference-on-dynamic-data"><i class="fas fa-link"></i></a>
</h3>
<p>When working with dynamic data, we can use an additional piece of information - the cause usually precedes the effect, which means that we can test for a time-lag between cause and effect to determine the direction of causality. This way of testing for causality is known as <em>Granger causality</em>, or Granger methods. Here an example:</p>
<div class="sourceCode" id="cb398"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">lmtest</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## What came first: the chicken or the egg?</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">ChickEgg</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/lmtest/man/grangertest.html">grangertest</a></span><span class="op">(</span><span class="va">egg</span> <span class="op">~</span> <span class="va">chicken</span>, order <span class="op">=</span> <span class="fl">3</span>, data <span class="op">=</span> <span class="va">ChickEgg</span><span class="op">)</span></span>
<span><span class="co">#&gt; Granger causality test</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Model 1: egg ~ Lags(egg, 1:3) + Lags(chicken, 1:3)</span></span>
<span><span class="co">#&gt; Model 2: egg ~ Lags(egg, 1:3)</span></span>
<span><span class="co">#&gt;   Res.Df Df      F Pr(&gt;F)</span></span>
<span><span class="co">#&gt; 1     44                 </span></span>
<span><span class="co">#&gt; 2     47 -3 0.5916 0.6238</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/lmtest/man/grangertest.html">grangertest</a></span><span class="op">(</span><span class="va">chicken</span> <span class="op">~</span> <span class="va">egg</span>, order <span class="op">=</span> <span class="fl">3</span>, data <span class="op">=</span> <span class="va">ChickEgg</span><span class="op">)</span></span>
<span><span class="co">#&gt; Granger causality test</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Model 1: chicken ~ Lags(chicken, 1:3) + Lags(egg, 1:3)</span></span>
<span><span class="co">#&gt; Model 2: chicken ~ Lags(chicken, 1:3)</span></span>
<span><span class="co">#&gt;   Res.Df Df     F   Pr(&gt;F)   </span></span>
<span><span class="co">#&gt; 1     44                     </span></span>
<span><span class="co">#&gt; 2     47 -3 5.405 0.002966 **</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span></code></pre></div>
</div>
<div id="outlook-for-machine-learning" class="section level3" number="7.2.5">
<h3>
<span class="header-section-number">7.2.5</span> Outlook for Machine Learning<a class="anchor" aria-label="anchor" href="#outlook-for-machine-learning"><i class="fas fa-link"></i></a>
</h3>
<p>As we have seen, there are already a few methods / algorithms for discovering causality from large data sets, but the systematic transfer of these concepts to machine learning, in particular deep learning, is still at its infancy. At the moment, this field is actively researched and changes extremely fast, so we recommend using Google to see what is currently going on. Particular in business and industry, there is a large interest in learning about causal effect from large data sets. In our opinion, a great topic for young scientists to specialize on.</p>
</div>
<div id="exercises-7" class="section level3" number="7.2.6">
<h3>
<span class="header-section-number">7.2.6</span> Exercises<a class="anchor" aria-label="anchor" href="#exercises-7"><i class="fas fa-link"></i></a>
</h3>
  <hr>
<strong><span style="color: #0011AA; font-size:18px;">1. Task</span></strong><br><p>Use one of the non-image based data sets (preferably Wine, which is also described in the data sets section <a href="datasets.html#datasets">9</a> but wasn’t used yet, but you can also use Nasa or Titanic) and fit a random forest. Explore / interpret the fitted model using iml (see also the book: <a href="https://christophm.github.io/interpretable-ml-book/" target="_blank" rel="noopener">https://christophm.github.io/interpretable-ml-book/</a>).</p>
  <details><summary><strong><span style="color: #0011AA; font-size:18px;">Solution</span></strong>
    </summary><p>
</p>
<div class="sourceCode" id="cb399"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://www.stat.berkeley.edu/~breiman/RandomForests/">randomForest</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://christophm.github.io/iml/">"iml"</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu">EcoData</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/EcoData/man/wine.html">wine</a></span><span class="op">)</span></span>
<span><span class="va">submission</span> <span class="op">=</span> <span class="va">data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">quality</span><span class="op">)</span><span class="op">)</span>, <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">==</span> <span class="st">"quality"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, <span class="op">]</span> <span class="co"># Removes sumbmission data as well.</span></span>
<span></span>
<span><span class="co"># Remark: Features don't need to be scaled for regression trees.</span></span>
<span></span>
<span><span class="va">rf</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/randomForest/man/randomForest.html">randomForest</a></span><span class="op">(</span><span class="va">quality</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span><span class="va">pred</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">rf</span>, <span class="va">data</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">pred</span>, <span class="va">data</span><span class="op">$</span><span class="va">quality</span><span class="op">)</span></span>
<span><span class="co">#&gt;     </span></span>
<span><span class="co">#&gt; pred   3   4   5   6   7   8</span></span>
<span><span class="co">#&gt;    4   2   4   0   0   0   0</span></span>
<span><span class="co">#&gt;    5   0   6 133   0   0   0</span></span>
<span><span class="co">#&gt;    6   0   0   3 113  10   0</span></span>
<span><span class="co">#&gt;    7   0   0   0   0  25   3</span></span>
<span><span class="op">(</span><span class="va">accuracy</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">pred</span> <span class="op">==</span> <span class="va">data</span><span class="op">$</span><span class="va">quality</span><span class="op">)</span><span class="op">)</span> <span class="co"># Fits pretty well (on the training data...)</span></span>
<span><span class="co">#&gt; [1] 0.9197324</span></span>
<span></span>
<span><span class="co"># For submission:</span></span>
<span><span class="co">#write.csv(round(predict(rf, submission)), file = "wine_RF.csv")</span></span>
<span></span>
<span><span class="co"># Standard depiction of importance:</span></span>
<span><span class="va">rf</span><span class="op">$</span><span class="va">importance</span></span>
<span><span class="co">#&gt;                      IncNodePurity</span></span>
<span><span class="co">#&gt; fixed.acidity            12.279077</span></span>
<span><span class="co">#&gt; volatile.acidity         21.997368</span></span>
<span><span class="co">#&gt; citric.acid              13.751476</span></span>
<span><span class="co">#&gt; residual.sugar           10.787817</span></span>
<span><span class="co">#&gt; chlorides                11.587301</span></span>
<span><span class="co">#&gt; free.sulfur.dioxide       9.966824</span></span>
<span><span class="co">#&gt; total.sulfur.dioxide     13.977669</span></span>
<span><span class="co">#&gt; density                  17.068801</span></span>
<span><span class="co">#&gt; pH                       10.302109</span></span>
<span><span class="co">#&gt; sulphates                20.273156</span></span>
<span><span class="co">#&gt; alcohol                  37.316264</span></span>
<span></span>
<span><span class="co"># IML:</span></span>
<span><span class="va">predictor</span> <span class="op">=</span> <span class="va"><a href="https://christophm.github.io/iml/reference/Predictor.html">Predictor</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    <span class="va">rf</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">!=</span> <span class="st">"quality"</span><span class="op">)</span><span class="op">]</span>, y <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">quality</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Mind: This is stochastical!</span></span>
<span><span class="va">importance</span> <span class="op">=</span> <span class="va"><a href="https://christophm.github.io/iml/reference/FeatureImp.html">FeatureImp</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">predictor</span>, loss <span class="op">=</span> <span class="st">"mae"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">importance</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="08-xAI_files/figure-html/chunk_chapter6_task_0-1.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb400"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Comparison between standard importance and IML importance:</span></span>
<span><span class="va">importanceRf</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">rf</span><span class="op">$</span><span class="va">importance</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">rf</span><span class="op">$</span><span class="va">importance</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">importanceIML</span> <span class="op">=</span> <span class="va">importance</span><span class="op">$</span><span class="va">results</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">comparison</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">importanceIML</span>, <span class="va">importanceRf</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">comparison</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"IML"</span>, <span class="st">"RF"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">comparison</span><span class="op">)</span></span>
<span><span class="co">#&gt;       IML                    RF                    </span></span>
<span><span class="co">#&gt;  [1,] "alcohol"              "alcohol"             </span></span>
<span><span class="co">#&gt;  [2,] "sulphates"            "volatile.acidity"    </span></span>
<span><span class="co">#&gt;  [3,] "volatile.acidity"     "sulphates"           </span></span>
<span><span class="co">#&gt;  [4,] "density"              "density"             </span></span>
<span><span class="co">#&gt;  [5,] "citric.acid"          "total.sulfur.dioxide"</span></span>
<span><span class="co">#&gt;  [6,] "total.sulfur.dioxide" "citric.acid"         </span></span>
<span><span class="co">#&gt;  [7,] "fixed.acidity"        "fixed.acidity"       </span></span>
<span><span class="co">#&gt;  [8,] "chlorides"            "chlorides"           </span></span>
<span><span class="co">#&gt;  [9,] "pH"                   "residual.sugar"      </span></span>
<span><span class="co">#&gt; [10,] "free.sulfur.dioxide"  "pH"                  </span></span>
<span><span class="co">#&gt; [11,] "residual.sugar"       "free.sulfur.dioxide"</span></span></code></pre></div>
<p>Mind that feature importance, and the random forest’s variable importance are related but not equal!
Variable importance is a measure for determining importance while creating the forest (i.e. for fitting). Feature importance is a measure for how important a variable is for prediction.</p>
<p>Maybe you want to see other explanation methods as well. Surely you can use the other techniques of this section on your own.</p>
    
  </details><br><hr>
<hr>
<strong><span style="color: #0011AA; font-size:18px;">2. Task</span></strong><br><p>As we show in section <a href="interpretation.html#causalInference">7.2.1</a> of this chapter, a random forest will split variable importance across collinear predictors, while a linear regression model (lm()) can identify which predictor is causally affecting the response (at least in theory, if all confounders are controlled). What about a boosted regression tree or an artificial neural network? Take the random forest example and add a boosted regression tree (easier, you can use for example <a href="https://rdrr.io/cran/xgboost/man/xgb.importance.html" class="uri">https://rdrr.io/cran/xgboost/man/xgb.importance.html</a>) or an artificial neural network, and have a look if those are better than the random forest at identifying causal predictors.</p>
  <details><summary><strong><span style="color: #0011AA; font-size:18px;">Solution</span></strong>
    </summary><p>
</p>
<div class="sourceCode" id="cb401"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/dmlc/xgboost">xgboost</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu">EcoData</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/EcoData/man/wine.html">wine</a></span><span class="op">)</span></span>
<span><span class="va">submission</span> <span class="op">=</span> <span class="va">data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">quality</span><span class="op">)</span><span class="op">)</span>, <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">==</span> <span class="st">"quality"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, <span class="op">]</span> <span class="co"># Removes sumbmission data as well.</span></span>
<span></span>
<span><span class="va">data_xg</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.DMatrix.html">xgb.DMatrix</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">!=</span> <span class="st">"quality"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  label <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">quality</span></span>
<span><span class="op">)</span></span>
<span><span class="va">brt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.train.html">xgboost</a></span><span class="op">(</span><span class="va">data_xg</span>, nrounds <span class="op">=</span> <span class="fl">24</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]  train-rmse:3.656523 </span></span>
<span><span class="co">#&gt; [2]  train-rmse:2.609494 </span></span>
<span><span class="co">#&gt; [3]  train-rmse:1.884807 </span></span>
<span><span class="co">#&gt; [4]  train-rmse:1.384918 </span></span>
<span><span class="co">#&gt; [5]  train-rmse:1.037362 </span></span>
<span><span class="co">#&gt; [6]  train-rmse:0.800110 </span></span>
<span><span class="co">#&gt; [7]  train-rmse:0.629324 </span></span>
<span><span class="co">#&gt; [8]  train-rmse:0.508917 </span></span>
<span><span class="co">#&gt; [9]  train-rmse:0.426155 </span></span>
<span><span class="co">#&gt; [10] train-rmse:0.369580 </span></span>
<span><span class="co">#&gt; [11] train-rmse:0.313017 </span></span>
<span><span class="co">#&gt; [12] train-rmse:0.274227 </span></span>
<span><span class="co">#&gt; [13] train-rmse:0.236959 </span></span>
<span><span class="co">#&gt; [14] train-rmse:0.207364 </span></span>
<span><span class="co">#&gt; [15] train-rmse:0.195811 </span></span>
<span><span class="co">#&gt; [16] train-rmse:0.182500 </span></span>
<span><span class="co">#&gt; [17] train-rmse:0.173310 </span></span>
<span><span class="co">#&gt; [18] train-rmse:0.154747 </span></span>
<span><span class="co">#&gt; [19] train-rmse:0.144045 </span></span>
<span><span class="co">#&gt; [20] train-rmse:0.139083 </span></span>
<span><span class="co">#&gt; [21] train-rmse:0.129605 </span></span>
<span><span class="co">#&gt; [22] train-rmse:0.118541 </span></span>
<span><span class="co">#&gt; [23] train-rmse:0.110689 </span></span>
<span><span class="co">#&gt; [24] train-rmse:0.097798</span></span>
<span></span>
<span><span class="va">pred</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">brt</span>, newdata <span class="op">=</span> <span class="va">data_xg</span><span class="op">)</span><span class="op">)</span> <span class="co"># Only integers are allowed.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">pred</span>, <span class="va">data</span><span class="op">$</span><span class="va">quality</span><span class="op">)</span></span>
<span><span class="co">#&gt;     </span></span>
<span><span class="co">#&gt; pred   3   4   5   6   7   8</span></span>
<span><span class="co">#&gt;    3   2   0   0   0   0   0</span></span>
<span><span class="co">#&gt;    4   0  10   0   0   0   0</span></span>
<span><span class="co">#&gt;    5   0   0 136   0   0   0</span></span>
<span><span class="co">#&gt;    6   0   0   0 113   1   0</span></span>
<span><span class="co">#&gt;    7   0   0   0   0  34   0</span></span>
<span><span class="co">#&gt;    8   0   0   0   0   0   3</span></span>
<span><span class="op">(</span><span class="va">accuracy</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">pred</span> <span class="op">==</span> <span class="va">data</span><span class="op">$</span><span class="va">quality</span><span class="op">)</span><span class="op">)</span> <span class="co"># Fits very well (on the training data...)</span></span>
<span><span class="co">#&gt; [1] 0.9966555</span></span>
<span></span>
<span><span class="co"># For submission:</span></span>
<span><span class="co">#write.csv(round(predict(rf, submission)), file = "wine_RF.csv")</span></span>
<span></span>
<span><span class="co"># Look at variable importance:</span></span>
<span><span class="fu">xgboost</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.importance.html">xgb.importance</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">brt</span><span class="op">)</span></span>
<span><span class="co">#&gt;                  Feature       Gain      Cover  Frequency</span></span>
<span><span class="co">#&gt;  1:              alcohol 0.28363726 0.13667721 0.07073509</span></span>
<span><span class="co">#&gt;  2:            sulphates 0.11331763 0.07015405 0.06657420</span></span>
<span><span class="co">#&gt;  3:        fixed.acidity 0.09844523 0.11359510 0.19278779</span></span>
<span><span class="co">#&gt;  4:     volatile.acidity 0.09582794 0.07098397 0.12760055</span></span>
<span><span class="co">#&gt;  5: total.sulfur.dioxide 0.09207986 0.09147259 0.07212205</span></span>
<span><span class="co">#&gt;  6:              density 0.07374576 0.14910006 0.08321775</span></span>
<span><span class="co">#&gt;  7:            chlorides 0.06025521 0.07972405 0.08876560</span></span>
<span><span class="co">#&gt;  8:       residual.sugar 0.05307944 0.07202137 0.08044383</span></span>
<span><span class="co">#&gt;  9:  free.sulfur.dioxide 0.04602742 0.04743503 0.06518724</span></span>
<span><span class="co">#&gt; 10:                   pH 0.04477577 0.12562892 0.07489598</span></span>
<span><span class="co">#&gt; 11:          citric.acid 0.03880847 0.04320764 0.07766990</span></span></code></pre></div>
<p>Every method yields slightly different results, but the main ingredient is alcohol (and sulphates).</p>
    
  </details><br><hr>
<strong><span style="color: #0011AA; font-size:18px;">3. Task</span></strong><br><p>If you’re done with the previous tasks and have still time and appetite, improve the submissions for our competition, in particular for the Wine data set. Possible ideas:</p>
<ul>
<li><p>Use MLR framework (section <a href="workflow.html#mlr">5.2</a>).</p></li>
<li><p>Try Transfer learning (section <a href="deep.html#transfer">6.4.2</a>). This was the winner of last years challenge.</p></li>
<li><p>Search on kaggle for more ideas / try to copy the ideas. This was the winner two years ago.</p></li>
</ul>
<p>A little example for the (unbalanced!) Wine data set</p>
  <details><summary><strong><span style="color: #0011AA; font-size:18px;">Solution</span></strong>
    </summary><p>
</p>
<div class="sourceCode" id="cb402"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/set_random_seed.html">set_random_seed</a></span><span class="op">(</span><span class="fl">123L</span>, disable_gpu <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># Already sets R's random seed.</span></span>
<span></span>
<span><span class="va">readin</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">percentageTest</span> <span class="op">=</span> <span class="fl">0.2</span>, <span class="va">aggregate</span> <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="co"># Parameter "aggregate" packs the classes with very low abundances into one.</span></span>
<span>    <span class="co"># If "aggregate" equals to NA, NaN, Null, 0 or FALSE, no aggregation is performed.</span></span>
<span>    <span class="co"># Else, the given number is the boundary.</span></span>
<span>    <span class="co"># Every class with less elements than the boundary is aggregated into one.</span></span>
<span>    </span>
<span>    <span class="co"># WARNING: These classes cannot be distinguished from then on!</span></span>
<span>    <span class="co"># Using the predictions for submission needs further processing!</span></span>
<span>    </span>
<span>    <span class="co"># Just for random selection of features, independent of the amount of function calls.</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">12345</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">train</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu">EcoData</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/EcoData/man/wine.html">wine</a></span><span class="op">)</span></span>
<span>    <span class="va">indicesTrain</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">train</span><span class="op">$</span><span class="va">quality</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">labelsTrain</span> <span class="op">=</span> <span class="va">train</span><span class="op">$</span><span class="va">quality</span><span class="op">[</span><span class="va">indicesTrain</span><span class="op">]</span></span>
<span>    <span class="va">labelsTrain</span> <span class="op">=</span> <span class="va">labelsTrain</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">labelsTrain</span><span class="op">)</span>  <span class="co"># Start at 0 (for softmax).</span></span>
<span>    <span class="va">train</span> <span class="op">=</span> <span class="va">train</span><span class="op">[</span>, <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">train</span><span class="op">)</span> <span class="op">==</span> <span class="st">"quality"</span><span class="op">)</span><span class="op">]</span></span>
<span>    </span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">aggregate</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">aggregate</span><span class="op">)</span><span class="op">{</span></span>
<span>        <span class="va">indices</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">labelsTrain</span><span class="op">)</span><span class="op">[</span></span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">labelsTrain</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">aggregate</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">labelsTrain</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span></span>
<span>        <span class="op">]</span><span class="op">)</span></span>
<span>        <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">indices</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>            <span class="va">labelsTrain</span><span class="op">[</span><span class="va">labelsTrain</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">indices</span><span class="op">]</span> <span class="op">=</span> <span class="op">-</span><span class="fl">1</span></span>
<span>            <span class="va">labelsTrain</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">labelsTrain</span><span class="op">)</span></span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">labelsTrain</span><span class="op">)</span> <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">labelsTrain</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span></span>
<span>            <span class="va">labelsTrain</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">labelsTrain</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="co"># Impute missing values (before any splitting, to get the highest power):</span></span>
<span>    <span class="va">train</span> <span class="op">=</span> <span class="fu">missRanger</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/missRanger/man/missRanger.html">missRanger</a></span><span class="op">(</span></span>
<span>        data <span class="op">=</span> <span class="va">train</span>,</span>
<span>        maxiter <span class="op">=</span> <span class="fl">10L</span>,</span>
<span>        seed <span class="op">=</span> <span class="fl">123</span>,</span>
<span>        num.trees <span class="op">=</span> <span class="fl">200L</span></span>
<span>    <span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Separate submission data (mind scaling!):</span></span>
<span>    <span class="va">submission</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">train</span><span class="op">[</span><span class="op">-</span><span class="va">indicesTrain</span>,<span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">train</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">train</span><span class="op">[</span><span class="va">indicesTrain</span>,<span class="op">]</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Very asymmetric training data:</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Size of training set: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">labelsTrain</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">labelsTrain</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="va">percentageTest</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>        <span class="st">"labelsTrain"</span> <span class="op">=</span> <span class="va">labelsTrain</span>,</span>
<span>        <span class="st">"labelsTest"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        <span class="st">"train"</span> <span class="op">=</span> <span class="va">train</span>,</span>
<span>        <span class="st">"test"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        <span class="st">"submission"</span> <span class="op">=</span> <span class="va">submission</span></span>
<span>      <span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="co"># Split into training and test set:</span></span>
<span>    <span class="va">len</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">train</span><span class="op">)</span></span>
<span>    <span class="va">indicesTest</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">len</span>, size <span class="op">=</span> <span class="va">percentageTest</span> <span class="op">*</span> <span class="va">len</span>, replace <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>    <span class="va">test</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">train</span><span class="op">[</span><span class="va">indicesTest</span>,<span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">labelsTest</span> <span class="op">=</span> <span class="va">labelsTrain</span><span class="op">[</span><span class="va">indicesTest</span><span class="op">]</span></span>
<span>    <span class="va">train</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">train</span><span class="op">[</span><span class="op">-</span><span class="va">indicesTest</span>,<span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">labelsTrain</span> <span class="op">=</span> <span class="va">labelsTrain</span><span class="op">[</span><span class="op">-</span><span class="va">indicesTest</span><span class="op">]</span></span>
<span>    </span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>        <span class="st">"labelsTrain"</span> <span class="op">=</span> <span class="va">labelsTrain</span>,</span>
<span>        <span class="st">"labelsTest"</span> <span class="op">=</span> <span class="va">labelsTest</span>,</span>
<span>        <span class="st">"train"</span> <span class="op">=</span> <span class="va">train</span>,</span>
<span>        <span class="st">"test"</span> <span class="op">=</span> <span class="va">test</span>,</span>
<span>        <span class="st">"submission"</span> <span class="op">=</span> <span class="va">submission</span></span>
<span>    <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">retVal</span> <span class="op">=</span> <span class="fu">readin</span><span class="op">(</span>aggregate <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Missing value imputation by random forests</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   Variables to impute:       fixed.acidity, volatile.acidity, citric.acid, residual.sugar, chlorides, free.sulfur.dioxide, total.sulfur.dioxide, density, pH, sulphates</span></span>
<span><span class="co">#&gt;   Variables used to impute:  fixed.acidity, volatile.acidity, citric.acid, residual.sugar, chlorides, free.sulfur.dioxide, total.sulfur.dioxide, density, pH, sulphates, alcohol</span></span>
<span><span class="co">#&gt; iter 1:  ..........</span></span>
<span><span class="co">#&gt; iter 2:  ..........</span></span>
<span><span class="co">#&gt; iter 3:  ..........</span></span>
<span><span class="co">#&gt; Size of training set: 694</span></span>
<span><span class="co">#&gt; labelsTrain</span></span>
<span><span class="co">#&gt;   0   1   2   3   4   5 </span></span>
<span><span class="co">#&gt;   7  25 309 261  84   8</span></span>
<span><span class="va">labelsTrain</span> <span class="op">=</span> <span class="va">retVal</span><span class="op">[[</span><span class="st">"labelsTrain"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">labelsTest</span> <span class="op">=</span> <span class="va">retVal</span><span class="op">[[</span><span class="st">"labelsTest"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">train</span> <span class="op">=</span> <span class="va">retVal</span><span class="op">[[</span><span class="st">"train"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">test</span> <span class="op">=</span> <span class="va">retVal</span><span class="op">[[</span><span class="st">"test"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">submission</span> <span class="op">=</span> <span class="va">retVal</span><span class="op">[[</span><span class="st">"submission"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">retVal</span><span class="op">)</span></span>
<span></span>
<span><span class="va">classNumber</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">labelsTrain</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">200L</span>, activation <span class="op">=</span> <span class="st">"leaky_relu"</span>,</span>
<span>    kernel_regularizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l2</a></span><span class="op">(</span><span class="fl">0.00035</span><span class="op">)</span>,</span>
<span>    input_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">train</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dropout.html">layer_dropout</a></span><span class="op">(</span><span class="fl">0.45</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">100L</span>, activation <span class="op">=</span> <span class="st">"relu"</span>,</span>
<span>    bias_regularizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l1_l2</a></span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dropout.html">layer_dropout</a></span><span class="op">(</span><span class="fl">0.2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">100L</span>, activation <span class="op">=</span> <span class="st">"leaky_relu"</span>,</span>
<span>    kernel_regularizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l2</a></span><span class="op">(</span><span class="fl">0.00035</span><span class="op">)</span>,</span>
<span>    bias_regularizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l1_l2</a></span><span class="op">(</span><span class="fl">0.1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dropout.html">layer_dropout</a></span><span class="op">(</span><span class="fl">0.25</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">50L</span>, activation <span class="op">=</span> <span class="st">"gelu"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">25L</span>, activation <span class="op">=</span> <span class="st">"elu"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dropout.html">layer_dropout</a></span><span class="op">(</span><span class="fl">0.35</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="co"># We need probabilities. So we use the softmax function.</span></span>
<span>    <span class="co"># Remember, the labels MUST start at 0!</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="va">classNumber</span>, activation <span class="op">=</span> <span class="st">"softmax"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://generics.r-lib.org/reference/compile.html">compile</a></span><span class="op">(</span>loss <span class="op">=</span> <span class="va">loss_binary_crossentropy</span>,</span>
<span>                   optimizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_adamax.html">optimizer_adamax</a></span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">0.015</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_history</span> <span class="op">=</span> </span>
<span>    <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># Mind the matrix property (no data.frame)!</span></span>
<span>        <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">train</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/k_one_hot.html">k_one_hot</a></span><span class="op">(</span><span class="va">labelsTrain</span>, <span class="va">classNumber</span><span class="op">)</span>,</span>
<span>            epochs <span class="op">=</span> <span class="fl">80L</span>, batch <span class="op">=</span> <span class="fl">12L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model_history</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="08-xAI_files/figure-html/chunk_chapter6_task_2-1.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb403"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Accuracy on training set (!)</span></span>
<span><span class="va">pred</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">model</span>, <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">train</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">which.max</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="fu">Metrics</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Metrics/man/accuracy.html">accuracy</a></span><span class="op">(</span><span class="va">pred</span>, <span class="va">labelsTrain</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.7733813</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">pred</span>, <span class="va">labelsTrain</span><span class="op">)</span></span>
<span><span class="co">#&gt;     labelsTrain</span></span>
<span><span class="co">#&gt; pred   0   1   2   3   4   5</span></span>
<span><span class="co">#&gt;    0   1   0   0   0   0   0</span></span>
<span><span class="co">#&gt;    1   0   1   0   0   0   0</span></span>
<span><span class="co">#&gt;    2   6  14 212  33   2   0</span></span>
<span><span class="co">#&gt;    3   0   8  25 179  25   3</span></span>
<span><span class="co">#&gt;    4   0   0   1   5  37   4</span></span>
<span></span>
<span><span class="co"># Accuracy on test set</span></span>
<span><span class="va">pred</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">model</span>, <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">test</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">which.max</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="fu">Metrics</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Metrics/man/accuracy.html">accuracy</a></span><span class="op">(</span><span class="va">pred</span>, <span class="va">labelsTest</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.6594203</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">pred</span>, <span class="va">labelsTest</span><span class="op">)</span></span>
<span><span class="co">#&gt;     labelsTest</span></span>
<span><span class="co">#&gt; pred  1  2  3  4  5</span></span>
<span><span class="co">#&gt;    1  0  1  0  0  0</span></span>
<span><span class="co">#&gt;    2  2 53 13  2  0</span></span>
<span><span class="co">#&gt;    3  0 16 31 11  0</span></span>
<span><span class="co">#&gt;    4  0  1  0  7  1</span></span></code></pre></div>
<p>Recognize overfitting of your model selection strategy by changing the seed few times (while keeping the model constant) and increase the percentage of test data.
Furthermore, consider fitting a random forest for good quality as well.</p>
<p>For the final predictions, we use the whole data set without holdouts:</p>
<div class="sourceCode" id="cb404"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/set_random_seed.html">set_random_seed</a></span><span class="op">(</span><span class="fl">321L</span>, disable_gpu <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># Already sets R's random seed.</span></span>
<span></span>
<span><span class="va">retVal</span> <span class="op">=</span> <span class="fu">readin</span><span class="op">(</span>percentageTest <span class="op">=</span> <span class="fl">0</span>, aggregate <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Missing value imputation by random forests</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   Variables to impute:       fixed.acidity, volatile.acidity, citric.acid, residual.sugar, chlorides, free.sulfur.dioxide, total.sulfur.dioxide, density, pH, sulphates</span></span>
<span><span class="co">#&gt;   Variables used to impute:  fixed.acidity, volatile.acidity, citric.acid, residual.sugar, chlorides, free.sulfur.dioxide, total.sulfur.dioxide, density, pH, sulphates, alcohol</span></span>
<span><span class="co">#&gt; iter 1:  ..........</span></span>
<span><span class="co">#&gt; iter 2:  ..........</span></span>
<span><span class="co">#&gt; iter 3:  ..........</span></span>
<span><span class="co">#&gt; Size of training set: 694</span></span>
<span><span class="co">#&gt; labelsTrain</span></span>
<span><span class="co">#&gt;   0   1   2   3   4   5 </span></span>
<span><span class="co">#&gt;   7  25 309 261  84   8</span></span>
<span><span class="va">labelsTrain</span> <span class="op">=</span> <span class="va">retVal</span><span class="op">[[</span><span class="st">"labelsTrain"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">labelsTest</span> <span class="op">=</span> <span class="va">retVal</span><span class="op">[[</span><span class="st">"labelsTest"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">train</span> <span class="op">=</span> <span class="va">retVal</span><span class="op">[[</span><span class="st">"train"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">test</span> <span class="op">=</span> <span class="va">retVal</span><span class="op">[[</span><span class="st">"test"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">submission</span> <span class="op">=</span> <span class="va">retVal</span><span class="op">[[</span><span class="st">"submission"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">retVal</span><span class="op">)</span></span>
<span></span>
<span><span class="va">classNumber</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">labelsTrain</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">200L</span>, activation <span class="op">=</span> <span class="st">"leaky_relu"</span>,</span>
<span>    kernel_regularizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l2</a></span><span class="op">(</span><span class="fl">0.00035</span><span class="op">)</span>,</span>
<span>    input_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">train</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dropout.html">layer_dropout</a></span><span class="op">(</span><span class="fl">0.45</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">100L</span>, activation <span class="op">=</span> <span class="st">"relu"</span>,</span>
<span>    bias_regularizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l1_l2</a></span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dropout.html">layer_dropout</a></span><span class="op">(</span><span class="fl">0.2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">100L</span>, activation <span class="op">=</span> <span class="st">"leaky_relu"</span>,</span>
<span>    kernel_regularizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l2</a></span><span class="op">(</span><span class="fl">0.00035</span><span class="op">)</span>,</span>
<span>    bias_regularizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l1_l2</a></span><span class="op">(</span><span class="fl">0.1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dropout.html">layer_dropout</a></span><span class="op">(</span><span class="fl">0.25</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">50L</span>, activation <span class="op">=</span> <span class="st">"gelu"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">25L</span>, activation <span class="op">=</span> <span class="st">"elu"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dropout.html">layer_dropout</a></span><span class="op">(</span><span class="fl">0.35</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="co"># We need probabilities. So we use the softmax function.</span></span>
<span>    <span class="co"># Remember, the labels MUST start at 0!</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="va">classNumber</span>, activation <span class="op">=</span> <span class="st">"softmax"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://generics.r-lib.org/reference/compile.html">compile</a></span><span class="op">(</span>loss <span class="op">=</span> <span class="va">loss_binary_crossentropy</span>,</span>
<span>                   optimizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_adamax.html">optimizer_adamax</a></span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">0.015</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_history</span> <span class="op">=</span> </span>
<span>    <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># Mind the matrix property (no data.frame)!</span></span>
<span>        <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">train</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/k_one_hot.html">k_one_hot</a></span><span class="op">(</span><span class="va">labelsTrain</span>, <span class="va">classNumber</span><span class="op">)</span>,</span>
<span>            epochs <span class="op">=</span> <span class="fl">80L</span>, batch <span class="op">=</span> <span class="fl">12L</span>, shuffle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model_history</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="08-xAI_files/figure-html/chunk_chapter6_task_3-1.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb405"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Accuracy on training set (!)</span></span>
<span><span class="va">pred</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">model</span>, <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">train</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">which.max</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="fu">Metrics</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Metrics/man/accuracy.html">accuracy</a></span><span class="op">(</span><span class="va">pred</span>, <span class="va">labelsTrain</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.7881844</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">pred</span>, <span class="va">labelsTrain</span><span class="op">)</span></span>
<span><span class="co">#&gt;     labelsTrain</span></span>
<span><span class="co">#&gt; pred   0   1   2   3   4   5</span></span>
<span><span class="co">#&gt;    1   3   7   1   0   0   0</span></span>
<span><span class="co">#&gt;    2   4  15 266  31   4   0</span></span>
<span><span class="co">#&gt;    3   0   3  36 209  15   2</span></span>
<span><span class="co">#&gt;    4   0   0   6  21  65   6</span></span>
<span></span>
<span><span class="co"># Reverse subtraction (for start at 0) and create submission file.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">pred</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu">EcoData</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/EcoData/man/wine.html">wine</a></span><span class="op">)</span><span class="op">$</span><span class="va">quality</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>          file <span class="op">=</span> <span class="st">"wine_NN.csv"</span><span class="op">)</span></span></code></pre></div>
    
  </details><br>
</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="deep.html"><span class="header-section-number">6</span> Deep Learning</a></div>
<div class="next"><a href="gan.html"><span class="header-section-number">8</span> Generative Modeling and Reinforcement Learning</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#interpretation"><span class="header-section-number">7</span> Interpretation and Causality With Machine Learning</a></li>
<li>
<a class="nav-link" href="#explainable-ai"><span class="header-section-number">7.1</span> Explainable AI</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#a-practical-example"><span class="header-section-number">7.1.1</span> A Practical Example</a></li>
<li><a class="nav-link" href="#feature-importance"><span class="header-section-number">7.1.2</span> Feature Importance</a></li>
<li><a class="nav-link" href="#partial-dependencies"><span class="header-section-number">7.1.3</span> Partial Dependencies</a></li>
<li><a class="nav-link" href="#accumulated-local-effects"><span class="header-section-number">7.1.4</span> Accumulated Local Effects</a></li>
<li><a class="nav-link" href="#friedmans-h-statistic"><span class="header-section-number">7.1.5</span> Friedman’s H-statistic</a></li>
<li><a class="nav-link" href="#global-explainer---simplifying-the-machine-learning-model"><span class="header-section-number">7.1.6</span> Global Explainer - Simplifying the Machine Learning Model</a></li>
<li><a class="nav-link" href="#local-explainer---lime-explaining-single-instances-observations"><span class="header-section-number">7.1.7</span> Local Explainer - LIME Explaining Single Instances (observations)</a></li>
<li><a class="nav-link" href="#local-explainer---shapley"><span class="header-section-number">7.1.8</span> Local Explainer - Shapley</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#causal-inference-and-machine-learning"><span class="header-section-number">7.2</span> Causal Inference and Machine Learning</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#causalInference"><span class="header-section-number">7.2.1</span> Causal Inference on Static Data</a></li>
<li><a class="nav-link" href="#structural-equation-models"><span class="header-section-number">7.2.2</span> Structural Equation Models</a></li>
<li><a class="nav-link" href="#automatic-causal-discovery"><span class="header-section-number">7.2.3</span> Automatic Causal Discovery</a></li>
<li><a class="nav-link" href="#causal-inference-on-dynamic-data"><span class="header-section-number">7.2.4</span> Causal Inference on Dynamic Data</a></li>
<li><a class="nav-link" href="#outlook-for-machine-learning"><span class="header-section-number">7.2.5</span> Outlook for Machine Learning</a></li>
<li><a class="nav-link" href="#exercises-7"><span class="header-section-number">7.2.6</span> Exercises</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/TheoreticalEcology/machinelearning/blob/master/book/08-xAI.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/TheoreticalEcology/machinelearning/edit/master/book/08-xAI.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Machine Learning and AI in TensorFlow and R</strong>" was written by Maximilian Pichler and Florian Hartig. It was last built on 2022-07-12.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
